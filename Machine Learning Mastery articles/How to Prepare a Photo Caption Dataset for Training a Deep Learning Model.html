<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
<meta charset="utf-8"/>
<title>How to Prepare a Photo Caption Dataset for Training a Deep Learning Model - Machine Learning Mastery</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="https://machinelearningmastery.com/xmlrpc.php" rel="pingback"/>
<!--  Mobile viewport scale -->
<meta content="initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" name="viewport"/>
<!-- This site is optimized with the Yoast SEO plugin v6.1.1 - https://yoa.st/1yg?utm_content=6.1.1 -->
<link href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/" rel="canonical"/>
<link href="https://plus.google.com/u/0/b/117073416089354242117/+MachinelearningmasteryHome/" rel="publisher"/>
<meta content="en_US" property="og:locale"/>
<meta content="article" property="og:type"/>
<meta content="How to Prepare a Photo Caption Dataset for Training a Deep Learning Model - Machine Learning Mastery" property="og:title"/>
<meta content="Automatic photo captioning is a problem where a model must generate a human-readable textual description given a photograph. It is a challenging problem in artificial intelligence that requires both image understanding from the field of computer vision as well as language generation from the field of natural language processing. It is now possible to develop …" property="og:description"/>
<meta content="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/" property="og:url"/>
<meta content="Machine Learning Mastery" property="og:site_name"/>
<meta content="https://www.facebook.com/Machine-Learning-Mastery-1429846323896563/" property="article:publisher"/>
<meta content="Natural Language Processing" property="article:section"/>
<meta content="2017-11-15T05:00:55+11:00" property="article:published_time"/>
<meta content="2018-01-03T05:35:54+11:00" property="article:modified_time"/>
<meta content="2018-01-03T05:35:54+11:00" property="og:updated_time"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Prepare-a-Photo-Caption-Dataset-for-Training-a-Deep-Learning-Model.jpg" property="og:image"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Prepare-a-Photo-Caption-Dataset-for-Training-a-Deep-Learning-Model.jpg" property="og:image:secure_url"/>
<meta content="640" property="og:image:width"/>
<meta content="400" property="og:image:height"/>
<script type="application/ld+json">{"@context":"http:\/\/schema.org","@type":"WebSite","@id":"#website","url":"https:\/\/machinelearningmastery.com\/","name":"Machine Learning Mastery","potentialAction":{"@type":"SearchAction","target":"https:\/\/machinelearningmastery.com\/?s={search_term_string}","query-input":"required name=search_term_string"}}</script>
<script type="application/ld+json">{"@context":"http:\/\/schema.org","@type":"Organization","url":"https:\/\/machinelearningmastery.com\/prepare-photo-caption-dataset-training-deep-learning-model\/","sameAs":["https:\/\/www.facebook.com\/Machine-Learning-Mastery-1429846323896563\/","https:\/\/www.linkedin.com\/in\/jasonbrownlee","https:\/\/plus.google.com\/u\/0\/b\/117073416089354242117\/+MachinelearningmasteryHome\/","https:\/\/twitter.com\/TeachTheMachine"],"@id":"#organization","name":"Machine Learning Mastery","logo":"https:\/\/machinelearningmastery.com\/wp-content\/uploads\/2016\/09\/cropped-icon.png"}</script>
<!-- / Yoast SEO plugin. -->
<link href="//cdnjs.cloudflare.com" rel="dns-prefetch"/>
<link href="//fonts.googleapis.com" rel="dns-prefetch"/>
<link href="//s.w.org" rel="dns-prefetch"/>
<link href="https://feeds.feedburner.com/MachineLearningMastery" rel="alternate" title="Machine Learning Mastery » Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/comments/feed/" rel="alternate" title="Machine Learning Mastery » Comments Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/feed/" rel="alternate" title="Machine Learning Mastery » How to Prepare a Photo Caption Dataset for Training a Deep Learning Model Comments Feed" type="application/rss+xml"/>
<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/machinelearningmastery.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.9.2"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56794,8205,9794,65039],[55358,56794,8203,9794,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta" id="crayon-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta" id="crayon-theme-classic-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta" id="crayon-font-monaco-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=4.9.2" id="contact-form-7-css" media="all" rel="stylesheet" type="text/css"/>
<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css?ver=4.2.2.0.iis7_supports_permalinks" id="apss-font-awesome-css" media="all" rel="stylesheet" type="text/css"/>
<link href="//fonts.googleapis.com/css?family=Open+Sans&amp;ver=4.9.2" id="apss-font-opensans-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/seo-optimized-share-buttons/css/frontend.css?ver=4.2.2.0.iis7_supports_permalinks" id="apss-frontend-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/integrations/testimonials/css/testimonials.css?ver=4.9.2" id="woo-testimonials-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/style.css?ver=5.9.21" id="theme-stylesheet-css" media="all" rel="stylesheet" type="text/css"/>
<!--[if lt IE 9]>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/css/non-responsive.css" rel="stylesheet" type="text/css" />
<style type="text/css">.col-full, #wrapper { width: 960px; max-width: 960px; } #inner-wrapper { padding: 0; } body.full-width #header, #nav-container, body.full-width #content, body.full-width #footer-widgets, body.full-width #footer { padding-left: 0; padding-right: 0; } body.fixed-mobile #top, body.fixed-mobile #header-container, body.fixed-mobile #footer-container, body.fixed-mobile #nav-container, body.fixed-mobile #footer-widgets-container { min-width: 960px; padding: 0 1em; } body.full-width #content { width: auto; padding: 0 1em;}</style>
<![endif]-->
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery.js?ver=1.12.4" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/machinelearningmastery.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/third-party.min.js?ver=4.9.2" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/modernizr.min.js?ver=2.6.2" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/general.min.js?ver=4.9.2" type="text/javascript"></script>
<link href="https://machinelearningmastery.com/wp-json/" rel="https://api.w.org/"/>
<link href="https://machinelearningmastery.com/xmlrpc.php?rsd" rel="EditURI" title="RSD" type="application/rsd+xml"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/wlwmanifest.xml" rel="wlwmanifest" type="application/wlwmanifest+xml"/>
<link href="https://machinelearningmastery.com/?p=4434" rel="shortlink"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fprepare-photo-caption-dataset-training-deep-learning-model%2F" rel="alternate" type="application/json+oembed"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fprepare-photo-caption-dataset-training-deep-learning-model%2F&amp;format=xml" rel="alternate" type="text/xml+oembed"/>
<!-- Start Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44039733-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->
<!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');

fbq('init', '296263687421164');
fbq('track', "PageView");</script>
<noscript><img height="1" src="https://www.facebook.com/tr?id=296263687421164&amp;ev=PageView&amp;noscript=1" style="display:none" width="1"/></noscript>
<!-- End Facebook Pixel Code -->
<!-- Custom CSS Styling -->
<style type="text/css">
#logo .site-title, #logo .site-description { display:none; }
body {background-repeat:no-repeat;background-position:top left;background-attachment:scroll;border-top:0px solid #000000;}
#header {background-repeat:no-repeat;background-position:left top;margin-top:0px;margin-bottom:0px;padding-top:10px;padding-bottom:10px;border:0px solid ;}
#logo .site-title a {font:bold 40px/1em Helvetica Neue, Helvetica, sans-serif;color:#222222;}
#logo .site-description {font:300 13px/1em Helvetica Neue, Helvetica, sans-serif;color:#999999;}
body, p { font:300 14px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
h1 { font:bold 28px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h2 { font:bold 24px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h3 { font:bold 20px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h4 { font:bold 16px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h5 { font:bold 14px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h6 { font:bold 12px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }
.page-title, .post .title, .page .title {font:bold 28px/1.1em "Helvetica Neue", Helvetica, sans-serif;color:#222222;}
.post .title a:link, .post .title a:visited, .page .title a:link, .page .title a:visited {color:#222222}
.post-meta { font:300 12px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#999999; }
.entry, .entry p{ font:300 15px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555; }
.post-more {font:300 13px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:;border-top:0px solid #e6e6e6;border-bottom:0px solid #e6e6e6;}
#post-author, #connect {border-top:1px solid #e6e6e6;border-bottom:1px solid #e6e6e6;border-left:1px solid #e6e6e6;border-right:1px solid #e6e6e6;border-radius:5px;-moz-border-radius:5px;-webkit-border-radius:5px;background-color:#fafafa}
.nav-entries a, .woo-pagination { font:300 13px/1em "Helvetica Neue", Helvetica, sans-serif;color:#888; }
.woo-pagination a, .woo-pagination a:hover {color:#888!important}
.widget h3 {font:bold 14px/1.2em &quot;Helvetica Neue&quot;, Helvetica, sans-serif;color:#555555;border-bottom:1px solid #e6e6e6;}
.widget_recent_comments li, #twitter li { border-color: #e6e6e6;}
.widget p, .widget .textwidget { font:300 13px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
.widget {font:300 13px/1.5em &quot;Helvetica Neue&quot;, Helvetica, sans-serif;color:#555555;border-radius:0px;-moz-border-radius:0px;-webkit-border-radius:0px;}
#tabs .inside li a, .widget_woodojo_tabs .tabbable .tab-pane li a { font:bold 12px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
#tabs .inside li span.meta, .widget_woodojo_tabs .tabbable .tab-pane li span.meta { font:300 11px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
#tabs ul.wooTabs li a, .widget_woodojo_tabs .tabbable .nav-tabs li a { font:300 11px/2em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
@media only screen and (min-width:768px) {
ul.nav li a, #navigation ul.rss a, #navigation ul.cart a.cart-contents, #navigation .cart-contents #navigation ul.rss, #navigation ul.nav-search, #navigation ul.nav-search a { font:300 14px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#666666; } #navigation ul.rss li a:before, #navigation ul.nav-search a.search-contents:before { color:#666666;}
#navigation ul.nav li ul, #navigation ul.cart > li > ul > div  { border: 0px solid #dbdbdb; }
#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation ul.nav > li  { border-right: 0px solid #dbdbdb; }#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation { box-shadow: none; -moz-box-shadow: none; -webkit-box-shadow: none; }#navigation ul li:first-child, #navigation ul li:first-child a { border-radius:0px 0 0 0px; -moz-border-radius:0px 0 0 0px; -webkit-border-radius:0px 0 0 0px; }
#navigation {border-top:0px solid #dbdbdb;border-bottom:0px solid #dbdbdb;border-left:0px solid #dbdbdb;border-right:0px solid #dbdbdb;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
#top ul.nav li a { font:300 12px/1.6em Helvetica Neue, Helvetica, sans-serif;color:#ddd; }
}
#footer, #footer p { font:300 13px/1.4em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
#footer {border-top:1px solid #dbdbdb;border-bottom:0px solid ;border-left:0px solid ;border-right:0px solid ;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
.magazine #loopedSlider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-magazine .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.magazine #loopedSlider .content .excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-magazine .slide-content p, .wooslider-theme-magazine .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.magazine .block .post .title a {font:bold 18px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }
#loopedSlider.business-slider .content h2 { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#loopedSlider.business-slider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#wrapper #loopedSlider.business-slider .content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.archive_header { font:bold 18px/1em Arial, sans-serif;color:#222222; }
.archive_header {border-bottom:1px solid #e6e6e6;}
.archive_header .catrss { display:none; }
</style>
<!-- Woo Shortcodes CSS -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/functions/css/shortcodes.css" rel="stylesheet" type="text/css"/>
<!-- Custom Stylesheet -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/custom.css" rel="stylesheet" type="text/css"/>
<!-- Theme version -->
<meta content="Canvas 5.9.21" name="generator"/>
<meta content="WooFramework 6.2.9" name="generator"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-32x32.png" rel="icon" sizes="32x32"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-192x192.png" rel="icon" sizes="192x192"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-180x180.png" rel="apple-touch-icon-precomposed"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-270x270.png" name="msapplication-TileImage"/>
</head>
<body class="post-template-default single single-post postid-4434 single-format-standard gecko alt-style-default two-col-left width-960 two-col-left-960">
<div id="wrapper">
<div id="inner-wrapper">
<h3 class="nav-toggle icon"><a href="#navigation">Navigation</a></h3>
<header class="col-full" id="header">
<div id="logo">
<a href="https://machinelearningmastery.com/" title="Making developers awesome at machine learning"><img alt="Machine Learning Mastery" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/MachineLearningMastery.png"/></a>
<span class="site-title"><a href="https://machinelearningmastery.com/">Machine Learning Mastery</a></span>
<span class="site-description">Making developers awesome at machine learning</span>
</div>
<div class="header-widget">
<div class="widget widget_text" id="text-3"> <div class="textwidget"><br/>
<div style="font-size:12pt;">
<a href="/start-here"><strong>Start Here</strong></a>
     
<a href="/blog">Blog</a>
     
<a href="/products">Books</a>
     
<a href="/about">About</a>
     
<a href="/contact">Contact</a>
</div></div>
</div><div class="widget widget_search" id="search-3"><div class="search_main">
<form action="https://machinelearningmastery.com/" class="searchform" method="get">
<input class="field s" name="s" onblur="if (this.value == '') {this.value = 'Search...';}" onfocus="if (this.value == 'Search...') {this.value = '';}" type="text" value="Search..."/>
<button class="fa fa-search submit" name="submit" type="submit" value="Search"></button>
</form>
<div class="fix"></div>
</div></div><div class="widget widget_text" id="text-44"> <div class="textwidget"><p>Need help with Deep Learning for Text? <a href="https://machinelearningmastery.lpages.co/dlfnlp-mini-course/">Take the FREE Mini-Course</a></p>
</div>
</div> </div>
</header>
<nav class="col-full" id="navigation" role="navigation">
<section class="menus">
<a class="nav-home" href="https://machinelearningmastery.com"><span>Home</span></a>
<h3>Empty Menu</h3> <div class="side-nav">
</div><!-- /#side-nav -->
</section><!-- /.menus -->
<a class="nav-close" href="#top"><span>Return to Content</span></a>
</nav>
<!-- #content Starts -->
<div class="col-full" id="content">
<div id="main-sidebar-container">
<!-- #main Starts -->
<section id="main">
<article class="post-4434 post type-post status-publish format-standard has-post-thumbnail hentry category-natural-language-processing">
<header>
<h1 class="title entry-title">How to Prepare a Photo Caption Dataset for Training a Deep Learning Model</h1> </header>
<div class="post-meta"><span class="small">By</span> <span class="author vcard"><span class="fn"><a href="https://machinelearningmastery.com/author/jasonb/" rel="author" title="Posts by Jason Brownlee">Jason Brownlee</a></span></span> <span class="small">on</span> <abbr class="date time published updated" title="2017-11-15T05:00:55+1100">November 15, 2017</abbr> <span class="small">in</span> <span class="categories"><a href="https://machinelearningmastery.com/category/natural-language-processing/" title="View all items in Natural Language Processing">Natural Language Processing</a></span> </div>
<section class="entry">
<div class="apss-social-share apss-theme-4 clearfix">
<div class="apss-twitter apss-single-icon">
<a href="javascript:void(0);" onclick="apss_open_in_popup_window(event, 'https://twitter.com/intent/tweet?text=How%20to%20Prepare%20a%20Photo%20Caption%20Dataset%20for%20Training%20a%20Deep%20Learning%20Model&amp;url=https%3A%2F%2Fmachinelearningmastery.com%2Fprepare-photo-caption-dataset-training-deep-learning-model%2F&amp;');" rel="nofollow" target="" title="Share on Twitter">
<div class="apss-icon-block clearfix">
<i class="fa fa-twitter"></i>
<span class="apss-social-text">Share on Twitter</span><span class="apss-share">Tweet</span>
</div>
</a>
</div>
<div class="apss-facebook apss-single-icon">
<a href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/" onclick="apss_open_in_popup_window(event, 'https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/');" rel="nofollow" target="" title="Share on Facebook">
<div class="apss-icon-block clearfix">
<i class="fa fa-facebook"></i>
<span class="apss-social-text">Share on Facebook</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-linkedin apss-single-icon">
<a href="http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Prepare%20a%20Photo%20Caption%20Dataset%20for%20Training%20a%20Deep%20Learning%20Model&amp;url=https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/&amp;summary=Automatic+photo+captioning+is+a+problem+where+a+model+must+generate+a+human-readable+textual+descrip..." onclick="apss_open_in_popup_window(event, 'http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Prepare%20a%20Photo%20Caption%20Dataset%20for%20Training%20a%20Deep%20Learning%20Model&amp;url=https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/&amp;summary=Automatic+photo+captioning+is+a+problem+where+a+model+must+generate+a+human-readable+textual+descrip...');" rel="nofollow" target="" title="Share on LinkedIn">
<div class="apss-icon-block clearfix"><i class="fa fa-linkedin"></i>
<span class="apss-social-text">Share on LinkedIn</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-google-plus apss-single-icon">
<a href="https://plus.google.com/share?url=https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/" onclick="apss_open_in_popup_window(event, 'https://plus.google.com/share?url=https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/');" rel="nofollow" target="" title="Share on Google Plus">
<div class="apss-icon-block clearfix">
<i class="fa fa-google-plus"></i>
<span class="apss-social-text">Share on Google Plus</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
</div><p>Automatic photo captioning is a problem where a model must generate a human-readable textual description given a photograph.</p>
<p>It is a challenging problem in artificial intelligence that requires both image understanding from the field of computer vision as well as language generation from the field of natural language processing.</p>
<p>It is now possible to develop your own image caption models using deep learning and freely available datasets of photos and their descriptions.</p>
<p>In this tutorial, you will discover how to prepare photos and textual descriptions ready for developing a deep learning automatic photo caption generation model.</p>
<p>After completing this tutorial, you will know:</p>
<ul>
<li>About the Flickr8K dataset comprised of more than 8,000 photos and up to 5 captions for each photo.</li>
<li>How to generally load and prepare photo and text data for modeling with deep learning.</li>
<li>How to specifically encode data for two different types of deep learning models in Keras.</li>
</ul>
<p>Let’s get started.</p>
<ul>
<li><strong>Update Nov/2017</strong>: Fixed small typos in the code in the “<em>Whole Description Sequence Model</em>” section. Thanks Moustapha Cheikh and Matthew.</li>
</ul>
<div class="wp-caption aligncenter" id="attachment_4435" style="max-width: 650px"><img alt="How to Prepare a Photo Caption Dataset for Training a Deep Learning Model" class="size-full wp-image-4435" height="400" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Prepare-a-Photo-Caption-Dataset-for-Training-a-Deep-Learning-Model.jpg" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Prepare-a-Photo-Caption-Dataset-for-Training-a-Deep-Learning-Model.jpg 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Prepare-a-Photo-Caption-Dataset-for-Training-a-Deep-Learning-Model-300x188.jpg 300w" width="640"/><p class="wp-caption-text">How to Prepare a Photo Caption Dataset for Training a Deep Learning Model<br/>Photo by <a href="https://www.flickr.com/photos/beverlyislike/3307325815/">beverlyislike</a>, some rights reserved.</p></div>
<h2>Tutorial Overview</h2>
<p>This tutorial is divided into 9 parts; they are:</p>
<ol>
<li>Download the Flickr8K Dataset</li>
<li>How to Load Photographs</li>
<li>Pre-Calculate Photo Features</li>
<li>How to Load Descriptions</li>
<li>Prepare Description Text</li>
<li>Whole Description Sequence Model</li>
<li>Word-By-Word Model</li>
<li>Progressive Loading</li>
<li>Pre-Calculate Photo Features</li>
</ol>
<h3>Python Environment</h3>
<p>This tutorial assumes you have a Python 3 SciPy environment installed. You can use Python 2, but you may need to change some of the examples.</p>
<p>You must have Keras (2.0 or higher) installed with either the TensorFlow or Theano backend.</p>
<p>The tutorial also assumes you have scikit-learn, Pandas, NumPy and Matplotlib installed.</p>
<p>If you need help with your environment, see this post:</p>
<ul>
<li><a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/">How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda</a></li>
</ul>
<!-- Start shortcoder --><p></p><div class="woo-sc-hr"></div>
<center>
<h3>Need help with Deep Learning for Text Data?</h3>
<p>Take my free 7-day email crash course now (with sample code).</p>
<p>Click to sign-up and also get a free PDF Ebook version of the course.</p>
<p><a href="https://machinelearningmastery.lpages.co/leadbox/144855173f72a2%3A164f8be4f346dc/5655638436741120/" rel="noopener" style="background: #ffce0a; color: #ffffff; text-decoration: none; font-family: Helvetica, Arial, sans-serif; font-weight: bold; font-size: 16px; line-height: 20px; padding: 10px; display: inline-block; max-width: 300px; border-radius: 5px; text-shadow: rgba(0, 0, 0, 0.25) 0px -1px 1px; box-shadow: rgba(255, 255, 255, 0.5) 0px 1px 3px inset, rgba(0, 0, 0, 0.5) 0px 1px 3px;" target="_blank">Start Your FREE Crash-Course Now</a><script data-config="%7B%7D" data-leadbox="144855173f72a2:164f8be4f346dc" data-url="https://machinelearningmastery.lpages.co/leadbox/144855173f72a2%3A164f8be4f346dc/5655638436741120/" src="https://machinelearningmastery.lpages.co/leadbox-1509466860.js" type="text/javascript"></script></p>
</center>
<p></p><div class="woo-sc-hr"></div><!-- End shortcoder v4.1.5-->
<h2>Download the Flickr8K Dataset</h2>
<p>A good dataset to use when getting started with image captioning is the Flickr8K dataset.</p>
<p>The reason is that it is realistic and relatively small so that you can download it and build models on your workstation using a CPU.</p>
<p>The definitive description of the dataset is in the paper “<a href="https://www.jair.org/media/3994/live-3994-7274-jair.pdf">Framing Image Description as a Ranking Task: Data, Models and Evaluation Metrics</a>” from 2013.</p>
<p>The authors describe the dataset as follows:</p>
<blockquote><p>We introduce a new benchmark collection for sentence-based image description and search, consisting of 8,000 images that are each paired with five different captions which provide clear descriptions of the salient entities and events.</p>
<p>…</p>
<p>The images were chosen from six different Flickr groups, and tend not to contain any well-known people or locations, but were manually selected to depict a variety of scenes and situations.</p></blockquote>
<p>— <a href="https://www.jair.org/media/3994/live-3994-7274-jair.pdf">Framing Image Description as a Ranking Task: Data, Models and Evaluation Metrics</a>, 2013.</p>
<p>The dataset is available for free. You must complete a request form and the links to the dataset will be emailed to you. I would love to link to them for you, but the email address expressly requests: “<em>Please do not redistribute the dataset</em>“.</p>
<p>You can use the link below to request the dataset:</p>
<ul>
<li><a href="https://illinois.edu/fb/sec/1713398">Dataset Request Form</a></li>
</ul>
<p>Within a short time, you will receive an email that contains links to two files:</p>
<ul>
<li><strong>Flickr8k_Dataset.zip</strong> (1 Gigabyte) An archive of all photographs.</li>
<li><strong>Flickr8k_text.zip</strong> (2.2 Megabytes) An archive of all text descriptions for photographs.</li>
</ul>
<p>Download the datasets and unzip them into your current working directory. You will have two directories:</p>
<ul>
<li><strong>Flicker8k_Dataset</strong>: Contains 8092 photographs in jpeg format.</li>
<li><strong>Flickr8k_text</strong>: Contains a number of files containing different sources of descriptions for the photographs.</li>
</ul>
<p>Next, let’s look at how to load the images.</p>
<h2>How to Load Photographs</h2>
<p>In this section, we will develop some code to load the photos for use with the Keras deep learning library in Python.</p>
<p>The image file names are unique image identifiers. For example, here is a sample of image file names:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec256681656409" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
990890291_afc72be141.jpg
99171998_7cc800ceef.jpg
99679241_adc853a5c0.jpg
997338199_7343367d7f.jpg
997722733_0cb5439472.jpg</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec256681656409-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec256681656409-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec256681656409-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec256681656409-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec256681656409-5">5</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec256681656409-1">990890291_afc72be141.jpg</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec256681656409-2">99171998_7cc800ceef.jpg</div><div class="crayon-line" id="crayon-5a658f57ec256681656409-3">99679241_adc853a5c0.jpg</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec256681656409-4">997338199_7343367d7f.jpg</div><div class="crayon-line" id="crayon-5a658f57ec256681656409-5">997722733_0cb5439472.jpg</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Keras provides the <em>load_img()</em> function that can be used to load the image files directly as an array of pixels.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec260770981025" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from keras.preprocessing.image import load_img
image = load_img('990890291_afc72be141.jpg')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec260770981025-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec260770981025-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec260770981025-1"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">load_img</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec260770981025-2"><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-s">'990890291_afc72be141.jpg'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>The pixel data needs to be converted to a NumPy array for use in Keras.</p>
<p>We can use the <em>img_to_array()</em> keras function to convert the loaded data.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec263467258429" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from keras.preprocessing.image import img_to_array
image = img_to_array(image)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec263467258429-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec263467258429-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec263467258429-1"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">img_to_array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec263467258429-2"><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>We may want to use a pre-defined feature extraction model, such as a state-of-the-art deep image classification network trained on Image net. The Oxford Visual Geometry Group (VGG) model is popular for this purpose and is available in Keras.</p>
<p>The Oxford Visual Geometry Group (VGG) model is popular for this purpose and is available in Keras.</p>
<p>If we decide to use this pre-trained model as a feature extractor in our model, we can preprocess the pixel data for the model by using the <em>preprocess_input()</em> function in Keras, for example:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec266065464462" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from keras.applications.vgg16 import preprocess_input

# reshape data into a single sample of an image
image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
# prepare the image for the VGG model
image = preprocess_input(image)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec266065464462-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec266065464462-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec266065464462-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec266065464462-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec266065464462-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec266065464462-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec266065464462-1"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-v">preprocess_input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec266065464462-2"> </div><div class="crayon-line" id="crayon-5a658f57ec266065464462-3"><span class="crayon-p"># reshape data into a single sample of an image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec266065464462-4"><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec266065464462-5"><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec266065464462-6"><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0006 seconds] -->
<p>We may also want to force the loading of the photo to have the same pixel dimensions as the VGG model, which are 224 x 224 pixels. We can do that in the call to <em>load_img()</em>, for example:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec269843263482" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
image = load_img('990890291_afc72be141.jpg', target_size=(224, 224))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec269843263482-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec269843263482-1"><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-s">'990890291_afc72be141.jpg'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>We may want to extract the unique image identifier from the image filename. We can do that by splitting the filename string by the ‘.’ (period) character and retrieving the first element of the resulting array:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec26b146667834" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
image_id = filename.split('.')[0]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec26b146667834-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec26b146667834-1"><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>We can tie all of this together and develop a function that, given the name of the directory containing the photos, will load and pre-process all of the photos for the VGG model and return them in a dictionary keyed on their unique image identifiers.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec26d305240787" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from os import listdir
from keras.preprocessing.image import load_img
from keras.preprocessing.image import img_to_array
from keras.applications.vgg16 import preprocess_input

def load_photos(directory):
	images = dict()
	for name in listdir(directory):
		# load an image from file
		filename = directory + '/' + name
		image = load_img(filename, target_size=(224, 224))
		# convert the image pixels to a numpy array
		image = img_to_array(image)
		# reshape data for the model
		image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
		# prepare the image for the VGG model
		image = preprocess_input(image)
		# get image id
		image_id = name.split('.')[0]
		images[image_id] = image
	return images

# load images
directory = 'Flicker8k_Dataset'
images = load_photos(directory)
print('Loaded Images: %d' % len(images))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec26d305240787-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec26d305240787-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec26d305240787-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec26d305240787-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec26d305240787-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec26d305240787-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec26d305240787-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec26d305240787-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec26d305240787-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec26d305240787-10">10</div><div class="crayon-num" data-line="crayon-5a658f57ec26d305240787-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec26d305240787-12">12</div><div class="crayon-num" data-line="crayon-5a658f57ec26d305240787-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec26d305240787-14">14</div><div class="crayon-num" data-line="crayon-5a658f57ec26d305240787-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec26d305240787-16">16</div><div class="crayon-num" data-line="crayon-5a658f57ec26d305240787-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec26d305240787-18">18</div><div class="crayon-num" data-line="crayon-5a658f57ec26d305240787-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec26d305240787-20">20</div><div class="crayon-num" data-line="crayon-5a658f57ec26d305240787-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec26d305240787-22">22</div><div class="crayon-num" data-line="crayon-5a658f57ec26d305240787-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec26d305240787-24">24</div><div class="crayon-num" data-line="crayon-5a658f57ec26d305240787-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec26d305240787-26">26</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec26d305240787-1"><span class="crayon-e">from </span><span class="crayon-e">os </span><span class="crayon-e">import </span><span class="crayon-e">listdir</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec26d305240787-2"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">load_img</span></div><div class="crayon-line" id="crayon-5a658f57ec26d305240787-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">img_to_array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec26d305240787-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">preprocess_input</span></div><div class="crayon-line" id="crayon-5a658f57ec26d305240787-5"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec26d305240787-6"><span class="crayon-e">def </span><span class="crayon-e">load_photos</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec26d305240787-7"><span class="crayon-h"> </span><span class="crayon-v">images</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec26d305240787-8"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">listdir</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec26d305240787-9"><span class="crayon-h"> </span><span class="crayon-p"># load an image from file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec26d305240787-10"><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">name</span></div><div class="crayon-line" id="crayon-5a658f57ec26d305240787-11"><span class="crayon-e"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec26d305240787-12"><span class="crayon-h"> </span><span class="crayon-p"># convert the image pixels to a numpy array</span></div><div class="crayon-line" id="crayon-5a658f57ec26d305240787-13"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec26d305240787-14"><span class="crayon-h"> </span><span class="crayon-p"># reshape data for the model</span></div><div class="crayon-line" id="crayon-5a658f57ec26d305240787-15"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec26d305240787-16"><span class="crayon-h"> </span><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line" id="crayon-5a658f57ec26d305240787-17"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec26d305240787-18"><span class="crayon-h"> </span><span class="crayon-p"># get image id</span></div><div class="crayon-line" id="crayon-5a658f57ec26d305240787-19"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec26d305240787-20"><span class="crayon-h"> </span><span class="crayon-v">images</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">image</span></div><div class="crayon-line" id="crayon-5a658f57ec26d305240787-21"><span class="crayon-e"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">images</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec26d305240787-22"> </div><div class="crayon-line" id="crayon-5a658f57ec26d305240787-23"><span class="crayon-p"># load images</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec26d305240787-24"><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flicker8k_Dataset'</span></div><div class="crayon-line" id="crayon-5a658f57ec26d305240787-25"><span class="crayon-v">images</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photos</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec26d305240787-26"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Loaded Images: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">images</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0019 seconds] -->
<p>Running this example prints the number of loaded images. It takes a few minutes to run.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec270114435836" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Loaded Images: 8091</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec270114435836-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec270114435836-1">Loaded Images: 8091</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>If you do not have the RAM to hold all images (about 5GB by my estimation), then you can add an if-statement to break the loop early after 100 images have been loaded, for example:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec272498584092" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
if (len(images) &gt;= 100):
	break</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec272498584092-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec272498584092-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec272498584092-1"><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">images</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&gt;=</span><span class="crayon-h"> </span><span class="crayon-cn">100</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec272498584092-2"><span class="crayon-h"> </span><span class="crayon-st">break</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p></p>
<h2>Pre-Calculate Photo Features</h2>
<p>It is possible to use a pre-trained model to extract the features from photos in the dataset and store the features to file.</p>
<p>This is an efficiency that means that the language part of the model that turns features extracted from the photo into textual descriptions can be trained standalone from the feature extraction model. The benefit is that the very large pre-trained models do not need to be loaded, held in memory, and used to process each photo while training the language model.</p>
<p>Later, the feature extraction model and language model can be put back together for making predictions on new photos.</p>
<p>In this section, we will extend the photo loading behavior developed in the previous section to load all photos, extract their features using a pre-trained VGG model, and store the extracted features to a new file that can be loaded and used to train the language model.</p>
<p>The first step is to load the VGG model. This model is provided directly in Keras and can be loaded as follows. Note that this will download the 500-megabyte model weights to your computer, which may take a few minutes.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec275564274067" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from keras.applications.vgg16 import VGG16
# load the model
in_layer = Input(shape=(224, 224, 3))
model = VGG16(include_top=False, input_tensor=in_layer, pooling='avg')
print(model.summary())</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec275564274067-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec275564274067-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec275564274067-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec275564274067-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec275564274067-5">5</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec275564274067-1"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-v">VGG16</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec275564274067-2"><span class="crayon-p"># load the model</span></div><div class="crayon-line" id="crayon-5a658f57ec275564274067-3"><span class="crayon-v">in_layer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec275564274067-4"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VGG16</span><span class="crayon-sy">(</span><span class="crayon-v">include_top</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_tensor</span><span class="crayon-o">=</span><span class="crayon-v">in_layer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">pooling</span><span class="crayon-o">=</span><span class="crayon-s">'avg'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec275564274067-5"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>This will load the VGG 16-layer model.</p>
<p>The two Dense output layers as well as the classification output layer are removed from the model by setting <em>include_top=False</em>. The output from the final pooling layer is taken as the features extracted from the image.</p>
<p>Next, we can walk over all images in the directory of images as in the previous section and call <em>predict()</em> function on the model for each prepared image to get the extracted features. The features can then be stored in a dictionary keyed on the image id.</p>
<p>The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec278616843575" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from os import listdir
from pickle import dump
from keras.applications.vgg16 import VGG16
from keras.preprocessing.image import load_img
from keras.preprocessing.image import img_to_array
from keras.applications.vgg16 import preprocess_input
from keras.layers import Input

# extract features from each photo in the directory
def extract_features(directory):
	# load the model
	in_layer = Input(shape=(224, 224, 3))
	model = VGG16(include_top=False, input_tensor=in_layer)
	print(model.summary())
	# extract features from each photo
	features = dict()
	for name in listdir(directory):
		# load an image from file
		filename = directory + '/' + name
		image = load_img(filename, target_size=(224, 224))
		# convert the image pixels to a numpy array
		image = img_to_array(image)
		# reshape data for the model
		image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
		# prepare the image for the VGG model
		image = preprocess_input(image)
		# get features
		feature = model.predict(image, verbose=0)
		# get image id
		image_id = name.split('.')[0]
		# store feature
		features[image_id] = feature
		print('&gt;%s' % name)
	return features

# extract features from all images
directory = 'Flicker8k_Dataset'
features = extract_features(directory)
print('Extracted Features: %d' % len(features))
# save to file
dump(features, open('features.pkl', 'wb'))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-10">10</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-12">12</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-14">14</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-16">16</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-18">18</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-20">20</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-22">22</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-24">24</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-26">26</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-28">28</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-30">30</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-32">32</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-34">34</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-36">36</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-38">38</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec278616843575-40">40</div><div class="crayon-num" data-line="crayon-5a658f57ec278616843575-41">41</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec278616843575-1"><span class="crayon-e">from </span><span class="crayon-e">os </span><span class="crayon-e">import </span><span class="crayon-e">listdir</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-2"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-e">dump</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">VGG16</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">load_img</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">img_to_array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-6"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">preprocess_input</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-7"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-v">Input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-8"> </div><div class="crayon-line" id="crayon-5a658f57ec278616843575-9"><span class="crayon-p"># extract features from each photo in the directory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-10"><span class="crayon-e">def </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-11"><span class="crayon-h"> </span><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-12"><span class="crayon-h"> </span><span class="crayon-v">in_layer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-13"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VGG16</span><span class="crayon-sy">(</span><span class="crayon-v">include_top</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_tensor</span><span class="crayon-o">=</span><span class="crayon-v">in_layer</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-14"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-15"><span class="crayon-h"> </span><span class="crayon-p"># extract features from each photo</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-16"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-17"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">listdir</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-18"><span class="crayon-h"> </span><span class="crayon-p"># load an image from file</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-19"><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">name</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-20"><span class="crayon-e"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-21"><span class="crayon-h"> </span><span class="crayon-p"># convert the image pixels to a numpy array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-22"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-23"><span class="crayon-h"> </span><span class="crayon-p"># reshape data for the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-24"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-25"><span class="crayon-h"> </span><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-26"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-27"><span class="crayon-h"> </span><span class="crayon-p"># get features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-28"><span class="crayon-h"> </span><span class="crayon-v">feature</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-29"><span class="crayon-h"> </span><span class="crayon-p"># get image id</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-30"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-31"><span class="crayon-h"> </span><span class="crayon-p"># store feature</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-32"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">feature</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-33"><span class="crayon-e"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'&gt;%s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-34"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-35"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-36"><span class="crayon-p"># extract features from all images</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-37"><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flicker8k_Dataset'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-38"><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-39"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Extracted Features: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec278616843575-40"><span class="crayon-p"># save to file</span></div><div class="crayon-line" id="crayon-5a658f57ec278616843575-41"><span class="crayon-e">dump</span><span class="crayon-sy">(</span><span class="crayon-v">features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0026 seconds] -->
<p>The example may take some time to complete, perhaps one hour.</p>
<p>After all features are extracted, the dictionary is stored in the file ‘<em>features.pkl</em>‘ in the current working directory.</p>
<p>These features can then be loaded later and used as input for training a language model.</p>
<p>You could experiment with other types of pre-trained models in Keras.</p>
<h2>How to Load Descriptions</h2>
<p>It is important to take a moment to talk about the descriptions; there are a number available.</p>
<p>The file <em>Flickr8k.token.txt</em> contains a list of image identifiers (used in the image filenames) and tokenized descriptions. Each image has multiple descriptions.</p>
<p>Below is a sample of the descriptions from the file showing 5 different descriptions for a single image.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec27e607860245" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
1305564994_00513f9a5b.jpg#0 A man in street racer armor be examine the tire of another racer 's motorbike .
1305564994_00513f9a5b.jpg#1 Two racer drive a white bike down a road .
1305564994_00513f9a5b.jpg#2 Two motorist be ride along on their vehicle that be oddly design and color .
1305564994_00513f9a5b.jpg#3 Two person be in a small race car drive by a green hill .
1305564994_00513f9a5b.jpg#4 Two person in race uniform in a street car .</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec27e607860245-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec27e607860245-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec27e607860245-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec27e607860245-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec27e607860245-5">5</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec27e607860245-1">1305564994_00513f9a5b.jpg#0 A man in street racer armor be examine the tire of another racer 's motorbike .</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec27e607860245-2">1305564994_00513f9a5b.jpg#1 Two racer drive a white bike down a road .</div><div class="crayon-line" id="crayon-5a658f57ec27e607860245-3">1305564994_00513f9a5b.jpg#2 Two motorist be ride along on their vehicle that be oddly design and color .</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec27e607860245-4">1305564994_00513f9a5b.jpg#3 Two person be in a small race car drive by a green hill .</div><div class="crayon-line" id="crayon-5a658f57ec27e607860245-5">1305564994_00513f9a5b.jpg#4 Two person in race uniform in a street car .</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>The file <em>ExpertAnnotations.txt</em> indicates which of the descriptions for each image were written by “<em>experts</em>” which were written by crowdsource workers asked to describe the image.</p>
<p>Finally, the file <em>CrowdFlowerAnnotations.txt</em> provides the frequency of crowd workers that indicate whether captions suit each image. These frequencies can be interpreted probabilistically.</p>
<p>The authors of the paper describe the annotations as follows:</p>
<blockquote><p>… annotators were asked to write sentences that describe the depicted scenes, situations, events and entities (people, animals, other objects). We collected multiple captions for each image because there is a considerable degree of variance in the way many images can be described.</p></blockquote>
<p>— <a href="https://www.jair.org/media/3994/live-3994-7274-jair.pdf">Framing Image Description as a Ranking Task: Data, Models and Evaluation Metrics</a>, 2013.</p>
<p>There are also lists of the photo identifiers to use in a train/test split so that you can compare results reported in the paper.</p>
<p>The first step is to decide which captions to use. The simplest approach is to use the first description for each photograph.</p>
<p>First, we need a function to load the entire annotations file (‘<em>Flickr8k.token.txt</em>‘) into memory. Below is a function to do this called <em>load_doc()</em> that, given a filename, will return the document as a string.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec282580348551" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec282580348551-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec282580348551-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec282580348551-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec282580348551-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec282580348551-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec282580348551-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec282580348551-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec282580348551-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec282580348551-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec282580348551-1"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec282580348551-2"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec282580348551-3"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec282580348551-4"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec282580348551-5"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec282580348551-6"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec282580348551-7"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec282580348551-8"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec282580348551-9"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>We can see from the sample of the file above that we need only split each line by white space and take the first element as the image identifier and the rest as the image description. For example:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec284242114424" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# split line by white space
tokens = line.split()
# take the first token as the image id, the rest as the description
image_id, image_desc = tokens[0], tokens[1:]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec284242114424-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec284242114424-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec284242114424-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec284242114424-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec284242114424-1"><span class="crayon-p"># split line by white space</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec284242114424-2"><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec284242114424-3"><span class="crayon-p"># take the first token as the image id, the rest as the description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec284242114424-4"><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>We can then clean up the image identifier by removing the filename extension and the description number.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec287556468249" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# remove filename from image id
image_id = image_id.split('.')[0]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec287556468249-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec287556468249-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec287556468249-1"><span class="crayon-p"># remove filename from image id</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec287556468249-2"><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>We can also put the description tokens back together into a string for later processing.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec289828542567" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# convert description tokens back to string
image_desc = ' '.join(image_desc)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec289828542567-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec289828542567-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec289828542567-1"><span class="crayon-p"># convert description tokens back to string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec289828542567-2"><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>We can put all of this together into a function.</p>
<p>Below defines the <em>load_descriptions()</em> function that will take the loaded file, process it line-by-line, and return a dictionary of image identifiers to their first description.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec28b696032624" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# extract descriptions for images
def load_descriptions(doc):
	mapping = dict()
	# process lines
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		if len(line) &lt; 2:
			continue
		# take the first token as the image id, the rest as the description
		image_id, image_desc = tokens[0], tokens[1:]
		# remove filename from image id
		image_id = image_id.split('.')[0]
		# convert description tokens back to string
		image_desc = ' '.join(image_desc)
		# store the first description for each image
		if image_id not in mapping:
			mapping[image_id] = image_desc
	return mapping

filename = 'Flickr8k_text/Flickr8k.token.txt'
doc = load_doc(filename)
descriptions = load_descriptions(doc)
print('Loaded: %d ' % len(descriptions))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-10">10</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-12">12</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-14">14</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-16">16</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-18">18</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-20">20</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-22">22</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-24">24</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-26">26</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-28">28</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-30">30</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-32">32</div><div class="crayon-num" data-line="crayon-5a658f57ec28b696032624-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec28b696032624-34">34</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec28b696032624-1"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-2"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-3"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-4"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-5"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-6"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-7"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-8"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-9"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-10"> </div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-11"><span class="crayon-p"># extract descriptions for images</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-12"><span class="crayon-e">def </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-13"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-14"><span class="crayon-h"> </span><span class="crayon-p"># process lines</span></div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-15"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-16"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-17"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-18"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-19"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-20"><span class="crayon-h"> </span><span class="crayon-p"># take the first token as the image id, the rest as the description</span></div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-21"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-22"><span class="crayon-h"> </span><span class="crayon-p"># remove filename from image id</span></div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-23"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-24"><span class="crayon-h"> </span><span class="crayon-p"># convert description tokens back to string</span></div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-25"><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-26"><span class="crayon-h"> </span><span class="crayon-p"># store the first description for each image</span></div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-27"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-28"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">image_desc</span></div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-29"><span class="crayon-e"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">mapping</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-30"> </div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-31"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr8k.token.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-32"><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec28b696032624-33"><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec28b696032624-34"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Loaded: %d '</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0019 seconds] -->
<p><span style="font-weight: 400;">Running the example prints the number of loaded image descriptions.</span></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec28e406525711" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Loaded: 8092</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec28e406525711-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec28e406525711-1">Loaded: 8092</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p><span style="font-weight: 400;">There are other ways to load descriptions that may turn out to be more accurate for the data.</span></p>
<p><span style="font-weight: 400;">Use the above example as a starting point and let me know what you come up with.<br/>
</span><span style="font-weight: 400;">Post your approach in the comments below.</span></p>
<h2>Prepare Description Text</h2>
<p>The descriptions are tokenized; this means that each token is comprised of words separated by white space.</p>
<p>It also means that punctuation are separated as their own tokens, such as periods (‘.’) and apostrophes for word plurals (‘s).</p>
<p>It is a good idea to clean up the description text before using it in a model. Some ideas of data cleaning we can form include:</p>
<ul>
<li>Normalizing the case of all tokens to lowercase.</li>
<li>Remove all punctuation from tokens.</li>
<li>Removing all tokens that contain one or fewer characters (after punctuation is removed), e.g. ‘a’ and hanging ‘s’ characters.</li>
</ul>
<p>We can implement these simple cleaning operations in a function that cleans each description in the loaded dictionary from the previous section. Below defines the <em>clean_descriptions()</em> function that will clean each loaded description.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec291868317042" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# clean description text
def clean_descriptions(descriptions):
	# prepare translation table for removing punctuation
	table = str.maketrans('', '', string.punctuation)
	for key, desc in descriptions.items():
		# tokenize
		desc = desc.split()
		# convert to lower case
		desc = [word.lower() for word in desc]
		# remove punctuation from each token
		desc = [w.translate(table) for w in desc]
		# remove hanging 's' and 'a'
		desc = [word for word in desc if len(word)&gt;1]
		# store as string
		descriptions[key] =  ' '.join(desc)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec291868317042-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec291868317042-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec291868317042-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec291868317042-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec291868317042-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec291868317042-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec291868317042-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec291868317042-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec291868317042-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec291868317042-10">10</div><div class="crayon-num" data-line="crayon-5a658f57ec291868317042-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec291868317042-12">12</div><div class="crayon-num" data-line="crayon-5a658f57ec291868317042-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec291868317042-14">14</div><div class="crayon-num" data-line="crayon-5a658f57ec291868317042-15">15</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec291868317042-1"><span class="crayon-p"># clean description text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec291868317042-2"><span class="crayon-e">def </span><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec291868317042-3"><span class="crayon-h"> </span><span class="crayon-p"># prepare translation table for removing punctuation</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec291868317042-4"><span class="crayon-h"> </span><span class="crayon-v">table</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">str</span><span class="crayon-sy">.</span><span class="crayon-e">maketrans</span><span class="crayon-sy">(</span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-sy">.</span><span class="crayon-v">punctuation</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec291868317042-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec291868317042-6"><span class="crayon-h"> </span><span class="crayon-p"># tokenize</span></div><div class="crayon-line" id="crayon-5a658f57ec291868317042-7"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec291868317042-8"><span class="crayon-h"> </span><span class="crayon-p"># convert to lower case</span></div><div class="crayon-line" id="crayon-5a658f57ec291868317042-9"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">.</span><span class="crayon-e">lower</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec291868317042-10"><span class="crayon-h"> </span><span class="crayon-p"># remove punctuation from each token</span></div><div class="crayon-line" id="crayon-5a658f57ec291868317042-11"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">w</span><span class="crayon-sy">.</span><span class="crayon-e">translate</span><span class="crayon-sy">(</span><span class="crayon-v">table</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec291868317042-12"><span class="crayon-h"> </span><span class="crayon-p"># remove hanging 's' and 'a'</span></div><div class="crayon-line" id="crayon-5a658f57ec291868317042-13"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-t">word</span><span class="crayon-sy">)</span><span class="crayon-o">&gt;</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec291868317042-14"><span class="crayon-h"> </span><span class="crayon-p"># store as string</span></div><div class="crayon-line" id="crayon-5a658f57ec291868317042-15"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h">  </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0014 seconds] -->
<p>We can then save the clean text to file for later use by our model.</p>
<p>Each line will contain the image identifier followed by the clean description. Below defines the <em>save_doc()</em> function for saving the cleaned descriptions to file.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec294948724937" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# save descriptions to file, one per line
def save_doc(descriptions, filename):
	lines = list()
	for key, desc in descriptions.items():
		lines.append(key + ' ' + desc)
	data = '\n'.join(lines)
	file = open(filename, 'w')
	file.write(data)
	file.close()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec294948724937-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec294948724937-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec294948724937-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec294948724937-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec294948724937-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec294948724937-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec294948724937-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec294948724937-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec294948724937-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec294948724937-1"><span class="crayon-p"># save descriptions to file, one per line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec294948724937-2"><span class="crayon-e">def </span><span class="crayon-e">save_doc</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec294948724937-3"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec294948724937-4"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec294948724937-5"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">key</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec294948724937-6"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'\n'</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec294948724937-7"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'w'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec294948724937-8"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec294948724937-9"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>Putting this all together with the loading of descriptions from the previous section, the complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec296985486276" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
import string

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# extract descriptions for images
def load_descriptions(doc):
	mapping = dict()
	# process lines
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		if len(line) &lt; 2:
			continue
		# take the first token as the image id, the rest as the description
		image_id, image_desc = tokens[0], tokens[1:]
		# remove filename from image id
		image_id = image_id.split('.')[0]
		# convert description tokens back to string
		image_desc = ' '.join(image_desc)
		# store the first description for each image
		if image_id not in mapping:
			mapping[image_id] = image_desc
	return mapping

# clean description text
def clean_descriptions(descriptions):
	# prepare translation table for removing punctuation
	table = str.maketrans('', '', string.punctuation)
	for key, desc in descriptions.items():
		# tokenize
		desc = desc.split()
		# convert to lower case
		desc = [word.lower() for word in desc]
		# remove punctuation from each token
		desc = [w.translate(table) for w in desc]
		# remove hanging 's' and 'a'
		desc = [word for word in desc if len(word)&gt;1]
		# store as string
		descriptions[key] =  ' '.join(desc)

# save descriptions to file, one per line
def save_doc(descriptions, filename):
	lines = list()
	for key, desc in descriptions.items():
		lines.append(key + ' ' + desc)
	data = '\n'.join(lines)
	file = open(filename, 'w')
	file.write(data)
	file.close()

filename = 'Flickr8k_text/Flickr8k.token.txt'
# load descriptions
doc = load_doc(filename)
# parse descriptions
descriptions = load_descriptions(doc)
print('Loaded: %d ' % len(descriptions))
# clean descriptions
clean_descriptions(descriptions)
# summarize vocabulary
all_tokens = ' '.join(descriptions.values()).split()
vocabulary = set(all_tokens)
print('Vocabulary Size: %d' % len(vocabulary))
# save descriptions
save_doc(descriptions, 'descriptions.txt')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-10">10</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-12">12</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-14">14</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-16">16</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-18">18</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-20">20</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-22">22</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-24">24</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-26">26</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-28">28</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-30">30</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-32">32</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-34">34</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-36">36</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-38">38</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-40">40</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-42">42</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-44">44</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-46">46</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-48">48</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-50">50</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-52">52</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-54">54</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-56">56</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-58">58</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-60">60</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-62">62</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-64">64</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-66">66</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-68">68</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-70">70</div><div class="crayon-num" data-line="crayon-5a658f57ec296985486276-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec296985486276-72">72</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec296985486276-1"><span class="crayon-e">import </span><span class="crayon-t">string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-2"> </div><div class="crayon-line" id="crayon-5a658f57ec296985486276-3"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-4"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-5"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-6"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-7"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-8"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-9"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-10"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-11"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-12"> </div><div class="crayon-line" id="crayon-5a658f57ec296985486276-13"><span class="crayon-p"># extract descriptions for images</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-14"><span class="crayon-e">def </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-15"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-16"><span class="crayon-h"> </span><span class="crayon-p"># process lines</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-17"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-18"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-19"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-20"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-21"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-22"><span class="crayon-h"> </span><span class="crayon-p"># take the first token as the image id, the rest as the description</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-23"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-24"><span class="crayon-h"> </span><span class="crayon-p"># remove filename from image id</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-25"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-26"><span class="crayon-h"> </span><span class="crayon-p"># convert description tokens back to string</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-27"><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-28"><span class="crayon-h"> </span><span class="crayon-p"># store the first description for each image</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-29"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-30"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">image_desc</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-31"><span class="crayon-e"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">mapping</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-32"> </div><div class="crayon-line" id="crayon-5a658f57ec296985486276-33"><span class="crayon-p"># clean description text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-34"><span class="crayon-e">def </span><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-35"><span class="crayon-h"> </span><span class="crayon-p"># prepare translation table for removing punctuation</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-36"><span class="crayon-h"> </span><span class="crayon-v">table</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">str</span><span class="crayon-sy">.</span><span class="crayon-e">maketrans</span><span class="crayon-sy">(</span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-sy">.</span><span class="crayon-v">punctuation</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-37"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-38"><span class="crayon-h"> </span><span class="crayon-p"># tokenize</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-39"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-40"><span class="crayon-h"> </span><span class="crayon-p"># convert to lower case</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-41"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">.</span><span class="crayon-e">lower</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-42"><span class="crayon-h"> </span><span class="crayon-p"># remove punctuation from each token</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-43"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">w</span><span class="crayon-sy">.</span><span class="crayon-e">translate</span><span class="crayon-sy">(</span><span class="crayon-v">table</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-44"><span class="crayon-h"> </span><span class="crayon-p"># remove hanging 's' and 'a'</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-45"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-t">word</span><span class="crayon-sy">)</span><span class="crayon-o">&gt;</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-46"><span class="crayon-h"> </span><span class="crayon-p"># store as string</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-47"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h">  </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-48"> </div><div class="crayon-line" id="crayon-5a658f57ec296985486276-49"><span class="crayon-p"># save descriptions to file, one per line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-50"><span class="crayon-e">def </span><span class="crayon-e">save_doc</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-51"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-52"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-53"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">key</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-54"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'\n'</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-55"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'w'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-56"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-57"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-58"> </div><div class="crayon-line" id="crayon-5a658f57ec296985486276-59"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr8k.token.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-60"><span class="crayon-p"># load descriptions</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-61"><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-62"><span class="crayon-p"># parse descriptions</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-63"><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-64"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Loaded: %d '</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-65"><span class="crayon-p"># clean descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-66"><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-67"><span class="crayon-p"># summarize vocabulary</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-68"><span class="crayon-v">all_tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-69"><span class="crayon-v">vocabulary</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">all_tokens</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-70"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">vocabulary</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec296985486276-71"><span class="crayon-p"># save descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec296985486276-72"><span class="crayon-e">save_doc</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0044 seconds] -->
<p>Running the example first loads 8,092 descriptions, cleans them, summarizes the vocabulary of 4,484 unique words, then saves them to a new file called ‘<em>descriptions.txt</em>‘.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec29a255902271" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Loaded: 8092
Vocabulary Size: 4484</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec29a255902271-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29a255902271-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec29a255902271-1">Loaded: 8092</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29a255902271-2">Vocabulary Size: 4484</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>Open the new file ‘<em>descriptions.txt</em>‘ in a text editor and review the contents. You should see somewhat readable descriptions of photos ready for modeling.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec29c718857383" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
...
3139118874_599b30b116 two girls pose for picture at christmastime
2065875490_a46b58c12b person is walking on sidewalk and skeleton is on the left inside of fence
2682382530_f9f8fd1e89 man in black shorts is stretching out his leg
3484019369_354e0b88c0 hockey team in red and white on the side of the ice rink
505955292_026f1489f2 boy rides horse</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec29c718857383-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29c718857383-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec29c718857383-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29c718857383-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec29c718857383-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29c718857383-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec29c718857383-1">...</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29c718857383-2">3139118874_599b30b116 two girls pose for picture at christmastime</div><div class="crayon-line" id="crayon-5a658f57ec29c718857383-3">2065875490_a46b58c12b person is walking on sidewalk and skeleton is on the left inside of fence</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29c718857383-4">2682382530_f9f8fd1e89 man in black shorts is stretching out his leg</div><div class="crayon-line" id="crayon-5a658f57ec29c718857383-5">3484019369_354e0b88c0 hockey team in red and white on the side of the ice rink</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29c718857383-6">505955292_026f1489f2 boy rides horse</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>The vocabulary is still relatively large. To make modeling easier, especially the first time around, I would recommend further reducing the vocabulary by removing words that only appear once or twice across all descriptions.</p>
<h2>Whole Description Sequence Model</h2>
<p>There are many ways to model the caption generation problem.</p>
<p>One naive way is to create a model that outputs the entire textual description in a one-shot manner.</p>
<p>This is a naive model because it puts a heavy burden on the model to both interpret the meaning of the photograph and generate words, then arrange those words into the correct order.</p>
<p>This is not unlike the language translation problem used in an Encoder-Decoder recurrent neural network where the entire translated sentence is output one word at a time given an encoding of the input sequence. Here we would use an encoding of the image to generate the output sentence instead.</p>
<p>The image may be encoded using a pre-trained model used for image classification, such as the VGG trained on the ImageNet model mentioned above.</p>
<p>The output of the model would be a probability distribution over each word in the vocabulary. The sequence would be as long as the longest photo description.</p>
<p>The descriptions would, therefore, need to be first integer encoded where each word in the vocabulary is assigned a unique integer and sequences of words would be replaced with sequences of integers. The integer sequences would then need to be one hot encoded to represent the idealized probability distribution over the vocabulary for each word in the sequence.</p>
<p>We can use tools in Keras to prepare the descriptions for this type of model.</p>
<p>The first step is to load the mapping of image identifiers to clean descriptions stored in ‘<em>descriptions.txt</em>‘.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec29f738011706" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load clean descriptions into memory
def load_clean_descriptions(filename):
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# store
		descriptions[image_id] = ' '.join(image_desc)
	return descriptions

descriptions = load_clean_descriptions('descriptions.txt')
print('Loaded %d' % (len(descriptions)))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec29f738011706-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29f738011706-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec29f738011706-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29f738011706-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec29f738011706-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29f738011706-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec29f738011706-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29f738011706-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec29f738011706-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29f738011706-10">10</div><div class="crayon-num" data-line="crayon-5a658f57ec29f738011706-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29f738011706-12">12</div><div class="crayon-num" data-line="crayon-5a658f57ec29f738011706-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29f738011706-14">14</div><div class="crayon-num" data-line="crayon-5a658f57ec29f738011706-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29f738011706-16">16</div><div class="crayon-num" data-line="crayon-5a658f57ec29f738011706-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29f738011706-18">18</div><div class="crayon-num" data-line="crayon-5a658f57ec29f738011706-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29f738011706-20">20</div><div class="crayon-num" data-line="crayon-5a658f57ec29f738011706-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29f738011706-22">22</div><div class="crayon-num" data-line="crayon-5a658f57ec29f738011706-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec29f738011706-24">24</div><div class="crayon-num" data-line="crayon-5a658f57ec29f738011706-25">25</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec29f738011706-1"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29f738011706-2"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec29f738011706-3"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29f738011706-4"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec29f738011706-5"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29f738011706-6"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec29f738011706-7"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29f738011706-8"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec29f738011706-9"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29f738011706-10"> </div><div class="crayon-line" id="crayon-5a658f57ec29f738011706-11"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29f738011706-12"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec29f738011706-13"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29f738011706-14"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec29f738011706-15"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29f738011706-16"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5a658f57ec29f738011706-17"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29f738011706-18"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line" id="crayon-5a658f57ec29f738011706-19"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29f738011706-20"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5a658f57ec29f738011706-21"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29f738011706-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">descriptions</span></div><div class="crayon-line" id="crayon-5a658f57ec29f738011706-23"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec29f738011706-24"><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec29f738011706-25"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Loaded %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0016 seconds] -->
<p>Running this piece loads the 8,092 photo descriptions into a dictionary keyed on image identifiers. These identifiers can then be used to load each photo file for the corresponding inputs to the model.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2a3515174560" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Loaded 8092</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2a3515174560-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2a3515174560-1">Loaded 8092</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>Next, we need to extract all of the description text so we can encode it.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2a5332250666" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# extract all text
desc_text = list(descriptions.values())</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2a5332250666-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2a5332250666-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2a5332250666-1"><span class="crayon-p"># extract all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2a5332250666-2"><span class="crayon-v">desc_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>We can use the Keras <em>Tokenizer</em> class to consistently map each word in the vocabulary to an integer. First, the object is created, then is fit on the description text. The fit tokenizer can later be saved to file for consistent decoding of the predictions back to vocabulary words.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2a7879676938" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from keras.preprocessing.text import Tokenizer
# prepare tokenizer
tokenizer = Tokenizer()
tokenizer.fit_on_texts(desc_text)
vocab_size = len(tokenizer.word_index) + 1
print('Vocabulary Size: %d' % vocab_size)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2a7879676938-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2a7879676938-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2a7879676938-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2a7879676938-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec2a7879676938-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2a7879676938-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2a7879676938-1"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">text </span><span class="crayon-e">import </span><span class="crayon-v">Tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2a7879676938-2"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line" id="crayon-5a658f57ec2a7879676938-3"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2a7879676938-4"><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">desc_text</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2a7879676938-5"><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2a7879676938-6"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>Next, we can use the fit tokenizer to encode the photo descriptions into sequences of integers.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2aa111683535" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# integer encode descriptions
sequences = tokenizer.texts_to_sequences(desc_text)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2aa111683535-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2aa111683535-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2aa111683535-1"><span class="crayon-p"># integer encode descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2aa111683535-2"><span class="crayon-v">sequences</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">desc_text</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>The model will require all output sequences to have the same length for training. We can achieve this by padding all encoded sequences to have the same length as the longest encoded sequence. We can pad the sequences with 0 values after the list of words. Keras provides the <em>pad_sequences()</em> function to pad the sequences.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2ac116339710" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from keras.preprocessing.sequence import pad_sequences
# pad all sequences to a fixed length
max_length = max(len(s) for s in sequences)
print('Description Length: %d' % max_length)
padded = pad_sequences(sequences, maxlen=max_length, padding='post')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2ac116339710-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ac116339710-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2ac116339710-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ac116339710-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec2ac116339710-5">5</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2ac116339710-1"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">sequence </span><span class="crayon-e">import </span><span class="crayon-v">pad_sequences</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ac116339710-2"><span class="crayon-p"># pad all sequences to a fixed length</span></div><div class="crayon-line" id="crayon-5a658f57ec2ac116339710-3"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">max</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">sequences</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ac116339710-4"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Description Length: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2ac116339710-5"><span class="crayon-v">padded</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">sequences</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">padding</span><span class="crayon-o">=</span><span class="crayon-s">'post'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>Finally, we can one hot encode the padded sequences to have one sparse vector for each word in the sequence. Keras provides the <em>to_categorical()</em> function to perform this operation.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2ae078236401" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from keras.utils import to_categorical
# one hot encode
y = to_categorical(padded, num_classes=vocab_size)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2ae078236401-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ae078236401-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2ae078236401-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2ae078236401-1"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-e">import </span><span class="crayon-v">to_categorical</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ae078236401-2"><span class="crayon-p"># one hot encode</span></div><div class="crayon-line" id="crayon-5a658f57ec2ae078236401-3"><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-v">padded</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>Once encoded, we can ensure that the sequence output data has the right shape for the model.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2b1997649492" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
y = y.reshape((len(descriptions), max_length, vocab_size))
print(y.shape)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2b1997649492-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b1997649492-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2b1997649492-1"><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b1997649492-2"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>Putting all of this together, the complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2b3427164129" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from numpy import array
from keras.preprocessing.text import Tokenizer
from keras.preprocessing.sequence import pad_sequences
from keras.utils import to_categorical

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load clean descriptions into memory
def load_clean_descriptions(filename):
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# store
		descriptions[image_id] = ' '.join(image_desc)
	return descriptions

descriptions = load_clean_descriptions('descriptions.txt')
print('Loaded %d' % (len(descriptions)))
# extract all text
desc_text = list(descriptions.values())
# prepare tokenizer
tokenizer = Tokenizer()
tokenizer.fit_on_texts(desc_text)
vocab_size = len(tokenizer.word_index) + 1
print('Vocabulary Size: %d' % vocab_size)
# integer encode descriptions
sequences = tokenizer.texts_to_sequences(desc_text)
# pad all sequences to a fixed length
max_length = max(len(s) for s in sequences)
print('Description Length: %d' % max_length)
padded = pad_sequences(sequences, maxlen=max_length, padding='post')
# one hot encode
y = to_categorical(padded, num_classes=vocab_size)
y = y.reshape((len(descriptions), max_length, vocab_size))
print(y.shape)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-10">10</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-12">12</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-14">14</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-16">16</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-18">18</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-20">20</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-22">22</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-24">24</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-26">26</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-28">28</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-30">30</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-32">32</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-34">34</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-36">36</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-38">38</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-40">40</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-42">42</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-44">44</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b3427164129-46">46</div><div class="crayon-num" data-line="crayon-5a658f57ec2b3427164129-47">47</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-1"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-2"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">text </span><span class="crayon-e">import </span><span class="crayon-e">Tokenizer</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">sequence </span><span class="crayon-e">import </span><span class="crayon-e">pad_sequences</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-e">import </span><span class="crayon-v">to_categorical</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-5"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-6"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-7"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-8"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-9"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-10"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-11"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-12"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-13"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-14"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-15"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-16"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-17"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-18"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-19"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-20"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-21"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-22"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-23"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-24"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-25"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-26"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-27"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-28"> </div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-29"><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-30"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Loaded %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-31"><span class="crayon-p"># extract all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-32"><span class="crayon-v">desc_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-33"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-34"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-35"><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">desc_text</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-36"><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-37"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-38"><span class="crayon-p"># integer encode descriptions</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-39"><span class="crayon-v">sequences</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">desc_text</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-40"><span class="crayon-p"># pad all sequences to a fixed length</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-41"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">max</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">sequences</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-42"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Description Length: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-43"><span class="crayon-v">padded</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">sequences</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">padding</span><span class="crayon-o">=</span><span class="crayon-s">'post'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-44"><span class="crayon-p"># one hot encode</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-45"><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-v">padded</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b3427164129-46"><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2b3427164129-47"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0031 seconds] -->
<p>Running the example first prints the number of loaded image descriptions (8,092 photos), the dataset vocabulary size (4,485 words), the length of the longest description (28 words), then finally the shape of the data for fitting a prediction model in the form <em>[samples, sequence length, features]</em>.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2b6234073809" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Loaded 8092
Vocabulary Size: 4485
Description Length: 28
(8092, 28, 4485)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2b6234073809-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b6234073809-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2b6234073809-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2b6234073809-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2b6234073809-1">Loaded 8092</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b6234073809-2">Vocabulary Size: 4485</div><div class="crayon-line" id="crayon-5a658f57ec2b6234073809-3">Description Length: 28</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2b6234073809-4">(8092, 28, 4485)</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>As mentioned, outputting the entire sequence may be challenging for the model.</p>
<p>We will look at a simpler model in the next section.</p>
<h2>Word-By-Word Model</h2>
<p>A simpler model for generating a caption for photographs is to generate one word given both the image as input and the last word generated.</p>
<p>This model would then have to be called recursively to generate each word in the description with previous predictions as input.</p>
<p>Using the word as input, give the model a forced context for predicting the next word in the sequence.</p>
<p>This is the model used in prior research, such as:</p>
<ul>
<li><a href="https://arxiv.org/abs/1411.4555">Show and Tell: A Neural Image Caption Generator</a>, 2015.</li>
</ul>
<p>A word embedding layer can be used to represent the input words. Like the feature extraction model for the photos, this too can be pre-trained either on a large corpus or on the dataset of all descriptions.</p>
<p>The model would take a full sequence of words as input; the length of the sequence would be the maximum length of descriptions in the dataset.</p>
<p>The model must be started with something. One approach is to surround each photo description with special tags to signal the start and end of the description, such as ‘STARTDESC’ and ‘ENDDESC’.</p>
<p>For example, the description:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2b9177651777" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
boy rides horse</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2b9177651777-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2b9177651777-1">boy rides horse</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>Would become:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2bb273955207" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
STARTDESC boy rides horse ENDDESC</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2bb273955207-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2bb273955207-1">STARTDESC boy rides horse ENDDESC</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>And would be fed to the model with the same image input to result in the following input-output word sequence pairs:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2be571577548" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Input (X), 						Output (y)
STARTDESC, 						boy
STARTDESC, boy,					rides
STARTDESC, boy, rides, 			horse
STARTDESC, boy, rides, horse	ENDDESC</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2be571577548-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2be571577548-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2be571577548-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2be571577548-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec2be571577548-5">5</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2be571577548-1">Input (X), 						Output (y)</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2be571577548-2">STARTDESC, 						boy</div><div class="crayon-line" id="crayon-5a658f57ec2be571577548-3">STARTDESC, boy,					rides</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2be571577548-4">STARTDESC, boy, rides, 			horse</div><div class="crayon-line" id="crayon-5a658f57ec2be571577548-5">STARTDESC, boy, rides, horse	ENDDESC</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>The data preparation would begin much the same as was described in the previous section.</p>
<p>Each description must be integer encoded. After encoding, the sequences are split into multiple input and output pairs and only the output word (y) is one hot encoded. This is because the model is only required to predict the probability distribution of one word at a time.</p>
<p>The code is the same up to the point where we calculate the maximum length of sequences.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2c0788552062" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
...
descriptions = load_clean_descriptions('descriptions.txt')
print('Loaded %d' % (len(descriptions)))
# extract all text
desc_text = list(descriptions.values())
# prepare tokenizer
tokenizer = Tokenizer()
tokenizer.fit_on_texts(desc_text)
vocab_size = len(tokenizer.word_index) + 1
print('Vocabulary Size: %d' % vocab_size)
# integer encode descriptions
sequences = tokenizer.texts_to_sequences(desc_text)
# determine the maximum sequence length
max_length = max(len(s) for s in sequences)
print('Description Length: %d' % max_length)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2c0788552062-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2c0788552062-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2c0788552062-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2c0788552062-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec2c0788552062-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2c0788552062-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec2c0788552062-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2c0788552062-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec2c0788552062-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2c0788552062-10">10</div><div class="crayon-num" data-line="crayon-5a658f57ec2c0788552062-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2c0788552062-12">12</div><div class="crayon-num" data-line="crayon-5a658f57ec2c0788552062-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2c0788552062-14">14</div><div class="crayon-num" data-line="crayon-5a658f57ec2c0788552062-15">15</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2c0788552062-1"><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2c0788552062-2"><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2c0788552062-3"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Loaded %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2c0788552062-4"><span class="crayon-p"># extract all text</span></div><div class="crayon-line" id="crayon-5a658f57ec2c0788552062-5"><span class="crayon-v">desc_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2c0788552062-6"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line" id="crayon-5a658f57ec2c0788552062-7"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2c0788552062-8"><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">desc_text</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2c0788552062-9"><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2c0788552062-10"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2c0788552062-11"><span class="crayon-p"># integer encode descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2c0788552062-12"><span class="crayon-v">sequences</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">desc_text</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2c0788552062-13"><span class="crayon-p"># determine the maximum sequence length</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2c0788552062-14"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">max</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">sequences</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2c0788552062-15"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Description Length: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0010 seconds] -->
<p>Next, we split the each integer encoded sequence into input and output pairs.</p>
<p>Let’s step through a single sequence called seq at the i’th word in the sequence, where i &gt;= 1.</p>
<p>First, we take the first i-1 words as the input sequence and the i’th word as the output word.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2c3838407815" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# split into input and output pair
in_seq, out_seq = seq[:i], seq[i]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2c3838407815-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2c3838407815-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2c3838407815-1"><span class="crayon-p"># split into input and output pair</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2c3838407815-2"><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Next, the input sequence is padded to the maximum length of the input sequences. Pre-padding is used (the default) so that new words appear at the end of the sequence, instead of the input beginning.</p>
<p>Pre-padding is used (the default) so that new words appear at the end of the sequence, instead of the beginning of the input.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2c5683286790" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# pad input sequence
in_seq = pad_sequences([in_seq], maxlen=max_length)[0]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2c5683286790-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2c5683286790-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2c5683286790-1"><span class="crayon-p"># pad input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2c5683286790-2"><span class="crayon-v">in_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>The output word is one hot encoded, much like in the previous section.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2c7372519371" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# encode output sequence
out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2c7372519371-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2c7372519371-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2c7372519371-1"><span class="crayon-p"># encode output sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2c7372519371-2"><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>We can put all of this together into a complete example to prepare description data for the word-by-word model.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2ca737082383" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from numpy import array
from keras.preprocessing.text import Tokenizer
from keras.preprocessing.sequence import pad_sequences
from keras.utils import to_categorical

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load clean descriptions into memory
def load_clean_descriptions(filename):
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# store
		descriptions[image_id] = ' '.join(image_desc)
	return descriptions

descriptions = load_clean_descriptions('descriptions.txt')
print('Loaded %d' % (len(descriptions)))
# extract all text
desc_text = list(descriptions.values())
# prepare tokenizer
tokenizer = Tokenizer()
tokenizer.fit_on_texts(desc_text)
vocab_size = len(tokenizer.word_index) + 1
print('Vocabulary Size: %d' % vocab_size)
# integer encode descriptions
sequences = tokenizer.texts_to_sequences(desc_text)
# determine the maximum sequence length
max_length = max(len(s) for s in sequences)
print('Description Length: %d' % max_length)

X, y = list(), list()
for img_no, seq in enumerate(sequences):
	# split one sequence into multiple X,y pairs
	for i in range(1, len(seq)):
		# split into input and output pair
		in_seq, out_seq = seq[:i], seq[i]
		# pad input sequence
		in_seq = pad_sequences([in_seq], maxlen=max_length)[0]
		# encode output sequence
		out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]
		# store
		X.append(in_seq)
		y.append(out_seq)

# convert to numpy arrays
X, y = array(X), array(y)
print(X.shape)
print(y.shape)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-10">10</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-12">12</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-14">14</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-16">16</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-18">18</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-20">20</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-22">22</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-24">24</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-26">26</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-28">28</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-30">30</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-32">32</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-34">34</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-36">36</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-38">38</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-40">40</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-42">42</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-44">44</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-46">46</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-48">48</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-50">50</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-52">52</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-54">54</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-56">56</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-58">58</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2ca737082383-60">60</div><div class="crayon-num" data-line="crayon-5a658f57ec2ca737082383-61">61</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-1"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-2"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">text </span><span class="crayon-e">import </span><span class="crayon-e">Tokenizer</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">sequence </span><span class="crayon-e">import </span><span class="crayon-e">pad_sequences</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-e">import </span><span class="crayon-v">to_categorical</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-5"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-6"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-7"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-8"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-9"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-10"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-11"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-12"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-13"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-14"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-15"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-16"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-17"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-18"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-19"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-20"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-21"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-22"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-23"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-24"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-25"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-26"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-27"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-28"> </div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-29"><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-30"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Loaded %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-31"><span class="crayon-p"># extract all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-32"><span class="crayon-v">desc_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-33"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-34"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-35"><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">desc_text</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-36"><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-37"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-38"><span class="crayon-p"># integer encode descriptions</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-39"><span class="crayon-v">sequences</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">desc_text</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-40"><span class="crayon-p"># determine the maximum sequence length</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-41"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">max</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">sequences</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-42"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Description Length: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-43"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-44"><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-45"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">img_no</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">seq </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">enumerate</span><span class="crayon-sy">(</span><span class="crayon-v">sequences</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-46"><span class="crayon-h"> </span><span class="crayon-p"># split one sequence into multiple X,y pairs</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-47"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">seq</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-48"><span class="crayon-h"> </span><span class="crayon-p"># split into input and output pair</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-49"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-50"><span class="crayon-h"> </span><span class="crayon-p"># pad input sequence</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-51"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-52"><span class="crayon-h"> </span><span class="crayon-p"># encode output sequence</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-53"><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-54"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-55"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-56"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">out_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-57"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-58"><span class="crayon-p"># convert to numpy arrays</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-59"><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2ca737082383-60"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2ca737082383-61"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0039 seconds] -->
<p>Running the example prints the same statistics, but prints the size of the resulting encoded input and output sequences.</p>
<p>Note that the input of images must follow the exact same ordering where the same photo is shown for each example drawn from a single description. One way to do this would be to load the photo and store it for each example prepared from a single description.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2cd998604159" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Loaded 8092
Vocabulary Size: 4485
Description Length: 28
(66456, 28)
(66456, 4485)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2cd998604159-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2cd998604159-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2cd998604159-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2cd998604159-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec2cd998604159-5">5</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2cd998604159-1">Loaded 8092</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2cd998604159-2">Vocabulary Size: 4485</div><div class="crayon-line" id="crayon-5a658f57ec2cd998604159-3">Description Length: 28</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2cd998604159-4">(66456, 28)</div><div class="crayon-line" id="crayon-5a658f57ec2cd998604159-5">(66456, 4485)</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<h2>Progressive Loading</h2>
<p>The Flicr8K dataset of photos and descriptions can fit into RAM, if you have a lot of RAM (e.g. 8 Gigabytes or more), and most modern systems do.</p>
<p>This is fine if you want to fit a deep learning model using the CPU.</p>
<p>Alternately, if you want to fit a model using a GPU, then you will not be able to fit the data into memory of an average GPU video card.</p>
<p>One solution is to progressively load the photos and descriptions as-needed by the model.</p>
<p>Keras supports progressively loaded datasets by using the <em>fit_generator()</em> function on the model. A generator is the term used to describe a function used to return batches of samples for the model to train on. This can be as simple as a standalone function, the name of which is passed to the <em>fit_generator()</em> function when fitting the model.</p>
<p>As a reminder, a model is fit for multiple epochs, where one epoch is one pass through the entire training dataset, such as all photos. One epoch is comprised of multiple batches of examples where the model weights are updated at the end of each batch.</p>
<p>A generator must create and yield one batch of examples. For example, the average sentence length in the dataset is 11 words; that means that each photo will result in 11 examples for fitting the model and two photos will result in about 22 examples on average. A good default batch size for modern hardware may be 32 examples, so that is about 2-3 photos worth of examples.</p>
<p>We can write a custom generator to load a few photos and return the samples as a single batch.</p>
<p>Let’s assume we are working with a word-by-word model described in the previous section that expects a sequence of words and a prepared image as input and predicts a single word.</p>
<p>Let’s design a data generator that given a loaded dictionary of image identifiers to clean descriptions, a trained tokenizer, and a maximum sequence length will load one-image worth of examples for each batch.</p>
<p>A generator must loop forever and yield each batch of samples. If generators and yield are new concepts for you, consider reading this article:</p>
<ul>
<li><a href="https://wiki.python.org/moin/Generators">Python Generators</a></li>
</ul>
<p>We can loop forever with a while loop and within this, loop over each image in the image directory. For each image filename, we can load the image and create all of the input-output sequence pairs from the image’s description.</p>
<p>Below is the data generator function.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2d1253931100" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
def data_generator(mapping, tokenizer, max_length):
	# loop for ever over images
	directory = 'Flicker8k_Dataset'
	while 1:
		for name in listdir(directory):
			# load an image from file
			filename = directory + '/' + name
			image, image_id = load_image(filename)
			# create word sequences
			desc = mapping[image_id]
			in_img, in_seq, out_word = create_sequences(tokenizer, max_length, desc, image)
			yield [[in_img, in_seq], out_word]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2d1253931100-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d1253931100-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2d1253931100-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d1253931100-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec2d1253931100-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d1253931100-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec2d1253931100-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d1253931100-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec2d1253931100-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d1253931100-10">10</div><div class="crayon-num" data-line="crayon-5a658f57ec2d1253931100-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d1253931100-12">12</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2d1253931100-1"><span class="crayon-e">def </span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">mapping</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d1253931100-2"><span class="crayon-h"> </span><span class="crayon-p"># loop for ever over images</span></div><div class="crayon-line" id="crayon-5a658f57ec2d1253931100-3"><span class="crayon-h"> </span><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flicker8k_Dataset'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d1253931100-4"><span class="crayon-h"> </span><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec2d1253931100-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">listdir</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d1253931100-6"><span class="crayon-h"> </span><span class="crayon-p"># load an image from file</span></div><div class="crayon-line" id="crayon-5a658f57ec2d1253931100-7"><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">name</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d1253931100-8"><span class="crayon-e"> </span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_image</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2d1253931100-9"><span class="crayon-h"> </span><span class="crayon-p"># create word sequences</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d1253931100-10"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec2d1253931100-11"><span class="crayon-h"> </span><span class="crayon-v">in_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d1253931100-12"><span class="crayon-h"> </span><span class="crayon-i">yield</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">in_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_word</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0010 seconds] -->
<p>You could extend it to take the name of the dataset directory as a parameter.</p>
<p>The generator returns an array containing the inputs (X) and output (y) for the model. The input is comprised of an array with two items for the input images and encoded word sequences. The outputs are one hot encoded words.</p>
<p>You can see that it calls a function called <em>load_photo()</em> to load a single photo and return the pixels and image identifier. This is a simplified version of the photo loading function developed at the beginning of this tutorial.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2d4464228900" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load a single photo intended as input for the VGG feature extractor model
def load_photo(filename):
	image = load_img(filename, target_size=(224, 224))
	# convert the image pixels to a numpy array
	image = img_to_array(image)
	# reshape data for the model
	image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
	# prepare the image for the VGG model
	image = preprocess_input(image)[0]
	# get image id
	image_id = filename.split('/')[-1].split('.')[0]
	return image, image_id</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2d4464228900-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d4464228900-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2d4464228900-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d4464228900-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec2d4464228900-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d4464228900-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec2d4464228900-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d4464228900-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec2d4464228900-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d4464228900-10">10</div><div class="crayon-num" data-line="crayon-5a658f57ec2d4464228900-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d4464228900-12">12</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2d4464228900-1"><span class="crayon-p"># load a single photo intended as input for the VGG feature extractor model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d4464228900-2"><span class="crayon-e">def </span><span class="crayon-e">load_photo</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec2d4464228900-3"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d4464228900-4"><span class="crayon-h"> </span><span class="crayon-p"># convert the image pixels to a numpy array</span></div><div class="crayon-line" id="crayon-5a658f57ec2d4464228900-5"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d4464228900-6"><span class="crayon-h"> </span><span class="crayon-p"># reshape data for the model</span></div><div class="crayon-line" id="crayon-5a658f57ec2d4464228900-7"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d4464228900-8"><span class="crayon-h"> </span><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line" id="crayon-5a658f57ec2d4464228900-9"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d4464228900-10"><span class="crayon-h"> </span><span class="crayon-p"># get image id</span></div><div class="crayon-line" id="crayon-5a658f57ec2d4464228900-11"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'/'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d4464228900-12"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_id</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0011 seconds] -->
<p>Another function named <em>create_sequences()</em> is called to create sequences of images, input sequences of words, and output words that we then yield to the caller. This is a function that includes everything discussed in the previous section, and also creates copies of the image pixels, one for each input-output pair created from the photo’s description.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2d7435640636" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# create sequences of images, input sequences and output words for an image
def create_sequences(tokenizer, max_length, descriptions, images):
	Ximages, XSeq, y = list(), list(),list()
	vocab_size = len(tokenizer.word_index) + 1
	for j in range(len(descriptions)):
		seq = descriptions[j]
		image = images[j]
		# integer encode
		seq = tokenizer.texts_to_sequences([seq])[0]
		# split one sequence into multiple X,y pairs
		for i in range(1, len(seq)):
			# select
			in_seq, out_seq = seq[:i], seq[i]
			# pad input sequence
			in_seq = pad_sequences([in_seq], maxlen=max_length)[0]
			# encode output sequence
			out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]
			# store
			Ximages.append(image)
			XSeq.append(in_seq)
			y.append(out_seq)
	Ximages, XSeq, y = array(Ximages), array(XSeq), array(y)
	return Ximages, XSeq, y</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2d7435640636-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d7435640636-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2d7435640636-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d7435640636-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec2d7435640636-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d7435640636-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec2d7435640636-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d7435640636-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec2d7435640636-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d7435640636-10">10</div><div class="crayon-num" data-line="crayon-5a658f57ec2d7435640636-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d7435640636-12">12</div><div class="crayon-num" data-line="crayon-5a658f57ec2d7435640636-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d7435640636-14">14</div><div class="crayon-num" data-line="crayon-5a658f57ec2d7435640636-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d7435640636-16">16</div><div class="crayon-num" data-line="crayon-5a658f57ec2d7435640636-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d7435640636-18">18</div><div class="crayon-num" data-line="crayon-5a658f57ec2d7435640636-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d7435640636-20">20</div><div class="crayon-num" data-line="crayon-5a658f57ec2d7435640636-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2d7435640636-22">22</div><div class="crayon-num" data-line="crayon-5a658f57ec2d7435640636-23">23</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2d7435640636-1"><span class="crayon-p"># create sequences of images, input sequences and output words for an image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d7435640636-2"><span class="crayon-e">def </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">images</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec2d7435640636-3"><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d7435640636-4"><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a658f57ec2d7435640636-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">j</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d7435640636-6"><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">j</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec2d7435640636-7"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">images</span><span class="crayon-sy">[</span><span class="crayon-v">j</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d7435640636-8"><span class="crayon-h"> </span><span class="crayon-p"># integer encode</span></div><div class="crayon-line" id="crayon-5a658f57ec2d7435640636-9"><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">seq</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d7435640636-10"><span class="crayon-h"> </span><span class="crayon-p"># split one sequence into multiple X,y pairs</span></div><div class="crayon-line" id="crayon-5a658f57ec2d7435640636-11"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">seq</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d7435640636-12"><span class="crayon-h"> </span><span class="crayon-p"># select</span></div><div class="crayon-line" id="crayon-5a658f57ec2d7435640636-13"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d7435640636-14"><span class="crayon-h"> </span><span class="crayon-p"># pad input sequence</span></div><div class="crayon-line" id="crayon-5a658f57ec2d7435640636-15"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d7435640636-16"><span class="crayon-h"> </span><span class="crayon-p"># encode output sequence</span></div><div class="crayon-line" id="crayon-5a658f57ec2d7435640636-17"><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d7435640636-18"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5a658f57ec2d7435640636-19"><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d7435640636-20"><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2d7435640636-21"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">out_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2d7435640636-22"><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">Ximages</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">XSeq</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2d7435640636-23"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0022 seconds] -->
<p>Prior to preparing the model that uses the data generator, we must load the clean descriptions, prepare the tokenizer, and calculate the maximum sequence length. All 3 of must be passed to the <em>data_generator()</em> as parameters.</p>
<p>We use the same <em>load_clean_descriptions()</em> function developed previously and a new <em>create_tokenizer()</em> function that simplifies the creation of the tokenizer.</p>
<p>Tying all of this together, the complete data generator is listed below, ready for use to train a model.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2da495083280" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from os import listdir
from numpy import array
from keras.preprocessing.text import Tokenizer
from keras.preprocessing.sequence import pad_sequences
from keras.utils import to_categorical
from keras.preprocessing.image import load_img
from keras.preprocessing.image import img_to_array
from keras.applications.vgg16 import preprocess_input

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load clean descriptions into memory
def load_clean_descriptions(filename):
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# store
		descriptions[image_id] = ' '.join(image_desc)
	return descriptions

# fit a tokenizer given caption descriptions
def create_tokenizer(descriptions):
	lines = list(descriptions.values())
	tokenizer = Tokenizer()
	tokenizer.fit_on_texts(lines)
	return tokenizer

# load a single photo intended as input for the VGG feature extractor model
def load_photo(filename):
	image = load_img(filename, target_size=(224, 224))
	# convert the image pixels to a numpy array
	image = img_to_array(image)
	# reshape data for the model
	image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
	# prepare the image for the VGG model
	image = preprocess_input(image)[0]
	# get image id
	image_id = filename.split('/')[-1].split('.')[0]
	return image, image_id

# create sequences of images, input sequences and output words for an image
def create_sequences(tokenizer, max_length, desc, image):
	Ximages, XSeq, y = list(), list(),list()
	vocab_size = len(tokenizer.word_index) + 1
	# integer encode the description
	seq = tokenizer.texts_to_sequences([desc])[0]
	# split one sequence into multiple X,y pairs
	for i in range(1, len(seq)):
		# select
		in_seq, out_seq = seq[:i], seq[i]
		# pad input sequence
		in_seq = pad_sequences([in_seq], maxlen=max_length)[0]
		# encode output sequence
		out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]
		# store
		Ximages.append(image)
		XSeq.append(in_seq)
		y.append(out_seq)
	Ximages, XSeq, y = array(Ximages), array(XSeq), array(y)
	return [Ximages, XSeq, y]

# data generator, intended to be used in a call to model.fit_generator()
def data_generator(descriptions, tokenizer, max_length):
	# loop for ever over images
	directory = 'Flicker8k_Dataset'
	while 1:
		for name in listdir(directory):
			# load an image from file
			filename = directory + '/' + name
			image, image_id = load_photo(filename)
			# create word sequences
			desc = descriptions[image_id]
			in_img, in_seq, out_word = create_sequences(tokenizer, max_length, desc, image)
			yield [[in_img, in_seq], out_word]

# load mapping of ids to descriptions
descriptions = load_clean_descriptions('descriptions.txt')
# integer encode sequences of words
tokenizer = create_tokenizer(descriptions)
# pad to fixed length
max_length = max(len(s.split()) for s in list(descriptions.values()))
print('Description Length: %d' % max_length)

# test the data generator
generator = data_generator(descriptions, tokenizer, max_length)
inputs, outputs = next(generator)
print(inputs[0].shape)
print(inputs[1].shape)
print(outputs.shape)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-6">6</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-8">8</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-10">10</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-12">12</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-14">14</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-16">16</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-18">18</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-20">20</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-22">22</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-24">24</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-26">26</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-28">28</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-30">30</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-32">32</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-34">34</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-36">36</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-38">38</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-40">40</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-42">42</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-44">44</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-46">46</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-48">48</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-50">50</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-52">52</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-54">54</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-56">56</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-58">58</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-60">60</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-62">62</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-64">64</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-66">66</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-68">68</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-70">70</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-72">72</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-74">74</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-76">76</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-78">78</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-80">80</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-82">82</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-84">84</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-86">86</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-88">88</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-90">90</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-92">92</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-94">94</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-96">96</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-98">98</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2da495083280-100">100</div><div class="crayon-num" data-line="crayon-5a658f57ec2da495083280-101">101</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2da495083280-1"><span class="crayon-e">from </span><span class="crayon-e">os </span><span class="crayon-e">import </span><span class="crayon-e">listdir</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-2"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">text </span><span class="crayon-e">import </span><span class="crayon-e">Tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">sequence </span><span class="crayon-e">import </span><span class="crayon-e">pad_sequences</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-e">import </span><span class="crayon-e">to_categorical</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-6"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">load_img</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-7"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">img_to_array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-v">preprocess_input</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-9"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-10"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-11"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-12"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-13"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-14"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-15"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-16"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-17"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-18"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-19"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-20"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-21"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-22"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-23"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-24"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-25"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-26"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-27"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-28"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-29"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-30"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-31"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-32"> </div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-33"><span class="crayon-p"># fit a tokenizer given caption descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-34"><span class="crayon-e">def </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-35"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-36"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-37"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-38"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-39"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-40"><span class="crayon-p"># load a single photo intended as input for the VGG feature extractor model</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-41"><span class="crayon-e">def </span><span class="crayon-e">load_photo</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-42"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-43"><span class="crayon-h"> </span><span class="crayon-p"># convert the image pixels to a numpy array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-44"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-45"><span class="crayon-h"> </span><span class="crayon-p"># reshape data for the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-46"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-47"><span class="crayon-h"> </span><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-48"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-49"><span class="crayon-h"> </span><span class="crayon-p"># get image id</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-50"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'/'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-51"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_id</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-52"> </div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-53"><span class="crayon-p"># create sequences of images, input sequences and output words for an image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-54"><span class="crayon-e">def </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-55"><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-56"><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-57"><span class="crayon-h"> </span><span class="crayon-p"># integer encode the description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-58"><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">desc</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-59"><span class="crayon-h"> </span><span class="crayon-p"># split one sequence into multiple X,y pairs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-60"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">seq</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-61"><span class="crayon-h"> </span><span class="crayon-p"># select</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-62"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-63"><span class="crayon-h"> </span><span class="crayon-p"># pad input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-64"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-65"><span class="crayon-h"> </span><span class="crayon-p"># encode output sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-66"><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-67"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-68"><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-69"><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-70"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">out_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-71"><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">Ximages</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">XSeq</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-72"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">Ximages</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-73"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-74"><span class="crayon-p"># data generator, intended to be used in a call to model.fit_generator()</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-75"><span class="crayon-e">def </span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-76"><span class="crayon-h"> </span><span class="crayon-p"># loop for ever over images</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-77"><span class="crayon-h"> </span><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flicker8k_Dataset'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-78"><span class="crayon-h"> </span><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-79"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">listdir</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-80"><span class="crayon-h"> </span><span class="crayon-p"># load an image from file</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-81"><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">name</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-82"><span class="crayon-e"> </span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photo</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-83"><span class="crayon-h"> </span><span class="crayon-p"># create word sequences</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-84"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-85"><span class="crayon-h"> </span><span class="crayon-v">in_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-86"><span class="crayon-h"> </span><span class="crayon-i">yield</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-v">in_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_word</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-87"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-88"><span class="crayon-p"># load mapping of ids to descriptions</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-89"><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-90"><span class="crayon-p"># integer encode sequences of words</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-91"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-92"><span class="crayon-p"># pad to fixed length</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-93"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">max</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-94"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Description Length: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-95"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-96"><span class="crayon-p"># test the data generator</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-97"><span class="crayon-v">generator</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-98"><span class="crayon-v">inputs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">next</span><span class="crayon-sy">(</span><span class="crayon-v">generator</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-99"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2da495083280-100"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2da495083280-101"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">outputs</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0068 seconds] -->
<p>A data generator can be tested by calling the <a href="https://docs.python.org/3/library/functions.html#next">next()</a> function.</p>
<p>We can test the generator as follows.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2df130251731" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# test the data generator
generator = data_generator(descriptions, tokenizer, max_length)
inputs, outputs = next(generator)
print(inputs[0].shape)
print(inputs[1].shape)
print(outputs.shape)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2df130251731-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2df130251731-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2df130251731-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2df130251731-4">4</div><div class="crayon-num" data-line="crayon-5a658f57ec2df130251731-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2df130251731-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2df130251731-1"><span class="crayon-p"># test the data generator</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2df130251731-2"><span class="crayon-v">generator</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2df130251731-3"><span class="crayon-v">inputs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">next</span><span class="crayon-sy">(</span><span class="crayon-v">generator</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2df130251731-4"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658f57ec2df130251731-5"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2df130251731-6"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">outputs</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0006 seconds] -->
<p>Running the example prints the shape of the input and output example for a single batch (e.g. 13 input-output pairs):</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2e2472784101" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
(13, 224, 224, 3)
(13, 28)
(13, 4485)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2e2472784101-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2e2472784101-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2e2472784101-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2e2472784101-1">(13, 224, 224, 3)</div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2e2472784101-2">(13, 28)</div><div class="crayon-line" id="crayon-5a658f57ec2e2472784101-3">(13, 4485)</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>The generator can be used to fit a model by calling the fit_generator() function on the model (instead of <em>fit()</em>) and passing in the generator.</p>
<p>We must also specify the number of steps or batches per epoch. We could estimate this as (10 x training dataset size), perhaps 70,000 if 7,000 images are used for training.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658f57ec2e5890657764" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define model
# ...
# fit model
model.fit_generator(data_generator(descriptions, tokenizer, max_length), steps_per_epoch=70000, ...)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658f57ec2e5890657764-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2e5890657764-2">2</div><div class="crayon-num" data-line="crayon-5a658f57ec2e5890657764-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658f57ec2e5890657764-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658f57ec2e5890657764-1"><span class="crayon-p"># define model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2e5890657764-2"><span class="crayon-p"># ...</span></div><div class="crayon-line" id="crayon-5a658f57ec2e5890657764-3"><span class="crayon-p"># fit model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658f57ec2e5890657764-4"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit_generator</span><span class="crayon-sy">(</span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">steps_per_epoch</span><span class="crayon-o">=</span><span class="crayon-cn">70000</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">.</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p></p>
<h2>Further Reading</h2>
<p>This section provides more resources on the topic if you are looking go deeper.</p>
<h3>Flickr8K Dataset</h3>
<ul>
<li><a href="http://nlp.cs.illinois.edu/HockenmaierGroup/Framing_Image_Description/KCCA.html">Framing image description as a ranking task: data, models and evaluation metrics</a> (Homepage)</li>
<li><a href="https://www.jair.org/media/3994/live-3994-7274-jair.pdf">Framing Image Description as a Ranking Task: Data, Models and Evaluation Metrics</a>, (PDF) 2013.</li>
<li><a href="https://illinois.edu/fb/sec/1713398">Dataset Request Form</a></li>
<li><a href="http://nlp.cs.illinois.edu/HockenmaierGroup/8k-pictures.html">Old Flicrk8K Homepage</a></li>
</ul>
<h3>API</h3>
<ul>
<li><a href="https://wiki.python.org/moin/Generators">Python Generators</a></li>
<li><a href="https://keras.io/models/model/">Keras Model API</a></li>
<li><a href="https://keras.io/preprocessing/sequence/#pad_sequences">Keras pad_sequences() API</a></li>
<li><a href="https://keras.io/preprocessing/text/#tokenizer">Keras Tokenizer API</a></li>
<li><a href="https://keras.io/applications/#vgg16">Keras VGG16 API</a></li>
</ul>
<h2>Summary</h2>
<p>In this tutorial, you discovered how to prepare photos and textual descriptions ready for developing an automatic photo caption generation model.</p>
<p>Specifically, you learned:</p>
<ul>
<li>About the Flickr8K dataset comprised of more than 8,000 photos and up to 5 captions for each photo.</li>
<li>How to generally load and prepare photo and text data for modeling with deep learning.</li>
<li>How to specifically encode data for two different types of deep learning models in Keras.</li>
</ul>
<p>Do you have any questions?<br/>
Ask your questions in the comments below and I will do my best to answer.</p>
<div class="awac-wrapper"><div class="awac widget text-42"> <div class="textwidget"><p></p><center><br/>
<div class="woo-sc-hr"></div>
<h2>Develop Deep Learning models for Text Data Today!</h2>
<p><a href="/deep-learning-for-nlp/"><img align="left" alt="Deep Learning for Natural Language Processing" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/DLFNLP-Cover-220.png" style="border: 0;"/></a></p>
<h4>Develop Your Own Text models in Minutes</h4>
<p>…with just a few lines of python code</p>
<p>Discover how in my new Ebook:<br/>
<a href="/deep-learning-for-nlp/">Deep Learning for Natural Language Processing</a></p>
<p>It provides <strong>self-study tutorials</strong> on topics like:<br/>
<em>Bag-of-Words, Word Embedding, Language Models, Caption Generation, Text Translation</em> and much more…</p>
<h4>Finally Bring Deep Learning to your Natural Language Processing Projects</h4>
<p>Skip the Academics. Just Results.</p>
<p><a href="/deep-learning-for-nlp/">Click to learn more</a>.<br/>
</p><div class="woo-sc-hr"></div><br/>
</center>
</div>
</div></div><div class="apss-social-share apss-theme-4 clearfix">
<div class="apss-twitter apss-single-icon">
<a href="javascript:void(0);" onclick="apss_open_in_popup_window(event, 'https://twitter.com/intent/tweet?text=How%20to%20Prepare%20a%20Photo%20Caption%20Dataset%20for%20Training%20a%20Deep%20Learning%20Model&amp;url=https%3A%2F%2Fmachinelearningmastery.com%2Fprepare-photo-caption-dataset-training-deep-learning-model%2F&amp;');" rel="nofollow" target="" title="Share on Twitter">
<div class="apss-icon-block clearfix">
<i class="fa fa-twitter"></i>
<span class="apss-social-text">Share on Twitter</span><span class="apss-share">Tweet</span>
</div>
</a>
</div>
<div class="apss-facebook apss-single-icon">
<a href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/" onclick="apss_open_in_popup_window(event, 'https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/');" rel="nofollow" target="" title="Share on Facebook">
<div class="apss-icon-block clearfix">
<i class="fa fa-facebook"></i>
<span class="apss-social-text">Share on Facebook</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-linkedin apss-single-icon">
<a href="http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Prepare%20a%20Photo%20Caption%20Dataset%20for%20Training%20a%20Deep%20Learning%20Model&amp;url=https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/&amp;summary=Automatic+photo+captioning+is+a+problem+where+a+model+must+generate+a+human-readable+textual+descrip..." onclick="apss_open_in_popup_window(event, 'http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Prepare%20a%20Photo%20Caption%20Dataset%20for%20Training%20a%20Deep%20Learning%20Model&amp;url=https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/&amp;summary=Automatic+photo+captioning+is+a+problem+where+a+model+must+generate+a+human-readable+textual+descrip...');" rel="nofollow" target="" title="Share on LinkedIn">
<div class="apss-icon-block clearfix"><i class="fa fa-linkedin"></i>
<span class="apss-social-text">Share on LinkedIn</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-google-plus apss-single-icon">
<a href="https://plus.google.com/share?url=https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/" onclick="apss_open_in_popup_window(event, 'https://plus.google.com/share?url=https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/');" rel="nofollow" target="" title="Share on Google Plus">
<div class="apss-icon-block clearfix">
<i class="fa fa-google-plus"></i>
<span class="apss-social-text">Share on Google Plus</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
</div> </section><!-- /.entry -->
<div class="fix"></div>
<aside id="post-author">
<div class="profile-image"><img alt="" class="avatar avatar-80 photo" height="80" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=160&amp;d=mm&amp;r=g 2x" width="80"/></div>
<div class="profile-content">
<h4>About Jason Brownlee</h4>
		Dr. Jason Brownlee is a husband, proud father, academic researcher, author, professional developer and a machine learning practitioner. He is dedicated to helping developers get started and get good at applied machine learning.
<a href="/about">Learn more</a>.				<div class="profile-link">
<a href="https://machinelearningmastery.com/author/jasonb/">
				View all posts by Jason Brownlee <span class="meta-nav">→</span> </a>
</div><!--#profile-link-->
</div>
<div class="fix"></div>
</aside>
<div class="post-utility"></div>
</article><!-- /.post -->
<div class="post-entries">
<div class="nav-prev fl"><a href="https://machinelearningmastery.com/how-to-caption-photos-with-deep-learning/" rel="prev"><i class="fa fa-angle-left"></i> How to Automatically Generate Textual Descriptions for Photographs with Deep Learning</a></div>
<div class="nav-next fr"><a href="https://machinelearningmastery.com/prepare-univariate-time-series-data-long-short-term-memory-networks/" rel="next">How to Prepare Univariate Time Series Data for Long Short-Term Memory Networks <i class="fa fa-angle-right"></i></a></div>
<div class="fix"></div>
</div>
<div id="comments"> <h3 id="comments-title">24 Responses to <em>How to Prepare a Photo Caption Dataset for Training a Deep Learning Model</em></h3>
<ol class="commentlist">
<li class="comment even thread-even depth-1" id="comment-420031">
<div class="comment-container" id="li-comment-420031">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/b42b12cffd99501e11eb8977174e7d7b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b42b12cffd99501e11eb8977174e7d7b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Adel</span>
<span class="date">November 15, 2017 at 9:13 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-420031" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Is this topic included in your new book ?</p>
<div class="reply">
<a aria-label="Reply to Adel" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=420031#respond" onclick='return addComment.moveForm( "comment-420031", "420031", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-420054">
<div class="comment-container" id="li-comment-420054">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 15, 2017 at 9:59 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-420054" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes, I have a suite of chapters on developing a caption generation model.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=420054#respond" onclick='return addComment.moveForm( "comment-420054", "420054", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-420091">
<div class="comment-container" id="li-comment-420091">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d418469567ef68d544219be6c7e0806b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d418469567ef68d544219be6c7e0806b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://emilwallner.com" rel="external nofollow">Emil</a></span>
<span class="date">November 15, 2017 at 8:50 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-420091" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>This is brilliant!!! Thanks for putting this together – thoroughly appreciated! 💯</p>
<div class="reply">
<a aria-label="Reply to Emil" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=420091#respond" onclick='return addComment.moveForm( "comment-420091", "420091", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-420175">
<div class="comment-container" id="li-comment-420175">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 16, 2017 at 10:27 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-420175" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You’re welcome, I’m glad it helped!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=420175#respond" onclick='return addComment.moveForm( "comment-420175", "420175", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-420273">
<div class="comment-container" id="li-comment-420273">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/613b0d427d2fddeef0887f735e1872d4?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/613b0d427d2fddeef0887f735e1872d4?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Joe Weber</span>
<span class="date">November 17, 2017 at 7:14 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-420273" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason, Isnt the data generator function supposed to call load_photo() instead of load_image()?</p>
<div class="reply">
<a aria-label="Reply to Joe Weber" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=420273#respond" onclick='return addComment.moveForm( "comment-420273", "420273", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-420297">
<div class="comment-container" id="li-comment-420297">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 17, 2017 at 9:30 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-420297" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>In the full example, the data generator does call load_photo() on line 82.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=420297#respond" onclick='return addComment.moveForm( "comment-420297", "420297", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-420386">
<div class="comment-container" id="li-comment-420386">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/88f067d4d63b7a4d7c08c114701bb78c?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/88f067d4d63b7a4d7c08c114701bb78c?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Irjam</span>
<span class="date">November 18, 2017 at 1:54 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-420386" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason, I am a newbie in Python and CNN. Can I have testing source code in which I input an image and it gives output with the caption?</p>
<div class="reply">
<a aria-label="Reply to Irjam" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=420386#respond" onclick='return addComment.moveForm( "comment-420386", "420386", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-420429">
<div class="comment-container" id="li-comment-420429">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 18, 2017 at 10:20 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-420429" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes, I will have some on the blog soon and in my new book on deep learning for NLP to be released soon.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=420429#respond" onclick='return addComment.moveForm( "comment-420429", "420429", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-420408">
<div class="comment-container" id="li-comment-420408">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/75992286751e4af536aae8fae3ca8dcb?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/75992286751e4af536aae8fae3ca8dcb?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://cheikh.me/" rel="external nofollow">Moustapha Cheikh</a></span>
<span class="date">November 18, 2017 at 9:05 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-420408" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Enjoyed reading your articles, you really explains everything in detail, Couldn’t be write much better! the article is very interesting and effective.</p>
<p>Note:  There is an typing error in the first time you mentioned load_clean_descriptions</p>
<p>mapping[image_id] = ‘ ‘.join(image_desc)</p>
<p>sould be </p>
<p>descriptions[image_id] = ‘ ‘.join(image_desc)</p>
<p>Thanks for sharing such interesting blog.</p>
<div class="reply">
<a aria-label="Reply to Moustapha Cheikh" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=420408#respond" onclick='return addComment.moveForm( "comment-420408", "420408", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-420434">
<div class="comment-container" id="li-comment-420434">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 18, 2017 at 10:28 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-420434" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Fixed, thanks!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=420434#respond" onclick='return addComment.moveForm( "comment-420434", "420434", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-421455">
<div class="comment-container" id="li-comment-421455">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/5c769fe1cdf7f9d63be68e484816a5c2?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/5c769fe1cdf7f9d63be68e484816a5c2?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://aspiringguru.info" rel="external nofollow">Matthew</a></span>
<span class="date">November 28, 2017 at 12:49 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-421455" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi,<br/>
enjoy following your blog.</p>
<p>I’m seeing an error here</p>
<p>def save_doc(descriptions, filename):<br/>
	lines = list()<br/>
	for key, desc in mapping.items():</p>
<p>this threw me for a bit until I saw mapping is returned from<br/>
def load_descriptions(doc)</p>
<p>fix below </p>
<p>def save_doc(descriptions, filename):<br/>
	lines = list()<br/>
	for key, desc in descriptions.items():</p>
<p>replaces<br/>
        for key, desc in mapping.items():</p>
<div class="reply">
<a aria-label="Reply to Matthew" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=421455#respond" onclick='return addComment.moveForm( "comment-421455", "421455", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-421537">
<div class="comment-container" id="li-comment-421537">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 29, 2017 at 8:16 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-421537" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Ouch, I’ve fixed that example too, cheers.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=421537#respond" onclick='return addComment.moveForm( "comment-421537", "421537", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-422079">
<div class="comment-container" id="li-comment-422079">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/74accdfbbe4d9c2d053c836107576858?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/74accdfbbe4d9c2d053c836107576858?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ranjith</span>
<span class="date">December 4, 2017 at 3:31 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-422079" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason, when I run the descriptions, I am getting the following error,<br/>
FileNotFoundError: [Errno 2] No such file or directory: ‘Flickr8k_text/Flickr8k.token.txt’, can you please help me with this please, I am very new to deep learning.</p>
<div class="reply">
<a aria-label="Reply to Ranjith" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=422079#respond" onclick='return addComment.moveForm( "comment-422079", "422079", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-422103">
<div class="comment-container" id="li-comment-422103">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 4, 2017 at 7:59 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-422103" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You must download the dataset and place it in the same directory as the code.</p>
<p>Try running from the command line, sometimes IDEs and Notebooks can mask or introduce errors.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=422103#respond" onclick='return addComment.moveForm( "comment-422103", "422103", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-425449">
<div class="comment-container" id="li-comment-425449">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/a88c536cdf15ae68d941ab3f86c62c08?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/a88c536cdf15ae68d941ab3f86c62c08?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Felix Fu</span>
<span class="date">January 2, 2018 at 9:03 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-425449" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason, thanks for this awesome post, I really enjoyed reading it. By the way, I think there is a typo when you talk about the number of steps per epoch. I think it should read “perhaps 70,000 if 7,000 images are used for training.”.</p>
<div class="reply">
<a aria-label="Reply to Felix Fu" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=425449#respond" onclick='return addComment.moveForm( "comment-425449", "425449", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-425479">
<div class="comment-container" id="li-comment-425479">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 3, 2018 at 5:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-425479" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks, fixed.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=425479#respond" onclick='return addComment.moveForm( "comment-425479", "425479", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-425859">
<div class="comment-container" id="li-comment-425859">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/eb6e0e753e8b51e64a60df228069a5f7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/eb6e0e753e8b51e64a60df228069a5f7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Joan</span>
<span class="date">January 8, 2018 at 8:03 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-425859" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
When I running dump(features, open(‘features.pkl’, ‘wb’)) ,I getting the following error: “feature.pkl is not UTF-8 encoded ”<br/>
Also I try to dump the output of predict function using only the first image.<br/>
It was like this:<br/>
{‘667626_18933d713e’: array([[[[  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
           10.62594891,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         …,<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            9.41605377,   0.        ]],</p>
<p>        [[  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   5.36805296],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         …,<br/>
         [  0.        ,   0.        ,   0.        , …,   1.45877278,<br/>
            0.        ,  39.37923431],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   1.39090693],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            3.93747687,   0.        ]],</p>
<p>        [[  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
           18.81423187,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   7.79979277,<br/>
            0.        ,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   9.14055347],<br/>
         …,<br/>
         [  0.        ,   0.        ,   0.        , …,  48.84911346,<br/>
            0.        ,  12.12792015],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            2.0710113 ,   0.        ]],</p>
<p>        …,<br/>
        [[  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         [  0.        ,   3.75439334,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         [  3.71412587,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         …,<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
           18.80825424,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
           13.0358696 ,   0.        ]],</p>
<p>        [[  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            4.03412676,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         …,<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            7.99308109,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
           32.52854919,   0.        ]],</p>
<p>        [[  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
           33.73991013,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
           14.52160454,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            4.05761242,   0.        ],<br/>
         …,<br/>
         [  0.        ,   0.        ,   0.        , …,   0.        ,<br/>
            0.        ,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,   0.90452403,<br/>
            0.        ,   0.        ],<br/>
         [  0.        ,   0.        ,   0.        , …,  29.89839745,<br/>
           38.23991394,   0.        ]]]], dtype=float32)}<br/>
And I was confused about whether this result correct or not.<br/>
Could you help me with this?<br/>
I really don’t know why my feature.pkl can save successfully.<br/>
Thank you so much.</p>
<p>         .</p>
<div class="reply">
<a aria-label="Reply to Joan" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=425859#respond" onclick='return addComment.moveForm( "comment-425859", "425859", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-425870">
<div class="comment-container" id="li-comment-425870">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 8, 2018 at 3:52 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-425870" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sorry, I have not seen that error before. Perhaps the full error message to stackoverflow?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=425870#respond" onclick='return addComment.moveForm( "comment-425870", "425870", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-425945">
<div class="comment-container" id="li-comment-425945">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/eb6e0e753e8b51e64a60df228069a5f7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/eb6e0e753e8b51e64a60df228069a5f7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Joan</span>
<span class="date">January 9, 2018 at 1:54 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-425945" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thank you for the prompt reply.I’ll try.</p>
<div class="reply">
<a aria-label="Reply to Joan" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=425945#respond" onclick='return addComment.moveForm( "comment-425945", "425945", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-426931">
<div class="comment-container" id="li-comment-426931">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/85da3e8579111e2d2b0ab2c0d5339898?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/85da3e8579111e2d2b0ab2c0d5339898?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Karthik</span>
<span class="date">January 19, 2018 at 9:45 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-426931" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello Jason,</p>
<p>I’m able to download dataset, the link is unavailable. Could you please help me here.</p>
<p>Thanks,<br/>
Karthik</p>
<div class="reply">
<a aria-label="Reply to Karthik" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=426931#respond" onclick='return addComment.moveForm( "comment-426931", "426931", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-2" id="comment-426932">
<div class="comment-container" id="li-comment-426932">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/85da3e8579111e2d2b0ab2c0d5339898?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/85da3e8579111e2d2b0ab2c0d5339898?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Karthik</span>
<span class="date">January 19, 2018 at 9:45 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-426932" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>*not able to</p>
<div class="reply">
<a aria-label="Reply to Karthik" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=426932#respond" onclick='return addComment.moveForm( "comment-426932", "426932", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-426933">
<div class="comment-container" id="li-comment-426933">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/85da3e8579111e2d2b0ab2c0d5339898?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/85da3e8579111e2d2b0ab2c0d5339898?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Karthik</span>
<span class="date">January 19, 2018 at 9:54 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-426933" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Jason , i could able to download now. Please ignore above my comments.</p>
<p>Thanks,Karthik</p>
<div class="reply">
<a aria-label="Reply to Karthik" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=426933#respond" onclick='return addComment.moveForm( "comment-426933", "426933", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-426986">
<div class="comment-container" id="li-comment-426986">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 20, 2018 at 8:19 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-426986" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>No problem.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=426986#respond" onclick='return addComment.moveForm( "comment-426986", "426986", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-426985">
<div class="comment-container" id="li-comment-426985">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 20, 2018 at 8:19 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/#comment-426985" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You must fill out this form:<br/>
<a href="https://forms.illinois.edu/sec/1713398" rel="nofollow">https://forms.illinois.edu/sec/1713398</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/?replytocom=426985#respond" onclick='return addComment.moveForm( "comment-426985", "426985", "respond", "4434" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ol>
</div> <div class="comment-respond" id="respond">
<h3 class="comment-reply-title" id="reply-title">Leave a Reply <small><a href="/prepare-photo-caption-dataset-training-deep-learning-model/#respond" id="cancel-comment-reply-link" rel="nofollow" style="display:none;">Click here to cancel reply.</a></small></h3> <form action="https://machinelearningmastery.com/wp-comments-post.php?wpe-comment-post=mlmastery" class="comment-form" id="commentform" method="post">
<p class="comment-form-comment"><label class="hide" for="comment">Comment</label> <textarea aria-required="true" cols="50" id="comment" maxlength="65525" name="comment" required="required" rows="10" tabindex="4"></textarea></p><p class="comment-form-author"><input aria-required="true" class="txt" id="author" name="author" size="30" tabindex="1" type="text" value=""/><label for="author">Name <span class="required">(required)</span></label> </p>
<p class="comment-form-email"><input aria-required="true" class="txt" id="email" name="email" size="30" tabindex="2" type="text" value=""/><label for="email">Email (will not be published) <span class="required">(required)</span></label> </p>
<p class="comment-form-url"><input class="txt" id="url" name="url" size="30" tabindex="3" type="text" value=""/><label for="url">Website</label></p>
<p class="form-submit"><input class="submit" id="submit" name="submit" type="submit" value="Submit Comment"/> <input id="comment_post_ID" name="comment_post_ID" type="hidden" value="4434"/>
<input id="comment_parent" name="comment_parent" type="hidden" value="0"/>
</p><p style="display: none;"><input id="akismet_comment_nonce" name="akismet_comment_nonce" type="hidden" value="6f28f986e6"/></p><p style="display: none;"><input id="ak_js" name="ak_js" type="hidden" value="64"/></p> </form>
</div><!-- #respond -->
</section><!-- /#main -->
<aside id="sidebar">
<div class="widget widget_woo_blogauthorinfo" id="woo_blogauthorinfo-2"><h3>Welcome to Machine Learning Mastery</h3><span class="left"><img alt="" class="avatar avatar-100 photo" height="100" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=100&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=200&amp;d=mm&amp;r=g 2x" width="100"/></span>
<p>Hi, I'm Dr. Jason Brownlee.
<br/>
My goal is to make practitioners like YOU awesome at applied machine learning.</p>
<p><a href="/about">Read More</a></p>
<div class="fix"></div>
</div><div class="widget widget_text" id="text-43"> <div class="textwidget"><p></p><center>
<h3>Deep Learning for Text Data</h3>
<p>Cut through the math and research papers.<br/>
Discover Word Embeddings, Text Translation and more.</p>
<p><a href="/deep-learning-for-nlp/">Get Started With Deep Learning for NLP Today!</a><br/>
<a href="/deep-learning-for-nlp/"><img src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/DLFNLP-Cover-220.png"/></a><br/>
</p></center>
</div>
</div>
<div class="widget widget_woo_tabs" id="woo_tabs-2"> <div id="tabs">
<ul class="wooTabs">
<li class="popular"><a href="#tab-pop">Popular</a></li> </ul>
<div class="clear"></div>
<div class="boxes box inside">
<ul class="list" id="tab-pop">
<li>
<a href="https://machinelearningmastery.com/machine-learning-in-python-step-by-step/" title="Your First Machine Learning Project in Python Step-By-Step"><img alt="Your First Machine Learning Project in Python Step-By-Step" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Your-First-Machine-Learning-Project-in-Python-Step-By-Step-150x150.jpg" title="Your First Machine Learning Project in Python Step-By-Step" width="45"/></a> <a href="https://machinelearningmastery.com/machine-learning-in-python-step-by-step/" title="Your First Machine Learning Project in Python Step-By-Step">Your First Machine Learning Project in Python Step-By-Step</a>
<span class="meta">June 10, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras"><img alt="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/07/Time-Series-Prediction-with-LSTM-Recurrent-Neural-Networks-in-Python-with-Keras-150x150.jpg" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras" width="45"/></a> <a href="https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras">Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras</a>
<span class="meta">July 21, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/" title="Multivariate Time Series Forecasting with LSTMs in Keras"><img alt="Line Plots of Air Pollution Time Series" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/06/Line-Plots-of-Air-Pollution-Time-Series-150x150.png" title="Multivariate Time Series Forecasting with LSTMs in Keras" width="45"/></a> <a href="https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/" title="Multivariate Time Series Forecasting with LSTMs in Keras">Multivariate Time Series Forecasting with LSTMs in Keras</a>
<span class="meta">August 14, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/tutorial-first-neural-network-python-keras/" title="Develop Your First Neural Network in Python With Keras Step-By-Step"><img alt="Tour of Deep Learning Algorithms" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/04/Tour-of-Deep-Learning-Algorithms-150x150.jpg" title="Develop Your First Neural Network in Python With Keras Step-By-Step" width="45"/></a> <a href="https://machinelearningmastery.com/tutorial-first-neural-network-python-keras/" title="Develop Your First Neural Network in Python With Keras Step-By-Step">Develop Your First Neural Network in Python With Keras Step-By-Step</a>
<span class="meta">May 24, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda"><img alt="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/How-to-Setup-a-Python-Environment-for-Machine-Learning-and-Deep-Learning-with-Anaconda-150x150.png" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda" width="45"/></a> <a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda">How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda</a>
<span class="meta">March 13, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/sequence-classification-lstm-recurrent-neural-networks-python-keras/" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras"><img alt="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/07/Sequence-Classification-with-LSTM-Recurrent-Neural-Networks-in-Python-with-Keras-150x150.jpg" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras" width="45"/></a> <a href="https://machinelearningmastery.com/sequence-classification-lstm-recurrent-neural-networks-python-keras/" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras">Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras</a>
<span class="meta">July 26, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/time-series-forecasting-long-short-term-memory-network-python/" title="Time Series Forecasting with the Long Short-Term Memory Network in Python"><img alt="Time Series Forecasting with the Long Short-Term Memory Network in Python" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/04/Time-Series-Forecasting-with-the-Long-Short-Term-Memory-Network-in-Python-150x150.jpg" title="Time Series Forecasting with the Long Short-Term Memory Network in Python" width="45"/></a> <a href="https://machinelearningmastery.com/time-series-forecasting-long-short-term-memory-network-python/" title="Time Series Forecasting with the Long Short-Term Memory Network in Python">Time Series Forecasting with the Long Short-Term Memory Network in Python</a>
<span class="meta">April 7, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/multi-class-classification-tutorial-keras-deep-learning-library/" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library"><img alt="Multi-Class Classification Tutorial with the Keras Deep Learning Library" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Multi-Class-Classification-Tutorial-with-the-Keras-Deep-Learning-Library-150x150.jpg" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library" width="45"/></a> <a href="https://machinelearningmastery.com/multi-class-classification-tutorial-keras-deep-learning-library/" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library">Multi-Class Classification Tutorial with the Keras Deep Learning Library</a>
<span class="meta">June 2, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/regression-tutorial-keras-deep-learning-library-python/" title="Regression Tutorial with the Keras Deep Learning Library in Python"><img alt="Regression Tutorial with Keras Deep Learning Library in Python" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Regression-Tutorial-with-Keras-Deep-Learning-Library-in-Python-150x150.jpg" title="Regression Tutorial with the Keras Deep Learning Library in Python" width="45"/></a> <a href="https://machinelearningmastery.com/regression-tutorial-keras-deep-learning-library-python/" title="Regression Tutorial with the Keras Deep Learning Library in Python">Regression Tutorial with the Keras Deep Learning Library in Python</a>
<span class="meta">June 9, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/grid-search-hyperparameters-deep-learning-models-python-keras/" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras"><img alt="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/08/How-to-Grid-Search-Hyperparameters-for-Deep-Learning-Models-in-Python-With-Keras-150x150.jpg" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras" width="45"/></a> <a href="https://machinelearningmastery.com/grid-search-hyperparameters-deep-learning-models-python-keras/" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras">How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras</a>
<span class="meta">August 9, 2016</span>
<div class="fix"></div>
</li>
</ul>
</div><!-- /.boxes -->
</div><!-- /wooTabs -->
</div> </aside><!-- /#sidebar -->
</div><!-- /#main-sidebar-container -->
</div><!-- /#content -->
<footer class="col-full" id="footer">
<div class="col-left" id="copyright">
<p>© 2018 Machine Learning Mastery. All Rights Reserved. </p> </div>
<div class="col-right" id="credit">
<p></p><p>
<a href="/privacy/">Privacy</a> | 
<a href="/contact/">Contact</a> |
<a href="/about/">About</a>
</p> </div>
</footer>
</div><!-- /#inner-wrapper -->
</div><!-- /#wrapper -->
<div class="fix"></div><!--/.fix-->
<!-- Drip -->
<script type="text/javascript">
  var _dcq = _dcq || [];
  var _dcs = _dcs || {}; 
  _dcs.account = '9556588';
  
  (function() {
    var dc = document.createElement('script');
    dc.type = 'text/javascript'; dc.async = true; 
    dc.src = '//tag.getdrip.com/9556588.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(dc, s);
  })();
</script><!-- Woo Tabs Widget -->
<script type="text/javascript">
jQuery(document).ready(function(){
	// UL = .wooTabs
	// Tab contents = .inside

	var tag_cloud_class = '#tagcloud';

	//Fix for tag clouds - unexpected height before .hide()
	var tag_cloud_height = jQuery( '#tagcloud').height();

	jQuery( '.inside ul li:last-child').css( 'border-bottom','0px' ); // remove last border-bottom from list in tab content
	jQuery( '.wooTabs').each(function(){
		jQuery(this).children( 'li').children( 'a:first').addClass( 'selected' ); // Add .selected class to first tab on load
	});
	jQuery( '.inside > *').hide();
	jQuery( '.inside > *:first-child').show();

	jQuery( '.wooTabs li a').click(function(evt){ // Init Click funtion on Tabs

		var clicked_tab_ref = jQuery(this).attr( 'href' ); // Strore Href value

		jQuery(this).parent().parent().children( 'li').children( 'a').removeClass( 'selected' ); //Remove selected from all tabs
		jQuery(this).addClass( 'selected' );
		jQuery(this).parent().parent().parent().children( '.inside').children( '*').hide();

		jQuery( '.inside ' + clicked_tab_ref).fadeIn(500);

		 evt.preventDefault();

	})
})
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/comment-reply.min.js?ver=4.9.2" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var wpcf7 = {"apiSettings":{"root":"https:\/\/machinelearningmastery.com\/wp-json\/contact-form-7\/v1","namespace":"contact-form-7\/v1"},"recaptcha":{"messages":{"empty":"Please verify that you are not a robot."}},"cached":"1"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/js/scripts.js?ver=4.9.2" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var frontend_ajax_object = {"ajax_url":"https:\/\/machinelearningmastery.com\/wp-admin\/admin-ajax.php","ajax_nonce":"555b70787c"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/seo-optimized-share-buttons/js/frontend.js?ver=4.2.2.0.iis7_supports_permalinks" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/wp-embed.min.js?ver=4.9.2" type="text/javascript"></script>
<script async="async" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/akismet/_inc/form.js?ver=4.0.2" type="text/javascript"></script>
</body>
</html>