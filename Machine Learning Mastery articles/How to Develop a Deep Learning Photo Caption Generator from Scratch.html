<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
<meta charset="utf-8"/>
<title>How to Develop a Deep Learning Photo Caption Generator from Scratch - Machine Learning Mastery</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="https://machinelearningmastery.com/xmlrpc.php" rel="pingback"/>
<!--  Mobile viewport scale -->
<meta content="initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" name="viewport"/>
<!-- This site is optimized with the Yoast SEO plugin v6.1.1 - https://yoa.st/1yg?utm_content=6.1.1 -->
<link href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" rel="canonical"/>
<link href="https://plus.google.com/u/0/b/117073416089354242117/+MachinelearningmasteryHome/" rel="publisher"/>
<meta content="en_US" property="og:locale"/>
<meta content="article" property="og:type"/>
<meta content="How to Develop a Deep Learning Photo Caption Generator from Scratch - Machine Learning Mastery" property="og:title"/>
<meta content="Develop a Deep Learning Model to Automatically Describe Photographs in Python with Keras, Step-by-Step. Caption generation is a challenging artificial intelligence problem where a textual description must be generated for a given photograph. It requires both methods from computer vision to understand the content of the image and a language model from the field of …" property="og:description"/>
<meta content="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" property="og:url"/>
<meta content="Machine Learning Mastery" property="og:site_name"/>
<meta content="https://www.facebook.com/Machine-Learning-Mastery-1429846323896563/" property="article:publisher"/>
<meta content="Natural Language Processing" property="article:section"/>
<meta content="2017-11-27T05:00:59+11:00" property="article:published_time"/>
<meta content="2017-12-14T16:44:18+11:00" property="article:modified_time"/>
<meta content="2017-12-14T16:44:18+11:00" property="og:updated_time"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/example.jpg" property="og:image"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/example.jpg" property="og:image:secure_url"/>
<meta content="640" property="og:image:width"/>
<meta content="512" property="og:image:height"/>
<script type="application/ld+json">{"@context":"http:\/\/schema.org","@type":"WebSite","@id":"#website","url":"https:\/\/machinelearningmastery.com\/","name":"Machine Learning Mastery","potentialAction":{"@type":"SearchAction","target":"https:\/\/machinelearningmastery.com\/?s={search_term_string}","query-input":"required name=search_term_string"}}</script>
<script type="application/ld+json">{"@context":"http:\/\/schema.org","@type":"Organization","url":"https:\/\/machinelearningmastery.com\/develop-a-deep-learning-caption-generation-model-in-python\/","sameAs":["https:\/\/www.facebook.com\/Machine-Learning-Mastery-1429846323896563\/","https:\/\/www.linkedin.com\/in\/jasonbrownlee","https:\/\/plus.google.com\/u\/0\/b\/117073416089354242117\/+MachinelearningmasteryHome\/","https:\/\/twitter.com\/TeachTheMachine"],"@id":"#organization","name":"Machine Learning Mastery","logo":"https:\/\/machinelearningmastery.com\/wp-content\/uploads\/2016\/09\/cropped-icon.png"}</script>
<!-- / Yoast SEO plugin. -->
<link href="//cdnjs.cloudflare.com" rel="dns-prefetch"/>
<link href="//fonts.googleapis.com" rel="dns-prefetch"/>
<link href="//s.w.org" rel="dns-prefetch"/>
<link href="https://feeds.feedburner.com/MachineLearningMastery" rel="alternate" title="Machine Learning Mastery » Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/comments/feed/" rel="alternate" title="Machine Learning Mastery » Comments Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/feed/" rel="alternate" title="Machine Learning Mastery » How to Develop a Deep Learning Photo Caption Generator from Scratch Comments Feed" type="application/rss+xml"/>
<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/machinelearningmastery.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.9.2"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56794,8205,9794,65039],[55358,56794,8203,9794,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta" id="crayon-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta" id="crayon-theme-classic-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta" id="crayon-font-monaco-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=4.9.2" id="contact-form-7-css" media="all" rel="stylesheet" type="text/css"/>
<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css?ver=4.2.2.0.iis7_supports_permalinks" id="apss-font-awesome-css" media="all" rel="stylesheet" type="text/css"/>
<link href="//fonts.googleapis.com/css?family=Open+Sans&amp;ver=4.9.2" id="apss-font-opensans-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/seo-optimized-share-buttons/css/frontend.css?ver=4.2.2.0.iis7_supports_permalinks" id="apss-frontend-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/integrations/testimonials/css/testimonials.css?ver=4.9.2" id="woo-testimonials-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/style.css?ver=5.9.21" id="theme-stylesheet-css" media="all" rel="stylesheet" type="text/css"/>
<!--[if lt IE 9]>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/css/non-responsive.css" rel="stylesheet" type="text/css" />
<style type="text/css">.col-full, #wrapper { width: 960px; max-width: 960px; } #inner-wrapper { padding: 0; } body.full-width #header, #nav-container, body.full-width #content, body.full-width #footer-widgets, body.full-width #footer { padding-left: 0; padding-right: 0; } body.fixed-mobile #top, body.fixed-mobile #header-container, body.fixed-mobile #footer-container, body.fixed-mobile #nav-container, body.fixed-mobile #footer-widgets-container { min-width: 960px; padding: 0 1em; } body.full-width #content { width: auto; padding: 0 1em;}</style>
<![endif]-->
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery.js?ver=1.12.4" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/machinelearningmastery.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/third-party.min.js?ver=4.9.2" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/modernizr.min.js?ver=2.6.2" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/general.min.js?ver=4.9.2" type="text/javascript"></script>
<link href="https://machinelearningmastery.com/wp-json/" rel="https://api.w.org/"/>
<link href="https://machinelearningmastery.com/xmlrpc.php?rsd" rel="EditURI" title="RSD" type="application/rsd+xml"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/wlwmanifest.xml" rel="wlwmanifest" type="application/wlwmanifest+xml"/>
<link href="https://machinelearningmastery.com/?p=4459" rel="shortlink"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fdevelop-a-deep-learning-caption-generation-model-in-python%2F" rel="alternate" type="application/json+oembed"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fdevelop-a-deep-learning-caption-generation-model-in-python%2F&amp;format=xml" rel="alternate" type="text/xml+oembed"/>
<!-- Start Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44039733-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->
<!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');

fbq('init', '296263687421164');
fbq('track', "PageView");</script>
<noscript><img height="1" src="https://www.facebook.com/tr?id=296263687421164&amp;ev=PageView&amp;noscript=1" style="display:none" width="1"/></noscript>
<!-- End Facebook Pixel Code -->
<!-- Custom CSS Styling -->
<style type="text/css">
#logo .site-title, #logo .site-description { display:none; }
body {background-repeat:no-repeat;background-position:top left;background-attachment:scroll;border-top:0px solid #000000;}
#header {background-repeat:no-repeat;background-position:left top;margin-top:0px;margin-bottom:0px;padding-top:10px;padding-bottom:10px;border:0px solid ;}
#logo .site-title a {font:bold 40px/1em Helvetica Neue, Helvetica, sans-serif;color:#222222;}
#logo .site-description {font:300 13px/1em Helvetica Neue, Helvetica, sans-serif;color:#999999;}
body, p { font:300 14px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
h1 { font:bold 28px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h2 { font:bold 24px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h3 { font:bold 20px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h4 { font:bold 16px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h5 { font:bold 14px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h6 { font:bold 12px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }
.page-title, .post .title, .page .title {font:bold 28px/1.1em "Helvetica Neue", Helvetica, sans-serif;color:#222222;}
.post .title a:link, .post .title a:visited, .page .title a:link, .page .title a:visited {color:#222222}
.post-meta { font:300 12px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#999999; }
.entry, .entry p{ font:300 15px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555; }
.post-more {font:300 13px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:;border-top:0px solid #e6e6e6;border-bottom:0px solid #e6e6e6;}
#post-author, #connect {border-top:1px solid #e6e6e6;border-bottom:1px solid #e6e6e6;border-left:1px solid #e6e6e6;border-right:1px solid #e6e6e6;border-radius:5px;-moz-border-radius:5px;-webkit-border-radius:5px;background-color:#fafafa}
.nav-entries a, .woo-pagination { font:300 13px/1em "Helvetica Neue", Helvetica, sans-serif;color:#888; }
.woo-pagination a, .woo-pagination a:hover {color:#888!important}
.widget h3 {font:bold 14px/1.2em &quot;Helvetica Neue&quot;, Helvetica, sans-serif;color:#555555;border-bottom:1px solid #e6e6e6;}
.widget_recent_comments li, #twitter li { border-color: #e6e6e6;}
.widget p, .widget .textwidget { font:300 13px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
.widget {font:300 13px/1.5em &quot;Helvetica Neue&quot;, Helvetica, sans-serif;color:#555555;border-radius:0px;-moz-border-radius:0px;-webkit-border-radius:0px;}
#tabs .inside li a, .widget_woodojo_tabs .tabbable .tab-pane li a { font:bold 12px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
#tabs .inside li span.meta, .widget_woodojo_tabs .tabbable .tab-pane li span.meta { font:300 11px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
#tabs ul.wooTabs li a, .widget_woodojo_tabs .tabbable .nav-tabs li a { font:300 11px/2em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
@media only screen and (min-width:768px) {
ul.nav li a, #navigation ul.rss a, #navigation ul.cart a.cart-contents, #navigation .cart-contents #navigation ul.rss, #navigation ul.nav-search, #navigation ul.nav-search a { font:300 14px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#666666; } #navigation ul.rss li a:before, #navigation ul.nav-search a.search-contents:before { color:#666666;}
#navigation ul.nav li ul, #navigation ul.cart > li > ul > div  { border: 0px solid #dbdbdb; }
#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation ul.nav > li  { border-right: 0px solid #dbdbdb; }#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation { box-shadow: none; -moz-box-shadow: none; -webkit-box-shadow: none; }#navigation ul li:first-child, #navigation ul li:first-child a { border-radius:0px 0 0 0px; -moz-border-radius:0px 0 0 0px; -webkit-border-radius:0px 0 0 0px; }
#navigation {border-top:0px solid #dbdbdb;border-bottom:0px solid #dbdbdb;border-left:0px solid #dbdbdb;border-right:0px solid #dbdbdb;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
#top ul.nav li a { font:300 12px/1.6em Helvetica Neue, Helvetica, sans-serif;color:#ddd; }
}
#footer, #footer p { font:300 13px/1.4em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
#footer {border-top:1px solid #dbdbdb;border-bottom:0px solid ;border-left:0px solid ;border-right:0px solid ;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
.magazine #loopedSlider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-magazine .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.magazine #loopedSlider .content .excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-magazine .slide-content p, .wooslider-theme-magazine .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.magazine .block .post .title a {font:bold 18px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }
#loopedSlider.business-slider .content h2 { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#loopedSlider.business-slider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#wrapper #loopedSlider.business-slider .content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.archive_header { font:bold 18px/1em Arial, sans-serif;color:#222222; }
.archive_header {border-bottom:1px solid #e6e6e6;}
.archive_header .catrss { display:none; }
</style>
<!-- Woo Shortcodes CSS -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/functions/css/shortcodes.css" rel="stylesheet" type="text/css"/>
<!-- Custom Stylesheet -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/custom.css" rel="stylesheet" type="text/css"/>
<!-- Theme version -->
<meta content="Canvas 5.9.21" name="generator"/>
<meta content="WooFramework 6.2.9" name="generator"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-32x32.png" rel="icon" sizes="32x32"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-192x192.png" rel="icon" sizes="192x192"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-180x180.png" rel="apple-touch-icon-precomposed"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-270x270.png" name="msapplication-TileImage"/>
</head>
<body class="post-template-default single single-post postid-4459 single-format-standard gecko alt-style-default two-col-left width-960 two-col-left-960">
<div id="wrapper">
<div id="inner-wrapper">
<h3 class="nav-toggle icon"><a href="#navigation">Navigation</a></h3>
<header class="col-full" id="header">
<div id="logo">
<a href="https://machinelearningmastery.com/" title="Making developers awesome at machine learning"><img alt="Machine Learning Mastery" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/MachineLearningMastery.png"/></a>
<span class="site-title"><a href="https://machinelearningmastery.com/">Machine Learning Mastery</a></span>
<span class="site-description">Making developers awesome at machine learning</span>
</div>
<div class="header-widget">
<div class="widget widget_text" id="text-3"> <div class="textwidget"><br/>
<div style="font-size:12pt;">
<a href="/start-here"><strong>Start Here</strong></a>
     
<a href="/blog">Blog</a>
     
<a href="/products">Books</a>
     
<a href="/about">About</a>
     
<a href="/contact">Contact</a>
</div></div>
</div><div class="widget widget_search" id="search-3"><div class="search_main">
<form action="https://machinelearningmastery.com/" class="searchform" method="get">
<input class="field s" name="s" onblur="if (this.value == '') {this.value = 'Search...';}" onfocus="if (this.value == 'Search...') {this.value = '';}" type="text" value="Search..."/>
<button class="fa fa-search submit" name="submit" type="submit" value="Search"></button>
</form>
<div class="fix"></div>
</div></div><div class="widget widget_text" id="text-44"> <div class="textwidget"><p>Need help with Deep Learning for Text? <a href="https://machinelearningmastery.lpages.co/dlfnlp-mini-course/">Take the FREE Mini-Course</a></p>
</div>
</div> </div>
</header>
<nav class="col-full" id="navigation" role="navigation">
<section class="menus">
<a class="nav-home" href="https://machinelearningmastery.com"><span>Home</span></a>
<h3>Empty Menu</h3> <div class="side-nav">
</div><!-- /#side-nav -->
</section><!-- /.menus -->
<a class="nav-close" href="#top"><span>Return to Content</span></a>
</nav>
<!-- #content Starts -->
<div class="col-full" id="content">
<div id="main-sidebar-container">
<!-- #main Starts -->
<section id="main">
<article class="post-4459 post type-post status-publish format-standard has-post-thumbnail hentry category-natural-language-processing">
<header>
<h1 class="title entry-title">How to Develop a Deep Learning Photo Caption Generator from Scratch</h1> </header>
<div class="post-meta"><span class="small">By</span> <span class="author vcard"><span class="fn"><a href="https://machinelearningmastery.com/author/jasonb/" rel="author" title="Posts by Jason Brownlee">Jason Brownlee</a></span></span> <span class="small">on</span> <abbr class="date time published updated" title="2017-11-27T05:00:59+1100">November 27, 2017</abbr> <span class="small">in</span> <span class="categories"><a href="https://machinelearningmastery.com/category/natural-language-processing/" title="View all items in Natural Language Processing">Natural Language Processing</a></span> </div>
<section class="entry">
<div class="apss-social-share apss-theme-4 clearfix">
<div class="apss-twitter apss-single-icon">
<a href="javascript:void(0);" onclick="apss_open_in_popup_window(event, 'https://twitter.com/intent/tweet?text=How%20to%20Develop%20a%20Deep%20Learning%20Photo%20Caption%20Generator%20from%20Scratch&amp;url=https%3A%2F%2Fmachinelearningmastery.com%2Fdevelop-a-deep-learning-caption-generation-model-in-python%2F&amp;');" rel="nofollow" target="" title="Share on Twitter">
<div class="apss-icon-block clearfix">
<i class="fa fa-twitter"></i>
<span class="apss-social-text">Share on Twitter</span><span class="apss-share">Tweet</span>
</div>
</a>
</div>
<div class="apss-facebook apss-single-icon">
<a href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" onclick="apss_open_in_popup_window(event, 'https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/');" rel="nofollow" target="" title="Share on Facebook">
<div class="apss-icon-block clearfix">
<i class="fa fa-facebook"></i>
<span class="apss-social-text">Share on Facebook</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-linkedin apss-single-icon">
<a href="http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Develop%20a%20Deep%20Learning%20Photo%20Caption%20Generator%20from%20Scratch&amp;url=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/&amp;summary=Develop+a+Deep+Learning+Model+to+Automatically%0D%0ADescribe+Photographs+in+Python+with+Keras%2C+Step-by-S..." onclick="apss_open_in_popup_window(event, 'http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Develop%20a%20Deep%20Learning%20Photo%20Caption%20Generator%20from%20Scratch&amp;url=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/&amp;summary=Develop+a+Deep+Learning+Model+to+Automatically%0D%0ADescribe+Photographs+in+Python+with+Keras%2C+Step-by-S...');" rel="nofollow" target="" title="Share on LinkedIn">
<div class="apss-icon-block clearfix"><i class="fa fa-linkedin"></i>
<span class="apss-social-text">Share on LinkedIn</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-google-plus apss-single-icon">
<a href="https://plus.google.com/share?url=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" onclick="apss_open_in_popup_window(event, 'https://plus.google.com/share?url=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/');" rel="nofollow" target="" title="Share on Google Plus">
<div class="apss-icon-block clearfix">
<i class="fa fa-google-plus"></i>
<span class="apss-social-text">Share on Google Plus</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
</div><h4 style="text-align: center;">Develop a Deep Learning Model to Automatically<br/>
Describe Photographs in Python with Keras, Step-by-Step.</h4>
<p>Caption generation is a challenging artificial intelligence problem where a textual description must be generated for a given photograph.</p>
<p>It requires both methods from computer vision to understand the content of the image and a language model from the field of natural language processing to turn the understanding of the image into words in the right order. Recently, deep learning methods have achieved state-of-the-art results on examples of this problem.</p>
<p>Deep learning methods have demonstrated state-of-the-art results on caption generation problems. What is most impressive about these methods is a single end-to-end model can be defined to predict a caption, given a photo, instead of requiring sophisticated data preparation or a pipeline of specifically designed models.</p>
<p>In this tutorial, you will discover how to develop a photo captioning deep learning model from scratch.</p>
<p>After completing this tutorial, you will know:</p>
<ul>
<li>How to prepare photo and text data for training a deep learning model.</li>
<li>How to design and train a deep learning caption generation model.</li>
<li>How to evaluate a train caption generation model and use it to caption entirely new photographs.</li>
</ul>
<p>Let’s get started.</p>
<ul>
<li><strong>Update Nov/2017</strong>: Added note about a bug introduced in Keras 2.1.0 and 2.1.1 that impacts the code in this tutorial.</li>
<li><strong>Update Dec/2017</strong>: Updated a typo in the function name when explaining how to save descriptions to file, thanks Minel.</li>
</ul>
<div class="wp-caption aligncenter" id="attachment_4463" style="max-width: 650px"><img alt="How to Develop a Deep Learning Caption Generation Model in Python from Scratch" class="size-full wp-image-4463" height="480" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Develop-a-Deep-Learning-Caption-Generation-Model-in-Python-from-Scratch.jpg" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Develop-a-Deep-Learning-Caption-Generation-Model-in-Python-from-Scratch.jpg 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Develop-a-Deep-Learning-Caption-Generation-Model-in-Python-from-Scratch-300x225.jpg 300w" width="640"/><p class="wp-caption-text">How to Develop a Deep Learning Caption Generation Model in Python from Scratch<br/>Photo by <a href="https://www.flickr.com/photos/livinginmonrovia/8069637650/">Living in Monrovia</a>, some rights reserved.</p></div>
<h2>Tutorial Overview</h2>
<p>This tutorial is divided into 6 parts; they are:</p>
<ol>
<li>Photo and Caption Dataset</li>
<li>Prepare Photo Data</li>
<li>Prepare Text Data</li>
<li>Develop Deep Learning Model</li>
<li>Evaluate Model</li>
<li>Generate New Captions</li>
</ol>
<h3>Python Environment</h3>
<p>This tutorial assumes you have a Python SciPy environment installed, ideally with Python 3.</p>
<p>You must have Keras (2.0 or higher) installed with either the TensorFlow or Theano backend.</p>
<p>The tutorial also assumes you have scikit-learn, Pandas, NumPy, and Matplotlib installed.</p>
<p>If you need help with your environment, see this tutorial:</p>
<ul>
<li><a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/">How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda</a></li>
</ul>
<p>I recommend running the code on a system with a GPU. You can access GPUs cheaply on Amazon Web Services. Learn how in this tutorial:</p>
<ul>
<li><a href="https://machinelearningmastery.com/develop-evaluate-large-deep-learning-models-keras-amazon-web-services/">How To Develop and Evaluate Large Deep Learning Models with Keras on Amazon Web Services</a></li>
</ul>
<p>Let’s dive in.</p>
<h3>Update Regarding Keras 2.1.1</h3>
<p>If you are using Keras 2.1.0 or Keras 2.1.1 you may see an error like the following when training the model:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49103536793073" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
ValueError: Error when checking target: expected dense_3 to have shape (None, 7579) but got array with shape (306404, 1)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49103536793073-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49103536793073-1">ValueError: Error when checking target: expected dense_3 to have shape (None, 7579) but got array with shape (306404, 1)</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>This is caused by a fault introduced in those versions of Keras. The fault appears to have been introduced in the to_categorical() function. I can confirm the fault occurs with Keras 2.1.1.</p>
<p>You can learn more about the fault here: <a href="https://github.com/fchollet/keras/issues/8519">utils.to_categorical should output a matrix even if input is single element</a>.</p>
<p>There are two options:</p>
<p>1. Downgrade Keras to 2.0.8 or upgrade to Keras 2.1.2.</p>
<p>or</p>
<p>2. Modify the code, change line 104 in the training example from:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4910b424014008" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4910b424014008-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4910b424014008-1"><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>to</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4910e174269518" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
out_seq = to_categorical([out_seq], num_classes=vocab_size)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4910e174269518-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4910e174269518-1"><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p><!-- Start shortcoder --></p><p></p><div class="woo-sc-hr"></div>
<center>
<h3>Need help with Deep Learning for Text Data?</h3>
<p>Take my free 7-day email crash course now (with sample code).</p>
<p>Click to sign-up and also get a free PDF Ebook version of the course.</p>
<p><a href="https://machinelearningmastery.lpages.co/leadbox/144855173f72a2%3A164f8be4f346dc/5655638436741120/" rel="noopener" style="background: #ffce0a; color: #ffffff; text-decoration: none; font-family: Helvetica, Arial, sans-serif; font-weight: bold; font-size: 16px; line-height: 20px; padding: 10px; display: inline-block; max-width: 300px; border-radius: 5px; text-shadow: rgba(0, 0, 0, 0.25) 0px -1px 1px; box-shadow: rgba(255, 255, 255, 0.5) 0px 1px 3px inset, rgba(0, 0, 0, 0.5) 0px 1px 3px;" target="_blank">Start Your FREE Crash-Course Now</a><script data-config="%7B%7D" data-leadbox="144855173f72a2:164f8be4f346dc" data-url="https://machinelearningmastery.lpages.co/leadbox/144855173f72a2%3A164f8be4f346dc/5655638436741120/" src="https://machinelearningmastery.lpages.co/leadbox-1509466860.js" type="text/javascript"></script></p>
</center>
<p></p><div class="woo-sc-hr"></div><!-- End shortcoder v4.1.5-->
<h2>Photo and Caption Dataset</h2>
<p>A good dataset to use when getting started with image captioning is the Flickr8K dataset.</p>
<p>The reason is because it is realistic and relatively small so that you can download it and build models on your workstation using a CPU.</p>
<p>The definitive description of the dataset is in the paper “<a href="https://www.jair.org/media/3994/live-3994-7274-jair.pdf">Framing Image Description as a Ranking Task: Data, Models and Evaluation Metrics</a>” from 2013.</p>
<p>The authors describe the dataset as follows:</p>
<blockquote><p>We introduce a new benchmark collection for sentence-based image description and search, consisting of 8,000 images that are each paired with five different captions which provide clear descriptions of the salient entities and events.</p>
<p>…</p>
<p>The images were chosen from six different Flickr groups, and tend not to contain any well-known people or locations, but were manually selected to depict a variety of scenes and situations.</p></blockquote>
<p>— <a href="https://www.jair.org/media/3994/live-3994-7274-jair.pdf">Framing Image Description as a Ranking Task: Data, Models and Evaluation Metrics</a>, 2013.</p>
<p>The dataset is available for free. You must complete a request form and the links to the dataset will be emailed to you. I would love to link to them for you, but the email address expressly requests: “<em>Please do not redistribute the dataset</em>“.</p>
<p>You can use the link below to request the dataset:</p>
<ul>
<li><a href="https://illinois.edu/fb/sec/1713398">Dataset Request Form</a></li>
</ul>
<p>Within a short time, you will receive an email that contains links to two files:</p>
<ul>
<li><strong>Flickr8k_Dataset.zip</strong> (1 Gigabyte) An archive of all photographs.</li>
<li><strong>Flickr8k_text.zip</strong> (2.2 Megabytes) An archive of all text descriptions for photographs.</li>
</ul>
<p>Download the datasets and unzip them into your current working directory. You will have two directories:</p>
<ul>
<li><strong>Flicker8k_Dataset</strong>: Contains 8092 photographs in JPEG format.</li>
<li><strong>Flickr8k_text</strong>: Contains a number of files containing different sources of descriptions for the photographs.</li>
</ul>
<p>The dataset has a pre-defined training dataset (6,000 images), development dataset (1,000 images), and test dataset (1,000 images).</p>
<p>One measure that can be used to evaluate the skill of the model are BLEU scores. For reference, below are some ball-park BLEU scores for skillful models when evaluated on the test dataset (taken from the 2017 paper “<a href="https://arxiv.org/abs/1703.09137">Where to put the Image in an Image Caption Generator</a>“):</p>
<ul>
<li>BLEU-1: 0.401 to 0.578.</li>
<li>BLEU-2: 0.176 to 0.390.</li>
<li>BLEU-3: 0.099 to 0.260.</li>
<li>BLEU-4: 0.059 to 0.170.</li>
</ul>
<p>We describe the BLEU metric more later when we work on evaluating our model.</p>
<p>Next, let’s look at how to load the images.</p>
<h2>Prepare Photo Data</h2>
<p>We will use a pre-trained model to interpret the content of the photos.</p>
<p>There are many models to choose from. In this case, we will use the Oxford Visual Geometry Group, or VGG, model that won the ImageNet competition in 2014. Learn more about the model here:</p>
<ul>
<li><a href="http://www.robots.ox.ac.uk/~vgg/research/very_deep/">Very Deep Convolutional Networks for Large-Scale Visual Recognition</a></li>
</ul>
<p>Keras provides this pre-trained model directly. Note, the first time you use this model, Keras will download the model weights from the Internet, which are about 500 Megabytes. This may take a few minutes depending on your internet connection.</p>
<p>We could use this model as part of a broader image caption model. The problem is, it is a large model and running each photo through the network every time we want to test a new language model configuration (downstream) is redundant.</p>
<p>Instead, we can pre-compute the “photo features” using the pre-trained model and save them to file. We can then load these features later and feed them into our model as the interpretation of a given photo in the dataset. It is no different to running the photo through the full VGG model; it is just we will have done it once in advance.</p>
<p>This is an optimization that will make training our models faster and consume less memory.</p>
<p>We can load the VGG model in Keras using the VGG class. We will remove the last layer from the loaded model, as this is the model used to predict a classification for a photo. We are not interested in classifying images, but we are interested in the internal representation of the photo right before a classification is made. These are the “features” that the model has extracted from the photo.</p>
<p>Keras also provides tools for reshaping the loaded photo into the preferred size for the model (e.g. 3 channel 224 x 224 pixel image).</p>
<p>Below is a function named <em>extract_features()</em> that, given a directory name, will load each photo, prepare it for VGG, and collect the predicted features from the VGG model. The image features are a 1-dimensional 4,096 element vector.</p>
<p>The function returns a dictionary of image identifier to image features.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49113329091935" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# extract features from each photo in the directory
def extract_features(directory):
	# load the model
	model = VGG16()
	# re-structure the model
	model.layers.pop()
	model = Model(inputs=model.inputs, outputs=model.layers[-1].output)
	# summarize
	print(model.summary())
	# extract features from each photo
	features = dict()
	for name in listdir(directory):
		# load an image from file
		filename = directory + '/' + name
		image = load_img(filename, target_size=(224, 224))
		# convert the image pixels to a numpy array
		image = img_to_array(image)
		# reshape data for the model
		image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
		# prepare the image for the VGG model
		image = preprocess_input(image)
		# get features
		feature = model.predict(image, verbose=0)
		# get image id
		image_id = name.split('.')[0]
		# store feature
		features[image_id] = feature
		print('&gt;%s' % name)
	return features</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49113329091935-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49113329091935-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49113329091935-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49113329091935-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49113329091935-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49113329091935-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49113329091935-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49113329091935-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49113329091935-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49113329091935-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49113329091935-22">22</div><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49113329091935-24">24</div><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49113329091935-26">26</div><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49113329091935-28">28</div><div class="crayon-num" data-line="crayon-5a6591aa49113329091935-29">29</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49113329091935-1"><span class="crayon-p"># extract features from each photo in the directory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49113329091935-2"><span class="crayon-e">def </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49113329091935-3"><span class="crayon-h"> </span><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49113329091935-4"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VGG16</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49113329091935-5"><span class="crayon-h"> </span><span class="crayon-p"># re-structure the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49113329091935-6"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">pop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49113329091935-7"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">inputs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">output</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49113329091935-8"><span class="crayon-h"> </span><span class="crayon-p"># summarize</span></div><div class="crayon-line" id="crayon-5a6591aa49113329091935-9"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49113329091935-10"><span class="crayon-h"> </span><span class="crayon-p"># extract features from each photo</span></div><div class="crayon-line" id="crayon-5a6591aa49113329091935-11"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49113329091935-12"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">listdir</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49113329091935-13"><span class="crayon-h"> </span><span class="crayon-p"># load an image from file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49113329091935-14"><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">name</span></div><div class="crayon-line" id="crayon-5a6591aa49113329091935-15"><span class="crayon-e"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49113329091935-16"><span class="crayon-h"> </span><span class="crayon-p"># convert the image pixels to a numpy array</span></div><div class="crayon-line" id="crayon-5a6591aa49113329091935-17"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49113329091935-18"><span class="crayon-h"> </span><span class="crayon-p"># reshape data for the model</span></div><div class="crayon-line" id="crayon-5a6591aa49113329091935-19"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49113329091935-20"><span class="crayon-h"> </span><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line" id="crayon-5a6591aa49113329091935-21"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49113329091935-22"><span class="crayon-h"> </span><span class="crayon-p"># get features</span></div><div class="crayon-line" id="crayon-5a6591aa49113329091935-23"><span class="crayon-h"> </span><span class="crayon-v">feature</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49113329091935-24"><span class="crayon-h"> </span><span class="crayon-p"># get image id</span></div><div class="crayon-line" id="crayon-5a6591aa49113329091935-25"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49113329091935-26"><span class="crayon-h"> </span><span class="crayon-p"># store feature</span></div><div class="crayon-line" id="crayon-5a6591aa49113329091935-27"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">feature</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49113329091935-28"><span class="crayon-e"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'&gt;%s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49113329091935-29"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0023 seconds] -->
<p>We can call this function to prepare the photo data for testing our models, then save the resulting dictionary to a file named ‘<em>features.pkl</em>‘.</p>
<p>The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49118093708195" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from os import listdir
from pickle import dump
from keras.applications.vgg16 import VGG16
from keras.preprocessing.image import load_img
from keras.preprocessing.image import img_to_array
from keras.applications.vgg16 import preprocess_input
from keras.models import Model

# extract features from each photo in the directory
def extract_features(directory):
	# load the model
	model = VGG16()
	# re-structure the model
	model.layers.pop()
	model = Model(inputs=model.inputs, outputs=model.layers[-1].output)
	# summarize
	print(model.summary())
	# extract features from each photo
	features = dict()
	for name in listdir(directory):
		# load an image from file
		filename = directory + '/' + name
		image = load_img(filename, target_size=(224, 224))
		# convert the image pixels to a numpy array
		image = img_to_array(image)
		# reshape data for the model
		image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
		# prepare the image for the VGG model
		image = preprocess_input(image)
		# get features
		feature = model.predict(image, verbose=0)
		# get image id
		image_id = name.split('.')[0]
		# store feature
		features[image_id] = feature
		print('&gt;%s' % name)
	return features

# extract features from all images
directory = 'Flicker8k_Dataset'
features = extract_features(directory)
print('Extracted Features: %d' % len(features))
# save to file
dump(features, open('features.pkl', 'wb'))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-22">22</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-24">24</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-26">26</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-28">28</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-30">30</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-32">32</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-34">34</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-36">36</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-38">38</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-40">40</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-42">42</div><div class="crayon-num" data-line="crayon-5a6591aa49118093708195-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49118093708195-44">44</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49118093708195-1"><span class="crayon-e">from </span><span class="crayon-e">os </span><span class="crayon-e">import </span><span class="crayon-e">listdir</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-2"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-e">dump</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">VGG16</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">load_img</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">img_to_array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-6"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">preprocess_input</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-7"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-v">Model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-8"> </div><div class="crayon-line" id="crayon-5a6591aa49118093708195-9"><span class="crayon-p"># extract features from each photo in the directory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-10"><span class="crayon-e">def </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-11"><span class="crayon-h"> </span><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-12"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VGG16</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-13"><span class="crayon-h"> </span><span class="crayon-p"># re-structure the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-14"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">pop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-15"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">inputs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">output</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-16"><span class="crayon-h"> </span><span class="crayon-p"># summarize</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-17"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-18"><span class="crayon-h"> </span><span class="crayon-p"># extract features from each photo</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-19"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-20"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">listdir</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-21"><span class="crayon-h"> </span><span class="crayon-p"># load an image from file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-22"><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">name</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-23"><span class="crayon-e"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-24"><span class="crayon-h"> </span><span class="crayon-p"># convert the image pixels to a numpy array</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-25"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-26"><span class="crayon-h"> </span><span class="crayon-p"># reshape data for the model</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-27"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-28"><span class="crayon-h"> </span><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-29"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-30"><span class="crayon-h"> </span><span class="crayon-p"># get features</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-31"><span class="crayon-h"> </span><span class="crayon-v">feature</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-32"><span class="crayon-h"> </span><span class="crayon-p"># get image id</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-33"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-34"><span class="crayon-h"> </span><span class="crayon-p"># store feature</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-35"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">feature</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-36"><span class="crayon-e"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'&gt;%s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-37"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-38"> </div><div class="crayon-line" id="crayon-5a6591aa49118093708195-39"><span class="crayon-p"># extract features from all images</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-40"><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flicker8k_Dataset'</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-41"><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-42"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Extracted Features: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49118093708195-43"><span class="crayon-p"># save to file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49118093708195-44"><span class="crayon-e">dump</span><span class="crayon-sy">(</span><span class="crayon-v">features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0028 seconds] -->
<p>Running this data preparation step may take a while depending on your hardware, perhaps one hour on the CPU with a modern workstation.</p>
<p>At the end of the run, you will have the extracted features stored in ‘<em>features.pkl</em>‘ for later use. This file will be about 127 Megabytes in size.</p>
<h2>Prepare Text Data</h2>
<p>The dataset contains multiple descriptions for each photograph and the text of the descriptions requires some minimal cleaning.</p>
<p>First, we will load the file containing all of the descriptions.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4911c066853665" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

filename = 'Flickr8k_text/Flickr8k.token.txt'
# load descriptions
doc = load_doc(filename)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4911c066853665-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911c066853665-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa4911c066853665-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911c066853665-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa4911c066853665-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911c066853665-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa4911c066853665-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911c066853665-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa4911c066853665-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911c066853665-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa4911c066853665-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911c066853665-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa4911c066853665-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4911c066853665-1"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911c066853665-2"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4911c066853665-3"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911c066853665-4"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4911c066853665-5"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911c066853665-6"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4911c066853665-7"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911c066853665-8"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4911c066853665-9"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911c066853665-10"> </div><div class="crayon-line" id="crayon-5a6591aa4911c066853665-11"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr8k.token.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911c066853665-12"><span class="crayon-p"># load descriptions</span></div><div class="crayon-line" id="crayon-5a6591aa4911c066853665-13"><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0006 seconds] -->
<p>Each photo has a unique identifier. This identifier is used on the photo filename and in the text file of descriptions.</p>
<p>Next, we will step through the list of photo descriptions. Below defines a function <em>load_descriptions()</em> that, given the loaded document text, will return a dictionary of photo identifiers to descriptions. Each photo identifier maps to a list of one or more textual descriptions.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4911e639159421" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# extract descriptions for images
def load_descriptions(doc):
	mapping = dict()
	# process lines
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		if len(line) &lt; 2:
			continue
		# take the first token as the image id, the rest as the description
		image_id, image_desc = tokens[0], tokens[1:]
		# remove filename from image id
		image_id = image_id.split('.')[0]
		# convert description tokens back to string
		image_desc = ' '.join(image_desc)
		# create the list if needed
		if image_id not in mapping:
			mapping[image_id] = list()
		# store description
		mapping[image_id].append(image_desc)
	return mapping

# parse descriptions
descriptions = load_descriptions(doc)
print('Loaded: %d ' % len(descriptions))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4911e639159421-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911e639159421-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa4911e639159421-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911e639159421-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa4911e639159421-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911e639159421-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa4911e639159421-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911e639159421-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa4911e639159421-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911e639159421-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa4911e639159421-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911e639159421-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa4911e639159421-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911e639159421-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa4911e639159421-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911e639159421-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa4911e639159421-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911e639159421-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa4911e639159421-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911e639159421-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa4911e639159421-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911e639159421-22">22</div><div class="crayon-num" data-line="crayon-5a6591aa4911e639159421-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4911e639159421-24">24</div><div class="crayon-num" data-line="crayon-5a6591aa4911e639159421-25">25</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4911e639159421-1"><span class="crayon-p"># extract descriptions for images</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911e639159421-2"><span class="crayon-e">def </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4911e639159421-3"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911e639159421-4"><span class="crayon-h"> </span><span class="crayon-p"># process lines</span></div><div class="crayon-line" id="crayon-5a6591aa4911e639159421-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911e639159421-6"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5a6591aa4911e639159421-7"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911e639159421-8"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4911e639159421-9"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911e639159421-10"><span class="crayon-h"> </span><span class="crayon-p"># take the first token as the image id, the rest as the description</span></div><div class="crayon-line" id="crayon-5a6591aa4911e639159421-11"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911e639159421-12"><span class="crayon-h"> </span><span class="crayon-p"># remove filename from image id</span></div><div class="crayon-line" id="crayon-5a6591aa4911e639159421-13"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911e639159421-14"><span class="crayon-h"> </span><span class="crayon-p"># convert description tokens back to string</span></div><div class="crayon-line" id="crayon-5a6591aa4911e639159421-15"><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911e639159421-16"><span class="crayon-h"> </span><span class="crayon-p"># create the list if needed</span></div><div class="crayon-line" id="crayon-5a6591aa4911e639159421-17"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911e639159421-18"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4911e639159421-19"><span class="crayon-h"> </span><span class="crayon-p"># store description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911e639159421-20"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4911e639159421-21"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">mapping</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911e639159421-22"> </div><div class="crayon-line" id="crayon-5a6591aa4911e639159421-23"><span class="crayon-p"># parse descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4911e639159421-24"><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4911e639159421-25"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Loaded: %d '</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0016 seconds] -->
<p>Next, we need to clean the description text. The descriptions are already tokenized and easy to work with.</p>
<p>We will clean the text in the following ways in order to reduce the size of the vocabulary of words we will need to work with:</p>
<ul>
<li>Convert all words to lowercase.</li>
<li>Remove all punctuation.</li>
<li>Remove all words that are one character or less in length (e.g. ‘a’).</li>
<li>Remove all words with numbers in them.</li>
</ul>
<p>Below defines the <em>clean_descriptions()</em> function that, given the dictionary of image identifiers to descriptions, steps through each description and cleans the text.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49122695009657" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
import string

def clean_descriptions(descriptions):
	# prepare translation table for removing punctuation
	table = str.maketrans('', '', string.punctuation)
	for key, desc_list in descriptions.items():
		for i in range(len(desc_list)):
			desc = desc_list[i]
			# tokenize
			desc = desc.split()
			# convert to lower case
			desc = [word.lower() for word in desc]
			# remove punctuation from each token
			desc = [w.translate(table) for w in desc]
			# remove hanging 's' and 'a'
			desc = [word for word in desc if len(word)&gt;1]
			# remove tokens with numbers in them
			desc = [word for word in desc if word.isalpha()]
			# store as string
			desc_list[i] =  ' '.join(desc)

# clean descriptions
clean_descriptions(descriptions)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49122695009657-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49122695009657-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49122695009657-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49122695009657-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49122695009657-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49122695009657-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49122695009657-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49122695009657-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49122695009657-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49122695009657-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49122695009657-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49122695009657-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa49122695009657-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49122695009657-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa49122695009657-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49122695009657-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa49122695009657-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49122695009657-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa49122695009657-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49122695009657-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa49122695009657-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49122695009657-22">22</div><div class="crayon-num" data-line="crayon-5a6591aa49122695009657-23">23</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49122695009657-1"><span class="crayon-e">import </span><span class="crayon-t">string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49122695009657-2"> </div><div class="crayon-line" id="crayon-5a6591aa49122695009657-3"><span class="crayon-e">def </span><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49122695009657-4"><span class="crayon-h"> </span><span class="crayon-p"># prepare translation table for removing punctuation</span></div><div class="crayon-line" id="crayon-5a6591aa49122695009657-5"><span class="crayon-h"> </span><span class="crayon-v">table</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">str</span><span class="crayon-sy">.</span><span class="crayon-e">maketrans</span><span class="crayon-sy">(</span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-sy">.</span><span class="crayon-v">punctuation</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49122695009657-6"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49122695009657-7"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">desc_list</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49122695009657-8"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa49122695009657-9"><span class="crayon-h"> </span><span class="crayon-p"># tokenize</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49122695009657-10"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49122695009657-11"><span class="crayon-h"> </span><span class="crayon-p"># convert to lower case</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49122695009657-12"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">.</span><span class="crayon-e">lower</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa49122695009657-13"><span class="crayon-h"> </span><span class="crayon-p"># remove punctuation from each token</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49122695009657-14"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">w</span><span class="crayon-sy">.</span><span class="crayon-e">translate</span><span class="crayon-sy">(</span><span class="crayon-v">table</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa49122695009657-15"><span class="crayon-h"> </span><span class="crayon-p"># remove hanging 's' and 'a'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49122695009657-16"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-t">word</span><span class="crayon-sy">)</span><span class="crayon-o">&gt;</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa49122695009657-17"><span class="crayon-h"> </span><span class="crayon-p"># remove tokens with numbers in them</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49122695009657-18"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-sy">.</span><span class="crayon-e">isalpha</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa49122695009657-19"><span class="crayon-h"> </span><span class="crayon-p"># store as string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49122695009657-20"><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h">  </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49122695009657-21"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49122695009657-22"><span class="crayon-p"># clean descriptions</span></div><div class="crayon-line" id="crayon-5a6591aa49122695009657-23"><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0019 seconds] -->
<p>Once cleaned, we can summarize the size of the vocabulary.</p>
<p>Ideally, we want a vocabulary that is both expressive and as small as possible. A smaller vocabulary will result in a smaller model that will train faster.</p>
<p>For reference, we can transform the clean descriptions into a set and print its size to get an idea of the size of our dataset vocabulary.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49125630468287" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# convert the loaded descriptions into a vocabulary of words
def to_vocabulary(descriptions):
	# build a list of all description strings
	all_desc = set()
	for key in descriptions.keys():
		[all_desc.update(d.split()) for d in descriptions[key]]
	return all_desc

# summarize vocabulary
vocabulary = to_vocabulary(descriptions)
print('Vocabulary Size: %d' % len(vocabulary))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49125630468287-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49125630468287-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49125630468287-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49125630468287-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49125630468287-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49125630468287-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49125630468287-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49125630468287-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49125630468287-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49125630468287-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49125630468287-11">11</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49125630468287-1"><span class="crayon-p"># convert the loaded descriptions into a vocabulary of words</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49125630468287-2"><span class="crayon-e">def </span><span class="crayon-e">to_vocabulary</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49125630468287-3"><span class="crayon-h"> </span><span class="crayon-p"># build a list of all description strings</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49125630468287-4"><span class="crayon-h"> </span><span class="crayon-v">all_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49125630468287-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">key </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49125630468287-6"><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">all_desc</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa49125630468287-7"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">all_desc</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49125630468287-8"> </div><div class="crayon-line" id="crayon-5a6591aa49125630468287-9"><span class="crayon-p"># summarize vocabulary</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49125630468287-10"><span class="crayon-v">vocabulary</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_vocabulary</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49125630468287-11"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">vocabulary</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0007 seconds] -->
<p>Finally, we can save the dictionary of image identifiers and descriptions to a new file named <em>descriptions.txt</em>, with one image identifier and description per line.</p>
<p>Below defines the <em>save_descriptions()</em> function that, given a dictionary containing the mapping of identifiers to descriptions and a filename, saves the mapping to file.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49127100162490" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# save descriptions to file, one per line
def save_descriptions(descriptions, filename):
	lines = list()
	for key, desc_list in descriptions.items():
		for desc in desc_list:
			lines.append(key + ' ' + desc)
	data = '\n'.join(lines)
	file = open(filename, 'w')
	file.write(data)
	file.close()

# save descriptions
save_descriptions(descriptions, 'descriptions.txt')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49127100162490-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49127100162490-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49127100162490-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49127100162490-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49127100162490-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49127100162490-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49127100162490-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49127100162490-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49127100162490-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49127100162490-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49127100162490-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49127100162490-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa49127100162490-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49127100162490-1"><span class="crayon-p"># save descriptions to file, one per line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49127100162490-2"><span class="crayon-e">def </span><span class="crayon-e">save_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49127100162490-3"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49127100162490-4"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49127100162490-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49127100162490-6"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">key</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49127100162490-7"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'\n'</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49127100162490-8"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'w'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49127100162490-9"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49127100162490-10"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49127100162490-11"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49127100162490-12"><span class="crayon-p"># save descriptions</span></div><div class="crayon-line" id="crayon-5a6591aa49127100162490-13"><span class="crayon-e">save_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0010 seconds] -->
<p>Putting this all together, the complete listing is provided below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4912a099106751" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
import string

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# extract descriptions for images
def load_descriptions(doc):
	mapping = dict()
	# process lines
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		if len(line) &lt; 2:
			continue
		# take the first token as the image id, the rest as the description
		image_id, image_desc = tokens[0], tokens[1:]
		# remove filename from image id
		image_id = image_id.split('.')[0]
		# convert description tokens back to string
		image_desc = ' '.join(image_desc)
		# create the list if needed
		if image_id not in mapping:
			mapping[image_id] = list()
		# store description
		mapping[image_id].append(image_desc)
	return mapping

def clean_descriptions(descriptions):
	# prepare translation table for removing punctuation
	table = str.maketrans('', '', string.punctuation)
	for key, desc_list in descriptions.items():
		for i in range(len(desc_list)):
			desc = desc_list[i]
			# tokenize
			desc = desc.split()
			# convert to lower case
			desc = [word.lower() for word in desc]
			# remove punctuation from each token
			desc = [w.translate(table) for w in desc]
			# remove hanging 's' and 'a'
			desc = [word for word in desc if len(word)&gt;1]
			# remove tokens with numbers in them
			desc = [word for word in desc if word.isalpha()]
			# store as string
			desc_list[i] =  ' '.join(desc)

# convert the loaded descriptions into a vocabulary of words
def to_vocabulary(descriptions):
	# build a list of all description strings
	all_desc = set()
	for key in descriptions.keys():
		[all_desc.update(d.split()) for d in descriptions[key]]
	return all_desc

# save descriptions to file, one per line
def save_descriptions(descriptions, filename):
	lines = list()
	for key, desc_list in descriptions.items():
		for desc in desc_list:
			lines.append(key + ' ' + desc)
	data = '\n'.join(lines)
	file = open(filename, 'w')
	file.write(data)
	file.close()

filename = 'Flickr8k_text/Flickr8k.token.txt'
# load descriptions
doc = load_doc(filename)
# parse descriptions
descriptions = load_descriptions(doc)
print('Loaded: %d ' % len(descriptions))
# clean descriptions
clean_descriptions(descriptions)
# summarize vocabulary
vocabulary = to_vocabulary(descriptions)
print('Vocabulary Size: %d' % len(vocabulary))
# save to file
save_descriptions(descriptions, 'descriptions.txt')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-22">22</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-24">24</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-26">26</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-28">28</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-30">30</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-32">32</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-34">34</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-36">36</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-38">38</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-40">40</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-42">42</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-44">44</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-46">46</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-48">48</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-50">50</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-52">52</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-54">54</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-56">56</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-58">58</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-60">60</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-62">62</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-64">64</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-66">66</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-68">68</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-70">70</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-72">72</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-74">74</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-76">76</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-78">78</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-80">80</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-82">82</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912a099106751-84">84</div><div class="crayon-num" data-line="crayon-5a6591aa4912a099106751-85">85</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4912a099106751-1"><span class="crayon-e">import </span><span class="crayon-t">string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-2"> </div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-3"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-4"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-5"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-6"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-7"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-8"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-9"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-10"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-11"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-12"> </div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-13"><span class="crayon-p"># extract descriptions for images</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-14"><span class="crayon-e">def </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-15"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-16"><span class="crayon-h"> </span><span class="crayon-p"># process lines</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-17"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-18"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-19"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-20"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-21"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-22"><span class="crayon-h"> </span><span class="crayon-p"># take the first token as the image id, the rest as the description</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-23"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-24"><span class="crayon-h"> </span><span class="crayon-p"># remove filename from image id</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-25"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-26"><span class="crayon-h"> </span><span class="crayon-p"># convert description tokens back to string</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-27"><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-28"><span class="crayon-h"> </span><span class="crayon-p"># create the list if needed</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-29"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-30"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-31"><span class="crayon-h"> </span><span class="crayon-p"># store description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-32"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-33"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">mapping</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-34"> </div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-35"><span class="crayon-e">def </span><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-36"><span class="crayon-h"> </span><span class="crayon-p"># prepare translation table for removing punctuation</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-37"><span class="crayon-h"> </span><span class="crayon-v">table</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">str</span><span class="crayon-sy">.</span><span class="crayon-e">maketrans</span><span class="crayon-sy">(</span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-sy">.</span><span class="crayon-v">punctuation</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-38"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-39"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">desc_list</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-40"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-41"><span class="crayon-h"> </span><span class="crayon-p"># tokenize</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-42"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-43"><span class="crayon-h"> </span><span class="crayon-p"># convert to lower case</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-44"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">.</span><span class="crayon-e">lower</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-45"><span class="crayon-h"> </span><span class="crayon-p"># remove punctuation from each token</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-46"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">w</span><span class="crayon-sy">.</span><span class="crayon-e">translate</span><span class="crayon-sy">(</span><span class="crayon-v">table</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-47"><span class="crayon-h"> </span><span class="crayon-p"># remove hanging 's' and 'a'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-48"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-t">word</span><span class="crayon-sy">)</span><span class="crayon-o">&gt;</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-49"><span class="crayon-h"> </span><span class="crayon-p"># remove tokens with numbers in them</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-50"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-sy">.</span><span class="crayon-e">isalpha</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-51"><span class="crayon-h"> </span><span class="crayon-p"># store as string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-52"><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h">  </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-53"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-54"><span class="crayon-p"># convert the loaded descriptions into a vocabulary of words</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-55"><span class="crayon-e">def </span><span class="crayon-e">to_vocabulary</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-56"><span class="crayon-h"> </span><span class="crayon-p"># build a list of all description strings</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-57"><span class="crayon-h"> </span><span class="crayon-v">all_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-58"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">key </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-59"><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">all_desc</span><span class="crayon-sy">.</span><span class="crayon-e">update</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-60"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">all_desc</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-61"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-62"><span class="crayon-p"># save descriptions to file, one per line</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-63"><span class="crayon-e">def </span><span class="crayon-e">save_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-64"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-65"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-66"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-67"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">key</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-68"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'\n'</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-69"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'w'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-70"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-71"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-72"> </div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-73"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr8k.token.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-74"><span class="crayon-p"># load descriptions</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-75"><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-76"><span class="crayon-p"># parse descriptions</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-77"><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-78"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Loaded: %d '</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-79"><span class="crayon-p"># clean descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-80"><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-81"><span class="crayon-p"># summarize vocabulary</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-82"><span class="crayon-v">vocabulary</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_vocabulary</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-83"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">vocabulary</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912a099106751-84"><span class="crayon-p"># save to file</span></div><div class="crayon-line" id="crayon-5a6591aa4912a099106751-85"><span class="crayon-e">save_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0050 seconds] -->
<p>Running the example first prints the number of loaded photo descriptions (8,092) and the size of the clean vocabulary (8,763 words).</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4912e879371890" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Loaded: 8,092
Vocabulary Size: 8,763</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4912e879371890-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4912e879371890-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4912e879371890-1">Loaded: 8,092</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4912e879371890-2">Vocabulary Size: 8,763</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Finally, the clean descriptions are written to ‘<em>descriptions.txt</em>‘.</p>
<p>Taking a look at the file, we can see that the descriptions are ready for modeling. The order of descriptions in your file may vary.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49130710743131" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
2252123185_487f21e336 bunch on people are seated in stadium
2252123185_487f21e336 crowded stadium is full of people watching an event
2252123185_487f21e336 crowd of people fill up packed stadium
2252123185_487f21e336 crowd sitting in an indoor stadium
2252123185_487f21e336 stadium full of people watch game
...</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49130710743131-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49130710743131-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49130710743131-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49130710743131-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49130710743131-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49130710743131-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49130710743131-1">2252123185_487f21e336 bunch on people are seated in stadium</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49130710743131-2">2252123185_487f21e336 crowded stadium is full of people watching an event</div><div class="crayon-line" id="crayon-5a6591aa49130710743131-3">2252123185_487f21e336 crowd of people fill up packed stadium</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49130710743131-4">2252123185_487f21e336 crowd sitting in an indoor stadium</div><div class="crayon-line" id="crayon-5a6591aa49130710743131-5">2252123185_487f21e336 stadium full of people watch game</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49130710743131-6">...</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<h2>Develop Deep Learning Model</h2>
<p>In this section, we will define the deep learning model and fit it on the training dataset.</p>
<p>This section is divided into the following parts:</p>
<ol>
<li>Loading Data.</li>
<li>Defining the Model.</li>
<li>Fitting the Model.</li>
<li>Complete Example.</li>
</ol>
<h3>Loading Data</h3>
<p>First, we must load the prepared photo and text data so that we can use it to fit the model.</p>
<p>We are going to train the data on all of the photos and captions in the training dataset. While training, we are going to monitor the performance of the model on the development dataset and use that performance to decide when to save models to file.</p>
<p>The train and development dataset have been predefined in the <em>Flickr_8k.trainImages.txt</em> and <em>Flickr_8k.devImages.txt</em> files respectively, that both contain lists of photo file names. From these file names, we can extract the photo identifiers and use these identifiers to filter photos and descriptions for each set.</p>
<p>The function <em>load_set()</em> below will load a pre-defined set of identifiers given the train or development sets filename.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49134903834338" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49134903834338-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49134903834338-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49134903834338-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49134903834338-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49134903834338-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49134903834338-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49134903834338-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49134903834338-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49134903834338-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49134903834338-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49134903834338-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49134903834338-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa49134903834338-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49134903834338-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa49134903834338-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49134903834338-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa49134903834338-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49134903834338-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa49134903834338-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49134903834338-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa49134903834338-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49134903834338-22">22</div><div class="crayon-num" data-line="crayon-5a6591aa49134903834338-23">23</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49134903834338-1"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49134903834338-2"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49134903834338-3"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49134903834338-4"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49134903834338-5"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49134903834338-6"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49134903834338-7"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49134903834338-8"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49134903834338-9"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49134903834338-10"> </div><div class="crayon-line" id="crayon-5a6591aa49134903834338-11"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49134903834338-12"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49134903834338-13"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49134903834338-14"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49134903834338-15"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49134903834338-16"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49134903834338-17"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49134903834338-18"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49134903834338-19"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49134903834338-20"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line" id="crayon-5a6591aa49134903834338-21"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49134903834338-22"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49134903834338-23"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>Now, we can load the photos and descriptions using the pre-defined set of train or development identifiers.</p>
<p>Below is the function <em>load_clean_descriptions()</em> that loads the cleaned text descriptions from ‘<em>descriptions.txt</em>‘ for a given set of identifiers and returns a dictionary of identifiers to lists of text descriptions.</p>
<p>The model we will develop will generate a caption given a photo, and the caption will be generated one word at a time. The sequence of previously generated words will be provided as input. Therefore, we will need a ‘<em>first word</em>’ to kick-off the generation process and a ‘<em>last word</em>‘ to signal the end of the caption.</p>
<p>We will use the strings ‘<em>startseq</em>‘ and ‘<em>endseq</em>‘ for this purpose. These tokens are added to the loaded descriptions as they are loaded. It is important to do this now before we encode the text so that the tokens are also encoded correctly.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49137542505744" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# create list
			if image_id not in descriptions:
				descriptions[image_id] = list()
			# wrap description in tokens
			desc = 'startseq ' + ' '.join(image_desc) + ' endseq'
			# store
			descriptions[image_id].append(desc)
	return descriptions</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49137542505744-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49137542505744-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49137542505744-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49137542505744-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49137542505744-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49137542505744-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49137542505744-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49137542505744-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49137542505744-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49137542505744-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49137542505744-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49137542505744-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa49137542505744-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49137542505744-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa49137542505744-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49137542505744-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa49137542505744-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49137542505744-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa49137542505744-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49137542505744-20">20</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49137542505744-1"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49137542505744-2"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49137542505744-3"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49137542505744-4"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49137542505744-5"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49137542505744-6"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49137542505744-7"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49137542505744-8"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49137542505744-9"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49137542505744-10"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa49137542505744-11"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49137542505744-12"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49137542505744-13"><span class="crayon-h"> </span><span class="crayon-p"># create list</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49137542505744-14"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49137542505744-15"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49137542505744-16"><span class="crayon-h"> </span><span class="crayon-p"># wrap description in tokens</span></div><div class="crayon-line" id="crayon-5a6591aa49137542505744-17"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49137542505744-18"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5a6591aa49137542505744-19"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49137542505744-20"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>Next, we can load the photo features for a given dataset.</p>
<p>Below defines a function named <em>load_photo_features()</em> that loads the entire set of photo descriptions, then returns the subset of interest for a given set of photo identifiers.</p>
<p>This is not very efficient; nevertheless, this will get us up and running quickly.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4913a516398744" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load photo features
def load_photo_features(filename, dataset):
	# load all features
	all_features = load(open(filename, 'rb'))
	# filter features
	features = {k: all_features[k] for k in dataset}
	return features</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4913a516398744-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913a516398744-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa4913a516398744-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913a516398744-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa4913a516398744-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913a516398744-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa4913a516398744-7">7</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4913a516398744-1"><span class="crayon-p"># load photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913a516398744-2"><span class="crayon-e">def </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4913a516398744-3"><span class="crayon-h"> </span><span class="crayon-p"># load all features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913a516398744-4"><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4913a516398744-5"><span class="crayon-h"> </span><span class="crayon-p"># filter features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913a516398744-6"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">k</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">k</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5a6591aa4913a516398744-7"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0006 seconds] -->
<p>We can pause here and test everything developed so far.</p>
<p>The complete code example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4913c499015072" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from pickle import load

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)

# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# create list
			if image_id not in descriptions:
				descriptions[image_id] = list()
			# wrap description in tokens
			desc = 'startseq ' + ' '.join(image_desc) + ' endseq'
			# store
			descriptions[image_id].append(desc)
	return descriptions

# load photo features
def load_photo_features(filename, dataset):
	# load all features
	all_features = load(open(filename, 'rb'))
	# filter features
	features = {k: all_features[k] for k in dataset}
	return features

# load training dataset (6K)
filename = 'Flickr8k_text/Flickr_8k.trainImages.txt'
train = load_set(filename)
print('Dataset: %d' % len(train))
# descriptions
train_descriptions = load_clean_descriptions('descriptions.txt', train)
print('Descriptions: train=%d' % len(train_descriptions))
# photo features
train_features = load_photo_features('features.pkl', train)
print('Photos: train=%d' % len(train_features))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-22">22</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-24">24</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-26">26</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-28">28</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-30">30</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-32">32</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-34">34</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-36">36</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-38">38</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-40">40</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-42">42</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-44">44</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-46">46</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-48">48</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-50">50</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-52">52</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-54">54</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-56">56</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-58">58</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-60">60</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-62">62</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4913c499015072-64">64</div><div class="crayon-num" data-line="crayon-5a6591aa4913c499015072-65">65</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4913c499015072-1"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-v">load</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-2"> </div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-3"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-4"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-5"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-6"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-7"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-8"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-9"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-10"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-11"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-12"> </div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-13"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-14"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-15"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-16"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-17"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-18"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-19"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-20"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-21"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-22"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-23"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-24"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-25"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-26"> </div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-27"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-28"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-29"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-30"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-31"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-32"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-33"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-34"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-35"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-36"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-37"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-38"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-39"><span class="crayon-h"> </span><span class="crayon-p"># create list</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-40"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-41"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-42"><span class="crayon-h"> </span><span class="crayon-p"># wrap description in tokens</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-43"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-44"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-45"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-46"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-47"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-48"><span class="crayon-p"># load photo features</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-49"><span class="crayon-e">def </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-50"><span class="crayon-h"> </span><span class="crayon-p"># load all features</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-51"><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-52"><span class="crayon-h"> </span><span class="crayon-p"># filter features</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-53"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">k</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">k</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-54"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-55"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-56"><span class="crayon-p"># load training dataset (6K)</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-57"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.trainImages.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-58"><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-59"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-60"><span class="crayon-p"># descriptions</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-61"><span class="crayon-v">train_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-62"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-63"><span class="crayon-p"># photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4913c499015072-64"><span class="crayon-v">train_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4913c499015072-65"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Photos: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0035 seconds] -->
<p>Running this example first loads the 6,000 photo identifiers in the test dataset. These features are then used to filter and load the cleaned description text and the pre-computed photo features.</p>
<p>We are nearly there.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49140865957332" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Dataset: 6,000
Descriptions: train=6,000
Photos: train=6,000</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49140865957332-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49140865957332-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49140865957332-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49140865957332-1">Dataset: 6,000</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49140865957332-2">Descriptions: train=6,000</div><div class="crayon-line" id="crayon-5a6591aa49140865957332-3">Photos: train=6,000</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>The description text will need to be encoded to numbers before it can be presented to the model as in input or compared to the model’s predictions.</p>
<p>The first step in encoding the data is to create a consistent mapping from words to unique integer values. Keras provides the <em>Tokenizer</em> class that can learn this mapping from the loaded description data.</p>
<p>Below defines the <em>to_lines()</em> to convert the dictionary of descriptions into a list of strings and the <em>create_tokenizer()</em> function that will fit a Tokenizer given the loaded photo description text.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49143839688644" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# convert a dictionary of clean descriptions to a list of descriptions
def to_lines(descriptions):
	all_desc = list()
	for key in descriptions.keys():
		[all_desc.append(d) for d in descriptions[key]]
	return all_desc

# fit a tokenizer given caption descriptions
def create_tokenizer(descriptions):
	lines = to_lines(descriptions)
	tokenizer = Tokenizer()
	tokenizer.fit_on_texts(lines)
	return tokenizer

# prepare tokenizer
tokenizer = create_tokenizer(train_descriptions)
vocab_size = len(tokenizer.word_index) + 1
print('Vocabulary Size: %d' % vocab_size)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49143839688644-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49143839688644-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49143839688644-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49143839688644-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49143839688644-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49143839688644-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49143839688644-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49143839688644-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49143839688644-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49143839688644-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49143839688644-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49143839688644-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa49143839688644-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49143839688644-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa49143839688644-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49143839688644-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa49143839688644-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49143839688644-18">18</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49143839688644-1"><span class="crayon-p"># convert a dictionary of clean descriptions to a list of descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49143839688644-2"><span class="crayon-e">def </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49143839688644-3"><span class="crayon-h"> </span><span class="crayon-v">all_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49143839688644-4"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">key </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49143839688644-5"><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">all_desc</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49143839688644-6"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">all_desc</span></div><div class="crayon-line" id="crayon-5a6591aa49143839688644-7"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49143839688644-8"><span class="crayon-p"># fit a tokenizer given caption descriptions</span></div><div class="crayon-line" id="crayon-5a6591aa49143839688644-9"><span class="crayon-e">def </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49143839688644-10"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49143839688644-11"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49143839688644-12"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49143839688644-13"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49143839688644-14"> </div><div class="crayon-line" id="crayon-5a6591aa49143839688644-15"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49143839688644-16"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49143839688644-17"><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49143839688644-18"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0011 seconds] -->
<p>We can now encode the text.</p>
<p>Each description will be split into words. The model will be provided one word and the photo and generate the next word. Then the first two words of the description will be provided to the model as input with the image to generate the next word. This is how the model will be trained.</p>
<p>For example, the input sequence “<em>little girl running in field</em>” would be split into 6 input-output pairs to train the model:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49146911153849" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
X1,		X2 (text sequence), 						y (word)
photo	startseq, 									little
photo	startseq, little,							girl
photo	startseq, little, girl, 					running
photo	startseq, little, girl, running, 			in
photo	startseq, little, girl, running, in, 		field
photo	startseq, little, girl, running, in, field, endseq</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49146911153849-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49146911153849-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49146911153849-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49146911153849-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49146911153849-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49146911153849-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49146911153849-7">7</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49146911153849-1">X1,		X2 (text sequence), 						y (word)</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49146911153849-2">photo	startseq, 									little</div><div class="crayon-line" id="crayon-5a6591aa49146911153849-3">photo	startseq, little,							girl</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49146911153849-4">photo	startseq, little, girl, 					running</div><div class="crayon-line" id="crayon-5a6591aa49146911153849-5">photo	startseq, little, girl, running, 			in</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49146911153849-6">photo	startseq, little, girl, running, in, 		field</div><div class="crayon-line" id="crayon-5a6591aa49146911153849-7">photo	startseq, little, girl, running, in, field, endseq</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Later, when the model is used to generate descriptions, the generated words will be concatenated and recursively provided as input to generate a caption for an image.</p>
<p>The function below named <em>create_sequences()</em>, given the tokenizer, a maximum sequence length, and the dictionary of all descriptions and photos, will transform the data into input-output pairs of data for training the model. There are two input arrays to the model: one for photo features and one for the encoded text. There is one output for the model which is the encoded next word in the text sequence.</p>
<p>The input text is encoded as integers, which will be fed to a word embedding layer. The photo features will be fed directly to another part of the model. The model will output a prediction, which will be a probability distribution over all words in the vocabulary.</p>
<p>The output data will therefore be a one-hot encoded version of each word, representing an idealized probability distribution with 0 values at all word positions except the actual word position, which has a value of 1.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49149512192041" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# create sequences of images, input sequences and output words for an image
def create_sequences(tokenizer, max_length, descriptions, photos):
	X1, X2, y = list(), list(), list()
	# walk through each image identifier
	for key, desc_list in descriptions.items():
		# walk through each description for the image
		for desc in desc_list:
			# encode the sequence
			seq = tokenizer.texts_to_sequences([desc])[0]
			# split one sequence into multiple X,y pairs
			for i in range(1, len(seq)):
				# split into input and output pair
				in_seq, out_seq = seq[:i], seq[i]
				# pad input sequence
				in_seq = pad_sequences([in_seq], maxlen=max_length)[0]
				# encode output sequence
				out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]
				# store
				X1.append(photos[key][0])
				X2.append(in_seq)
				y.append(out_seq)
	return array(X1), array(X2), array(y)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49149512192041-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49149512192041-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49149512192041-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49149512192041-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49149512192041-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49149512192041-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49149512192041-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49149512192041-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49149512192041-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49149512192041-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49149512192041-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49149512192041-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa49149512192041-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49149512192041-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa49149512192041-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49149512192041-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa49149512192041-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49149512192041-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa49149512192041-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49149512192041-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa49149512192041-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49149512192041-22">22</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49149512192041-1"><span class="crayon-p"># create sequences of images, input sequences and output words for an image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49149512192041-2"><span class="crayon-e">def </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49149512192041-3"><span class="crayon-h"> </span><span class="crayon-v">X1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49149512192041-4"><span class="crayon-h"> </span><span class="crayon-p"># walk through each image identifier</span></div><div class="crayon-line" id="crayon-5a6591aa49149512192041-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49149512192041-6"><span class="crayon-h"> </span><span class="crayon-p"># walk through each description for the image</span></div><div class="crayon-line" id="crayon-5a6591aa49149512192041-7"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49149512192041-8"><span class="crayon-h"> </span><span class="crayon-p"># encode the sequence</span></div><div class="crayon-line" id="crayon-5a6591aa49149512192041-9"><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">desc</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49149512192041-10"><span class="crayon-h"> </span><span class="crayon-p"># split one sequence into multiple X,y pairs</span></div><div class="crayon-line" id="crayon-5a6591aa49149512192041-11"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">seq</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49149512192041-12"><span class="crayon-h"> </span><span class="crayon-p"># split into input and output pair</span></div><div class="crayon-line" id="crayon-5a6591aa49149512192041-13"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49149512192041-14"><span class="crayon-h"> </span><span class="crayon-p"># pad input sequence</span></div><div class="crayon-line" id="crayon-5a6591aa49149512192041-15"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49149512192041-16"><span class="crayon-h"> </span><span class="crayon-p"># encode output sequence</span></div><div class="crayon-line" id="crayon-5a6591aa49149512192041-17"><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49149512192041-18"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5a6591aa49149512192041-19"><span class="crayon-h"> </span><span class="crayon-v">X1</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">photos</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49149512192041-20"><span class="crayon-h"> </span><span class="crayon-v">X2</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49149512192041-21"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">out_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49149512192041-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X1</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X2</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0020 seconds] -->
<p>We will need to calculate the maximum number of words in the longest description. A short helper function named <em>max_length()</em> is defined below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4914c195411122" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# calculate the length of the description with the most words
def max_length(descriptions):
	lines = to_lines(descriptions)
	return max(len(d.split()) for d in lines)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4914c195411122-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4914c195411122-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa4914c195411122-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4914c195411122-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4914c195411122-1"><span class="crayon-p"># calculate the length of the description with the most words</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4914c195411122-2"><span class="crayon-e">def </span><span class="crayon-e">max_length</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4914c195411122-3"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4914c195411122-4"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">max</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>We now have enough to load the data for the training and development datasets and transform the loaded data into input-output pairs for fitting a deep learning model.</p>
<h3>Defining the Model</h3>
<p>We will define a deep learning based on the “<em>merge-model</em>” described by Marc Tanti, et al. in their 2017 papers:</p>
<ul>
<li><a href="https://arxiv.org/abs/1703.09137">Where to put the Image in an Image Caption Generator</a>, 2017.</li>
<li><a href="https://arxiv.org/abs/1708.02043">What is the Role of Recurrent Neural Networks (RNNs) in an Image Caption Generator?</a>, 2017.</li>
</ul>
<p>The authors provide a nice schematic of the model, reproduced below.</p>
<div class="wp-caption aligncenter" id="attachment_4460" style="max-width: 1134px"><img alt="Schematic of the Merge Model For Image Captioning" class="size-full wp-image-4460" height="300" sizes="(max-width: 1124px) 100vw, 1124px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Schematic-of-the-Merge-Model-For-Image-Captioning.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Schematic-of-the-Merge-Model-For-Image-Captioning.png 1124w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Schematic-of-the-Merge-Model-For-Image-Captioning-300x80.png 300w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Schematic-of-the-Merge-Model-For-Image-Captioning-768x205.png 768w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Schematic-of-the-Merge-Model-For-Image-Captioning-1024x273.png 1024w" width="1124"/><p class="wp-caption-text">Schematic of the Merge Model For Image Captioning</p></div>
<p>We will describe the model in three parts:</p>
<ul>
<li><strong>Photo Feature Extractor</strong>. This is a 16-layer VGG model pre-trained on the ImageNet dataset. We have pre-processed the photos with the VGG model (without the output layer) and will use the extracted features predicted by this model as input.</li>
<li><strong>Sequence Processor</strong>. This is a word embedding layer for handling the text input, followed by a Long Short-Term Memory (LSTM) recurrent neural network layer.</li>
<li><strong>Decoder</strong> (for lack of a better name). Both the feature extractor and sequence processor output a fixed-length vector. These are merged together and processed by a Dense layer to make a final prediction.</li>
</ul>
<p>The Photo Feature Extractor model expects input photo features to be a vector of 4,096 elements. These are processed by a Dense layer to produce a 256 element representation of the photo.</p>
<p>The Sequence Processor model expects input sequences with a pre-defined length (34 words) which are fed into an Embedding layer that uses a mask to ignore padded values. This is followed by an LSTM layer with 256 memory units.</p>
<p>Both the input models produce a 256 element vector. Further, both input models use regularization in the form of 50% dropout. This is to reduce overfitting the training dataset, as this model configuration learns very fast.</p>
<p>The Decoder model merges the vectors from both input models using an addition operation. This is then fed to a Dense 256 neuron layer and then to a final output Dense layer that makes a softmax prediction over the entire output vocabulary for the next word in the sequence.</p>
<p>The function below named <em>define_model()</em> defines and returns the model ready to be fit.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4914f755914843" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor model
	inputs1 = Input(shape=(4096,))
	fe1 = Dropout(0.5)(inputs1)
	fe2 = Dense(256, activation='relu')(fe1)
	# sequence model
	inputs2 = Input(shape=(max_length,))
	se1 = Embedding(vocab_size, 256, mask_zero=True)(inputs2)
	se2 = Dropout(0.5)(se1)
	se3 = LSTM(256)(se2)
	# decoder model
	decoder1 = add([fe2, se3])
	decoder2 = Dense(256, activation='relu')(decoder1)
	outputs = Dense(vocab_size, activation='softmax')(decoder2)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam')
	# summarize model
	print(model.summary())
	plot_model(model, to_file='model.png', show_shapes=True)
	return model</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4914f755914843-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4914f755914843-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa4914f755914843-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4914f755914843-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa4914f755914843-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4914f755914843-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa4914f755914843-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4914f755914843-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa4914f755914843-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4914f755914843-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa4914f755914843-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4914f755914843-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa4914f755914843-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4914f755914843-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa4914f755914843-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4914f755914843-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa4914f755914843-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4914f755914843-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa4914f755914843-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4914f755914843-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa4914f755914843-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4914f755914843-22">22</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4914f755914843-1"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4914f755914843-2"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4914f755914843-3"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4914f755914843-4"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">4096</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4914f755914843-5"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dropout</span><span class="crayon-sy">(</span><span class="crayon-cn">0.5</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4914f755914843-6"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4914f755914843-7"><span class="crayon-h"> </span><span class="crayon-p"># sequence model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4914f755914843-8"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4914f755914843-9"><span class="crayon-h"> </span><span class="crayon-v">se1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4914f755914843-10"><span class="crayon-h"> </span><span class="crayon-v">se2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dropout</span><span class="crayon-sy">(</span><span class="crayon-cn">0.5</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">se1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4914f755914843-11"><span class="crayon-h"> </span><span class="crayon-v">se3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">se2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4914f755914843-12"><span class="crayon-h"> </span><span class="crayon-p"># decoder model</span></div><div class="crayon-line" id="crayon-5a6591aa4914f755914843-13"><span class="crayon-h"> </span><span class="crayon-v">decoder1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">se3</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4914f755914843-14"><span class="crayon-h"> </span><span class="crayon-v">decoder2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">decoder1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4914f755914843-15"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">decoder2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4914f755914843-16"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line" id="crayon-5a6591aa4914f755914843-17"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4914f755914843-18"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4914f755914843-19"><span class="crayon-h"> </span><span class="crayon-p"># summarize model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4914f755914843-20"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4914f755914843-21"><span class="crayon-h"> </span><span class="crayon-e">plot_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">to_file</span><span class="crayon-o">=</span><span class="crayon-s">'model.png'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">show_shapes</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4914f755914843-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0021 seconds] -->
<p>To get a sense for the structure of the model, specifically the shapes of the layers, see the summary listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49153943696823" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
____________________________________________________________________________________________________
Layer (type)                     Output Shape          Param #     Connected to
====================================================================================================
input_2 (InputLayer)             (None, 34)            0
____________________________________________________________________________________________________
input_1 (InputLayer)             (None, 4096)          0
____________________________________________________________________________________________________
embedding_1 (Embedding)          (None, 34, 256)       1940224     input_2[0][0]
____________________________________________________________________________________________________
dropout_1 (Dropout)              (None, 4096)          0           input_1[0][0]
____________________________________________________________________________________________________
dropout_2 (Dropout)              (None, 34, 256)       0           embedding_1[0][0]
____________________________________________________________________________________________________
dense_1 (Dense)                  (None, 256)           1048832     dropout_1[0][0]
____________________________________________________________________________________________________
lstm_1 (LSTM)                    (None, 256)           525312      dropout_2[0][0]
____________________________________________________________________________________________________
add_1 (Add)                      (None, 256)           0           dense_1[0][0]
                                                                   lstm_1[0][0]
____________________________________________________________________________________________________
dense_2 (Dense)                  (None, 256)           65792       add_1[0][0]
____________________________________________________________________________________________________
dense_3 (Dense)                  (None, 7579)          1947803     dense_2[0][0]
====================================================================================================
Total params: 5,527,963
Trainable params: 5,527,963
Non-trainable params: 0
____________________________________________________________________________________________________</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49153943696823-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49153943696823-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49153943696823-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49153943696823-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49153943696823-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49153943696823-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49153943696823-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49153943696823-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49153943696823-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49153943696823-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49153943696823-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49153943696823-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa49153943696823-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49153943696823-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa49153943696823-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49153943696823-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa49153943696823-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49153943696823-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa49153943696823-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49153943696823-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa49153943696823-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49153943696823-22">22</div><div class="crayon-num" data-line="crayon-5a6591aa49153943696823-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49153943696823-24">24</div><div class="crayon-num" data-line="crayon-5a6591aa49153943696823-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49153943696823-26">26</div><div class="crayon-num" data-line="crayon-5a6591aa49153943696823-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49153943696823-28">28</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49153943696823-1">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49153943696823-2">Layer (type)                     Output Shape          Param #     Connected to</div><div class="crayon-line" id="crayon-5a6591aa49153943696823-3">====================================================================================================</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49153943696823-4">input_2 (InputLayer)             (None, 34)            0</div><div class="crayon-line" id="crayon-5a6591aa49153943696823-5">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49153943696823-6">input_1 (InputLayer)             (None, 4096)          0</div><div class="crayon-line" id="crayon-5a6591aa49153943696823-7">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49153943696823-8">embedding_1 (Embedding)          (None, 34, 256)       1940224     input_2[0][0]</div><div class="crayon-line" id="crayon-5a6591aa49153943696823-9">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49153943696823-10">dropout_1 (Dropout)              (None, 4096)          0           input_1[0][0]</div><div class="crayon-line" id="crayon-5a6591aa49153943696823-11">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49153943696823-12">dropout_2 (Dropout)              (None, 34, 256)       0           embedding_1[0][0]</div><div class="crayon-line" id="crayon-5a6591aa49153943696823-13">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49153943696823-14">dense_1 (Dense)                  (None, 256)           1048832     dropout_1[0][0]</div><div class="crayon-line" id="crayon-5a6591aa49153943696823-15">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49153943696823-16">lstm_1 (LSTM)                    (None, 256)           525312      dropout_2[0][0]</div><div class="crayon-line" id="crayon-5a6591aa49153943696823-17">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49153943696823-18">add_1 (Add)                      (None, 256)           0           dense_1[0][0]</div><div class="crayon-line" id="crayon-5a6591aa49153943696823-19">                                                                   lstm_1[0][0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49153943696823-20">____________________________________________________________________________________________________</div><div class="crayon-line" id="crayon-5a6591aa49153943696823-21">dense_2 (Dense)                  (None, 256)           65792       add_1[0][0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49153943696823-22">____________________________________________________________________________________________________</div><div class="crayon-line" id="crayon-5a6591aa49153943696823-23">dense_3 (Dense)                  (None, 7579)          1947803     dense_2[0][0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49153943696823-24">====================================================================================================</div><div class="crayon-line" id="crayon-5a6591aa49153943696823-25">Total params: 5,527,963</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49153943696823-26">Trainable params: 5,527,963</div><div class="crayon-line" id="crayon-5a6591aa49153943696823-27">Non-trainable params: 0</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49153943696823-28">____________________________________________________________________________________________________</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>We also create a plot to visualize the structure of the network that better helps understand the two streams of input.</p>
<div class="wp-caption aligncenter" id="attachment_4461" style="max-width: 847px"><img alt="Plot of the Caption Generation Deep Learning Model" class="size-full wp-image-4461" height="737" sizes="(max-width: 837px) 100vw, 837px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Plot-of-the-Caption-Generation-Deep-Learning-Model.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Plot-of-the-Caption-Generation-Deep-Learning-Model.png 837w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Plot-of-the-Caption-Generation-Deep-Learning-Model-300x264.png 300w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Plot-of-the-Caption-Generation-Deep-Learning-Model-768x676.png 768w" width="837"/><p class="wp-caption-text">Plot of the Caption Generation Deep Learning Model</p></div>
<h3>Fitting the Model</h3>
<p>Now that we know how to define the model, we can fit it on the training dataset.</p>
<p>The model learns fast and quickly overfits the training dataset. For this reason, we will monitor the skill of the trained model on the holdout development dataset. When the skill of the model on the development dataset improves at the end of an epoch, we will save the whole model to file.</p>
<p>At the end of the run, we can then use the saved model with the best skill on the training dataset as our final model.</p>
<p>We can do this by defining a <em>ModelCheckpoint</em> in Keras and specifying it to monitor the minimum loss on the validation dataset and save the model to a file that has both the training and validation loss in the filename.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49157720357423" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define checkpoint callback
filepath = 'model-ep{epoch:03d}-loss{loss:.3f}-val_loss{val_loss:.3f}.h5'
checkpoint = ModelCheckpoint(filepath, monitor='val_loss', verbose=1, save_best_only=True, mode='min')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49157720357423-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49157720357423-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49157720357423-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49157720357423-1"><span class="crayon-p"># define checkpoint callback</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49157720357423-2"><span class="crayon-v">filepath</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'model-ep{epoch:03d}-loss{loss:.3f}-val_loss{val_loss:.3f}.h5'</span></div><div class="crayon-line" id="crayon-5a6591aa49157720357423-3"><span class="crayon-v">checkpoint</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">ModelCheckpoint</span><span class="crayon-sy">(</span><span class="crayon-v">filepath</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">monitor</span><span class="crayon-o">=</span><span class="crayon-s">'val_loss'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">save_best_only</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mode</span><span class="crayon-o">=</span><span class="crayon-s">'min'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>We can then specify the checkpoint in the call to <em>fit()</em> via the <em>callbacks</em> argument. We must also specify the development dataset in <em>fit()</em> via the <em>validation_data</em> argument.</p>
<p>We will only fit the model for 20 epochs, but given the amount of training data, each epoch may take 30 minutes on modern hardware.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4915a136507070" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# fit model
model.fit([X1train, X2train], ytrain, epochs=20, verbose=2, callbacks=[checkpoint], validation_data=([X1test, X2test], ytest))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4915a136507070-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915a136507070-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4915a136507070-1"><span class="crayon-p"># fit model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915a136507070-2"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">X1train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2train</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ytrain</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">20</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">callbacks</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">checkpoint</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">validation_data</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">X1test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2test</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ytest</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p></p>
<h3>Complete Example</h3>
<p>The complete example for fitting the model on the training data is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4915d265653474" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from numpy import array
from pickle import load
from keras.preprocessing.text import Tokenizer
from keras.preprocessing.sequence import pad_sequences
from keras.utils import to_categorical
from keras.utils import plot_model
from keras.models import Model
from keras.layers import Input
from keras.layers import Dense
from keras.layers import LSTM
from keras.layers import Embedding
from keras.layers import Dropout
from keras.layers.merge import add
from keras.callbacks import ModelCheckpoint

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)

# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# create list
			if image_id not in descriptions:
				descriptions[image_id] = list()
			# wrap description in tokens
			desc = 'startseq ' + ' '.join(image_desc) + ' endseq'
			# store
			descriptions[image_id].append(desc)
	return descriptions

# load photo features
def load_photo_features(filename, dataset):
	# load all features
	all_features = load(open(filename, 'rb'))
	# filter features
	features = {k: all_features[k] for k in dataset}
	return features

# covert a dictionary of clean descriptions to a list of descriptions
def to_lines(descriptions):
	all_desc = list()
	for key in descriptions.keys():
		[all_desc.append(d) for d in descriptions[key]]
	return all_desc

# fit a tokenizer given caption descriptions
def create_tokenizer(descriptions):
	lines = to_lines(descriptions)
	tokenizer = Tokenizer()
	tokenizer.fit_on_texts(lines)
	return tokenizer

# calculate the length of the description with the most words
def max_length(descriptions):
	lines = to_lines(descriptions)
	return max(len(d.split()) for d in lines)

# create sequences of images, input sequences and output words for an image
def create_sequences(tokenizer, max_length, descriptions, photos):
	X1, X2, y = list(), list(), list()
	# walk through each image identifier
	for key, desc_list in descriptions.items():
		# walk through each description for the image
		for desc in desc_list:
			# encode the sequence
			seq = tokenizer.texts_to_sequences([desc])[0]
			# split one sequence into multiple X,y pairs
			for i in range(1, len(seq)):
				# split into input and output pair
				in_seq, out_seq = seq[:i], seq[i]
				# pad input sequence
				in_seq = pad_sequences([in_seq], maxlen=max_length)[0]
				# encode output sequence
				out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]
				# store
				X1.append(photos[key][0])
				X2.append(in_seq)
				y.append(out_seq)
	return array(X1), array(X2), array(y)

# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor model
	inputs1 = Input(shape=(4096,))
	fe1 = Dropout(0.5)(inputs1)
	fe2 = Dense(256, activation='relu')(fe1)
	# sequence model
	inputs2 = Input(shape=(max_length,))
	se1 = Embedding(vocab_size, 256, mask_zero=True)(inputs2)
	se2 = Dropout(0.5)(se1)
	se3 = LSTM(256)(se2)
	# decoder model
	decoder1 = add([fe2, se3])
	decoder2 = Dense(256, activation='relu')(decoder1)
	outputs = Dense(vocab_size, activation='softmax')(decoder2)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam')
	# summarize model
	print(model.summary())
	plot_model(model, to_file='model.png', show_shapes=True)
	return model

# train dataset

# load training dataset (6K)
filename = 'Flickr8k_text/Flickr_8k.trainImages.txt'
train = load_set(filename)
print('Dataset: %d' % len(train))
# descriptions
train_descriptions = load_clean_descriptions('descriptions.txt', train)
print('Descriptions: train=%d' % len(train_descriptions))
# photo features
train_features = load_photo_features('features.pkl', train)
print('Photos: train=%d' % len(train_features))
# prepare tokenizer
tokenizer = create_tokenizer(train_descriptions)
vocab_size = len(tokenizer.word_index) + 1
print('Vocabulary Size: %d' % vocab_size)
# determine the maximum sequence length
max_length = max_length(train_descriptions)
print('Description Length: %d' % max_length)
# prepare sequences
X1train, X2train, ytrain = create_sequences(tokenizer, max_length, train_descriptions, train_features)

# dev dataset

# load test set
filename = 'Flickr8k_text/Flickr_8k.devImages.txt'
test = load_set(filename)
print('Dataset: %d' % len(test))
# descriptions
test_descriptions = load_clean_descriptions('descriptions.txt', test)
print('Descriptions: test=%d' % len(test_descriptions))
# photo features
test_features = load_photo_features('features.pkl', test)
print('Photos: test=%d' % len(test_features))
# prepare sequences
X1test, X2test, ytest = create_sequences(tokenizer, max_length, test_descriptions, test_features)

# fit model

# define the model
model = define_model(vocab_size, max_length)
# define checkpoint callback
filepath = 'model-ep{epoch:03d}-loss{loss:.3f}-val_loss{val_loss:.3f}.h5'
checkpoint = ModelCheckpoint(filepath, monitor='val_loss', verbose=1, save_best_only=True, mode='min')
# fit model
model.fit([X1train, X2train], ytrain, epochs=20, verbose=2, callbacks=[checkpoint], validation_data=([X1test, X2test], ytest))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-22">22</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-24">24</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-26">26</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-28">28</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-30">30</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-32">32</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-34">34</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-36">36</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-38">38</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-40">40</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-42">42</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-44">44</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-46">46</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-48">48</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-50">50</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-52">52</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-54">54</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-56">56</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-58">58</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-60">60</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-62">62</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-64">64</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-66">66</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-68">68</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-70">70</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-72">72</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-74">74</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-76">76</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-78">78</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-80">80</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-82">82</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-84">84</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-86">86</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-88">88</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-90">90</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-92">92</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-94">94</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-96">96</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-98">98</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-100">100</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-102">102</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-104">104</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-106">106</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-108">108</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-110">110</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-112">112</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-114">114</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-116">116</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-118">118</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-120">120</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-122">122</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-124">124</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-126">126</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-128">128</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-130">130</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-131">131</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-132">132</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-133">133</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-134">134</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-135">135</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-136">136</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-137">137</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-138">138</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-139">139</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-140">140</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-141">141</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-142">142</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-143">143</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-144">144</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-145">145</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-146">146</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-147">147</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-148">148</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-149">149</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-150">150</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-151">151</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-152">152</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-153">153</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-154">154</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-155">155</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-156">156</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-157">157</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-158">158</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-159">159</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-160">160</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-161">161</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-162">162</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-163">163</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-164">164</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-165">165</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-166">166</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-167">167</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-168">168</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-169">169</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-170">170</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-171">171</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-172">172</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-173">173</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-174">174</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-175">175</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-176">176</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-177">177</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4915d265653474-178">178</div><div class="crayon-num" data-line="crayon-5a6591aa4915d265653474-179">179</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4915d265653474-1"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-2"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-e">load</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">text </span><span class="crayon-e">import </span><span class="crayon-e">Tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">sequence </span><span class="crayon-e">import </span><span class="crayon-e">pad_sequences</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-e">import </span><span class="crayon-e">to_categorical</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-6"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-e">import </span><span class="crayon-e">plot_model</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-7"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Input</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dense</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-10"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">LSTM</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-11"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Embedding</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-12"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dropout</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-13"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">merge </span><span class="crayon-e">import </span><span class="crayon-e">add</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-14"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">callbacks </span><span class="crayon-e">import </span><span class="crayon-v">ModelCheckpoint</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-15"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-16"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-17"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-18"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-19"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-20"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-21"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-22"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-23"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-24"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-25"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-26"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-27"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-28"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-29"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-30"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-31"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-32"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-33"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-34"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-35"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-36"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-37"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-38"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-39"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-40"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-41"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-42"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-43"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-44"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-45"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-46"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-47"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-48"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-49"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-50"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-51"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-52"><span class="crayon-h"> </span><span class="crayon-p"># create list</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-53"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-54"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-55"><span class="crayon-h"> </span><span class="crayon-p"># wrap description in tokens</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-56"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-57"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-58"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-59"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-60"> </div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-61"><span class="crayon-p"># load photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-62"><span class="crayon-e">def </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-63"><span class="crayon-h"> </span><span class="crayon-p"># load all features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-64"><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-65"><span class="crayon-h"> </span><span class="crayon-p"># filter features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-66"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">k</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">k</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-67"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-68"> </div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-69"><span class="crayon-p"># covert a dictionary of clean descriptions to a list of descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-70"><span class="crayon-e">def </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-71"><span class="crayon-h"> </span><span class="crayon-v">all_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-72"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">key </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-73"><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">all_desc</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-74"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">all_desc</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-75"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-76"><span class="crayon-p"># fit a tokenizer given caption descriptions</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-77"><span class="crayon-e">def </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-78"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-79"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-80"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-81"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-82"> </div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-83"><span class="crayon-p"># calculate the length of the description with the most words</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-84"><span class="crayon-e">def </span><span class="crayon-e">max_length</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-85"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-86"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">max</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-87"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-88"><span class="crayon-p"># create sequences of images, input sequences and output words for an image</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-89"><span class="crayon-e">def </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-90"><span class="crayon-h"> </span><span class="crayon-v">X1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-91"><span class="crayon-h"> </span><span class="crayon-p"># walk through each image identifier</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-92"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-93"><span class="crayon-h"> </span><span class="crayon-p"># walk through each description for the image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-94"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-95"><span class="crayon-h"> </span><span class="crayon-p"># encode the sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-96"><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">desc</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-97"><span class="crayon-h"> </span><span class="crayon-p"># split one sequence into multiple X,y pairs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-98"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">seq</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-99"><span class="crayon-h"> </span><span class="crayon-p"># split into input and output pair</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-100"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-101"><span class="crayon-h"> </span><span class="crayon-p"># pad input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-102"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-103"><span class="crayon-h"> </span><span class="crayon-p"># encode output sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-104"><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-105"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-106"><span class="crayon-h"> </span><span class="crayon-v">X1</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">photos</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-107"><span class="crayon-h"> </span><span class="crayon-v">X2</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-108"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">out_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-109"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X1</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">X2</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-110"> </div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-111"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-112"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-113"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-114"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">4096</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-115"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dropout</span><span class="crayon-sy">(</span><span class="crayon-cn">0.5</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-116"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-117"><span class="crayon-h"> </span><span class="crayon-p"># sequence model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-118"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-119"><span class="crayon-h"> </span><span class="crayon-v">se1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-120"><span class="crayon-h"> </span><span class="crayon-v">se2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dropout</span><span class="crayon-sy">(</span><span class="crayon-cn">0.5</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">se1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-121"><span class="crayon-h"> </span><span class="crayon-v">se3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">se2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-122"><span class="crayon-h"> </span><span class="crayon-p"># decoder model</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-123"><span class="crayon-h"> </span><span class="crayon-v">decoder1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">se3</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-124"><span class="crayon-h"> </span><span class="crayon-v">decoder2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">decoder1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-125"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">decoder2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-126"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-127"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-128"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-129"><span class="crayon-h"> </span><span class="crayon-p"># summarize model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-130"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-131"><span class="crayon-h"> </span><span class="crayon-e">plot_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">to_file</span><span class="crayon-o">=</span><span class="crayon-s">'model.png'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">show_shapes</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-132"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-133"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-134"><span class="crayon-p"># train dataset</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-135"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-136"><span class="crayon-p"># load training dataset (6K)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-137"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.trainImages.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-138"><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-139"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-140"><span class="crayon-p"># descriptions</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-141"><span class="crayon-v">train_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-142"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-143"><span class="crayon-p"># photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-144"><span class="crayon-v">train_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-145"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Photos: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-146"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-147"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-148"><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-149"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-150"><span class="crayon-p"># determine the maximum sequence length</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-151"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">max_length</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-152"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Description Length: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-153"><span class="crayon-p"># prepare sequences</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-154"><span class="crayon-v">X1train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ytrain</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_features</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-155"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-156"><span class="crayon-p"># dev dataset</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-157"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-158"><span class="crayon-p"># load test set</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-159"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.devImages.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-160"><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-161"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-162"><span class="crayon-p"># descriptions</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-163"><span class="crayon-v">test_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-164"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: test=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-165"><span class="crayon-p"># photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-166"><span class="crayon-v">test_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-167"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Photos: test=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-168"><span class="crayon-p"># prepare sequences</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-169"><span class="crayon-v">X1test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ytest</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_features</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-170"> </div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-171"><span class="crayon-p"># fit model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-172"> </div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-173"><span class="crayon-p"># define the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-174"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-175"><span class="crayon-p"># define checkpoint callback</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-176"><span class="crayon-v">filepath</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'model-ep{epoch:03d}-loss{loss:.3f}-val_loss{val_loss:.3f}.h5'</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-177"><span class="crayon-v">checkpoint</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">ModelCheckpoint</span><span class="crayon-sy">(</span><span class="crayon-v">filepath</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">monitor</span><span class="crayon-o">=</span><span class="crayon-s">'val_loss'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">save_best_only</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mode</span><span class="crayon-o">=</span><span class="crayon-s">'min'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4915d265653474-178"><span class="crayon-p"># fit model</span></div><div class="crayon-line" id="crayon-5a6591aa4915d265653474-179"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">X1train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2train</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ytrain</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">20</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">callbacks</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">checkpoint</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">validation_data</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">X1test</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X2test</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ytest</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0111 seconds] -->
<p>Running the example first prints a summary of the loaded training and development datasets.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49163163039216" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Dataset: 6,000
Descriptions: train=6,000
Photos: train=6,000
Vocabulary Size: 7,579
Description Length: 34
Dataset: 1,000
Descriptions: test=1,000
Photos: test=1,000</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49163163039216-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49163163039216-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49163163039216-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49163163039216-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49163163039216-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49163163039216-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49163163039216-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49163163039216-8">8</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49163163039216-1">Dataset: 6,000</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49163163039216-2">Descriptions: train=6,000</div><div class="crayon-line" id="crayon-5a6591aa49163163039216-3">Photos: train=6,000</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49163163039216-4">Vocabulary Size: 7,579</div><div class="crayon-line" id="crayon-5a6591aa49163163039216-5">Description Length: 34</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49163163039216-6">Dataset: 1,000</div><div class="crayon-line" id="crayon-5a6591aa49163163039216-7">Descriptions: test=1,000</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49163163039216-8">Photos: test=1,000</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>After the summary of the model, we can get an idea of the total number of training and validation (development) input-output pairs.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49166992828725" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Train on 306,404 samples, validate on 50,903 samples</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49166992828725-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49166992828725-1">Train on 306,404 samples, validate on 50,903 samples</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0000 seconds] -->
<p>The model then runs, saving the best model to .h5 files along the way.</p>
<p>On my run, the best validation results were saved to the file:</p>
<ul>
<li><em>model-ep002-loss3.245-val_loss3.612.h5</em></li>
</ul>
<p>This model was saved at the end of epoch 2 with a loss of 3.245 on the training dataset and a loss of 3.612 on the development dataset</p>
<p>Your specific results will vary.</p>
<p>Let me know what you get in the comments below.</p>
<p>If you ran the example on AWS, copy the model file back to your current working directory. If you need help with commands on AWS, see the post:</p>
<ul>
<li><a href="https://machinelearningmastery.com/command-line-recipes-deep-learning-amazon-web-services/">10 Command Line Recipes for Deep Learning on Amazon Web Services</a></li>
</ul>
<h2>Evaluate Model</h2>
<p>Once the model is fit, we can evaluate the skill of its predictions on the holdout test dataset.</p>
<p>We will evaluate a model by generating descriptions for all photos in the test dataset and evaluating those predictions with a standard cost function.</p>
<p>First, we need to be able to generate a description for a photo using a trained model.</p>
<p>This involves passing in the start description token ‘<em>startseq</em>‘, generating one word, then calling the model recursively with generated words as input until the end of sequence token is reached ‘<em>endseq</em>‘ or the maximum description length is reached.</p>
<p>The function below named <em>generate_desc()</em> implements this behavior and generates a textual description given a trained model, and a given prepared photo as input. It calls the function <em>word_for_id()</em> in order to map an integer prediction back to a word.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49169602369653" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# map an integer to a word
def word_for_id(integer, tokenizer):
	for word, index in tokenizer.word_index.items():
		if index == integer:
			return word
	return None

# generate a description for an image
def generate_desc(model, tokenizer, photo, max_length):
	# seed the generation process
	in_text = 'startseq'
	# iterate over the whole length of the sequence
	for i in range(max_length):
		# integer encode input sequence
		sequence = tokenizer.texts_to_sequences([in_text])[0]
		# pad input
		sequence = pad_sequences([sequence], maxlen=max_length)
		# predict next word
		yhat = model.predict([photo,sequence], verbose=0)
		# convert probability to integer
		yhat = argmax(yhat)
		# map integer to word
		word = word_for_id(yhat, tokenizer)
		# stop if we cannot map the word
		if word is None:
			break
		# append as input for generating the next word
		in_text += ' ' + word
		# stop if we predict the end of the sequence
		if word == 'endseq':
			break
	return in_text</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-22">22</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-24">24</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-26">26</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-28">28</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-30">30</div><div class="crayon-num" data-line="crayon-5a6591aa49169602369653-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49169602369653-32">32</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49169602369653-1"><span class="crayon-p"># map an integer to a word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-2"><span class="crayon-e">def </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-t">integer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-3"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">index </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-4"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">integer</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-5"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-6"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">None</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-7"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-8"><span class="crayon-p"># generate a description for an image</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-9"><span class="crayon-e">def </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-10"><span class="crayon-h"> </span><span class="crayon-p"># seed the generation process</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-11"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-12"><span class="crayon-h"> </span><span class="crayon-p"># iterate over the whole length of the sequence</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-13"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-14"><span class="crayon-h"> </span><span class="crayon-p"># integer encode input sequence</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-15"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_text</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-16"><span class="crayon-h"> </span><span class="crayon-p"># pad input</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-17"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-18"><span class="crayon-h"> </span><span class="crayon-p"># predict next word</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-19"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-20"><span class="crayon-h"> </span><span class="crayon-p"># convert probability to integer</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-21"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">argmax</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-22"><span class="crayon-h"> </span><span class="crayon-p"># map integer to word</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-23"><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-24"><span class="crayon-h"> </span><span class="crayon-p"># stop if we cannot map the word</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-25"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-26"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-27"><span class="crayon-h"> </span><span class="crayon-p"># append as input for generating the next word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-28"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-29"><span class="crayon-h"> </span><span class="crayon-p"># stop if we predict the end of the sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-30"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">'endseq'</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49169602369653-31"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49169602369653-32"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">in_text</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0019 seconds] -->
<p>We will generate predictions for all photos in the test dataset and in the train dataset.</p>
<p>The function below named <em>evaluate_model()</em> will evaluate a trained model against a given dataset of photo descriptions and photo features. The actual and predicted descriptions are collected and evaluated collectively using the corpus BLEU score that summarizes how close the generated text is to the expected text.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4916d904554782" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# evaluate the skill of the model
def evaluate_model(model, descriptions, photos, tokenizer, max_length):
	actual, predicted = list(), list()
	# step over the whole set
	for key, desc_list in descriptions.items():
		# generate description
		yhat = generate_desc(model, tokenizer, photos[key], max_length)
		# store actual and predicted
		references = [d.split() for d in desc_list]
		actual.append(references)
		predicted.append(yhat.split())
	# calculate BLEU score
	print('BLEU-1: %f' % corpus_bleu(actual, predicted, weights=(1.0, 0, 0, 0)))
	print('BLEU-2: %f' % corpus_bleu(actual, predicted, weights=(0.5, 0.5, 0, 0)))
	print('BLEU-3: %f' % corpus_bleu(actual, predicted, weights=(0.3, 0.3, 0.3, 0)))
	print('BLEU-4: %f' % corpus_bleu(actual, predicted, weights=(0.25, 0.25, 0.25, 0.25)))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4916d904554782-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4916d904554782-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa4916d904554782-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4916d904554782-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa4916d904554782-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4916d904554782-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa4916d904554782-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4916d904554782-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa4916d904554782-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4916d904554782-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa4916d904554782-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4916d904554782-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa4916d904554782-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4916d904554782-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa4916d904554782-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4916d904554782-16">16</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4916d904554782-1"><span class="crayon-p"># evaluate the skill of the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4916d904554782-2"><span class="crayon-e">def </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa4916d904554782-3"><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4916d904554782-4"><span class="crayon-h"> </span><span class="crayon-p"># step over the whole set</span></div><div class="crayon-line" id="crayon-5a6591aa4916d904554782-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4916d904554782-6"><span class="crayon-h"> </span><span class="crayon-p"># generate description</span></div><div class="crayon-line" id="crayon-5a6591aa4916d904554782-7"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4916d904554782-8"><span class="crayon-h"> </span><span class="crayon-p"># store actual and predicted</span></div><div class="crayon-line" id="crayon-5a6591aa4916d904554782-9"><span class="crayon-h"> </span><span class="crayon-v">references</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4916d904554782-10"><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">references</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4916d904554782-11"><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4916d904554782-12"><span class="crayon-h"> </span><span class="crayon-p"># calculate BLEU score</span></div><div class="crayon-line" id="crayon-5a6591aa4916d904554782-13"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-1: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">1.0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4916d904554782-14"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-2: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">0.5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4916d904554782-15"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-3: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">0.3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4916d904554782-16"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-4: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">0.25</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.25</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.25</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.25</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0021 seconds] -->
<p>BLEU scores are used in text translation for evaluating translated text against one or more reference translations.</p>
<p>Here, we compare each generated description against all of the reference descriptions for the photograph. We then calculate BLEU scores for 1, 2, 3 and 4 cumulative n-grams.</p>
<p>You can learn more about the BLEU score here:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/BLEU">BLEU (bilingual evaluation understudy) on Wikipedia</a></li>
</ul>
<p>The <a href="http://www.nltk.org/api/nltk.translate.html">NLTK Python library implements the BLEU score</a> calculation in the <em>corpus_bleu()</em> function. A higher score close to 1.0 is better, a score closer to zero is worse.</p>
<p>We can put all of this together with the functions from the previous section for loading the data. We first need to load the training dataset in order to prepare a Tokenizer so that we can encode generated words as input sequences for the model. It is critical that we encode the generated words using exactly the same encoding scheme as was used when training the model.</p>
<p>We then use these functions for loading the test dataset.</p>
<p>The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49170313525947" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from numpy import argmax
from pickle import load
from keras.preprocessing.text import Tokenizer
from keras.preprocessing.sequence import pad_sequences
from keras.models import load_model
from nltk.translate.bleu_score import corpus_bleu

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)

# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# create list
			if image_id not in descriptions:
				descriptions[image_id] = list()
			# wrap description in tokens
			desc = 'startseq ' + ' '.join(image_desc) + ' endseq'
			# store
			descriptions[image_id].append(desc)
	return descriptions

# load photo features
def load_photo_features(filename, dataset):
	# load all features
	all_features = load(open(filename, 'rb'))
	# filter features
	features = {k: all_features[k] for k in dataset}
	return features

# covert a dictionary of clean descriptions to a list of descriptions
def to_lines(descriptions):
	all_desc = list()
	for key in descriptions.keys():
		[all_desc.append(d) for d in descriptions[key]]
	return all_desc

# fit a tokenizer given caption descriptions
def create_tokenizer(descriptions):
	lines = to_lines(descriptions)
	tokenizer = Tokenizer()
	tokenizer.fit_on_texts(lines)
	return tokenizer

# calculate the length of the description with the most words
def max_length(descriptions):
	lines = to_lines(descriptions)
	return max(len(d.split()) for d in lines)

# map an integer to a word
def word_for_id(integer, tokenizer):
	for word, index in tokenizer.word_index.items():
		if index == integer:
			return word
	return None

# generate a description for an image
def generate_desc(model, tokenizer, photo, max_length):
	# seed the generation process
	in_text = 'startseq'
	# iterate over the whole length of the sequence
	for i in range(max_length):
		# integer encode input sequence
		sequence = tokenizer.texts_to_sequences([in_text])[0]
		# pad input
		sequence = pad_sequences([sequence], maxlen=max_length)
		# predict next word
		yhat = model.predict([photo,sequence], verbose=0)
		# convert probability to integer
		yhat = argmax(yhat)
		# map integer to word
		word = word_for_id(yhat, tokenizer)
		# stop if we cannot map the word
		if word is None:
			break
		# append as input for generating the next word
		in_text += ' ' + word
		# stop if we predict the end of the sequence
		if word == 'endseq':
			break
	return in_text

# evaluate the skill of the model
def evaluate_model(model, descriptions, photos, tokenizer, max_length):
	actual, predicted = list(), list()
	# step over the whole set
	for key, desc_list in descriptions.items():
		# generate description
		yhat = generate_desc(model, tokenizer, photos[key], max_length)
		# store actual and predicted
		references = [d.split() for d in desc_list]
		actual.append(references)
		predicted.append(yhat.split())
	# calculate BLEU score
	print('BLEU-1: %f' % corpus_bleu(actual, predicted, weights=(1.0, 0, 0, 0)))
	print('BLEU-2: %f' % corpus_bleu(actual, predicted, weights=(0.5, 0.5, 0, 0)))
	print('BLEU-3: %f' % corpus_bleu(actual, predicted, weights=(0.3, 0.3, 0.3, 0)))
	print('BLEU-4: %f' % corpus_bleu(actual, predicted, weights=(0.25, 0.25, 0.25, 0.25)))

# prepare tokenizer on train set

# load training dataset (6K)
filename = 'Flickr8k_text/Flickr_8k.trainImages.txt'
train = load_set(filename)
print('Dataset: %d' % len(train))
# descriptions
train_descriptions = load_clean_descriptions('descriptions.txt', train)
print('Descriptions: train=%d' % len(train_descriptions))
# prepare tokenizer
tokenizer = create_tokenizer(train_descriptions)
vocab_size = len(tokenizer.word_index) + 1
print('Vocabulary Size: %d' % vocab_size)
# determine the maximum sequence length
max_length = max_length(train_descriptions)
print('Description Length: %d' % max_length)

# prepare test set

# load test set
filename = 'Flickr8k_text/Flickr_8k.testImages.txt'
test = load_set(filename)
print('Dataset: %d' % len(test))
# descriptions
test_descriptions = load_clean_descriptions('descriptions.txt', test)
print('Descriptions: test=%d' % len(test_descriptions))
# photo features
test_features = load_photo_features('features.pkl', test)
print('Photos: test=%d' % len(test_features))

# load the model
filename = 'model-ep002-loss3.245-val_loss3.612.h5'
model = load_model(filename)
# evaluate model
evaluate_model(model, test_descriptions, test_features, tokenizer, max_length)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-22">22</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-24">24</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-26">26</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-28">28</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-30">30</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-32">32</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-34">34</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-36">36</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-38">38</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-40">40</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-42">42</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-44">44</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-46">46</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-48">48</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-50">50</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-52">52</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-54">54</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-56">56</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-58">58</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-60">60</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-62">62</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-64">64</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-66">66</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-68">68</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-70">70</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-72">72</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-74">74</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-76">76</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-78">78</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-80">80</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-82">82</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-84">84</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-86">86</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-88">88</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-90">90</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-92">92</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-94">94</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-96">96</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-98">98</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-100">100</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-102">102</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-104">104</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-106">106</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-108">108</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-110">110</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-112">112</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-114">114</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-116">116</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-118">118</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-120">120</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-122">122</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-124">124</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-126">126</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-128">128</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-130">130</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-131">131</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-132">132</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-133">133</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-134">134</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-135">135</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-136">136</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-137">137</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-138">138</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-139">139</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-140">140</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-141">141</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-142">142</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-143">143</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-144">144</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-145">145</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-146">146</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-147">147</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-148">148</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-149">149</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-150">150</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-151">151</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-152">152</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-153">153</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-154">154</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-155">155</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-156">156</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-157">157</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-158">158</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-159">159</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-160">160</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-161">161</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-162">162</div><div class="crayon-num" data-line="crayon-5a6591aa49170313525947-163">163</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49170313525947-164">164</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49170313525947-1"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">argmax</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-2"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-e">load</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">text </span><span class="crayon-e">import </span><span class="crayon-e">Tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">sequence </span><span class="crayon-e">import </span><span class="crayon-e">pad_sequences</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">load_model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-6"><span class="crayon-e">from </span><span class="crayon-v">nltk</span><span class="crayon-sy">.</span><span class="crayon-v">translate</span><span class="crayon-sy">.</span><span class="crayon-e">bleu_score </span><span class="crayon-e">import </span><span class="crayon-v">corpus_bleu</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-7"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-8"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-9"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-10"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-11"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-12"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-13"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-14"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-15"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-16"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-17"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-18"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-19"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-20"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-21"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-22"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-23"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-24"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-25"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-26"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-27"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-28"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-29"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-30"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-31"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-32"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-33"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-34"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-35"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-36"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-37"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-38"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-39"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-40"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-41"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-42"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-43"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-44"><span class="crayon-h"> </span><span class="crayon-p"># create list</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-45"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-46"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-47"><span class="crayon-h"> </span><span class="crayon-p"># wrap description in tokens</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-48"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-49"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-50"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-51"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-52"> </div><div class="crayon-line" id="crayon-5a6591aa49170313525947-53"><span class="crayon-p"># load photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-54"><span class="crayon-e">def </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-55"><span class="crayon-h"> </span><span class="crayon-p"># load all features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-56"><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-57"><span class="crayon-h"> </span><span class="crayon-p"># filter features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-58"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">k</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">k</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-59"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-60"> </div><div class="crayon-line" id="crayon-5a6591aa49170313525947-61"><span class="crayon-p"># covert a dictionary of clean descriptions to a list of descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-62"><span class="crayon-e">def </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-63"><span class="crayon-h"> </span><span class="crayon-v">all_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-64"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">key </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-65"><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">all_desc</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-66"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">all_desc</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-67"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-68"><span class="crayon-p"># fit a tokenizer given caption descriptions</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-69"><span class="crayon-e">def </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-70"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-71"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-72"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-73"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-74"> </div><div class="crayon-line" id="crayon-5a6591aa49170313525947-75"><span class="crayon-p"># calculate the length of the description with the most words</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-76"><span class="crayon-e">def </span><span class="crayon-e">max_length</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-77"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-78"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">max</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-79"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-80"><span class="crayon-p"># map an integer to a word</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-81"><span class="crayon-e">def </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-t">integer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-82"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">index </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-83"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">integer</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-84"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-85"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">None</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-86"> </div><div class="crayon-line" id="crayon-5a6591aa49170313525947-87"><span class="crayon-p"># generate a description for an image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-88"><span class="crayon-e">def </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-89"><span class="crayon-h"> </span><span class="crayon-p"># seed the generation process</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-90"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq'</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-91"><span class="crayon-h"> </span><span class="crayon-p"># iterate over the whole length of the sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-92"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-93"><span class="crayon-h"> </span><span class="crayon-p"># integer encode input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-94"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_text</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-95"><span class="crayon-h"> </span><span class="crayon-p"># pad input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-96"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-97"><span class="crayon-h"> </span><span class="crayon-p"># predict next word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-98"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-99"><span class="crayon-h"> </span><span class="crayon-p"># convert probability to integer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-100"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">argmax</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-101"><span class="crayon-h"> </span><span class="crayon-p"># map integer to word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-102"><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-103"><span class="crayon-h"> </span><span class="crayon-p"># stop if we cannot map the word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-104"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-105"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-106"><span class="crayon-h"> </span><span class="crayon-p"># append as input for generating the next word</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-107"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-108"><span class="crayon-h"> </span><span class="crayon-p"># stop if we predict the end of the sequence</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-109"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">'endseq'</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-110"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-111"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">in_text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-112"> </div><div class="crayon-line" id="crayon-5a6591aa49170313525947-113"><span class="crayon-p"># evaluate the skill of the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-114"><span class="crayon-e">def </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-115"><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-116"><span class="crayon-h"> </span><span class="crayon-p"># step over the whole set</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-117"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc_list </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-118"><span class="crayon-h"> </span><span class="crayon-p"># generate description</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-119"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-120"><span class="crayon-h"> </span><span class="crayon-p"># store actual and predicted</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-121"><span class="crayon-h"> </span><span class="crayon-v">references</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">d</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc_list</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-122"><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">references</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-123"><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-124"><span class="crayon-h"> </span><span class="crayon-p"># calculate BLEU score</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-125"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-1: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">1.0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-126"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-2: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">0.5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-127"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-3: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">0.3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-128"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'BLEU-4: %f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">0.25</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.25</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.25</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0.25</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-129"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-130"><span class="crayon-p"># prepare tokenizer on train set</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-131"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-132"><span class="crayon-p"># load training dataset (6K)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-133"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.trainImages.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-134"><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-135"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-136"><span class="crayon-p"># descriptions</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-137"><span class="crayon-v">train_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-138"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-139"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-140"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-141"><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-142"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-143"><span class="crayon-p"># determine the maximum sequence length</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-144"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">max_length</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-145"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Description Length: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-146"> </div><div class="crayon-line" id="crayon-5a6591aa49170313525947-147"><span class="crayon-p"># prepare test set</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-148"> </div><div class="crayon-line" id="crayon-5a6591aa49170313525947-149"><span class="crayon-p"># load test set</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-150"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.testImages.txt'</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-151"><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-152"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-153"><span class="crayon-p"># descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-154"><span class="crayon-v">test_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-155"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: test=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-156"><span class="crayon-p"># photo features</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-157"><span class="crayon-v">test_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-158"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Photos: test=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-159"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-160"><span class="crayon-p"># load the model</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-161"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'model-ep002-loss3.245-val_loss3.612.h5'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-162"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_model</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49170313525947-163"><span class="crayon-p"># evaluate model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49170313525947-164"><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0096 seconds] -->
<p>Running the example prints the BLEU scores.</p>
<p>We can see that the scores fit within and close to the top of the expected range of a skillful model on the problem. The chosen model configuration is by no means optimized.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49176773553763" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
BLEU-1: 0.579114
BLEU-2: 0.344856
BLEU-3: 0.252154
BLEU-4: 0.131446</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49176773553763-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49176773553763-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49176773553763-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49176773553763-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49176773553763-1">BLEU-1: 0.579114</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49176773553763-2">BLEU-2: 0.344856</div><div class="crayon-line" id="crayon-5a6591aa49176773553763-3">BLEU-3: 0.252154</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49176773553763-4">BLEU-4: 0.131446</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<h2>Generate New Captions</h2>
<p>Now that we know how to develop and evaluate a caption generation model, how can we use it?</p>
<p>Almost everything we need to generate captions for entirely new photographs is in the model file.</p>
<p>We also need the Tokenizer for encoding generated words for the model while generating a sequence, and the maximum length of input sequences, used when we defined the model (e.g. 34).</p>
<p>We can hard code the maximum sequence length. With the encoding of text, we can create the tokenizer and save it to a file so that we can load it quickly whenever we need it without needing the entire Flickr8K dataset. An alternative would be to use our own vocabulary file and mapping to integers function during training.</p>
<p>We can create the Tokenizer as before and save it as a pickle file <em>tokenizer.pkl</em>. The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49179141582769" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from keras.preprocessing.text import Tokenizer
from pickle import dump

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)

# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# create list
			if image_id not in descriptions:
				descriptions[image_id] = list()
			# wrap description in tokens
			desc = 'startseq ' + ' '.join(image_desc) + ' endseq'
			# store
			descriptions[image_id].append(desc)
	return descriptions

# covert a dictionary of clean descriptions to a list of descriptions
def to_lines(descriptions):
	all_desc = list()
	for key in descriptions.keys():
		[all_desc.append(d) for d in descriptions[key]]
	return all_desc

# fit a tokenizer given caption descriptions
def create_tokenizer(descriptions):
	lines = to_lines(descriptions)
	tokenizer = Tokenizer()
	tokenizer.fit_on_texts(lines)
	return tokenizer

# load training dataset (6K)
filename = 'Flickr8k_text/Flickr_8k.trainImages.txt'
train = load_set(filename)
print('Dataset: %d' % len(train))
# descriptions
train_descriptions = load_clean_descriptions('descriptions.txt', train)
print('Descriptions: train=%d' % len(train_descriptions))
# prepare tokenizer
tokenizer = create_tokenizer(train_descriptions)
# save the tokenizer
dump(tokenizer, open('tokenizer.pkl', 'wb'))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-22">22</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-24">24</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-26">26</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-28">28</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-30">30</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-32">32</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-34">34</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-36">36</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-38">38</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-40">40</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-42">42</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-44">44</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-46">46</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-48">48</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-50">50</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-52">52</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-54">54</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-56">56</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-58">58</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-60">60</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-62">62</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-64">64</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-66">66</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-68">68</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-70">70</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49179141582769-72">72</div><div class="crayon-num" data-line="crayon-5a6591aa49179141582769-73">73</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49179141582769-1"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">text </span><span class="crayon-e">import </span><span class="crayon-e">Tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-2"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-v">dump</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-3"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-4"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-5"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-6"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-7"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-8"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-9"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-10"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-11"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-12"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-13"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-14"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-15"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-16"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-17"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-18"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-19"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-20"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-21"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-22"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-23"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-24"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-25"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-26"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-27"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-28"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-29"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-30"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-31"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-32"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-33"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-34"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-35"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-36"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-37"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-38"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-39"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-40"><span class="crayon-h"> </span><span class="crayon-p"># create list</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-41"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-42"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-43"><span class="crayon-h"> </span><span class="crayon-p"># wrap description in tokens</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-44"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-45"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-46"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-47"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-48"> </div><div class="crayon-line" id="crayon-5a6591aa49179141582769-49"><span class="crayon-p"># covert a dictionary of clean descriptions to a list of descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-50"><span class="crayon-e">def </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-51"><span class="crayon-h"> </span><span class="crayon-v">all_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-52"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">key </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-53"><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">all_desc</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">d</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">d</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-54"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">all_desc</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-55"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-56"><span class="crayon-p"># fit a tokenizer given caption descriptions</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-57"><span class="crayon-e">def </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-58"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_lines</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-59"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-60"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-61"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-62"> </div><div class="crayon-line" id="crayon-5a6591aa49179141582769-63"><span class="crayon-p"># load training dataset (6K)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-64"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.trainImages.txt'</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-65"><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-66"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-67"><span class="crayon-p"># descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-68"><span class="crayon-v">train_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-69"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-70"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-71"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49179141582769-72"><span class="crayon-p"># save the tokenizer</span></div><div class="crayon-line" id="crayon-5a6591aa49179141582769-73"><span class="crayon-e">dump</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'tokenizer.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0039 seconds] -->
<p>We can now load the tokenizer whenever we need it without having to load the entire training dataset of annotations.</p>
<p>Now, let’s generate a description for a new photograph.</p>
<p>Below is a new photograph that I chose randomly on Flickr (available under a permissive license).</p>
<div class="wp-caption aligncenter" id="attachment_4462" style="max-width: 650px"><img alt="Photo of a dog at the beach." class="size-full wp-image-4462" height="512" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/example.jpg" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/example.jpg 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/example-300x240.jpg 300w" width="640"/><p class="wp-caption-text">Photo of a dog at the beach.<br/>Photo by <a href="https://www.flickr.com/photos/bambe1964/7837618434/">bambe1964</a>, some rights reserved.</p></div>
<p>We will generate a description for it using our model.</p>
<p>Download the photograph and save it to your local directory with the filename “<em>example.jpg</em>“.</p>
<p>First, we must load the Tokenizer from <em>tokenizer.pkl</em> and define the maximum length of the sequence to generate, needed for padding inputs.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4917d535080631" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load the tokenizer
tokenizer = load(open('tokenizer.pkl', 'rb'))
# pre-define the max sequence length (from training)
max_length = 34</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4917d535080631-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4917d535080631-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa4917d535080631-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa4917d535080631-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4917d535080631-1"><span class="crayon-p"># load the tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4917d535080631-2"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'tokenizer.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa4917d535080631-3"><span class="crayon-p"># pre-define the max sequence length (from training)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa4917d535080631-4"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">34</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>Then we must load the model, as before.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49180120004938" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load the model
model = load_model('model-ep002-loss3.245-val_loss3.612.h5')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49180120004938-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49180120004938-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49180120004938-1"><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49180120004938-2"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_model</span><span class="crayon-sy">(</span><span class="crayon-s">'model-ep002-loss3.245-val_loss3.612.h5'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Next, we must load the photo we which to describe and extract the features.</p>
<p>We could do this by re-defining the model and adding the VGG-16 model to it, or we can use the VGG model to predict the features and use them as inputs to our existing model. We will do the latter and use a modified version of the <em>extract_features()</em> function used during data preparation, but adapted to work on a single photo.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49183581703877" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# extract features from each photo in the directory
def extract_features(filename):
	# load the model
	model = VGG16()
	# re-structure the model
	model.layers.pop()
	model = Model(inputs=model.inputs, outputs=model.layers[-1].output)
	# load the photo
	image = load_img(filename, target_size=(224, 224))
	# convert the image pixels to a numpy array
	image = img_to_array(image)
	# reshape data for the model
	image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
	# prepare the image for the VGG model
	image = preprocess_input(image)
	# get features
	feature = model.predict(image, verbose=0)
	return feature

# load and prepare the photograph
photo = extract_features('example.jpg')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49183581703877-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49183581703877-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49183581703877-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49183581703877-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49183581703877-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49183581703877-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49183581703877-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49183581703877-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49183581703877-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49183581703877-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49183581703877-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49183581703877-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa49183581703877-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49183581703877-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa49183581703877-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49183581703877-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa49183581703877-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49183581703877-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa49183581703877-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49183581703877-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa49183581703877-21">21</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49183581703877-1"><span class="crayon-p"># extract features from each photo in the directory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49183581703877-2"><span class="crayon-e">def </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49183581703877-3"><span class="crayon-h"> </span><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49183581703877-4"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VGG16</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49183581703877-5"><span class="crayon-h"> </span><span class="crayon-p"># re-structure the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49183581703877-6"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">pop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49183581703877-7"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">inputs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">output</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49183581703877-8"><span class="crayon-h"> </span><span class="crayon-p"># load the photo</span></div><div class="crayon-line" id="crayon-5a6591aa49183581703877-9"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49183581703877-10"><span class="crayon-h"> </span><span class="crayon-p"># convert the image pixels to a numpy array</span></div><div class="crayon-line" id="crayon-5a6591aa49183581703877-11"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49183581703877-12"><span class="crayon-h"> </span><span class="crayon-p"># reshape data for the model</span></div><div class="crayon-line" id="crayon-5a6591aa49183581703877-13"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49183581703877-14"><span class="crayon-h"> </span><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line" id="crayon-5a6591aa49183581703877-15"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49183581703877-16"><span class="crayon-h"> </span><span class="crayon-p"># get features</span></div><div class="crayon-line" id="crayon-5a6591aa49183581703877-17"><span class="crayon-h"> </span><span class="crayon-v">feature</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49183581703877-18"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">feature</span></div><div class="crayon-line" id="crayon-5a6591aa49183581703877-19"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49183581703877-20"><span class="crayon-p"># load and prepare the photograph</span></div><div class="crayon-line" id="crayon-5a6591aa49183581703877-21"><span class="crayon-v">photo</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-s">'example.jpg'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0015 seconds] -->
<p>We can then generate a description using the <em>generate_desc()</em> function defined when evaluating the model.</p>
<p>The complete example for generating a description for an entirely new standalone photograph is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49185631467765" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from pickle import load
from numpy import argmax
from keras.preprocessing.sequence import pad_sequences
from keras.applications.vgg16 import VGG16
from keras.preprocessing.image import load_img
from keras.preprocessing.image import img_to_array
from keras.applications.vgg16 import preprocess_input
from keras.models import Model
from keras.models import load_model

# extract features from each photo in the directory
def extract_features(filename):
	# load the model
	model = VGG16()
	# re-structure the model
	model.layers.pop()
	model = Model(inputs=model.inputs, outputs=model.layers[-1].output)
	# load the photo
	image = load_img(filename, target_size=(224, 224))
	# convert the image pixels to a numpy array
	image = img_to_array(image)
	# reshape data for the model
	image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
	# prepare the image for the VGG model
	image = preprocess_input(image)
	# get features
	feature = model.predict(image, verbose=0)
	return feature

# map an integer to a word
def word_for_id(integer, tokenizer):
	for word, index in tokenizer.word_index.items():
		if index == integer:
			return word
	return None

# generate a description for an image
def generate_desc(model, tokenizer, photo, max_length):
	# seed the generation process
	in_text = 'startseq'
	# iterate over the whole length of the sequence
	for i in range(max_length):
		# integer encode input sequence
		sequence = tokenizer.texts_to_sequences([in_text])[0]
		# pad input
		sequence = pad_sequences([sequence], maxlen=max_length)
		# predict next word
		yhat = model.predict([photo,sequence], verbose=0)
		# convert probability to integer
		yhat = argmax(yhat)
		# map integer to word
		word = word_for_id(yhat, tokenizer)
		# stop if we cannot map the word
		if word is None:
			break
		# append as input for generating the next word
		in_text += ' ' + word
		# stop if we predict the end of the sequence
		if word == 'endseq':
			break
	return in_text

# load the tokenizer
tokenizer = load(open('tokenizer.pkl', 'rb'))
# pre-define the max sequence length (from training)
max_length = 34
# load the model
model = load_model('model-ep002-loss3.245-val_loss3.612.h5')
# load and prepare the photograph
photo = extract_features('example.jpg')
# generate description
description = generate_desc(model, tokenizer, photo, max_length)
print(description)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-2">2</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-4">4</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-6">6</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-8">8</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-10">10</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-12">12</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-14">14</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-16">16</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-18">18</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-20">20</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-22">22</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-24">24</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-26">26</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-28">28</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-30">30</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-32">32</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-34">34</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-36">36</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-38">38</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-40">40</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-42">42</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-44">44</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-46">46</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-48">48</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-50">50</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-52">52</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-54">54</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-56">56</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-58">58</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-60">60</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-62">62</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-64">64</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-66">66</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-68">68</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-70">70</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591aa49185631467765-72">72</div><div class="crayon-num" data-line="crayon-5a6591aa49185631467765-73">73</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49185631467765-1"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-e">load</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-2"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">argmax</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">sequence </span><span class="crayon-e">import </span><span class="crayon-e">pad_sequences</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">VGG16</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">load_img</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-6"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">img_to_array</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-7"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">preprocess_input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Model</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-v">load_model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-10"> </div><div class="crayon-line" id="crayon-5a6591aa49185631467765-11"><span class="crayon-p"># extract features from each photo in the directory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-12"><span class="crayon-e">def </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-13"><span class="crayon-h"> </span><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-14"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VGG16</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-15"><span class="crayon-h"> </span><span class="crayon-p"># re-structure the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-16"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">pop</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-17"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">inputs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">.</span><span class="crayon-v">output</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-18"><span class="crayon-h"> </span><span class="crayon-p"># load the photo</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-19"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-20"><span class="crayon-h"> </span><span class="crayon-p"># convert the image pixels to a numpy array</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-21"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-22"><span class="crayon-h"> </span><span class="crayon-p"># reshape data for the model</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-23"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-24"><span class="crayon-h"> </span><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-25"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-26"><span class="crayon-h"> </span><span class="crayon-p"># get features</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-27"><span class="crayon-h"> </span><span class="crayon-v">feature</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-28"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">feature</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-29"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-30"><span class="crayon-p"># map an integer to a word</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-31"><span class="crayon-e">def </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-t">integer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-32"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">index </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-33"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">integer</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-34"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-35"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">None</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-36"> </div><div class="crayon-line" id="crayon-5a6591aa49185631467765-37"><span class="crayon-p"># generate a description for an image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-38"><span class="crayon-e">def </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-39"><span class="crayon-h"> </span><span class="crayon-p"># seed the generation process</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-40"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq'</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-41"><span class="crayon-h"> </span><span class="crayon-p"># iterate over the whole length of the sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-42"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-43"><span class="crayon-h"> </span><span class="crayon-p"># integer encode input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-44"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_text</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-45"><span class="crayon-h"> </span><span class="crayon-p"># pad input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-46"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-47"><span class="crayon-h"> </span><span class="crayon-p"># predict next word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-48"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-49"><span class="crayon-h"> </span><span class="crayon-p"># convert probability to integer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-50"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">argmax</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-51"><span class="crayon-h"> </span><span class="crayon-p"># map integer to word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-52"><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-53"><span class="crayon-h"> </span><span class="crayon-p"># stop if we cannot map the word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-54"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-55"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-56"><span class="crayon-h"> </span><span class="crayon-p"># append as input for generating the next word</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-57"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-58"><span class="crayon-h"> </span><span class="crayon-p"># stop if we predict the end of the sequence</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-59"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">'endseq'</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-60"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-61"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">in_text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-62"> </div><div class="crayon-line" id="crayon-5a6591aa49185631467765-63"><span class="crayon-p"># load the tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-64"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'tokenizer.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-65"><span class="crayon-p"># pre-define the max sequence length (from training)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-66"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">34</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-67"><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-68"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_model</span><span class="crayon-sy">(</span><span class="crayon-s">'model-ep002-loss3.245-val_loss3.612.h5'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-69"><span class="crayon-p"># load and prepare the photograph</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-70"><span class="crayon-v">photo</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-s">'example.jpg'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-71"><span class="crayon-p"># generate description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591aa49185631467765-72"><span class="crayon-v">description</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591aa49185631467765-73"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">description</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0042 seconds] -->
<p>In this case, the description generated was as follows:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa49189490927886" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
startseq dog is running across the beach endseq</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa49189490927886-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa49189490927886-1">startseq dog is running across the beach endseq</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>You could remove the start and end tokens and you would have the basis for a nice automatic photo captioning model.</p>
<p>It’s like living in the future guys!</p>
<p>It still completely blows my mind that we can do this. Wow.</p>
<h2>Extensions</h2>
<p>This section lists some ideas for extending the tutorial that you may wish to explore.</p>
<ul>
<li><strong>Alternate Pre-Trained Photo Models</strong>. A small 16-layer VGG model was used for feature extraction. Consider exploring larger models that offer better performance on the ImageNet dataset, such as Inception.</li>
<li><strong>Smaller Vocabulary</strong>. A larger vocabulary of nearly eight thousand words was used in the development of the model. Many of the words supported may be misspellings or only used once in the entire dataset. Refine the vocabulary and reduce the size, perhaps by half.</li>
<li><strong>Pre-trained Word Vectors</strong>. The model learned the word vectors as part of fitting the model. Better performance may be achieved by using word vectors either pre-trained on the training dataset or trained on a much larger corpus of text, such as news articles or Wikipedia.</li>
<li><strong>Tune Model</strong>. The configuration of the model was not tuned on the problem. Explore alternate configurations and see if you can achieve better performance.</li>
</ul>
<p>Did you try any of these extensions? Share your results in the comments below.</p>
<h2>Further Reading</h2>
<p>This section provides more resources on the topic if you are looking go deeper.</p>
<h3>Caption Generation Papers</h3>
<ul>
<li><a href="https://arxiv.org/abs/1411.4555">Show and Tell: A Neural Image Caption Generator</a>, 2015.</li>
<li><a href="https://arxiv.org/abs/1502.03044">Show, Attend and Tell: Neural Image Caption Generation with Visual Attention</a>, 2015.</li>
<li><a href="https://arxiv.org/abs/1703.09137">Where to put the Image in an Image Caption Generator</a>, 2017.</li>
<li><a href="https://arxiv.org/abs/1708.02043">What is the Role of Recurrent Neural Networks (RNNs) in an Image Caption Generator?</a>, 2017.</li>
<li><a href="https://arxiv.org/abs/1601.03896">Automatic Description Generation from Images: A Survey of Models, Datasets, and Evaluation Measures</a>, 2016.</li>
</ul>
<h3>Flickr8K Dataset</h3>
<ul>
<li><a href="http://nlp.cs.illinois.edu/HockenmaierGroup/Framing_Image_Description/KCCA.html">Framing image description as a ranking task: data, models and evaluation metrics</a> (Homepage)</li>
<li><a href="https://www.jair.org/media/3994/live-3994-7274-jair.pdf">Framing Image Description as a Ranking Task: Data, Models and Evaluation Metrics</a>, (PDF) 2013.</li>
<li><a href="https://illinois.edu/fb/sec/1713398">Dataset Request Form</a></li>
<li><a href="http://nlp.cs.illinois.edu/HockenmaierGroup/8k-pictures.html">Old Flicrk8K Homepage</a></li>
</ul>
<h3>API</h3>
<ul>
<li><a href="https://keras.io/models/model/">Keras Model API</a></li>
<li><a href="https://keras.io/preprocessing/sequence/#pad_sequences">Keras pad_sequences() API</a></li>
<li><a href="https://keras.io/preprocessing/text/#tokenizer">Keras Tokenizer API</a></li>
<li><a href="https://keras.io/applications/#vgg16">Keras VGG16 API</a></li>
<li><a href="https://radimrehurek.com/gensim/models/word2vec.html">Gensim word2vec API</a></li>
<li><a href="http://www.nltk.org/api/nltk.translate.html">nltk.translate package API Documentation</a></li>
</ul>
<h2>Summary</h2>
<p>In this tutorial, you discovered how to develop a photo captioning deep learning model from scratch.</p>
<p>Specifically, you learned:</p>
<ul>
<li>How to prepare photo and text data ready for training a deep learning model.</li>
<li>How to design and train a deep learning caption generation model.</li>
<li>How to evaluate a train caption generation model and use it to caption entirely new photographs.</li>
</ul>
<p>Do you have any questions?<br/>
Ask your questions in the comments below and I will do my best to answer.</p>
<div class="awac-wrapper"><div class="awac widget text-42"> <div class="textwidget"><p></p><center><br/>
<div class="woo-sc-hr"></div>
<h2>Develop Deep Learning models for Text Data Today!</h2>
<p><a href="/deep-learning-for-nlp/"><img align="left" alt="Deep Learning for Natural Language Processing" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/DLFNLP-Cover-220.png" style="border: 0;"/></a></p>
<h4>Develop Your Own Text models in Minutes</h4>
<p>…with just a few lines of python code</p>
<p>Discover how in my new Ebook:<br/>
<a href="/deep-learning-for-nlp/">Deep Learning for Natural Language Processing</a></p>
<p>It provides <strong>self-study tutorials</strong> on topics like:<br/>
<em>Bag-of-Words, Word Embedding, Language Models, Caption Generation, Text Translation</em> and much more…</p>
<h4>Finally Bring Deep Learning to your Natural Language Processing Projects</h4>
<p>Skip the Academics. Just Results.</p>
<p><a href="/deep-learning-for-nlp/">Click to learn more</a>.<br/>
</p><div class="woo-sc-hr"></div><br/>
</center>
</div>
</div></div><div class="apss-social-share apss-theme-4 clearfix">
<div class="apss-twitter apss-single-icon">
<a href="javascript:void(0);" onclick="apss_open_in_popup_window(event, 'https://twitter.com/intent/tweet?text=How%20to%20Develop%20a%20Deep%20Learning%20Photo%20Caption%20Generator%20from%20Scratch&amp;url=https%3A%2F%2Fmachinelearningmastery.com%2Fdevelop-a-deep-learning-caption-generation-model-in-python%2F&amp;');" rel="nofollow" target="" title="Share on Twitter">
<div class="apss-icon-block clearfix">
<i class="fa fa-twitter"></i>
<span class="apss-social-text">Share on Twitter</span><span class="apss-share">Tweet</span>
</div>
</a>
</div>
<div class="apss-facebook apss-single-icon">
<a href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" onclick="apss_open_in_popup_window(event, 'https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/');" rel="nofollow" target="" title="Share on Facebook">
<div class="apss-icon-block clearfix">
<i class="fa fa-facebook"></i>
<span class="apss-social-text">Share on Facebook</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-linkedin apss-single-icon">
<a href="http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Develop%20a%20Deep%20Learning%20Photo%20Caption%20Generator%20from%20Scratch&amp;url=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/&amp;summary=Develop+a+Deep+Learning+Model+to+Automatically%0D%0ADescribe+Photographs+in+Python+with+Keras%2C+Step-by-S..." onclick="apss_open_in_popup_window(event, 'http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Develop%20a%20Deep%20Learning%20Photo%20Caption%20Generator%20from%20Scratch&amp;url=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/&amp;summary=Develop+a+Deep+Learning+Model+to+Automatically%0D%0ADescribe+Photographs+in+Python+with+Keras%2C+Step-by-S...');" rel="nofollow" target="" title="Share on LinkedIn">
<div class="apss-icon-block clearfix"><i class="fa fa-linkedin"></i>
<span class="apss-social-text">Share on LinkedIn</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-google-plus apss-single-icon">
<a href="https://plus.google.com/share?url=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" onclick="apss_open_in_popup_window(event, 'https://plus.google.com/share?url=https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/');" rel="nofollow" target="" title="Share on Google Plus">
<div class="apss-icon-block clearfix">
<i class="fa fa-google-plus"></i>
<span class="apss-social-text">Share on Google Plus</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
</div> </section><!-- /.entry -->
<div class="fix"></div>
<aside id="post-author">
<div class="profile-image"><img alt="" class="avatar avatar-80 photo" height="80" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=160&amp;d=mm&amp;r=g 2x" width="80"/></div>
<div class="profile-content">
<h4>About Jason Brownlee</h4>
		Dr. Jason Brownlee is a husband, proud father, academic researcher, author, professional developer and a machine learning practitioner. He is dedicated to helping developers get started and get good at applied machine learning.
<a href="/about">Learn more</a>.				<div class="profile-link">
<a href="https://machinelearningmastery.com/author/jasonb/">
				View all posts by Jason Brownlee <span class="meta-nav">→</span> </a>
</div><!--#profile-link-->
</div>
<div class="fix"></div>
</aside>
<div class="post-utility"></div>
</article><!-- /.post -->
<div class="post-entries">
<div class="nav-prev fl"><a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/" rel="prev"><i class="fa fa-angle-left"></i> How to Use Small Experiments to Develop a Caption Generation Model in Keras</a></div>
<div class="nav-next fr"><a href="https://machinelearningmastery.com/gentle-introduction-text-summarization/" rel="next">A Gentle Introduction to Text Summarization <i class="fa fa-angle-right"></i></a></div>
<div class="fix"></div>
</div>
<div id="comments"> <h3 id="comments-title">44 Responses to <em>How to Develop a Deep Learning Photo Caption Generator from Scratch</em></h3>
<ol class="commentlist">
<li class="comment even thread-even depth-1" id="comment-421397">
<div class="comment-container" id="li-comment-421397">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/cba7595273306c580724556d6969e244?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/cba7595273306c580724556d6969e244?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Christian Beckmann</span>
<span class="date">November 28, 2017 at 3:21 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421397" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>thanks for this great article about image caption!</p>
<p>My results after training were a bit worse (loss 3.566 – val_loss 3.859, then started to overfit) so i decided to try keras.applications.inception_v3.InceptionV3 for the base model. Currently it is still running and i am curious to see if it will do better.</p>
<div class="reply">
<a aria-label="Reply to Christian Beckmann" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=421397#respond" onclick='return addComment.moveForm( "comment-421397", "421397", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-421431">
<div class="comment-container" id="li-comment-421431">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 28, 2017 at 8:41 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421431" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Let me know how you go Christian.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=421431#respond" onclick='return addComment.moveForm( "comment-421431", "421431", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-421644">
<div class="comment-container" id="li-comment-421644">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/c68408ea018d67921361ee2d377299da?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/c68408ea018d67921361ee2d377299da?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Akash</span>
<span class="date">November 30, 2017 at 4:56 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421644" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
Once again  great Article.<br/>
I ran into some error while executing the code under “Complete example ” section.<br/>
The error I got was<br/>
ValueError: Error when checking target: expected dense_3 to have shape (None, 7579) but got array with shape (306404, 1)<br/>
 Any idea how to fix this?<br/>
Thanks</p>
<div class="reply">
<a aria-label="Reply to Akash" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=421644#respond" onclick='return addComment.moveForm( "comment-421644", "421644", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-421673">
<div class="comment-container" id="li-comment-421673">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 30, 2017 at 8:26 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421673" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Akash, nice catch.</p>
<p>The fault appears to have been introduced in a recent version of Keras in the to_categorical() function. I can confirm the fault occurs with Keras 2.1.1.</p>
<p>You can learn more about the fault here:<br/>
<a href="https://github.com/fchollet/keras/issues/8519" rel="nofollow">https://github.com/fchollet/keras/issues/8519</a></p>
<p>There are two options:</p>
<p>1. Downgrade Keras to 2.0.8</p>
<p>or </p>
<p>2. Modify the code, change line 104 in the training code example from:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4ba22110058852" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4ba22110058852-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4ba22110058852-1"><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p></p>
<p>to </p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591aa4ba2c000194349" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
out_seq = to_categorical([out_seq], num_classes=vocab_size)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591aa4ba2c000194349-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591aa4ba2c000194349-1"><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p></p>
<p>I hope that helps.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=421673#respond" onclick='return addComment.moveForm( "comment-421673", "421673", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-421719">
<div class="comment-container" id="li-comment-421719">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/c68408ea018d67921361ee2d377299da?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/c68408ea018d67921361ee2d377299da?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Akash</span>
<span class="date">November 30, 2017 at 5:38 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421719" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Jason. It’s working now.<br/>
Can you suggest the changes to be made to use Inception model and word embedding like word2vec.</p>
<div class="reply">
<a aria-label="Reply to Akash" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=421719#respond" onclick='return addComment.moveForm( "comment-421719", "421719", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-421791">
<div class="comment-container" id="li-comment-421791">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 1, 2017 at 7:26 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421791" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I’m glad to hear that.</p>
<p>Yes, simply load the inception model and prepare the images.<br/>
<a href="https://keras.io/applications/" rel="nofollow">https://keras.io/applications/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=421791#respond" onclick='return addComment.moveForm( "comment-421791", "421791", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-421755">
<div class="comment-container" id="li-comment-421755">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/9537df9d267d96cec91e9478f70f7a9e?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/9537df9d267d96cec91e9478f70f7a9e?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Zoltan</span>
<span class="date">November 30, 2017 at 11:47 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421755" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason, </p>
<p>Big thumbs up, nicely written, really informative article. I especially like the step by step approach.</p>
<p>But when I tried to go through it, I got an error in load_poto_features saying that “name ‘load’ not defined”. Which is kinda odd.</p>
<p>Otherwise everything seems fine.</p>
<div class="reply">
<a aria-label="Reply to Zoltan" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=421755#respond" onclick='return addComment.moveForm( "comment-421755", "421755", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-421807">
<div class="comment-container" id="li-comment-421807">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 1, 2017 at 7:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421807" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks.</p>
<p>Perhaps double check you have the load function imported from pickle?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=421807#respond" onclick='return addComment.moveForm( "comment-421807", "421807", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-421847">
<div class="comment-container" id="li-comment-421847">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/df5140ff432d7b5d7af269c6840f1777?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/df5140ff432d7b5d7af269c6840f1777?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Bikram Kachari</span>
<span class="date">December 1, 2017 at 4:59 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421847" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason</p>
<p>I am a regular follower of your tutorials. They are great. I got to learn a lot. Thank you so much. Please keep up the good work</p>
<div class="reply">
<a aria-label="Reply to Bikram Kachari" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=421847#respond" onclick='return addComment.moveForm( "comment-421847", "421847", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-421904">
<div class="comment-container" id="li-comment-421904">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 2, 2017 at 8:49 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421904" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You’re welcome!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=421904#respond" onclick='return addComment.moveForm( "comment-421904", "421904", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-421853">
<div class="comment-container" id="li-comment-421853">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/35819af56db0314e56e202d5e7a3869d?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/35819af56db0314e56e202d5e7a3869d?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">maibam</span>
<span class="date">December 1, 2017 at 7:05 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421853" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>____________________________________________________________________________________________________<br/>
Layer (type)                     Output Shape          Param #     Connected to<br/>
====================================================================================================<br/>
input_2 (InputLayer)             (None, 34)            0<br/>
____________________________________________________________________________________________________<br/>
input_1 (InputLayer)             (None, 4096)          0<br/>
____________________________________________________________________________________________________<br/>
embedding_1 (Embedding)          (None, 34, 256)       1940224     input_2[0][0]<br/>
____________________________________________________________________________________________________<br/>
dropout_1 (Dropout)              (None, 4096)          0           input_1[0][0]<br/>
____________________________________________________________________________________________________<br/>
dropout_2 (Dropout)              (None, 34, 256)       0           embedding_1[0][0]<br/>
____________________________________________________________________________________________________<br/>
dense_1 (Dense)                  (None, 256)           1048832     dropout_1[0][0]<br/>
____________________________________________________________________________________________________<br/>
lstm_1 (LSTM)                    (None, 256)           525312      dropout_2[0][0]<br/>
____________________________________________________________________________________________________<br/>
add_1 (Add)                      (None, 256)           0           dense_1[0][0]<br/>
                                                                   lstm_1[0][0]<br/>
____________________________________________________________________________________________________<br/>
dense_2 (Dense)                  (None, 256)           65792       add_1[0][0]<br/>
____________________________________________________________________________________________________<br/>
dense_3 (Dense)                  (None, 7579)          1947803     dense_2[0][0]<br/>
====================================================================================================<br/>
Total params: 5,527,963<br/>
Trainable params: 5,527,963<br/>
Non-trainable params: 0<br/>
_________________________</p>
<p>ValueError: Error when checking input: expected input_1 to have 2 dimensions, but got array with shape (306404, 7, 7, 512)</p>
<p>Getting error during mode.fit<br/>
model.fit([X1train, X2train], ytrain, epochs=20, verbose=2, callbacks=[checkpoint], validation_data=([X1test, X2test], ytest))</p>
<p>Keras  2.0.8 with tensorflow<br/>
what is wrong ?</p>
<div class="reply">
<a aria-label="Reply to maibam" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=421853#respond" onclick='return addComment.moveForm( "comment-421853", "421853", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-421907">
<div class="comment-container" id="li-comment-421907">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 2, 2017 at 8:51 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421907" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Not sure, did you copy all of the code exactly?</p>
<p>Is your numpy and tensorflow also up to date?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=421907#respond" onclick='return addComment.moveForm( "comment-421907", "421907", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-426681">
<div class="comment-container" id="li-comment-426681">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/cba7595273306c580724556d6969e244?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/cba7595273306c580724556d6969e244?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Christian</span>
<span class="date">January 16, 2018 at 10:09 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-426681" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>This looks like he did change the network for feature extraction. When using include_top=False and wheigts=’imagenet” you get this type of data structure.</p>
<div class="reply">
<a aria-label="Reply to Christian" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=426681#respond" onclick='return addComment.moveForm( "comment-426681", "426681", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-426720">
<div class="comment-container" id="li-comment-426720">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 17, 2018 at 9:58 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-426720" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Nice.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=426720#respond" onclick='return addComment.moveForm( "comment-426720", "426720", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-421950">
<div class="comment-container" id="li-comment-421950">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/000b71fb827140eef02a19418028d6de?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/000b71fb827140eef02a19418028d6de?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Vik</span>
<span class="date">December 2, 2017 at 7:16 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421950" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thank you for the article. It is great to see full pipeline.<br/>
Always following your articles with admiration</p>
<div class="reply">
<a aria-label="Reply to Vik" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=421950#respond" onclick='return addComment.moveForm( "comment-421950", "421950", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-421991">
<div class="comment-container" id="li-comment-421991">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 3, 2017 at 5:24 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-421991" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=421991#respond" onclick='return addComment.moveForm( "comment-421991", "421991", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-422111">
<div class="comment-container" id="li-comment-422111">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/2379782137d7cc566e1dc257762b9952?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2379782137d7cc566e1dc257762b9952?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Gonzalo Gasca Meza</span>
<span class="date">December 4, 2017 at 10:42 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422111" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>In the prepare data section, if using Python 2.7 there is no str.maketrans method.<br/>
To make this work just comment that line and in line 46 do this:<br/>
desc = [w.translate(None, string.punctuation) for w in desc]</p>
<div class="reply">
<a aria-label="Reply to Gonzalo Gasca Meza" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=422111#respond" onclick='return addComment.moveForm( "comment-422111", "422111", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-422122">
<div class="comment-container" id="li-comment-422122">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 4, 2017 at 4:57 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422122" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Gonzalo!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=422122#respond" onclick='return addComment.moveForm( "comment-422122", "422122", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-422776">
<div class="comment-container" id="li-comment-422776">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://www.modyco.fr/fr/component/jsn/minel.html?Itemid=" rel="external nofollow">Minel</a></span>
<span class="date">December 11, 2017 at 6:17 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422776" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
I am using your code step by step. There is a light mistake :<br/>
you wrote<br/>
# save descriptions<br/>
save_doc(descriptions, ‘descriptions.txt’)</p>
<p>in fact the right intruction is<br/>
# save descriptions<br/>
save_descriptions(descriptions, ‘descriptions.txt’)</p>
<p>as you wrote in the final example<br/>
best</p>
<div class="reply">
<a aria-label="Reply to Minel" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=422776#respond" onclick='return addComment.moveForm( "comment-422776", "422776", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-422822">
<div class="comment-container" id="li-comment-422822">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 12, 2017 at 5:25 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422822" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Minel, fixed.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=422822#respond" onclick='return addComment.moveForm( "comment-422822", "422822", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-422778">
<div class="comment-container" id="li-comment-422778">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://www.modyco.fr/fr/component/jsn/minel.html?Itemid=" rel="external nofollow">Minel</a></span>
<span class="date">December 11, 2017 at 6:34 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422778" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi jason<br/>
Another small detail. I had to write<br/>
from pickle import load<br/>
to run the instruction<br/>
	all_features = load(open(filename, ‘rb’))</p>
<p>Best</p>
<div class="reply">
<a aria-label="Reply to Minel" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=422778#respond" onclick='return addComment.moveForm( "comment-422778", "422778", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-422823">
<div class="comment-container" id="li-comment-422823">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 12, 2017 at 5:27 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422823" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Nice catch, fixed. Thanks!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=422823#respond" onclick='return addComment.moveForm( "comment-422823", "422823", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-422787">
<div class="comment-container" id="li-comment-422787">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://www.modyco.fr/fr/component/jsn/minel.html?Itemid=" rel="external nofollow">Minel</a></span>
<span class="date">December 11, 2017 at 9:32 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422787" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
I met some trouble running your code. I got a MemoryError on the instruction :<br/>
return array(X1), array(X2), array(y)</p>
<p>I am using a virtual machine with Linux (Debian), Python3,  with 32Giga of memory.<br/>
Could you tell me what was the size of the memory on the computer you used to check your program ?</p>
<p>Best</p>
<div class="reply">
<a aria-label="Reply to Minel" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=422787#respond" onclick='return addComment.moveForm( "comment-422787", "422787", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-422826">
<div class="comment-container" id="li-comment-422826">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 12, 2017 at 5:29 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422826" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I expect 8GB of RAM would be enough.</p>
<p>Perhaps try and use progressive loading instead, as described in this post:<br/>
<a href="https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/" rel="nofollow">https://machinelearningmastery.com/prepare-photo-caption-dataset-training-deep-learning-model/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=422826#respond" onclick='return addComment.moveForm( "comment-422826", "422826", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-422916">
<div class="comment-container" id="li-comment-422916">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/11fe8c12eee8439eec8d7cf30646fba7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://www.modyco.fr/fr/component/jsn/minel.html?Itemid=" rel="external nofollow">Minel</a></span>
<span class="date">December 12, 2017 at 11:34 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422916" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thank for the advice.In fact, I upgraded the VM (64Go, 16 cores) and it worked fine (using 45Go of memory)<br/>
Best</p>
<div class="reply">
<a aria-label="Reply to Minel" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=422916#respond" onclick='return addComment.moveForm( "comment-422916", "422916", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-422947">
<div class="comment-container" id="li-comment-422947">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 13, 2017 at 5:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-422947" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Nice! Glad to hear it.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=422947#respond" onclick='return addComment.moveForm( "comment-422947", "422947", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-423633">
<div class="comment-container" id="li-comment-423633">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ff89cc762470a4d4682e3b48c67cd781?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ff89cc762470a4d4682e3b48c67cd781?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Josh Ash</span>
<span class="date">December 17, 2017 at 9:56 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-423633" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason – hello from Queensland 🙂<br/>
Your tutorials on applied ML in Python are the best on the net hands down, thanks for putting them together!</p>
<div class="reply">
<a aria-label="Reply to Josh Ash" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=423633#respond" onclick='return addComment.moveForm( "comment-423633", "423633", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-423672">
<div class="comment-container" id="li-comment-423672">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 18, 2017 at 5:22 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-423672" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Josh!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=423672#respond" onclick='return addComment.moveForm( "comment-423672", "423672", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-423748">
<div class="comment-container" id="li-comment-423748">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/e235b328169e2f5e7221a7cb89601940?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/e235b328169e2f5e7221a7cb89601940?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Madhivarman</span>
<span class="date">December 18, 2017 at 7:12 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-423748" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>hai Jason.. When i run the train.py script my lap freeze…I don’t know whether its training or not.Did anyone face this issue ?</p>
<p>Thanks..!</p>
<div class="reply">
<a aria-label="Reply to Madhivarman" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=423748#respond" onclick='return addComment.moveForm( "comment-423748", "423748", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-423781">
<div class="comment-container" id="li-comment-423781">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 19, 2017 at 5:16 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-423781" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sorry to hear that.</p>
<p>Perhaps try running it on AWS for a few dollars:<br/>
<a href="https://machinelearningmastery.com/develop-evaluate-large-deep-learning-models-keras-amazon-web-services/" rel="nofollow">https://machinelearningmastery.com/develop-evaluate-large-deep-learning-models-keras-amazon-web-services/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=423781#respond" onclick='return addComment.moveForm( "comment-423781", "423781", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-424156">
<div class="comment-container" id="li-comment-424156">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/8a5c42b5ce041dc744347fad1df531fd?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/8a5c42b5ce041dc744347fad1df531fd?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Muhammad Awais</span>
<span class="date">December 20, 2017 at 3:36 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424156" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks for such a great work. I found an error message when running a code<br/>
FileNotFoundError: [Errno 2] No such file or directory: ‘descriptions.txt’<br/>
Please help</p>
<div class="reply">
<a aria-label="Reply to Muhammad Awais" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=424156#respond" onclick='return addComment.moveForm( "comment-424156", "424156", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-424169">
<div class="comment-container" id="li-comment-424169">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 20, 2017 at 3:50 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424169" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Ensure you generate the descriptions file before running the prior model – check the tutorial steps again and ensure you execute each in turn.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=424169#respond" onclick='return addComment.moveForm( "comment-424169", "424169", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-424237">
<div class="comment-container" id="li-comment-424237">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/08d5f83cd4ba24e4baebd5228176fda6?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/08d5f83cd4ba24e4baebd5228176fda6?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Daniel F</span>
<span class="date">December 21, 2017 at 4:31 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424237" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>I’m getting a MemoryError when I try to prepare the training sequences: </p>
<p>Traceback (most recent call last):<br/>
  File “C:\Users\Daniel\Desktop\project\deeplearningmodel.py”, line 154, in<br/>
    X1train, X2train, ytrain = create_sequences(tokenizer, max_length, train_descriptions, train_features)<br/>
  File “C:\Users\Daniel\Desktop\project\deeplearningmodel.py”, line 104, in create_sequences<br/>
    out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]<br/>
  File “C:\Program Files\Anaconda3\lib\site-packages\keras\utils\np_utils.py”, line 24, in to_categorical<br/>
    categorical = np.zeros((n, num_classes))<br/>
MemoryError</p>
<p>any advice? I have 8GB of RAM.</p>
<div class="reply">
<a aria-label="Reply to Daniel F" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=424237#respond" onclick='return addComment.moveForm( "comment-424237", "424237", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-424258">
<div class="comment-container" id="li-comment-424258">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 21, 2017 at 5:29 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424258" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps try using progressive loading described in this post:<br/>
<a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/" rel="nofollow">https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=424258#respond" onclick='return addComment.moveForm( "comment-424258", "424258", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-424392">
<div class="comment-container" id="li-comment-424392">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/08d5f83cd4ba24e4baebd5228176fda6?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/08d5f83cd4ba24e4baebd5228176fda6?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Daniel F</span>
<span class="date">December 22, 2017 at 8:26 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424392" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Any chance you could show what that would look like functioning with this example? 🙂 I’m struggling a bit to bring a similar generator from the other example to this script.</p>
<div class="reply">
<a aria-label="Reply to Daniel F" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=424392#respond" onclick='return addComment.moveForm( "comment-424392", "424392", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-424419">
<div class="comment-container" id="li-comment-424419">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 22, 2017 at 4:13 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424419" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks for the suggestion, I’ll schedule time to update the example.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=424419#respond" onclick='return addComment.moveForm( "comment-424419", "424419", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-5" id="comment-424455">
<div class="comment-container" id="li-comment-424455">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/08d5f83cd4ba24e4baebd5228176fda6?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/08d5f83cd4ba24e4baebd5228176fda6?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Daniel F</span>
<span class="date">December 22, 2017 at 11:58 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424455" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Great! Thanks so much </p>
<p>And thanks for the blog, it is really wonderful 🙂 For now I just cut down the training set a lot to work around the memory error and understand.the code better.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-424489">
<div class="comment-container" id="li-comment-424489">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 23, 2017 at 5:19 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424489" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Daniel.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-424996">
<div class="comment-container" id="li-comment-424996">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ec2c85f0596146bc8af40dc6354bfc32?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ec2c85f0596146bc8af40dc6354bfc32?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">zonetrooper32</span>
<span class="date">December 28, 2017 at 3:12 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-424996" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>Thank you for this amazing article about image captioning.</p>
<p>Currently I am trying to re-implement the whole code, except that I am doing it in pure Tensorflow. I’m curious to see if my re-implementation is working as smooth as yours.</p>
<p>Also a shower thought, it might be better to get a better vector representations for words if using the pretrained word2vec embeddings, for example Glove 6B or GoogleNews. Learning embeddings from scratch with only 8k words might have some performance loss.</p>
<p>Again thank you for putting everything together, it will take quite some time to implement from scratch without your tutorial.</p>
<div class="reply">
<a aria-label="Reply to zonetrooper32" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=424996#respond" onclick='return addComment.moveForm( "comment-424996", "424996", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-425014">
<div class="comment-container" id="li-comment-425014">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 28, 2017 at 5:26 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-425014" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Try it and see if it lifts model skill. Let me know how you go.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=425014#respond" onclick='return addComment.moveForm( "comment-425014", "425014", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-425881">
<div class="comment-container" id="li-comment-425881">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/abec5dc1f6ddcc301aa1edddd739122b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/abec5dc1f6ddcc301aa1edddd739122b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Sasikanth</span>
<span class="date">January 8, 2018 at 5:04 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-425881" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello Jason,<br/>
Is there a R package to perform modeling of images?</p>
<p>regards<br/>
sasikanth</p>
<div class="reply">
<a aria-label="Reply to Sasikanth" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=425881#respond" onclick='return addComment.moveForm( "comment-425881", "425881", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-425910">
<div class="comment-container" id="li-comment-425910">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 9, 2018 at 5:24 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-425910" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I don’t know, sorry.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=425910#respond" onclick='return addComment.moveForm( "comment-425910", "425910", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-426679">
<div class="comment-container" id="li-comment-426679">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/00eac6eb851a9c3cda81ac8e1dcf1bb4?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/00eac6eb851a9c3cda81ac8e1dcf1bb4?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Marco</span>
<span class="date">January 16, 2018 at 10:08 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-426679" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason! Thanks for your amazing tutorial! I have a question. I don’t understand the meaning of the number 1 on this line (extract_features):<br/>
image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))</p>
<p>Can you explain me what reshape does and the meaning of the arguments?</p>
<p>Thanks in advance.</p>
<div class="reply">
<a aria-label="Reply to Marco" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=426679#respond" onclick='return addComment.moveForm( "comment-426679", "426679", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-426719">
<div class="comment-container" id="li-comment-426719">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 17, 2018 at 9:58 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/#comment-426719" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Great question, see this post to learn more about numpy arrays:<br/>
<a href="https://machinelearningmastery.com/index-slice-reshape-numpy-arrays-machine-learning-python/" rel="nofollow">https://machinelearningmastery.com/index-slice-reshape-numpy-arrays-machine-learning-python/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/?replytocom=426719#respond" onclick='return addComment.moveForm( "comment-426719", "426719", "respond", "4459" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ol>
</div> <div class="comment-respond" id="respond">
<h3 class="comment-reply-title" id="reply-title">Leave a Reply <small><a href="/develop-a-deep-learning-caption-generation-model-in-python/#respond" id="cancel-comment-reply-link" rel="nofollow" style="display:none;">Click here to cancel reply.</a></small></h3> <form action="https://machinelearningmastery.com/wp-comments-post.php?wpe-comment-post=mlmastery" class="comment-form" id="commentform" method="post">
<p class="comment-form-comment"><label class="hide" for="comment">Comment</label> <textarea aria-required="true" cols="50" id="comment" maxlength="65525" name="comment" required="required" rows="10" tabindex="4"></textarea></p><p class="comment-form-author"><input aria-required="true" class="txt" id="author" name="author" size="30" tabindex="1" type="text" value=""/><label for="author">Name <span class="required">(required)</span></label> </p>
<p class="comment-form-email"><input aria-required="true" class="txt" id="email" name="email" size="30" tabindex="2" type="text" value=""/><label for="email">Email (will not be published) <span class="required">(required)</span></label> </p>
<p class="comment-form-url"><input class="txt" id="url" name="url" size="30" tabindex="3" type="text" value=""/><label for="url">Website</label></p>
<p class="form-submit"><input class="submit" id="submit" name="submit" type="submit" value="Submit Comment"/> <input id="comment_post_ID" name="comment_post_ID" type="hidden" value="4459"/>
<input id="comment_parent" name="comment_parent" type="hidden" value="0"/>
</p><p style="display: none;"><input id="akismet_comment_nonce" name="akismet_comment_nonce" type="hidden" value="bcf0a5d9a8"/></p><p style="display: none;"><input id="ak_js" name="ak_js" type="hidden" value="184"/></p> </form>
</div><!-- #respond -->
</section><!-- /#main -->
<aside id="sidebar">
<div class="widget widget_woo_blogauthorinfo" id="woo_blogauthorinfo-2"><h3>Welcome to Machine Learning Mastery</h3><span class="left"><img alt="" class="avatar avatar-100 photo" height="100" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=100&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=200&amp;d=mm&amp;r=g 2x" width="100"/></span>
<p>Hi, I'm Dr. Jason Brownlee.
<br/>
My goal is to make practitioners like YOU awesome at applied machine learning.</p>
<p><a href="/about">Read More</a></p>
<div class="fix"></div>
</div><div class="widget widget_text" id="text-43"> <div class="textwidget"><p></p><center>
<h3>Deep Learning for Text Data</h3>
<p>Cut through the math and research papers.<br/>
Discover Word Embeddings, Text Translation and more.</p>
<p><a href="/deep-learning-for-nlp/">Get Started With Deep Learning for NLP Today!</a><br/>
<a href="/deep-learning-for-nlp/"><img src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/DLFNLP-Cover-220.png"/></a><br/>
</p></center>
</div>
</div>
<div class="widget widget_woo_tabs" id="woo_tabs-2"> <div id="tabs">
<ul class="wooTabs">
<li class="popular"><a href="#tab-pop">Popular</a></li> </ul>
<div class="clear"></div>
<div class="boxes box inside">
<ul class="list" id="tab-pop">
<li>
<a href="https://machinelearningmastery.com/machine-learning-in-python-step-by-step/" title="Your First Machine Learning Project in Python Step-By-Step"><img alt="Your First Machine Learning Project in Python Step-By-Step" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Your-First-Machine-Learning-Project-in-Python-Step-By-Step-150x150.jpg" title="Your First Machine Learning Project in Python Step-By-Step" width="45"/></a> <a href="https://machinelearningmastery.com/machine-learning-in-python-step-by-step/" title="Your First Machine Learning Project in Python Step-By-Step">Your First Machine Learning Project in Python Step-By-Step</a>
<span class="meta">June 10, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras"><img alt="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/07/Time-Series-Prediction-with-LSTM-Recurrent-Neural-Networks-in-Python-with-Keras-150x150.jpg" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras" width="45"/></a> <a href="https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras">Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras</a>
<span class="meta">July 21, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/" title="Multivariate Time Series Forecasting with LSTMs in Keras"><img alt="Line Plots of Air Pollution Time Series" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/06/Line-Plots-of-Air-Pollution-Time-Series-150x150.png" title="Multivariate Time Series Forecasting with LSTMs in Keras" width="45"/></a> <a href="https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/" title="Multivariate Time Series Forecasting with LSTMs in Keras">Multivariate Time Series Forecasting with LSTMs in Keras</a>
<span class="meta">August 14, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/tutorial-first-neural-network-python-keras/" title="Develop Your First Neural Network in Python With Keras Step-By-Step"><img alt="Tour of Deep Learning Algorithms" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/04/Tour-of-Deep-Learning-Algorithms-150x150.jpg" title="Develop Your First Neural Network in Python With Keras Step-By-Step" width="45"/></a> <a href="https://machinelearningmastery.com/tutorial-first-neural-network-python-keras/" title="Develop Your First Neural Network in Python With Keras Step-By-Step">Develop Your First Neural Network in Python With Keras Step-By-Step</a>
<span class="meta">May 24, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda"><img alt="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/How-to-Setup-a-Python-Environment-for-Machine-Learning-and-Deep-Learning-with-Anaconda-150x150.png" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda" width="45"/></a> <a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda">How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda</a>
<span class="meta">March 13, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/sequence-classification-lstm-recurrent-neural-networks-python-keras/" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras"><img alt="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/07/Sequence-Classification-with-LSTM-Recurrent-Neural-Networks-in-Python-with-Keras-150x150.jpg" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras" width="45"/></a> <a href="https://machinelearningmastery.com/sequence-classification-lstm-recurrent-neural-networks-python-keras/" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras">Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras</a>
<span class="meta">July 26, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/time-series-forecasting-long-short-term-memory-network-python/" title="Time Series Forecasting with the Long Short-Term Memory Network in Python"><img alt="Time Series Forecasting with the Long Short-Term Memory Network in Python" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/04/Time-Series-Forecasting-with-the-Long-Short-Term-Memory-Network-in-Python-150x150.jpg" title="Time Series Forecasting with the Long Short-Term Memory Network in Python" width="45"/></a> <a href="https://machinelearningmastery.com/time-series-forecasting-long-short-term-memory-network-python/" title="Time Series Forecasting with the Long Short-Term Memory Network in Python">Time Series Forecasting with the Long Short-Term Memory Network in Python</a>
<span class="meta">April 7, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/multi-class-classification-tutorial-keras-deep-learning-library/" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library"><img alt="Multi-Class Classification Tutorial with the Keras Deep Learning Library" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Multi-Class-Classification-Tutorial-with-the-Keras-Deep-Learning-Library-150x150.jpg" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library" width="45"/></a> <a href="https://machinelearningmastery.com/multi-class-classification-tutorial-keras-deep-learning-library/" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library">Multi-Class Classification Tutorial with the Keras Deep Learning Library</a>
<span class="meta">June 2, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/regression-tutorial-keras-deep-learning-library-python/" title="Regression Tutorial with the Keras Deep Learning Library in Python"><img alt="Regression Tutorial with Keras Deep Learning Library in Python" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Regression-Tutorial-with-Keras-Deep-Learning-Library-in-Python-150x150.jpg" title="Regression Tutorial with the Keras Deep Learning Library in Python" width="45"/></a> <a href="https://machinelearningmastery.com/regression-tutorial-keras-deep-learning-library-python/" title="Regression Tutorial with the Keras Deep Learning Library in Python">Regression Tutorial with the Keras Deep Learning Library in Python</a>
<span class="meta">June 9, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/grid-search-hyperparameters-deep-learning-models-python-keras/" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras"><img alt="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/08/How-to-Grid-Search-Hyperparameters-for-Deep-Learning-Models-in-Python-With-Keras-150x150.jpg" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras" width="45"/></a> <a href="https://machinelearningmastery.com/grid-search-hyperparameters-deep-learning-models-python-keras/" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras">How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras</a>
<span class="meta">August 9, 2016</span>
<div class="fix"></div>
</li>
</ul>
</div><!-- /.boxes -->
</div><!-- /wooTabs -->
</div> </aside><!-- /#sidebar -->
</div><!-- /#main-sidebar-container -->
</div><!-- /#content -->
<footer class="col-full" id="footer">
<div class="col-left" id="copyright">
<p>© 2018 Machine Learning Mastery. All Rights Reserved. </p> </div>
<div class="col-right" id="credit">
<p></p><p>
<a href="/privacy/">Privacy</a> | 
<a href="/contact/">Contact</a> |
<a href="/about/">About</a>
</p> </div>
</footer>
</div><!-- /#inner-wrapper -->
</div><!-- /#wrapper -->
<div class="fix"></div><!--/.fix-->
<!-- Drip -->
<script type="text/javascript">
  var _dcq = _dcq || [];
  var _dcs = _dcs || {}; 
  _dcs.account = '9556588';
  
  (function() {
    var dc = document.createElement('script');
    dc.type = 'text/javascript'; dc.async = true; 
    dc.src = '//tag.getdrip.com/9556588.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(dc, s);
  })();
</script><!-- Woo Tabs Widget -->
<script type="text/javascript">
jQuery(document).ready(function(){
	// UL = .wooTabs
	// Tab contents = .inside

	var tag_cloud_class = '#tagcloud';

	//Fix for tag clouds - unexpected height before .hide()
	var tag_cloud_height = jQuery( '#tagcloud').height();

	jQuery( '.inside ul li:last-child').css( 'border-bottom','0px' ); // remove last border-bottom from list in tab content
	jQuery( '.wooTabs').each(function(){
		jQuery(this).children( 'li').children( 'a:first').addClass( 'selected' ); // Add .selected class to first tab on load
	});
	jQuery( '.inside > *').hide();
	jQuery( '.inside > *:first-child').show();

	jQuery( '.wooTabs li a').click(function(evt){ // Init Click funtion on Tabs

		var clicked_tab_ref = jQuery(this).attr( 'href' ); // Strore Href value

		jQuery(this).parent().parent().children( 'li').children( 'a').removeClass( 'selected' ); //Remove selected from all tabs
		jQuery(this).addClass( 'selected' );
		jQuery(this).parent().parent().parent().children( '.inside').children( '*').hide();

		jQuery( '.inside ' + clicked_tab_ref).fadeIn(500);

		 evt.preventDefault();

	})
})
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/comment-reply.min.js?ver=4.9.2" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var wpcf7 = {"apiSettings":{"root":"https:\/\/machinelearningmastery.com\/wp-json\/contact-form-7\/v1","namespace":"contact-form-7\/v1"},"recaptcha":{"messages":{"empty":"Please verify that you are not a robot."}},"cached":"1"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/js/scripts.js?ver=4.9.2" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var frontend_ajax_object = {"ajax_url":"https:\/\/machinelearningmastery.com\/wp-admin\/admin-ajax.php","ajax_nonce":"555b70787c"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/seo-optimized-share-buttons/js/frontend.js?ver=4.2.2.0.iis7_supports_permalinks" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/wp-embed.min.js?ver=4.9.2" type="text/javascript"></script>
<script async="async" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/akismet/_inc/form.js?ver=4.0.2" type="text/javascript"></script>
</body>
</html>