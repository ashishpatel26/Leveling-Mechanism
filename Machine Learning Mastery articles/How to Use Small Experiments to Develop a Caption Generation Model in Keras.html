<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
<meta charset="utf-8"/>
<title>How to Use Small Experiments to Develop a Caption Generation Model in Keras - Machine Learning Mastery</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="https://machinelearningmastery.com/xmlrpc.php" rel="pingback"/>
<!--  Mobile viewport scale -->
<meta content="initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" name="viewport"/>
<!-- This site is optimized with the Yoast SEO plugin v6.1.1 - https://yoa.st/1yg?utm_content=6.1.1 -->
<link href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/" rel="canonical"/>
<link href="https://plus.google.com/u/0/b/117073416089354242117/+MachinelearningmasteryHome/" rel="publisher"/>
<meta content="en_US" property="og:locale"/>
<meta content="article" property="og:type"/>
<meta content="How to Use Small Experiments to Develop a Caption Generation Model in Keras - Machine Learning Mastery" property="og:title"/>
<meta content="Caption generation is a challenging artificial intelligence problem where a textual description must be generated for a photograph. It requires both methods from computer vision to understand the content of the image and a language model from the field of natural language processing to turn the understanding of the image into words in the right …" property="og:description"/>
<meta content="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/" property="og:url"/>
<meta content="Machine Learning Mastery" property="og:site_name"/>
<meta content="https://www.facebook.com/Machine-Learning-Mastery-1429846323896563/" property="article:publisher"/>
<meta content="Natural Language Processing" property="article:section"/>
<meta content="2017-11-24T05:00:37+11:00" property="article:published_time"/>
<meta content="2017-11-21T11:06:46+11:00" property="article:modified_time"/>
<meta content="2017-11-21T11:06:46+11:00" property="og:updated_time"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Use-Small-Experiments-to-Develop-a-Caption-Generation-Model-in-Keras.jpg" property="og:image"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Use-Small-Experiments-to-Develop-a-Caption-Generation-Model-in-Keras.jpg" property="og:image:secure_url"/>
<meta content="640" property="og:image:width"/>
<meta content="480" property="og:image:height"/>
<script type="application/ld+json">{"@context":"http:\/\/schema.org","@type":"WebSite","@id":"#website","url":"https:\/\/machinelearningmastery.com\/","name":"Machine Learning Mastery","potentialAction":{"@type":"SearchAction","target":"https:\/\/machinelearningmastery.com\/?s={search_term_string}","query-input":"required name=search_term_string"}}</script>
<script type="application/ld+json">{"@context":"http:\/\/schema.org","@type":"Organization","url":"https:\/\/machinelearningmastery.com\/develop-a-caption-generation-model-in-keras\/","sameAs":["https:\/\/www.facebook.com\/Machine-Learning-Mastery-1429846323896563\/","https:\/\/www.linkedin.com\/in\/jasonbrownlee","https:\/\/plus.google.com\/u\/0\/b\/117073416089354242117\/+MachinelearningmasteryHome\/","https:\/\/twitter.com\/TeachTheMachine"],"@id":"#organization","name":"Machine Learning Mastery","logo":"https:\/\/machinelearningmastery.com\/wp-content\/uploads\/2016\/09\/cropped-icon.png"}</script>
<!-- / Yoast SEO plugin. -->
<link href="//cdnjs.cloudflare.com" rel="dns-prefetch"/>
<link href="//fonts.googleapis.com" rel="dns-prefetch"/>
<link href="//s.w.org" rel="dns-prefetch"/>
<link href="https://feeds.feedburner.com/MachineLearningMastery" rel="alternate" title="Machine Learning Mastery » Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/comments/feed/" rel="alternate" title="Machine Learning Mastery » Comments Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/feed/" rel="alternate" title="Machine Learning Mastery » How to Use Small Experiments to Develop a Caption Generation Model in Keras Comments Feed" type="application/rss+xml"/>
<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/machinelearningmastery.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.9.2"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56794,8205,9794,65039],[55358,56794,8203,9794,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta" id="crayon-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta" id="crayon-theme-classic-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta" id="crayon-font-monaco-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=4.9.2" id="contact-form-7-css" media="all" rel="stylesheet" type="text/css"/>
<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css?ver=4.2.2.0.iis7_supports_permalinks" id="apss-font-awesome-css" media="all" rel="stylesheet" type="text/css"/>
<link href="//fonts.googleapis.com/css?family=Open+Sans&amp;ver=4.9.2" id="apss-font-opensans-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/seo-optimized-share-buttons/css/frontend.css?ver=4.2.2.0.iis7_supports_permalinks" id="apss-frontend-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/integrations/testimonials/css/testimonials.css?ver=4.9.2" id="woo-testimonials-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/style.css?ver=5.9.21" id="theme-stylesheet-css" media="all" rel="stylesheet" type="text/css"/>
<!--[if lt IE 9]>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/css/non-responsive.css" rel="stylesheet" type="text/css" />
<style type="text/css">.col-full, #wrapper { width: 960px; max-width: 960px; } #inner-wrapper { padding: 0; } body.full-width #header, #nav-container, body.full-width #content, body.full-width #footer-widgets, body.full-width #footer { padding-left: 0; padding-right: 0; } body.fixed-mobile #top, body.fixed-mobile #header-container, body.fixed-mobile #footer-container, body.fixed-mobile #nav-container, body.fixed-mobile #footer-widgets-container { min-width: 960px; padding: 0 1em; } body.full-width #content { width: auto; padding: 0 1em;}</style>
<![endif]-->
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery.js?ver=1.12.4" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/machinelearningmastery.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/third-party.min.js?ver=4.9.2" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/modernizr.min.js?ver=2.6.2" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/general.min.js?ver=4.9.2" type="text/javascript"></script>
<link href="https://machinelearningmastery.com/wp-json/" rel="https://api.w.org/"/>
<link href="https://machinelearningmastery.com/xmlrpc.php?rsd" rel="EditURI" title="RSD" type="application/rsd+xml"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/wlwmanifest.xml" rel="wlwmanifest" type="application/wlwmanifest+xml"/>
<link href="https://machinelearningmastery.com/?p=4450" rel="shortlink"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fdevelop-a-caption-generation-model-in-keras%2F" rel="alternate" type="application/json+oembed"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fdevelop-a-caption-generation-model-in-keras%2F&amp;format=xml" rel="alternate" type="text/xml+oembed"/>
<!-- Start Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44039733-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->
<!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');

fbq('init', '296263687421164');
fbq('track', "PageView");</script>
<noscript><img height="1" src="https://www.facebook.com/tr?id=296263687421164&amp;ev=PageView&amp;noscript=1" style="display:none" width="1"/></noscript>
<!-- End Facebook Pixel Code -->
<!-- Custom CSS Styling -->
<style type="text/css">
#logo .site-title, #logo .site-description { display:none; }
body {background-repeat:no-repeat;background-position:top left;background-attachment:scroll;border-top:0px solid #000000;}
#header {background-repeat:no-repeat;background-position:left top;margin-top:0px;margin-bottom:0px;padding-top:10px;padding-bottom:10px;border:0px solid ;}
#logo .site-title a {font:bold 40px/1em Helvetica Neue, Helvetica, sans-serif;color:#222222;}
#logo .site-description {font:300 13px/1em Helvetica Neue, Helvetica, sans-serif;color:#999999;}
body, p { font:300 14px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
h1 { font:bold 28px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h2 { font:bold 24px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h3 { font:bold 20px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h4 { font:bold 16px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h5 { font:bold 14px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h6 { font:bold 12px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }
.page-title, .post .title, .page .title {font:bold 28px/1.1em "Helvetica Neue", Helvetica, sans-serif;color:#222222;}
.post .title a:link, .post .title a:visited, .page .title a:link, .page .title a:visited {color:#222222}
.post-meta { font:300 12px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#999999; }
.entry, .entry p{ font:300 15px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555; }
.post-more {font:300 13px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:;border-top:0px solid #e6e6e6;border-bottom:0px solid #e6e6e6;}
#post-author, #connect {border-top:1px solid #e6e6e6;border-bottom:1px solid #e6e6e6;border-left:1px solid #e6e6e6;border-right:1px solid #e6e6e6;border-radius:5px;-moz-border-radius:5px;-webkit-border-radius:5px;background-color:#fafafa}
.nav-entries a, .woo-pagination { font:300 13px/1em "Helvetica Neue", Helvetica, sans-serif;color:#888; }
.woo-pagination a, .woo-pagination a:hover {color:#888!important}
.widget h3 {font:bold 14px/1.2em &quot;Helvetica Neue&quot;, Helvetica, sans-serif;color:#555555;border-bottom:1px solid #e6e6e6;}
.widget_recent_comments li, #twitter li { border-color: #e6e6e6;}
.widget p, .widget .textwidget { font:300 13px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
.widget {font:300 13px/1.5em &quot;Helvetica Neue&quot;, Helvetica, sans-serif;color:#555555;border-radius:0px;-moz-border-radius:0px;-webkit-border-radius:0px;}
#tabs .inside li a, .widget_woodojo_tabs .tabbable .tab-pane li a { font:bold 12px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
#tabs .inside li span.meta, .widget_woodojo_tabs .tabbable .tab-pane li span.meta { font:300 11px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
#tabs ul.wooTabs li a, .widget_woodojo_tabs .tabbable .nav-tabs li a { font:300 11px/2em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
@media only screen and (min-width:768px) {
ul.nav li a, #navigation ul.rss a, #navigation ul.cart a.cart-contents, #navigation .cart-contents #navigation ul.rss, #navigation ul.nav-search, #navigation ul.nav-search a { font:300 14px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#666666; } #navigation ul.rss li a:before, #navigation ul.nav-search a.search-contents:before { color:#666666;}
#navigation ul.nav li ul, #navigation ul.cart > li > ul > div  { border: 0px solid #dbdbdb; }
#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation ul.nav > li  { border-right: 0px solid #dbdbdb; }#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation { box-shadow: none; -moz-box-shadow: none; -webkit-box-shadow: none; }#navigation ul li:first-child, #navigation ul li:first-child a { border-radius:0px 0 0 0px; -moz-border-radius:0px 0 0 0px; -webkit-border-radius:0px 0 0 0px; }
#navigation {border-top:0px solid #dbdbdb;border-bottom:0px solid #dbdbdb;border-left:0px solid #dbdbdb;border-right:0px solid #dbdbdb;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
#top ul.nav li a { font:300 12px/1.6em Helvetica Neue, Helvetica, sans-serif;color:#ddd; }
}
#footer, #footer p { font:300 13px/1.4em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
#footer {border-top:1px solid #dbdbdb;border-bottom:0px solid ;border-left:0px solid ;border-right:0px solid ;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
.magazine #loopedSlider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-magazine .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.magazine #loopedSlider .content .excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-magazine .slide-content p, .wooslider-theme-magazine .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.magazine .block .post .title a {font:bold 18px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }
#loopedSlider.business-slider .content h2 { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#loopedSlider.business-slider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#wrapper #loopedSlider.business-slider .content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.archive_header { font:bold 18px/1em Arial, sans-serif;color:#222222; }
.archive_header {border-bottom:1px solid #e6e6e6;}
.archive_header .catrss { display:none; }
</style>
<!-- Woo Shortcodes CSS -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/functions/css/shortcodes.css" rel="stylesheet" type="text/css"/>
<!-- Custom Stylesheet -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/custom.css" rel="stylesheet" type="text/css"/>
<!-- Theme version -->
<meta content="Canvas 5.9.21" name="generator"/>
<meta content="WooFramework 6.2.9" name="generator"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-32x32.png" rel="icon" sizes="32x32"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-192x192.png" rel="icon" sizes="192x192"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-180x180.png" rel="apple-touch-icon-precomposed"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-270x270.png" name="msapplication-TileImage"/>
</head>
<body class="post-template-default single single-post postid-4450 single-format-standard chrome alt-style-default two-col-left width-960 two-col-left-960">
<div id="wrapper">
<div id="inner-wrapper">
<h3 class="nav-toggle icon"><a href="#navigation">Navigation</a></h3>
<header class="col-full" id="header">
<div id="logo">
<a href="https://machinelearningmastery.com/" title="Making developers awesome at machine learning"><img alt="Machine Learning Mastery" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/MachineLearningMastery.png"/></a>
<span class="site-title"><a href="https://machinelearningmastery.com/">Machine Learning Mastery</a></span>
<span class="site-description">Making developers awesome at machine learning</span>
</div>
<div class="header-widget">
<div class="widget widget_text" id="text-3"> <div class="textwidget"><br/>
<div style="font-size:12pt;">
<a href="/start-here"><strong>Start Here</strong></a>
     
<a href="/blog">Blog</a>
     
<a href="/products">Books</a>
     
<a href="/about">About</a>
     
<a href="/contact">Contact</a>
</div></div>
</div><div class="widget widget_search" id="search-3"><div class="search_main">
<form action="https://machinelearningmastery.com/" class="searchform" method="get">
<input class="field s" name="s" onblur="if (this.value == '') {this.value = 'Search...';}" onfocus="if (this.value == 'Search...') {this.value = '';}" type="text" value="Search..."/>
<button class="fa fa-search submit" name="submit" type="submit" value="Search"></button>
</form>
<div class="fix"></div>
</div></div><div class="widget widget_text" id="text-44"> <div class="textwidget"><p>Need help with Deep Learning for Text? <a href="https://machinelearningmastery.lpages.co/dlfnlp-mini-course/">Take the FREE Mini-Course</a></p>
</div>
</div> </div>
</header>
<nav class="col-full" id="navigation" role="navigation">
<section class="menus">
<a class="nav-home" href="https://machinelearningmastery.com"><span>Home</span></a>
<h3>Empty Menu</h3> <div class="side-nav">
</div><!-- /#side-nav -->
</section><!-- /.menus -->
<a class="nav-close" href="#top"><span>Return to Content</span></a>
</nav>
<!-- #content Starts -->
<div class="col-full" id="content">
<div id="main-sidebar-container">
<!-- #main Starts -->
<section id="main">
<article class="post-4450 post type-post status-publish format-standard has-post-thumbnail hentry category-natural-language-processing">
<header>
<h1 class="title entry-title">How to Use Small Experiments to Develop a Caption Generation Model in Keras</h1> </header>
<div class="post-meta"><span class="small">By</span> <span class="author vcard"><span class="fn"><a href="https://machinelearningmastery.com/author/jasonb/" rel="author" title="Posts by Jason Brownlee">Jason Brownlee</a></span></span> <span class="small">on</span> <abbr class="date time published updated" title="2017-11-24T05:00:37+1100">November 24, 2017</abbr> <span class="small">in</span> <span class="categories"><a href="https://machinelearningmastery.com/category/natural-language-processing/" title="View all items in Natural Language Processing">Natural Language Processing</a></span> </div>
<section class="entry">
<div class="apss-social-share apss-theme-4 clearfix">
<div class="apss-twitter apss-single-icon">
<a href="javascript:void(0);" onclick="apss_open_in_popup_window(event, 'https://twitter.com/intent/tweet?text=How%20to%20Use%20Small%20Experiments%20to%20Develop%20a%20Caption%20Generation%20Model%20in%20Keras&amp;url=https%3A%2F%2Fmachinelearningmastery.com%2Fdevelop-a-caption-generation-model-in-keras%2F&amp;');" rel="nofollow" target="" title="Share on Twitter">
<div class="apss-icon-block clearfix">
<i class="fa fa-twitter"></i>
<span class="apss-social-text">Share on Twitter</span><span class="apss-share">Tweet</span>
</div>
</a>
</div>
<div class="apss-facebook apss-single-icon">
<a href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/" onclick="apss_open_in_popup_window(event, 'https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/');" rel="nofollow" target="" title="Share on Facebook">
<div class="apss-icon-block clearfix">
<i class="fa fa-facebook"></i>
<span class="apss-social-text">Share on Facebook</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-linkedin apss-single-icon">
<a href="http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Use%20Small%20Experiments%20to%20Develop%20a%20Caption%20Generation%20Model%20in%20Keras&amp;url=https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/&amp;summary=Caption+generation+is+a+challenging+artificial+intelligence+problem+where+a+textual+description+must..." onclick="apss_open_in_popup_window(event, 'http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Use%20Small%20Experiments%20to%20Develop%20a%20Caption%20Generation%20Model%20in%20Keras&amp;url=https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/&amp;summary=Caption+generation+is+a+challenging+artificial+intelligence+problem+where+a+textual+description+must...');" rel="nofollow" target="" title="Share on LinkedIn">
<div class="apss-icon-block clearfix"><i class="fa fa-linkedin"></i>
<span class="apss-social-text">Share on LinkedIn</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-google-plus apss-single-icon">
<a href="https://plus.google.com/share?url=https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/" onclick="apss_open_in_popup_window(event, 'https://plus.google.com/share?url=https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/');" rel="nofollow" target="" title="Share on Google Plus">
<div class="apss-icon-block clearfix">
<i class="fa fa-google-plus"></i>
<span class="apss-social-text">Share on Google Plus</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
</div><p>Caption generation is a challenging artificial intelligence problem where a textual description must be generated for a photograph.</p>
<p>It requires both methods from computer vision to understand the content of the image and a language model from the field of natural language processing to turn the understanding of the image into words in the right order. Recently, deep learning methods have achieved state of the art results on examples of this problem.</p>
<p>It can be hard to develop caption generating models on your own data, primarily because the datasets and the models are so large and take days to train. An alternative approach is to explore model configurations with a small sample of the fuller dataset.</p>
<p>In this tutorial, you will discover how you can use a small sample of a standard photo captioning dataset to explore different deep model designs.</p>
<p>After completing this tutorial, you will know:</p>
<ul>
<li>How to prepare data for photo captioning modeling.</li>
<li>How to design a baseline and test harness to evaluate the skill of models and control for their stochastic nature.</li>
<li>How to evaluate properties like model skill, feature extraction models, and word embeddings in order to lift model skill.</li>
</ul>
<p>Let’s get started.</p>
<div class="wp-caption aligncenter" id="attachment_4456" style="max-width: 650px"><img alt="How to Use Small Experiments to Develop a Caption Generation Model in Keras" class="size-full wp-image-4456" height="480" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Use-Small-Experiments-to-Develop-a-Caption-Generation-Model-in-Keras.jpg" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Use-Small-Experiments-to-Develop-a-Caption-Generation-Model-in-Keras.jpg 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/How-to-Use-Small-Experiments-to-Develop-a-Caption-Generation-Model-in-Keras-300x225.jpg 300w" width="640"/><p class="wp-caption-text">How to Use Small Experiments to Develop a Caption Generation Model in Keras<br/>Photo by <a href="https://www.flickr.com/photos/perry-pics/5968641588/">Per</a>, some rights reserved.</p></div>
<h2>Tutorial Overview</h2>
<p>This tutorial is divided into 6 parts; they are:</p>
<ol>
<li>Data Preparation</li>
<li>Baseline Caption Generation Model</li>
<li>Network Size Parameters</li>
<li>Configuring the Feature Extraction Model</li>
<li>Word Embedding Models</li>
<li>Analysis of Results</li>
</ol>
<h3>Python Environment</h3>
<p>This tutorial assumes you have a Python SciPy environment installed, ideally with Python 3.</p>
<p>You must have Keras (2.0 or higher) installed with either the TensorFlow or Theano backend.</p>
<p>The tutorial also assumes you have scikit-learn, Pandas, NumPy, and Matplotlib installed.</p>
<p>If you need help with your environment, see this tutorial:</p>
<ul>
<li><a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/">How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda</a></li>
</ul>
<p>I recommend running the code on a system with a GPU.</p>
<p>You can access GPUs cheaply on Amazon Web Services. Learn how in this tutorial:</p>
<ul>
<li><a href="https://machinelearningmastery.com/develop-evaluate-large-deep-learning-models-keras-amazon-web-services/">How To Develop and Evaluate Large Deep Learning Models with Keras on Amazon Web Services</a></li>
</ul>
<p>Let’s dive in.</p>
<!-- Start shortcoder --><p></p><div class="woo-sc-hr"></div>
<center>
<h3>Need help with Deep Learning for Text Data?</h3>
<p>Take my free 7-day email crash course now (with sample code).</p>
<p>Click to sign-up and also get a free PDF Ebook version of the course.</p>
<p><a href="https://machinelearningmastery.lpages.co/leadbox/144855173f72a2%3A164f8be4f346dc/5655638436741120/" rel="noopener" style="background: #ffce0a; color: #ffffff; text-decoration: none; font-family: Helvetica, Arial, sans-serif; font-weight: bold; font-size: 16px; line-height: 20px; padding: 10px; display: inline-block; max-width: 300px; border-radius: 5px; text-shadow: rgba(0, 0, 0, 0.25) 0px -1px 1px; box-shadow: rgba(255, 255, 255, 0.5) 0px 1px 3px inset, rgba(0, 0, 0, 0.5) 0px 1px 3px;" target="_blank">Start Your FREE Crash-Course Now</a><script data-config="%7B%7D" data-leadbox="144855173f72a2:164f8be4f346dc" data-url="https://machinelearningmastery.lpages.co/leadbox/144855173f72a2%3A164f8be4f346dc/5655638436741120/" src="https://machinelearningmastery.lpages.co/leadbox-1509466860.js" type="text/javascript"></script></p>
</center>
<p></p><div class="woo-sc-hr"></div><!-- End shortcoder v4.1.5-->
<h2>Data Preparation</h2>
<p>First, we need to prepare the dataset for training the model.</p>
<p>We will use the Flickr8K dataset that is comprised of a little more than 8,000 photographs and their descriptions.</p>
<p>You can download the dataset from here:</p>
<ul>
<li><a href="http://nlp.cs.illinois.edu/HockenmaierGroup/Framing_Image_Description/KCCA.html">Framing image description as a ranking task: data, models and evaluation metrics</a>.</li>
</ul>
<p>Unzip the photographs and descriptions into your current working directory into <em>Flicker8k_Dataset</em> and <em>Flickr8k_text</em> directories respectively.</p>
<p>There are two parts to the data preparation, they are:</p>
<ol>
<li>Preparing the Text</li>
<li>Preparing the Photos</li>
</ol>
<h3>Preparing the Text</h3>
<p>The dataset contains multiple descriptions for each photograph and the text of the descriptions requires some minimal cleaning.</p>
<p>First, we will load the file containing all of the descriptions.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c593fff549116625" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

filename = 'Flickr8k_text/Flickr8k.token.txt'
# load descriptions
doc = load_doc(filename)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c593fff549116625-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c593fff549116625-2">2</div><div class="crayon-num" data-line="crayon-5a6591c593fff549116625-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c593fff549116625-4">4</div><div class="crayon-num" data-line="crayon-5a6591c593fff549116625-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c593fff549116625-6">6</div><div class="crayon-num" data-line="crayon-5a6591c593fff549116625-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c593fff549116625-8">8</div><div class="crayon-num" data-line="crayon-5a6591c593fff549116625-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c593fff549116625-10">10</div><div class="crayon-num" data-line="crayon-5a6591c593fff549116625-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c593fff549116625-12">12</div><div class="crayon-num" data-line="crayon-5a6591c593fff549116625-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c593fff549116625-1"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c593fff549116625-2"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c593fff549116625-3"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c593fff549116625-4"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c593fff549116625-5"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c593fff549116625-6"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c593fff549116625-7"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c593fff549116625-8"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c593fff549116625-9"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c593fff549116625-10"> </div><div class="crayon-line" id="crayon-5a6591c593fff549116625-11"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr8k.token.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c593fff549116625-12"><span class="crayon-p"># load descriptions</span></div><div class="crayon-line" id="crayon-5a6591c593fff549116625-13"><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>Each photo has a unique identifier. This is used in the photo filename and in the text file of descriptions. Next, we will step through the list of photo descriptions and save the first description for each photo. Below defines a function named <em>load_descriptions()</em> that, given the loaded document text, will return a dictionary of photo identifiers to descriptions.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59400a129405816" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# extract descriptions for images
def load_descriptions(doc):
	mapping = dict()
	# process lines
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		if len(line) &lt; 2:
			continue
		# take the first token as the image id, the rest as the description
		image_id, image_desc = tokens[0], tokens[1:]
		# remove filename from image id
		image_id = image_id.split('.')[0]
		# convert description tokens back to string
		image_desc = ' '.join(image_desc)
		# store the first description for each image
		if image_id not in mapping:
			mapping[image_id] = image_desc
	return mapping

# parse descriptions
descriptions = load_descriptions(doc)
print('Loaded: %d ' % len(descriptions))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59400a129405816-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400a129405816-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59400a129405816-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400a129405816-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59400a129405816-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400a129405816-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59400a129405816-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400a129405816-8">8</div><div class="crayon-num" data-line="crayon-5a6591c59400a129405816-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400a129405816-10">10</div><div class="crayon-num" data-line="crayon-5a6591c59400a129405816-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400a129405816-12">12</div><div class="crayon-num" data-line="crayon-5a6591c59400a129405816-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400a129405816-14">14</div><div class="crayon-num" data-line="crayon-5a6591c59400a129405816-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400a129405816-16">16</div><div class="crayon-num" data-line="crayon-5a6591c59400a129405816-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400a129405816-18">18</div><div class="crayon-num" data-line="crayon-5a6591c59400a129405816-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400a129405816-20">20</div><div class="crayon-num" data-line="crayon-5a6591c59400a129405816-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400a129405816-22">22</div><div class="crayon-num" data-line="crayon-5a6591c59400a129405816-23">23</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59400a129405816-1"><span class="crayon-p"># extract descriptions for images</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400a129405816-2"><span class="crayon-e">def </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59400a129405816-3"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400a129405816-4"><span class="crayon-h"> </span><span class="crayon-p"># process lines</span></div><div class="crayon-line" id="crayon-5a6591c59400a129405816-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400a129405816-6"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5a6591c59400a129405816-7"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400a129405816-8"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59400a129405816-9"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400a129405816-10"><span class="crayon-h"> </span><span class="crayon-p"># take the first token as the image id, the rest as the description</span></div><div class="crayon-line" id="crayon-5a6591c59400a129405816-11"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400a129405816-12"><span class="crayon-h"> </span><span class="crayon-p"># remove filename from image id</span></div><div class="crayon-line" id="crayon-5a6591c59400a129405816-13"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400a129405816-14"><span class="crayon-h"> </span><span class="crayon-p"># convert description tokens back to string</span></div><div class="crayon-line" id="crayon-5a6591c59400a129405816-15"><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400a129405816-16"><span class="crayon-h"> </span><span class="crayon-p"># store the first description for each image</span></div><div class="crayon-line" id="crayon-5a6591c59400a129405816-17"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400a129405816-18"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">image_desc</span></div><div class="crayon-line" id="crayon-5a6591c59400a129405816-19"><span class="crayon-e"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">mapping</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400a129405816-20"> </div><div class="crayon-line" id="crayon-5a6591c59400a129405816-21"><span class="crayon-p"># parse descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400a129405816-22"><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59400a129405816-23"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Loaded: %d '</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0018 seconds] -->
<p>Next, we need to clean the description text.</p>
<p>The descriptions are already tokenized and easy to work with. We will clean the text in the following ways in order to reduce the size of the vocabulary of words we will need to work with:</p>
<ul>
<li>Convert all words to lowercase.</li>
<li>Remove all punctuation.</li>
<li>Remove all words that are one character or less in length (e.g. ‘a’).</li>
</ul>
<p>Below defines the <em>clean_descriptions()</em> function that, given the dictionary of image identifiers to descriptions, steps through each description and cleans the text.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59400d228782337" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
import string

def clean_descriptions(descriptions):
	# prepare translation table for removing punctuation
	table = str.maketrans('', '', string.punctuation)
	for key, desc in descriptions.items():
		# tokenize
		desc = desc.split()
		# convert to lower case
		desc = [word.lower() for word in desc]
		# remove punctuation from each token
		desc = [w.translate(table) for w in desc]
		# remove hanging 's' and 'a'
		desc = [word for word in desc if len(word)&gt;1]
		# store as string
		descriptions[key] =  ' '.join(desc)

# clean descriptions
clean_descriptions(descriptions)
# summarize vocabulary
all_tokens = ' '.join(descriptions.values()).split()
vocabulary = set(all_tokens)
print('Vocabulary Size: %d' % len(vocabulary))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59400d228782337-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400d228782337-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59400d228782337-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400d228782337-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59400d228782337-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400d228782337-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59400d228782337-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400d228782337-8">8</div><div class="crayon-num" data-line="crayon-5a6591c59400d228782337-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400d228782337-10">10</div><div class="crayon-num" data-line="crayon-5a6591c59400d228782337-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400d228782337-12">12</div><div class="crayon-num" data-line="crayon-5a6591c59400d228782337-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400d228782337-14">14</div><div class="crayon-num" data-line="crayon-5a6591c59400d228782337-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400d228782337-16">16</div><div class="crayon-num" data-line="crayon-5a6591c59400d228782337-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400d228782337-18">18</div><div class="crayon-num" data-line="crayon-5a6591c59400d228782337-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400d228782337-20">20</div><div class="crayon-num" data-line="crayon-5a6591c59400d228782337-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59400d228782337-22">22</div><div class="crayon-num" data-line="crayon-5a6591c59400d228782337-23">23</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59400d228782337-1"><span class="crayon-e">import </span><span class="crayon-t">string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400d228782337-2"> </div><div class="crayon-line" id="crayon-5a6591c59400d228782337-3"><span class="crayon-e">def </span><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400d228782337-4"><span class="crayon-h"> </span><span class="crayon-p"># prepare translation table for removing punctuation</span></div><div class="crayon-line" id="crayon-5a6591c59400d228782337-5"><span class="crayon-h"> </span><span class="crayon-v">table</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">str</span><span class="crayon-sy">.</span><span class="crayon-e">maketrans</span><span class="crayon-sy">(</span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-sy">.</span><span class="crayon-v">punctuation</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400d228782337-6"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59400d228782337-7"><span class="crayon-h"> </span><span class="crayon-p"># tokenize</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400d228782337-8"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59400d228782337-9"><span class="crayon-h"> </span><span class="crayon-p"># convert to lower case</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400d228782337-10"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">.</span><span class="crayon-e">lower</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59400d228782337-11"><span class="crayon-h"> </span><span class="crayon-p"># remove punctuation from each token</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400d228782337-12"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">w</span><span class="crayon-sy">.</span><span class="crayon-e">translate</span><span class="crayon-sy">(</span><span class="crayon-v">table</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59400d228782337-13"><span class="crayon-h"> </span><span class="crayon-p"># remove hanging 's' and 'a'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400d228782337-14"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-t">word</span><span class="crayon-sy">)</span><span class="crayon-o">&gt;</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59400d228782337-15"><span class="crayon-h"> </span><span class="crayon-p"># store as string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400d228782337-16"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h">  </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59400d228782337-17"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400d228782337-18"><span class="crayon-p"># clean descriptions</span></div><div class="crayon-line" id="crayon-5a6591c59400d228782337-19"><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400d228782337-20"><span class="crayon-p"># summarize vocabulary</span></div><div class="crayon-line" id="crayon-5a6591c59400d228782337-21"><span class="crayon-v">all_tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59400d228782337-22"><span class="crayon-v">vocabulary</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">all_tokens</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59400d228782337-23"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">vocabulary</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0021 seconds] -->
<p>Finally, we save the dictionary of image identifiers and descriptions to a new file named <em>descriptions.txt</em>, with one image identifier and description per line.</p>
<p>Below defines the <em>save_doc()</em> function that given a dictionary containing the mapping of identifiers to descriptions and a filename, saves the mapping to file.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594010021381220" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# save descriptions to file, one per line
def save_doc(descriptions, filename):
	lines = list()
	for key, desc in descriptions.items():
		lines.append(key + ' ' + desc)
	data = '\n'.join(lines)
	file = open(filename, 'w')
	file.write(data)
	file.close()

# save descriptions
save_doc(descriptions, 'descriptions.txt')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594010021381220-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594010021381220-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594010021381220-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594010021381220-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594010021381220-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594010021381220-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594010021381220-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594010021381220-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594010021381220-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594010021381220-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594010021381220-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594010021381220-12">12</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594010021381220-1"><span class="crayon-p"># save descriptions to file, one per line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594010021381220-2"><span class="crayon-e">def </span><span class="crayon-e">save_doc</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594010021381220-3"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594010021381220-4"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594010021381220-5"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">key</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594010021381220-6"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'\n'</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594010021381220-7"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'w'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594010021381220-8"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594010021381220-9"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594010021381220-10"> </div><div class="crayon-line" id="crayon-5a6591c594010021381220-11"><span class="crayon-p"># save descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594010021381220-12"><span class="crayon-e">save_doc</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0009 seconds] -->
<p>Putting this all together, the complete listing is provided below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594012451051627" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
import string

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# extract descriptions for images
def load_descriptions(doc):
	mapping = dict()
	# process lines
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		if len(line) &lt; 2:
			continue
		# take the first token as the image id, the rest as the description
		image_id, image_desc = tokens[0], tokens[1:]
		# remove filename from image id
		image_id = image_id.split('.')[0]
		# convert description tokens back to string
		image_desc = ' '.join(image_desc)
		# store the first description for each image
		if image_id not in mapping:
			mapping[image_id] = image_desc
	return mapping

def clean_descriptions(descriptions):
	# prepare translation table for removing punctuation
	table = str.maketrans('', '', string.punctuation)
	for key, desc in descriptions.items():
		# tokenize
		desc = desc.split()
		# convert to lower case
		desc = [word.lower() for word in desc]
		# remove punctuation from each token
		desc = [w.translate(table) for w in desc]
		# remove hanging 's' and 'a'
		desc = [word for word in desc if len(word)&gt;1]
		# store as string
		descriptions[key] =  ' '.join(desc)

# save descriptions to file, one per line
def save_doc(descriptions, filename):
	lines = list()
	for key, desc in descriptions.items():
		lines.append(key + ' ' + desc)
	data = '\n'.join(lines)
	file = open(filename, 'w')
	file.write(data)
	file.close()

filename = 'Flickr8k_text/Flickr8k.token.txt'
# load descriptions
doc = load_doc(filename)
# parse descriptions
descriptions = load_descriptions(doc)
print('Loaded: %d ' % len(descriptions))
# clean descriptions
clean_descriptions(descriptions)
# summarize vocabulary
all_tokens = ' '.join(descriptions.values()).split()
vocabulary = set(all_tokens)
print('Vocabulary Size: %d' % len(vocabulary))
# save descriptions
save_doc(descriptions, 'descriptions.txt')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594012451051627-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-14">14</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-16">16</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-18">18</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-20">20</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-22">22</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-24">24</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-26">26</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-28">28</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-30">30</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-32">32</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-34">34</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-36">36</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-38">38</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-40">40</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-42">42</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-44">44</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-46">46</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-48">48</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-50">50</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-52">52</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-54">54</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-56">56</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-58">58</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-60">60</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-62">62</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-64">64</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-66">66</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-68">68</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594012451051627-70">70</div><div class="crayon-num" data-line="crayon-5a6591c594012451051627-71">71</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594012451051627-1"><span class="crayon-e">import </span><span class="crayon-t">string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-2"> </div><div class="crayon-line" id="crayon-5a6591c594012451051627-3"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-4"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-5"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-6"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-7"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-8"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-9"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-10"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-11"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-12"> </div><div class="crayon-line" id="crayon-5a6591c594012451051627-13"><span class="crayon-p"># extract descriptions for images</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-14"><span class="crayon-e">def </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-15"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-16"><span class="crayon-h"> </span><span class="crayon-p"># process lines</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-17"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-18"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-19"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-20"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-21"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-22"><span class="crayon-h"> </span><span class="crayon-p"># take the first token as the image id, the rest as the description</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-23"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-24"><span class="crayon-h"> </span><span class="crayon-p"># remove filename from image id</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-25"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-26"><span class="crayon-h"> </span><span class="crayon-p"># convert description tokens back to string</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-27"><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-28"><span class="crayon-h"> </span><span class="crayon-p"># store the first description for each image</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-29"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-30"><span class="crayon-h"> </span><span class="crayon-v">mapping</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">image_desc</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-31"><span class="crayon-e"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">mapping</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-32"> </div><div class="crayon-line" id="crayon-5a6591c594012451051627-33"><span class="crayon-e">def </span><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-34"><span class="crayon-h"> </span><span class="crayon-p"># prepare translation table for removing punctuation</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-35"><span class="crayon-h"> </span><span class="crayon-v">table</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">str</span><span class="crayon-sy">.</span><span class="crayon-e">maketrans</span><span class="crayon-sy">(</span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">''</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-sy">.</span><span class="crayon-v">punctuation</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-36"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-37"><span class="crayon-h"> </span><span class="crayon-p"># tokenize</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-38"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-39"><span class="crayon-h"> </span><span class="crayon-p"># convert to lower case</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-40"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">.</span><span class="crayon-e">lower</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-41"><span class="crayon-h"> </span><span class="crayon-p"># remove punctuation from each token</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-42"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">w</span><span class="crayon-sy">.</span><span class="crayon-e">translate</span><span class="crayon-sy">(</span><span class="crayon-v">table</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">w</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-43"><span class="crayon-h"> </span><span class="crayon-p"># remove hanging 's' and 'a'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-44"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-t">word</span><span class="crayon-sy">)</span><span class="crayon-o">&gt;</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-45"><span class="crayon-h"> </span><span class="crayon-p"># store as string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-46"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h">  </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-47"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-48"><span class="crayon-p"># save descriptions to file, one per line</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-49"><span class="crayon-e">def </span><span class="crayon-e">save_doc</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-50"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-51"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-52"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">key</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-53"><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'\n'</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-54"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'w'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-55"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">write</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-56"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-57"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-58"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr8k.token.txt'</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-59"><span class="crayon-p"># load descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-60"><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-61"><span class="crayon-p"># parse descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-62"><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">doc</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-63"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Loaded: %d '</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-64"><span class="crayon-p"># clean descriptions</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-65"><span class="crayon-e">clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-66"><span class="crayon-p"># summarize vocabulary</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-67"><span class="crayon-v">all_tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-68"><span class="crayon-v">vocabulary</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">all_tokens</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-69"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">vocabulary</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594012451051627-70"><span class="crayon-p"># save descriptions</span></div><div class="crayon-line" id="crayon-5a6591c594012451051627-71"><span class="crayon-e">save_doc</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0045 seconds] -->
<p>Running the example first prints the number of loaded photo descriptions (8,092) and the size of the clean vocabulary (4,484 words).</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594016379614211" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Loaded: 8092
Vocabulary Size: 4484</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594016379614211-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594016379614211-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594016379614211-1">Loaded: 8092</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594016379614211-2">Vocabulary Size: 4484</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>The clean descriptions are then written to ‘<em>descriptions.txt</em>‘. Taking a look in the file, we can see that the descriptions are ready for modeling.</p>
<p>Taking a look in the file, we can see that the descriptions are ready for modeling.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59401b461742965" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
3621647714_fc67ab2617 man is standing on snow with trees and mountains all around him
365128300_6966058139 group of people are rafting on river rapids
2751694538_fffa3d307d man and boy sit in the driver seat
537628742_146f2c24f8 little girl running in field
2320125735_27fe729948 black and brown dog with blue collar goes on alert by soccer ball in the grass
...</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59401b461742965-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401b461742965-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59401b461742965-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401b461742965-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59401b461742965-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401b461742965-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59401b461742965-1">3621647714_fc67ab2617 man is standing on snow with trees and mountains all around him</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401b461742965-2">365128300_6966058139 group of people are rafting on river rapids</div><div class="crayon-line" id="crayon-5a6591c59401b461742965-3">2751694538_fffa3d307d man and boy sit in the driver seat</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401b461742965-4">537628742_146f2c24f8 little girl running in field</div><div class="crayon-line" id="crayon-5a6591c59401b461742965-5">2320125735_27fe729948 black and brown dog with blue collar goes on alert by soccer ball in the grass</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401b461742965-6">...</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<h3>Preparing the Photos</h3>
<p>We will use a pre-trained model to interpret the content of the photos.</p>
<p>There are many models to choose from. In this case, we will use the Oxford Visual Geometry Group or VGG model that won the ImageNet competition in 2014. Learn more about the model here:</p>
<ul>
<li><a href="http://www.robots.ox.ac.uk/~vgg/research/very_deep/">Very Deep Convolutional Networks for Large-Scale Visual Recognition</a></li>
</ul>
<p>Keras provides this pre-trained model directly. Note, the first time you use this model, Keras will download the model weights from the Internet, which are about 500 Megabytes. This may take a few minutes depending on your internet connection.</p>
<p>We could use this model as part of a broader image caption model. The problem is, it is a large model and running each photo through the network every time we want to test a new language model configuration (downstream) is redundant.</p>
<p>Instead, we can pre-compute the “photo features” using the pre-trained model and save them to file. We can then load these features later and feed them into our model as the interpretation of a given photo in the dataset. It is no different to running the photo through the full VGG model, it is just that we will have done it once in advance.</p>
<p>This is an optimization that will make training our models faster and consume less memory.</p>
<p>We can load the VGG model in Keras using the VGG class. We will load the model without the top; this means without the layers at the end of the network that are used to interpret the features extracted from the input and turn them into a class prediction. We are not interested in the image net classification of the photos and we will train our own interpretation of the image features.</p>
<p>Keras also provides tools for reshaping the loaded photo into the preferred size for the model (e.g. 3 channel 224 x 224 pixel image).</p>
<p>Below is a function named <em>extract_features()</em> that given a directory name will load each photo, prepare it for VGG and collect the predicted features from the VGG model. The image features are a 3-dimensional array with the shape (7, 7, 512).</p>
<p>The function returns a dictionary of image identifier to image features.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59401f346389369" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# extract features from each photo in the directory
def extract_features(directory):
	# load the model
	in_layer = Input(shape=(224, 224, 3))
	model = VGG16(include_top=False, input_tensor=in_layer)
	print(model.summary())
	# extract features from each photo
	features = dict()
	for name in listdir(directory):
		# load an image from file
		filename = directory + '/' + name
		image = load_img(filename, target_size=(224, 224))
		# convert the image pixels to a numpy array
		image = img_to_array(image)
		# reshape data for the model
		image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
		# prepare the image for the VGG model
		image = preprocess_input(image)
		# get features
		feature = model.predict(image, verbose=0)
		# get image id
		image_id = name.split('.')[0]
		# store feature
		features[image_id] = feature
		print('&gt;%s' % name)
	return features</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59401f346389369-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401f346389369-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59401f346389369-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401f346389369-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59401f346389369-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401f346389369-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59401f346389369-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401f346389369-8">8</div><div class="crayon-num" data-line="crayon-5a6591c59401f346389369-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401f346389369-10">10</div><div class="crayon-num" data-line="crayon-5a6591c59401f346389369-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401f346389369-12">12</div><div class="crayon-num" data-line="crayon-5a6591c59401f346389369-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401f346389369-14">14</div><div class="crayon-num" data-line="crayon-5a6591c59401f346389369-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401f346389369-16">16</div><div class="crayon-num" data-line="crayon-5a6591c59401f346389369-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401f346389369-18">18</div><div class="crayon-num" data-line="crayon-5a6591c59401f346389369-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401f346389369-20">20</div><div class="crayon-num" data-line="crayon-5a6591c59401f346389369-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401f346389369-22">22</div><div class="crayon-num" data-line="crayon-5a6591c59401f346389369-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401f346389369-24">24</div><div class="crayon-num" data-line="crayon-5a6591c59401f346389369-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59401f346389369-26">26</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59401f346389369-1"><span class="crayon-p"># extract features from each photo in the directory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401f346389369-2"><span class="crayon-e">def </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59401f346389369-3"><span class="crayon-h"> </span><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401f346389369-4"><span class="crayon-h"> </span><span class="crayon-v">in_layer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59401f346389369-5"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VGG16</span><span class="crayon-sy">(</span><span class="crayon-v">include_top</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_tensor</span><span class="crayon-o">=</span><span class="crayon-v">in_layer</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401f346389369-6"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59401f346389369-7"><span class="crayon-h"> </span><span class="crayon-p"># extract features from each photo</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401f346389369-8"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59401f346389369-9"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">listdir</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401f346389369-10"><span class="crayon-h"> </span><span class="crayon-p"># load an image from file</span></div><div class="crayon-line" id="crayon-5a6591c59401f346389369-11"><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">name</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401f346389369-12"><span class="crayon-e"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59401f346389369-13"><span class="crayon-h"> </span><span class="crayon-p"># convert the image pixels to a numpy array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401f346389369-14"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59401f346389369-15"><span class="crayon-h"> </span><span class="crayon-p"># reshape data for the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401f346389369-16"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59401f346389369-17"><span class="crayon-h"> </span><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401f346389369-18"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59401f346389369-19"><span class="crayon-h"> </span><span class="crayon-p"># get features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401f346389369-20"><span class="crayon-h"> </span><span class="crayon-v">feature</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59401f346389369-21"><span class="crayon-h"> </span><span class="crayon-p"># get image id</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401f346389369-22"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59401f346389369-23"><span class="crayon-h"> </span><span class="crayon-p"># store feature</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401f346389369-24"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">feature</span></div><div class="crayon-line" id="crayon-5a6591c59401f346389369-25"><span class="crayon-e"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'&gt;%s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59401f346389369-26"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0025 seconds] -->
<p>We can call this function to prepare the photo data for testing our models, then save the resulting dictionary to a file named ‘<em>features.pkl</em>‘.</p>
<p>The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594022374417648" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from os import listdir
from pickle import dump
from keras.applications.vgg16 import VGG16
from keras.preprocessing.image import load_img
from keras.preprocessing.image import img_to_array
from keras.applications.vgg16 import preprocess_input
from keras.layers import Input

# extract features from each photo in the directory
def extract_features(directory):
	# load the model
	in_layer = Input(shape=(224, 224, 3))
	model = VGG16(include_top=False, input_tensor=in_layer)
	print(model.summary())
	# extract features from each photo
	features = dict()
	for name in listdir(directory):
		# load an image from file
		filename = directory + '/' + name
		image = load_img(filename, target_size=(224, 224))
		# convert the image pixels to a numpy array
		image = img_to_array(image)
		# reshape data for the model
		image = image.reshape((1, image.shape[0], image.shape[1], image.shape[2]))
		# prepare the image for the VGG model
		image = preprocess_input(image)
		# get features
		feature = model.predict(image, verbose=0)
		# get image id
		image_id = name.split('.')[0]
		# store feature
		features[image_id] = feature
		print('&gt;%s' % name)
	return features

# extract features from all images
directory = 'Flicker8k_Dataset'
features = extract_features(directory)
print('Extracted Features: %d' % len(features))
# save to file
dump(features, open('features.pkl', 'wb'))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594022374417648-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-14">14</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-16">16</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-18">18</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-20">20</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-22">22</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-24">24</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-26">26</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-28">28</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-30">30</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-32">32</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-34">34</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-36">36</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-38">38</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594022374417648-40">40</div><div class="crayon-num" data-line="crayon-5a6591c594022374417648-41">41</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594022374417648-1"><span class="crayon-e">from </span><span class="crayon-e">os </span><span class="crayon-e">import </span><span class="crayon-e">listdir</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-2"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-e">dump</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-3"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">VGG16</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">load_img</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">img_to_array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-6"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">preprocess_input</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-7"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-v">Input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-8"> </div><div class="crayon-line" id="crayon-5a6591c594022374417648-9"><span class="crayon-p"># extract features from each photo in the directory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-10"><span class="crayon-e">def </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-11"><span class="crayon-h"> </span><span class="crayon-p"># load the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-12"><span class="crayon-h"> </span><span class="crayon-v">in_layer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">3</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-13"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">VGG16</span><span class="crayon-sy">(</span><span class="crayon-v">include_top</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_tensor</span><span class="crayon-o">=</span><span class="crayon-v">in_layer</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-14"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-15"><span class="crayon-h"> </span><span class="crayon-p"># extract features from each photo</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-16"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-17"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">listdir</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-18"><span class="crayon-h"> </span><span class="crayon-p"># load an image from file</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-19"><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">name</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-20"><span class="crayon-e"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_img</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">target_size</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">224</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">224</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-21"><span class="crayon-h"> </span><span class="crayon-p"># convert the image pixels to a numpy array</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-22"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">img_to_array</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-23"><span class="crayon-h"> </span><span class="crayon-p"># reshape data for the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-24"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-25"><span class="crayon-h"> </span><span class="crayon-p"># prepare the image for the VGG model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-26"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">preprocess_input</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-27"><span class="crayon-h"> </span><span class="crayon-p"># get features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-28"><span class="crayon-h"> </span><span class="crayon-v">feature</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-29"><span class="crayon-h"> </span><span class="crayon-p"># get image id</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-30"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-31"><span class="crayon-h"> </span><span class="crayon-p"># store feature</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-32"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">feature</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-33"><span class="crayon-e"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'&gt;%s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-34"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-35"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-36"><span class="crayon-p"># extract features from all images</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-37"><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flicker8k_Dataset'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-38"><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">extract_features</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-39"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Extracted Features: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594022374417648-40"><span class="crayon-p"># save to file</span></div><div class="crayon-line" id="crayon-5a6591c594022374417648-41"><span class="crayon-e">dump</span><span class="crayon-sy">(</span><span class="crayon-v">features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0031 seconds] -->
<p>Running this data preparation step may take a while depending on your hardware, perhaps one hour on the CPU with a modern workstation.</p>
<p>At the end of the run, you will have the extracted features stored in ‘<em>features.pkl</em>‘ for later use.</p>
<h2>Baseline Caption Generation Model</h2>
<p>In this section, we will define a baseline model for generating captions for photos and how to evaluate it so that it can be compared to variations on this baseline.</p>
<p>This section is divided into 5 parts:</p>
<ol>
<li>Load Data.</li>
<li>Fit Model.</li>
<li>Evaluate Model.</li>
<li>Complete Example</li>
<li>“A” versus “A” Test</li>
<li>Generate Photo Captions</li>
</ol>
<h3>1. Load Data</h3>
<p>We are not going to fit the model on all of the caption data, or even on a large sample of the data.</p>
<p>In this tutorial, we are interested in quickly testing a suite of different configurations of a caption model to see what works on this data. That means we need the evaluation of one model configuration to happen quickly. Toward this end, we will train the models on 100 photographs and captions, then evaluate them on both the training dataset and on a new test set of 100 photographs and captions.</p>
<p>First, we need to load a pre-defined subset of photographs. The provided dataset has separate sets for train, test, and development, which are really just different groups of photo identifiers. We will load the development set and use the first 100 identifiers for train and the second 100 (e.g. from 100 to 200) as the test set.</p>
<p>The function <em>load_set()</em> below will load a pre-defined set of identifiers, and we will call it with the ‘<em>Flickr_8k.devImages.txt</em>‘ filename as an argument.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594026324866335" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594026324866335-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594026324866335-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594026324866335-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594026324866335-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594026324866335-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594026324866335-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594026324866335-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594026324866335-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594026324866335-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594026324866335-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594026324866335-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594026324866335-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594026324866335-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594026324866335-1"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594026324866335-2"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594026324866335-3"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594026324866335-4"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594026324866335-5"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594026324866335-6"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594026324866335-7"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594026324866335-8"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594026324866335-9"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594026324866335-10"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line" id="crayon-5a6591c594026324866335-11"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594026324866335-12"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594026324866335-13"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0011 seconds] -->
<p>Next, we need to split the set into train and test sets.</p>
<p>We will start by ordering the identifiers by sorting them to ensure we always split them consistently across machines and runs, then take the first 100 for train and the next 100 for test.</p>
<p>The <em>train_test_split()</em> function below will create this split given the loaded set of identifiers as input.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594029894453700" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# split a dataset into train/test elements
def train_test_split(dataset):
	# order keys so the split is consistent
	ordered = sorted(dataset)
	# return split dataset as two new sets
	return set(ordered[:100]), set(ordered[100:200])</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594029894453700-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594029894453700-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594029894453700-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594029894453700-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594029894453700-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594029894453700-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594029894453700-1"><span class="crayon-p"># split a dataset into train/test elements</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594029894453700-2"><span class="crayon-e">def </span><span class="crayon-e">train_test_split</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594029894453700-3"><span class="crayon-h"> </span><span class="crayon-p"># order keys so the split is consistent</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594029894453700-4"><span class="crayon-h"> </span><span class="crayon-v">ordered</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sorted</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594029894453700-5"><span class="crayon-h"> </span><span class="crayon-p"># return split dataset as two new sets</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594029894453700-6"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">ordered</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-cn">100</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">ordered</span><span class="crayon-sy">[</span><span class="crayon-cn">100</span><span class="crayon-o">:</span><span class="crayon-cn">200</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>Now, we can load the photo descriptions using the pre-defined set of train or test identifiers.</p>
<p>Below is the function <em>load_clean_descriptions()</em> that loads the cleaned text descriptions from ‘<em>descriptions.txt</em>‘ for a given set of identifiers and returns a dictionary of identifier to text.</p>
<p>The model we will develop will generate a caption given a photo, and the caption will be generated one word at a time. The sequence of previously generated words will be provided as input. Therefore, we will need a “<em>first word</em>” to kick-off the generation process and a ‘<em>last word</em>‘ to signal the end of the caption. We will use the strings ‘<em>startseq</em>‘ and ‘<em>endseq</em>‘ for this purpose.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59402c425356275" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# store
			descriptions[image_id] = 'startseq ' + ' '.join(image_desc) + ' endseq'
	return descriptions</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59402c425356275-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59402c425356275-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59402c425356275-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59402c425356275-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59402c425356275-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59402c425356275-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59402c425356275-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59402c425356275-8">8</div><div class="crayon-num" data-line="crayon-5a6591c59402c425356275-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59402c425356275-10">10</div><div class="crayon-num" data-line="crayon-5a6591c59402c425356275-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59402c425356275-12">12</div><div class="crayon-num" data-line="crayon-5a6591c59402c425356275-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59402c425356275-14">14</div><div class="crayon-num" data-line="crayon-5a6591c59402c425356275-15">15</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59402c425356275-1"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59402c425356275-2"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59402c425356275-3"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59402c425356275-4"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59402c425356275-5"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59402c425356275-6"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59402c425356275-7"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59402c425356275-8"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59402c425356275-9"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59402c425356275-10"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59402c425356275-11"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59402c425356275-12"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59402c425356275-13"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59402c425356275-14"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line" id="crayon-5a6591c59402c425356275-15"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>Next, we can load the photo features for a given dataset.</p>
<p>Below defines a function named <em>load_photo_features()</em> that loads the entire set of photo descriptions, then returns the subset of interest for a given set of photo identifiers. This is not very efficient as the loaded dictionary of all photo features is about 700 Megabytes. Nevertheless, this will get us up and running quickly.</p>
<p>Note, if you have a better approach, share it in the comments below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59402f274113877" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load photo features
def load_photo_features(filename, dataset):
	# load all features
	all_features = load(open(filename, 'rb'))
	# filter features
	features = {k: all_features[k] for k in dataset}
	return features</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59402f274113877-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59402f274113877-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59402f274113877-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59402f274113877-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59402f274113877-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59402f274113877-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59402f274113877-7">7</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59402f274113877-1"><span class="crayon-p"># load photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59402f274113877-2"><span class="crayon-e">def </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59402f274113877-3"><span class="crayon-h"> </span><span class="crayon-p"># load all features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59402f274113877-4"><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59402f274113877-5"><span class="crayon-h"> </span><span class="crayon-p"># filter features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59402f274113877-6"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">k</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">k</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5a6591c59402f274113877-7"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>We can pause here and test everything developed so far.</p>
<p>The complete code example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594032979141558" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from pickle import load

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)

# split a dataset into train/test elements
def train_test_split(dataset):
	# order keys so the split is consistent
	ordered = sorted(dataset)
	# return split dataset as two new sets
	return set(ordered[:100]), set(ordered[100:200])

# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# store
			descriptions[image_id] = 'startseq ' + ' '.join(image_desc) + ' endseq'
	return descriptions

# load photo features
def load_photo_features(filename, dataset):
	# load all features
	all_features = load(open(filename, 'rb'))
	# filter features
	features = {k: all_features[k] for k in dataset}
	return features

# load dev set
filename = 'Flickr8k_text/Flickr_8k.devImages.txt'
dataset = load_set(filename)
print('Dataset: %d' % len(dataset))
# train-test split
train, test = train_test_split(dataset)
print('Train=%d, Test=%d' % (len(train), len(test)))
# descriptions
train_descriptions = load_clean_descriptions('descriptions.txt', train)
test_descriptions = load_clean_descriptions('descriptions.txt', test)
print('Descriptions: train=%d, test=%d' % (len(train_descriptions), len(test_descriptions)))
# photo features
train_features = load_photo_features('features.pkl', train)
test_features = load_photo_features('features.pkl', test)
print('Photos: train=%d, test=%d' % (len(train_features), len(test_features)))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594032979141558-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-14">14</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-16">16</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-18">18</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-20">20</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-22">22</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-24">24</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-26">26</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-28">28</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-30">30</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-32">32</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-34">34</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-36">36</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-38">38</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-40">40</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-42">42</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-44">44</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-46">46</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-48">48</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-50">50</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-52">52</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-54">54</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-56">56</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-58">58</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-60">60</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-62">62</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-64">64</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-66">66</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-68">68</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-70">70</div><div class="crayon-num" data-line="crayon-5a6591c594032979141558-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594032979141558-72">72</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594032979141558-1"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-v">load</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-2"> </div><div class="crayon-line" id="crayon-5a6591c594032979141558-3"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-4"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-5"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-6"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-7"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-8"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-9"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-10"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-11"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-12"> </div><div class="crayon-line" id="crayon-5a6591c594032979141558-13"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-14"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-15"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-16"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-17"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-18"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-19"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-20"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-21"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-22"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-23"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-24"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-25"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-26"> </div><div class="crayon-line" id="crayon-5a6591c594032979141558-27"><span class="crayon-p"># split a dataset into train/test elements</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-28"><span class="crayon-e">def </span><span class="crayon-e">train_test_split</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-29"><span class="crayon-h"> </span><span class="crayon-p"># order keys so the split is consistent</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-30"><span class="crayon-h"> </span><span class="crayon-v">ordered</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sorted</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-31"><span class="crayon-h"> </span><span class="crayon-p"># return split dataset as two new sets</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-32"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">ordered</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-cn">100</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">ordered</span><span class="crayon-sy">[</span><span class="crayon-cn">100</span><span class="crayon-o">:</span><span class="crayon-cn">200</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-33"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-34"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-35"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-36"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-37"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-38"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-39"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-40"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-41"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-42"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-43"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-44"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-45"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-46"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-47"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-48"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-49"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-50"><span class="crayon-p"># load photo features</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-51"><span class="crayon-e">def </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-52"><span class="crayon-h"> </span><span class="crayon-p"># load all features</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-53"><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-54"><span class="crayon-h"> </span><span class="crayon-p"># filter features</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-55"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">k</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">k</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-56"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-57"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-58"><span class="crayon-p"># load dev set</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-59"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.devImages.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-60"><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-61"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-62"><span class="crayon-p"># train-test split</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-63"><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">train_test_split</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-64"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Train=%d, Test=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-65"><span class="crayon-p"># descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-66"><span class="crayon-v">train_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-67"><span class="crayon-v">test_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-68"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: train=%d, test=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-69"><span class="crayon-p"># photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-70"><span class="crayon-v">train_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594032979141558-71"><span class="crayon-v">test_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594032979141558-72"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Photos: train=%d, test=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_features</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0044 seconds] -->
<p>Running this example first loads the 1,000 photo identifiers in the development dataset. A train and test set is selected and used to filter the set of clean photo descriptions and prepared image features.</p>
<p>We are nearly there.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594035559024259" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Dataset: 1,000
Train=100, Test=100
Descriptions: train=100, test=100
Photos: train=100, test=100</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594035559024259-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594035559024259-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594035559024259-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594035559024259-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594035559024259-1">Dataset: 1,000</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594035559024259-2">Train=100, Test=100</div><div class="crayon-line" id="crayon-5a6591c594035559024259-3">Descriptions: train=100, test=100</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594035559024259-4">Photos: train=100, test=100</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>The description text will need to be encoded to numbers before it can be presented to the model as in input or compared to the model’s predictions.</p>
<p>The first step in encoding the data is to create a consistent mapping from words to unique integer values. Keras provides the Tokenizer class that can learn this mapping from the loaded description data.</p>
<p>Below defines the <em>create_tokenizer()</em> that will fit a Tokenizer given the loaded photo description text.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594038316702773" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# fit a tokenizer given caption descriptions
def create_tokenizer(descriptions):
	lines = list(descriptions.values())
	tokenizer = Tokenizer()
	tokenizer.fit_on_texts(lines)
	return tokenizer

# prepare tokenizer
tokenizer = create_tokenizer(descriptions)
vocab_size = len(tokenizer.word_index) + 1
print('Vocabulary Size: %d' % vocab_size)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594038316702773-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594038316702773-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594038316702773-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594038316702773-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594038316702773-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594038316702773-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594038316702773-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594038316702773-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594038316702773-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594038316702773-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594038316702773-11">11</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594038316702773-1"><span class="crayon-p"># fit a tokenizer given caption descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594038316702773-2"><span class="crayon-e">def </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594038316702773-3"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594038316702773-4"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594038316702773-5"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594038316702773-6"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span></div><div class="crayon-line" id="crayon-5a6591c594038316702773-7"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594038316702773-8"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line" id="crayon-5a6591c594038316702773-9"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594038316702773-10"><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a6591c594038316702773-11"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>We can now encode the text.</p>
<p>Each description will be split into words. The model will be provided one word and the photo and generate the next word. Then the first two words of the description will be provided to the model as input with the image to generate the next word. This is how the model will be trained.</p>
<p>For example, the input sequence “<em>little girl running in field</em>” would be split into 6 input-output pairs to train the model:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59403b242587789" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
X1,		X2 (text sequence), 						y (word)
photo	startseq, 									little
photo	startseq, little,							girl
photo	startseq, little, girl, 					running
photo	startseq, little, girl, running, 			in
photo	startseq, little, girl, running, in, 		field
photo	startseq, little, girl, running, in, field, endseq</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59403b242587789-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59403b242587789-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59403b242587789-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59403b242587789-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59403b242587789-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59403b242587789-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59403b242587789-7">7</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59403b242587789-1">X1,		X2 (text sequence), 						y (word)</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59403b242587789-2">photo	startseq, 									little</div><div class="crayon-line" id="crayon-5a6591c59403b242587789-3">photo	startseq, little,							girl</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59403b242587789-4">photo	startseq, little, girl, 					running</div><div class="crayon-line" id="crayon-5a6591c59403b242587789-5">photo	startseq, little, girl, running, 			in</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59403b242587789-6">photo	startseq, little, girl, running, in, 		field</div><div class="crayon-line" id="crayon-5a6591c59403b242587789-7">photo	startseq, little, girl, running, in, field, endseq</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Later when the model is used to generate descriptions, the generated words will be concatenated and recursively provided as input to generate a caption for an image.</p>
<p>The function below named <em>create_sequences()</em> given the tokenizer, a single clean description, the features for a photo, and the maximum description length will prepare a set of input-output pairs for training a model. Calling this function will return <em>X1</em> and <em>X2</em> for the arrays of image data and input sequence data and the <em>y </em>value for the output word.</p>
<p>The input sequences are integer encoded and the output word is one-hot encoded to represent the probability distribution of the expected word across the whole vocabulary of possible words.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59403e885492617" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# create sequences of images, input sequences and output words for an image
def create_sequences(tokenizer, desc, image, max_length):
	Ximages, XSeq, y = list(), list(),list()
	vocab_size = len(tokenizer.word_index) + 1
	# integer encode the description
	seq = tokenizer.texts_to_sequences([desc])[0]
	# split one sequence into multiple X,y pairs
	for i in range(1, len(seq)):
		# select
		in_seq, out_seq = seq[:i], seq[i]
		# pad input sequence
		in_seq = pad_sequences([in_seq], maxlen=max_length)[0]
		# encode output sequence
		out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]
		# store
		Ximages.append(image)
		XSeq.append(in_seq)
		y.append(out_seq)
	# Ximages, XSeq, y = array(Ximages), array(XSeq), array(y)
	return [Ximages, XSeq, y]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59403e885492617-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59403e885492617-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59403e885492617-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59403e885492617-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59403e885492617-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59403e885492617-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59403e885492617-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59403e885492617-8">8</div><div class="crayon-num" data-line="crayon-5a6591c59403e885492617-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59403e885492617-10">10</div><div class="crayon-num" data-line="crayon-5a6591c59403e885492617-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59403e885492617-12">12</div><div class="crayon-num" data-line="crayon-5a6591c59403e885492617-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59403e885492617-14">14</div><div class="crayon-num" data-line="crayon-5a6591c59403e885492617-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59403e885492617-16">16</div><div class="crayon-num" data-line="crayon-5a6591c59403e885492617-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59403e885492617-18">18</div><div class="crayon-num" data-line="crayon-5a6591c59403e885492617-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59403e885492617-20">20</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59403e885492617-1"><span class="crayon-p"># create sequences of images, input sequences and output words for an image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59403e885492617-2"><span class="crayon-e">def </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59403e885492617-3"><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59403e885492617-4"><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a6591c59403e885492617-5"><span class="crayon-h"> </span><span class="crayon-p"># integer encode the description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59403e885492617-6"><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">desc</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59403e885492617-7"><span class="crayon-h"> </span><span class="crayon-p"># split one sequence into multiple X,y pairs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59403e885492617-8"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">seq</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59403e885492617-9"><span class="crayon-h"> </span><span class="crayon-p"># select</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59403e885492617-10"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59403e885492617-11"><span class="crayon-h"> </span><span class="crayon-p"># pad input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59403e885492617-12"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59403e885492617-13"><span class="crayon-h"> </span><span class="crayon-p"># encode output sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59403e885492617-14"><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59403e885492617-15"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59403e885492617-16"><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59403e885492617-17"><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59403e885492617-18"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">out_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59403e885492617-19"><span class="crayon-h"> </span><span class="crayon-p"># Ximages, XSeq, y = array(Ximages), array(XSeq), array(y)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59403e885492617-20"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">Ximages</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0022 seconds] -->
<p></p>
<h3>2. Fit Model</h3>
<p>We are nearly ready to fit the model.</p>
<p>Parts of the model have already been discussed, but let’s re-iterate.</p>
<p>The model is based on the example laid out in the paper “<a href="https://arxiv.org/abs/1411.4555">Show and Tell: A Neural Image Caption Generator</a>“, 2015.</p>
<p>The model involves three parts:</p>
<ul>
<li><strong>Photo Feature Extractor</strong>. This is a 16-layer VGG model pre-trained on the ImageNet dataset. We have pre-processed the photos with a the VGG model (without the top) and will use the extracted features predicted by this model as input.</li>
<li><strong>Sequence Processor</strong>. This is a word embedding layer for handling the text input, followed by an LSTM layer. The LSTM output is interpreted by a Dense layer one output at a time.</li>
<li><strong>Interpreter (for lack of a better name)</strong>. Both the feature extractor and sequence processor output a fixed-length vector that is the length of a maximum sequence. These are concatenated together and processed by an LSTM and Dense layer before a final prediction is made.</li>
</ul>
<p>A conservative number of neurons is used in the base model. Specifically, a 128 Dense layer after the feature extractor, a 50-dimensionality word embedding followed by a 256 unit LSTM and 128 neuron Dense after the sequence processor, and finally a 500 unit LSTM followed by a 500 neuron Dense at the end of the network.</p>
<p>The model predicts a probability distribution across the vocabulary, therefore a softmax activation function is used and a categorical cross entropy loss function is minimized while fitting the network.</p>
<p>The function <em>define_model()</em> defines the baseline model, given the size of the vocabulary and the maximum length of photo descriptions. The Keras functional API is used to define the model as it provides the flexibility needed to define a model that takes two input streams and combines them.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594042171736506" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor (encoder)
	inputs1 = Input(shape=(7, 7, 512))
	fe1 = GlobalMaxPooling2D()(inputs1)
	fe2 = Dense(128, activation='relu')(fe1)
	fe3 = RepeatVector(max_length)(fe2)
	# embedding
	inputs2 = Input(shape=(max_length,))
	emb2 = Embedding(vocab_size, 50, mask_zero=True)(inputs2)
	emb3 = LSTM(256, return_sequences=True)(emb2)
	emb4 = TimeDistributed(Dense(128, activation='relu'))(emb3)
	# merge inputs
	merged = concatenate([fe3, emb4])
	# language model (decoder)
	lm2 = LSTM(500)(merged)
	lm3 = Dense(500, activation='relu')(lm2)
	outputs = Dense(vocab_size, activation='softmax')(lm3)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
	print(model.summary())
	plot_model(model, show_shapes=True, to_file='plot.png')
	return model</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594042171736506-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594042171736506-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594042171736506-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594042171736506-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594042171736506-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594042171736506-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594042171736506-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594042171736506-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594042171736506-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594042171736506-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594042171736506-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594042171736506-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594042171736506-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594042171736506-14">14</div><div class="crayon-num" data-line="crayon-5a6591c594042171736506-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594042171736506-16">16</div><div class="crayon-num" data-line="crayon-5a6591c594042171736506-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594042171736506-18">18</div><div class="crayon-num" data-line="crayon-5a6591c594042171736506-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594042171736506-20">20</div><div class="crayon-num" data-line="crayon-5a6591c594042171736506-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594042171736506-22">22</div><div class="crayon-num" data-line="crayon-5a6591c594042171736506-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594042171736506-24">24</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594042171736506-1"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594042171736506-2"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594042171736506-3"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor (encoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594042171736506-4"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">512</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594042171736506-5"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">GlobalMaxPooling2D</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594042171736506-6"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594042171736506-7"><span class="crayon-h"> </span><span class="crayon-v">fe3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594042171736506-8"><span class="crayon-h"> </span><span class="crayon-p"># embedding</span></div><div class="crayon-line" id="crayon-5a6591c594042171736506-9"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594042171736506-10"><span class="crayon-h"> </span><span class="crayon-v">emb2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594042171736506-11"><span class="crayon-h"> </span><span class="crayon-v">emb3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594042171736506-12"><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594042171736506-13"><span class="crayon-h"> </span><span class="crayon-p"># merge inputs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594042171736506-14"><span class="crayon-h"> </span><span class="crayon-v">merged</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concatenate</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594042171736506-15"><span class="crayon-h"> </span><span class="crayon-p"># language model (decoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594042171736506-16"><span class="crayon-h"> </span><span class="crayon-v">lm2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">merged</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594042171736506-17"><span class="crayon-h"> </span><span class="crayon-v">lm3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594042171736506-18"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594042171736506-19"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594042171736506-20"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594042171736506-21"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'accuracy'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594042171736506-22"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594042171736506-23"><span class="crayon-h"> </span><span class="crayon-e">plot_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">show_shapes</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">to_file</span><span class="crayon-o">=</span><span class="crayon-s">'plot.png'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594042171736506-24"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0027 seconds] -->
<p>To get a sense for the structure of the model, specifically the shapes of the layers, see the summary listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594046761052369" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
____________________________________________________________________________________________________
Layer (type)                     Output Shape          Param #     Connected to
====================================================================================================
input_1 (InputLayer)             (None, 7, 7, 512)     0
____________________________________________________________________________________________________
input_2 (InputLayer)             (None, 25)            0
____________________________________________________________________________________________________
global_max_pooling2d_1 (GlobalMa (None, 512)           0           input_1[0][0]
____________________________________________________________________________________________________
embedding_1 (Embedding)          (None, 25, 50)        18300       input_2[0][0]
____________________________________________________________________________________________________
dense_1 (Dense)                  (None, 128)           65664       global_max_pooling2d_1[0][0]
____________________________________________________________________________________________________
lstm_1 (LSTM)                    (None, 25, 256)       314368      embedding_1[0][0]
____________________________________________________________________________________________________
repeat_vector_1 (RepeatVector)   (None, 25, 128)       0           dense_1[0][0]
____________________________________________________________________________________________________
time_distributed_1 (TimeDistribu (None, 25, 128)       32896       lstm_1[0][0]
____________________________________________________________________________________________________
concatenate_1 (Concatenate)      (None, 25, 256)       0           repeat_vector_1[0][0]
                                                                   time_distributed_1[0][0]
____________________________________________________________________________________________________
lstm_2 (LSTM)                    (None, 500)           1514000     concatenate_1[0][0]
____________________________________________________________________________________________________
dense_3 (Dense)                  (None, 500)           250500      lstm_2[0][0]
____________________________________________________________________________________________________
dense_4 (Dense)                  (None, 366)           183366      dense_3[0][0]
====================================================================================================
Total params: 2,379,094
Trainable params: 2,379,094
Non-trainable params: 0
____________________________________________________________________________________________________</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594046761052369-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-14">14</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-16">16</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-18">18</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-20">20</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-22">22</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-24">24</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-26">26</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-28">28</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-30">30</div><div class="crayon-num" data-line="crayon-5a6591c594046761052369-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594046761052369-32">32</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594046761052369-1">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-2">Layer (type)                     Output Shape          Param #     Connected to</div><div class="crayon-line" id="crayon-5a6591c594046761052369-3">====================================================================================================</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-4">input_1 (InputLayer)             (None, 7, 7, 512)     0</div><div class="crayon-line" id="crayon-5a6591c594046761052369-5">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-6">input_2 (InputLayer)             (None, 25)            0</div><div class="crayon-line" id="crayon-5a6591c594046761052369-7">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-8">global_max_pooling2d_1 (GlobalMa (None, 512)           0           input_1[0][0]</div><div class="crayon-line" id="crayon-5a6591c594046761052369-9">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-10">embedding_1 (Embedding)          (None, 25, 50)        18300       input_2[0][0]</div><div class="crayon-line" id="crayon-5a6591c594046761052369-11">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-12">dense_1 (Dense)                  (None, 128)           65664       global_max_pooling2d_1[0][0]</div><div class="crayon-line" id="crayon-5a6591c594046761052369-13">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-14">lstm_1 (LSTM)                    (None, 25, 256)       314368      embedding_1[0][0]</div><div class="crayon-line" id="crayon-5a6591c594046761052369-15">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-16">repeat_vector_1 (RepeatVector)   (None, 25, 128)       0           dense_1[0][0]</div><div class="crayon-line" id="crayon-5a6591c594046761052369-17">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-18">time_distributed_1 (TimeDistribu (None, 25, 128)       32896       lstm_1[0][0]</div><div class="crayon-line" id="crayon-5a6591c594046761052369-19">____________________________________________________________________________________________________</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-20">concatenate_1 (Concatenate)      (None, 25, 256)       0           repeat_vector_1[0][0]</div><div class="crayon-line" id="crayon-5a6591c594046761052369-21">                                                                   time_distributed_1[0][0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-22">____________________________________________________________________________________________________</div><div class="crayon-line" id="crayon-5a6591c594046761052369-23">lstm_2 (LSTM)                    (None, 500)           1514000     concatenate_1[0][0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-24">____________________________________________________________________________________________________</div><div class="crayon-line" id="crayon-5a6591c594046761052369-25">dense_3 (Dense)                  (None, 500)           250500      lstm_2[0][0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-26">____________________________________________________________________________________________________</div><div class="crayon-line" id="crayon-5a6591c594046761052369-27">dense_4 (Dense)                  (None, 366)           183366      dense_3[0][0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-28">====================================================================================================</div><div class="crayon-line" id="crayon-5a6591c594046761052369-29">Total params: 2,379,094</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-30">Trainable params: 2,379,094</div><div class="crayon-line" id="crayon-5a6591c594046761052369-31">Non-trainable params: 0</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594046761052369-32">____________________________________________________________________________________________________</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>We also create a plot to visualize the structure of the network that better helps understand the two streams of input.</p>
<div class="wp-caption aligncenter" id="attachment_4451" style="max-width: 1231px"><img alt="Plot of the Baseline Captioning Deep Learning Model" class="size-full wp-image-4451" height="848" sizes="(max-width: 1221px) 100vw, 1221px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Network-Graph-Plot-of-Baseline-Captioning-Model.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Network-Graph-Plot-of-Baseline-Captioning-Model.png 1221w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Network-Graph-Plot-of-Baseline-Captioning-Model-300x208.png 300w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Network-Graph-Plot-of-Baseline-Captioning-Model-768x533.png 768w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Network-Graph-Plot-of-Baseline-Captioning-Model-1024x711.png 1024w" width="1221"/><p class="wp-caption-text">Plot of the Baseline Captioning Deep Learning Model</p></div>
<p>We will train the model using a data generator. This is strictly not required given that the captions and extracted photo features can probably fit into memory as a single dataset. Nevertheless, it is good practice for when you come to train the final model on the entire dataset.</p>
<p>A generator will yield a result when called. In Keras, it will yield a single batch of input-output samples that are used to estimate the error gradient and update the model weights.</p>
<p>The function <em>data_generator()</em> defines the data generator, given a dictionary of loaded photo descriptions, photo features, the tokenizer for integer encoding sequences, and the maximum sequence length in the dataset.</p>
<p>The generator loops forever and keeps yielding batches of input-output pairs when asked. We also have a <em>n_step</em> parameter that allows us to tune how many images worth of input-output pairs to generate for each batch. The average sequence has 10 words, that is 10 input-output pairs, and a good batch size might be 30 samples, which is about 2-to-3 images worth.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59404b254977731" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# data generator, intended to be used in a call to model.fit_generator()
def data_generator(descriptions, features, tokenizer, max_length, n_step):
	# loop until we finish training
	while 1:
		# loop over photo identifiers in the dataset
		keys = list(descriptions.keys())
		for i in range(0, len(keys), n_step):
			Ximages, XSeq, y = list(), list(),list()
			for j in range(i, min(len(keys), i+n_step)):
				image_id = keys[j]
				# retrieve photo feature input
				image = features[image_id][0]
				# retrieve text input
				desc = descriptions[image_id]
				# generate input-output pairs
				in_img, in_seq, out_word = create_sequences(tokenizer, desc, image, max_length)
				for k in range(len(in_img)):
					Ximages.append(in_img[k])
					XSeq.append(in_seq[k])
					y.append(out_word[k])
			# yield this batch of samples to the model
			yield [[array(Ximages), array(XSeq)], array(y)]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59404b254977731-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59404b254977731-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59404b254977731-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59404b254977731-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59404b254977731-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59404b254977731-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59404b254977731-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59404b254977731-8">8</div><div class="crayon-num" data-line="crayon-5a6591c59404b254977731-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59404b254977731-10">10</div><div class="crayon-num" data-line="crayon-5a6591c59404b254977731-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59404b254977731-12">12</div><div class="crayon-num" data-line="crayon-5a6591c59404b254977731-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59404b254977731-14">14</div><div class="crayon-num" data-line="crayon-5a6591c59404b254977731-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59404b254977731-16">16</div><div class="crayon-num" data-line="crayon-5a6591c59404b254977731-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59404b254977731-18">18</div><div class="crayon-num" data-line="crayon-5a6591c59404b254977731-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59404b254977731-20">20</div><div class="crayon-num" data-line="crayon-5a6591c59404b254977731-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59404b254977731-22">22</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59404b254977731-1"><span class="crayon-p"># data generator, intended to be used in a call to model.fit_generator()</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59404b254977731-2"><span class="crayon-e">def </span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_step</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59404b254977731-3"><span class="crayon-h"> </span><span class="crayon-p"># loop until we finish training</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59404b254977731-4"><span class="crayon-h"> </span><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59404b254977731-5"><span class="crayon-h"> </span><span class="crayon-p"># loop over photo identifiers in the dataset</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59404b254977731-6"><span class="crayon-h"> </span><span class="crayon-v">keys</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59404b254977731-7"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">keys</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_step</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59404b254977731-8"><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59404b254977731-9"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">j</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">min</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">keys</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">+</span><span class="crayon-v">n_step</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59404b254977731-10"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">keys</span><span class="crayon-sy">[</span><span class="crayon-v">j</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59404b254977731-11"><span class="crayon-h"> </span><span class="crayon-p"># retrieve photo feature input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59404b254977731-12"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59404b254977731-13"><span class="crayon-h"> </span><span class="crayon-p"># retrieve text input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59404b254977731-14"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59404b254977731-15"><span class="crayon-h"> </span><span class="crayon-p"># generate input-output pairs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59404b254977731-16"><span class="crayon-h"> </span><span class="crayon-v">in_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59404b254977731-17"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">k</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">in_img</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59404b254977731-18"><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_img</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59404b254977731-19"><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_seq</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59404b254977731-20"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">out_word</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59404b254977731-21"><span class="crayon-h"> </span><span class="crayon-p"># yield this batch of samples to the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59404b254977731-22"><span class="crayon-h"> </span><span class="crayon-i">yield</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">Ximages</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">XSeq</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0023 seconds] -->
<p>The model can be fit by calling <em>fit_generator()</em> and passing it to the data generator, along with all of the parameters needed. When fitting the model, we can also specify the number of batches to run per epoch and the number of epochs.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59404e147480260" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
model.fit_generator(data_generator(train_descriptions, train_features, tokenizer, max_length, n_photos_per_update), steps_per_epoch=n_batches_per_epoch, epochs=n_epochs, verbose=verbose)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59404e147480260-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59404e147480260-1"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit_generator</span><span class="crayon-sy">(</span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_photos_per_update</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">steps_per_epoch</span><span class="crayon-o">=</span><span class="crayon-v">n_batches_per_epoch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-v">verbose</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0005 seconds] -->
<p>For these experiments, we will use 2 images per batch, 50 batches (or 100 images) per epoch, and 50 training epochs. You can experiment with different configurations in your own experiments.</p>
<h3>3. Evaluate Model</h3>
<p>Now that we know how to prepare the data and define a model, we must define a test harness to evaluate a given model.</p>
<p>We will evaluate a model by training it on the dataset, generating descriptions for all photos in the training dataset, evaluating those predictions with a cost function, and then repeating this evaluation process multiple times.</p>
<p>The outcome will be a distribution of skill scores for the model that we can summarize by calculating the mean and standard deviation. This is the preferred way to evaluate deep learning models. See this post:</p>
<ul>
<li><a href="https://machinelearningmastery.com/evaluate-skill-deep-learning-models/">How to Evaluate the Skill of Deep Learning Models</a></li>
</ul>
<p>First, we need to be able to generate a description for a photo using a trained model.</p>
<p>This involves passing in the start description token ‘<em>startseq</em>‘, generating one word, then calling the model recursively with generated words as input until the end of sequence token is reached ‘<em>endseq</em>‘ or the maximum description length is reached.</p>
<p>The function below named <em>generate_desc()</em> implements this behavior and generates a textual description given a trained model, and a given prepared photo as input. It calls the function <em>word_for_id()</em> in order to map an integer prediction back to a word.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594052961682125" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# map an integer to a word
def word_for_id(integer, tokenizer):
	for word, index in tokenizer.word_index.items():
		if index == integer:
			return word
	return None

# generate a description for an image
def generate_desc(model, tokenizer, photo, max_length):
	# seed the generation process
	in_text = 'startseq'
	# iterate over the whole length of the sequence
	for i in range(max_length):
		# integer encode input sequence
		sequence = tokenizer.texts_to_sequences([in_text])[0]
		# pad input
		sequence = pad_sequences([sequence], maxlen=max_length)
		# predict next word
		yhat = model.predict([photo,sequence], verbose=0)
		# convert probability to integer
		yhat = argmax(yhat)
		# map integer to word
		word = word_for_id(yhat, tokenizer)
		# stop if we cannot map the word
		if word is None:
			break
		# append as input for generating the next word
		in_text += ' ' + word
		# stop if we predict the end of the sequence
		if word == 'endseq':
			break
	return in_text</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594052961682125-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-14">14</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-16">16</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-18">18</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-20">20</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-22">22</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-24">24</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-26">26</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-28">28</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-30">30</div><div class="crayon-num" data-line="crayon-5a6591c594052961682125-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594052961682125-32">32</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594052961682125-1"><span class="crayon-p"># map an integer to a word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-2"><span class="crayon-e">def </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-t">integer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-3"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">index </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-4"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">integer</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-5"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-6"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">None</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-7"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-8"><span class="crayon-p"># generate a description for an image</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-9"><span class="crayon-e">def </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-10"><span class="crayon-h"> </span><span class="crayon-p"># seed the generation process</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-11"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-12"><span class="crayon-h"> </span><span class="crayon-p"># iterate over the whole length of the sequence</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-13"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-14"><span class="crayon-h"> </span><span class="crayon-p"># integer encode input sequence</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-15"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_text</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-16"><span class="crayon-h"> </span><span class="crayon-p"># pad input</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-17"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-18"><span class="crayon-h"> </span><span class="crayon-p"># predict next word</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-19"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-20"><span class="crayon-h"> </span><span class="crayon-p"># convert probability to integer</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-21"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">argmax</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-22"><span class="crayon-h"> </span><span class="crayon-p"># map integer to word</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-23"><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-24"><span class="crayon-h"> </span><span class="crayon-p"># stop if we cannot map the word</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-25"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-26"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-27"><span class="crayon-h"> </span><span class="crayon-p"># append as input for generating the next word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-28"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-29"><span class="crayon-h"> </span><span class="crayon-p"># stop if we predict the end of the sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-30"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">'endseq'</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594052961682125-31"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594052961682125-32"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">in_text</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0019 seconds] -->
<p>We will generate predictions for all photos in the training dataset and in the test dataset.</p>
<p>The function below named <em>evaluate_model()</em> will evaluate a trained model against a given dataset of photo descriptions and photo features. The actual and predicted descriptions are collected and evaluated collectively using the corpus BLEU score that summarizes how close the generated text is to the expected text.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594055352199460" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# evaluate the skill of the model
def evaluate_model(model, descriptions, photos, tokenizer, max_length):
	actual, predicted = list(), list()
	# step over the whole set
	for key, desc in descriptions.items():
		# generate description
		yhat = generate_desc(model, tokenizer, photos[key], max_length)
		# store actual and predicted
		actual.append([desc.split()])
		predicted.append(yhat.split())
	# calculate BLEU score
	bleu = corpus_bleu(actual, predicted)
	return bleu</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594055352199460-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594055352199460-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594055352199460-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594055352199460-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594055352199460-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594055352199460-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594055352199460-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594055352199460-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594055352199460-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594055352199460-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594055352199460-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594055352199460-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594055352199460-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594055352199460-1"><span class="crayon-p"># evaluate the skill of the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594055352199460-2"><span class="crayon-e">def </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594055352199460-3"><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594055352199460-4"><span class="crayon-h"> </span><span class="crayon-p"># step over the whole set</span></div><div class="crayon-line" id="crayon-5a6591c594055352199460-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594055352199460-6"><span class="crayon-h"> </span><span class="crayon-p"># generate description</span></div><div class="crayon-line" id="crayon-5a6591c594055352199460-7"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594055352199460-8"><span class="crayon-h"> </span><span class="crayon-p"># store actual and predicted</span></div><div class="crayon-line" id="crayon-5a6591c594055352199460-9"><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">desc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594055352199460-10"><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594055352199460-11"><span class="crayon-h"> </span><span class="crayon-p"># calculate BLEU score</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594055352199460-12"><span class="crayon-h"> </span><span class="crayon-v">bleu</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594055352199460-13"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">bleu</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0012 seconds] -->
<p>BLEU scores are used in text translation for evaluating translated text against one or more reference translations. We do in fact have access to multiple reference descriptions for each image that we could compare to, but for simplicity, we will use the first description for each photo in the dataset (e.g. the cleaned version).</p>
<p>You can learn more about the BLEU score here:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/BLEU">BLEU (bilingual evaluation understudy) on Wikipedia</a></li>
</ul>
<p>The NLTK Python library implements the BLEU score calculation in the <a href="http://www.nltk.org/api/nltk.translate.html"><em>corpus_bleu()</em> function</a>. A higher score close to 1.0 is better, a score closer to zero is worse.</p>
<p>Finally, all we need to do is define, fit, and evaluate the model multiple times in a loop then report the final average score.</p>
<p>Ideally, we would repeat the experiment 30 times or more, but this will take too long for our small test harness. Instead, will evaluate the model 3 times. It will be faster, but the mean score will have higher variance.</p>
<p>Below defines the model evaluation loop. At the end of the run, the distribution of BLEU scores for the train and test sets are saved to a file.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594058579818155" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# run experiment
train_results, test_results = list(), list()
for i in range(n_repeats):
	# define the model
	model = define_model(vocab_size, max_length)
	# fit model
	model.fit_generator(data_generator(train_descriptions, train_features, tokenizer, max_length, n_photos_per_update), steps_per_epoch=n_batches_per_epoch, epochs=n_epochs, verbose=verbose)
	# evaluate model on training data
	train_score = evaluate_model(model, train_descriptions, train_features, tokenizer, max_length)
	test_score = evaluate_model(model, test_descriptions, test_features, tokenizer, max_length)
	# store
	train_results.append(train_score)
	test_results.append(test_score)
	print('&gt;%d: train=%f test=%f' % ((i+1), train_score, test_score))
# save results to file
df = DataFrame()
df['train'] = train_results
df['test'] = test_results
print(df.describe())
df.to_csv(model_name+'.csv', index=False)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594058579818155-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594058579818155-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594058579818155-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594058579818155-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594058579818155-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594058579818155-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594058579818155-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594058579818155-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594058579818155-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594058579818155-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594058579818155-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594058579818155-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594058579818155-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594058579818155-14">14</div><div class="crayon-num" data-line="crayon-5a6591c594058579818155-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594058579818155-16">16</div><div class="crayon-num" data-line="crayon-5a6591c594058579818155-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594058579818155-18">18</div><div class="crayon-num" data-line="crayon-5a6591c594058579818155-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594058579818155-20">20</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594058579818155-1"><span class="crayon-p"># run experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594058579818155-2"><span class="crayon-v">train_results</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594058579818155-3"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_repeats</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594058579818155-4"><span class="crayon-h"> </span><span class="crayon-p"># define the model</span></div><div class="crayon-line" id="crayon-5a6591c594058579818155-5"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594058579818155-6"><span class="crayon-h"> </span><span class="crayon-p"># fit model</span></div><div class="crayon-line" id="crayon-5a6591c594058579818155-7"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit_generator</span><span class="crayon-sy">(</span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_photos_per_update</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">steps_per_epoch</span><span class="crayon-o">=</span><span class="crayon-v">n_batches_per_epoch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-v">verbose</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594058579818155-8"><span class="crayon-h"> </span><span class="crayon-p"># evaluate model on training data</span></div><div class="crayon-line" id="crayon-5a6591c594058579818155-9"><span class="crayon-h"> </span><span class="crayon-v">train_score</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594058579818155-10"><span class="crayon-h"> </span><span class="crayon-v">test_score</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594058579818155-11"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594058579818155-12"><span class="crayon-h"> </span><span class="crayon-v">train_results</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">train_score</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594058579818155-13"><span class="crayon-h"> </span><span class="crayon-v">test_results</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">test_score</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594058579818155-14"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'&gt;%d: train=%f test=%f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">i</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_score</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594058579818155-15"><span class="crayon-p"># save results to file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594058579818155-16"><span class="crayon-v">df</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594058579818155-17"><span class="crayon-v">df</span><span class="crayon-sy">[</span><span class="crayon-s">'train'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">train_results</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594058579818155-18"><span class="crayon-v">df</span><span class="crayon-sy">[</span><span class="crayon-s">'test'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">test_results</span></div><div class="crayon-line" id="crayon-5a6591c594058579818155-19"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">df</span><span class="crayon-sy">.</span><span class="crayon-e">describe</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594058579818155-20"><span class="crayon-v">df</span><span class="crayon-sy">.</span><span class="crayon-e">to_csv</span><span class="crayon-sy">(</span><span class="crayon-v">model_name</span><span class="crayon-o">+</span><span class="crayon-s">'.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0019 seconds] -->
<p>We parameterize the run as follows, allowing us to name each run and save the result to separate files.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59405b781720530" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define experiment
model_name = 'baseline1'
verbose = 2
n_epochs = 50
n_photos_per_update = 2
n_batches_per_epoch = int(len(train) / n_photos_per_update)
n_repeats = 3</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59405b781720530-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405b781720530-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59405b781720530-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405b781720530-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59405b781720530-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405b781720530-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59405b781720530-7">7</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59405b781720530-1"><span class="crayon-p"># define experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405b781720530-2"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'baseline1'</span></div><div class="crayon-line" id="crayon-5a6591c59405b781720530-3"><span class="crayon-v">verbose</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405b781720530-4"><span class="crayon-v">n_epochs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">50</span></div><div class="crayon-line" id="crayon-5a6591c59405b781720530-5"><span class="crayon-v">n_photos_per_update</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405b781720530-6"><span class="crayon-v">n_batches_per_epoch</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-v">n_photos_per_update</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405b781720530-7"><span class="crayon-v">n_repeats</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">3</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0006 seconds] -->
<p></p>
<h3>4. Complete Example</h3>
<p>The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59405e540695414" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from os import listdir
from numpy import array
from numpy import argmax
from pandas import DataFrame
from nltk.translate.bleu_score import corpus_bleu
from pickle import load

from keras.preprocessing.text import Tokenizer
from keras.preprocessing.sequence import pad_sequences
from keras.utils import to_categorical
from keras.preprocessing.image import load_img
from keras.preprocessing.image import img_to_array
from keras.applications.vgg16 import preprocess_input
from keras.applications.vgg16 import VGG16
from keras.utils import plot_model
from keras.models import Model
from keras.layers import Input
from keras.layers import Dense
from keras.layers import Flatten
from keras.layers import LSTM
from keras.layers import RepeatVector
from keras.layers import TimeDistributed
from keras.layers import Embedding
from keras.layers.merge import concatenate
from keras.layers.pooling import GlobalMaxPooling2D

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)

# split a dataset into train/test elements
def train_test_split(dataset):
	# order keys so the split is consistent
	ordered = sorted(dataset)
	# return split dataset as two new sets
	return set(ordered[:100]), set(ordered[100:200])

# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# store
			descriptions[image_id] = 'startseq ' + ' '.join(image_desc) + ' endseq'
	return descriptions

# load photo features
def load_photo_features(filename, dataset):
	# load all features
	all_features = load(open(filename, 'rb'))
	# filter features
	features = {k: all_features[k] for k in dataset}
	return features

# fit a tokenizer given caption descriptions
def create_tokenizer(descriptions):
	lines = list(descriptions.values())
	tokenizer = Tokenizer()
	tokenizer.fit_on_texts(lines)
	return tokenizer

# create sequences of images, input sequences and output words for an image
def create_sequences(tokenizer, desc, image, max_length):
	Ximages, XSeq, y = list(), list(),list()
	vocab_size = len(tokenizer.word_index) + 1
	# integer encode the description
	seq = tokenizer.texts_to_sequences([desc])[0]
	# split one sequence into multiple X,y pairs
	for i in range(1, len(seq)):
		# select
		in_seq, out_seq = seq[:i], seq[i]
		# pad input sequence
		in_seq = pad_sequences([in_seq], maxlen=max_length)[0]
		# encode output sequence
		out_seq = to_categorical([out_seq], num_classes=vocab_size)[0]
		# store
		Ximages.append(image)
		XSeq.append(in_seq)
		y.append(out_seq)
	# Ximages, XSeq, y = array(Ximages), array(XSeq), array(y)
	return [Ximages, XSeq, y]

# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor (encoder)
	inputs1 = Input(shape=(7, 7, 512))
	fe1 = GlobalMaxPooling2D()(inputs1)
	fe2 = Dense(128, activation='relu')(fe1)
	fe3 = RepeatVector(max_length)(fe2)
	# embedding
	inputs2 = Input(shape=(max_length,))
	emb2 = Embedding(vocab_size, 50, mask_zero=True)(inputs2)
	emb3 = LSTM(256, return_sequences=True)(emb2)
	emb4 = TimeDistributed(Dense(128, activation='relu'))(emb3)
	# merge inputs
	merged = concatenate([fe3, emb4])
	# language model (decoder)
	lm2 = LSTM(500)(merged)
	lm3 = Dense(500, activation='relu')(lm2)
	outputs = Dense(vocab_size, activation='softmax')(lm3)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
	print(model.summary())
	plot_model(model, show_shapes=True, to_file='plot.png')
	return model

# data generator, intended to be used in a call to model.fit_generator()
def data_generator(descriptions, features, tokenizer, max_length, n_step):
	# loop until we finish training
	while 1:
		# loop over photo identifiers in the dataset
		keys = list(descriptions.keys())
		for i in range(0, len(keys), n_step):
			Ximages, XSeq, y = list(), list(),list()
			for j in range(i, min(len(keys), i+n_step)):
				image_id = keys[j]
				# retrieve photo feature input
				image = features[image_id][0]
				# retrieve text input
				desc = descriptions[image_id]
				# generate input-output pairs
				in_img, in_seq, out_word = create_sequences(tokenizer, desc, image, max_length)
				for k in range(len(in_img)):
					Ximages.append(in_img[k])
					XSeq.append(in_seq[k])
					y.append(out_word[k])
			# yield this batch of samples to the model
			yield [[array(Ximages), array(XSeq)], array(y)]

# map an integer to a word
def word_for_id(integer, tokenizer):
	for word, index in tokenizer.word_index.items():
		if index == integer:
			return word
	return None

# generate a description for an image
def generate_desc(model, tokenizer, photo, max_length):
	# seed the generation process
	in_text = 'startseq'
	# iterate over the whole length of the sequence
	for i in range(max_length):
		# integer encode input sequence
		sequence = tokenizer.texts_to_sequences([in_text])[0]
		# pad input
		sequence = pad_sequences([sequence], maxlen=max_length)
		# predict next word
		yhat = model.predict([photo,sequence], verbose=0)
		# convert probability to integer
		yhat = argmax(yhat)
		# map integer to word
		word = word_for_id(yhat, tokenizer)
		# stop if we cannot map the word
		if word is None:
			break
		# append as input for generating the next word
		in_text += ' ' + word
		# stop if we predict the end of the sequence
		if word == 'endseq':
			break
	return in_text

# evaluate the skill of the model
def evaluate_model(model, descriptions, photos, tokenizer, max_length):
	actual, predicted = list(), list()
	# step over the whole set
	for key, desc in descriptions.items():
		# generate description
		yhat = generate_desc(model, tokenizer, photos[key], max_length)
		# store actual and predicted
		actual.append([desc.split()])
		predicted.append(yhat.split())
	# calculate BLEU score
	bleu = corpus_bleu(actual, predicted)
	return bleu

# load dev set
filename = 'Flickr8k_text/Flickr_8k.devImages.txt'
dataset = load_set(filename)
print('Dataset: %d' % len(dataset))
# train-test split
train, test = train_test_split(dataset)
# descriptions
train_descriptions = load_clean_descriptions('descriptions.txt', train)
test_descriptions = load_clean_descriptions('descriptions.txt', test)
print('Descriptions: train=%d, test=%d' % (len(train_descriptions), len(test_descriptions)))
# photo features
train_features = load_photo_features('features.pkl', train)
test_features = load_photo_features('features.pkl', test)
print('Photos: train=%d, test=%d' % (len(train_features), len(test_features)))
# prepare tokenizer
tokenizer = create_tokenizer(train_descriptions)
vocab_size = len(tokenizer.word_index) + 1
print('Vocabulary Size: %d' % vocab_size)
# determine the maximum sequence length
max_length = max(len(s.split()) for s in list(train_descriptions.values()))
print('Description Length: %d' % max_length)

# define experiment
model_name = 'baseline1'
verbose = 2
n_epochs = 50
n_photos_per_update = 2
n_batches_per_epoch = int(len(train) / n_photos_per_update)
n_repeats = 3

# run experiment
train_results, test_results = list(), list()
for i in range(n_repeats):
	# define the model
	model = define_model(vocab_size, max_length)
	# fit model
	model.fit_generator(data_generator(train_descriptions, train_features, tokenizer, max_length, n_photos_per_update), steps_per_epoch=n_batches_per_epoch, epochs=n_epochs, verbose=verbose)
	# evaluate model on training data
	train_score = evaluate_model(model, train_descriptions, train_features, tokenizer, max_length)
	test_score = evaluate_model(model, test_descriptions, test_features, tokenizer, max_length)
	# store
	train_results.append(train_score)
	test_results.append(test_score)
	print('&gt;%d: train=%f test=%f' % ((i+1), train_score, test_score))
# save results to file
df = DataFrame()
df['train'] = train_results
df['test'] = test_results
print(df.describe())
df.to_csv(model_name+'.csv', index=False)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-8">8</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-10">10</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-12">12</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-14">14</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-16">16</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-18">18</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-20">20</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-22">22</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-24">24</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-26">26</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-28">28</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-30">30</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-32">32</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-34">34</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-36">36</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-38">38</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-40">40</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-42">42</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-44">44</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-46">46</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-48">48</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-50">50</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-52">52</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-54">54</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-56">56</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-58">58</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-60">60</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-62">62</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-64">64</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-66">66</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-68">68</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-70">70</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-72">72</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-74">74</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-76">76</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-78">78</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-80">80</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-82">82</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-84">84</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-86">86</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-88">88</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-90">90</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-92">92</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-94">94</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-96">96</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-98">98</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-100">100</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-102">102</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-104">104</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-106">106</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-108">108</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-110">110</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-112">112</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-114">114</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-116">116</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-118">118</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-120">120</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-122">122</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-124">124</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-126">126</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-128">128</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-130">130</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-131">131</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-132">132</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-133">133</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-134">134</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-135">135</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-136">136</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-137">137</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-138">138</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-139">139</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-140">140</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-141">141</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-142">142</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-143">143</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-144">144</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-145">145</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-146">146</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-147">147</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-148">148</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-149">149</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-150">150</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-151">151</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-152">152</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-153">153</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-154">154</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-155">155</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-156">156</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-157">157</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-158">158</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-159">159</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-160">160</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-161">161</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-162">162</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-163">163</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-164">164</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-165">165</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-166">166</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-167">167</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-168">168</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-169">169</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-170">170</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-171">171</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-172">172</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-173">173</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-174">174</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-175">175</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-176">176</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-177">177</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-178">178</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-179">179</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-180">180</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-181">181</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-182">182</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-183">183</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-184">184</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-185">185</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-186">186</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-187">187</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-188">188</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-189">189</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-190">190</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-191">191</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-192">192</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-193">193</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-194">194</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-195">195</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-196">196</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-197">197</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-198">198</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-199">199</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-200">200</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-201">201</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-202">202</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-203">203</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-204">204</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-205">205</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-206">206</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-207">207</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-208">208</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-209">209</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-210">210</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-211">211</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-212">212</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-213">213</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-214">214</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-215">215</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-216">216</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-217">217</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-218">218</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-219">219</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-220">220</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-221">221</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-222">222</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-223">223</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-224">224</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-225">225</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-226">226</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-227">227</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-228">228</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-229">229</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-230">230</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-231">231</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-232">232</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-233">233</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-234">234</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-235">235</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-236">236</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-237">237</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-238">238</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-239">239</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-240">240</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-241">241</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-242">242</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-243">243</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-244">244</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-245">245</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-246">246</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-247">247</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-248">248</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-249">249</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-250">250</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-251">251</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-252">252</div><div class="crayon-num" data-line="crayon-5a6591c59405e540695414-253">253</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59405e540695414-254">254</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59405e540695414-1"><span class="crayon-e">from </span><span class="crayon-e">os </span><span class="crayon-e">import </span><span class="crayon-e">listdir</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-2"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-3"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">argmax</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-4"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">DataFrame</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-5"><span class="crayon-e">from </span><span class="crayon-v">nltk</span><span class="crayon-sy">.</span><span class="crayon-v">translate</span><span class="crayon-sy">.</span><span class="crayon-e">bleu_score </span><span class="crayon-e">import </span><span class="crayon-e">corpus_bleu</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-6"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-e">load</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-7"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">text </span><span class="crayon-e">import </span><span class="crayon-e">Tokenizer</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">sequence </span><span class="crayon-e">import </span><span class="crayon-e">pad_sequences</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-10"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-e">import </span><span class="crayon-e">to_categorical</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-11"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">load_img</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-12"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">preprocessing</span><span class="crayon-sy">.</span><span class="crayon-e">image </span><span class="crayon-e">import </span><span class="crayon-e">img_to_array</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-13"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">preprocess_input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-14"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">applications</span><span class="crayon-sy">.</span><span class="crayon-e">vgg16 </span><span class="crayon-e">import </span><span class="crayon-e">VGG16</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-15"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">utils </span><span class="crayon-e">import </span><span class="crayon-e">plot_model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-16"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Model</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-17"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-18"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dense</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-19"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Flatten</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-20"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">LSTM</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-21"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">RepeatVector</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-22"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">TimeDistributed</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-23"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Embedding</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-24"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">merge </span><span class="crayon-e">import </span><span class="crayon-e">concatenate</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-25"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">pooling </span><span class="crayon-e">import </span><span class="crayon-v">GlobalMaxPooling2D</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-26"> </div><div class="crayon-line" id="crayon-5a6591c59405e540695414-27"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-28"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-29"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-30"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-31"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-32"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-33"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-34"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-35"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-36"> </div><div class="crayon-line" id="crayon-5a6591c59405e540695414-37"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-38"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-39"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-40"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-41"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-42"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-43"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-44"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-45"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-46"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-47"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-48"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-49"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-50"> </div><div class="crayon-line" id="crayon-5a6591c59405e540695414-51"><span class="crayon-p"># split a dataset into train/test elements</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-52"><span class="crayon-e">def </span><span class="crayon-e">train_test_split</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-53"><span class="crayon-h"> </span><span class="crayon-p"># order keys so the split is consistent</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-54"><span class="crayon-h"> </span><span class="crayon-v">ordered</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sorted</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-55"><span class="crayon-h"> </span><span class="crayon-p"># return split dataset as two new sets</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-56"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">ordered</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-cn">100</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">ordered</span><span class="crayon-sy">[</span><span class="crayon-cn">100</span><span class="crayon-o">:</span><span class="crayon-cn">200</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-57"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-58"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-59"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-60"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-61"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-62"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-63"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-64"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-65"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-66"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-67"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-68"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-69"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-70"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-71"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-72"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-73"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-74"><span class="crayon-p"># load photo features</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-75"><span class="crayon-e">def </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-76"><span class="crayon-h"> </span><span class="crayon-p"># load all features</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-77"><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-78"><span class="crayon-h"> </span><span class="crayon-p"># filter features</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-79"><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-v">k</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">all_features</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">k</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">}</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-80"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">features</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-81"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-82"><span class="crayon-p"># fit a tokenizer given caption descriptions</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-83"><span class="crayon-e">def </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-84"><span class="crayon-h"> </span><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-85"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Tokenizer</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-86"><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">fit_on_texts</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-87"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-88"> </div><div class="crayon-line" id="crayon-5a6591c59405e540695414-89"><span class="crayon-p"># create sequences of images, input sequences and output words for an image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-90"><span class="crayon-e">def </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-91"><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-92"><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-93"><span class="crayon-h"> </span><span class="crayon-p"># integer encode the description</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-94"><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">desc</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-95"><span class="crayon-h"> </span><span class="crayon-p"># split one sequence into multiple X,y pairs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-96"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">seq</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-97"><span class="crayon-h"> </span><span class="crayon-p"># select</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-98"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">seq</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-99"><span class="crayon-h"> </span><span class="crayon-p"># pad input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-100"><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-101"><span class="crayon-h"> </span><span class="crayon-p"># encode output sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-102"><span class="crayon-h"> </span><span class="crayon-v">out_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">to_categorical</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">out_seq</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">num_classes</span><span class="crayon-o">=</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-103"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-104"><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">image</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-105"><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-106"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">out_seq</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-107"><span class="crayon-h"> </span><span class="crayon-p"># Ximages, XSeq, y = array(Ximages), array(XSeq), array(y)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-108"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">Ximages</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-109"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-110"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-111"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-112"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor (encoder)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-113"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">512</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-114"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">GlobalMaxPooling2D</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-115"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-116"><span class="crayon-h"> </span><span class="crayon-v">fe3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-117"><span class="crayon-h"> </span><span class="crayon-p"># embedding</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-118"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-119"><span class="crayon-h"> </span><span class="crayon-v">emb2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-120"><span class="crayon-h"> </span><span class="crayon-v">emb3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-121"><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb3</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-122"><span class="crayon-h"> </span><span class="crayon-p"># merge inputs</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-123"><span class="crayon-h"> </span><span class="crayon-v">merged</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concatenate</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-124"><span class="crayon-h"> </span><span class="crayon-p"># language model (decoder)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-125"><span class="crayon-h"> </span><span class="crayon-v">lm2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">merged</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-126"><span class="crayon-h"> </span><span class="crayon-v">lm3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-127"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm3</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-128"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-129"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-130"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'accuracy'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-131"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">summary</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-132"><span class="crayon-h"> </span><span class="crayon-e">plot_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">show_shapes</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">to_file</span><span class="crayon-o">=</span><span class="crayon-s">'plot.png'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-133"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-134"> </div><div class="crayon-line" id="crayon-5a6591c59405e540695414-135"><span class="crayon-p"># data generator, intended to be used in a call to model.fit_generator()</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-136"><span class="crayon-e">def </span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_step</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-137"><span class="crayon-h"> </span><span class="crayon-p"># loop until we finish training</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-138"><span class="crayon-h"> </span><span class="crayon-st">while</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-139"><span class="crayon-h"> </span><span class="crayon-p"># loop over photo identifiers in the dataset</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-140"><span class="crayon-h"> </span><span class="crayon-v">keys</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">keys</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-141"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">keys</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_step</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-142"><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-143"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">j</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">min</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">keys</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">i</span><span class="crayon-o">+</span><span class="crayon-v">n_step</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-144"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">keys</span><span class="crayon-sy">[</span><span class="crayon-v">j</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-145"><span class="crayon-h"> </span><span class="crayon-p"># retrieve photo feature input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-146"><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">features</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-147"><span class="crayon-h"> </span><span class="crayon-p"># retrieve text input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-148"><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-149"><span class="crayon-h"> </span><span class="crayon-p"># generate input-output pairs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-150"><span class="crayon-h"> </span><span class="crayon-v">in_img</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">in_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">out_word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_sequences</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-151"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">k</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">in_img</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-152"><span class="crayon-h"> </span><span class="crayon-v">Ximages</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_img</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-153"><span class="crayon-h"> </span><span class="crayon-v">XSeq</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">in_seq</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-154"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">out_word</span><span class="crayon-sy">[</span><span class="crayon-v">k</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-155"><span class="crayon-h"> </span><span class="crayon-p"># yield this batch of samples to the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-156"><span class="crayon-h"> </span><span class="crayon-i">yield</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-sy">[</span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">Ximages</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">XSeq</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-157"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-158"><span class="crayon-p"># map an integer to a word</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-159"><span class="crayon-e">def </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-t">integer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-160"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">index </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-161"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-t">integer</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-162"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-163"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">None</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-164"> </div><div class="crayon-line" id="crayon-5a6591c59405e540695414-165"><span class="crayon-p"># generate a description for an image</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-166"><span class="crayon-e">def </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-167"><span class="crayon-h"> </span><span class="crayon-p"># seed the generation process</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-168"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq'</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-169"><span class="crayon-h"> </span><span class="crayon-p"># iterate over the whole length of the sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-170"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-171"><span class="crayon-h"> </span><span class="crayon-p"># integer encode input sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-172"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-e">texts_to_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">in_text</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-173"><span class="crayon-h"> </span><span class="crayon-p"># pad input</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-174"><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">pad_sequences</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">maxlen</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-175"><span class="crayon-h"> </span><span class="crayon-p"># predict next word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-176"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">photo</span><span class="crayon-sy">,</span><span class="crayon-v">sequence</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-177"><span class="crayon-h"> </span><span class="crayon-p"># convert probability to integer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-178"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">argmax</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-179"><span class="crayon-h"> </span><span class="crayon-p"># map integer to word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-180"><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">word_for_id</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-181"><span class="crayon-h"> </span><span class="crayon-p"># stop if we cannot map the word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-182"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-183"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-184"><span class="crayon-h"> </span><span class="crayon-p"># append as input for generating the next word</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-185"><span class="crayon-h"> </span><span class="crayon-v">in_text</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-t">word</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-186"><span class="crayon-h"> </span><span class="crayon-p"># stop if we predict the end of the sequence</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-187"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">==</span><span class="crayon-h"> </span><span class="crayon-s">'endseq'</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-188"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-189"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">in_text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-190"> </div><div class="crayon-line" id="crayon-5a6591c59405e540695414-191"><span class="crayon-p"># evaluate the skill of the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-192"><span class="crayon-e">def </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-193"><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-194"><span class="crayon-h"> </span><span class="crayon-p"># step over the whole set</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-195"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-196"><span class="crayon-h"> </span><span class="crayon-p"># generate description</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-197"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-198"><span class="crayon-h"> </span><span class="crayon-p"># store actual and predicted</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-199"><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">desc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-200"><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-201"><span class="crayon-h"> </span><span class="crayon-p"># calculate BLEU score</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-202"><span class="crayon-h"> </span><span class="crayon-v">bleu</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-203"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">bleu</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-204"> </div><div class="crayon-line" id="crayon-5a6591c59405e540695414-205"><span class="crayon-p"># load dev set</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-206"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.devImages.txt'</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-207"><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-208"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-209"><span class="crayon-p"># train-test split</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-210"><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">train_test_split</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-211"><span class="crayon-p"># descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-212"><span class="crayon-v">train_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-213"><span class="crayon-v">test_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-214"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: train=%d, test=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-215"><span class="crayon-p"># photo features</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-216"><span class="crayon-v">train_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-217"><span class="crayon-v">test_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_photo_features</span><span class="crayon-sy">(</span><span class="crayon-s">'features.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-218"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Photos: train=%d, test=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_features</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-219"><span class="crayon-p"># prepare tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-220"><span class="crayon-v">tokenizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">create_tokenizer</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-221"><span class="crayon-v">vocab_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-222"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-223"><span class="crayon-p"># determine the maximum sequence length</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-224"><span class="crayon-v">max_length</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">max</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">s</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-225"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Description Length: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-226"> </div><div class="crayon-line" id="crayon-5a6591c59405e540695414-227"><span class="crayon-p"># define experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-228"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'baseline1'</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-229"><span class="crayon-v">verbose</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-230"><span class="crayon-v">n_epochs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">50</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-231"><span class="crayon-v">n_photos_per_update</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-232"><span class="crayon-v">n_batches_per_epoch</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">int</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">/</span><span class="crayon-h"> </span><span class="crayon-v">n_photos_per_update</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-233"><span class="crayon-v">n_repeats</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">3</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-234"> </div><div class="crayon-line" id="crayon-5a6591c59405e540695414-235"><span class="crayon-p"># run experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-236"><span class="crayon-v">train_results</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-237"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_repeats</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-238"><span class="crayon-h"> </span><span class="crayon-p"># define the model</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-239"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-240"><span class="crayon-h"> </span><span class="crayon-p"># fit model</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-241"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit_generator</span><span class="crayon-sy">(</span><span class="crayon-e">data_generator</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_photos_per_update</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">steps_per_epoch</span><span class="crayon-o">=</span><span class="crayon-v">n_batches_per_epoch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-v">verbose</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-242"><span class="crayon-h"> </span><span class="crayon-p"># evaluate model on training data</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-243"><span class="crayon-h"> </span><span class="crayon-v">train_score</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-244"><span class="crayon-h"> </span><span class="crayon-v">test_score</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-245"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-246"><span class="crayon-h"> </span><span class="crayon-v">train_results</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">train_score</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-247"><span class="crayon-h"> </span><span class="crayon-v">test_results</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">test_score</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-248"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'&gt;%d: train=%f test=%f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">i</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_score</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_score</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-249"><span class="crayon-p"># save results to file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-250"><span class="crayon-v">df</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-251"><span class="crayon-v">df</span><span class="crayon-sy">[</span><span class="crayon-s">'train'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">train_results</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-252"><span class="crayon-v">df</span><span class="crayon-sy">[</span><span class="crayon-s">'test'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">test_results</span></div><div class="crayon-line" id="crayon-5a6591c59405e540695414-253"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">df</span><span class="crayon-sy">.</span><span class="crayon-e">describe</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59405e540695414-254"><span class="crayon-v">df</span><span class="crayon-sy">.</span><span class="crayon-e">to_csv</span><span class="crayon-sy">(</span><span class="crayon-v">model_name</span><span class="crayon-o">+</span><span class="crayon-s">'.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0190 seconds] -->
<p>Running the example first prints summary statistics for the loaded training data.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594065006575701" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Dataset: 1,000
Descriptions: train=100, test=100
Photos: train=100, test=100
Vocabulary Size: 366
Description Length: 25</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594065006575701-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594065006575701-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594065006575701-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594065006575701-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594065006575701-5">5</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594065006575701-1">Dataset: 1,000</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594065006575701-2">Descriptions: train=100, test=100</div><div class="crayon-line" id="crayon-5a6591c594065006575701-3">Photos: train=100, test=100</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594065006575701-4">Vocabulary Size: 366</div><div class="crayon-line" id="crayon-5a6591c594065006575701-5">Description Length: 25</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>The example should take about 20 minutes on GPU hardware, a little longer on CPU hardware.</p>
<p>At the end of the run, a mean BLEU of 0.06 is reported on the training set and 0.04 on the test set. Results are stored in <em>baseline1.csv</em>.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594069020197345" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
          train      test
count  3.000000  3.000000
mean   0.060617  0.040978
std    0.023498  0.025105
min    0.042882  0.012101
25%    0.047291  0.032658
50%    0.051701  0.053215
75%    0.069484  0.055416
max    0.087268  0.057617</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594069020197345-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594069020197345-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594069020197345-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594069020197345-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594069020197345-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594069020197345-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594069020197345-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594069020197345-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594069020197345-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594069020197345-1">          train      test</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594069020197345-2">count  3.000000  3.000000</div><div class="crayon-line" id="crayon-5a6591c594069020197345-3">mean   0.060617  0.040978</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594069020197345-4">std    0.023498  0.025105</div><div class="crayon-line" id="crayon-5a6591c594069020197345-5">min    0.042882  0.012101</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594069020197345-6">25%    0.047291  0.032658</div><div class="crayon-line" id="crayon-5a6591c594069020197345-7">50%    0.051701  0.053215</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594069020197345-8">75%    0.069484  0.055416</div><div class="crayon-line" id="crayon-5a6591c594069020197345-9">max    0.087268  0.057617</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>This provides a baseline model for comparison to alternate configurations.</p>
<h3>“A” versus “A” Test</h3>
<p>Before we start testing variations of the model, it is important to get an idea of whether or not the test harness is stable.</p>
<p>That is, whether the summarizing skill of the model over 5 runs is sufficient to control for the stochastic nature of the model.</p>
<p>We can get an idea of this by running the experiment again in what is called an A vs A test in A/B testing land. We would expect to get an equivalent result if we ran the same experiment again; if we don’t, perhaps additional repeats would be required to control for the stochastic nature of the method and on the dataset.</p>
<p>Below are the results from a second run of the algorithm.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59406c404046974" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
          train      test
count  3.000000  3.000000
mean   0.036902  0.043003
std    0.020281  0.017295
min    0.018522  0.026055
25%    0.026023  0.034192
50%    0.033525  0.042329
75%    0.046093  0.051477
max    0.058660  0.060624</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59406c404046974-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59406c404046974-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59406c404046974-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59406c404046974-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59406c404046974-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59406c404046974-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59406c404046974-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59406c404046974-8">8</div><div class="crayon-num" data-line="crayon-5a6591c59406c404046974-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59406c404046974-1">          train      test</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59406c404046974-2">count  3.000000  3.000000</div><div class="crayon-line" id="crayon-5a6591c59406c404046974-3">mean   0.036902  0.043003</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59406c404046974-4">std    0.020281  0.017295</div><div class="crayon-line" id="crayon-5a6591c59406c404046974-5">min    0.018522  0.026055</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59406c404046974-6">25%    0.026023  0.034192</div><div class="crayon-line" id="crayon-5a6591c59406c404046974-7">50%    0.033525  0.042329</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59406c404046974-8">75%    0.046093  0.051477</div><div class="crayon-line" id="crayon-5a6591c59406c404046974-9">max    0.058660  0.060624</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>We can see that the run gets a very similar mean and standard deviation BLEU scores. Specifically, a mean BLEU of 0.03 vs 0.06 on train and 0.04 to 0.04 for test.</p>
<p>The harness is a little noisy, but stable enough for comparison.</p>
<p>Is the model any good?</p>
<h3>Generate Photo Captions</h3>
<p>We expect the model is under-trained and maybe even under provisioned, but can it generate any kind of readable text at all?</p>
<p>It is important that the baseline model have some modicum of capability so that we can relate the BLEU scores of the baseline to an idea of what kind of quality of descriptions are being generated.</p>
<p>Let’s train a single model and generate a few descriptions from the train and test sets as a sanity check.</p>
<p>Change the number of repeats to 1 and the name of the run to ‘<em>baseline_generate</em>‘.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59406f802714044" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
model_name = 'baseline_generate'
n_repeats = 1</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59406f802714044-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59406f802714044-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59406f802714044-1"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'baseline_generate'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59406f802714044-2"><span class="crayon-v">n_repeats</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Then update the <em>evaluate_model()</em> function to only evaluate the first 5 photos in the dataset and print the descriptions, as follows.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594071270499332" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# evaluate the skill of the model
def evaluate_model(model, descriptions, photos, tokenizer, max_length):
	actual, predicted = list(), list()
	# step over the whole set
	for key, desc in descriptions.items():
		# generate description
		yhat = generate_desc(model, tokenizer, photos[key], max_length)
		# store actual and predicted
		actual.append([desc.split()])
		predicted.append(yhat.split())
		print('Actual:    %s' % desc)
		print('Predicted: %s' % yhat)
		if len(actual) &gt;= 5:
			break
	# calculate BLEU score
	bleu = corpus_bleu(actual, predicted)
	return bleu</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594071270499332-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594071270499332-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594071270499332-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594071270499332-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594071270499332-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594071270499332-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594071270499332-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594071270499332-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594071270499332-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594071270499332-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594071270499332-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594071270499332-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594071270499332-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594071270499332-14">14</div><div class="crayon-num" data-line="crayon-5a6591c594071270499332-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594071270499332-16">16</div><div class="crayon-num" data-line="crayon-5a6591c594071270499332-17">17</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594071270499332-1"><span class="crayon-p"># evaluate the skill of the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594071270499332-2"><span class="crayon-e">def </span><span class="crayon-e">evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594071270499332-3"><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594071270499332-4"><span class="crayon-h"> </span><span class="crayon-p"># step over the whole set</span></div><div class="crayon-line" id="crayon-5a6591c594071270499332-5"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-v">key</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">desc </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594071270499332-6"><span class="crayon-h"> </span><span class="crayon-p"># generate description</span></div><div class="crayon-line" id="crayon-5a6591c594071270499332-7"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_desc</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">photos</span><span class="crayon-sy">[</span><span class="crayon-v">key</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594071270499332-8"><span class="crayon-h"> </span><span class="crayon-p"># store actual and predicted</span></div><div class="crayon-line" id="crayon-5a6591c594071270499332-9"><span class="crayon-h"> </span><span class="crayon-v">actual</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">desc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594071270499332-10"><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594071270499332-11"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Actual:    %s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">desc</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594071270499332-12"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Predicted: %s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594071270499332-13"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&gt;=</span><span class="crayon-h"> </span><span class="crayon-cn">5</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594071270499332-14"><span class="crayon-h"> </span><span class="crayon-st">break</span></div><div class="crayon-line" id="crayon-5a6591c594071270499332-15"><span class="crayon-h"> </span><span class="crayon-p"># calculate BLEU score</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594071270499332-16"><span class="crayon-h"> </span><span class="crayon-v">bleu</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">corpus_bleu</span><span class="crayon-sy">(</span><span class="crayon-v">actual</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predicted</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594071270499332-17"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">bleu</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0015 seconds] -->
<p>Re-run the example.</p>
<p>You should see results for the train set like the following (the specific results will vary given the stochastic nature of the algorithm):</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594074759331578" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Actual:    startseq boy bites hard into treat while he sits outside endseq
Predicted: startseq boy boy while while he while outside endseq

Actual:    startseq man in field backed by american flags endseq
Predicted: startseq man in in standing city endseq

Actual:    startseq two girls are walking down dirt road in park endseq
Predicted: startseq man walking down down road in endseq

Actual:    startseq girl laying on the tree with boy kneeling before her endseq
Predicted: startseq boy while in up up up water endseq

Actual:    startseq boy in striped shirt is jumping in front of water fountain endseq
Predicted: startseq man is is shirt is on on on on bike endseq</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594074759331578-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594074759331578-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594074759331578-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594074759331578-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594074759331578-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594074759331578-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594074759331578-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594074759331578-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594074759331578-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594074759331578-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594074759331578-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594074759331578-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594074759331578-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594074759331578-14">14</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594074759331578-1">Actual:    startseq boy bites hard into treat while he sits outside endseq</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594074759331578-2">Predicted: startseq boy boy while while he while outside endseq</div><div class="crayon-line" id="crayon-5a6591c594074759331578-3"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594074759331578-4">Actual:    startseq man in field backed by american flags endseq</div><div class="crayon-line" id="crayon-5a6591c594074759331578-5">Predicted: startseq man in in standing city endseq</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594074759331578-6"> </div><div class="crayon-line" id="crayon-5a6591c594074759331578-7">Actual:    startseq two girls are walking down dirt road in park endseq</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594074759331578-8">Predicted: startseq man walking down down road in endseq</div><div class="crayon-line" id="crayon-5a6591c594074759331578-9"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594074759331578-10">Actual:    startseq girl laying on the tree with boy kneeling before her endseq</div><div class="crayon-line" id="crayon-5a6591c594074759331578-11">Predicted: startseq boy while in up up up water endseq</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594074759331578-12"> </div><div class="crayon-line" id="crayon-5a6591c594074759331578-13">Actual:    startseq boy in striped shirt is jumping in front of water fountain endseq</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594074759331578-14">Predicted: startseq man is is shirt is on on on on bike endseq</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>You should see results on the test dataset as follows:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594077716860564" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Actual:    startseq three people are looking into photographic equipment endseq
Predicted: startseq boy racer on on on on bike endseq

Actual:    startseq boy is leaning on chair whilst another boy pulls him around with rope endseq
Predicted: startseq girl in playing on on on sword endseq

Actual:    startseq black and brown dog jumping in midair near field endseq
Predicted: startseq dog dog running running running and dog in grass endseq

Actual:    startseq dog places his head on man face endseq
Predicted: startseq brown dog dog to to to to to to to ball endseq

Actual:    startseq man in green hat is someplace up high endseq
Predicted: startseq man in up up his waves endseq</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594077716860564-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594077716860564-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594077716860564-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594077716860564-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594077716860564-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594077716860564-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594077716860564-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594077716860564-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594077716860564-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594077716860564-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594077716860564-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594077716860564-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594077716860564-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594077716860564-14">14</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594077716860564-1">Actual:    startseq three people are looking into photographic equipment endseq</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594077716860564-2">Predicted: startseq boy racer on on on on bike endseq</div><div class="crayon-line" id="crayon-5a6591c594077716860564-3"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594077716860564-4">Actual:    startseq boy is leaning on chair whilst another boy pulls him around with rope endseq</div><div class="crayon-line" id="crayon-5a6591c594077716860564-5">Predicted: startseq girl in playing on on on sword endseq</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594077716860564-6"> </div><div class="crayon-line" id="crayon-5a6591c594077716860564-7">Actual:    startseq black and brown dog jumping in midair near field endseq</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594077716860564-8">Predicted: startseq dog dog running running running and dog in grass endseq</div><div class="crayon-line" id="crayon-5a6591c594077716860564-9"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594077716860564-10">Actual:    startseq dog places his head on man face endseq</div><div class="crayon-line" id="crayon-5a6591c594077716860564-11">Predicted: startseq brown dog dog to to to to to to to ball endseq</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594077716860564-12"> </div><div class="crayon-line" id="crayon-5a6591c594077716860564-13">Actual:    startseq man in green hat is someplace up high endseq</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594077716860564-14">Predicted: startseq man in up up his waves endseq</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>We can see that the descriptions are not perfect, some are a little rough, but generally the model is generating somewhat readable text. A good starting point for improvement.</p>
<p>Next, let’s look at some experiments to vary the size or capacity of different sub-models.</p>
<h2>Network Size Parameters</h2>
<p>In this section, we will see how gross variations to the network structure impact model skill.</p>
<p>We will look at the following aspects of the model size:</p>
<ol>
<li>Size of the fixed-vector output from the ‘encoders’.</li>
<li>Size of the sequence encoder model.</li>
<li>Size of the language model.</li>
</ol>
<p>Let’s dive in.</p>
<h3>Size of Fixed-Length Vector</h3>
<p>In the baseline model, the photo feature extractor and the text sequence encoder both output a 128 element vector. These vectors are then concatenated to be processed by the language model.</p>
<p>The 128 element vector from each sub-model contains everything known about the input sequence and photo. We can vary the size of this vector to see if it impacts model skill</p>
<p>First, we can decrease the size by half from 128 elements to 64 elements.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59407a837298436" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor (encoder)
	inputs1 = Input(shape=(7, 7, 512))
	fe1 = GlobalMaxPooling2D()(inputs1)
	fe2 = Dense(64, activation='relu')(fe1)
	fe3 = RepeatVector(max_length)(fe2)
	# embedding
	inputs2 = Input(shape=(max_length,))
	emb2 = Embedding(vocab_size, 50, mask_zero=True)(inputs2)
	emb3 = LSTM(256, return_sequences=True)(emb2)
	emb4 = TimeDistributed(Dense(64, activation='relu'))(emb3)
	# merge inputs
	merged = concatenate([fe3, emb4])
	# language model (decoder)
	lm2 = LSTM(500)(merged)
	lm3 = Dense(500, activation='relu')(lm2)
	outputs = Dense(vocab_size, activation='softmax')(lm3)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
	return model</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59407a837298436-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407a837298436-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59407a837298436-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407a837298436-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59407a837298436-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407a837298436-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59407a837298436-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407a837298436-8">8</div><div class="crayon-num" data-line="crayon-5a6591c59407a837298436-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407a837298436-10">10</div><div class="crayon-num" data-line="crayon-5a6591c59407a837298436-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407a837298436-12">12</div><div class="crayon-num" data-line="crayon-5a6591c59407a837298436-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407a837298436-14">14</div><div class="crayon-num" data-line="crayon-5a6591c59407a837298436-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407a837298436-16">16</div><div class="crayon-num" data-line="crayon-5a6591c59407a837298436-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407a837298436-18">18</div><div class="crayon-num" data-line="crayon-5a6591c59407a837298436-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407a837298436-20">20</div><div class="crayon-num" data-line="crayon-5a6591c59407a837298436-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407a837298436-22">22</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59407a837298436-1"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407a837298436-2"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59407a837298436-3"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor (encoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407a837298436-4"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">512</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59407a837298436-5"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">GlobalMaxPooling2D</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407a837298436-6"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">64</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59407a837298436-7"><span class="crayon-h"> </span><span class="crayon-v">fe3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407a837298436-8"><span class="crayon-h"> </span><span class="crayon-p"># embedding</span></div><div class="crayon-line" id="crayon-5a6591c59407a837298436-9"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407a837298436-10"><span class="crayon-h"> </span><span class="crayon-v">emb2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59407a837298436-11"><span class="crayon-h"> </span><span class="crayon-v">emb3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407a837298436-12"><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">64</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59407a837298436-13"><span class="crayon-h"> </span><span class="crayon-p"># merge inputs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407a837298436-14"><span class="crayon-h"> </span><span class="crayon-v">merged</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concatenate</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59407a837298436-15"><span class="crayon-h"> </span><span class="crayon-p"># language model (decoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407a837298436-16"><span class="crayon-h"> </span><span class="crayon-v">lm2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">merged</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59407a837298436-17"><span class="crayon-h"> </span><span class="crayon-v">lm3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407a837298436-18"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59407a837298436-19"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407a837298436-20"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59407a837298436-21"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'accuracy'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407a837298436-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0024 seconds] -->
<p>We will name this model ‘<em>size_sm_fixed_vec</em>‘.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59407d147227802" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
model_name = 'size_sm_fixed_vec'</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59407d147227802-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59407d147227802-1"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'size_sm_fixed_vec'</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Running this experiment produces the following BLEU scores, perhaps a small gain over baseline on the test set.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59407f323121978" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
          train      test
count  3.000000  3.000000
mean   0.204421  0.063148
std    0.026992  0.003264
min    0.174769  0.059391
25%    0.192849  0.062074
50%    0.210929  0.064757
75%    0.219246  0.065026
max    0.227564  0.065295</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59407f323121978-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407f323121978-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59407f323121978-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407f323121978-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59407f323121978-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407f323121978-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59407f323121978-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59407f323121978-8">8</div><div class="crayon-num" data-line="crayon-5a6591c59407f323121978-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59407f323121978-1">          train      test</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407f323121978-2">count  3.000000  3.000000</div><div class="crayon-line" id="crayon-5a6591c59407f323121978-3">mean   0.204421  0.063148</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407f323121978-4">std    0.026992  0.003264</div><div class="crayon-line" id="crayon-5a6591c59407f323121978-5">min    0.174769  0.059391</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407f323121978-6">25%    0.192849  0.062074</div><div class="crayon-line" id="crayon-5a6591c59407f323121978-7">50%    0.210929  0.064757</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59407f323121978-8">75%    0.219246  0.065026</div><div class="crayon-line" id="crayon-5a6591c59407f323121978-9">max    0.227564  0.065295</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>We can also double the size of the fixed-length vector from 128 to 256 units.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594081267765917" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor (encoder)
	inputs1 = Input(shape=(7, 7, 512))
	fe1 = GlobalMaxPooling2D()(inputs1)
	fe2 = Dense(256, activation='relu')(fe1)
	fe3 = RepeatVector(max_length)(fe2)
	# embedding
	inputs2 = Input(shape=(max_length,))
	emb2 = Embedding(vocab_size, 50, mask_zero=True)(inputs2)
	emb3 = LSTM(256, return_sequences=True)(emb2)
	emb4 = TimeDistributed(Dense(256, activation='relu'))(emb3)
	# merge inputs
	merged = concatenate([fe3, emb4])
	# language model (decoder)
	lm2 = LSTM(500)(merged)
	lm3 = Dense(500, activation='relu')(lm2)
	outputs = Dense(vocab_size, activation='softmax')(lm3)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
	return model</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594081267765917-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594081267765917-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594081267765917-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594081267765917-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594081267765917-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594081267765917-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594081267765917-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594081267765917-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594081267765917-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594081267765917-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594081267765917-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594081267765917-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594081267765917-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594081267765917-14">14</div><div class="crayon-num" data-line="crayon-5a6591c594081267765917-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594081267765917-16">16</div><div class="crayon-num" data-line="crayon-5a6591c594081267765917-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594081267765917-18">18</div><div class="crayon-num" data-line="crayon-5a6591c594081267765917-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594081267765917-20">20</div><div class="crayon-num" data-line="crayon-5a6591c594081267765917-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594081267765917-22">22</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594081267765917-1"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594081267765917-2"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594081267765917-3"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor (encoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594081267765917-4"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">512</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594081267765917-5"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">GlobalMaxPooling2D</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594081267765917-6"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594081267765917-7"><span class="crayon-h"> </span><span class="crayon-v">fe3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594081267765917-8"><span class="crayon-h"> </span><span class="crayon-p"># embedding</span></div><div class="crayon-line" id="crayon-5a6591c594081267765917-9"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594081267765917-10"><span class="crayon-h"> </span><span class="crayon-v">emb2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594081267765917-11"><span class="crayon-h"> </span><span class="crayon-v">emb3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594081267765917-12"><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594081267765917-13"><span class="crayon-h"> </span><span class="crayon-p"># merge inputs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594081267765917-14"><span class="crayon-h"> </span><span class="crayon-v">merged</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concatenate</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594081267765917-15"><span class="crayon-h"> </span><span class="crayon-p"># language model (decoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594081267765917-16"><span class="crayon-h"> </span><span class="crayon-v">lm2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">merged</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594081267765917-17"><span class="crayon-h"> </span><span class="crayon-v">lm3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594081267765917-18"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594081267765917-19"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594081267765917-20"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594081267765917-21"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'accuracy'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594081267765917-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0025 seconds] -->
<p>We will name this configuration ‘<em>size_lg_fixed_vec</em>‘.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594084257879233" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
model_name = 'size_lg_fixed_vec'</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594084257879233-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594084257879233-1"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'size_lg_fixed_vec'</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>Running this experiment shows BLEU scores suggesting that the model is not better off.</p>
<p>It is possible that with more data and/or longer training, we may see a different story.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594086239360420" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
          train      test
count  3.000000  3.000000
mean   0.023517  0.027813
std    0.009951  0.010525
min    0.012037  0.021737
25%    0.020435  0.021737
50%    0.028833  0.021737
75%    0.029257  0.030852
max    0.029682  0.039966</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594086239360420-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594086239360420-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594086239360420-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594086239360420-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594086239360420-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594086239360420-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594086239360420-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594086239360420-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594086239360420-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594086239360420-1">          train      test</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594086239360420-2">count  3.000000  3.000000</div><div class="crayon-line" id="crayon-5a6591c594086239360420-3">mean   0.023517  0.027813</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594086239360420-4">std    0.009951  0.010525</div><div class="crayon-line" id="crayon-5a6591c594086239360420-5">min    0.012037  0.021737</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594086239360420-6">25%    0.020435  0.021737</div><div class="crayon-line" id="crayon-5a6591c594086239360420-7">50%    0.028833  0.021737</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594086239360420-8">75%    0.029257  0.030852</div><div class="crayon-line" id="crayon-5a6591c594086239360420-9">max    0.029682  0.039966</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<h3>Sequence Encoder Size</h3>
<p>We can call the sub-model that interprets the input sequence of words generated so far as the sequence encoder.</p>
<p>First, we can try to see if decreasing the representational capacity of the sequence encoder impacts model skill. We can reduce the number of memory units in the LSTM layer from 256 to 128.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594088424806087" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor (encoder)
	inputs1 = Input(shape=(7, 7, 512))
	fe1 = GlobalMaxPooling2D()(inputs1)
	fe2 = Dense(128, activation='relu')(fe1)
	fe3 = RepeatVector(max_length)(fe2)
	# embedding
	inputs2 = Input(shape=(max_length,))
	emb2 = Embedding(vocab_size, 50, mask_zero=True)(inputs2)
	emb3 = LSTM(128, return_sequences=True)(emb2)
	emb4 = TimeDistributed(Dense(128, activation='relu'))(emb3)
	# merge inputs
	merged = concatenate([fe3, emb4])
	# language model (decoder)
	lm2 = LSTM(500)(merged)
	lm3 = Dense(500, activation='relu')(lm2)
	outputs = Dense(vocab_size, activation='softmax')(lm3)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
	return model

model_name = 'size_sm_seq_model'</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594088424806087-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594088424806087-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594088424806087-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594088424806087-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594088424806087-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594088424806087-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594088424806087-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594088424806087-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594088424806087-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594088424806087-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594088424806087-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594088424806087-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594088424806087-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594088424806087-14">14</div><div class="crayon-num" data-line="crayon-5a6591c594088424806087-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594088424806087-16">16</div><div class="crayon-num" data-line="crayon-5a6591c594088424806087-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594088424806087-18">18</div><div class="crayon-num" data-line="crayon-5a6591c594088424806087-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594088424806087-20">20</div><div class="crayon-num" data-line="crayon-5a6591c594088424806087-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594088424806087-22">22</div><div class="crayon-num" data-line="crayon-5a6591c594088424806087-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594088424806087-24">24</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594088424806087-1"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594088424806087-2"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594088424806087-3"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor (encoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594088424806087-4"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">512</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594088424806087-5"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">GlobalMaxPooling2D</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594088424806087-6"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594088424806087-7"><span class="crayon-h"> </span><span class="crayon-v">fe3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594088424806087-8"><span class="crayon-h"> </span><span class="crayon-p"># embedding</span></div><div class="crayon-line" id="crayon-5a6591c594088424806087-9"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594088424806087-10"><span class="crayon-h"> </span><span class="crayon-v">emb2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594088424806087-11"><span class="crayon-h"> </span><span class="crayon-v">emb3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594088424806087-12"><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594088424806087-13"><span class="crayon-h"> </span><span class="crayon-p"># merge inputs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594088424806087-14"><span class="crayon-h"> </span><span class="crayon-v">merged</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concatenate</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594088424806087-15"><span class="crayon-h"> </span><span class="crayon-p"># language model (decoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594088424806087-16"><span class="crayon-h"> </span><span class="crayon-v">lm2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">merged</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594088424806087-17"><span class="crayon-h"> </span><span class="crayon-v">lm3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594088424806087-18"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594088424806087-19"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594088424806087-20"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594088424806087-21"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'accuracy'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594088424806087-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">model</span></div><div class="crayon-line" id="crayon-5a6591c594088424806087-23"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594088424806087-24"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'size_sm_seq_model'</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0023 seconds] -->
<p>Running this example, we can see perhaps a small bump on both train and test over baseline. This might be an artifact of the small training set size.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59408b602471240" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
          train      test
count  3.000000  3.000000
mean   0.074944  0.053917
std    0.014263  0.013264
min    0.066292  0.039142
25%    0.066713  0.048476
50%    0.067134  0.057810
75%    0.079270  0.061304
max    0.091406  0.064799</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59408b602471240-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408b602471240-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59408b602471240-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408b602471240-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59408b602471240-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408b602471240-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59408b602471240-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408b602471240-8">8</div><div class="crayon-num" data-line="crayon-5a6591c59408b602471240-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59408b602471240-1">          train      test</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408b602471240-2">count  3.000000  3.000000</div><div class="crayon-line" id="crayon-5a6591c59408b602471240-3">mean   0.074944  0.053917</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408b602471240-4">std    0.014263  0.013264</div><div class="crayon-line" id="crayon-5a6591c59408b602471240-5">min    0.066292  0.039142</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408b602471240-6">25%    0.066713  0.048476</div><div class="crayon-line" id="crayon-5a6591c59408b602471240-7">50%    0.067134  0.057810</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408b602471240-8">75%    0.079270  0.061304</div><div class="crayon-line" id="crayon-5a6591c59408b602471240-9">max    0.091406  0.064799</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Going the other way, we can double the number of LSTM layers from one to two and see if that makes a dramatic difference.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59408e862329826" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor (encoder)
	inputs1 = Input(shape=(7, 7, 512))
	fe1 = GlobalMaxPooling2D()(inputs1)
	fe2 = Dense(128, activation='relu')(fe1)
	fe3 = RepeatVector(max_length)(fe2)
	# embedding
	inputs2 = Input(shape=(max_length,))
	emb2 = Embedding(vocab_size, 50, mask_zero=True)(inputs2)
	emb3 = LSTM(256, return_sequences=True)(emb2)
	emb4 = LSTM(256, return_sequences=True)(emb3)
	emb5 = TimeDistributed(Dense(128, activation='relu'))(emb4)
	# merge inputs
	merged = concatenate([fe3, emb5])
	# language model (decoder)
	lm2 = LSTM(500)(merged)
	lm3 = Dense(500, activation='relu')(lm2)
	outputs = Dense(vocab_size, activation='softmax')(lm3)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
	return model

model_name = 'size_lg_seq_model'</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59408e862329826-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408e862329826-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59408e862329826-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408e862329826-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59408e862329826-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408e862329826-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59408e862329826-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408e862329826-8">8</div><div class="crayon-num" data-line="crayon-5a6591c59408e862329826-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408e862329826-10">10</div><div class="crayon-num" data-line="crayon-5a6591c59408e862329826-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408e862329826-12">12</div><div class="crayon-num" data-line="crayon-5a6591c59408e862329826-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408e862329826-14">14</div><div class="crayon-num" data-line="crayon-5a6591c59408e862329826-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408e862329826-16">16</div><div class="crayon-num" data-line="crayon-5a6591c59408e862329826-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408e862329826-18">18</div><div class="crayon-num" data-line="crayon-5a6591c59408e862329826-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408e862329826-20">20</div><div class="crayon-num" data-line="crayon-5a6591c59408e862329826-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408e862329826-22">22</div><div class="crayon-num" data-line="crayon-5a6591c59408e862329826-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59408e862329826-24">24</div><div class="crayon-num" data-line="crayon-5a6591c59408e862329826-25">25</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59408e862329826-1"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408e862329826-2"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59408e862329826-3"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor (encoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408e862329826-4"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">512</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59408e862329826-5"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">GlobalMaxPooling2D</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408e862329826-6"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59408e862329826-7"><span class="crayon-h"> </span><span class="crayon-v">fe3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408e862329826-8"><span class="crayon-h"> </span><span class="crayon-p"># embedding</span></div><div class="crayon-line" id="crayon-5a6591c59408e862329826-9"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408e862329826-10"><span class="crayon-h"> </span><span class="crayon-v">emb2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59408e862329826-11"><span class="crayon-h"> </span><span class="crayon-v">emb3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408e862329826-12"><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59408e862329826-13"><span class="crayon-h"> </span><span class="crayon-v">emb5</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb4</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408e862329826-14"><span class="crayon-h"> </span><span class="crayon-p"># merge inputs</span></div><div class="crayon-line" id="crayon-5a6591c59408e862329826-15"><span class="crayon-h"> </span><span class="crayon-v">merged</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concatenate</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">emb5</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408e862329826-16"><span class="crayon-h"> </span><span class="crayon-p"># language model (decoder)</span></div><div class="crayon-line" id="crayon-5a6591c59408e862329826-17"><span class="crayon-h"> </span><span class="crayon-v">lm2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">merged</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408e862329826-18"><span class="crayon-h"> </span><span class="crayon-v">lm3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59408e862329826-19"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm3</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408e862329826-20"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line" id="crayon-5a6591c59408e862329826-21"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408e862329826-22"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'accuracy'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59408e862329826-23"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59408e862329826-24"> </div><div class="crayon-line" id="crayon-5a6591c59408e862329826-25"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'size_lg_seq_model'</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0026 seconds] -->
<p>Running this experiment shows a decent bump in BLEU on both train and test sets.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594091246746062" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
          train      test
count  3.000000  3.000000
mean   0.094937  0.096970
std    0.022394  0.079270
min    0.069151  0.046722
25%    0.087656  0.051279
50%    0.106161  0.055836
75%    0.107830  0.122094
max    0.109499  0.188351</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594091246746062-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594091246746062-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594091246746062-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594091246746062-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594091246746062-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594091246746062-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594091246746062-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594091246746062-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594091246746062-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594091246746062-1">          train      test</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594091246746062-2">count  3.000000  3.000000</div><div class="crayon-line" id="crayon-5a6591c594091246746062-3">mean   0.094937  0.096970</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594091246746062-4">std    0.022394  0.079270</div><div class="crayon-line" id="crayon-5a6591c594091246746062-5">min    0.069151  0.046722</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594091246746062-6">25%    0.087656  0.051279</div><div class="crayon-line" id="crayon-5a6591c594091246746062-7">50%    0.106161  0.055836</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594091246746062-8">75%    0.107830  0.122094</div><div class="crayon-line" id="crayon-5a6591c594091246746062-9">max    0.109499  0.188351</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>We can also try to increase the representational capacity of the word embedding by doubling it from 50-dimensions to 100-dimensions.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594093624461491" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor (encoder)
	inputs1 = Input(shape=(7, 7, 512))
	fe1 = GlobalMaxPooling2D()(inputs1)
	fe2 = Dense(128, activation='relu')(fe1)
	fe3 = RepeatVector(max_length)(fe2)
	# embedding
	inputs2 = Input(shape=(max_length,))
	emb2 = Embedding(vocab_size, 100, mask_zero=True)(inputs2)
	emb3 = LSTM(256, return_sequences=True)(emb2)
	emb4 = TimeDistributed(Dense(128, activation='relu'))(emb3)
	# merge inputs
	merged = concatenate([fe3, emb4])
	# language model (decoder)
	lm2 = LSTM(500)(merged)
	lm3 = Dense(500, activation='relu')(lm2)
	outputs = Dense(vocab_size, activation='softmax')(lm3)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
	return model

model_name = 'size_em_seq_model'</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594093624461491-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594093624461491-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594093624461491-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594093624461491-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594093624461491-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594093624461491-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594093624461491-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594093624461491-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594093624461491-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594093624461491-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594093624461491-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594093624461491-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594093624461491-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594093624461491-14">14</div><div class="crayon-num" data-line="crayon-5a6591c594093624461491-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594093624461491-16">16</div><div class="crayon-num" data-line="crayon-5a6591c594093624461491-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594093624461491-18">18</div><div class="crayon-num" data-line="crayon-5a6591c594093624461491-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594093624461491-20">20</div><div class="crayon-num" data-line="crayon-5a6591c594093624461491-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594093624461491-22">22</div><div class="crayon-num" data-line="crayon-5a6591c594093624461491-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594093624461491-24">24</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594093624461491-1"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594093624461491-2"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594093624461491-3"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor (encoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594093624461491-4"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">512</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594093624461491-5"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">GlobalMaxPooling2D</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594093624461491-6"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594093624461491-7"><span class="crayon-h"> </span><span class="crayon-v">fe3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594093624461491-8"><span class="crayon-h"> </span><span class="crayon-p"># embedding</span></div><div class="crayon-line" id="crayon-5a6591c594093624461491-9"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594093624461491-10"><span class="crayon-h"> </span><span class="crayon-v">emb2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594093624461491-11"><span class="crayon-h"> </span><span class="crayon-v">emb3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594093624461491-12"><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594093624461491-13"><span class="crayon-h"> </span><span class="crayon-p"># merge inputs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594093624461491-14"><span class="crayon-h"> </span><span class="crayon-v">merged</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concatenate</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594093624461491-15"><span class="crayon-h"> </span><span class="crayon-p"># language model (decoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594093624461491-16"><span class="crayon-h"> </span><span class="crayon-v">lm2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">merged</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594093624461491-17"><span class="crayon-h"> </span><span class="crayon-v">lm3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594093624461491-18"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594093624461491-19"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594093624461491-20"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594093624461491-21"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'accuracy'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594093624461491-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">model</span></div><div class="crayon-line" id="crayon-5a6591c594093624461491-23"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594093624461491-24"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'size_em_seq_model'</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0024 seconds] -->
<p>We see a large movement on the training dataset, but perhaps little movement on the test dataset.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594096878660185" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
count  3.000000  3.000000
mean   0.112743  0.050935
std    0.017136  0.006860
min    0.096121  0.043741
25%    0.103940  0.047701
50%    0.111759  0.051661
75%    0.121055  0.054533
max    0.130350  0.057404</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594096878660185-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594096878660185-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594096878660185-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594096878660185-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594096878660185-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594096878660185-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594096878660185-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594096878660185-8">8</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594096878660185-1">count  3.000000  3.000000</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594096878660185-2">mean   0.112743  0.050935</div><div class="crayon-line" id="crayon-5a6591c594096878660185-3">std    0.017136  0.006860</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594096878660185-4">min    0.096121  0.043741</div><div class="crayon-line" id="crayon-5a6591c594096878660185-5">25%    0.103940  0.047701</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594096878660185-6">50%    0.111759  0.051661</div><div class="crayon-line" id="crayon-5a6591c594096878660185-7">75%    0.121055  0.054533</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594096878660185-8">max    0.130350  0.057404</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<h3>Size of Language Model</h3>
<p>We can refer to the model that learns from the concatenated sequence and photo feature input as the language model. It is responsible for generating words.</p>
<p>First, we can look at the impact on model skill by cutting the LSTM and dense layers from 500 to 256 neurons.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c594099910479217" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor (encoder)
	inputs1 = Input(shape=(7, 7, 512))
	fe1 = GlobalMaxPooling2D()(inputs1)
	fe2 = Dense(128, activation='relu')(fe1)
	fe3 = RepeatVector(max_length)(fe2)
	# embedding
	inputs2 = Input(shape=(max_length,))
	emb2 = Embedding(vocab_size, 50, mask_zero=True)(inputs2)
	emb3 = LSTM(256, return_sequences=True)(emb2)
	emb4 = TimeDistributed(Dense(128, activation='relu'))(emb3)
	# merge inputs
	merged = concatenate([fe3, emb4])
	# language model (decoder)
	lm2 = LSTM(256)(merged)
	lm3 = Dense(256, activation='relu')(lm2)
	outputs = Dense(vocab_size, activation='softmax')(lm3)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
	return model

model_name = 'size_sm_lang_model'</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c594099910479217-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594099910479217-2">2</div><div class="crayon-num" data-line="crayon-5a6591c594099910479217-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594099910479217-4">4</div><div class="crayon-num" data-line="crayon-5a6591c594099910479217-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594099910479217-6">6</div><div class="crayon-num" data-line="crayon-5a6591c594099910479217-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594099910479217-8">8</div><div class="crayon-num" data-line="crayon-5a6591c594099910479217-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594099910479217-10">10</div><div class="crayon-num" data-line="crayon-5a6591c594099910479217-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594099910479217-12">12</div><div class="crayon-num" data-line="crayon-5a6591c594099910479217-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594099910479217-14">14</div><div class="crayon-num" data-line="crayon-5a6591c594099910479217-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594099910479217-16">16</div><div class="crayon-num" data-line="crayon-5a6591c594099910479217-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594099910479217-18">18</div><div class="crayon-num" data-line="crayon-5a6591c594099910479217-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594099910479217-20">20</div><div class="crayon-num" data-line="crayon-5a6591c594099910479217-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594099910479217-22">22</div><div class="crayon-num" data-line="crayon-5a6591c594099910479217-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c594099910479217-24">24</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c594099910479217-1"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594099910479217-2"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c594099910479217-3"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor (encoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594099910479217-4"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">512</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594099910479217-5"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">GlobalMaxPooling2D</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594099910479217-6"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594099910479217-7"><span class="crayon-h"> </span><span class="crayon-v">fe3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594099910479217-8"><span class="crayon-h"> </span><span class="crayon-p"># embedding</span></div><div class="crayon-line" id="crayon-5a6591c594099910479217-9"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594099910479217-10"><span class="crayon-h"> </span><span class="crayon-v">emb2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594099910479217-11"><span class="crayon-h"> </span><span class="crayon-v">emb3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594099910479217-12"><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594099910479217-13"><span class="crayon-h"> </span><span class="crayon-p"># merge inputs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594099910479217-14"><span class="crayon-h"> </span><span class="crayon-v">merged</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concatenate</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594099910479217-15"><span class="crayon-h"> </span><span class="crayon-p"># language model (decoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594099910479217-16"><span class="crayon-h"> </span><span class="crayon-v">lm2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">merged</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594099910479217-17"><span class="crayon-h"> </span><span class="crayon-v">lm3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594099910479217-18"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594099910479217-19"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594099910479217-20"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c594099910479217-21"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'accuracy'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594099910479217-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">model</span></div><div class="crayon-line" id="crayon-5a6591c594099910479217-23"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c594099910479217-24"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'size_sm_lang_model'</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0023 seconds] -->
<p>We can see that this has a small positive effect on BLEU for both training and test datasets, again, likely related to the small size of the datasets.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59409b968883737" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
          train      test
count  3.000000  3.000000
mean   0.063632  0.056059
std    0.018521  0.009064
min    0.045127  0.048916
25%    0.054363  0.050961
50%    0.063599  0.053005
75%    0.072884  0.059630
max    0.082169  0.066256</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59409b968883737-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409b968883737-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59409b968883737-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409b968883737-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59409b968883737-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409b968883737-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59409b968883737-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409b968883737-8">8</div><div class="crayon-num" data-line="crayon-5a6591c59409b968883737-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59409b968883737-1">          train      test</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409b968883737-2">count  3.000000  3.000000</div><div class="crayon-line" id="crayon-5a6591c59409b968883737-3">mean   0.063632  0.056059</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409b968883737-4">std    0.018521  0.009064</div><div class="crayon-line" id="crayon-5a6591c59409b968883737-5">min    0.045127  0.048916</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409b968883737-6">25%    0.054363  0.050961</div><div class="crayon-line" id="crayon-5a6591c59409b968883737-7">50%    0.063599  0.053005</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409b968883737-8">75%    0.072884  0.059630</div><div class="crayon-line" id="crayon-5a6591c59409b968883737-9">max    0.082169  0.066256</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>We can also look at the impact of doubling the capacity of the language model by adding a second LSTM layer of the same size.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c59409e420909619" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor (encoder)
	inputs1 = Input(shape=(7, 7, 512))
	fe1 = GlobalMaxPooling2D()(inputs1)
	fe2 = Dense(128, activation='relu')(fe1)
	fe3 = RepeatVector(max_length)(fe2)
	# embedding
	inputs2 = Input(shape=(max_length,))
	emb2 = Embedding(vocab_size, 50, mask_zero=True)(inputs2)
	emb3 = LSTM(256, return_sequences=True)(emb2)
	emb4 = TimeDistributed(Dense(128, activation='relu'))(emb3)
	# merge inputs
	merged = concatenate([fe3, emb4])
	# language model (decoder)
	lm2 = LSTM(500, return_sequences=True)(merged)
	lm3 = LSTM(500)(lm2)
	lm4 = Dense(500, activation='relu')(lm3)
	outputs = Dense(vocab_size, activation='softmax')(lm4)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
	return model

model_name = 'size_lg_lang_model'</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c59409e420909619-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409e420909619-2">2</div><div class="crayon-num" data-line="crayon-5a6591c59409e420909619-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409e420909619-4">4</div><div class="crayon-num" data-line="crayon-5a6591c59409e420909619-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409e420909619-6">6</div><div class="crayon-num" data-line="crayon-5a6591c59409e420909619-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409e420909619-8">8</div><div class="crayon-num" data-line="crayon-5a6591c59409e420909619-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409e420909619-10">10</div><div class="crayon-num" data-line="crayon-5a6591c59409e420909619-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409e420909619-12">12</div><div class="crayon-num" data-line="crayon-5a6591c59409e420909619-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409e420909619-14">14</div><div class="crayon-num" data-line="crayon-5a6591c59409e420909619-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409e420909619-16">16</div><div class="crayon-num" data-line="crayon-5a6591c59409e420909619-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409e420909619-18">18</div><div class="crayon-num" data-line="crayon-5a6591c59409e420909619-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409e420909619-20">20</div><div class="crayon-num" data-line="crayon-5a6591c59409e420909619-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409e420909619-22">22</div><div class="crayon-num" data-line="crayon-5a6591c59409e420909619-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c59409e420909619-24">24</div><div class="crayon-num" data-line="crayon-5a6591c59409e420909619-25">25</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c59409e420909619-1"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409e420909619-2"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c59409e420909619-3"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor (encoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409e420909619-4"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">512</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59409e420909619-5"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">GlobalMaxPooling2D</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409e420909619-6"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59409e420909619-7"><span class="crayon-h"> </span><span class="crayon-v">fe3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409e420909619-8"><span class="crayon-h"> </span><span class="crayon-p"># embedding</span></div><div class="crayon-line" id="crayon-5a6591c59409e420909619-9"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409e420909619-10"><span class="crayon-h"> </span><span class="crayon-v">emb2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59409e420909619-11"><span class="crayon-h"> </span><span class="crayon-v">emb3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409e420909619-12"><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59409e420909619-13"><span class="crayon-h"> </span><span class="crayon-p"># merge inputs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409e420909619-14"><span class="crayon-h"> </span><span class="crayon-v">merged</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concatenate</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59409e420909619-15"><span class="crayon-h"> </span><span class="crayon-p"># language model (decoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409e420909619-16"><span class="crayon-h"> </span><span class="crayon-v">lm2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">merged</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59409e420909619-17"><span class="crayon-h"> </span><span class="crayon-v">lm3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409e420909619-18"><span class="crayon-h"> </span><span class="crayon-v">lm4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59409e420909619-19"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm4</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409e420909619-20"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line" id="crayon-5a6591c59409e420909619-21"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409e420909619-22"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'accuracy'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c59409e420909619-23"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c59409e420909619-24"> </div><div class="crayon-line" id="crayon-5a6591c59409e420909619-25"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'size_lg_lang_model'</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0026 seconds] -->
<p>Again, we see minor movements in BLEU, perhaps an artifact of noise and dataset size. The improvement on the test</p>
<p>The improvement on the test dataset may be a good sign. This might be a change worth exploring.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940a1012796102" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
          train      test
count  3.000000  3.000000
mean   0.043838  0.067658
std    0.037580  0.045813
min    0.017990  0.015757
25%    0.022284  0.050252
50%    0.026578  0.084748
75%    0.056763  0.093608
max    0.086948  0.102469</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940a1012796102-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a1012796102-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940a1012796102-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a1012796102-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940a1012796102-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a1012796102-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940a1012796102-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a1012796102-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940a1012796102-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940a1012796102-1">          train      test</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a1012796102-2">count  3.000000  3.000000</div><div class="crayon-line" id="crayon-5a6591c5940a1012796102-3">mean   0.043838  0.067658</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a1012796102-4">std    0.037580  0.045813</div><div class="crayon-line" id="crayon-5a6591c5940a1012796102-5">min    0.017990  0.015757</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a1012796102-6">25%    0.022284  0.050252</div><div class="crayon-line" id="crayon-5a6591c5940a1012796102-7">50%    0.026578  0.084748</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a1012796102-8">75%    0.056763  0.093608</div><div class="crayon-line" id="crayon-5a6591c5940a1012796102-9">max    0.086948  0.102469</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Tuning model size on a much smaller dataset is challenging.</p>
<h2>Configuring the Feature Extraction Model</h2>
<p>The use of the pre-trained VGG16 model provides some additional points of configuration.</p>
<p>The baseline model removed the top from the VGG model, including a global max pooling layer, which then feeds into an encoding of the features to a 128 element vector.</p>
<p>In this section, we will look at the following modifications to the baseline model:</p>
<ol>
<li>Using a global average pooling layer after the VGG model.</li>
<li>Not using any global pooling.</li>
</ol>
<h3>Global Average Pooling</h3>
<p>We can replace the GlobalMaxPooling2D layer with a GlobalAveragePooling2D to achieve average pooling.</p>
<p>Global average pooling was developed to reduce overfitting for image classification problems, but may offer some benefit in interpreting the features extracted from the image.</p>
<p>For more on global average pooling, see the paper:</p>
<ul>
<li><a href="https://arxiv.org/abs/1312.4400">Network In Network</a>, 2013.</li>
</ul>
<p>The updated <em>define_model()</em> function and experiment name are listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940a3298189399" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor (encoder)
	inputs1 = Input(shape=(7, 7, 512))
	fe1 = GlobalAveragePooling2D()(inputs1)
	fe2 = Dense(128, activation='relu')(fe1)
	fe3 = RepeatVector(max_length)(fe2)
	# embedding
	inputs2 = Input(shape=(max_length,))
	emb2 = Embedding(vocab_size, 50, mask_zero=True)(inputs2)
	emb3 = LSTM(256, return_sequences=True)(emb2)
	emb4 = TimeDistributed(Dense(128, activation='relu'))(emb3)
	# merge inputs
	merged = concatenate([fe3, emb4])
	# language model (decoder)
	lm2 = LSTM(500)(merged)
	lm3 = Dense(500, activation='relu')(lm2)
	outputs = Dense(vocab_size, activation='softmax')(lm3)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
	return model

model_name = 'fe_avg_pool'</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940a3298189399-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a3298189399-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940a3298189399-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a3298189399-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940a3298189399-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a3298189399-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940a3298189399-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a3298189399-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940a3298189399-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a3298189399-10">10</div><div class="crayon-num" data-line="crayon-5a6591c5940a3298189399-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a3298189399-12">12</div><div class="crayon-num" data-line="crayon-5a6591c5940a3298189399-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a3298189399-14">14</div><div class="crayon-num" data-line="crayon-5a6591c5940a3298189399-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a3298189399-16">16</div><div class="crayon-num" data-line="crayon-5a6591c5940a3298189399-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a3298189399-18">18</div><div class="crayon-num" data-line="crayon-5a6591c5940a3298189399-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a3298189399-20">20</div><div class="crayon-num" data-line="crayon-5a6591c5940a3298189399-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a3298189399-22">22</div><div class="crayon-num" data-line="crayon-5a6591c5940a3298189399-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a3298189399-24">24</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940a3298189399-1"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a3298189399-2"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940a3298189399-3"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor (encoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a3298189399-4"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">512</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a3298189399-5"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">GlobalAveragePooling2D</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a3298189399-6"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a3298189399-7"><span class="crayon-h"> </span><span class="crayon-v">fe3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a3298189399-8"><span class="crayon-h"> </span><span class="crayon-p"># embedding</span></div><div class="crayon-line" id="crayon-5a6591c5940a3298189399-9"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a3298189399-10"><span class="crayon-h"> </span><span class="crayon-v">emb2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a3298189399-11"><span class="crayon-h"> </span><span class="crayon-v">emb3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a3298189399-12"><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a3298189399-13"><span class="crayon-h"> </span><span class="crayon-p"># merge inputs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a3298189399-14"><span class="crayon-h"> </span><span class="crayon-v">merged</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concatenate</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a3298189399-15"><span class="crayon-h"> </span><span class="crayon-p"># language model (decoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a3298189399-16"><span class="crayon-h"> </span><span class="crayon-v">lm2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">merged</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a3298189399-17"><span class="crayon-h"> </span><span class="crayon-v">lm3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a3298189399-18"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a3298189399-19"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a3298189399-20"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a3298189399-21"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'accuracy'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a3298189399-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">model</span></div><div class="crayon-line" id="crayon-5a6591c5940a3298189399-23"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a3298189399-24"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'fe_avg_pool'</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0025 seconds] -->
<p>The results suggest a dramatic improvement on the training dataset, which may be a sign of overfitting. We also see a small lift on test skill. This might be a change worth exploring.</p>
<p>We also see a small lift on test skill. This might be a change worth exploring.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940a7474051481" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
          train      test
count  3.000000  3.000000
mean   0.834627  0.060847
std    0.083259  0.040463
min    0.745074  0.017705
25%    0.797096  0.042294
50%    0.849118  0.066884
75%    0.879404  0.082418
max    0.909690  0.097952</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940a7474051481-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a7474051481-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940a7474051481-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a7474051481-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940a7474051481-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a7474051481-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940a7474051481-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a7474051481-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940a7474051481-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940a7474051481-1">          train      test</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a7474051481-2">count  3.000000  3.000000</div><div class="crayon-line" id="crayon-5a6591c5940a7474051481-3">mean   0.834627  0.060847</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a7474051481-4">std    0.083259  0.040463</div><div class="crayon-line" id="crayon-5a6591c5940a7474051481-5">min    0.745074  0.017705</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a7474051481-6">25%    0.797096  0.042294</div><div class="crayon-line" id="crayon-5a6591c5940a7474051481-7">50%    0.849118  0.066884</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a7474051481-8">75%    0.879404  0.082418</div><div class="crayon-line" id="crayon-5a6591c5940a7474051481-9">max    0.909690  0.097952</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<h3>No Pooling</h3>
<p>We can remove the GlobalMaxPooling2D and flatten the 3D photo feature and feed it directly into a Dense layer.</p>
<p>I would not expect this to be a good model design, but it is worth testing this assumption.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940a9599989100" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor (encoder)
	inputs1 = Input(shape=(7, 7, 512))
	fe1 = Flatten()(inputs1)
	fe2 = Dense(128, activation='relu')(fe1)
	fe3 = RepeatVector(max_length)(fe2)
	# embedding
	inputs2 = Input(shape=(max_length,))
	emb2 = Embedding(vocab_size, 50, mask_zero=True)(inputs2)
	emb3 = LSTM(256, return_sequences=True)(emb2)
	emb4 = TimeDistributed(Dense(128, activation='relu'))(emb3)
	# merge inputs
	merged = concatenate([fe3, emb4])
	# language model (decoder)
	lm2 = LSTM(500)(merged)
	lm3 = Dense(500, activation='relu')(lm2)
	outputs = Dense(vocab_size, activation='softmax')(lm3)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
	return model

model_name = 'fe_flat'</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940a9599989100-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a9599989100-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940a9599989100-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a9599989100-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940a9599989100-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a9599989100-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940a9599989100-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a9599989100-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940a9599989100-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a9599989100-10">10</div><div class="crayon-num" data-line="crayon-5a6591c5940a9599989100-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a9599989100-12">12</div><div class="crayon-num" data-line="crayon-5a6591c5940a9599989100-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a9599989100-14">14</div><div class="crayon-num" data-line="crayon-5a6591c5940a9599989100-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a9599989100-16">16</div><div class="crayon-num" data-line="crayon-5a6591c5940a9599989100-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a9599989100-18">18</div><div class="crayon-num" data-line="crayon-5a6591c5940a9599989100-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a9599989100-20">20</div><div class="crayon-num" data-line="crayon-5a6591c5940a9599989100-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a9599989100-22">22</div><div class="crayon-num" data-line="crayon-5a6591c5940a9599989100-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940a9599989100-24">24</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940a9599989100-1"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a9599989100-2"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940a9599989100-3"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor (encoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a9599989100-4"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">512</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a9599989100-5"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Flatten</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a9599989100-6"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a9599989100-7"><span class="crayon-h"> </span><span class="crayon-v">fe3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a9599989100-8"><span class="crayon-h"> </span><span class="crayon-p"># embedding</span></div><div class="crayon-line" id="crayon-5a6591c5940a9599989100-9"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a9599989100-10"><span class="crayon-h"> </span><span class="crayon-v">emb2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a9599989100-11"><span class="crayon-h"> </span><span class="crayon-v">emb3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a9599989100-12"><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a9599989100-13"><span class="crayon-h"> </span><span class="crayon-p"># merge inputs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a9599989100-14"><span class="crayon-h"> </span><span class="crayon-v">merged</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concatenate</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a9599989100-15"><span class="crayon-h"> </span><span class="crayon-p"># language model (decoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a9599989100-16"><span class="crayon-h"> </span><span class="crayon-v">lm2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">merged</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a9599989100-17"><span class="crayon-h"> </span><span class="crayon-v">lm3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a9599989100-18"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a9599989100-19"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a9599989100-20"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940a9599989100-21"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'accuracy'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a9599989100-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">model</span></div><div class="crayon-line" id="crayon-5a6591c5940a9599989100-23"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940a9599989100-24"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'fe_flat'</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0023 seconds] -->
<p>Surprisingly, we see a small lift on training data and a large lift on test data. This is surprising (to me) and may be worth further investigation.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940ac906339447" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
          train      test
count  3.000000  3.000000
mean   0.055988  0.135231
std    0.017566  0.079714
min    0.038605  0.044177
25%    0.047116  0.106633
50%    0.055627  0.169089
75%    0.064679  0.180758
max    0.073731  0.192428</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940ac906339447-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ac906339447-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940ac906339447-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ac906339447-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940ac906339447-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ac906339447-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940ac906339447-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ac906339447-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940ac906339447-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940ac906339447-1">          train      test</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ac906339447-2">count  3.000000  3.000000</div><div class="crayon-line" id="crayon-5a6591c5940ac906339447-3">mean   0.055988  0.135231</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ac906339447-4">std    0.017566  0.079714</div><div class="crayon-line" id="crayon-5a6591c5940ac906339447-5">min    0.038605  0.044177</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ac906339447-6">25%    0.047116  0.106633</div><div class="crayon-line" id="crayon-5a6591c5940ac906339447-7">50%    0.055627  0.169089</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ac906339447-8">75%    0.064679  0.180758</div><div class="crayon-line" id="crayon-5a6591c5940ac906339447-9">max    0.073731  0.192428</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>We can try repeating this experiment and provide more capacity for interpreting the extracted photo features. A new Dense layer with 500 neurons is added after the Flatten layer.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940ae964902942" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the captioning model
def define_model(vocab_size, max_length):
	# feature extractor (encoder)
	inputs1 = Input(shape=(7, 7, 512))
	fe1 = Flatten()(inputs1)
	fe2 = Dense(500, activation='relu')(fe1)
	fe3 = Dense(128, activation='relu')(fe2)
	fe4 = RepeatVector(max_length)(fe3)
	# embedding
	inputs2 = Input(shape=(max_length,))
	emb2 = Embedding(vocab_size, 50, mask_zero=True)(inputs2)
	emb3 = LSTM(256, return_sequences=True)(emb2)
	emb4 = TimeDistributed(Dense(128, activation='relu'))(emb3)
	# merge inputs
	merged = concatenate([fe4, emb4])
	# language model (decoder)
	lm2 = LSTM(500)(merged)
	lm3 = Dense(500, activation='relu')(lm2)
	outputs = Dense(vocab_size, activation='softmax')(lm3)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
	return model

model_name = 'fe_flat2'</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940ae964902942-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ae964902942-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940ae964902942-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ae964902942-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940ae964902942-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ae964902942-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940ae964902942-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ae964902942-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940ae964902942-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ae964902942-10">10</div><div class="crayon-num" data-line="crayon-5a6591c5940ae964902942-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ae964902942-12">12</div><div class="crayon-num" data-line="crayon-5a6591c5940ae964902942-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ae964902942-14">14</div><div class="crayon-num" data-line="crayon-5a6591c5940ae964902942-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ae964902942-16">16</div><div class="crayon-num" data-line="crayon-5a6591c5940ae964902942-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ae964902942-18">18</div><div class="crayon-num" data-line="crayon-5a6591c5940ae964902942-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ae964902942-20">20</div><div class="crayon-num" data-line="crayon-5a6591c5940ae964902942-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ae964902942-22">22</div><div class="crayon-num" data-line="crayon-5a6591c5940ae964902942-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ae964902942-24">24</div><div class="crayon-num" data-line="crayon-5a6591c5940ae964902942-25">25</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940ae964902942-1"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ae964902942-2"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940ae964902942-3"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor (encoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ae964902942-4"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">512</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ae964902942-5"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Flatten</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ae964902942-6"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ae964902942-7"><span class="crayon-h"> </span><span class="crayon-v">fe3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ae964902942-8"><span class="crayon-h"> </span><span class="crayon-v">fe4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ae964902942-9"><span class="crayon-h"> </span><span class="crayon-p"># embedding</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ae964902942-10"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ae964902942-11"><span class="crayon-h"> </span><span class="crayon-v">emb2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ae964902942-12"><span class="crayon-h"> </span><span class="crayon-v">emb3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ae964902942-13"><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb3</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ae964902942-14"><span class="crayon-h"> </span><span class="crayon-p"># merge inputs</span></div><div class="crayon-line" id="crayon-5a6591c5940ae964902942-15"><span class="crayon-h"> </span><span class="crayon-v">merged</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concatenate</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe4</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ae964902942-16"><span class="crayon-h"> </span><span class="crayon-p"># language model (decoder)</span></div><div class="crayon-line" id="crayon-5a6591c5940ae964902942-17"><span class="crayon-h"> </span><span class="crayon-v">lm2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">merged</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ae964902942-18"><span class="crayon-h"> </span><span class="crayon-v">lm3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ae964902942-19"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm3</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ae964902942-20"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line" id="crayon-5a6591c5940ae964902942-21"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ae964902942-22"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'accuracy'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ae964902942-23"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ae964902942-24"> </div><div class="crayon-line" id="crayon-5a6591c5940ae964902942-25"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'fe_flat2'</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0024 seconds] -->
<p>This results in a less impressive change and perhaps worse BLEU results on the test dataset.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940b1544551587" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
          train      test
count  3.000000  3.000000
mean   0.060126  0.029487
std    0.030300  0.013205
min    0.031235  0.020850
25%    0.044359  0.021887
50%    0.057483  0.022923
75%    0.074572  0.033805
max    0.091661  0.044688</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940b1544551587-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b1544551587-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940b1544551587-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b1544551587-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940b1544551587-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b1544551587-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940b1544551587-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b1544551587-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940b1544551587-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940b1544551587-1">          train      test</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b1544551587-2">count  3.000000  3.000000</div><div class="crayon-line" id="crayon-5a6591c5940b1544551587-3">mean   0.060126  0.029487</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b1544551587-4">std    0.030300  0.013205</div><div class="crayon-line" id="crayon-5a6591c5940b1544551587-5">min    0.031235  0.020850</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b1544551587-6">25%    0.044359  0.021887</div><div class="crayon-line" id="crayon-5a6591c5940b1544551587-7">50%    0.057483  0.022923</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b1544551587-8">75%    0.074572  0.033805</div><div class="crayon-line" id="crayon-5a6591c5940b1544551587-9">max    0.091661  0.044688</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<h2>Word Embedding Models</h2>
<p>A key part of the model is the sequence learning model that must interpret the sequence of words generated so far for a photo.</p>
<p>At the input to this sub-model is a word embedding and a good way to improve a word embedding over learning it from scratch as part of the model (as in the baseline model) is to use pre-trained word embeddings.</p>
<p>In this section, we will explore the impact of using a pre-trained word embedding on the model. Specifically:</p>
<ol>
<li>Training a Word2Vec Model</li>
<li>Training a Word2Vec Model + Fine Tuning</li>
</ol>
<h3>Trained word2vec Embedding</h3>
<p>An efficient learning algorithm for pre-training a word embedding from a corpus of text is the word2vec algorithm.</p>
<p>You can learn more about the word2vec algorithm here:</p>
<ul>
<li><a href="https://code.google.com/archive/p/word2vec/">Word2Vec Google Code Project</a></li>
</ul>
<p>We can use this algorithm to train a new standalone set of word vectors using the cleaned photo descriptions in the dataset.</p>
<p>The <a href="https://radimrehurek.com/gensim/models/word2vec.html">Gensim library</a> provides access to an implementation of the algorithm that we can use to pre-train the embedding.</p>
<p>First, we must load the clean photo descriptions for the training dataset, as before.</p>
<p>Next, we can fit the word2vec model on all of the clean descriptions. We should note that this includes more descriptions than the 50 used in the training dataset. A fairer model for these experiments should only be trained on those descriptions in the training dataset.</p>
<p>Once fit, we can save the words and word vectors to an ASCII file, perhaps for later inspection or visualization.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940b5460509703" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# train word2vec model
lines = [s.split() for s in train_descriptions.values()]
model = Word2Vec(lines, size=100, window=5, workers=8, min_count=1)
# summarize vocabulary size in model
words = list(model.wv.vocab)
print('Vocabulary size: %d' % len(words))

# save model in ASCII (word2vec) format
filename = 'custom_embedding.txt'
model.wv.save_word2vec_format(filename, binary=False)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940b5460509703-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b5460509703-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940b5460509703-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b5460509703-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940b5460509703-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b5460509703-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940b5460509703-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b5460509703-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940b5460509703-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b5460509703-10">10</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940b5460509703-1"><span class="crayon-p"># train word2vec model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b5460509703-2"><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">s</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c5940b5460509703-3"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Word2Vec</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">size</span><span class="crayon-o">=</span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">window</span><span class="crayon-o">=</span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">workers</span><span class="crayon-o">=</span><span class="crayon-cn">8</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">min_count</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b5460509703-4"><span class="crayon-p"># summarize vocabulary size in model</span></div><div class="crayon-line" id="crayon-5a6591c5940b5460509703-5"><span class="crayon-v">words</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">wv</span><span class="crayon-sy">.</span><span class="crayon-v">vocab</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b5460509703-6"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">words</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940b5460509703-7"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b5460509703-8"><span class="crayon-p"># save model in ASCII (word2vec) format</span></div><div class="crayon-line" id="crayon-5a6591c5940b5460509703-9"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'custom_embedding.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b5460509703-10"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">wv</span><span class="crayon-sy">.</span><span class="crayon-e">save_word2vec_format</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">binary</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0015 seconds] -->
<p>The word embedding is saved to the file ‘<em>custom_embedding.txt</em>‘.</p>
<p>Now, we can load the embedding into memory, retrieve only the word vectors for the words in our vocabulary, then save them to a new file.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940b7749584340" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load the whole embedding into memory
embedding = dict()
file = open('custom_embedding.txt')
for line in file:
	values = line.split()
	word = values[0]
	coefs = asarray(values[1:], dtype='float32')
	embedding[word] = coefs
file.close()
print('Embedding Size: %d' % len(embedding))

# summarize vocabulary
all_tokens = ' '.join(train_descriptions.values()).split()
vocabulary = set(all_tokens)
print('Vocabulary Size: %d' % len(vocabulary))

# get the vectors for words in our vocab
cust_embedding = dict()
for word in vocabulary:
	# check if word in embedding
	if word not in embedding:
		continue
	cust_embedding[word] = embedding[word]
print('Custom Embedding %d' % len(cust_embedding))

# save
dump(cust_embedding, open('word2vec_embedding.pkl', 'wb'))
print('Saved Embedding')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940b7749584340-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b7749584340-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940b7749584340-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b7749584340-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940b7749584340-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b7749584340-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940b7749584340-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b7749584340-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940b7749584340-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b7749584340-10">10</div><div class="crayon-num" data-line="crayon-5a6591c5940b7749584340-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b7749584340-12">12</div><div class="crayon-num" data-line="crayon-5a6591c5940b7749584340-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b7749584340-14">14</div><div class="crayon-num" data-line="crayon-5a6591c5940b7749584340-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b7749584340-16">16</div><div class="crayon-num" data-line="crayon-5a6591c5940b7749584340-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b7749584340-18">18</div><div class="crayon-num" data-line="crayon-5a6591c5940b7749584340-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b7749584340-20">20</div><div class="crayon-num" data-line="crayon-5a6591c5940b7749584340-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b7749584340-22">22</div><div class="crayon-num" data-line="crayon-5a6591c5940b7749584340-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b7749584340-24">24</div><div class="crayon-num" data-line="crayon-5a6591c5940b7749584340-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b7749584340-26">26</div><div class="crayon-num" data-line="crayon-5a6591c5940b7749584340-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940b7749584340-28">28</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940b7749584340-1"><span class="crayon-p"># load the whole embedding into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b7749584340-2"><span class="crayon-v">embedding</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940b7749584340-3"><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'custom_embedding.txt'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b7749584340-4"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940b7749584340-5"><span class="crayon-h"> </span><span class="crayon-v">values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b7749584340-6"><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c5940b7749584340-7"><span class="crayon-h"> </span><span class="crayon-v">coefs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">asarray</span><span class="crayon-sy">(</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dtype</span><span class="crayon-o">=</span><span class="crayon-s">'float32'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b7749584340-8"><span class="crayon-h"> </span><span class="crayon-v">embedding</span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">coefs</span></div><div class="crayon-line" id="crayon-5a6591c5940b7749584340-9"><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b7749584340-10"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Embedding Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">embedding</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940b7749584340-11"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b7749584340-12"><span class="crayon-p"># summarize vocabulary</span></div><div class="crayon-line" id="crayon-5a6591c5940b7749584340-13"><span class="crayon-v">all_tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b7749584340-14"><span class="crayon-v">vocabulary</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">all_tokens</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940b7749584340-15"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">vocabulary</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b7749584340-16"> </div><div class="crayon-line" id="crayon-5a6591c5940b7749584340-17"><span class="crayon-p"># get the vectors for words in our vocab</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b7749584340-18"><span class="crayon-v">cust_embedding</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940b7749584340-19"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">vocabulary</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b7749584340-20"><span class="crayon-h"> </span><span class="crayon-p"># check if word in embedding</span></div><div class="crayon-line" id="crayon-5a6591c5940b7749584340-21"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">embedding</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b7749584340-22"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line" id="crayon-5a6591c5940b7749584340-23"><span class="crayon-h"> </span><span class="crayon-v">cust_embedding</span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">embedding</span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b7749584340-24"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Custom Embedding %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">cust_embedding</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940b7749584340-25"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b7749584340-26"><span class="crayon-p"># save</span></div><div class="crayon-line" id="crayon-5a6591c5940b7749584340-27"><span class="crayon-e">dump</span><span class="crayon-sy">(</span><span class="crayon-v">cust_embedding</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'word2vec_embedding.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940b7749584340-28"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Saved Embedding'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0029 seconds] -->
<p>The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940ba636723626" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# prepare word vectors for captioning model

from numpy import asarray
from pickle import dump
from gensim.models import Word2Vec

# load doc into memory
def load_doc(filename):
	# open the file as read only
	file = open(filename, 'r')
	# read all text
	text = file.read()
	# close the file
	file.close()
	return text

# load a pre-defined list of photo identifiers
def load_set(filename):
	doc = load_doc(filename)
	dataset = list()
	# process line by line
	for line in doc.split('\n'):
		# skip empty lines
		if len(line) &lt; 1:
			continue
		# get the image identifier
		identifier = line.split('.')[0]
		dataset.append(identifier)
	return set(dataset)

# split a dataset into train/test elements
def train_test_split(dataset):
	# order keys so the split is consistent
	ordered = sorted(dataset)
	# return split dataset as two new sets
	return set(ordered[:100]), set(ordered[100:200])

# load clean descriptions into memory
def load_clean_descriptions(filename, dataset):
	# load document
	doc = load_doc(filename)
	descriptions = dict()
	for line in doc.split('\n'):
		# split line by white space
		tokens = line.split()
		# split id from description
		image_id, image_desc = tokens[0], tokens[1:]
		# skip images not in the set
		if image_id in dataset:
			# store
			descriptions[image_id] = 'startseq ' + ' '.join(image_desc) + ' endseq'
	return descriptions

# load dev set
filename = 'Flickr8k_text/Flickr_8k.devImages.txt'
dataset = load_set(filename)
print('Dataset: %d' % len(dataset))
# train-test split
train, test = train_test_split(dataset)
print('Train=%d, Test=%d' % (len(train), len(test)))
# descriptions
train_descriptions = load_clean_descriptions('descriptions.txt', train)
print('Descriptions: train=%d' % len(train_descriptions))

# train word2vec model
lines = [s.split() for s in train_descriptions.values()]
model = Word2Vec(lines, size=100, window=5, workers=8, min_count=1)
# summarize vocabulary size in model
words = list(model.wv.vocab)
print('Vocabulary size: %d' % len(words))

# save model in ASCII (word2vec) format
filename = 'custom_embedding.txt'
model.wv.save_word2vec_format(filename, binary=False)

# load the whole embedding into memory
embedding = dict()
file = open('custom_embedding.txt')
for line in file:
	values = line.split()
	word = values[0]
	coefs = asarray(values[1:], dtype='float32')
	embedding[word] = coefs
file.close()
print('Embedding Size: %d' % len(embedding))

# summarize vocabulary
all_tokens = ' '.join(train_descriptions.values()).split()
vocabulary = set(all_tokens)
print('Vocabulary Size: %d' % len(vocabulary))

# get the vectors for words in our vocab
cust_embedding = dict()
for word in vocabulary:
	# check if word in embedding
	if word not in embedding:
		continue
	cust_embedding[word] = embedding[word]
print('Custom Embedding %d' % len(cust_embedding))

# save
dump(cust_embedding, open('word2vec_embedding.pkl', 'wb'))
print('Saved Embedding')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-10">10</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-12">12</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-14">14</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-16">16</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-18">18</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-20">20</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-22">22</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-24">24</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-26">26</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-28">28</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-30">30</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-32">32</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-34">34</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-36">36</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-38">38</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-40">40</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-42">42</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-44">44</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-46">46</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-48">48</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-50">50</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-52">52</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-54">54</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-56">56</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-58">58</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-60">60</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-62">62</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-64">64</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-66">66</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-68">68</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-70">70</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-72">72</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-74">74</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-76">76</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-78">78</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-80">80</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-82">82</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-84">84</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-86">86</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-88">88</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-90">90</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-92">92</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-94">94</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-96">96</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-98">98</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-100">100</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940ba636723626-102">102</div><div class="crayon-num" data-line="crayon-5a6591c5940ba636723626-103">103</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940ba636723626-1"><span class="crayon-p"># prepare word vectors for captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-2"> </div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-3"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">asarray</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-4"><span class="crayon-e">from </span><span class="crayon-e">pickle </span><span class="crayon-e">import </span><span class="crayon-e">dump</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-5"><span class="crayon-e">from </span><span class="crayon-v">gensim</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-v">Word2Vec</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-6"> </div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-7"><span class="crayon-p"># load doc into memory</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-8"><span class="crayon-e">def </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-9"><span class="crayon-h"> </span><span class="crayon-p"># open the file as read only</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-10"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'r'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-11"><span class="crayon-h"> </span><span class="crayon-p"># read all text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-12"><span class="crayon-h"> </span><span class="crayon-v">text</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">read</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-13"><span class="crayon-h"> </span><span class="crayon-p"># close the file</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-14"><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-15"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">text</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-16"> </div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-17"><span class="crayon-p"># load a pre-defined list of photo identifiers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-18"><span class="crayon-e">def </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-19"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-20"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-21"><span class="crayon-h"> </span><span class="crayon-p"># process line by line</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-22"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-23"><span class="crayon-h"> </span><span class="crayon-p"># skip empty lines</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-24"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">line</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">&lt;</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-25"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-26"><span class="crayon-h"> </span><span class="crayon-p"># get the image identifier</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-27"><span class="crayon-h"> </span><span class="crayon-v">identifier</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-28"><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">identifier</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-29"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-30"> </div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-31"><span class="crayon-p"># split a dataset into train/test elements</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-32"><span class="crayon-e">def </span><span class="crayon-e">train_test_split</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-33"><span class="crayon-h"> </span><span class="crayon-p"># order keys so the split is consistent</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-34"><span class="crayon-h"> </span><span class="crayon-v">ordered</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sorted</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-35"><span class="crayon-h"> </span><span class="crayon-p"># return split dataset as two new sets</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-36"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">ordered</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-cn">100</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">ordered</span><span class="crayon-sy">[</span><span class="crayon-cn">100</span><span class="crayon-o">:</span><span class="crayon-cn">200</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-37"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-38"><span class="crayon-p"># load clean descriptions into memory</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-39"><span class="crayon-e">def </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-40"><span class="crayon-h"> </span><span class="crayon-p"># load document</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-41"><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_doc</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-42"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-43"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">doc</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'\n'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-44"><span class="crayon-h"> </span><span class="crayon-p"># split line by white space</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-45"><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-46"><span class="crayon-h"> </span><span class="crayon-p"># split id from description</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-47"><span class="crayon-h"> </span><span class="crayon-v">image_id</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">image_desc</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tokens</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-48"><span class="crayon-h"> </span><span class="crayon-p"># skip images not in the set</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-49"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">image_id </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-50"><span class="crayon-h"> </span><span class="crayon-p"># store</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-51"><span class="crayon-h"> </span><span class="crayon-v">descriptions</span><span class="crayon-sy">[</span><span class="crayon-v">image_id</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'startseq '</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">image_desc</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">' endseq'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-52"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">descriptions</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-53"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-54"><span class="crayon-p"># load dev set</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-55"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'Flickr8k_text/Flickr_8k.devImages.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-56"><span class="crayon-v">dataset</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_set</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-57"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Dataset: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-58"><span class="crayon-p"># train-test split</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-59"><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">train_test_split</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-60"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Train=%d, Test=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-61"><span class="crayon-p"># descriptions</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-62"><span class="crayon-v">train_descriptions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_clean_descriptions</span><span class="crayon-sy">(</span><span class="crayon-s">'descriptions.txt'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-63"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Descriptions: train=%d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-64"> </div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-65"><span class="crayon-p"># train word2vec model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-66"><span class="crayon-v">lines</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">s</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">s</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-67"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Word2Vec</span><span class="crayon-sy">(</span><span class="crayon-v">lines</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">size</span><span class="crayon-o">=</span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">window</span><span class="crayon-o">=</span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">workers</span><span class="crayon-o">=</span><span class="crayon-cn">8</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">min_count</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-68"><span class="crayon-p"># summarize vocabulary size in model</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-69"><span class="crayon-v">words</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">wv</span><span class="crayon-sy">.</span><span class="crayon-v">vocab</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-70"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">words</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-71"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-72"><span class="crayon-p"># save model in ASCII (word2vec) format</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-73"><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'custom_embedding.txt'</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-74"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-v">wv</span><span class="crayon-sy">.</span><span class="crayon-e">save_word2vec_format</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">binary</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-75"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-76"><span class="crayon-p"># load the whole embedding into memory</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-77"><span class="crayon-v">embedding</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-78"><span class="crayon-v">file</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'custom_embedding.txt'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-79"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">line </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">file</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-80"><span class="crayon-h"> </span><span class="crayon-v">values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">line</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-81"><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-82"><span class="crayon-h"> </span><span class="crayon-v">coefs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">asarray</span><span class="crayon-sy">(</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dtype</span><span class="crayon-o">=</span><span class="crayon-s">'float32'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-83"><span class="crayon-h"> </span><span class="crayon-v">embedding</span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">coefs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-84"><span class="crayon-v">file</span><span class="crayon-sy">.</span><span class="crayon-e">close</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-85"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Embedding Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">embedding</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-86"> </div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-87"><span class="crayon-p"># summarize vocabulary</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-88"><span class="crayon-v">all_tokens</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">' '</span><span class="crayon-sy">.</span><span class="crayon-e">join</span><span class="crayon-sy">(</span><span class="crayon-v">train_descriptions</span><span class="crayon-sy">.</span><span class="crayon-e">values</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-89"><span class="crayon-v">vocabulary</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">set</span><span class="crayon-sy">(</span><span class="crayon-v">all_tokens</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-90"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Vocabulary Size: %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">vocabulary</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-91"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-92"><span class="crayon-p"># get the vectors for words in our vocab</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-93"><span class="crayon-v">cust_embedding</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-94"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">vocabulary</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-95"><span class="crayon-h"> </span><span class="crayon-p"># check if word in embedding</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-96"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">embedding</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-97"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-98"><span class="crayon-h"> </span><span class="crayon-v">cust_embedding</span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">embedding</span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-99"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Custom Embedding %d'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">cust_embedding</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-100"> </div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-101"><span class="crayon-p"># save</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940ba636723626-102"><span class="crayon-e">dump</span><span class="crayon-sy">(</span><span class="crayon-v">cust_embedding</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'word2vec_embedding.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'wb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940ba636723626-103"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Saved Embedding'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0059 seconds] -->
<p>Running this example creates a new dictionary mapping of word-to-word vectors stored in the file ‘<em>word2vec_embedding.pkl</em>‘.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940be112030390" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Dataset: 1000
Train=100, Test=100
Descriptions: train=100
Vocabulary size: 365
Embedding Size: 366
Vocabulary Size: 365
Custom Embedding 365
Saved Embedding</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940be112030390-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940be112030390-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940be112030390-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940be112030390-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940be112030390-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940be112030390-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940be112030390-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940be112030390-8">8</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940be112030390-1">Dataset: 1000</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940be112030390-2">Train=100, Test=100</div><div class="crayon-line" id="crayon-5a6591c5940be112030390-3">Descriptions: train=100</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940be112030390-4">Vocabulary size: 365</div><div class="crayon-line" id="crayon-5a6591c5940be112030390-5">Embedding Size: 366</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940be112030390-6">Vocabulary Size: 365</div><div class="crayon-line" id="crayon-5a6591c5940be112030390-7">Custom Embedding 365</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940be112030390-8">Saved Embedding</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Next, we can load this embedding and use the word vectors as the fixed weights in an Embedding layer.</p>
<p>Below provides the <em>load_embedding()</em> function that loads the custom word2vec embedding and returns the new Embedding layer for use in the model.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940c1994200738" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load a word embedding
def load_embedding(tokenizer, vocab_size, max_length):
	# load the tokenizer
	embedding = load(open('word2vec_embedding.pkl', 'rb'))
	dimensions = 100
	trainable = False
	# create a weight matrix for words in training docs
	weights = zeros((vocab_size, dimensions))
	# walk words in order of tokenizer vocab to ensure vectors are in the right index
	for word, i in tokenizer.word_index.items():
		if word not in embedding:
			continue
		weights[i] = embedding[word]
	layer = Embedding(vocab_size, dimensions, weights=[weights], input_length=max_length, trainable=trainable, mask_zero=True)
	return layer</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940c1994200738-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c1994200738-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940c1994200738-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c1994200738-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940c1994200738-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c1994200738-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940c1994200738-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c1994200738-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940c1994200738-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c1994200738-10">10</div><div class="crayon-num" data-line="crayon-5a6591c5940c1994200738-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c1994200738-12">12</div><div class="crayon-num" data-line="crayon-5a6591c5940c1994200738-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c1994200738-14">14</div><div class="crayon-num" data-line="crayon-5a6591c5940c1994200738-15">15</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940c1994200738-1"><span class="crayon-p"># load a word embedding</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c1994200738-2"><span class="crayon-e">def </span><span class="crayon-e">load_embedding</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940c1994200738-3"><span class="crayon-h"> </span><span class="crayon-p"># load the tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c1994200738-4"><span class="crayon-h"> </span><span class="crayon-v">embedding</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'word2vec_embedding.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940c1994200738-5"><span class="crayon-h"> </span><span class="crayon-v">dimensions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">100</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c1994200738-6"><span class="crayon-h"> </span><span class="crayon-v">trainable</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">False</span></div><div class="crayon-line" id="crayon-5a6591c5940c1994200738-7"><span class="crayon-h"> </span><span class="crayon-p"># create a weight matrix for words in training docs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c1994200738-8"><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">zeros</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dimensions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940c1994200738-9"><span class="crayon-h"> </span><span class="crayon-p"># walk words in order of tokenizer vocab to ensure vectors are in the right index</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c1994200738-10"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940c1994200738-11"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">embedding</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c1994200738-12"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line" id="crayon-5a6591c5940c1994200738-13"><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">embedding</span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c1994200738-14"><span class="crayon-h"> </span><span class="crayon-v">layer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dimensions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">weights</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_length</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">trainable</span><span class="crayon-o">=</span><span class="crayon-v">trainable</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940c1994200738-15"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">layer</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>We can use it in our model by calling the function directly from our <em>define_model()</em> function.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940c4605546061" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the captioning model
def define_model(tokenizer, vocab_size, max_length):
	# feature extractor (encoder)
	inputs1 = Input(shape=(7, 7, 512))
	fe1 = GlobalMaxPooling2D()(inputs1)
	fe2 = Dense(128, activation='relu')(fe1)
	fe3 = RepeatVector(max_length)(fe2)
	# embedding
	inputs2 = Input(shape=(max_length,))
	emb2 = load_embedding(tokenizer, vocab_size, max_length)(inputs2)
	emb3 = LSTM(256, return_sequences=True)(emb2)
	emb4 = TimeDistributed(Dense(128, activation='relu'))(emb3)
	# merge inputs
	merged = concatenate([fe3, emb4])
	# language model (decoder)
	lm2 = LSTM(500)(merged)
	lm3 = Dense(500, activation='relu')(lm2)
	outputs = Dense(vocab_size, activation='softmax')(lm3)
	# tie it together [image, seq] [word]
	model = Model(inputs=[inputs1, inputs2], outputs=outputs)
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
	return model

model_name = 'seq_w2v_fixed'</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940c4605546061-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c4605546061-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940c4605546061-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c4605546061-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940c4605546061-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c4605546061-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940c4605546061-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c4605546061-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940c4605546061-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c4605546061-10">10</div><div class="crayon-num" data-line="crayon-5a6591c5940c4605546061-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c4605546061-12">12</div><div class="crayon-num" data-line="crayon-5a6591c5940c4605546061-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c4605546061-14">14</div><div class="crayon-num" data-line="crayon-5a6591c5940c4605546061-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c4605546061-16">16</div><div class="crayon-num" data-line="crayon-5a6591c5940c4605546061-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c4605546061-18">18</div><div class="crayon-num" data-line="crayon-5a6591c5940c4605546061-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c4605546061-20">20</div><div class="crayon-num" data-line="crayon-5a6591c5940c4605546061-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c4605546061-22">22</div><div class="crayon-num" data-line="crayon-5a6591c5940c4605546061-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c4605546061-24">24</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940c4605546061-1"><span class="crayon-p"># define the captioning model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c4605546061-2"><span class="crayon-e">def </span><span class="crayon-e">define_model</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940c4605546061-3"><span class="crayon-h"> </span><span class="crayon-p"># feature extractor (encoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c4605546061-4"><span class="crayon-h"> </span><span class="crayon-v">inputs1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">7</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">512</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940c4605546061-5"><span class="crayon-h"> </span><span class="crayon-v">fe1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">GlobalMaxPooling2D</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c4605546061-6"><span class="crayon-h"> </span><span class="crayon-v">fe2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940c4605546061-7"><span class="crayon-h"> </span><span class="crayon-v">fe3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">fe2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c4605546061-8"><span class="crayon-h"> </span><span class="crayon-p"># embedding</span></div><div class="crayon-line" id="crayon-5a6591c5940c4605546061-9"><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Input</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c4605546061-10"><span class="crayon-h"> </span><span class="crayon-v">emb2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load_embedding</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">inputs2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940c4605546061-11"><span class="crayon-h"> </span><span class="crayon-v">emb3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">256</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c4605546061-12"><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">128</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">emb3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940c4605546061-13"><span class="crayon-h"> </span><span class="crayon-p"># merge inputs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c4605546061-14"><span class="crayon-h"> </span><span class="crayon-v">merged</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concatenate</span><span class="crayon-sy">(</span><span class="crayon-sy">[</span><span class="crayon-v">fe3</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">emb4</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940c4605546061-15"><span class="crayon-h"> </span><span class="crayon-p"># language model (decoder)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c4605546061-16"><span class="crayon-h"> </span><span class="crayon-v">lm2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">merged</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940c4605546061-17"><span class="crayon-h"> </span><span class="crayon-v">lm3</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">500</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'relu'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c4605546061-18"><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">(</span><span class="crayon-v">lm3</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940c4605546061-19"><span class="crayon-h"> </span><span class="crayon-p"># tie it together [image, seq] [word]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c4605546061-20"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Model</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">inputs1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs2</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">outputs</span><span class="crayon-o">=</span><span class="crayon-v">outputs</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940c4605546061-21"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'accuracy'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c4605546061-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">model</span></div><div class="crayon-line" id="crayon-5a6591c5940c4605546061-23"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c4605546061-24"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'seq_w2v_fixed'</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0023 seconds] -->
<p>We can see some lift on the training dataset, perhaps no real notable change on the test dataset.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940c6008186015" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
          train      test
count  3.000000  3.000000
mean   0.096780  0.047540
std    0.055073  0.008445
min    0.033511  0.038340
25%    0.078186  0.043840
50%    0.122861  0.049341
75%    0.128414  0.052140
max    0.133967  0.054939</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940c6008186015-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c6008186015-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940c6008186015-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c6008186015-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940c6008186015-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c6008186015-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940c6008186015-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c6008186015-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940c6008186015-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940c6008186015-1">          train      test</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c6008186015-2">count  3.000000  3.000000</div><div class="crayon-line" id="crayon-5a6591c5940c6008186015-3">mean   0.096780  0.047540</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c6008186015-4">std    0.055073  0.008445</div><div class="crayon-line" id="crayon-5a6591c5940c6008186015-5">min    0.033511  0.038340</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c6008186015-6">25%    0.078186  0.043840</div><div class="crayon-line" id="crayon-5a6591c5940c6008186015-7">50%    0.122861  0.049341</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c6008186015-8">75%    0.128414  0.052140</div><div class="crayon-line" id="crayon-5a6591c5940c6008186015-9">max    0.133967  0.054939</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<h3>Trained word2vec Embedding with Fine Tuning</h3>
<p>We can repeat the previous experiment and allow the model to tune the word vectors while fitting the model.</p>
<p>The updated <em>load_embedding()</em> function that permits the embedding layer to be fine-tuned is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940c9973085866" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load a word embedding
def load_embedding(tokenizer, vocab_size, max_length):
	# load the tokenizer
	embedding = load(open('word2vec_embedding.pkl', 'rb'))
	dimensions = 100
	trainable = True
	# create a weight matrix for words in training docs
	weights = zeros((vocab_size, dimensions))
	# walk words in order of tokenizer vocab to ensure vectors are in the right index
	for word, i in tokenizer.word_index.items():
		if word not in embedding:
			continue
		weights[i] = embedding[word]
	layer = Embedding(vocab_size, dimensions, weights=[weights], input_length=max_length, trainable=trainable, mask_zero=True)
	return layer

model_name = 'seq_w2v_tuned'</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940c9973085866-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c9973085866-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940c9973085866-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c9973085866-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940c9973085866-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c9973085866-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940c9973085866-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c9973085866-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940c9973085866-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c9973085866-10">10</div><div class="crayon-num" data-line="crayon-5a6591c5940c9973085866-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c9973085866-12">12</div><div class="crayon-num" data-line="crayon-5a6591c5940c9973085866-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c9973085866-14">14</div><div class="crayon-num" data-line="crayon-5a6591c5940c9973085866-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940c9973085866-16">16</div><div class="crayon-num" data-line="crayon-5a6591c5940c9973085866-17">17</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940c9973085866-1"><span class="crayon-p"># load a word embedding</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c9973085866-2"><span class="crayon-e">def </span><span class="crayon-e">load_embedding</span><span class="crayon-sy">(</span><span class="crayon-v">tokenizer</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">max_length</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940c9973085866-3"><span class="crayon-h"> </span><span class="crayon-p"># load the tokenizer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c9973085866-4"><span class="crayon-h"> </span><span class="crayon-v">embedding</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">load</span><span class="crayon-sy">(</span><span class="crayon-e">open</span><span class="crayon-sy">(</span><span class="crayon-s">'word2vec_embedding.pkl'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'rb'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940c9973085866-5"><span class="crayon-h"> </span><span class="crayon-v">dimensions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">100</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c9973085866-6"><span class="crayon-h"> </span><span class="crayon-v">trainable</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">True</span></div><div class="crayon-line" id="crayon-5a6591c5940c9973085866-7"><span class="crayon-h"> </span><span class="crayon-p"># create a weight matrix for words in training docs</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c9973085866-8"><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">zeros</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dimensions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940c9973085866-9"><span class="crayon-h"> </span><span class="crayon-p"># walk words in order of tokenizer vocab to ensure vectors are in the right index</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c9973085866-10"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">tokenizer</span><span class="crayon-sy">.</span><span class="crayon-v">word_index</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940c9973085866-11"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-t">word</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">embedding</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c9973085866-12"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line" id="crayon-5a6591c5940c9973085866-13"><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">embedding</span><span class="crayon-sy">[</span><span class="crayon-t">word</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c9973085866-14"><span class="crayon-h"> </span><span class="crayon-v">layer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Embedding</span><span class="crayon-sy">(</span><span class="crayon-v">vocab_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">dimensions</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">weights</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">weights</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_length</span><span class="crayon-o">=</span><span class="crayon-v">max_length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">trainable</span><span class="crayon-o">=</span><span class="crayon-v">trainable</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">mask_zero</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940c9973085866-15"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">layer</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940c9973085866-16"> </div><div class="crayon-line" id="crayon-5a6591c5940c9973085866-17"><span class="crayon-v">model_name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'seq_w2v_tuned'</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0015 seconds] -->
<p>Again, we do not see much difference in using these pre-trained word embedding vectors over the baseline model.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940cc318701331" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
          train      test
count  3.000000  3.000000
mean   0.065297  0.042712
std    0.080194  0.007697
min    0.017675  0.034593
25%    0.019003  0.039117
50%    0.020332  0.043641
75%    0.089108  0.046772
max    0.157885  0.049904</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940cc318701331-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940cc318701331-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940cc318701331-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940cc318701331-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940cc318701331-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940cc318701331-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940cc318701331-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940cc318701331-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940cc318701331-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940cc318701331-1">          train      test</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940cc318701331-2">count  3.000000  3.000000</div><div class="crayon-line" id="crayon-5a6591c5940cc318701331-3">mean   0.065297  0.042712</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940cc318701331-4">std    0.080194  0.007697</div><div class="crayon-line" id="crayon-5a6591c5940cc318701331-5">min    0.017675  0.034593</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940cc318701331-6">25%    0.019003  0.039117</div><div class="crayon-line" id="crayon-5a6591c5940cc318701331-7">50%    0.020332  0.043641</div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940cc318701331-8">75%    0.089108  0.046772</div><div class="crayon-line" id="crayon-5a6591c5940cc318701331-9">max    0.157885  0.049904</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<h2>Analysis of Results</h2>
<p>We have performed a few experiments on a very small sample (1.6%) from the Flickr8k training dataset of 8,000 photos.</p>
<p>It is possible that the sample is too small, that the models were not trained for long enough, and that 3 repeats of each model results in too much variance. These aspects can also be tested by evaluated by designing experiments such as:</p>
<ol>
<li>Does model skill scale with the size of the dataset?</li>
<li>Do more epochs result in better skill?</li>
<li>Do more repeats result in a skill with less variance?</li>
</ol>
<p>Nevertheless, we have some ideas on how we might configure a model for the fuller dataset.</p>
<p>Below is a summary of the mean results from the experiments performed in this tutorial.</p>
<p>It is helpful to review a graph of the results. If we had more repeats, a box and whisker plot for each distribution of scores might be a good visualization. Here we use a simple bar graph. Remember, that larger BLEU scores are better.</p>
<p>Results on the training dataset:</p>
<div class="wp-caption aligncenter" id="attachment_4452" style="max-width: 610px"><img alt="Bar Chart of Experiment vs Model Skill on the Training Dataset" class="size-full wp-image-4452" height="371" sizes="(max-width: 600px) 100vw, 600px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Bar-Chart-of-Experiment-vs-Model-Skill-on-the-Training-Dataset.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Bar-Chart-of-Experiment-vs-Model-Skill-on-the-Training-Dataset.png 600w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Bar-Chart-of-Experiment-vs-Model-Skill-on-the-Training-Dataset-300x186.png 300w" width="600"/><p class="wp-caption-text">Bar Chart of Experiment vs Model Skill on the Training Dataset</p></div>
<p>Results on the test dataset:</p>
<div class="wp-caption aligncenter" id="attachment_4453" style="max-width: 610px"><img alt="Bar Chart of Experiment vs Model Skill on the Test Dataset" class="size-full wp-image-4453" height="371" sizes="(max-width: 600px) 100vw, 600px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Bar-Chart-of-Experiment-vs-Model-Skill-on-the-Test-Dataset.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Bar-Chart-of-Experiment-vs-Model-Skill-on-the-Test-Dataset.png 600w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Bar-Chart-of-Experiment-vs-Model-Skill-on-the-Test-Dataset-300x186.png 300w" width="600"/><p class="wp-caption-text">Bar Chart of Experiment vs Model Skill on the Test Dataset</p></div>
<p>From just looking at the mean results on the test dataset, we can suggest:</p>
<ul>
<li>Perhaps pooling is not required after the photo feature extractor (fe_flat at 0.135231).</li>
<li>Perhaps average pooling offers an advantage over max pooling after the photo feature extractor (fe_avg_pool at 0.060847).</li>
<li>Perhaps a smaller sized fixed-length vector after the sub-models is a good idea (size_sm_fixed_vec at 0.063148).</li>
<li>Perhaps adding more layers to the language model offers some benefit (size_lg_lang_model at 0.067658).</li>
<li>Perhaps adding more layers to the sequence model offers some benefit (size_lg_seq_model at 0.09697).</li>
</ul>
<p>I would also recommend exploring combinations of these suggestions.</p>
<p>We can also review the distribution of results.</p>
<p>Below is some code to load the saved results from each experiment and create a box-and-whisker plot of results on the train and test sets for review.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a6591c5940d0405071082" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from os import listdir
from pandas import read_csv
from pandas import DataFrame
from matplotlib import pyplot

# load all .csv results into a dataframe
train, test = DataFrame(), DataFrame()
directory = 'results'
for name in listdir(directory):
	if not name.endswith('csv'):
		continue
	filename = directory + '/' + name
	data = read_csv(filename, header=0)
	experiment = name.split('.')[0]
	train[experiment] = data['train']
	test[experiment] = data['test']

# plot results on train
train.boxplot(vert=False)
pyplot.show()
# plot results on test
test.boxplot(vert=False)
pyplot.show()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a6591c5940d0405071082-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940d0405071082-2">2</div><div class="crayon-num" data-line="crayon-5a6591c5940d0405071082-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940d0405071082-4">4</div><div class="crayon-num" data-line="crayon-5a6591c5940d0405071082-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940d0405071082-6">6</div><div class="crayon-num" data-line="crayon-5a6591c5940d0405071082-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940d0405071082-8">8</div><div class="crayon-num" data-line="crayon-5a6591c5940d0405071082-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940d0405071082-10">10</div><div class="crayon-num" data-line="crayon-5a6591c5940d0405071082-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940d0405071082-12">12</div><div class="crayon-num" data-line="crayon-5a6591c5940d0405071082-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940d0405071082-14">14</div><div class="crayon-num" data-line="crayon-5a6591c5940d0405071082-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940d0405071082-16">16</div><div class="crayon-num" data-line="crayon-5a6591c5940d0405071082-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940d0405071082-18">18</div><div class="crayon-num" data-line="crayon-5a6591c5940d0405071082-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940d0405071082-20">20</div><div class="crayon-num" data-line="crayon-5a6591c5940d0405071082-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a6591c5940d0405071082-22">22</div><div class="crayon-num" data-line="crayon-5a6591c5940d0405071082-23">23</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a6591c5940d0405071082-1"><span class="crayon-e">from </span><span class="crayon-e">os </span><span class="crayon-e">import </span><span class="crayon-e">listdir</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940d0405071082-2"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line" id="crayon-5a6591c5940d0405071082-3"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">DataFrame</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940d0405071082-4"><span class="crayon-e">from </span><span class="crayon-e">matplotlib </span><span class="crayon-e">import </span><span class="crayon-v">pyplot</span></div><div class="crayon-line" id="crayon-5a6591c5940d0405071082-5"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940d0405071082-6"><span class="crayon-p"># load all .csv results into a dataframe</span></div><div class="crayon-line" id="crayon-5a6591c5940d0405071082-7"><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940d0405071082-8"><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-s">'results'</span></div><div class="crayon-line" id="crayon-5a6591c5940d0405071082-9"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">listdir</span><span class="crayon-sy">(</span><span class="crayon-v">directory</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940d0405071082-10"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">.</span><span class="crayon-e">endswith</span><span class="crayon-sy">(</span><span class="crayon-s">'csv'</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a6591c5940d0405071082-11"><span class="crayon-h"> </span><span class="crayon-st">continue</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940d0405071082-12"><span class="crayon-h"> </span><span class="crayon-v">filename</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">directory</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-s">'/'</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">name</span></div><div class="crayon-line" id="crayon-5a6591c5940d0405071082-13"><span class="crayon-e"> </span><span class="crayon-v">data</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-v">filename</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940d0405071082-14"><span class="crayon-h"> </span><span class="crayon-v">experiment</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-sy">.</span><span class="crayon-e">split</span><span class="crayon-sy">(</span><span class="crayon-s">'.'</span><span class="crayon-sy">)</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c5940d0405071082-15"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-v">experiment</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-s">'train'</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940d0405071082-16"><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">[</span><span class="crayon-v">experiment</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-sy">[</span><span class="crayon-s">'test'</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a6591c5940d0405071082-17"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940d0405071082-18"><span class="crayon-p"># plot results on train</span></div><div class="crayon-line" id="crayon-5a6591c5940d0405071082-19"><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-e">boxplot</span><span class="crayon-sy">(</span><span class="crayon-v">vert</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940d0405071082-20"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">show</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940d0405071082-21"><span class="crayon-p"># plot results on test</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a6591c5940d0405071082-22"><span class="crayon-v">test</span><span class="crayon-sy">.</span><span class="crayon-e">boxplot</span><span class="crayon-sy">(</span><span class="crayon-v">vert</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a6591c5940d0405071082-23"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">show</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0014 seconds] -->
<p>Distribution of results on the training dataset.</p>
<div class="wp-caption aligncenter" id="attachment_4454" style="max-width: 2438px"><img alt="Box and Whisker Plot of Experiment vs Model Skill on the Training Dataset" class="size-full wp-image-4454" height="960" sizes="(max-width: 2428px) 100vw, 2428px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Box-and-Whisker-Plot-of-Experiment-vs-Model-Skill-on-the-Training-Dataset.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Box-and-Whisker-Plot-of-Experiment-vs-Model-Skill-on-the-Training-Dataset.png 2428w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Box-and-Whisker-Plot-of-Experiment-vs-Model-Skill-on-the-Training-Dataset-300x119.png 300w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Box-and-Whisker-Plot-of-Experiment-vs-Model-Skill-on-the-Training-Dataset-768x304.png 768w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Box-and-Whisker-Plot-of-Experiment-vs-Model-Skill-on-the-Training-Dataset-1024x405.png 1024w" width="2428"/><p class="wp-caption-text">Box and Whisker Plot of Experiment vs Model Skill on the Training Dataset</p></div>
<p>Distribution of results on the test dataset.</p>
<div class="wp-caption aligncenter" id="attachment_4455" style="max-width: 2486px"><img alt="Box and Whisker Plot of Experiment vs Model Skill on the Test Dataset" class="size-full wp-image-4455" height="960" sizes="(max-width: 2476px) 100vw, 2476px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Box-and-Whisker-Plot-of-Experiment-vs-Model-Skill-on-the-Test-Dataset.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Box-and-Whisker-Plot-of-Experiment-vs-Model-Skill-on-the-Test-Dataset.png 2476w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Box-and-Whisker-Plot-of-Experiment-vs-Model-Skill-on-the-Test-Dataset-300x116.png 300w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Box-and-Whisker-Plot-of-Experiment-vs-Model-Skill-on-the-Test-Dataset-768x298.png 768w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/09/Box-and-Whisker-Plot-of-Experiment-vs-Model-Skill-on-the-Test-Dataset-1024x397.png 1024w" width="2476"/><p class="wp-caption-text">Box and Whisker Plot of Experiment vs Model Skill on the Test Dataset</p></div>
<p>A review of these distributions suggests:</p>
<ul>
<li>The spread on the flat results is large; perhaps going with average pooling might be safer.</li>
<li>The spread on the larger language model is large and skewed in the wrong/risky direction.</li>
<li>The spread on the larger sequence model is large and skewed in the right direction.</li>
<li>There may be some benefit in a smaller fixed-length vector size.</li>
</ul>
<p>I would expect increasing repeats to 5, 10, or 30 would tighten up these distributions somewhat.</p>
<h2>Further Reading</h2>
<p>This section provides more resources on the topic if you are looking go deeper.</p>
<h3>Papers</h3>
<ul>
<li><a href="https://arxiv.org/abs/1411.4555">Show and Tell: A Neural Image Caption Generator</a>, 2015.</li>
<li><a href="https://arxiv.org/abs/1502.03044">Show, Attend and Tell: Neural Image Caption Generation with Visual Attention</a>, 2016.</li>
<li><a href="https://arxiv.org/abs/1312.4400">Network In Network</a>, 2013.</li>
</ul>
<h3>Related Captioning Projects</h3>
<ul>
<li><a href="https://github.com/anuragmishracse/caption_generator">caption_generator: An image captioning project</a></li>
<li><a href="https://github.com/LemonATsu/Keras-Image-Caption">Keras Image Caption</a></li>
<li><a href="https://github.com/oarriaga/neural_image_captioning">Neural Image Captioning (NIC)</a></li>
<li><a href="https://deeplearningmania.quora.com/Keras-deep-learning-for-image-caption-retrieval">Keras deep learning for image caption retrieval</a></li>
<li><a href="http://www.cs.nthu.edu.tw/~shwu/courses/ml/competitions/02_Image-Caption/02_Image-Caption.html">DataLab Cup 2: Image Captioning</a></li>
</ul>
<h3>Other</h3>
<ul>
<li><a href="http://nlp.cs.illinois.edu/HockenmaierGroup/Framing_Image_Description/KCCA.html">Framing image description as a ranking task: data, models and evaluation metrics</a>.</li>
</ul>
<h3>API</h3>
<ul>
<li><a href="https://keras.io/applications/#vgg16">Keras VGG16 API</a></li>
<li><a href="https://radimrehurek.com/gensim/models/word2vec.html">Gensim word2vec API</a></li>
</ul>
<h2>Summary</h2>
<p>In this tutorial, you discovered how you can use a small sample of the photo captioning dataset to explore different model designs.</p>
<p>Specifically, you learned:</p>
<ul>
<li>How to prepare data for photo captioning modeling.</li>
<li>How to design a baseline and test harness to evaluate the skill of models and control for their stochastic nature.</li>
<li>How to evaluate properties like model skill, feature extraction model, and word embeddings in order to lift model skill.</li>
</ul>
<p>What experiments can you think up?<br/>
What else have you tried?<br/>
What are the best results you can get on the train and test dataset?</p>
<p>Let me know in the comments below.</p>
<div class="awac-wrapper"><div class="awac widget text-42"> <div class="textwidget"><p></p><center><br/>
<div class="woo-sc-hr"></div>
<h2>Develop Deep Learning models for Text Data Today!</h2>
<p><a href="/deep-learning-for-nlp/"><img align="left" alt="Deep Learning for Natural Language Processing" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/DLFNLP-Cover-220.png" style="border: 0;"/></a></p>
<h4>Develop Your Own Text models in Minutes</h4>
<p>…with just a few lines of python code</p>
<p>Discover how in my new Ebook:<br/>
<a href="/deep-learning-for-nlp/">Deep Learning for Natural Language Processing</a></p>
<p>It provides <strong>self-study tutorials</strong> on topics like:<br/>
<em>Bag-of-Words, Word Embedding, Language Models, Caption Generation, Text Translation</em> and much more…</p>
<h4>Finally Bring Deep Learning to your Natural Language Processing Projects</h4>
<p>Skip the Academics. Just Results.</p>
<p><a href="/deep-learning-for-nlp/">Click to learn more</a>.<br/>
</p><div class="woo-sc-hr"></div><br/>
</center>
</div>
</div></div><div class="apss-social-share apss-theme-4 clearfix">
<div class="apss-twitter apss-single-icon">
<a href="javascript:void(0);" onclick="apss_open_in_popup_window(event, 'https://twitter.com/intent/tweet?text=How%20to%20Use%20Small%20Experiments%20to%20Develop%20a%20Caption%20Generation%20Model%20in%20Keras&amp;url=https%3A%2F%2Fmachinelearningmastery.com%2Fdevelop-a-caption-generation-model-in-keras%2F&amp;');" rel="nofollow" target="" title="Share on Twitter">
<div class="apss-icon-block clearfix">
<i class="fa fa-twitter"></i>
<span class="apss-social-text">Share on Twitter</span><span class="apss-share">Tweet</span>
</div>
</a>
</div>
<div class="apss-facebook apss-single-icon">
<a href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/" onclick="apss_open_in_popup_window(event, 'https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/');" rel="nofollow" target="" title="Share on Facebook">
<div class="apss-icon-block clearfix">
<i class="fa fa-facebook"></i>
<span class="apss-social-text">Share on Facebook</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-linkedin apss-single-icon">
<a href="http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Use%20Small%20Experiments%20to%20Develop%20a%20Caption%20Generation%20Model%20in%20Keras&amp;url=https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/&amp;summary=Caption+generation+is+a+challenging+artificial+intelligence+problem+where+a+textual+description+must..." onclick="apss_open_in_popup_window(event, 'http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Use%20Small%20Experiments%20to%20Develop%20a%20Caption%20Generation%20Model%20in%20Keras&amp;url=https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/&amp;summary=Caption+generation+is+a+challenging+artificial+intelligence+problem+where+a+textual+description+must...');" rel="nofollow" target="" title="Share on LinkedIn">
<div class="apss-icon-block clearfix"><i class="fa fa-linkedin"></i>
<span class="apss-social-text">Share on LinkedIn</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-google-plus apss-single-icon">
<a href="https://plus.google.com/share?url=https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/" onclick="apss_open_in_popup_window(event, 'https://plus.google.com/share?url=https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/');" rel="nofollow" target="" title="Share on Google Plus">
<div class="apss-icon-block clearfix">
<i class="fa fa-google-plus"></i>
<span class="apss-social-text">Share on Google Plus</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
</div> </section><!-- /.entry -->
<div class="fix"></div>
<aside id="post-author">
<div class="profile-image"><img alt="" class="avatar avatar-80 photo" height="80" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=160&amp;d=mm&amp;r=g 2x" width="80"/></div>
<div class="profile-content">
<h4>About Jason Brownlee</h4>
		Dr. Jason Brownlee is a husband, proud father, academic researcher, author, professional developer and a machine learning practitioner. He is dedicated to helping developers get started and get good at applied machine learning.
<a href="/about">Learn more</a>.				<div class="profile-link">
<a href="https://machinelearningmastery.com/author/jasonb/">
				View all posts by Jason Brownlee <span class="meta-nav">→</span> </a>
</div><!--#profile-link-->
</div>
<div class="fix"></div>
</aside>
<div class="post-utility"></div>
</article><!-- /.post -->
<div class="post-entries">
<div class="nav-prev fl"><a href="https://machinelearningmastery.com/deep-learning-caption-generation-models/" rel="prev"><i class="fa fa-angle-left"></i> A Gentle Introduction to Deep Learning Caption Generation Models</a></div>
<div class="nav-next fr"><a href="https://machinelearningmastery.com/develop-a-deep-learning-caption-generation-model-in-python/" rel="next">How to Develop a Deep Learning Photo Caption Generator from Scratch <i class="fa fa-angle-right"></i></a></div>
<div class="fix"></div>
</div>
<div id="comments"> <h3 id="comments-title">12 Responses to <em>How to Use Small Experiments to Develop a Caption Generation Model in Keras</em></h3>
<ol class="commentlist">
<li class="comment even thread-even depth-1" id="comment-421018">
<div class="comment-container" id="li-comment-421018">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d418469567ef68d544219be6c7e0806b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d418469567ef68d544219be6c7e0806b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://emilwallner.com" rel="external nofollow">Emil</a></span>
<span class="date">November 24, 2017 at 6:39 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/#comment-421018" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hats off, another ace tutorial! </p>
<p>I’m curious how the TimeDistributed layer impacts the data before the concatenation. Is it possible to skip it? Also, is there a reason you are using VGG instead of the InceptionResNetV2 class other than memory/compute constraints.</p>
<p>Thanks!</p>
<div class="reply">
<a aria-label="Reply to Emil" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/?replytocom=421018#respond" onclick='return addComment.moveForm( "comment-421018", "421018", "respond", "4450" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-421051">
<div class="comment-container" id="li-comment-421051">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 24, 2017 at 9:52 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/#comment-421051" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I chose VGG because it is smaller and simpler. You can use anything you wish.</p>
<p>You can skip the TimeDistributed as Dense can support time steps now I believe. I like it in there as it reminds me what is going on (e.g. outputting time steps).</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/?replytocom=421051#respond" onclick='return addComment.moveForm( "comment-421051", "421051", "respond", "4450" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-421085">
<div class="comment-container" id="li-comment-421085">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/8e1b745128d324ae58800448c40f5df6?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/8e1b745128d324ae58800448c40f5df6?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Alex</span>
<span class="date">November 24, 2017 at 6:16 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/#comment-421085" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Ho jason, why don t you reset the LSTM states between the inputs related to different images? Ad they are not related to the same sequences.</p>
<div class="reply">
<a aria-label="Reply to Alex" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/?replytocom=421085#respond" onclick='return addComment.moveForm( "comment-421085", "421085", "respond", "4450" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-421132">
<div class="comment-container" id="li-comment-421132">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 25, 2017 at 10:14 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/#comment-421132" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>For speed of training.</p>
<p>It’s a great suggestion though, try it and see if it lifts skill! Let me know how you go.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/?replytocom=421132#respond" onclick='return addComment.moveForm( "comment-421132", "421132", "respond", "4450" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-421388">
<div class="comment-container" id="li-comment-421388">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/8e1b745128d324ae58800448c40f5df6?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/8e1b745128d324ae58800448c40f5df6?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Alex</span>
<span class="date">November 28, 2017 at 1:39 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/#comment-421388" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks! In order to try this way, should I set stateful=True (avoiding the LSTM to reset itself automatically) and manually run model.reset_states() before training a single batch? (each batch is related to the sequence of a single image).</p>
<div class="reply">
<a aria-label="Reply to Alex" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/?replytocom=421388#respond" onclick='return addComment.moveForm( "comment-421388", "421388", "respond", "4450" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-421427">
<div class="comment-container" id="li-comment-421427">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 28, 2017 at 8:38 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/#comment-421427" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/?replytocom=421427#respond" onclick='return addComment.moveForm( "comment-421427", "421427", "respond", "4450" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-422924">
<div class="comment-container" id="li-comment-422924">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d418469567ef68d544219be6c7e0806b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d418469567ef68d544219be6c7e0806b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://emilwallner.com" rel="external nofollow">Emil</a></span>
<span class="date">December 13, 2017 at 12:10 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/#comment-422924" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>What’s the logic of the +1 when you are creating the vocab len: “vocab_size = len(tokenizer.word_index) + 1”? Is it to leave remove for the 0?</p>
<p>Thanks</p>
<div class="reply">
<a aria-label="Reply to Emil" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/?replytocom=422924#respond" onclick='return addComment.moveForm( "comment-422924", "422924", "respond", "4450" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-422951">
<div class="comment-container" id="li-comment-422951">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 13, 2017 at 5:39 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/#comment-422951" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Good question, to make space for 0 – words in the vocab start at 1.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/?replytocom=422951#respond" onclick='return addComment.moveForm( "comment-422951", "422951", "respond", "4450" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-424463">
<div class="comment-container" id="li-comment-424463">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/3bcbac93f39ca3dee92281833e20f3f5?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3bcbac93f39ca3dee92281833e20f3f5?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://mozial" rel="external nofollow">xiaolian</a></span>
<span class="date">December 23, 2017 at 1:54 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/#comment-424463" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>i got a error : Error when checking input: expected input_11 to have 4 dimensions, but got array with shape (28, 4096)</p>
<div class="reply">
<a aria-label="Reply to xiaolian" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/?replytocom=424463#respond" onclick='return addComment.moveForm( "comment-424463", "424463", "respond", "4450" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-424492">
<div class="comment-container" id="li-comment-424492">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 23, 2017 at 5:21 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/#comment-424492" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Are you able to confirm that your libraries are up to date and that you copied all of the code from the post?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/?replytocom=424492#respond" onclick='return addComment.moveForm( "comment-424492", "424492", "respond", "4450" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-424548">
<div class="comment-container" id="li-comment-424548">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/3bcbac93f39ca3dee92281833e20f3f5?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3bcbac93f39ca3dee92281833e20f3f5?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://mozila" rel="external nofollow">xiaolian</a></span>
<span class="date">December 23, 2017 at 1:40 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/#comment-424548" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>can i get the code in github?</p>
<div class="reply">
<a aria-label="Reply to xiaolian" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/?replytocom=424548#respond" onclick='return addComment.moveForm( "comment-424548", "424548", "respond", "4450" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-424616">
<div class="comment-container" id="li-comment-424616">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 24, 2017 at 4:51 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/#comment-424616" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The code is on the post, why do you need it on github?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/develop-a-caption-generation-model-in-keras/?replytocom=424616#respond" onclick='return addComment.moveForm( "comment-424616", "424616", "respond", "4450" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ol>
</div> <div class="comment-respond" id="respond">
<h3 class="comment-reply-title" id="reply-title">Leave a Reply <small><a href="/develop-a-caption-generation-model-in-keras/#respond" id="cancel-comment-reply-link" rel="nofollow" style="display:none;">Click here to cancel reply.</a></small></h3> <form action="https://machinelearningmastery.com/wp-comments-post.php?wpe-comment-post=mlmastery" class="comment-form" id="commentform" method="post">
<p class="comment-form-comment"><label class="hide" for="comment">Comment</label> <textarea aria-required="true" cols="50" id="comment" maxlength="65525" name="comment" required="required" rows="10" tabindex="4"></textarea></p><p class="comment-form-author"><input aria-required="true" class="txt" id="author" name="author" size="30" tabindex="1" type="text" value=""/><label for="author">Name <span class="required">(required)</span></label> </p>
<p class="comment-form-email"><input aria-required="true" class="txt" id="email" name="email" size="30" tabindex="2" type="text" value=""/><label for="email">Email (will not be published) <span class="required">(required)</span></label> </p>
<p class="comment-form-url"><input class="txt" id="url" name="url" size="30" tabindex="3" type="text" value=""/><label for="url">Website</label></p>
<p class="form-submit"><input class="submit" id="submit" name="submit" type="submit" value="Submit Comment"/> <input id="comment_post_ID" name="comment_post_ID" type="hidden" value="4450"/>
<input id="comment_parent" name="comment_parent" type="hidden" value="0"/>
</p><p style="display: none;"><input id="akismet_comment_nonce" name="akismet_comment_nonce" type="hidden" value="17a326b314"/></p><p style="display: none;"><input id="ak_js" name="ak_js" type="hidden" value="140"/></p> </form>
</div><!-- #respond -->
</section><!-- /#main -->
<aside id="sidebar">
<div class="widget widget_woo_blogauthorinfo" id="woo_blogauthorinfo-2"><h3>Welcome to Machine Learning Mastery</h3><span class="left"><img alt="" class="avatar avatar-100 photo" height="100" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=100&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=200&amp;d=mm&amp;r=g 2x" width="100"/></span>
<p>Hi, I'm Dr. Jason Brownlee.
<br/>
My goal is to make practitioners like YOU awesome at applied machine learning.</p>
<p><a href="/about">Read More</a></p>
<div class="fix"></div>
</div><div class="widget widget_text" id="text-43"> <div class="textwidget"><p></p><center>
<h3>Deep Learning for Text Data</h3>
<p>Cut through the math and research papers.<br/>
Discover Word Embeddings, Text Translation and more.</p>
<p><a href="/deep-learning-for-nlp/">Get Started With Deep Learning for NLP Today!</a><br/>
<a href="/deep-learning-for-nlp/"><img src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/11/DLFNLP-Cover-220.png"/></a><br/>
</p></center>
</div>
</div>
<div class="widget widget_woo_tabs" id="woo_tabs-2"> <div id="tabs">
<ul class="wooTabs">
<li class="popular"><a href="#tab-pop">Popular</a></li> </ul>
<div class="clear"></div>
<div class="boxes box inside">
<ul class="list" id="tab-pop">
<li>
<a href="https://machinelearningmastery.com/machine-learning-in-python-step-by-step/" title="Your First Machine Learning Project in Python Step-By-Step"><img alt="Your First Machine Learning Project in Python Step-By-Step" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Your-First-Machine-Learning-Project-in-Python-Step-By-Step-150x150.jpg" title="Your First Machine Learning Project in Python Step-By-Step" width="45"/></a> <a href="https://machinelearningmastery.com/machine-learning-in-python-step-by-step/" title="Your First Machine Learning Project in Python Step-By-Step">Your First Machine Learning Project in Python Step-By-Step</a>
<span class="meta">June 10, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras"><img alt="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/07/Time-Series-Prediction-with-LSTM-Recurrent-Neural-Networks-in-Python-with-Keras-150x150.jpg" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras" width="45"/></a> <a href="https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras">Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras</a>
<span class="meta">July 21, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/" title="Multivariate Time Series Forecasting with LSTMs in Keras"><img alt="Line Plots of Air Pollution Time Series" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/06/Line-Plots-of-Air-Pollution-Time-Series-150x150.png" title="Multivariate Time Series Forecasting with LSTMs in Keras" width="45"/></a> <a href="https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/" title="Multivariate Time Series Forecasting with LSTMs in Keras">Multivariate Time Series Forecasting with LSTMs in Keras</a>
<span class="meta">August 14, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/tutorial-first-neural-network-python-keras/" title="Develop Your First Neural Network in Python With Keras Step-By-Step"><img alt="Tour of Deep Learning Algorithms" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/04/Tour-of-Deep-Learning-Algorithms-150x150.jpg" title="Develop Your First Neural Network in Python With Keras Step-By-Step" width="45"/></a> <a href="https://machinelearningmastery.com/tutorial-first-neural-network-python-keras/" title="Develop Your First Neural Network in Python With Keras Step-By-Step">Develop Your First Neural Network in Python With Keras Step-By-Step</a>
<span class="meta">May 24, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda"><img alt="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/How-to-Setup-a-Python-Environment-for-Machine-Learning-and-Deep-Learning-with-Anaconda-150x150.png" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda" width="45"/></a> <a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda">How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda</a>
<span class="meta">March 13, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/sequence-classification-lstm-recurrent-neural-networks-python-keras/" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras"><img alt="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/07/Sequence-Classification-with-LSTM-Recurrent-Neural-Networks-in-Python-with-Keras-150x150.jpg" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras" width="45"/></a> <a href="https://machinelearningmastery.com/sequence-classification-lstm-recurrent-neural-networks-python-keras/" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras">Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras</a>
<span class="meta">July 26, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/time-series-forecasting-long-short-term-memory-network-python/" title="Time Series Forecasting with the Long Short-Term Memory Network in Python"><img alt="Time Series Forecasting with the Long Short-Term Memory Network in Python" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/04/Time-Series-Forecasting-with-the-Long-Short-Term-Memory-Network-in-Python-150x150.jpg" title="Time Series Forecasting with the Long Short-Term Memory Network in Python" width="45"/></a> <a href="https://machinelearningmastery.com/time-series-forecasting-long-short-term-memory-network-python/" title="Time Series Forecasting with the Long Short-Term Memory Network in Python">Time Series Forecasting with the Long Short-Term Memory Network in Python</a>
<span class="meta">April 7, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/multi-class-classification-tutorial-keras-deep-learning-library/" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library"><img alt="Multi-Class Classification Tutorial with the Keras Deep Learning Library" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Multi-Class-Classification-Tutorial-with-the-Keras-Deep-Learning-Library-150x150.jpg" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library" width="45"/></a> <a href="https://machinelearningmastery.com/multi-class-classification-tutorial-keras-deep-learning-library/" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library">Multi-Class Classification Tutorial with the Keras Deep Learning Library</a>
<span class="meta">June 2, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/regression-tutorial-keras-deep-learning-library-python/" title="Regression Tutorial with the Keras Deep Learning Library in Python"><img alt="Regression Tutorial with Keras Deep Learning Library in Python" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Regression-Tutorial-with-Keras-Deep-Learning-Library-in-Python-150x150.jpg" title="Regression Tutorial with the Keras Deep Learning Library in Python" width="45"/></a> <a href="https://machinelearningmastery.com/regression-tutorial-keras-deep-learning-library-python/" title="Regression Tutorial with the Keras Deep Learning Library in Python">Regression Tutorial with the Keras Deep Learning Library in Python</a>
<span class="meta">June 9, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/grid-search-hyperparameters-deep-learning-models-python-keras/" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras"><img alt="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/08/How-to-Grid-Search-Hyperparameters-for-Deep-Learning-Models-in-Python-With-Keras-150x150.jpg" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras" width="45"/></a> <a href="https://machinelearningmastery.com/grid-search-hyperparameters-deep-learning-models-python-keras/" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras">How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras</a>
<span class="meta">August 9, 2016</span>
<div class="fix"></div>
</li>
</ul>
</div><!-- /.boxes -->
</div><!-- /wooTabs -->
</div> </aside><!-- /#sidebar -->
</div><!-- /#main-sidebar-container -->
</div><!-- /#content -->
<footer class="col-full" id="footer">
<div class="col-left" id="copyright">
<p>© 2018 Machine Learning Mastery. All Rights Reserved. </p> </div>
<div class="col-right" id="credit">
<p></p><p>
<a href="/privacy/">Privacy</a> | 
<a href="/contact/">Contact</a> |
<a href="/about/">About</a>
</p> </div>
</footer>
</div><!-- /#inner-wrapper -->
</div><!-- /#wrapper -->
<div class="fix"></div><!--/.fix-->
<!-- Drip -->
<script type="text/javascript">
  var _dcq = _dcq || [];
  var _dcs = _dcs || {}; 
  _dcs.account = '9556588';
  
  (function() {
    var dc = document.createElement('script');
    dc.type = 'text/javascript'; dc.async = true; 
    dc.src = '//tag.getdrip.com/9556588.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(dc, s);
  })();
</script><!-- Woo Tabs Widget -->
<script type="text/javascript">
jQuery(document).ready(function(){
	// UL = .wooTabs
	// Tab contents = .inside

	var tag_cloud_class = '#tagcloud';

	//Fix for tag clouds - unexpected height before .hide()
	var tag_cloud_height = jQuery( '#tagcloud').height();

	jQuery( '.inside ul li:last-child').css( 'border-bottom','0px' ); // remove last border-bottom from list in tab content
	jQuery( '.wooTabs').each(function(){
		jQuery(this).children( 'li').children( 'a:first').addClass( 'selected' ); // Add .selected class to first tab on load
	});
	jQuery( '.inside > *').hide();
	jQuery( '.inside > *:first-child').show();

	jQuery( '.wooTabs li a').click(function(evt){ // Init Click funtion on Tabs

		var clicked_tab_ref = jQuery(this).attr( 'href' ); // Strore Href value

		jQuery(this).parent().parent().children( 'li').children( 'a').removeClass( 'selected' ); //Remove selected from all tabs
		jQuery(this).addClass( 'selected' );
		jQuery(this).parent().parent().parent().children( '.inside').children( '*').hide();

		jQuery( '.inside ' + clicked_tab_ref).fadeIn(500);

		 evt.preventDefault();

	})
})
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/comment-reply.min.js?ver=4.9.2" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var wpcf7 = {"apiSettings":{"root":"https:\/\/machinelearningmastery.com\/wp-json\/contact-form-7\/v1","namespace":"contact-form-7\/v1"},"recaptcha":{"messages":{"empty":"Please verify that you are not a robot."}},"cached":"1"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/js/scripts.js?ver=4.9.2" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var frontend_ajax_object = {"ajax_url":"https:\/\/machinelearningmastery.com\/wp-admin\/admin-ajax.php","ajax_nonce":"555b70787c"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/seo-optimized-share-buttons/js/frontend.js?ver=4.2.2.0.iis7_supports_permalinks" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/wp-embed.min.js?ver=4.9.2" type="text/javascript"></script>
<script async="async" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/akismet/_inc/form.js?ver=4.0.2" type="text/javascript"></script>
</body>
</html>