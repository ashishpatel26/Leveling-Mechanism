<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
<meta charset="utf-8"/>
<title>How to Develop an Encoder-Decoder Model with Attention for Sequence-to-Sequence Prediction in Keras - Machine Learning Mastery</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="https://machinelearningmastery.com/xmlrpc.php" rel="pingback"/>
<!--  Mobile viewport scale -->
<meta content="initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" name="viewport"/>
<!-- This site is optimized with the Yoast SEO plugin v6.1.1 - https://yoa.st/1yg?utm_content=6.1.1 -->
<link href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/" rel="canonical"/>
<link href="https://plus.google.com/u/0/b/117073416089354242117/+MachinelearningmasteryHome/" rel="publisher"/>
<meta content="en_US" property="og:locale"/>
<meta content="article" property="og:type"/>
<meta content="How to Develop an Encoder-Decoder Model with Attention for Sequence-to-Sequence Prediction in Keras - Machine Learning Mastery" property="og:title"/>
<meta content="The encoder-decoder architecture for recurrent neural networks is proving to be powerful on a host of sequence-to-sequence prediction problems in the field of natural language processing such as machine translation and caption generation. Attention is a mechanism that addresses a limitation of the encoder-decoder architecture on long sequences, and that in general speeds up the …" property="og:description"/>
<meta content="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/" property="og:url"/>
<meta content="Machine Learning Mastery" property="og:site_name"/>
<meta content="https://www.facebook.com/Machine-Learning-Mastery-1429846323896563/" property="article:publisher"/>
<meta content="Long Short-Term Memory Networks" property="article:section"/>
<meta content="2017-10-17T05:00:48+11:00" property="article:published_time"/>
<meta content="2017-10-13T08:40:30+11:00" property="article:modified_time"/>
<meta content="2017-10-13T08:40:30+11:00" property="og:updated_time"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/10/How-to-Develop-an-Encoder-Decoder-Model-with-Attention-for-Sequence-to-Sequence-Prediction-in-Keras.jpg" property="og:image"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/10/How-to-Develop-an-Encoder-Decoder-Model-with-Attention-for-Sequence-to-Sequence-Prediction-in-Keras.jpg" property="og:image:secure_url"/>
<meta content="640" property="og:image:width"/>
<meta content="427" property="og:image:height"/>
<script type="application/ld+json">{"@context":"http:\/\/schema.org","@type":"WebSite","@id":"#website","url":"https:\/\/machinelearningmastery.com\/","name":"Machine Learning Mastery","potentialAction":{"@type":"SearchAction","target":"https:\/\/machinelearningmastery.com\/?s={search_term_string}","query-input":"required name=search_term_string"}}</script>
<script type="application/ld+json">{"@context":"http:\/\/schema.org","@type":"Organization","url":"https:\/\/machinelearningmastery.com\/encoder-decoder-attention-sequence-to-sequence-prediction-keras\/","sameAs":["https:\/\/www.facebook.com\/Machine-Learning-Mastery-1429846323896563\/","https:\/\/www.linkedin.com\/in\/jasonbrownlee","https:\/\/plus.google.com\/u\/0\/b\/117073416089354242117\/+MachinelearningmasteryHome\/","https:\/\/twitter.com\/TeachTheMachine"],"@id":"#organization","name":"Machine Learning Mastery","logo":"https:\/\/machinelearningmastery.com\/wp-content\/uploads\/2016\/09\/cropped-icon.png"}</script>
<!-- / Yoast SEO plugin. -->
<link href="//cdnjs.cloudflare.com" rel="dns-prefetch"/>
<link href="//fonts.googleapis.com" rel="dns-prefetch"/>
<link href="//s.w.org" rel="dns-prefetch"/>
<link href="https://feeds.feedburner.com/MachineLearningMastery" rel="alternate" title="Machine Learning Mastery » Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/comments/feed/" rel="alternate" title="Machine Learning Mastery » Comments Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/feed/" rel="alternate" title="Machine Learning Mastery » How to Develop an Encoder-Decoder Model with Attention for Sequence-to-Sequence Prediction in Keras Comments Feed" type="application/rss+xml"/>
<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/machinelearningmastery.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.9.2"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56794,8205,9794,65039],[55358,56794,8203,9794,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta" id="crayon-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta" id="crayon-theme-classic-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta" id="crayon-font-monaco-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=4.9.2" id="contact-form-7-css" media="all" rel="stylesheet" type="text/css"/>
<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css?ver=4.2.2.0.iis7_supports_permalinks" id="apss-font-awesome-css" media="all" rel="stylesheet" type="text/css"/>
<link href="//fonts.googleapis.com/css?family=Open+Sans&amp;ver=4.9.2" id="apss-font-opensans-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/seo-optimized-share-buttons/css/frontend.css?ver=4.2.2.0.iis7_supports_permalinks" id="apss-frontend-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/integrations/testimonials/css/testimonials.css?ver=4.9.2" id="woo-testimonials-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/style.css?ver=5.9.21" id="theme-stylesheet-css" media="all" rel="stylesheet" type="text/css"/>
<!--[if lt IE 9]>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/css/non-responsive.css" rel="stylesheet" type="text/css" />
<style type="text/css">.col-full, #wrapper { width: 960px; max-width: 960px; } #inner-wrapper { padding: 0; } body.full-width #header, #nav-container, body.full-width #content, body.full-width #footer-widgets, body.full-width #footer { padding-left: 0; padding-right: 0; } body.fixed-mobile #top, body.fixed-mobile #header-container, body.fixed-mobile #footer-container, body.fixed-mobile #nav-container, body.fixed-mobile #footer-widgets-container { min-width: 960px; padding: 0 1em; } body.full-width #content { width: auto; padding: 0 1em;}</style>
<![endif]-->
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery.js?ver=1.12.4" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/machinelearningmastery.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/third-party.min.js?ver=4.9.2" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/modernizr.min.js?ver=2.6.2" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/general.min.js?ver=4.9.2" type="text/javascript"></script>
<link href="https://machinelearningmastery.com/wp-json/" rel="https://api.w.org/"/>
<link href="https://machinelearningmastery.com/xmlrpc.php?rsd" rel="EditURI" title="RSD" type="application/rsd+xml"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/wlwmanifest.xml" rel="wlwmanifest" type="application/wlwmanifest+xml"/>
<link href="https://machinelearningmastery.com/?p=4549" rel="shortlink"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fencoder-decoder-attention-sequence-to-sequence-prediction-keras%2F" rel="alternate" type="application/json+oembed"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fencoder-decoder-attention-sequence-to-sequence-prediction-keras%2F&amp;format=xml" rel="alternate" type="text/xml+oembed"/>
<!-- Start Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44039733-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->
<!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');

fbq('init', '296263687421164');
fbq('track', "PageView");</script>
<noscript><img height="1" src="https://www.facebook.com/tr?id=296263687421164&amp;ev=PageView&amp;noscript=1" style="display:none" width="1"/></noscript>
<!-- End Facebook Pixel Code -->
<!-- Custom CSS Styling -->
<style type="text/css">
#logo .site-title, #logo .site-description { display:none; }
body {background-repeat:no-repeat;background-position:top left;background-attachment:scroll;border-top:0px solid #000000;}
#header {background-repeat:no-repeat;background-position:left top;margin-top:0px;margin-bottom:0px;padding-top:10px;padding-bottom:10px;border:0px solid ;}
#logo .site-title a {font:bold 40px/1em Helvetica Neue, Helvetica, sans-serif;color:#222222;}
#logo .site-description {font:300 13px/1em Helvetica Neue, Helvetica, sans-serif;color:#999999;}
body, p { font:300 14px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
h1 { font:bold 28px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h2 { font:bold 24px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h3 { font:bold 20px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h4 { font:bold 16px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h5 { font:bold 14px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h6 { font:bold 12px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }
.page-title, .post .title, .page .title {font:bold 28px/1.1em "Helvetica Neue", Helvetica, sans-serif;color:#222222;}
.post .title a:link, .post .title a:visited, .page .title a:link, .page .title a:visited {color:#222222}
.post-meta { font:300 12px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#999999; }
.entry, .entry p{ font:300 15px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555; }
.post-more {font:300 13px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:;border-top:0px solid #e6e6e6;border-bottom:0px solid #e6e6e6;}
#post-author, #connect {border-top:1px solid #e6e6e6;border-bottom:1px solid #e6e6e6;border-left:1px solid #e6e6e6;border-right:1px solid #e6e6e6;border-radius:5px;-moz-border-radius:5px;-webkit-border-radius:5px;background-color:#fafafa}
.nav-entries a, .woo-pagination { font:300 13px/1em "Helvetica Neue", Helvetica, sans-serif;color:#888; }
.woo-pagination a, .woo-pagination a:hover {color:#888!important}
.widget h3 {font:bold 14px/1.2em &quot;Helvetica Neue&quot;, Helvetica, sans-serif;color:#555555;border-bottom:1px solid #e6e6e6;}
.widget_recent_comments li, #twitter li { border-color: #e6e6e6;}
.widget p, .widget .textwidget { font:300 13px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
.widget {font:300 13px/1.5em &quot;Helvetica Neue&quot;, Helvetica, sans-serif;color:#555555;border-radius:0px;-moz-border-radius:0px;-webkit-border-radius:0px;}
#tabs .inside li a, .widget_woodojo_tabs .tabbable .tab-pane li a { font:bold 12px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
#tabs .inside li span.meta, .widget_woodojo_tabs .tabbable .tab-pane li span.meta { font:300 11px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
#tabs ul.wooTabs li a, .widget_woodojo_tabs .tabbable .nav-tabs li a { font:300 11px/2em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
@media only screen and (min-width:768px) {
ul.nav li a, #navigation ul.rss a, #navigation ul.cart a.cart-contents, #navigation .cart-contents #navigation ul.rss, #navigation ul.nav-search, #navigation ul.nav-search a { font:300 14px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#666666; } #navigation ul.rss li a:before, #navigation ul.nav-search a.search-contents:before { color:#666666;}
#navigation ul.nav li ul, #navigation ul.cart > li > ul > div  { border: 0px solid #dbdbdb; }
#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation ul.nav > li  { border-right: 0px solid #dbdbdb; }#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation { box-shadow: none; -moz-box-shadow: none; -webkit-box-shadow: none; }#navigation ul li:first-child, #navigation ul li:first-child a { border-radius:0px 0 0 0px; -moz-border-radius:0px 0 0 0px; -webkit-border-radius:0px 0 0 0px; }
#navigation {border-top:0px solid #dbdbdb;border-bottom:0px solid #dbdbdb;border-left:0px solid #dbdbdb;border-right:0px solid #dbdbdb;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
#top ul.nav li a { font:300 12px/1.6em Helvetica Neue, Helvetica, sans-serif;color:#ddd; }
}
#footer, #footer p { font:300 13px/1.4em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
#footer {border-top:1px solid #dbdbdb;border-bottom:0px solid ;border-left:0px solid ;border-right:0px solid ;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
.magazine #loopedSlider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-magazine .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.magazine #loopedSlider .content .excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-magazine .slide-content p, .wooslider-theme-magazine .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.magazine .block .post .title a {font:bold 18px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }
#loopedSlider.business-slider .content h2 { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#loopedSlider.business-slider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#wrapper #loopedSlider.business-slider .content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.archive_header { font:bold 18px/1em Arial, sans-serif;color:#222222; }
.archive_header {border-bottom:1px solid #e6e6e6;}
.archive_header .catrss { display:none; }
</style>
<!-- Woo Shortcodes CSS -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/functions/css/shortcodes.css" rel="stylesheet" type="text/css"/>
<!-- Custom Stylesheet -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/custom.css" rel="stylesheet" type="text/css"/>
<!-- Theme version -->
<meta content="Canvas 5.9.21" name="generator"/>
<meta content="WooFramework 6.2.9" name="generator"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-32x32.png" rel="icon" sizes="32x32"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-192x192.png" rel="icon" sizes="192x192"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-180x180.png" rel="apple-touch-icon-precomposed"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-270x270.png" name="msapplication-TileImage"/>
</head>
<body class="post-template-default single single-post postid-4549 single-format-standard safari alt-style-default two-col-left width-960 two-col-left-960">
<div id="wrapper">
<div id="inner-wrapper">
<h3 class="nav-toggle icon"><a href="#navigation">Navigation</a></h3>
<header class="col-full" id="header">
<div id="logo">
<a href="https://machinelearningmastery.com/" title="Making developers awesome at machine learning"><img alt="Machine Learning Mastery" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/MachineLearningMastery.png"/></a>
<span class="site-title"><a href="https://machinelearningmastery.com/">Machine Learning Mastery</a></span>
<span class="site-description">Making developers awesome at machine learning</span>
</div>
<div class="header-widget">
<div class="widget widget_text" id="text-3"> <div class="textwidget"><br/>
<div style="font-size:12pt;">
<a href="/start-here"><strong>Start Here</strong></a>
     
<a href="/blog">Blog</a>
     
<a href="/products">Books</a>
     
<a href="/about">About</a>
     
<a href="/contact">Contact</a>
</div></div>
</div><div class="widget widget_search" id="search-3"><div class="search_main">
<form action="https://machinelearningmastery.com/" class="searchform" method="get">
<input class="field s" name="s" onblur="if (this.value == '') {this.value = 'Search...';}" onfocus="if (this.value == 'Search...') {this.value = '';}" type="text" value="Search..."/>
<button class="fa fa-search submit" name="submit" type="submit" value="Search"></button>
</form>
<div class="fix"></div>
</div></div><div class="widget widget_text" id="text-31"> <div class="textwidget"><p>Need help with LSTMs in Python? <a href="https://machinelearningmastery.lpages.co/lnwp-mini-course/">Take the FREE Mini-Course</a>.</p>
</div>
</div> </div>
</header>
<nav class="col-full" id="navigation" role="navigation">
<section class="menus">
<a class="nav-home" href="https://machinelearningmastery.com"><span>Home</span></a>
<h3>Empty Menu</h3> <div class="side-nav">
</div><!-- /#side-nav -->
</section><!-- /.menus -->
<a class="nav-close" href="#top"><span>Return to Content</span></a>
</nav>
<!-- #content Starts -->
<div class="col-full" id="content">
<div id="main-sidebar-container">
<!-- #main Starts -->
<section id="main">
<article class="post-4549 post type-post status-publish format-standard has-post-thumbnail hentry category-lstm">
<header>
<h1 class="title entry-title">How to Develop an Encoder-Decoder Model with Attention for Sequence-to-Sequence Prediction in Keras</h1> </header>
<div class="post-meta"><span class="small">By</span> <span class="author vcard"><span class="fn"><a href="https://machinelearningmastery.com/author/jasonb/" rel="author" title="Posts by Jason Brownlee">Jason Brownlee</a></span></span> <span class="small">on</span> <abbr class="date time published updated" title="2017-10-17T05:00:48+1100">October 17, 2017</abbr> <span class="small">in</span> <span class="categories"><a href="https://machinelearningmastery.com/category/lstm/" title="View all items in Long Short-Term Memory Networks">Long Short-Term Memory Networks</a></span> </div>
<section class="entry">
<div class="apss-social-share apss-theme-4 clearfix">
<div class="apss-twitter apss-single-icon">
<a href="javascript:void(0);" onclick="apss_open_in_popup_window(event, 'https://twitter.com/intent/tweet?text=How%20to%20Develop%20an%20Encoder-Decoder%20Model%20with%20Attention%20for%20Sequence-to-Sequence%20Prediction%20in%20Keras&amp;url=https%3A%2F%2Fmachinelearningmastery.com%2Fencoder-decoder-attention-sequence-to-sequence-prediction-keras%2F&amp;');" rel="nofollow" target="" title="Share on Twitter">
<div class="apss-icon-block clearfix">
<i class="fa fa-twitter"></i>
<span class="apss-social-text">Share on Twitter</span><span class="apss-share">Tweet</span>
</div>
</a>
</div>
<div class="apss-facebook apss-single-icon">
<a href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/" onclick="apss_open_in_popup_window(event, 'https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/');" rel="nofollow" target="" title="Share on Facebook">
<div class="apss-icon-block clearfix">
<i class="fa fa-facebook"></i>
<span class="apss-social-text">Share on Facebook</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-linkedin apss-single-icon">
<a href="http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Develop%20an%20Encoder-Decoder%20Model%20with%20Attention%20for%20Sequence-to-Sequence%20Prediction%20in%20Keras&amp;url=https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/&amp;summary=The+encoder-decoder+architecture+for+recurrent+neural+networks+is+proving+to+be+powerful+on+a+host+o..." onclick="apss_open_in_popup_window(event, 'http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Develop%20an%20Encoder-Decoder%20Model%20with%20Attention%20for%20Sequence-to-Sequence%20Prediction%20in%20Keras&amp;url=https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/&amp;summary=The+encoder-decoder+architecture+for+recurrent+neural+networks+is+proving+to+be+powerful+on+a+host+o...');" rel="nofollow" target="" title="Share on LinkedIn">
<div class="apss-icon-block clearfix"><i class="fa fa-linkedin"></i>
<span class="apss-social-text">Share on LinkedIn</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-google-plus apss-single-icon">
<a href="https://plus.google.com/share?url=https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/" onclick="apss_open_in_popup_window(event, 'https://plus.google.com/share?url=https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/');" rel="nofollow" target="" title="Share on Google Plus">
<div class="apss-icon-block clearfix">
<i class="fa fa-google-plus"></i>
<span class="apss-social-text">Share on Google Plus</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
</div><p>The encoder-decoder architecture for recurrent neural networks is proving to be powerful on a host of sequence-to-sequence prediction problems in the field of natural language processing such as machine translation and caption generation.</p>
<p>Attention is a mechanism that addresses a limitation of the encoder-decoder architecture on long sequences, and that in general speeds up the learning and lifts the skill of the model no sequence to sequence prediction problems.</p>
<p>In this tutorial, you will discover how to develop an encoder-decoder recurrent neural network with attention in Python with Keras.</p>
<p>After completing this tutorial, you will know:</p>
<ul>
<li>How to design a small and configurable problem to evaluate encoder-decoder recurrent neural networks with and without attention.</li>
<li>How to design and evaluate an encoder-decoder network with and without attention for the sequence prediction problem.</li>
<li>How to robustly compare the performance of encoder-decoder networks with and without attention.</li>
</ul>
<p>Let’s get started.</p>
<div class="wp-caption aligncenter" id="attachment_4550" style="max-width: 650px"><img alt="How to Develop an Encoder-Decoder Model with Attention for Sequence-to-Sequence Prediction in Keras" class="size-full wp-image-4550" height="427" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/10/How-to-Develop-an-Encoder-Decoder-Model-with-Attention-for-Sequence-to-Sequence-Prediction-in-Keras.jpg" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/10/How-to-Develop-an-Encoder-Decoder-Model-with-Attention-for-Sequence-to-Sequence-Prediction-in-Keras.jpg 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/10/How-to-Develop-an-Encoder-Decoder-Model-with-Attention-for-Sequence-to-Sequence-Prediction-in-Keras-300x200.jpg 300w" width="640"/><p class="wp-caption-text">How to Develop an Encoder-Decoder Model with Attention for Sequence-to-Sequence Prediction in Keras<br/>Photo by <a href="https://www.flickr.com/photos/150568953@N07/34585914155/">Angela and Andrew</a>, some rights reserved.</p></div>
<h2>Tutorial Overview</h2>
<p>This tutorial is divided into 6 parts; they are:</p>
<ol>
<li>Encoder-Decoder with Attention</li>
<li>Test Problem for Attention</li>
<li>Encoder-Decoder without Attention</li>
<li>Custom Keras Attention Layer</li>
<li>Encoder-Decoder with Attention</li>
<li>Comparison of Models</li>
</ol>
<h3>Python Environment</h3>
<p>This tutorial assumes you have a Python 3 SciPy environment installed.</p>
<p>You must have Keras (2.0 or higher) installed with either the TensorFlow or Theano backend.</p>
<p>The tutorial also assumes you have scikit-learn, Pandas, NumPy, and Matplotlib installed.</p>
<p>If you need help with your environment, see this post:</p>
<ul>
<li><a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/">How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda</a></li>
</ul>
<h2>Encoder-Decoder with Attention</h2>
<p>The encoder-decoder model for recurrent neural networks is an architecture for sequence-to-sequence prediction problems.</p>
<p>It is comprised of two sub-models, as its name suggests:</p>
<ul>
<li><strong>Encoder</strong>: The encoder is responsible for stepping through the input time steps and encoding the entire sequence into a fixed length vector called a context vector.</li>
<li><strong>Decoder</strong>: The decoder is responsible for stepping through the output time steps while reading from the context vector.</li>
</ul>
<p>A problem with the architecture is that performance is poor on long input or output sequences. The reason is believed to be because of the fixed-sized internal representation used by the encoder.</p>
<p>Attention is an extension to the architecture that addresses this limitation. It works by first providing a richer context from the encoder to the decoder and a learning mechanism where the decoder can learn where to pay attention in the richer encoding when predicting each time step in the output sequence.</p>
<p>For more on attention in the encoder-decoder architecture, see the posts:</p>
<ul>
<li><a href="https://machinelearningmastery.com/attention-long-short-term-memory-recurrent-neural-networks/">Attention in Long Short-Term Memory Recurrent Neural Networks</a></li>
<li><a href="https://machinelearningmastery.com/how-does-attention-work-in-encoder-decoder-recurrent-neural-networks/">How Does Attention Work in Encoder-Decoder Recurrent Neural Networks</a></li>
</ul>
<h2>Test Problem for Attention</h2>
<p>Before we develop models with attention, we will first define a contrived scalable test problem that we can use to determine whether attention is providing any benefit.</p>
<p>In this problem, we will generate sequences of random integers as input and matching output sequences comprised of a subset of the integers in the input sequence.</p>
<p>For example, an input sequence might be [1, 6, 2, 7, 3] and the expected output sequence might be the first two random integers in the sequence [1, 6].</p>
<p>We will define the problem such that the input and output sequences are the same length and pad the output sequences with “0” values as needed.</p>
<p>First, we need a function to generate sequences of random integers. We will use the Python <a href="https://docs.python.org/3/library/random.html">randint()</a> function to generate random integers between 0 and a maximum value and use this range as the cardinality for the problem (e.g. the number of features or an axis of difficulty).</p>
<p>The function <em>generate_sequence()</em> below will generate a random sequence of integers to a fixed length and with the specified cardinality.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669a7067784172" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from random import randint

# generate a sequence of random integers
def generate_sequence(length, n_unique):
	return [randint(0, n_unique-1) for _ in range(length)]

# generate random sequence
sequence = generate_sequence(5, 50)
print(sequence)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669a7067784172-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669a7067784172-2">2</div><div class="crayon-num" data-line="crayon-5a659134669a7067784172-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669a7067784172-4">4</div><div class="crayon-num" data-line="crayon-5a659134669a7067784172-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669a7067784172-6">6</div><div class="crayon-num" data-line="crayon-5a659134669a7067784172-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669a7067784172-8">8</div><div class="crayon-num" data-line="crayon-5a659134669a7067784172-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669a7067784172-1"><span class="crayon-e">from </span><span class="crayon-e">random </span><span class="crayon-e">import </span><span class="crayon-v">randint</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669a7067784172-2"> </div><div class="crayon-line" id="crayon-5a659134669a7067784172-3"><span class="crayon-p"># generate a sequence of random integers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669a7067784172-4"><span class="crayon-e">def </span><span class="crayon-e">generate_sequence</span><span class="crayon-sy">(</span><span class="crayon-v">length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669a7067784172-5"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">randint</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">length</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669a7067784172-6"> </div><div class="crayon-line" id="crayon-5a659134669a7067784172-7"><span class="crayon-p"># generate random sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669a7067784172-8"><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_sequence</span><span class="crayon-sy">(</span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669a7067784172-9"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">sequence</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>Running this example generates a sequence of 5 time steps where each value in the sequence is a random integer between 0 and 49.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669b3210999765" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
[43, 3, 28, 34, 33]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669b3210999765-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669b3210999765-1">[43, 3, 28, 34, 33]</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Next, we need a function to <a href="https://machinelearningmastery.com/how-to-one-hot-encode-sequence-data-in-python/">one hot encode</a> the discrete integer values into binary vectors.</p>
<p>If a cardinality of 50 is used, then each integer will be represented by a 50-element vector of 0 values and 1 in the index of the specified integer value.</p>
<p>The <em>one_hot_encode()</em> function below will one hot encode a given sequence of integers.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669b6228164811" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# one hot encode sequence
def one_hot_encode(sequence, n_unique):
	encoding = list()
	for value in sequence:
		vector = [0 for _ in range(n_unique)]
		vector[value] = 1
		encoding.append(vector)
	return array(encoding)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669b6228164811-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669b6228164811-2">2</div><div class="crayon-num" data-line="crayon-5a659134669b6228164811-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669b6228164811-4">4</div><div class="crayon-num" data-line="crayon-5a659134669b6228164811-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669b6228164811-6">6</div><div class="crayon-num" data-line="crayon-5a659134669b6228164811-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669b6228164811-8">8</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669b6228164811-1"><span class="crayon-p"># one hot encode sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669b6228164811-2"><span class="crayon-e">def </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669b6228164811-3"><span class="crayon-h"> </span><span class="crayon-v">encoding</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669b6228164811-4"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">value </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669b6228164811-5"><span class="crayon-h"> </span><span class="crayon-v">vector</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669b6228164811-6"><span class="crayon-h"> </span><span class="crayon-v">vector</span><span class="crayon-sy">[</span><span class="crayon-v">value</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a659134669b6228164811-7"><span class="crayon-h"> </span><span class="crayon-v">encoding</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">vector</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669b6228164811-8"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">encoding</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0010 seconds] -->
<p>We also need to be able to decode an encoded sequence. This will be needed to turn a prediction from the model or an encoded expected sequence back into a sequence of integers we can read and evaluate.</p>
<p>The <em>one_hot_decode()</em> function below will decode a one hot encoded sequence back into a sequence of integers.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669b9122713494" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# decode a one hot encoded string
def one_hot_decode(encoded_seq):
	return [argmax(vector) for vector in encoded_seq]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669b9122713494-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669b9122713494-2">2</div><div class="crayon-num" data-line="crayon-5a659134669b9122713494-3">3</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669b9122713494-1"><span class="crayon-p"># decode a one hot encoded string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669b9122713494-2"><span class="crayon-e">def </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">encoded_seq</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669b9122713494-3"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">argmax</span><span class="crayon-sy">(</span><span class="crayon-v">vector</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">vector </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">encoded_seq</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0004 seconds] -->
<p>We can test out these operations in the example below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669bb815703491" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from random import randint
from numpy import array
from numpy import argmax

# generate a sequence of random integers
def generate_sequence(length, n_unique):
	return [randint(0, n_unique-1) for _ in range(length)]

# one hot encode sequence
def one_hot_encode(sequence, n_unique):
	encoding = list()
	for value in sequence:
		vector = [0 for _ in range(n_unique)]
		vector[value] = 1
		encoding.append(vector)
	return array(encoding)

# decode a one hot encoded string
def one_hot_decode(encoded_seq):
	return [argmax(vector) for vector in encoded_seq]

# generate random sequence
sequence = generate_sequence(5, 50)
print(sequence)
# one hot encode
encoded = one_hot_encode(sequence, 50)
print(encoded)
# decode
decoded = one_hot_decode(encoded)
print(decoded)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669bb815703491-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-2">2</div><div class="crayon-num" data-line="crayon-5a659134669bb815703491-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-4">4</div><div class="crayon-num" data-line="crayon-5a659134669bb815703491-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-6">6</div><div class="crayon-num" data-line="crayon-5a659134669bb815703491-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-8">8</div><div class="crayon-num" data-line="crayon-5a659134669bb815703491-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-10">10</div><div class="crayon-num" data-line="crayon-5a659134669bb815703491-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-12">12</div><div class="crayon-num" data-line="crayon-5a659134669bb815703491-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-14">14</div><div class="crayon-num" data-line="crayon-5a659134669bb815703491-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-16">16</div><div class="crayon-num" data-line="crayon-5a659134669bb815703491-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-18">18</div><div class="crayon-num" data-line="crayon-5a659134669bb815703491-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-20">20</div><div class="crayon-num" data-line="crayon-5a659134669bb815703491-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-22">22</div><div class="crayon-num" data-line="crayon-5a659134669bb815703491-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-24">24</div><div class="crayon-num" data-line="crayon-5a659134669bb815703491-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-26">26</div><div class="crayon-num" data-line="crayon-5a659134669bb815703491-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-28">28</div><div class="crayon-num" data-line="crayon-5a659134669bb815703491-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669bb815703491-30">30</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669bb815703491-1"><span class="crayon-e">from </span><span class="crayon-e">random </span><span class="crayon-e">import </span><span class="crayon-e">randint</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-2"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line" id="crayon-5a659134669bb815703491-3"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-v">argmax</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-4"> </div><div class="crayon-line" id="crayon-5a659134669bb815703491-5"><span class="crayon-p"># generate a sequence of random integers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-6"><span class="crayon-e">def </span><span class="crayon-e">generate_sequence</span><span class="crayon-sy">(</span><span class="crayon-v">length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669bb815703491-7"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">randint</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">length</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-8"> </div><div class="crayon-line" id="crayon-5a659134669bb815703491-9"><span class="crayon-p"># one hot encode sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-10"><span class="crayon-e">def </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669bb815703491-11"><span class="crayon-h"> </span><span class="crayon-v">encoding</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-12"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">value </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669bb815703491-13"><span class="crayon-h"> </span><span class="crayon-v">vector</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-14"><span class="crayon-h"> </span><span class="crayon-v">vector</span><span class="crayon-sy">[</span><span class="crayon-v">value</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a659134669bb815703491-15"><span class="crayon-h"> </span><span class="crayon-v">encoding</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">vector</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-16"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">encoding</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669bb815703491-17"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-18"><span class="crayon-p"># decode a one hot encoded string</span></div><div class="crayon-line" id="crayon-5a659134669bb815703491-19"><span class="crayon-e">def </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">encoded_seq</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-20"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">argmax</span><span class="crayon-sy">(</span><span class="crayon-v">vector</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">vector </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">encoded_seq</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a659134669bb815703491-21"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-22"><span class="crayon-p"># generate random sequence</span></div><div class="crayon-line" id="crayon-5a659134669bb815703491-23"><span class="crayon-v">sequence</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_sequence</span><span class="crayon-sy">(</span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-24"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">sequence</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669bb815703491-25"><span class="crayon-p"># one hot encode</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-26"><span class="crayon-v">encoded</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669bb815703491-27"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">encoded</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-28"><span class="crayon-p"># decode</span></div><div class="crayon-line" id="crayon-5a659134669bb815703491-29"><span class="crayon-v">decoded</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">encoded</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669bb815703491-30"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">decoded</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0019 seconds] -->
<p>Running the example first prints a randomly generated sequence, then the one hot encoded version, then finally the decoded sequence again.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669be457538929" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
[3, 18, 32, 11, 36]
[[0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]
 [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]
 [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]
 [0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]
 [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0]]
[3, 18, 32, 11, 36]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669be457538929-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669be457538929-2">2</div><div class="crayon-num" data-line="crayon-5a659134669be457538929-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669be457538929-4">4</div><div class="crayon-num" data-line="crayon-5a659134669be457538929-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669be457538929-6">6</div><div class="crayon-num" data-line="crayon-5a659134669be457538929-7">7</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669be457538929-1">[3, 18, 32, 11, 36]</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669be457538929-2">[[0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]</div><div class="crayon-line" id="crayon-5a659134669be457538929-3"> [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669be457538929-4"> [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]</div><div class="crayon-line" id="crayon-5a659134669be457538929-5"> [0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669be457538929-6"> [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0]]</div><div class="crayon-line" id="crayon-5a659134669be457538929-7">[3, 18, 32, 11, 36]</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Finally, we need a function that can create input and output pairs of sequences to train and evaluate a model.</p>
<p>The function below named <em>get_pair()</em> will return one input and output sequence pair given a specified input length, output length, and cardinality. Both input and output sequences are the same length, the length of the input sequence, but the output sequence will be taken as the first <em>n</em> characters of the input sequence and padded with zero values to the required length.</p>
<p>The sequences of integers are then encoded then reshaped into a 3D format required for the recurrent neural network, with the dimensions: <em>samples</em>, <em>time steps</em>, and <em>features</em>. In this case, samples is always 1 as we are only generating one input-output pair, the time steps is the input sequence length and features is the cardinality of each time step.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669c1013386968" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# prepare data for the LSTM
def get_pair(n_in, n_out, n_unique):
	# generate random sequence
	sequence_in = generate_sequence(n_in, n_unique)
	sequence_out = sequence_in[:n_out] + [0 for _ in range(n_in-n_out)]
	# one hot encode
	X = one_hot_encode(sequence_in, n_unique)
	y = one_hot_encode(sequence_out, n_unique)
	# reshape as 3D
	X = X.reshape((1, X.shape[0], X.shape[1]))
	y = y.reshape((1, y.shape[0], y.shape[1]))
	return X,y</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669c1013386968-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c1013386968-2">2</div><div class="crayon-num" data-line="crayon-5a659134669c1013386968-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c1013386968-4">4</div><div class="crayon-num" data-line="crayon-5a659134669c1013386968-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c1013386968-6">6</div><div class="crayon-num" data-line="crayon-5a659134669c1013386968-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c1013386968-8">8</div><div class="crayon-num" data-line="crayon-5a659134669c1013386968-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c1013386968-10">10</div><div class="crayon-num" data-line="crayon-5a659134669c1013386968-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c1013386968-12">12</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669c1013386968-1"><span class="crayon-p"># prepare data for the LSTM</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c1013386968-2"><span class="crayon-e">def </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669c1013386968-3"><span class="crayon-h"> </span><span class="crayon-p"># generate random sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c1013386968-4"><span class="crayon-h"> </span><span class="crayon-v">sequence_in</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_sequence</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669c1013386968-5"><span class="crayon-h"> </span><span class="crayon-v">sequence_out</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sequence_in</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">n_out</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-o">-</span><span class="crayon-v">n_out</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c1013386968-6"><span class="crayon-h"> </span><span class="crayon-p"># one hot encode</span></div><div class="crayon-line" id="crayon-5a659134669c1013386968-7"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c1013386968-8"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669c1013386968-9"><span class="crayon-h"> </span><span class="crayon-p"># reshape as 3D</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c1013386968-10"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669c1013386968-11"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c1013386968-12"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0016 seconds] -->
<p>We can put this all together and demonstrate the data preparation code.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669c4839204611" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from random import randint
from numpy import array
from numpy import argmax

# generate a sequence of random integers
def generate_sequence(length, n_unique):
	return [randint(0, n_unique-1) for _ in range(length)]

# one hot encode sequence
def one_hot_encode(sequence, n_unique):
	encoding = list()
	for value in sequence:
		vector = [0 for _ in range(n_unique)]
		vector[value] = 1
		encoding.append(vector)
	return array(encoding)

# decode a one hot encoded string
def one_hot_decode(encoded_seq):
	return [argmax(vector) for vector in encoded_seq]

# prepare data for the LSTM
def get_pair(n_in, n_out, n_unique):
	# generate random sequence
	sequence_in = generate_sequence(n_in, n_unique)
	sequence_out = sequence_in[:n_out] + [0 for _ in range(n_in-n_out)]
	# one hot encode
	X = one_hot_encode(sequence_in, n_unique)
	y = one_hot_encode(sequence_out, n_unique)
	# reshape as 3D
	X = X.reshape((1, X.shape[0], X.shape[1]))
	y = y.reshape((1, y.shape[0], y.shape[1]))
	return X,y

# generate random sequence
X, y = get_pair(5, 2, 50)
print(X.shape, y.shape)
print('X=%s, y=%s' % (one_hot_decode(X[0]), one_hot_decode(y[0])))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669c4839204611-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-2">2</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-4">4</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-6">6</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-8">8</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-10">10</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-12">12</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-14">14</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-16">16</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-18">18</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-20">20</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-22">22</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-24">24</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-26">26</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-28">28</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-30">30</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-32">32</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-34">34</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-36">36</div><div class="crayon-num" data-line="crayon-5a659134669c4839204611-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c4839204611-38">38</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669c4839204611-1"><span class="crayon-e">from </span><span class="crayon-e">random </span><span class="crayon-e">import </span><span class="crayon-e">randint</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-2"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-3"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-v">argmax</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-4"> </div><div class="crayon-line" id="crayon-5a659134669c4839204611-5"><span class="crayon-p"># generate a sequence of random integers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-6"><span class="crayon-e">def </span><span class="crayon-e">generate_sequence</span><span class="crayon-sy">(</span><span class="crayon-v">length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-7"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">randint</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">length</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-8"> </div><div class="crayon-line" id="crayon-5a659134669c4839204611-9"><span class="crayon-p"># one hot encode sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-10"><span class="crayon-e">def </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-11"><span class="crayon-h"> </span><span class="crayon-v">encoding</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-12"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">value </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-13"><span class="crayon-h"> </span><span class="crayon-v">vector</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-14"><span class="crayon-h"> </span><span class="crayon-v">vector</span><span class="crayon-sy">[</span><span class="crayon-v">value</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-15"><span class="crayon-h"> </span><span class="crayon-v">encoding</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">vector</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-16"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">encoding</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-17"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-18"><span class="crayon-p"># decode a one hot encoded string</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-19"><span class="crayon-e">def </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">encoded_seq</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-20"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">argmax</span><span class="crayon-sy">(</span><span class="crayon-v">vector</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">vector </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">encoded_seq</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-21"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-22"><span class="crayon-p"># prepare data for the LSTM</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-23"><span class="crayon-e">def </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-24"><span class="crayon-h"> </span><span class="crayon-p"># generate random sequence</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-25"><span class="crayon-h"> </span><span class="crayon-v">sequence_in</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_sequence</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-26"><span class="crayon-h"> </span><span class="crayon-v">sequence_out</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sequence_in</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">n_out</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-o">-</span><span class="crayon-v">n_out</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-27"><span class="crayon-h"> </span><span class="crayon-p"># one hot encode</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-28"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-29"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-30"><span class="crayon-h"> </span><span class="crayon-p"># reshape as 3D</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-31"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-32"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-33"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-34"> </div><div class="crayon-line" id="crayon-5a659134669c4839204611-35"><span class="crayon-p"># generate random sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-36"><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-cn">5</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">50</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669c4839204611-37"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c4839204611-38"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'X=%s, y=%s'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0038 seconds] -->
<p>Running the example generates a single input-output pair and prints the shape of both arrays.</p>
<p>The generated pair is then printed in a decoded form where we can see that the first two integers of the sequence are reproduced in the output sequence followed by a padding of zero values.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669c7666333034" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
(1, 5, 50) (1, 5, 50)
X=[12, 20, 36, 40, 12], y=[12, 20, 0, 0, 0]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669c7666333034-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669c7666333034-2">2</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669c7666333034-1">(1, 5, 50) (1, 5, 50)</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669c7666333034-2">X=[12, 20, 36, 40, 12], y=[12, 20, 0, 0, 0]</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<h2>Encoder-Decoder Without Attention</h2>
<p>In this section, we will develop a baseline in performance on the problem with an encoder-decoder model without attention.</p>
<p>We will fix the problem definition at input and output sequences of 5 time steps, the first 2 elements of the input sequence in the output sequence and a cardinality of 50.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669ca695281308" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# configure problem
n_features = 50
n_timesteps_in = 5
n_timesteps_out = 2</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669ca695281308-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669ca695281308-2">2</div><div class="crayon-num" data-line="crayon-5a659134669ca695281308-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669ca695281308-4">4</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669ca695281308-1"><span class="crayon-p"># configure problem</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669ca695281308-2"><span class="crayon-v">n_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">50</span></div><div class="crayon-line" id="crayon-5a659134669ca695281308-3"><span class="crayon-v">n_timesteps_in</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">5</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669ca695281308-4"><span class="crayon-v">n_timesteps_out</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0003 seconds] -->
<p>We can develop a simple encoder-decoder model in Keras by taking the output from an encoder LSTM model, repeating it n times for the number of timesteps in the output sequence, then using a decoder to predict the output sequence.</p>
<p>For more detail on how to define an encoder-decoder architecture in Keras, see the post:</p>
<ul>
<li><a href="https://machinelearningmastery.com/encoder-decoder-long-short-term-memory-networks/">Encoder-Decoder Long Short-Term Memory Networks</a></li>
</ul>
<p>We will configure the encoder and decoder with the same number of units, in this case 150. We will use the efficient Adam implementation of gradient descent and optimize the categorical cross entropy loss function, given that the problem is technically a multi-class classification problem.</p>
<p>The configuration for the model was found after a little trial and error and is by no means optimized.</p>
<p>The code for an encoder-decoder architecture in Keras is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669cd502496390" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define model
model = Sequential()
model.add(LSTM(150, input_shape=(n_timesteps_in, n_features)))
model.add(RepeatVector(n_timesteps_in))
model.add(LSTM(150, return_sequences=True))
model.add(TimeDistributed(Dense(n_features, activation='softmax')))
model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['acc'])</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669cd502496390-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669cd502496390-2">2</div><div class="crayon-num" data-line="crayon-5a659134669cd502496390-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669cd502496390-4">4</div><div class="crayon-num" data-line="crayon-5a659134669cd502496390-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669cd502496390-6">6</div><div class="crayon-num" data-line="crayon-5a659134669cd502496390-7">7</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669cd502496390-1"><span class="crayon-p"># define model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669cd502496390-2"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669cd502496390-3"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669cd502496390-4"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669cd502496390-5"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669cd502496390-6"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">n_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669cd502496390-7"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'acc'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0013 seconds] -->
<p>We will train the model on 5,000 random input-output pairs of integer sequences.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669cf950093915" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# train LSTM
for epoch in range(5000):
	# generate new random sequence
	X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features)
	# fit model for one epoch on this sequence
	model.fit(X, y, epochs=1, verbose=2)</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669cf950093915-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669cf950093915-2">2</div><div class="crayon-num" data-line="crayon-5a659134669cf950093915-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669cf950093915-4">4</div><div class="crayon-num" data-line="crayon-5a659134669cf950093915-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669cf950093915-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669cf950093915-1"><span class="crayon-p"># train LSTM</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669cf950093915-2"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">epoch </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">5000</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669cf950093915-3"><span class="crayon-h"> </span><span class="crayon-p"># generate new random sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669cf950093915-4"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669cf950093915-5"><span class="crayon-h"> </span><span class="crayon-p"># fit model for one epoch on this sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669cf950093915-6"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0006 seconds] -->
<p>Once trained, we will evaluate the model on 100 new randomly generated integer sequences and only mark a prediction correct when the entire output sequence matches the expected value.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669d1265787026" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# evaluate LSTM
total, correct = 100, 0
for _ in range(total):
	X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features)
	yhat = model.predict(X, verbose=0)
	if array_equal(one_hot_decode(y[0]), one_hot_decode(yhat[0])):
		correct += 1
print('Accuracy: %.2f%%' % (float(correct)/float(total)*100.0))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669d1265787026-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d1265787026-2">2</div><div class="crayon-num" data-line="crayon-5a659134669d1265787026-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d1265787026-4">4</div><div class="crayon-num" data-line="crayon-5a659134669d1265787026-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d1265787026-6">6</div><div class="crayon-num" data-line="crayon-5a659134669d1265787026-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d1265787026-8">8</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669d1265787026-1"><span class="crayon-p"># evaluate LSTM</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d1265787026-2"><span class="crayon-v">total</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">correct</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-5a659134669d1265787026-3"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">total</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d1265787026-4"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669d1265787026-5"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d1265787026-6"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">array_equal</span><span class="crayon-sy">(</span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669d1265787026-7"><span class="crayon-h"> </span><span class="crayon-v">correct</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d1265787026-8"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Accuracy: %.2f%%'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-t">float</span><span class="crayon-sy">(</span><span class="crayon-v">correct</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-t">float</span><span class="crayon-sy">(</span><span class="crayon-v">total</span><span class="crayon-sy">)</span><span class="crayon-o">*</span><span class="crayon-cn">100.0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0016 seconds] -->
<p>Finally, we will print 10 examples of expected output sequences and sequences predicted by the model.</p>
<p>Putting all of this together, the complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669d4126363274" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from random import randint
from numpy import array
from numpy import argmax
from numpy import array_equal
from keras.models import Sequential
from keras.layers import LSTM
from keras.layers import Dense
from keras.layers import TimeDistributed
from keras.layers import RepeatVector

# generate a sequence of random integers
def generate_sequence(length, n_unique):
	return [randint(0, n_unique-1) for _ in range(length)]

# one hot encode sequence
def one_hot_encode(sequence, n_unique):
	encoding = list()
	for value in sequence:
		vector = [0 for _ in range(n_unique)]
		vector[value] = 1
		encoding.append(vector)
	return array(encoding)

# decode a one hot encoded string
def one_hot_decode(encoded_seq):
	return [argmax(vector) for vector in encoded_seq]

# prepare data for the LSTM
def get_pair(n_in, n_out, cardinality):
	# generate random sequence
	sequence_in = generate_sequence(n_in, cardinality)
	sequence_out = sequence_in[:n_out] + [0 for _ in range(n_in-n_out)]
	# one hot encode
	X = one_hot_encode(sequence_in, cardinality)
	y = one_hot_encode(sequence_out, cardinality)
	# reshape as 3D
	X = X.reshape((1, X.shape[0], X.shape[1]))
	y = y.reshape((1, y.shape[0], y.shape[1]))
	return X,y

# configure problem
n_features = 50
n_timesteps_in = 5
n_timesteps_out = 2
# define model
model = Sequential()
model.add(LSTM(150, input_shape=(n_timesteps_in, n_features)))
model.add(RepeatVector(n_timesteps_in))
model.add(LSTM(150, return_sequences=True))
model.add(TimeDistributed(Dense(n_features, activation='softmax')))
model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['acc'])
# train LSTM
for epoch in range(5000):
	# generate new random sequence
	X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features)
	# fit model for one epoch on this sequence
	model.fit(X, y, epochs=1, verbose=2)
# evaluate LSTM
total, correct = 100, 0
for _ in range(total):
	X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features)
	yhat = model.predict(X, verbose=0)
	if array_equal(one_hot_decode(y[0]), one_hot_decode(yhat[0])):
		correct += 1
print('Accuracy: %.2f%%' % (float(correct)/float(total)*100.0))
# spot check some examples
for _ in range(10):
	X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features)
	yhat = model.predict(X, verbose=0)
	print('Expected:', one_hot_decode(y[0]), 'Predicted', one_hot_decode(yhat[0]))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669d4126363274-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-2">2</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-4">4</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-6">6</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-8">8</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-10">10</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-12">12</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-14">14</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-16">16</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-18">18</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-20">20</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-22">22</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-24">24</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-26">26</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-28">28</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-30">30</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-32">32</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-34">34</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-36">36</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-38">38</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-40">40</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-42">42</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-44">44</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-46">46</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-48">48</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-50">50</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-52">52</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-54">54</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-56">56</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-58">58</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-60">60</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-62">62</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-64">64</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-66">66</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-68">68</div><div class="crayon-num" data-line="crayon-5a659134669d4126363274-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669d4126363274-70">70</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669d4126363274-1"><span class="crayon-e">from </span><span class="crayon-e">random </span><span class="crayon-e">import </span><span class="crayon-e">randint</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-2"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-3"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">argmax</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-4"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">array_equal</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Sequential</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-6"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">LSTM</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-7"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dense</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">TimeDistributed</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-v">RepeatVector</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-10"> </div><div class="crayon-line" id="crayon-5a659134669d4126363274-11"><span class="crayon-p"># generate a sequence of random integers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-12"><span class="crayon-e">def </span><span class="crayon-e">generate_sequence</span><span class="crayon-sy">(</span><span class="crayon-v">length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-13"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">randint</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">length</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-14"> </div><div class="crayon-line" id="crayon-5a659134669d4126363274-15"><span class="crayon-p"># one hot encode sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-16"><span class="crayon-e">def </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-17"><span class="crayon-h"> </span><span class="crayon-v">encoding</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-18"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">value </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-19"><span class="crayon-h"> </span><span class="crayon-v">vector</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-20"><span class="crayon-h"> </span><span class="crayon-v">vector</span><span class="crayon-sy">[</span><span class="crayon-v">value</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-21"><span class="crayon-h"> </span><span class="crayon-v">encoding</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">vector</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-22"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">encoding</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-23"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-24"><span class="crayon-p"># decode a one hot encoded string</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-25"><span class="crayon-e">def </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">encoded_seq</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-26"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">argmax</span><span class="crayon-sy">(</span><span class="crayon-v">vector</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">vector </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">encoded_seq</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-27"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-28"><span class="crayon-p"># prepare data for the LSTM</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-29"><span class="crayon-e">def </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cardinality</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-30"><span class="crayon-h"> </span><span class="crayon-p"># generate random sequence</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-31"><span class="crayon-h"> </span><span class="crayon-v">sequence_in</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_sequence</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cardinality</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-32"><span class="crayon-h"> </span><span class="crayon-v">sequence_out</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sequence_in</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">n_out</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-o">-</span><span class="crayon-v">n_out</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-33"><span class="crayon-h"> </span><span class="crayon-p"># one hot encode</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-34"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cardinality</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-35"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cardinality</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-36"><span class="crayon-h"> </span><span class="crayon-p"># reshape as 3D</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-37"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-38"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-39"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-40"> </div><div class="crayon-line" id="crayon-5a659134669d4126363274-41"><span class="crayon-p"># configure problem</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-42"><span class="crayon-v">n_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">50</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-43"><span class="crayon-v">n_timesteps_in</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">5</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-44"><span class="crayon-v">n_timesteps_out</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-45"><span class="crayon-p"># define model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-46"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-47"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-48"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-49"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-50"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">n_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-51"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'acc'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-52"><span class="crayon-p"># train LSTM</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-53"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">epoch </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">5000</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-54"><span class="crayon-h"> </span><span class="crayon-p"># generate new random sequence</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-55"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-56"><span class="crayon-h"> </span><span class="crayon-p"># fit model for one epoch on this sequence</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-57"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-58"><span class="crayon-p"># evaluate LSTM</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-59"><span class="crayon-v">total</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">correct</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-60"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">total</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-61"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-62"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-63"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">array_equal</span><span class="crayon-sy">(</span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-64"><span class="crayon-h"> </span><span class="crayon-v">correct</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-65"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Accuracy: %.2f%%'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-t">float</span><span class="crayon-sy">(</span><span class="crayon-v">correct</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-t">float</span><span class="crayon-sy">(</span><span class="crayon-v">total</span><span class="crayon-sy">)</span><span class="crayon-o">*</span><span class="crayon-cn">100.0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-66"><span class="crayon-p"># spot check some examples</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-67"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-68"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669d4126363274-69"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669d4126363274-70"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Expected:'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Predicted'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0074 seconds] -->
<p>Running this example will not take long, perhaps a few minutes on the CPU, no GPU is required.</p>
<p>The accuracy of the model was reported at just under 20%. Your results will vary given the <a href="https://machinelearningmastery.com/randomness-in-machine-learning/">stochastic nature of neural networks</a>; consider running the example a few times and taking the average.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669d8275421123" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Accuracy: 19.00%</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669d8275421123-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669d8275421123-1">Accuracy: 19.00%</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>We can see from the sample outputs that the model does get one number in the output sequence correct for most or all cases, and only struggles with the second number. All zero padding values are predicted correctly.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669da227834905" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Expected: [47, 0, 0, 0, 0] Predicted [47, 47, 0, 0, 0]
Expected: [43, 31, 0, 0, 0] Predicted [43, 31, 0, 0, 0]
Expected: [14, 22, 0, 0, 0] Predicted [14, 14, 0, 0, 0]
Expected: [39, 31, 0, 0, 0] Predicted [39, 39, 0, 0, 0]
Expected: [6, 4, 0, 0, 0] Predicted [6, 4, 0, 0, 0]
Expected: [47, 0, 0, 0, 0] Predicted [47, 47, 0, 0, 0]
Expected: [39, 33, 0, 0, 0] Predicted [39, 39, 0, 0, 0]
Expected: [23, 2, 0, 0, 0] Predicted [23, 23, 0, 0, 0]
Expected: [19, 28, 0, 0, 0] Predicted [19, 3, 0, 0, 0]
Expected: [32, 33, 0, 0, 0] Predicted [32, 32, 0, 0, 0]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669da227834905-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669da227834905-2">2</div><div class="crayon-num" data-line="crayon-5a659134669da227834905-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669da227834905-4">4</div><div class="crayon-num" data-line="crayon-5a659134669da227834905-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669da227834905-6">6</div><div class="crayon-num" data-line="crayon-5a659134669da227834905-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669da227834905-8">8</div><div class="crayon-num" data-line="crayon-5a659134669da227834905-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669da227834905-10">10</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669da227834905-1">Expected: [47, 0, 0, 0, 0] Predicted [47, 47, 0, 0, 0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669da227834905-2">Expected: [43, 31, 0, 0, 0] Predicted [43, 31, 0, 0, 0]</div><div class="crayon-line" id="crayon-5a659134669da227834905-3">Expected: [14, 22, 0, 0, 0] Predicted [14, 14, 0, 0, 0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669da227834905-4">Expected: [39, 31, 0, 0, 0] Predicted [39, 39, 0, 0, 0]</div><div class="crayon-line" id="crayon-5a659134669da227834905-5">Expected: [6, 4, 0, 0, 0] Predicted [6, 4, 0, 0, 0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669da227834905-6">Expected: [47, 0, 0, 0, 0] Predicted [47, 47, 0, 0, 0]</div><div class="crayon-line" id="crayon-5a659134669da227834905-7">Expected: [39, 33, 0, 0, 0] Predicted [39, 39, 0, 0, 0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669da227834905-8">Expected: [23, 2, 0, 0, 0] Predicted [23, 23, 0, 0, 0]</div><div class="crayon-line" id="crayon-5a659134669da227834905-9">Expected: [19, 28, 0, 0, 0] Predicted [19, 3, 0, 0, 0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669da227834905-10">Expected: [32, 33, 0, 0, 0] Predicted [32, 32, 0, 0, 0]</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<h2>Custom Keras Attention Layer</h2>
<p>Now we need to add attention to the encoder-decoder model.</p>
<p>At the time of writing, Keras does not have the capability of attention built into the library, but it is <a href="https://github.com/fchollet/keras/issues/7633">coming</a> <a href="https://github.com/fchollet/keras/pull/7980">soon</a>.</p>
<p>Until attention is officially available in Keras, we can either develop our own implementation or use an existing third-party implementation.</p>
<p>To speed things up, let’s use an existing third-party implementation.</p>
<p><a href="http://www.zafarali.me/">Zafarali Ahmed</a> an intern at <a href="https://www.datalogue.io/">Datalogue</a> developed a <a href="https://keras.io/layers/writing-your-own-keras-layers/">custom layer</a> for Keras that provides support for attention, presented in a post titled “<a href="https://medium.com/datalogue/attention-in-keras-1892773a4f22">How to Visualize Your Recurrent Neural Network with Attention in Keras</a>” in 2017 and GitHub project called “<a href="https://github.com/datalogue/keras-attention">keras-attention</a>“.</p>
<p>The custom attention layer is called <em>AttentionDecoder</em> and is available in the <a href="https://github.com/datalogue/keras-attention/blob/master/models/custom_recurrents.py">custom_recurrents.py</a> file in the GitHub project. We can reuse this code under the <a href="https://github.com/datalogue/keras-attention/blob/master/LICENSE">GNU Affero General Public License v3.0 license </a>of the project.</p>
<p>A copy of the custom layer is listed below for completeness. Copy it and paste it into a new and separate file in your current working directory called ‘<em>attention_decoder.py</em>‘.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669de933824032" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
import tensorflow as tf
from keras import backend as K
from keras import regularizers, constraints, initializers, activations
from keras.layers.recurrent import Recurrent, _time_distributed_dense
from keras.engine import InputSpec

tfPrint = lambda d, T: tf.Print(input_=T, data=[T, tf.shape(T)], message=d)

class AttentionDecoder(Recurrent):

    def __init__(self, units, output_dim,
                 activation='tanh',
                 return_probabilities=False,
                 name='AttentionDecoder',
                 kernel_initializer='glorot_uniform',
                 recurrent_initializer='orthogonal',
                 bias_initializer='zeros',
                 kernel_regularizer=None,
                 bias_regularizer=None,
                 activity_regularizer=None,
                 kernel_constraint=None,
                 bias_constraint=None,
                 **kwargs):
        """
        Implements an AttentionDecoder that takes in a sequence encoded by an
        encoder and outputs the decoded states
        :param units: dimension of the hidden state and the attention matrices
        :param output_dim: the number of labels in the output space

        references:
            Bahdanau, Dzmitry, Kyunghyun Cho, and Yoshua Bengio.
            "Neural machine translation by jointly learning to align and translate."
            arXiv preprint arXiv:1409.0473 (2014).
        """
        self.units = units
        self.output_dim = output_dim
        self.return_probabilities = return_probabilities
        self.activation = activations.get(activation)
        self.kernel_initializer = initializers.get(kernel_initializer)
        self.recurrent_initializer = initializers.get(recurrent_initializer)
        self.bias_initializer = initializers.get(bias_initializer)

        self.kernel_regularizer = regularizers.get(kernel_regularizer)
        self.recurrent_regularizer = regularizers.get(kernel_regularizer)
        self.bias_regularizer = regularizers.get(bias_regularizer)
        self.activity_regularizer = regularizers.get(activity_regularizer)

        self.kernel_constraint = constraints.get(kernel_constraint)
        self.recurrent_constraint = constraints.get(kernel_constraint)
        self.bias_constraint = constraints.get(bias_constraint)

        super(AttentionDecoder, self).__init__(**kwargs)
        self.name = name
        self.return_sequences = True  # must return sequences

    def build(self, input_shape):
        """
          See Appendix 2 of Bahdanau 2014, arXiv:1409.0473
          for model details that correspond to the matrices here.
        """

        self.batch_size, self.timesteps, self.input_dim = input_shape

        if self.stateful:
            super(AttentionDecoder, self).reset_states()

        self.states = [None, None]  # y, s

        """
            Matrices for creating the context vector
        """

        self.V_a = self.add_weight(shape=(self.units,),
                                   name='V_a',
                                   initializer=self.kernel_initializer,
                                   regularizer=self.kernel_regularizer,
                                   constraint=self.kernel_constraint)
        self.W_a = self.add_weight(shape=(self.units, self.units),
                                   name='W_a',
                                   initializer=self.kernel_initializer,
                                   regularizer=self.kernel_regularizer,
                                   constraint=self.kernel_constraint)
        self.U_a = self.add_weight(shape=(self.input_dim, self.units),
                                   name='U_a',
                                   initializer=self.kernel_initializer,
                                   regularizer=self.kernel_regularizer,
                                   constraint=self.kernel_constraint)
        self.b_a = self.add_weight(shape=(self.units,),
                                   name='b_a',
                                   initializer=self.bias_initializer,
                                   regularizer=self.bias_regularizer,
                                   constraint=self.bias_constraint)
        """
            Matrices for the r (reset) gate
        """
        self.C_r = self.add_weight(shape=(self.input_dim, self.units),
                                   name='C_r',
                                   initializer=self.recurrent_initializer,
                                   regularizer=self.recurrent_regularizer,
                                   constraint=self.recurrent_constraint)
        self.U_r = self.add_weight(shape=(self.units, self.units),
                                   name='U_r',
                                   initializer=self.recurrent_initializer,
                                   regularizer=self.recurrent_regularizer,
                                   constraint=self.recurrent_constraint)
        self.W_r = self.add_weight(shape=(self.output_dim, self.units),
                                   name='W_r',
                                   initializer=self.recurrent_initializer,
                                   regularizer=self.recurrent_regularizer,
                                   constraint=self.recurrent_constraint)
        self.b_r = self.add_weight(shape=(self.units, ),
                                   name='b_r',
                                   initializer=self.bias_initializer,
                                   regularizer=self.bias_regularizer,
                                   constraint=self.bias_constraint)

        """
            Matrices for the z (update) gate
        """
        self.C_z = self.add_weight(shape=(self.input_dim, self.units),
                                   name='C_z',
                                   initializer=self.recurrent_initializer,
                                   regularizer=self.recurrent_regularizer,
                                   constraint=self.recurrent_constraint)
        self.U_z = self.add_weight(shape=(self.units, self.units),
                                   name='U_z',
                                   initializer=self.recurrent_initializer,
                                   regularizer=self.recurrent_regularizer,
                                   constraint=self.recurrent_constraint)
        self.W_z = self.add_weight(shape=(self.output_dim, self.units),
                                   name='W_z',
                                   initializer=self.recurrent_initializer,
                                   regularizer=self.recurrent_regularizer,
                                   constraint=self.recurrent_constraint)
        self.b_z = self.add_weight(shape=(self.units, ),
                                   name='b_z',
                                   initializer=self.bias_initializer,
                                   regularizer=self.bias_regularizer,
                                   constraint=self.bias_constraint)
        """
            Matrices for the proposal
        """
        self.C_p = self.add_weight(shape=(self.input_dim, self.units),
                                   name='C_p',
                                   initializer=self.recurrent_initializer,
                                   regularizer=self.recurrent_regularizer,
                                   constraint=self.recurrent_constraint)
        self.U_p = self.add_weight(shape=(self.units, self.units),
                                   name='U_p',
                                   initializer=self.recurrent_initializer,
                                   regularizer=self.recurrent_regularizer,
                                   constraint=self.recurrent_constraint)
        self.W_p = self.add_weight(shape=(self.output_dim, self.units),
                                   name='W_p',
                                   initializer=self.recurrent_initializer,
                                   regularizer=self.recurrent_regularizer,
                                   constraint=self.recurrent_constraint)
        self.b_p = self.add_weight(shape=(self.units, ),
                                   name='b_p',
                                   initializer=self.bias_initializer,
                                   regularizer=self.bias_regularizer,
                                   constraint=self.bias_constraint)
        """
            Matrices for making the final prediction vector
        """
        self.C_o = self.add_weight(shape=(self.input_dim, self.output_dim),
                                   name='C_o',
                                   initializer=self.recurrent_initializer,
                                   regularizer=self.recurrent_regularizer,
                                   constraint=self.recurrent_constraint)
        self.U_o = self.add_weight(shape=(self.units, self.output_dim),
                                   name='U_o',
                                   initializer=self.recurrent_initializer,
                                   regularizer=self.recurrent_regularizer,
                                   constraint=self.recurrent_constraint)
        self.W_o = self.add_weight(shape=(self.output_dim, self.output_dim),
                                   name='W_o',
                                   initializer=self.recurrent_initializer,
                                   regularizer=self.recurrent_regularizer,
                                   constraint=self.recurrent_constraint)
        self.b_o = self.add_weight(shape=(self.output_dim, ),
                                   name='b_o',
                                   initializer=self.bias_initializer,
                                   regularizer=self.bias_regularizer,
                                   constraint=self.bias_constraint)

        # For creating the initial state:
        self.W_s = self.add_weight(shape=(self.input_dim, self.units),
                                   name='W_s',
                                   initializer=self.recurrent_initializer,
                                   regularizer=self.recurrent_regularizer,
                                   constraint=self.recurrent_constraint)

        self.input_spec = [
            InputSpec(shape=(self.batch_size, self.timesteps, self.input_dim))]
        self.built = True

    def call(self, x):
        # store the whole sequence so we can "attend" to it at each timestep
        self.x_seq = x

        # apply the a dense layer over the time dimension of the sequence
        # do it here because it doesn't depend on any previous steps
        # thefore we can save computation time:
        self._uxpb = _time_distributed_dense(self.x_seq, self.U_a, b=self.b_a,
                                             input_dim=self.input_dim,
                                             timesteps=self.timesteps,
                                             output_dim=self.units)

        return super(AttentionDecoder, self).call(x)

    def get_initial_state(self, inputs):
        # apply the matrix on the first time step to get the initial s0.
        s0 = activations.tanh(K.dot(inputs[:, 0], self.W_s))

        # from keras.layers.recurrent to initialize a vector of (batchsize,
        # output_dim)
        y0 = K.zeros_like(inputs)  # (samples, timesteps, input_dims)
        y0 = K.sum(y0, axis=(1, 2))  # (samples, )
        y0 = K.expand_dims(y0)  # (samples, 1)
        y0 = K.tile(y0, [1, self.output_dim])

        return [y0, s0]

    def step(self, x, states):

        ytm, stm = states

        # repeat the hidden state to the length of the sequence
        _stm = K.repeat(stm, self.timesteps)

        # now multiplty the weight matrix with the repeated hidden state
        _Wxstm = K.dot(_stm, self.W_a)

        # calculate the attention probabilities
        # this relates how much other timesteps contributed to this one.
        et = K.dot(activations.tanh(_Wxstm + self._uxpb),
                   K.expand_dims(self.V_a))
        at = K.exp(et)
        at_sum = K.sum(at, axis=1)
        at_sum_repeated = K.repeat(at_sum, self.timesteps)
        at /= at_sum_repeated  # vector of size (batchsize, timesteps, 1)

        # calculate the context vector
        context = K.squeeze(K.batch_dot(at, self.x_seq, axes=1), axis=1)
        # ~~~&gt; calculate new hidden state
        # first calculate the "r" gate:

        rt = activations.sigmoid(
            K.dot(ytm, self.W_r)
            + K.dot(stm, self.U_r)
            + K.dot(context, self.C_r)
            + self.b_r)

        # now calculate the "z" gate
        zt = activations.sigmoid(
            K.dot(ytm, self.W_z)
            + K.dot(stm, self.U_z)
            + K.dot(context, self.C_z)
            + self.b_z)

        # calculate the proposal hidden state:
        s_tp = activations.tanh(
            K.dot(ytm, self.W_p)
            + K.dot((rt * stm), self.U_p)
            + K.dot(context, self.C_p)
            + self.b_p)

        # new hidden state:
        st = (1-zt)*stm + zt * s_tp

        yt = activations.softmax(
            K.dot(ytm, self.W_o)
            + K.dot(stm, self.U_o)
            + K.dot(context, self.C_o)
            + self.b_o)

        if self.return_probabilities:
            return at, [yt, st]
        else:
            return yt, [yt, st]

    def compute_output_shape(self, input_shape):
        """
            For Keras internal compatability checking
        """
        if self.return_probabilities:
            return (None, self.timesteps, self.timesteps)
        else:
            return (None, self.timesteps, self.output_dim)

    def get_config(self):
        """
            For rebuilding models on load time.
        """
        config = {
            'output_dim': self.output_dim,
            'units': self.units,
            'return_probabilities': self.return_probabilities
        }
        base_config = super(AttentionDecoder, self).get_config()
        return dict(list(base_config.items()) + list(config.items()))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669de933824032-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-2">2</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-4">4</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-6">6</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-8">8</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-10">10</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-12">12</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-14">14</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-16">16</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-18">18</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-20">20</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-22">22</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-24">24</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-26">26</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-28">28</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-30">30</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-32">32</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-34">34</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-36">36</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-38">38</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-40">40</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-42">42</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-44">44</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-46">46</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-48">48</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-50">50</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-52">52</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-54">54</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-56">56</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-58">58</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-60">60</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-62">62</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-64">64</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-66">66</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-68">68</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-70">70</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-72">72</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-74">74</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-76">76</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-78">78</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-80">80</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-82">82</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-84">84</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-86">86</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-88">88</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-90">90</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-92">92</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-94">94</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-96">96</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-98">98</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-100">100</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-102">102</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-104">104</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-106">106</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-108">108</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-110">110</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-112">112</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-114">114</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-116">116</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-118">118</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-120">120</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-122">122</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-124">124</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-126">126</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-128">128</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-130">130</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-131">131</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-132">132</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-133">133</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-134">134</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-135">135</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-136">136</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-137">137</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-138">138</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-139">139</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-140">140</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-141">141</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-142">142</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-143">143</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-144">144</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-145">145</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-146">146</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-147">147</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-148">148</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-149">149</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-150">150</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-151">151</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-152">152</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-153">153</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-154">154</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-155">155</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-156">156</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-157">157</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-158">158</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-159">159</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-160">160</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-161">161</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-162">162</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-163">163</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-164">164</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-165">165</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-166">166</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-167">167</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-168">168</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-169">169</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-170">170</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-171">171</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-172">172</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-173">173</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-174">174</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-175">175</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-176">176</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-177">177</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-178">178</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-179">179</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-180">180</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-181">181</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-182">182</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-183">183</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-184">184</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-185">185</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-186">186</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-187">187</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-188">188</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-189">189</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-190">190</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-191">191</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-192">192</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-193">193</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-194">194</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-195">195</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-196">196</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-197">197</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-198">198</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-199">199</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-200">200</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-201">201</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-202">202</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-203">203</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-204">204</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-205">205</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-206">206</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-207">207</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-208">208</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-209">209</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-210">210</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-211">211</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-212">212</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-213">213</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-214">214</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-215">215</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-216">216</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-217">217</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-218">218</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-219">219</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-220">220</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-221">221</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-222">222</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-223">223</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-224">224</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-225">225</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-226">226</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-227">227</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-228">228</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-229">229</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-230">230</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-231">231</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-232">232</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-233">233</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-234">234</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-235">235</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-236">236</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-237">237</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-238">238</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-239">239</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-240">240</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-241">241</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-242">242</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-243">243</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-244">244</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-245">245</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-246">246</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-247">247</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-248">248</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-249">249</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-250">250</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-251">251</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-252">252</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-253">253</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-254">254</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-255">255</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-256">256</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-257">257</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-258">258</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-259">259</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-260">260</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-261">261</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-262">262</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-263">263</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-264">264</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-265">265</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-266">266</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-267">267</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-268">268</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-269">269</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-270">270</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-271">271</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-272">272</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-273">273</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-274">274</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-275">275</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-276">276</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-277">277</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-278">278</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-279">279</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-280">280</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-281">281</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-282">282</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-283">283</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-284">284</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-285">285</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-286">286</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-287">287</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-288">288</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-289">289</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-290">290</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-291">291</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-292">292</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-293">293</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-294">294</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-295">295</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-296">296</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-297">297</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-298">298</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-299">299</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-300">300</div><div class="crayon-num" data-line="crayon-5a659134669de933824032-301">301</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669de933824032-302">302</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669de933824032-1"><span class="crayon-e">import </span><span class="crayon-e">tensorflow </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-e">tf</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-2"><span class="crayon-e">from </span><span class="crayon-e">keras </span><span class="crayon-e">import </span><span class="crayon-e">backend </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-i">K</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-3"><span class="crayon-e">from </span><span class="crayon-e">keras </span><span class="crayon-e">import </span><span class="crayon-v">regularizers</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">constraints</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">initializers</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">activations</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-4"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-v">layers</span><span class="crayon-sy">.</span><span class="crayon-e">recurrent </span><span class="crayon-e">import </span><span class="crayon-v">Recurrent</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">_time_distributed_dense</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">engine </span><span class="crayon-e">import </span><span class="crayon-e">InputSpec</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-6"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-7"><span class="crayon-v">tfPrint</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">lambda</span><span class="crayon-h"> </span><span class="crayon-v">d</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">T</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">tf</span><span class="crayon-sy">.</span><span class="crayon-e">Print</span><span class="crayon-sy">(</span><span class="crayon-v">input_</span><span class="crayon-o">=</span><span class="crayon-v">T</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">data</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-v">T</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">tf</span><span class="crayon-sy">.</span><span class="crayon-e">shape</span><span class="crayon-sy">(</span><span class="crayon-v">T</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">message</span><span class="crayon-o">=</span><span class="crayon-v">d</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-8"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-9"><span class="crayon-t">class</span><span class="crayon-h"> </span><span class="crayon-e">AttentionDecoder</span><span class="crayon-sy">(</span><span class="crayon-v">Recurrent</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-10"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-11"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">__init__</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">units</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">output_dim</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-12"><span class="crayon-h">                 </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'tanh'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-13"><span class="crayon-h">                 </span><span class="crayon-v">return_probabilities</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-14"><span class="crayon-h">                 </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'AttentionDecoder'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-15"><span class="crayon-h">                 </span><span class="crayon-v">kernel_initializer</span><span class="crayon-o">=</span><span class="crayon-s">'glorot_uniform'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-16"><span class="crayon-h">                 </span><span class="crayon-v">recurrent_initializer</span><span class="crayon-o">=</span><span class="crayon-s">'orthogonal'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-17"><span class="crayon-h">                 </span><span class="crayon-v">bias_initializer</span><span class="crayon-o">=</span><span class="crayon-s">'zeros'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-18"><span class="crayon-h">                 </span><span class="crayon-v">kernel_regularizer</span><span class="crayon-o">=</span><span class="crayon-v">None</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-19"><span class="crayon-h">                 </span><span class="crayon-v">bias_regularizer</span><span class="crayon-o">=</span><span class="crayon-v">None</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-20"><span class="crayon-h">                 </span><span class="crayon-v">activity_regularizer</span><span class="crayon-o">=</span><span class="crayon-v">None</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-21"><span class="crayon-h">                 </span><span class="crayon-v">kernel_constraint</span><span class="crayon-o">=</span><span class="crayon-v">None</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-22"><span class="crayon-h">                 </span><span class="crayon-v">bias_constraint</span><span class="crayon-o">=</span><span class="crayon-v">None</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-23"><span class="crayon-h">                 </span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-v">kwargs</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-24"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-25"><span class="crayon-s">        Implements an AttentionDecoder that takes in a sequence encoded by an</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-26"><span class="crayon-s">        encoder and outputs the decoded states</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-27"><span class="crayon-s">        :param units: dimension of the hidden state and the attention matrices</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-28"><span class="crayon-s">        :param output_dim: the number of labels in the output space</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-29"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-30"><span class="crayon-s">        references:</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-31"><span class="crayon-s">            Bahdanau, Dzmitry, Kyunghyun Cho, and Yoshua Bengio.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-32"><span class="crayon-s">            "</span><span class="crayon-e">Neural </span><span class="crayon-e">machine </span><span class="crayon-e">translation </span><span class="crayon-e">by </span><span class="crayon-e">jointly </span><span class="crayon-e">learning </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-e">align </span><span class="crayon-st">and</span><span class="crayon-h"> </span><span class="crayon-v">translate</span><span class="crayon-sy">.</span><span class="crayon-s">"</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-33"><span class="crayon-s">            arXiv preprint arXiv:1409.0473 (2014).</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-34"><span class="crayon-s">        "</span><span class="crayon-s">""</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-35"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">units</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-36"><span class="crayon-e">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">output_dim</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">output_dim</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-37"><span class="crayon-e">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">return_probabilities</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">return_probabilities</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-38"><span class="crayon-e">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">activation</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">activations</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">activation</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-39"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">kernel_initializer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">initializers</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">kernel_initializer</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-40"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">initializers</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-41"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_initializer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">initializers</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">bias_initializer</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-42"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-43"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">kernel_regularizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">regularizers</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">kernel_regularizer</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-44"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">regularizers</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">kernel_regularizer</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-45"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_regularizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">regularizers</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">bias_regularizer</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-46"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">activity_regularizer</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">regularizers</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">activity_regularizer</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-47"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-48"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">kernel_constraint</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">constraints</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">kernel_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-49"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_constraint</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">constraints</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">kernel_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-50"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_constraint</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">constraints</span><span class="crayon-sy">.</span><span class="crayon-e">get</span><span class="crayon-sy">(</span><span class="crayon-v">bias_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-51"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-52"><span class="crayon-h">        </span><span class="crayon-r">super</span><span class="crayon-sy">(</span><span class="crayon-v">AttentionDecoder</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">__init__</span><span class="crayon-sy">(</span><span class="crayon-o">*</span><span class="crayon-o">*</span><span class="crayon-v">kwargs</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-53"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">name</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-54"><span class="crayon-e">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">return_sequences</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">True</span><span class="crayon-h">  </span><span class="crayon-p"># must return sequences</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-55"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-56"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">build</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-57"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-58"><span class="crayon-s">          See Appendix 2 of Bahdanau 2014, arXiv:1409.0473</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-59"><span class="crayon-s">          for model details that correspond to the matrices here.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-60"><span class="crayon-s">        "</span><span class="crayon-s">""</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-61"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-62"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">input_dim</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">input_shape</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-63"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-64"><span class="crayon-e">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">stateful</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-65"><span class="crayon-h">            </span><span class="crayon-r">super</span><span class="crayon-sy">(</span><span class="crayon-v">AttentionDecoder</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">reset_states</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-66"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-67"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">states</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">None</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">None</span><span class="crayon-sy">]</span><span class="crayon-h">  </span><span class="crayon-p"># y, s</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-68"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-69"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-70"><span class="crayon-s">            Matrices for creating the context vector</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-71"><span class="crayon-s">        "</span><span class="crayon-s">""</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-72"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-73"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">V_a</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-74"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'V_a'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-75"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">kernel_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-76"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">kernel_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-77"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">kernel_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-78"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">W_a</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-79"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'W_a'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-80"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">kernel_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-81"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">kernel_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-82"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">kernel_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-83"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">U_a</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">input_dim</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-84"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'U_a'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-85"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">kernel_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-86"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">kernel_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-87"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">kernel_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-88"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">b_a</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">,</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-89"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'b_a'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-90"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-91"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-92"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-93"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-94"><span class="crayon-s">            Matrices for the r (reset) gate</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-95"><span class="crayon-s">        "</span><span class="crayon-s">""</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-96"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">C_r</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">input_dim</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-97"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'C_r'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-98"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-99"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-100"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-101"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">U_r</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-102"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'U_r'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-103"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-104"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-105"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-106"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">W_r</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">output_dim</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-107"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'W_r'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-108"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-109"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-110"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-111"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">b_r</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-112"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'b_r'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-113"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-114"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-115"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-116"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-117"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-118"><span class="crayon-s">            Matrices for the z (update) gate</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-119"><span class="crayon-s">        "</span><span class="crayon-s">""</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-120"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">C_z</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">input_dim</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-121"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'C_z'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-122"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-123"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-124"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-125"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">U_z</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-126"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'U_z'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-127"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-128"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-129"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-130"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">W_z</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">output_dim</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-131"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'W_z'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-132"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-133"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-134"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-135"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">b_z</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-136"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'b_z'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-137"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-138"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-139"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-140"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-141"><span class="crayon-s">            Matrices for the proposal</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-142"><span class="crayon-s">        "</span><span class="crayon-s">""</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-143"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">C_p</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">input_dim</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-144"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'C_p'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-145"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-146"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-147"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-148"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">U_p</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-149"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'U_p'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-150"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-151"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-152"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-153"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">W_p</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">output_dim</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-154"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'W_p'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-155"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-156"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-157"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-158"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">b_p</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-159"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'b_p'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-160"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-161"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-162"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-163"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-164"><span class="crayon-s">            Matrices for making the final prediction vector</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-165"><span class="crayon-s">        "</span><span class="crayon-s">""</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-166"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">C_o</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">input_dim</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">output_dim</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-167"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'C_o'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-168"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-169"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-170"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-171"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">U_o</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">output_dim</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-172"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'U_o'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-173"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-174"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-175"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-176"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">W_o</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">output_dim</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">output_dim</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-177"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'W_o'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-178"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-179"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-180"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-181"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">b_o</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">output_dim</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-182"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'b_o'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-183"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-184"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-185"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">bias_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-186"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-187"><span class="crayon-h">        </span><span class="crayon-p"># For creating the initial state:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-188"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">W_s</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-e">add_weight</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">input_dim</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-189"><span class="crayon-h">                                   </span><span class="crayon-v">name</span><span class="crayon-o">=</span><span class="crayon-s">'W_s'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-190"><span class="crayon-h">                                   </span><span class="crayon-v">initializer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_initializer</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-191"><span class="crayon-h">                                   </span><span class="crayon-v">regularizer</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-192"><span class="crayon-h">                                   </span><span class="crayon-v">constraint</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">recurrent_constraint</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-193"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-194"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">input_spec</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-195"><span class="crayon-h">            </span><span class="crayon-e">InputSpec</span><span class="crayon-sy">(</span><span class="crayon-v">shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">input_dim</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-196"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">built</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">True</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-197"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-198"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">call</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-199"><span class="crayon-h">        </span><span class="crayon-p"># store the whole sequence so we can "attend" to it at each timestep</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-200"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">x_seq</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">x</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-201"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-202"><span class="crayon-h">        </span><span class="crayon-p"># apply the a dense layer over the time dimension of the sequence</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-203"><span class="crayon-h">        </span><span class="crayon-p"># do it here because it doesn't depend on any previous steps</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-204"><span class="crayon-h">        </span><span class="crayon-p"># thefore we can save computation time:</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-205"><span class="crayon-h">        </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">_uxpb</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">_time_distributed_dense</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">x_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">U_a</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">b</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">b_a</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-206"><span class="crayon-h">                                             </span><span class="crayon-v">input_dim</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">input_dim</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-207"><span class="crayon-h">                                             </span><span class="crayon-v">timesteps</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">timesteps</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-208"><span class="crayon-h">                                             </span><span class="crayon-v">output_dim</span><span class="crayon-o">=</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-209"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-210"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-r">super</span><span class="crayon-sy">(</span><span class="crayon-v">AttentionDecoder</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">call</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-211"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-212"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">get_initial_state</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">inputs</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-213"><span class="crayon-h">        </span><span class="crayon-p"># apply the matrix on the first time step to get the initial s0.</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-214"><span class="crayon-h">        </span><span class="crayon-v">s0</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">activations</span><span class="crayon-sy">.</span><span class="crayon-e">tanh</span><span class="crayon-sy">(</span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">W_s</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-215"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-216"><span class="crayon-h">        </span><span class="crayon-p"># from keras.layers.recurrent to initialize a vector of (batchsize,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-217"><span class="crayon-h">        </span><span class="crayon-p"># output_dim)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-218"><span class="crayon-h">        </span><span class="crayon-v">y0</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">zeros_like</span><span class="crayon-sy">(</span><span class="crayon-v">inputs</span><span class="crayon-sy">)</span><span class="crayon-h">  </span><span class="crayon-p"># (samples, timesteps, input_dims)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-219"><span class="crayon-h">        </span><span class="crayon-v">y0</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">sum</span><span class="crayon-sy">(</span><span class="crayon-v">y0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">axis</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">2</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h">  </span><span class="crayon-p"># (samples, )</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-220"><span class="crayon-h">        </span><span class="crayon-v">y0</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">expand_dims</span><span class="crayon-sy">(</span><span class="crayon-v">y0</span><span class="crayon-sy">)</span><span class="crayon-h">  </span><span class="crayon-p"># (samples, 1)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-221"><span class="crayon-h">        </span><span class="crayon-v">y0</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">tile</span><span class="crayon-sy">(</span><span class="crayon-v">y0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">output_dim</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-222"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-223"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">y0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">s0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-224"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-225"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">step</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">states</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-226"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-227"><span class="crayon-h">        </span><span class="crayon-v">ytm</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">stm</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">states</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-228"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-229"><span class="crayon-h">        </span><span class="crayon-p"># repeat the hidden state to the length of the sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-230"><span class="crayon-h">        </span><span class="crayon-v">_stm</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">repeat</span><span class="crayon-sy">(</span><span class="crayon-v">stm</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">timesteps</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-231"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-232"><span class="crayon-h">        </span><span class="crayon-p"># now multiplty the weight matrix with the repeated hidden state</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-233"><span class="crayon-h">        </span><span class="crayon-v">_Wxstm</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-v">_stm</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">W_a</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-234"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-235"><span class="crayon-h">        </span><span class="crayon-p"># calculate the attention probabilities</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-236"><span class="crayon-h">        </span><span class="crayon-p"># this relates how much other timesteps contributed to this one.</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-237"><span class="crayon-h">        </span><span class="crayon-v">et</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-v">activations</span><span class="crayon-sy">.</span><span class="crayon-e">tanh</span><span class="crayon-sy">(</span><span class="crayon-v">_Wxstm</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">_uxpb</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-238"><span class="crayon-h">                   </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">expand_dims</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">V_a</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-239"><span class="crayon-h">        </span><span class="crayon-v">at</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">exp</span><span class="crayon-sy">(</span><span class="crayon-v">et</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-240"><span class="crayon-h">        </span><span class="crayon-v">at_sum</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">sum</span><span class="crayon-sy">(</span><span class="crayon-v">at</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">axis</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-241"><span class="crayon-h">        </span><span class="crayon-v">at_sum_repeated</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">repeat</span><span class="crayon-sy">(</span><span class="crayon-v">at_sum</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">timesteps</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-242"><span class="crayon-h">        </span><span class="crayon-v">at</span><span class="crayon-h"> </span><span class="crayon-o">/=</span><span class="crayon-h"> </span><span class="crayon-v">at_sum_repeated</span><span class="crayon-h">  </span><span class="crayon-p"># vector of size (batchsize, timesteps, 1)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-243"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-244"><span class="crayon-h">        </span><span class="crayon-p"># calculate the context vector</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-245"><span class="crayon-h">        </span><span class="crayon-v">context</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">squeeze</span><span class="crayon-sy">(</span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">batch_dot</span><span class="crayon-sy">(</span><span class="crayon-v">at</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">x_seq</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">axes</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">axis</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-246"><span class="crayon-h">        </span><span class="crayon-p"># ~~~&gt; calculate new hidden state</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-247"><span class="crayon-h">        </span><span class="crayon-p"># first calculate the "r" gate:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-248"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-249"><span class="crayon-h">        </span><span class="crayon-v">rt</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">activations</span><span class="crayon-sy">.</span><span class="crayon-e">sigmoid</span><span class="crayon-sy">(</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-250"><span class="crayon-h">            </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-v">ytm</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">W_r</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-251"><span class="crayon-h">            </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-v">stm</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">U_r</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-252"><span class="crayon-h">            </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-v">context</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">C_r</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-253"><span class="crayon-h">            </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">b_r</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-254"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-255"><span class="crayon-h">        </span><span class="crayon-p"># now calculate the "z" gate</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-256"><span class="crayon-h">        </span><span class="crayon-v">zt</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">activations</span><span class="crayon-sy">.</span><span class="crayon-e">sigmoid</span><span class="crayon-sy">(</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-257"><span class="crayon-h">            </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-v">ytm</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">W_z</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-258"><span class="crayon-h">            </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-v">stm</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">U_z</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-259"><span class="crayon-h">            </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-v">context</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">C_z</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-260"><span class="crayon-h">            </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">b_z</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-261"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-262"><span class="crayon-h">        </span><span class="crayon-p"># calculate the proposal hidden state:</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-263"><span class="crayon-h">        </span><span class="crayon-v">s_tp</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">activations</span><span class="crayon-sy">.</span><span class="crayon-e">tanh</span><span class="crayon-sy">(</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-264"><span class="crayon-h">            </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-v">ytm</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">W_p</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-265"><span class="crayon-h">            </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-e ">rt *</span><span class="crayon-h"> </span><span class="crayon-v">stm</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">U_p</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-266"><span class="crayon-h">            </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-v">context</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">C_p</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-267"><span class="crayon-h">            </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">b_p</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-268"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-269"><span class="crayon-h">        </span><span class="crayon-p"># new hidden state:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-270"><span class="crayon-h">        </span><span class="crayon-v">st</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-o">-</span><span class="crayon-v">zt</span><span class="crayon-sy">)</span><span class="crayon-o">*</span><span class="crayon-v">stm</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e ">zt *</span><span class="crayon-h"> </span><span class="crayon-e">s_tp</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-271"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-272"><span class="crayon-e">        </span><span class="crayon-v">yt</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">activations</span><span class="crayon-sy">.</span><span class="crayon-e">softmax</span><span class="crayon-sy">(</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-273"><span class="crayon-h">            </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-v">ytm</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">W_o</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-274"><span class="crayon-h">            </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-v">stm</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">U_o</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-275"><span class="crayon-h">            </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">K</span><span class="crayon-sy">.</span><span class="crayon-e">dot</span><span class="crayon-sy">(</span><span class="crayon-v">context</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">C_o</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-276"><span class="crayon-h">            </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">b_o</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-277"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-278"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">return_probabilities</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-279"><span class="crayon-h">            </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">at</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">yt</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">st</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-280"><span class="crayon-h">        </span><span class="crayon-st">else</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-281"><span class="crayon-h">            </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">yt</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">yt</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">st</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-282"> </div><div class="crayon-line" id="crayon-5a659134669de933824032-283"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">compute_output_shape</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-284"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-285"><span class="crayon-s">            For Keras internal compatability checking</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-286"><span class="crayon-s">        "</span><span class="crayon-s">""</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-287"><span class="crayon-h">        </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">return_probabilities</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-288"><span class="crayon-h">            </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">None</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">timesteps</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-289"><span class="crayon-h">        </span><span class="crayon-st">else</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-290"><span class="crayon-h">            </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">None</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">timesteps</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">output_dim</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-291"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-292"><span class="crayon-h">    </span><span class="crayon-e">def </span><span class="crayon-e">get_config</span><span class="crayon-sy">(</span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-293"><span class="crayon-h">        </span><span class="crayon-s">""</span><span class="crayon-s">"</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-294"><span class="crayon-s">            For rebuilding models on load time.</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-295"><span class="crayon-s">        "</span><span class="crayon-s">""</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-296"><span class="crayon-h">        </span><span class="crayon-v">config</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-297"><span class="crayon-h">            </span><span class="crayon-s">'output_dim'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">output_dim</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-298"><span class="crayon-h">            </span><span class="crayon-s">'units'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">units</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-299"><span class="crayon-h">            </span><span class="crayon-s">'return_probabilities'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">.</span><span class="crayon-v">return</span><span class="crayon-sy">_</span>probabilities</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-300"><span class="crayon-h">        </span><span class="crayon-sy">}</span></div><div class="crayon-line" id="crayon-5a659134669de933824032-301"><span class="crayon-h">        </span><span class="crayon-v">base_config</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-r">super</span><span class="crayon-sy">(</span><span class="crayon-v">AttentionDecoder</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-r">self</span><span class="crayon-sy">)</span><span class="crayon-sy">.</span><span class="crayon-e">get_config</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669de933824032-302"><span class="crayon-h">        </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">dict</span><span class="crayon-sy">(</span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">base_config</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-v">config</span><span class="crayon-sy">.</span><span class="crayon-e">items</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0283 seconds] -->
<p>We can make use of this custom layer in our projects by importing it as follows:</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669e8508122784" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from attention_decoder import AttentionDecoder</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669e8508122784-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669e8508122784-1"><span class="crayon-e">from </span><span class="crayon-e">attention_decoder </span><span class="crayon-e">import </span><span class="crayon-v">AttentionDecoder</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0002 seconds] -->
<p>The layer implements attention as described by Bahdanau, et al. in their paper “<a href="https://arxiv.org/abs/1409.0473">Neural Machine Translation by Jointly Learning to Align and Translate</a>.”</p>
<p>The code is explained well in the original post and linked to both the LSTM and attention equations.</p>
<p>A limitation of this implementation is that it must output sequences that are the same length as the input sequences, the specific limitation that the encoder-decoder architecture was designed to overcome.</p>
<p>Importantly, the new layer manages both the repeating of the decoding as performed by the second LSTM, as well as the softmax output for the model as was performed by the Dense output layer in the encoder-decoder model without attention. This greatly simplifies the code for the model.</p>
<p>It is important to note that the custom layer is built upon the <a href="https://github.com/fchollet/keras/blob/master/keras/legacy/layers.py#L762">Recurrent</a> layer in Keras, which, at the time of writing, is marked as legacy code, and presumably will be removed from the project at some point.</p>
<h2>Encoder-Decoder With Attention</h2>
<p>Now that we have an implementation of attention that we can use, we can develop an encoder-decoder model with attention for our contrived sequence prediction problem.</p>
<p>The model with the attention layer is defined below. We can see that the layer handles some of the machinery of the encoder-decoder model itself, making defining the model simpler.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669f2703352265" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define model
model = Sequential()
model.add(LSTM(150, input_shape=(n_timesteps_in, n_features), return_sequences=True))
model.add(AttentionDecoder(150, n_features))
model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['acc'])</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669f2703352265-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f2703352265-2">2</div><div class="crayon-num" data-line="crayon-5a659134669f2703352265-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f2703352265-4">4</div><div class="crayon-num" data-line="crayon-5a659134669f2703352265-5">5</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669f2703352265-1"><span class="crayon-p"># define model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f2703352265-2"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669f2703352265-3"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f2703352265-4"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">AttentionDecoder</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669f2703352265-5"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'acc'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0009 seconds] -->
<p>That’s it. The rest of the example is the same.</p>
<p>The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669f5447739766" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from random import randint
from numpy import array
from numpy import argmax
from numpy import array_equal
from keras.models import Sequential
from keras.layers import LSTM
from attention_decoder import AttentionDecoder

# generate a sequence of random integers
def generate_sequence(length, n_unique):
	return [randint(0, n_unique-1) for _ in range(length)]

# one hot encode sequence
def one_hot_encode(sequence, n_unique):
	encoding = list()
	for value in sequence:
		vector = [0 for _ in range(n_unique)]
		vector[value] = 1
		encoding.append(vector)
	return array(encoding)

# decode a one hot encoded string
def one_hot_decode(encoded_seq):
	return [argmax(vector) for vector in encoded_seq]

# prepare data for the LSTM
def get_pair(n_in, n_out, cardinality):
	# generate random sequence
	sequence_in = generate_sequence(n_in, cardinality)
	sequence_out = sequence_in[:n_out] + [0 for _ in range(n_in-n_out)]
	# one hot encode
	X = one_hot_encode(sequence_in, cardinality)
	y = one_hot_encode(sequence_out, cardinality)
	# reshape as 3D
	X = X.reshape((1, X.shape[0], X.shape[1]))
	y = y.reshape((1, y.shape[0], y.shape[1]))
	return X,y

# configure problem
n_features = 50
n_timesteps_in = 5
n_timesteps_out = 2

# define model
model = Sequential()
model.add(LSTM(150, input_shape=(n_timesteps_in, n_features), return_sequences=True))
model.add(AttentionDecoder(150, n_features))
model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['acc'])
# train LSTM
for epoch in range(5000):
	# generate new random sequence
	X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features)
	# fit model for one epoch on this sequence
	model.fit(X, y, epochs=1, verbose=2)
# evaluate LSTM
total, correct = 100, 0
for _ in range(total):
	X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features)
	yhat = model.predict(X, verbose=0)
	if array_equal(one_hot_decode(y[0]), one_hot_decode(yhat[0])):
		correct += 1
print('Accuracy: %.2f%%' % (float(correct)/float(total)*100.0))
# spot check some examples
for _ in range(10):
	X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features)
	yhat = model.predict(X, verbose=0)
	print('Expected:', one_hot_decode(y[0]), 'Predicted', one_hot_decode(yhat[0]))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669f5447739766-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-2">2</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-4">4</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-6">6</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-8">8</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-10">10</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-12">12</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-14">14</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-16">16</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-18">18</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-20">20</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-22">22</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-24">24</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-26">26</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-28">28</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-30">30</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-32">32</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-34">34</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-36">36</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-38">38</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-40">40</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-42">42</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-44">44</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-46">46</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-48">48</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-50">50</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-52">52</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-54">54</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-56">56</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-58">58</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-60">60</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-62">62</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-64">64</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669f5447739766-66">66</div><div class="crayon-num" data-line="crayon-5a659134669f5447739766-67">67</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669f5447739766-1"><span class="crayon-e">from </span><span class="crayon-e">random </span><span class="crayon-e">import </span><span class="crayon-e">randint</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-2"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-3"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">argmax</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-4"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">array_equal</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Sequential</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-6"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">LSTM</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-7"><span class="crayon-e">from </span><span class="crayon-e">attention_decoder </span><span class="crayon-e">import </span><span class="crayon-v">AttentionDecoder</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-8"> </div><div class="crayon-line" id="crayon-5a659134669f5447739766-9"><span class="crayon-p"># generate a sequence of random integers</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-10"><span class="crayon-e">def </span><span class="crayon-e">generate_sequence</span><span class="crayon-sy">(</span><span class="crayon-v">length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-11"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">randint</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">length</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-12"> </div><div class="crayon-line" id="crayon-5a659134669f5447739766-13"><span class="crayon-p"># one hot encode sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-14"><span class="crayon-e">def </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-15"><span class="crayon-h"> </span><span class="crayon-v">encoding</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-16"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">value </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-17"><span class="crayon-h"> </span><span class="crayon-v">vector</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-18"><span class="crayon-h"> </span><span class="crayon-v">vector</span><span class="crayon-sy">[</span><span class="crayon-v">value</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-19"><span class="crayon-h"> </span><span class="crayon-v">encoding</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">vector</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-20"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">encoding</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-21"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-22"><span class="crayon-p"># decode a one hot encoded string</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-23"><span class="crayon-e">def </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">encoded_seq</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-24"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">argmax</span><span class="crayon-sy">(</span><span class="crayon-v">vector</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">vector </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">encoded_seq</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-25"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-26"><span class="crayon-p"># prepare data for the LSTM</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-27"><span class="crayon-e">def </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cardinality</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-28"><span class="crayon-h"> </span><span class="crayon-p"># generate random sequence</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-29"><span class="crayon-h"> </span><span class="crayon-v">sequence_in</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_sequence</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cardinality</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-30"><span class="crayon-h"> </span><span class="crayon-v">sequence_out</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sequence_in</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">n_out</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-o">-</span><span class="crayon-v">n_out</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-31"><span class="crayon-h"> </span><span class="crayon-p"># one hot encode</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-32"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cardinality</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-33"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cardinality</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-34"><span class="crayon-h"> </span><span class="crayon-p"># reshape as 3D</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-35"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-36"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-37"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-38"> </div><div class="crayon-line" id="crayon-5a659134669f5447739766-39"><span class="crayon-p"># configure problem</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-40"><span class="crayon-v">n_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">50</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-41"><span class="crayon-v">n_timesteps_in</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">5</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-42"><span class="crayon-v">n_timesteps_out</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-43"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-44"><span class="crayon-p"># define model</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-45"><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-46"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-47"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">AttentionDecoder</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-48"><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'acc'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-49"><span class="crayon-p"># train LSTM</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-50"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">epoch </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">5000</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-51"><span class="crayon-h"> </span><span class="crayon-p"># generate new random sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-52"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-53"><span class="crayon-h"> </span><span class="crayon-p"># fit model for one epoch on this sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-54"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">2</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-55"><span class="crayon-p"># evaluate LSTM</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-56"><span class="crayon-v">total</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">correct</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-57"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">total</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-58"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-59"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-60"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">array_equal</span><span class="crayon-sy">(</span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-61"><span class="crayon-h"> </span><span class="crayon-v">correct</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-62"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Accuracy: %.2f%%'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-t">float</span><span class="crayon-sy">(</span><span class="crayon-v">correct</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-t">float</span><span class="crayon-sy">(</span><span class="crayon-v">total</span><span class="crayon-sy">)</span><span class="crayon-o">*</span><span class="crayon-cn">100.0</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-63"><span class="crayon-p"># spot check some examples</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-64"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">10</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-65"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669f5447739766-66"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669f5447739766-67"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Expected:'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'Predicted'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0075 seconds] -->
<p>Running the example prints the skill of the model on 100 randomly generated input-output pairs. With the same resources and same amount of training, the model with attention performs much better.</p>
<p>Your results may vary given the stochastic nature of neural networks. Try running the example a few times.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669f9276231762" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Accuracy: 95.00%</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669f9276231762-1">1</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669f9276231762-1">Accuracy: 95.00%</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>Spot-checking some sample outputs and predicted sequences, we can see very few errors, even in cases when there is a zero value in the first two elements.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669fb943428788" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Expected: [48, 47, 0, 0, 0] Predicted [48, 47, 0, 0, 0]
Expected: [7, 46, 0, 0, 0] Predicted [7, 46, 0, 0, 0]
Expected: [32, 30, 0, 0, 0] Predicted [32, 2, 0, 0, 0]
Expected: [3, 25, 0, 0, 0] Predicted [3, 25, 0, 0, 0]
Expected: [45, 4, 0, 0, 0] Predicted [45, 4, 0, 0, 0]
Expected: [49, 9, 0, 0, 0] Predicted [49, 9, 0, 0, 0]
Expected: [22, 23, 0, 0, 0] Predicted [22, 23, 0, 0, 0]
Expected: [29, 36, 0, 0, 0] Predicted [29, 36, 0, 0, 0]
Expected: [0, 29, 0, 0, 0] Predicted [0, 29, 0, 0, 0]
Expected: [11, 26, 0, 0, 0] Predicted [11, 26, 0, 0, 0]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669fb943428788-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669fb943428788-2">2</div><div class="crayon-num" data-line="crayon-5a659134669fb943428788-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669fb943428788-4">4</div><div class="crayon-num" data-line="crayon-5a659134669fb943428788-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669fb943428788-6">6</div><div class="crayon-num" data-line="crayon-5a659134669fb943428788-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669fb943428788-8">8</div><div class="crayon-num" data-line="crayon-5a659134669fb943428788-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669fb943428788-10">10</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669fb943428788-1">Expected: [48, 47, 0, 0, 0] Predicted [48, 47, 0, 0, 0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669fb943428788-2">Expected: [7, 46, 0, 0, 0] Predicted [7, 46, 0, 0, 0]</div><div class="crayon-line" id="crayon-5a659134669fb943428788-3">Expected: [32, 30, 0, 0, 0] Predicted [32, 2, 0, 0, 0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669fb943428788-4">Expected: [3, 25, 0, 0, 0] Predicted [3, 25, 0, 0, 0]</div><div class="crayon-line" id="crayon-5a659134669fb943428788-5">Expected: [45, 4, 0, 0, 0] Predicted [45, 4, 0, 0, 0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669fb943428788-6">Expected: [49, 9, 0, 0, 0] Predicted [49, 9, 0, 0, 0]</div><div class="crayon-line" id="crayon-5a659134669fb943428788-7">Expected: [22, 23, 0, 0, 0] Predicted [22, 23, 0, 0, 0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669fb943428788-8">Expected: [29, 36, 0, 0, 0] Predicted [29, 36, 0, 0, 0]</div><div class="crayon-line" id="crayon-5a659134669fb943428788-9">Expected: [0, 29, 0, 0, 0] Predicted [0, 29, 0, 0, 0]</div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669fb943428788-10">Expected: [11, 26, 0, 0, 0] Predicted [11, 26, 0, 0, 0]</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p></p>
<h2>Comparison of Models</h2>
<p>Although we are getting better results from the model with attention, the results were reported from a single run of each model.</p>
<p>In this case, we seek a more robust finding by repeating the evaluation of each model multiple times and reporting the average performance over those runs. For more information on this robust approach to evaluating neural network models, see the post:</p>
<ul>
<li><a href="https://machinelearningmastery.com/evaluate-skill-deep-learning-models/">How to Evaluate the Skill of Deep Learning Models</a></li>
</ul>
<p>We can define a function to create each type of model, as follows.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a659134669ff294572089" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# define the encoder-decoder model
def baseline_model(n_timesteps_in, n_features):
	model = Sequential()
	model.add(LSTM(150, input_shape=(n_timesteps_in, n_features)))
	model.add(RepeatVector(n_timesteps_in))
	model.add(LSTM(150, return_sequences=True))
	model.add(TimeDistributed(Dense(n_features, activation='softmax')))
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['acc'])
	return model

# define the encoder-decoder with attention model
def attention_model(n_timesteps_in, n_features):
	model = Sequential()
	model.add(LSTM(150, input_shape=(n_timesteps_in, n_features), return_sequences=True))
	model.add(AttentionDecoder(150, n_features))
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['acc'])
	return model</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a659134669ff294572089-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669ff294572089-2">2</div><div class="crayon-num" data-line="crayon-5a659134669ff294572089-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669ff294572089-4">4</div><div class="crayon-num" data-line="crayon-5a659134669ff294572089-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669ff294572089-6">6</div><div class="crayon-num" data-line="crayon-5a659134669ff294572089-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669ff294572089-8">8</div><div class="crayon-num" data-line="crayon-5a659134669ff294572089-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669ff294572089-10">10</div><div class="crayon-num" data-line="crayon-5a659134669ff294572089-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669ff294572089-12">12</div><div class="crayon-num" data-line="crayon-5a659134669ff294572089-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669ff294572089-14">14</div><div class="crayon-num" data-line="crayon-5a659134669ff294572089-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a659134669ff294572089-16">16</div><div class="crayon-num" data-line="crayon-5a659134669ff294572089-17">17</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a659134669ff294572089-1"><span class="crayon-p"># define the encoder-decoder model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669ff294572089-2"><span class="crayon-e">def </span><span class="crayon-e">baseline_model</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669ff294572089-3"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669ff294572089-4"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669ff294572089-5"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669ff294572089-6"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669ff294572089-7"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">n_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669ff294572089-8"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'acc'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669ff294572089-9"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669ff294572089-10"> </div><div class="crayon-line" id="crayon-5a659134669ff294572089-11"><span class="crayon-p"># define the encoder-decoder with attention model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669ff294572089-12"><span class="crayon-e">def </span><span class="crayon-e">attention_model</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a659134669ff294572089-13"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669ff294572089-14"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669ff294572089-15"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">AttentionDecoder</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a659134669ff294572089-16"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'acc'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a659134669ff294572089-17"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0025 seconds] -->
<p>We can then define a function to fit and evaluate the accuracy of a fit model and return the accuracy score.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a65913466a02446447244" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# train and evaluate a model, return accuracy
def train_evaluate_model(model, n_timesteps_in, n_timesteps_out, n_features):
	# train LSTM
	for epoch in range(5000):
		# generate new random sequence
		X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features)
		# fit model for one epoch on this sequence
		model.fit(X, y, epochs=1, verbose=0)
	# evaluate LSTM
	total, correct = 100, 0
	for _ in range(total):
		X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features)
		yhat = model.predict(X, verbose=0)
		if array_equal(one_hot_decode(y[0]), one_hot_decode(yhat[0])):
			correct += 1
	return float(correct)/float(total)*100.0</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a65913466a02446447244-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a02446447244-2">2</div><div class="crayon-num" data-line="crayon-5a65913466a02446447244-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a02446447244-4">4</div><div class="crayon-num" data-line="crayon-5a65913466a02446447244-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a02446447244-6">6</div><div class="crayon-num" data-line="crayon-5a65913466a02446447244-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a02446447244-8">8</div><div class="crayon-num" data-line="crayon-5a65913466a02446447244-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a02446447244-10">10</div><div class="crayon-num" data-line="crayon-5a65913466a02446447244-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a02446447244-12">12</div><div class="crayon-num" data-line="crayon-5a65913466a02446447244-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a02446447244-14">14</div><div class="crayon-num" data-line="crayon-5a65913466a02446447244-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a02446447244-16">16</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a65913466a02446447244-1"><span class="crayon-p"># train and evaluate a model, return accuracy</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a02446447244-2"><span class="crayon-e">def </span><span class="crayon-e">train_evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65913466a02446447244-3"><span class="crayon-h"> </span><span class="crayon-p"># train LSTM</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a02446447244-4"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">epoch </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">5000</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65913466a02446447244-5"><span class="crayon-h"> </span><span class="crayon-p"># generate new random sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a02446447244-6"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a02446447244-7"><span class="crayon-h"> </span><span class="crayon-p"># fit model for one epoch on this sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a02446447244-8"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a02446447244-9"><span class="crayon-h"> </span><span class="crayon-p"># evaluate LSTM</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a02446447244-10"><span class="crayon-h"> </span><span class="crayon-v">total</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">correct</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line" id="crayon-5a65913466a02446447244-11"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">total</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a02446447244-12"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a02446447244-13"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a02446447244-14"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">array_equal</span><span class="crayon-sy">(</span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65913466a02446447244-15"><span class="crayon-h"> </span><span class="crayon-v">correct</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a02446447244-16"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">float</span><span class="crayon-sy">(</span><span class="crayon-v">correct</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-t">float</span><span class="crayon-sy">(</span><span class="crayon-v">total</span><span class="crayon-sy">)</span><span class="crayon-o">*</span><span class="crayon-cn">100.0</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0021 seconds] -->
<p>Putting this together, we can repeat the process of creating, training, and evaluating each type of model multiple times and reporting the mean accuracy over the repeats. To keep running times down, we will repeat each model evaluation 10 times, although if you have the resources, you could increase this to 30 or 100 times.</p>
<p>The complete example is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a65913466a05711453859" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from random import randint
from numpy import array
from numpy import argmax
from numpy import array_equal
from keras.models import Sequential
from keras.layers import LSTM
from keras.layers import Dense
from keras.layers import TimeDistributed
from keras.layers import RepeatVector
from attention_decoder import AttentionDecoder

# generate a sequence of random integers
def generate_sequence(length, n_unique):
	return [randint(0, n_unique-1) for _ in range(length)]

# one hot encode sequence
def one_hot_encode(sequence, n_unique):
	encoding = list()
	for value in sequence:
		vector = [0 for _ in range(n_unique)]
		vector[value] = 1
		encoding.append(vector)
	return array(encoding)

# decode a one hot encoded string
def one_hot_decode(encoded_seq):
	return [argmax(vector) for vector in encoded_seq]

# prepare data for the LSTM
def get_pair(n_in, n_out, cardinality):
	# generate random sequence
	sequence_in = generate_sequence(n_in, cardinality)
	sequence_out = sequence_in[:n_out] + [0 for _ in range(n_in-n_out)]
	# one hot encode
	X = one_hot_encode(sequence_in, cardinality)
	y = one_hot_encode(sequence_out, cardinality)
	# reshape as 3D
	X = X.reshape((1, X.shape[0], X.shape[1]))
	y = y.reshape((1, y.shape[0], y.shape[1]))
	return X,y

# define the encoder-decoder model
def baseline_model(n_timesteps_in, n_features):
	model = Sequential()
	model.add(LSTM(150, input_shape=(n_timesteps_in, n_features)))
	model.add(RepeatVector(n_timesteps_in))
	model.add(LSTM(150, return_sequences=True))
	model.add(TimeDistributed(Dense(n_features, activation='softmax')))
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['acc'])
	return model

# define the encoder-decoder with attention model
def attention_model(n_timesteps_in, n_features):
	model = Sequential()
	model.add(LSTM(150, input_shape=(n_timesteps_in, n_features), return_sequences=True))
	model.add(AttentionDecoder(150, n_features))
	model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['acc'])
	return model

# train and evaluate a model, return accuracy
def train_evaluate_model(model, n_timesteps_in, n_timesteps_out, n_features):
	# train LSTM
	for epoch in range(5000):
		# generate new random sequence
		X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features)
		# fit model for one epoch on this sequence
		model.fit(X, y, epochs=1, verbose=0)
	# evaluate LSTM
	total, correct = 100, 0
	for _ in range(total):
		X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features)
		yhat = model.predict(X, verbose=0)
		if array_equal(one_hot_decode(y[0]), one_hot_decode(yhat[0])):
			correct += 1
	return float(correct)/float(total)*100.0

# configure problem
n_features = 50
n_timesteps_in = 5
n_timesteps_out = 2
n_repeats = 10
# evaluate encoder-decoder model
print('Encoder-Decoder Model')
results = list()
for _ in range(n_repeats):
	model = baseline_model(n_timesteps_in, n_features)
	accuracy = train_evaluate_model(model, n_timesteps_in, n_timesteps_out, n_features)
	results.append(accuracy)
	print(accuracy)
print('Mean Accuracy: %.2f%%' % (sum(results)/float(n_repeats)))
# evaluate encoder-decoder with attention model
print('Encoder-Decoder With Attention Model')
results = list()
for _ in range(n_repeats):
	model = attention_model(n_timesteps_in, n_features)
	accuracy = train_evaluate_model(model, n_timesteps_in, n_timesteps_out, n_features)
	results.append(accuracy)
	print(accuracy)
print('Mean Accuracy: %.2f%%' % (sum(results)/float(n_repeats)))</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a65913466a05711453859-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-2">2</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-4">4</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-6">6</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-8">8</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-10">10</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-12">12</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-14">14</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-16">16</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-18">18</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-20">20</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-22">22</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-24">24</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-26">26</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-28">28</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-30">30</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-32">32</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-34">34</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-36">36</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-38">38</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-40">40</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-42">42</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-44">44</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-46">46</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-48">48</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-50">50</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-52">52</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-54">54</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-56">56</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-58">58</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-60">60</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-62">62</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-64">64</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-66">66</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-68">68</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-70">70</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-72">72</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-74">74</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-76">76</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-78">78</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-80">80</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-82">82</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-84">84</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-86">86</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-88">88</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-90">90</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-92">92</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-94">94</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-96">96</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a05711453859-98">98</div><div class="crayon-num" data-line="crayon-5a65913466a05711453859-99">99</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a65913466a05711453859-1"><span class="crayon-e">from </span><span class="crayon-e">random </span><span class="crayon-e">import </span><span class="crayon-e">randint</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-2"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-t">array</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-3"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">argmax</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-4"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-e">array_equal</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-5"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Sequential</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-6"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">LSTM</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-7"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dense</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">TimeDistributed</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">RepeatVector</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-10"><span class="crayon-e">from </span><span class="crayon-e">attention_decoder </span><span class="crayon-e">import </span><span class="crayon-v">AttentionDecoder</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-11"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-12"><span class="crayon-p"># generate a sequence of random integers</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-13"><span class="crayon-e">def </span><span class="crayon-e">generate_sequence</span><span class="crayon-sy">(</span><span class="crayon-v">length</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-14"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">randint</span><span class="crayon-sy">(</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">length</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-15"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-16"><span class="crayon-p"># one hot encode sequence</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-17"><span class="crayon-e">def </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-18"><span class="crayon-h"> </span><span class="crayon-v">encoding</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-19"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">value </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">sequence</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-20"><span class="crayon-h"> </span><span class="crayon-v">vector</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_unique</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-21"><span class="crayon-h"> </span><span class="crayon-v">vector</span><span class="crayon-sy">[</span><span class="crayon-v">value</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-22"><span class="crayon-h"> </span><span class="crayon-v">encoding</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">vector</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-23"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">encoding</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-24"> </div><div class="crayon-line" id="crayon-5a65913466a05711453859-25"><span class="crayon-p"># decode a one hot encoded string</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-26"><span class="crayon-e">def </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">encoded_seq</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-27"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">argmax</span><span class="crayon-sy">(</span><span class="crayon-v">vector</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">vector </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">encoded_seq</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-28"> </div><div class="crayon-line" id="crayon-5a65913466a05711453859-29"><span class="crayon-p"># prepare data for the LSTM</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-30"><span class="crayon-e">def </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cardinality</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-31"><span class="crayon-h"> </span><span class="crayon-p"># generate random sequence</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-32"><span class="crayon-h"> </span><span class="crayon-v">sequence_in</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">generate_sequence</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cardinality</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-33"><span class="crayon-h"> </span><span class="crayon-v">sequence_out</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">sequence_in</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-v">n_out</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_in</span><span class="crayon-o">-</span><span class="crayon-v">n_out</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-34"><span class="crayon-h"> </span><span class="crayon-p"># one hot encode</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-35"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cardinality</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-36"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_encode</span><span class="crayon-sy">(</span><span class="crayon-v">sequence_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">cardinality</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-37"><span class="crayon-h"> </span><span class="crayon-p"># reshape as 3D</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-38"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-39"><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-40"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-41"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-42"><span class="crayon-p"># define the encoder-decoder model</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-43"><span class="crayon-e">def </span><span class="crayon-e">baseline_model</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-44"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-45"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-46"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">RepeatVector</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-47"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-48"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">TimeDistributed</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-v">n_features</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">activation</span><span class="crayon-o">=</span><span class="crayon-s">'softmax'</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-49"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'acc'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-50"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-51"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-52"><span class="crayon-p"># define the encoder-decoder with attention model</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-53"><span class="crayon-e">def </span><span class="crayon-e">attention_model</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-54"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-55"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">return_sequences</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-56"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">AttentionDecoder</span><span class="crayon-sy">(</span><span class="crayon-cn">150</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-57"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'categorical_crossentropy'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">metrics</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-s">'acc'</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-58"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-59"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-60"><span class="crayon-p"># train and evaluate a model, return accuracy</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-61"><span class="crayon-e">def </span><span class="crayon-e">train_evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-62"><span class="crayon-h"> </span><span class="crayon-p"># train LSTM</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-63"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">epoch </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">5000</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-64"><span class="crayon-h"> </span><span class="crayon-p"># generate new random sequence</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-65"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-66"><span class="crayon-h"> </span><span class="crayon-p"># fit model for one epoch on this sequence</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-67"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-68"><span class="crayon-h"> </span><span class="crayon-p"># evaluate LSTM</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-69"><span class="crayon-h"> </span><span class="crayon-v">total</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">correct</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">100</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-70"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">total</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-71"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">get_pair</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-72"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-73"><span class="crayon-h"> </span><span class="crayon-st">if</span><span class="crayon-h"> </span><span class="crayon-e">array_equal</span><span class="crayon-sy">(</span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">y</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">one_hot_decode</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-74"><span class="crayon-h"> </span><span class="crayon-v">correct</span><span class="crayon-h"> </span><span class="crayon-o">+=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-75"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-t">float</span><span class="crayon-sy">(</span><span class="crayon-v">correct</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-t">float</span><span class="crayon-sy">(</span><span class="crayon-v">total</span><span class="crayon-sy">)</span><span class="crayon-o">*</span><span class="crayon-cn">100.0</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-76"> </div><div class="crayon-line" id="crayon-5a65913466a05711453859-77"><span class="crayon-p"># configure problem</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-78"><span class="crayon-v">n_features</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">50</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-79"><span class="crayon-v">n_timesteps_in</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">5</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-80"><span class="crayon-v">n_timesteps_out</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">2</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-81"><span class="crayon-v">n_repeats</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-82"><span class="crayon-p"># evaluate encoder-decoder model</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-83"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Encoder-Decoder Model'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-84"><span class="crayon-v">results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-85"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_repeats</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-86"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">baseline_model</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-87"><span class="crayon-h"> </span><span class="crayon-v">accuracy</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">train_evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-88"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">accuracy</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-89"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">accuracy</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-90"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Mean Accuracy: %.2f%%'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">sum</span><span class="crayon-sy">(</span><span class="crayon-v">results</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-t">float</span><span class="crayon-sy">(</span><span class="crayon-v">n_repeats</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-91"><span class="crayon-p"># evaluate encoder-decoder with attention model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-92"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Encoder-Decoder With Attention Model'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-93"><span class="crayon-v">results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-94"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">_</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_repeats</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-95"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">attention_model</span><span class="crayon-sy">(</span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-96"><span class="crayon-h"> </span><span class="crayon-v">accuracy</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">train_evaluate_model</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_in</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_timesteps_out</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_features</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-97"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">accuracy</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a05711453859-98"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">accuracy</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65913466a05711453859-99"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'Mean Accuracy: %.2f%%'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-e">sum</span><span class="crayon-sy">(</span><span class="crayon-v">results</span><span class="crayon-sy">)</span><span class="crayon-o">/</span><span class="crayon-t">float</span><span class="crayon-sy">(</span><span class="crayon-v">n_repeats</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0102 seconds] -->
<p>Running this example prints the accuracy for each model repeat to give you an idea of the progress of the run.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-mac print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a65913466a09973633313" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Encoder-Decoder Model
20.0
23.0
23.0
18.0
28.000000000000004
28.999999999999996
23.0
26.0
21.0
20.0
Mean Accuracy: 23.10%

Encoder-Decoder With Attention Model
98.0
91.0
94.0
93.0
96.0
99.0
97.0
94.0
99.0
96.0
Mean Accuracy: 95.70%</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a65913466a09973633313-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a09973633313-2">2</div><div class="crayon-num" data-line="crayon-5a65913466a09973633313-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a09973633313-4">4</div><div class="crayon-num" data-line="crayon-5a65913466a09973633313-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a09973633313-6">6</div><div class="crayon-num" data-line="crayon-5a65913466a09973633313-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a09973633313-8">8</div><div class="crayon-num" data-line="crayon-5a65913466a09973633313-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a09973633313-10">10</div><div class="crayon-num" data-line="crayon-5a65913466a09973633313-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a09973633313-12">12</div><div class="crayon-num" data-line="crayon-5a65913466a09973633313-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a09973633313-14">14</div><div class="crayon-num" data-line="crayon-5a65913466a09973633313-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a09973633313-16">16</div><div class="crayon-num" data-line="crayon-5a65913466a09973633313-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a09973633313-18">18</div><div class="crayon-num" data-line="crayon-5a65913466a09973633313-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a09973633313-20">20</div><div class="crayon-num" data-line="crayon-5a65913466a09973633313-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a09973633313-22">22</div><div class="crayon-num" data-line="crayon-5a65913466a09973633313-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65913466a09973633313-24">24</div><div class="crayon-num" data-line="crayon-5a65913466a09973633313-25">25</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a65913466a09973633313-1">Encoder-Decoder Model</div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a09973633313-2">20.0</div><div class="crayon-line" id="crayon-5a65913466a09973633313-3">23.0</div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a09973633313-4">23.0</div><div class="crayon-line" id="crayon-5a65913466a09973633313-5">18.0</div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a09973633313-6">28.000000000000004</div><div class="crayon-line" id="crayon-5a65913466a09973633313-7">28.999999999999996</div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a09973633313-8">23.0</div><div class="crayon-line" id="crayon-5a65913466a09973633313-9">26.0</div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a09973633313-10">21.0</div><div class="crayon-line" id="crayon-5a65913466a09973633313-11">20.0</div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a09973633313-12">Mean Accuracy: 23.10%</div><div class="crayon-line" id="crayon-5a65913466a09973633313-13"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a09973633313-14">Encoder-Decoder With Attention Model</div><div class="crayon-line" id="crayon-5a65913466a09973633313-15">98.0</div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a09973633313-16">91.0</div><div class="crayon-line" id="crayon-5a65913466a09973633313-17">94.0</div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a09973633313-18">93.0</div><div class="crayon-line" id="crayon-5a65913466a09973633313-19">96.0</div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a09973633313-20">99.0</div><div class="crayon-line" id="crayon-5a65913466a09973633313-21">97.0</div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a09973633313-22">94.0</div><div class="crayon-line" id="crayon-5a65913466a09973633313-23">99.0</div><div class="crayon-line crayon-striped-line" id="crayon-5a65913466a09973633313-24">96.0</div><div class="crayon-line" id="crayon-5a65913466a09973633313-25">Mean Accuracy: 95.70%</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>We can see that even averaged over 10 runs, the attention model still shows better performance than the encoder-decoder model without attention, 23.10% vs 95.70%.</p>
<p>A good extension to this evaluation would be to capture the model loss each epoch for each model, take the average, and compare how the loss changes over time for the architecture with and without attention. I expect that this trace would show attention achieving better skill much faster and sooner than the non-attentional model, further highlighting the benefit of the approach.</p>
<h2>Further Reading</h2>
<p>This section provides more resources on the topic if you are looking to go deeper.</p>
<ul>
<li><a href="https://machinelearningmastery.com/attention-long-short-term-memory-recurrent-neural-networks/">Attention in Long Short-Term Memory Recurrent Neural Networks</a></li>
<li><a href="https://machinelearningmastery.com/how-does-attention-work-in-encoder-decoder-recurrent-neural-networks/">How Does Attention Work in Encoder-Decoder Recurrent Neural Networks</a></li>
<li><a href="https://machinelearningmastery.com/encoder-decoder-long-short-term-memory-networks/">Encoder-Decoder Long Short-Term Memory Networks</a></li>
<li><a href="https://machinelearningmastery.com/evaluate-skill-deep-learning-models/">How to Evaluate the Skill of Deep Learning Models</a></li>
<li><a href="https://medium.com/datalogue/attention-in-keras-1892773a4f22">How to Visualize Your Recurrent Neural Network with Attention in Keras</a>, 2017.</li>
<li><a href="https://github.com/datalogue/keras-attention">keras-attention GitHub Project</a></li>
<li><a href="https://github.com/datalogue/keras-attention">Neural Machine Translation by Jointly Learning to Align and Translate</a>, 2015.</li>
</ul>
<h2>Summary</h2>
<p>In this tutorial, you discovered how to develop an encoder-decoder recurrent neural network with attention in Python with Keras.</p>
<p>Specifically, you learned:</p>
<ul>
<li>How to design a small and configurable problem to evaluate encoder-decoder recurrent neural networks with and without attention.</li>
<li>How to design and evaluate an encoder-decoder network with and without attention for the sequence prediction problem.</li>
<li>How to robustly compare the performance of encoder-decoder networks with and without attention.</li>
</ul>
<p>Do you have any questions?<br/>
Ask your questions in the comments below and I will do my best to answer.</p>
<div class="awac-wrapper"><div class="awac widget text-30"> <div class="textwidget"><div class="woo-sc-hr"></div>
<p></p><center>
<h2>Develop LSTMs for Sequence Prediction Today!</h2>
<p><a href="/lstms-with-python/"><img align="left" alt="Long Short-Term Memory Networks with Python" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/07/Cover-220.png" style="border: 0;"/></a></p>
<h4>Develop Your Own LSTM models in Minutes</h4>
<p>…with just a few lines of python code</p>
<p>Discover how in my new Ebook:<br/>
<a href="/lstms-with-python/">Long Short-Term Memory Networks with Python</a></p>
<p>It provides <strong>self-study tutorials</strong> on topics like:<br/>
<em>CNN LSTMs, Encoder-Decoder LSTMs, generative models, data preparation, making predictions</em> and much more…</p>
<h4>Finally Bring LSTM Recurrent Neural Networks to<br/>
Your Sequence Predictions Projects</h4>
<p>Skip the Academics. Just Results.</p>
<p><a href="/lstms-with-python/">Click to learn more</a>.<br/>
</p></center><br/>
<div class="woo-sc-hr"></div>
</div>
</div></div><div class="apss-social-share apss-theme-4 clearfix">
<div class="apss-twitter apss-single-icon">
<a href="javascript:void(0);" onclick="apss_open_in_popup_window(event, 'https://twitter.com/intent/tweet?text=How%20to%20Develop%20an%20Encoder-Decoder%20Model%20with%20Attention%20for%20Sequence-to-Sequence%20Prediction%20in%20Keras&amp;url=https%3A%2F%2Fmachinelearningmastery.com%2Fencoder-decoder-attention-sequence-to-sequence-prediction-keras%2F&amp;');" rel="nofollow" target="" title="Share on Twitter">
<div class="apss-icon-block clearfix">
<i class="fa fa-twitter"></i>
<span class="apss-social-text">Share on Twitter</span><span class="apss-share">Tweet</span>
</div>
</a>
</div>
<div class="apss-facebook apss-single-icon">
<a href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/" onclick="apss_open_in_popup_window(event, 'https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/');" rel="nofollow" target="" title="Share on Facebook">
<div class="apss-icon-block clearfix">
<i class="fa fa-facebook"></i>
<span class="apss-social-text">Share on Facebook</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-linkedin apss-single-icon">
<a href="http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Develop%20an%20Encoder-Decoder%20Model%20with%20Attention%20for%20Sequence-to-Sequence%20Prediction%20in%20Keras&amp;url=https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/&amp;summary=The+encoder-decoder+architecture+for+recurrent+neural+networks+is+proving+to+be+powerful+on+a+host+o..." onclick="apss_open_in_popup_window(event, 'http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Develop%20an%20Encoder-Decoder%20Model%20with%20Attention%20for%20Sequence-to-Sequence%20Prediction%20in%20Keras&amp;url=https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/&amp;summary=The+encoder-decoder+architecture+for+recurrent+neural+networks+is+proving+to+be+powerful+on+a+host+o...');" rel="nofollow" target="" title="Share on LinkedIn">
<div class="apss-icon-block clearfix"><i class="fa fa-linkedin"></i>
<span class="apss-social-text">Share on LinkedIn</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-google-plus apss-single-icon">
<a href="https://plus.google.com/share?url=https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/" onclick="apss_open_in_popup_window(event, 'https://plus.google.com/share?url=https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/');" rel="nofollow" target="" title="Share on Google Plus">
<div class="apss-icon-block clearfix">
<i class="fa fa-google-plus"></i>
<span class="apss-social-text">Share on Google Plus</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
</div> </section><!-- /.entry -->
<div class="fix"></div>
<aside id="post-author">
<div class="profile-image"><img alt="" class="avatar avatar-80 photo" height="80" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=160&amp;d=mm&amp;r=g 2x" width="80"/></div>
<div class="profile-content">
<h4>About Jason Brownlee</h4>
		Dr. Jason Brownlee is a husband, proud father, academic researcher, author, professional developer and a machine learning practitioner. He is dedicated to helping developers get started and get good at applied machine learning.
<a href="/about">Learn more</a>.				<div class="profile-link">
<a href="https://machinelearningmastery.com/author/jasonb/">
				View all posts by Jason Brownlee <span class="meta-nav">→</span> </a>
</div><!--#profile-link-->
</div>
<div class="fix"></div>
</aside>
<div class="post-utility"></div>
</article><!-- /.post -->
<div class="post-entries">
<div class="nav-prev fl"><a href="https://machinelearningmastery.com/prepare-movie-review-data-sentiment-analysis/" rel="prev"><i class="fa fa-angle-left"></i> How to Prepare Movie Review Data for Sentiment Analysis</a></div>
<div class="nav-next fr"><a href="https://machinelearningmastery.com/clean-text-machine-learning-python/" rel="next">How to Clean Text for Machine Learning with Python <i class="fa fa-angle-right"></i></a></div>
<div class="fix"></div>
</div>
<div id="comments"> <h3 id="comments-title">55 Responses to <em>How to Develop an Encoder-Decoder Model with Attention for Sequence-to-Sequence Prediction in Keras</em></h3>
<ol class="commentlist">
<li class="comment even thread-even depth-1" id="comment-416988">
<div class="comment-container" id="li-comment-416988">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/5f1923a192f166cd4dba85f49d136a15?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/5f1923a192f166cd4dba85f49d136a15?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Chetan</span>
<span class="date">October 17, 2017 at 6:11 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-416988" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The timing of this post couldn’t have been more accurate. I’ve spent hours and days on google looking for a reliable Keras implementation of attention. Can’t wait to test this on my specific problem definition. Thanks a ton Jason!</p>
<div class="reply">
<a aria-label="Reply to Chetan" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=416988#respond" onclick='return addComment.moveForm( "comment-416988", "416988", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-417014">
<div class="comment-container" id="li-comment-417014">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 17, 2017 at 4:03 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417014" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I’m glad to hear that Chetan!</p>
<p>Let me know how you go.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417014#respond" onclick='return addComment.moveForm( "comment-417014", "417014", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-417039">
<div class="comment-container" id="li-comment-417039">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/a5165801397d5e04c68e8361e15b0699?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/a5165801397d5e04c68e8361e15b0699?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">ChrisJew</span>
<span class="date">October 17, 2017 at 10:35 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417039" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>test soft</p>
<div class="reply">
<a aria-label="Reply to ChrisJew" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417039#respond" onclick='return addComment.moveForm( "comment-417039", "417039", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-417060">
<div class="comment-container" id="li-comment-417060">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 18, 2017 at 5:36 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417060" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Your test worked.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417060#respond" onclick='return addComment.moveForm( "comment-417060", "417060", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-417120">
<div class="comment-container" id="li-comment-417120">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/2ba198a1f6dc86d11c5fe930dd5bda71?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2ba198a1f6dc86d11c5fe930dd5bda71?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Mateo</span>
<span class="date">October 18, 2017 at 11:30 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417120" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thank you for this post! </p>
<p>Unfortunately the kernel crashes on my laptop! I don’t know why (no RAM issues)<br/>
I use Keras==2.0.8 and TF==1.3.0</p>
<div class="reply">
<a aria-label="Reply to Mateo" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417120#respond" onclick='return addComment.moveForm( "comment-417120", "417120", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-417141">
<div class="comment-container" id="li-comment-417141">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 19, 2017 at 5:37 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417141" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Ouch. Perhaps there is something up with your environment.</p>
<p>This post might help if you need to set things up from scratch:<br/>
<a href="http://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" rel="nofollow">http://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417141#respond" onclick='return addComment.moveForm( "comment-417141", "417141", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-417270">
<div class="comment-container" id="li-comment-417270">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/983d413a4b7399b2c6fb79054226f50a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/983d413a4b7399b2c6fb79054226f50a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ravi Annaswamy</span>
<span class="date">October 20, 2017 at 7:09 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417270" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Jason, very nice tutorial on probably the most important and most powerful neural application architecture (seq2seq with attention – since it is equivalent to a self programming turing machine – it sees an input stream of symbols, then can move back and forth using attention and write out a stream of symbols).</p>
<p>In fact theoretically it is super-turing, because it works with continuous (real) representation instead of Turing symbolic notation. google ‘recurrent networks super turing’ for proofs.</p>
<p>I am looking forward to attention being integrated into Keras and your revised code later, but no one can match your ability to setup the problem, generate data, explain step by step.. Keep up the great work.</p>
<p>Ravi Annaswamy</p>
<div class="reply">
<a aria-label="Reply to Ravi Annaswamy" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417270#respond" onclick='return addComment.moveForm( "comment-417270", "417270", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-417326">
<div class="comment-container" id="li-comment-417326">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 21, 2017 at 5:29 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417326" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks Ravi, I really appreciate your support! You made my day 🙂</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417326#respond" onclick='return addComment.moveForm( "comment-417326", "417326", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-417274">
<div class="comment-container" id="li-comment-417274">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/983d413a4b7399b2c6fb79054226f50a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/983d413a4b7399b2c6fb79054226f50a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ravi Annaswamy</span>
<span class="date">October 20, 2017 at 8:12 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417274" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Jason, I think in order to show the power of sequence mapping, we need to try two things:<br/>
1. The input sequence should be of variable length (not always 5). For example you can make it a length of 10 max, but it should generate sequences of any length between say 4 to 10 (remaining zeros).<br/>
2. The output should not be just zeroing of values, but more complex output for example, the first and last non zero value of the sequence…</p>
<div class="reply">
<a aria-label="Reply to Ravi Annaswamy" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417274#respond" onclick='return addComment.moveForm( "comment-417274", "417274", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-2" id="comment-417275">
<div class="comment-container" id="li-comment-417275">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/983d413a4b7399b2c6fb79054226f50a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/983d413a4b7399b2c6fb79054226f50a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ravi Annaswamy</span>
<span class="date">October 20, 2017 at 8:15 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417275" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>something like the example built here:<br/>
<a href="https://talbaumel.github.io/attention/" rel="nofollow">https://talbaumel.github.io/attention/</a></p>
<div class="reply">
<a aria-label="Reply to Ravi Annaswamy" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417275#respond" onclick='return addComment.moveForm( "comment-417275", "417275", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-417279">
<div class="comment-container" id="li-comment-417279">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/983d413a4b7399b2c6fb79054226f50a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/983d413a4b7399b2c6fb79054226f50a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ravi Annaswamy</span>
<span class="date">October 20, 2017 at 9:49 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417279" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I am working on a modification of your excellent code, to illustrate this extended task, will post shortly.</p>
<div class="reply">
<a aria-label="Reply to Ravi Annaswamy" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417279#respond" onclick='return addComment.moveForm( "comment-417279", "417279", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-417331">
<div class="comment-container" id="li-comment-417331">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 21, 2017 at 5:34 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417331" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes, you could easily modify the above example to achieve these requirements.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417331#respond" onclick='return addComment.moveForm( "comment-417331", "417331", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-417282">
<div class="comment-container" id="li-comment-417282">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/983d413a4b7399b2c6fb79054226f50a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/983d413a4b7399b2c6fb79054226f50a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Ravi Annaswamy</span>
<span class="date">October 20, 2017 at 10:25 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417282" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Dr.Jason,</p>
<p>You have done an excellent application and framework code.</p>
<p>I wanted to expose the great value of this architecture and modularity of<br/>
this code by attempting a harder problem. Harder in two ways:</p>
<p>First we want to make the input sequence variable length from example to example.</p>
<p>Second, we want the output to be one that requires attention and long term memory,<br/>
 across the length!</p>
<p>So we come up with this task:</p>
<p>Given a input sequence which is variable length with zero padding…<br/>
[6, 8, 7, 2, 2, 6, 6, 4, 0, 0]<br/>
I wanted the network to pick out and output the first and last non-zero of the series<br/>
[6, 4, 0, 0, 0, 0, 0, 0, 0, 0]</p>
<p>To make it even more interesting task for memory, we want it to output<br/>
the two numbers in reverse order:</p>
<p>input:<br/>
[6, 8, 7, 2, 2, 6, 6, 4, 0, 0]<br/>
output<br/>
[4, 6, 0, 0, 0, 0, 0, 0, 0, 0]</p>
<p>This would require that the algorithm figure out that we are selecting the first and last of the sequence,<br/>
and then writing out them in reverse order! It really needs some kind of a turing machine that can<br/>
go back and forth on the sequence and decide when to write what! Can the seq2seq with attention LSTM do this?<br/>
Let us try out.</p>
<p>Here are few more training cases created:<br/>
[5, 5, 3, 3, 2, 0, 0, 0, 0, 0] [2, 5, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[4, 7, 7, 4, 3, 9, 0, 0, 0, 0] [9, 4, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[2, 6, 7, 6, 5, 0, 0, 0, 0, 0] [5, 2, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[9, 8, 2, 8, 8, 7, 9, 1, 5, 0] [5, 9, 0, 0, 0, 0, 0, 0, 0, 0]</p>
<p>I made the following changes to your excellent code to make this possible:</p>
<p>1. In order to use 0 as the padding character, we make the unique letters from 1 to n_unique.</p>
<p># generate a sequence of random integers<br/>
def generate_sequence(length, n_unique):<br/>
	return [randint(0, n_unique-2)+1 for _ in range(length)]</p>
<p>I think in your original code also you should adopt the above mechanism so that 0 is reserved as padding<br/>
symbol and generated sequence only contains 1 to n_unique. I think this will increase accuracy to 100% in your tests too.</p>
<p>2. In order to simplify the domain, for faster training, I restricted the range of values:</p>
<p>n_features = 8<br/>
n_timesteps_in = 10<br/>
n_timesteps_out = 2</p>
<p>That is the input has a max of 10 positions but anywhere between 4 to 9 of these could be nonzero sequence, as shown below.<br/>
The input only uses an alphabet of 8 numbers instead of the 50 you used.</p>
<p>3. Correspondingly the get_pair was modified to generate the series above:</p>
<p># prepare data for the LSTM<br/>
def get_pair(n_in, n_out, cardinality, verbose=False): # edited this to add verbose flag<br/>
	# generate random sequence<br/>
	sequence_in = generate_sequence(n_in, cardinality)<br/>
	real_length = randint(4,n_in-1) # i added this<br/>
	sequence_in = sequence_in[:real_length] + [0 for _ in range(n_in-real_length)] # i added this<br/>
	sequence_out = [sequence_in[real_length-1]]+[sequence_in[0]] + [0 for _ in range(n_in-2)] # i edited this<br/>
	if verbose:  # added this for testing<br/>
		print(sequence_in,sequence_out) # added this<br/>
	# one hot encode<br/>
	X = one_hot_encode(sequence_in, cardinality)<br/>
	y = one_hot_encode(sequence_out, cardinality)<br/>
	# reshape as 3D<br/>
	X = X.reshape((1, X.shape[0], X.shape[1]))<br/>
	y = y.reshape((1, y.shape[0], y.shape[1]))<br/>
	return X,y</p>
<p>4. With these changes:<br/>
for _ in range(5):<br/>
    a=get_pair(10,2,10,verbose=True)</p>
<p>generates:</p>
<p>[6, 8, 7, 2, 2, 6, 6, 4, 0, 0] [4, 6, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[5, 5, 3, 3, 2, 0, 0, 0, 0, 0] [2, 5, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[4, 7, 7, 4, 3, 9, 0, 0, 0, 0] [9, 4, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[2, 6, 7, 6, 5, 0, 0, 0, 0, 0] [5, 2, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[9, 8, 2, 8, 8, 7, 9, 1, 5, 0] [5, 9, 0, 0, 0, 0, 0, 0, 0, 0]</p>
<p>5. Result of training on this dataset:<br/>
Encoder-Decoder Model<br/>
20.0<br/>
12.0<br/>
18.0<br/>
19.0<br/>
9.0<br/>
10.0<br/>
16.0<br/>
12.0<br/>
12.0<br/>
11.0</p>
<p>Encoder-Decoder With Attention Model<br/>
100.0<br/>
100.0<br/>
100.0<br/>
100.0<br/>
100.0<br/>
100.0<br/>
100.0<br/>
100.0<br/>
100.0<br/>
100.0</p>
<p>Yes!</p>
<p>This shows the capacity of recurrent neural models to learn arbitrary programs from example input and output pairs!<br/>
Of course, one can increase length of the sequence and also the n_unique to make the task harder, but I do not expect<br/>
dramatic failure as we gradually increase to reasonable values.</p>
<p>I am really very happy that you put together this excellent example. Please feel free to add this extension application to your excellent article/books if it will add value. Also please review the changes to make sure I have not made any errors.</p>
<p>The only complaint I have is that the keras implementation of attention is very slow. (I think the pytorch implementation will be<br/>
far faster because of avoiding a few layers of abstraction..but I may be wrong, will try it..)</p>
<p>Ravi</p>
<p>Attached the complete code for reproducibility:</p>
<p>from random import randint<br/>
from numpy import array<br/>
from numpy import argmax<br/>
from numpy import array_equal<br/>
from keras.models import Sequential<br/>
from keras.layers import LSTM<br/>
from keras.layers import Dense<br/>
from keras.layers import TimeDistributed<br/>
from keras.layers import RepeatVector<br/>
from attention_decoder import AttentionDecoder</p>
<p># generate a sequence of random integers<br/>
def generate_sequence(length, n_unique):<br/>
	return [randint(0, n_unique-2)+1 for _ in range(length)]</p>
<p># one hot encode sequence<br/>
def one_hot_encode(sequence, n_unique):<br/>
	encoding = list()<br/>
	for value in sequence:<br/>
		vector = [0 for _ in range(n_unique)]<br/>
		vector[value] = 1<br/>
		encoding.append(vector)<br/>
	return array(encoding)</p>
<p># decode a one hot encoded string<br/>
def one_hot_decode(encoded_seq):<br/>
	return [argmax(vector) for vector in encoded_seq]</p>
<p># prepare data for the LSTM<br/>
def get_pair(n_in, n_out, cardinality, verbose=False):<br/>
	# generate random sequence<br/>
	sequence_in = generate_sequence(n_in, cardinality)<br/>
	real_length = randint(4,n_in-1)<br/>
	sequence_in = sequence_in[:real_length] + [0 for _ in range(n_in-real_length)]<br/>
	sequence_out = [sequence_in[real_length-1]]+[sequence_in[0]] + [0 for _ in range(n_in-2)]<br/>
	if verbose:<br/>
		print(sequence_in,sequence_out)<br/>
	# one hot encode<br/>
	X = one_hot_encode(sequence_in, cardinality)<br/>
	y = one_hot_encode(sequence_out, cardinality)<br/>
	# reshape as 3D<br/>
	X = X.reshape((1, X.shape[0], X.shape[1]))<br/>
	y = y.reshape((1, y.shape[0], y.shape[1]))<br/>
	return X,y</p>
<p># define the encoder-decoder model<br/>
def baseline_model(n_timesteps_in, n_features):<br/>
	model = Sequential()<br/>
	model.add(LSTM(150, input_shape=(n_timesteps_in, n_features)))<br/>
	model.add(RepeatVector(n_timesteps_in))<br/>
	model.add(LSTM(150, return_sequences=True))<br/>
	model.add(TimeDistributed(Dense(n_features, activation=’softmax’)))<br/>
	model.compile(loss=’categorical_crossentropy’, optimizer=’adam’, metrics=[‘acc’])<br/>
	return model</p>
<p># define the encoder-decoder with attention model<br/>
def attention_model(n_timesteps_in, n_features):<br/>
	model = Sequential()<br/>
	model.add(LSTM(150, input_shape=(n_timesteps_in, n_features), return_sequences=True))<br/>
	model.add(AttentionDecoder(150, n_features))<br/>
	model.compile(loss=’categorical_crossentropy’, optimizer=’adam’, metrics=[‘acc’])<br/>
	return model</p>
<p># train and evaluate a model, return accuracy<br/>
def train_evaluate_model(model, n_timesteps_in, n_timesteps_out, n_features):<br/>
	# train LSTM<br/>
	for epoch in range(5000):<br/>
		# generate new random sequence<br/>
		X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features)<br/>
		# fit model for one epoch on this sequence<br/>
		model.fit(X, y, epochs=1, verbose=0)<br/>
	# evaluate LSTM<br/>
	total, correct = 100, 0<br/>
	for _ in range(total):<br/>
		X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features)<br/>
		yhat = model.predict(X, verbose=0)<br/>
		if array_equal(one_hot_decode(y[0]), one_hot_decode(yhat[0])):<br/>
			correct += 1<br/>
	return float(correct)/float(total)*100.0</p>
<p># configure problem<br/>
n_features = 8<br/>
n_timesteps_in = 10<br/>
n_timesteps_out = 2<br/>
n_repeats = 10</p>
<p># evaluate encoder-decoder model<br/>
print(‘Encoder-Decoder Model’)<br/>
results = list()<br/>
for _ in range(n_repeats):<br/>
	model = baseline_model(n_timesteps_in, n_features)<br/>
	accuracy = train_evaluate_model(model, n_timesteps_in, n_timesteps_out, n_features)<br/>
	results.append(accuracy)<br/>
	print(accuracy)<br/>
print(‘Mean Accuracy: %.2f%%’ % (sum(results)/float(n_repeats)))<br/>
# evaluate encoder-decoder with attention model<br/>
print(‘Encoder-Decoder With Attention Model’)<br/>
results = list()<br/>
for _ in range(n_repeats):<br/>
	model = attention_model(n_timesteps_in, n_features)<br/>
	accuracy = train_evaluate_model(model, n_timesteps_in, n_timesteps_out, n_features)<br/>
	results.append(accuracy)<br/>
	print(accuracy)<br/>
print(‘Mean Accuracy: %.2f%%’ % (sum(results)/float(n_repeats)))</p>
<div class="reply">
<a aria-label="Reply to Ravi Annaswamy" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417282#respond" onclick='return addComment.moveForm( "comment-417282", "417282", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-417335">
<div class="comment-container" id="li-comment-417335">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 21, 2017 at 5:38 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417335" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Great work!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417335#respond" onclick='return addComment.moveForm( "comment-417335", "417335", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-417283">
<div class="comment-container" id="li-comment-417283">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/983d413a4b7399b2c6fb79054226f50a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/983d413a4b7399b2c6fb79054226f50a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">ravi annaswamy</span>
<span class="date">October 20, 2017 at 10:44 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417283" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>here is verbose evaluation</p>
<p>for _ in range(5):<br/>
    X,y = get_pair(n_timesteps_in, n_timesteps_out, n_features,verbose=True)<br/>
    yhat = model.predict(X, verbose=0)<br/>
    print(one_hot_decode(yhat[0]))</p>
<p>[5, 5, 1, 6, 1, 4, 5, 0, 0, 0] [5, 5, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[5, 5, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[5, 5, 4, 7, 2, 1, 3, 0, 0, 0] [3, 5, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[3, 5, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[3, 4, 7, 6, 3, 1, 3, 1, 1, 0] [1, 3, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[1, 3, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[1, 4, 1, 4, 7, 2, 2, 3, 4, 0] [4, 1, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[4, 1, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[1, 5, 1, 4, 7, 6, 3, 7, 7, 0] [7, 1, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[7, 1, 0, 0, 0, 0, 0, 0, 0, 0]</p>
<div class="reply">
<a aria-label="Reply to ravi annaswamy" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417283#respond" onclick='return addComment.moveForm( "comment-417283", "417283", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-2" id="comment-417762">
<div class="comment-container" id="li-comment-417762">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/be992c5c2c4cb5cedb66b0e234d2db42?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/be992c5c2c4cb5cedb66b0e234d2db42?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Meeklai</span>
<span class="date">October 24, 2017 at 8:07 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417762" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Awesome work Ravi!</p>
<p>Would you please upload these codes into <a href="https://gist.github.com" rel="nofollow">https://gist.github.com</a>?</p>
<div class="reply">
<a aria-label="Reply to Meeklai" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417762#respond" onclick='return addComment.moveForm( "comment-417762", "417762", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-417295">
<div class="comment-container" id="li-comment-417295">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/be992c5c2c4cb5cedb66b0e234d2db42?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/be992c5c2c4cb5cedb66b0e234d2db42?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Meeklai</span>
<span class="date">October 21, 2017 at 2:57 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417295" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>First of all, thank you so much for this worth reading article. It clarified me a lot about how to implement autoencoder model in Keras.</p>
<p>I just have a little confused point that I wish you would explain. Why do you need to transform an original vector of integers into a 2D matrix containing a one hot vector of each integer? Can’t you just send that original vector of integers into the encoder as an input?</p>
<p>Thank you again for this worthful article, Dr. Brownlee</p>
<div class="reply">
<a aria-label="Reply to Meeklai" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417295#respond" onclick='return addComment.moveForm( "comment-417295", "417295", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-417343">
<div class="comment-container" id="li-comment-417343">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 21, 2017 at 5:43 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417343" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You can, but the one hot encoding is richer and often results in better model skill.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417343#respond" onclick='return addComment.moveForm( "comment-417343", "417343", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-417546">
<div class="comment-container" id="li-comment-417546">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/be992c5c2c4cb5cedb66b0e234d2db42?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/be992c5c2c4cb5cedb66b0e234d2db42?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Meeklai</span>
<span class="date">October 23, 2017 at 2:21 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417546" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thank you Dr. Brownlee, would one hot encoding is better for a situation that the number of cardinality is much greater than this example? Like fitting an encoder with lots of text documents, which will result in huge number of encoder’s keys</p>
<div class="reply">
<a aria-label="Reply to Meeklai" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417546#respond" onclick='return addComment.moveForm( "comment-417546", "417546", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-417573">
<div class="comment-container" id="li-comment-417573">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 23, 2017 at 5:49 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417573" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>In that case, it might be better to use a distributed representation like a word embedding:<br/>
<a href="https://machinelearningmastery.com/develop-word-embeddings-python-gensim/" rel="nofollow">https://machinelearningmastery.com/develop-word-embeddings-python-gensim/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417573#respond" onclick='return addComment.moveForm( "comment-417573", "417573", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-417760">
<div class="comment-container" id="li-comment-417760">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/4aac06ac6fc821ea5c6dd300a33a5367?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/4aac06ac6fc821ea5c6dd300a33a5367?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Hendrik</span>
<span class="date">October 24, 2017 at 7:00 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417760" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>In case of multiple LSTM layers, is the AttentionDecoder layer supposed to stay after all LSTMs only once or it must be inserted after each LSTM layert?</p>
<div class="reply">
<a aria-label="Reply to Hendrik" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417760#respond" onclick='return addComment.moveForm( "comment-417760", "417760", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-417825">
<div class="comment-container" id="li-comment-417825">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 25, 2017 at 6:44 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417825" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The attention is only used directly after the encoder.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417825#respond" onclick='return addComment.moveForm( "comment-417825", "417825", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-417848">
<div class="comment-container" id="li-comment-417848">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/236a49e0b91ead97e45054264dd38e80?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/236a49e0b91ead97e45054264dd38e80?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Trialcritic</span>
<span class="date">October 25, 2017 at 8:21 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417848" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Usually, when people have 5 input and 2 output steps, we use</p>
<p>model.add(LSTM(size, input_shape=(n_timesteps_in, n_features)))<br/>
model.add(RepeatVector(n_timesteps_out)) # this is different from input steps<br/>
model.add(LSTM(size, return_sequences=True))</p>
<p>This makes sense, as suggested </p>
<p>“we need to repeat the single vector outputted from the encoder network to obtain a sequence which has the same length with the output sequences”.</p>
<p>Wonder if this must be changed.</p>
<div class="reply">
<a aria-label="Reply to Trialcritic" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417848#respond" onclick='return addComment.moveForm( "comment-417848", "417848", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-417879">
<div class="comment-container" id="li-comment-417879">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">October 25, 2017 at 3:57 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-417879" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes, the RepeatVector approach is not a pure encoder-decoder as defined in the first papers, but often performs as well or better in my experience.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=417879#respond" onclick='return addComment.moveForm( "comment-417879", "417879", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-418907">
<div class="comment-container" id="li-comment-418907">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/f39ae554bc7b2f18107ef1ef0c98fb57?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/f39ae554bc7b2f18107ef1ef0c98fb57?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Aayushee</span>
<span class="date">November 3, 2017 at 8:17 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-418907" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>Thanks for such a well explained post on this topic. You mention the limitation that output sequences are the same length as the input sequences in case of the attention encoder decoder model used.<br/>
Could you please give an idea what should be done in an attention based model when output and input lengths are not same? I was wondering if we can use a RepeatVector(output_timesteps) in the current attention model on the encoder output and then feed it to the AttentionDecoder?</p>
<div class="reply">
<a aria-label="Reply to Aayushee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=418907#respond" onclick='return addComment.moveForm( "comment-418907", "418907", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-418950">
<div class="comment-container" id="li-comment-418950">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 4, 2017 at 5:29 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-418950" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>This implementation of attention cannot handle input and output sequences with different lengths, sorry.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=418950#respond" onclick='return addComment.moveForm( "comment-418950", "418950", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-419006">
<div class="comment-container" id="li-comment-419006">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/6cc0059e7264ec1a65e56a360de273ea?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/6cc0059e7264ec1a65e56a360de273ea?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">caichao</span>
<span class="date">November 4, 2017 at 11:43 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-419006" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>By running your example (the “with attention part”, I’ve gotten the following error:<br/>
ValueError: Dimensions must be equal, but are 150 and 50 for ‘AttentionDecoder/MatMul_4’ (op: ‘MatMul’) with input shapes: [?,150], [50,150].</p>
<div class="reply">
<a aria-label="Reply to caichao" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=419006#respond" onclick='return addComment.moveForm( "comment-419006", "419006", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-419036">
<div class="comment-container" id="li-comment-419036">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 5, 2017 at 5:16 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-419036" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Ensure you have the latest version of Keras.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=419036#respond" onclick='return addComment.moveForm( "comment-419036", "419036", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-419058">
<div class="comment-container" id="li-comment-419058">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/6cc0059e7264ec1a65e56a360de273ea?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/6cc0059e7264ec1a65e56a360de273ea?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">caichao</span>
<span class="date">November 5, 2017 at 11:51 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-419058" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>My keras version is 2.0.2</p>
<div class="reply">
<a aria-label="Reply to caichao" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=419058#respond" onclick='return addComment.moveForm( "comment-419058", "419058", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-419106">
<div class="comment-container" id="li-comment-419106">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 6, 2017 at 4:48 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-419106" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps try 2.0.8 or higher?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=419106#respond" onclick='return addComment.moveForm( "comment-419106", "419106", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-5" id="comment-419160">
<div class="comment-container" id="li-comment-419160">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/6cc0059e7264ec1a65e56a360de273ea?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/6cc0059e7264ec1a65e56a360de273ea?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">caichao</span>
<span class="date">November 6, 2017 at 11:47 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-419160" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>also when I upgrade keras to 2.0.9<br/>
I got the following problem</p>
<p>from keras.layers.recurrent import Recurrent, _time_distributed_dense<br/>
“unresolved reference _time_distributed_dense”</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-5" id="comment-419200">
<div class="comment-container" id="li-comment-419200">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 7, 2017 at 9:50 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-419200" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Interesting, perhaps the example requires Keras 2.0.8. This was the version I used when developing the example.</p>
<div class="reply">
</div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even depth-3" id="comment-419059">
<div class="comment-container" id="li-comment-419059">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/6cc0059e7264ec1a65e56a360de273ea?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/6cc0059e7264ec1a65e56a360de273ea?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">caichao</span>
<span class="date">November 5, 2017 at 12:08 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-419059" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>also when I upgrade keras to 2.0.9<br/>
I got the following problem</p>
<p>from keras.layers.recurrent import Recurrent, _time_distributed_dense<br/>
“unresolved reference _time_distributed_dense”</p>
<div class="reply">
<a aria-label="Reply to caichao" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=419059#respond" onclick='return addComment.moveForm( "comment-419059", "419059", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-419087">
<div class="comment-container" id="li-comment-419087">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/f0e23e514a28215a10f3a8b3ebd162aa?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/f0e23e514a28215a10f3a8b3ebd162aa?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">kamal</span>
<span class="date">November 6, 2017 at 12:54 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-419087" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason. thank you for your great tutorials. I have 2 questions:</p>
<p>1) is there any Dense layer after Decoder in Attention code?<br/>
2)should features input be equal to features output or not ( their length should be equal  as you mentioned)?</p>
<p>thank you, again</p>
<div class="reply">
<a aria-label="Reply to kamal" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=419087#respond" onclick='return addComment.moveForm( "comment-419087", "419087", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-419110">
<div class="comment-container" id="li-comment-419110">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 6, 2017 at 4:53 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-419110" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Yes, there is normally a dense output after the decoder (or a part of the decoder).</p>
<p>Features can vary. Normally/often you would have more input features than output features.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=419110#respond" onclick='return addComment.moveForm( "comment-419110", "419110", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-421598">
<div class="comment-container" id="li-comment-421598">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/915cae986938189d008b8322a0da043a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/915cae986938189d008b8322a0da043a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Nandini</span>
<span class="date">November 29, 2017 at 5:33 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-421598" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>from keras.models import Model,</p>
<p>How this Model() layer will works in keras?</p>
<div class="reply">
<a aria-label="Reply to Nandini" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=421598#respond" onclick='return addComment.moveForm( "comment-421598", "421598", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-421660">
<div class="comment-container" id="li-comment-421660">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 30, 2017 at 8:07 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-421660" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Great question, you can learn more in this post:<br/>
<a href="https://machinelearningmastery.com/keras-functional-api-deep-learning/" rel="nofollow">https://machinelearningmastery.com/keras-functional-api-deep-learning/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=421660#respond" onclick='return addComment.moveForm( "comment-421660", "421660", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-421745">
<div class="comment-container" id="li-comment-421745">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/f4270716c896093a88ecce0e6e9607f7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/f4270716c896093a88ecce0e6e9607f7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Basma</span>
<span class="date">November 30, 2017 at 9:57 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-421745" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>thank you so much for this great tutorial, I’m actually trying to build an encoder with attention, so the attention should be in the encoder part, can you explain please how this can be adapted ?</p>
<p>Many thanks 🙂</p>
<div class="reply">
<a aria-label="Reply to Basma" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=421745#respond" onclick='return addComment.moveForm( "comment-421745", "421745", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-421802">
<div class="comment-container" id="li-comment-421802">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 1, 2017 at 7:32 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-421802" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Generally, attention is in the decoder, not the encoder. Sorry, I don’t have an example of an encoder with attention.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=421802#respond" onclick='return addComment.moveForm( "comment-421802", "421802", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-422287">
<div class="comment-container" id="li-comment-422287">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/f4270716c896093a88ecce0e6e9607f7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/f4270716c896093a88ecce0e6e9607f7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Basma</span>
<span class="date">December 6, 2017 at 7:52 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-422287" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason, </p>
<p>i’m trying to use this great implementation for seq2seq to encode text. I have a dialogue turn from user A that I’ll decode to get dialogue turn from user B. I am using the following code</p>
<p>    seq2seq = Sequential()<br/>
    seq2seq.add(Embedding(output_dim=args.emb_dim,<br/>
                            input_dim=MAX_NB_WORDS,<br/>
                            input_length=MAX_SEQUENCE_LENGTH,<br/>
                            weights=[embedding_matrix],<br/>
                            mask_zero=True,<br/>
                            trainable=True))</p>
<p>    seq2seq.add(LSTM(units=args.hidden_size, return_sequences=True))<br/>
    seq2seq.add(AttentionDecoder(args.hidden_size, args.emb_dim))<br/>
    seq2seq.compile(loss=’categorical_crossentropy’, optimizer=’adam’, metrics=[‘acc’])</p>
<p>But actually I don’t know how I can compare the decoded vector to the turn vector that I already have. </p>
<p>My dialogue vectors are already encoded using keras preprocessing text_to_sequence and padded.</p>
<p>Many thanks !</p>
<div class="reply">
<a aria-label="Reply to Basma" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=422287#respond" onclick='return addComment.moveForm( "comment-422287", "422287", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-422348">
<div class="comment-container" id="li-comment-422348">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 7, 2017 at 7:53 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-422348" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I assume you are outputting a sequence of integers. These integers must be mapped back to words using whatever scheme you used to encode your training data.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=422348#respond" onclick='return addComment.moveForm( "comment-422348", "422348", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-425448">
<div class="comment-container" id="li-comment-425448">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/100f574e3c1c287e687cbbb91e8a7f1b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/100f574e3c1c287e687cbbb91e8a7f1b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Leo</span>
<span class="date">January 2, 2018 at 8:58 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-425448" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi, Jason</p>
<p>Thanks for this tutorial. I’m trying a word embedding seq2seq model. But I’m stuck with how to build the model.<br/>
I use tokenizer and pad_sequences to encode Xtrain and ytrain, and then processing ytrain through to_categorical.<br/>
The format of input fed into the model is just like the ones in this tutorial: 1 input of Xtrain and ytrain for each epoch.<br/>
And it seems there’s something wrong with the embedding layer. But I can’t figure out why.</p>
<p>model = Sequential()<br/>
model.add(Embedding(vocab_size, 150, input_length=max_length))<br/>
model.add(Bidirectional(LSTM(150, return_sequences=True)))<br/>
model.add(AttentionDecoder(150, n_features))<br/>
model.compile(loss=’categorical_crossentropy’, optimizer=’adam’, metrics=[‘acc’])</p>
<p>ValueError: Error when checking input: expected embedding_8_input to have shape (None, 148) but got array with shape (148, 1)</p>
<div class="reply">
<a aria-label="Reply to Leo" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=425448#respond" onclick='return addComment.moveForm( "comment-425448", "425448", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-2" id="comment-425451">
<div class="comment-container" id="li-comment-425451">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/100f574e3c1c287e687cbbb91e8a7f1b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/100f574e3c1c287e687cbbb91e8a7f1b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Leo</span>
<span class="date">January 2, 2018 at 9:35 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-425451" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sorry, I have another question. Can I just fit the model directly instead of using for loop to train the model for each epoch?<br/>
If I just fit the model directly, I got another error message:<br/>
Error when checking target: expected AttentionDecoder to have 3 dimensions, but got array with shape (200, 1321)</p>
<p>Thank you very much.</p>
<div class="reply">
<a aria-label="Reply to Leo" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=425451#respond" onclick='return addComment.moveForm( "comment-425451", "425451", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-3" id="comment-425480">
<div class="comment-container" id="li-comment-425480">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 3, 2018 at 5:36 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-425480" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You can, but you must change the shape of the data you are feeding to the network.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=425480#respond" onclick='return addComment.moveForm( "comment-425480", "425480", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-425478">
<div class="comment-container" id="li-comment-425478">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 3, 2018 at 5:34 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-425478" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>This post might help to get you started with embedding layers:<br/>
<a href="https://machinelearningmastery.com/use-word-embedding-layers-deep-learning-keras/" rel="nofollow">https://machinelearningmastery.com/use-word-embedding-layers-deep-learning-keras/</a></p>
<p>Remember to one hot encode your input data.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=425478#respond" onclick='return addComment.moveForm( "comment-425478", "425478", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-425604">
<div class="comment-container" id="li-comment-425604">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/100f574e3c1c287e687cbbb91e8a7f1b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/100f574e3c1c287e687cbbb91e8a7f1b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Leo</span>
<span class="date">January 4, 2018 at 3:34 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-425604" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi, Jason</p>
<p>Thanks for your suggestion. and it works. However, I change the problem in this tutorial a little bit, and get stuck again.</p>
<p>In this tutorial, the definition of the problem is given Xtrain, for example, [3, 5, 12, 10, 18, 20], and then, we echo the first two element, so the ytrain looks like [3, 5, 0, 0, 0, 0].</p>
<p>Now, I want to find the specific continuous two numbers in a sequence but those two continuous numbers are located at different location within each sequence. </p>
<p>For example, what I want is [16, Z] where Z is any number, and [16, Z] is within an sequence, Xtrain.</p>
<p>So, Xtrain and ytrain look like:<br/>
Xtrain                                                     ytrain<br/>
[3, 1, 10, 14, 8, 20, 16, 7, 9, 19]            [16, 7, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[6, 1, 23, 16, 9, 12, 22, 8, 0, 17]            [16, 9, 0, 0, 0, 0, 0, 0, 0, 0]<br/>
[9, 13, 15, 12, 16, 2, 5, 1, 10, 8]            [16, 2, 0, 0, 0, 0, 0, 0, 0, 0]</p>
<p>I think the key point is to transform the format of Xtrain and ytrain. One-hot encoding Xtrain remains the same just like this tutorial. But right now I have no idea how to fit ytrain into the model. I tried several ways to transform the format of ytrain, such as,<br/>
1. One-hot encoding ytrain, but it doesn’t work.<br/>
2. One-hot encoding the location of [16, Z], but it seems nonsense.<br/>
3. Changing the format of ytrain to, for example, [0, 0, 0, 0, 0, 0 16, 7, 0, 0], and then one-hot encoding this sequence, but it<br/>
    still doesn’t work.</p>
<p>Do you have any suggestion or idea on such problem? Thank you very much.</p>
<div class="reply">
<a aria-label="Reply to Leo" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=425604#respond" onclick='return addComment.moveForm( "comment-425604", "425604", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-425655">
<div class="comment-container" id="li-comment-425655">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 5, 2018 at 5:17 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-425655" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You could model it as a summarization task with the full sequence in and 2 elements out.</p>
<p>For that you can use an encoder-decoder without attention.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=425655#respond" onclick='return addComment.moveForm( "comment-425655", "425655", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-425795">
<div class="comment-container" id="li-comment-425795">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d7480b55f9558dfcf7c3ddca632964f7?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d7480b55f9558dfcf7c3ddca632964f7?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Paul</span>
<span class="date">January 7, 2018 at 2:27 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-425795" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Is there an updated version of this example that uses TimeDistributed in Keras instead of _time_distributed_dense ?</p>
<div class="reply">
<a aria-label="Reply to Paul" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=425795#respond" onclick='return addComment.moveForm( "comment-425795", "425795", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-425810">
<div class="comment-container" id="li-comment-425810">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 7, 2018 at 5:11 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-425810" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Not at this stage, I am waiting for attention to be officially supported by Keras.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=425810#respond" onclick='return addComment.moveForm( "comment-425810", "425810", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-426236">
<div class="comment-container" id="li-comment-426236">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1f3686186b9a82fa2cdd9a5bf2072d97?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1f3686186b9a82fa2cdd9a5bf2072d97?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="https://www.linkedin.com/in/denisandreiaraujo/" rel="external nofollow">Denis</a></span>
<span class="date">January 12, 2018 at 3:50 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-426236" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>About _time_distributed_dense problem: I copied the code of the _time_distributed_dense function from keras/python/keras/layers/recurrent.py file into the attention_decoder.py file (before the AttentionDecoder class) and the Jason’s code worked for me.</p>
<div class="reply">
<a aria-label="Reply to Denis" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=426236#respond" onclick='return addComment.moveForm( "comment-426236", "426236", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-426261">
<div class="comment-container" id="li-comment-426261">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 12, 2018 at 5:54 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-426261" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Nice!</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=426261#respond" onclick='return addComment.moveForm( "comment-426261", "426261", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-426399">
<div class="comment-container" id="li-comment-426399">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/7dc7a3642d9d0071fbb1c2f35b405abe?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7dc7a3642d9d0071fbb1c2f35b405abe?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="https://nipunbatra.github.io" rel="external nofollow">Nipun Batra</a></span>
<span class="date">January 13, 2018 at 8:28 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-426399" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
Many thanks for the excellent post (as always!)</p>
<p>I was wondering: could we have learnt a model for the continuous data? That is, instead of one hot encoding the input and the output, if we feed in the raw sequence? I wondered as I have not yet seen a Seq2Seq with attention for continuous data. I was thinking of writing a simple model based on your post, to denoise a sine signal. It should be a case of Seq2seq on same length sequences.</p>
<div class="reply">
<a aria-label="Reply to Nipun Batra" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=426399#respond" onclick='return addComment.moveForm( "comment-426399", "426399", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-426471">
<div class="comment-container" id="li-comment-426471">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 14, 2018 at 6:33 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-426471" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sure, but it may be a harder problem for the model to learn.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=426471#respond" onclick='return addComment.moveForm( "comment-426471", "426471", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-426555">
<div class="comment-container" id="li-comment-426555">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/7dc7a3642d9d0071fbb1c2f35b405abe?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7dc7a3642d9d0071fbb1c2f35b405abe?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="https://nipunbatra.github.io" rel="external nofollow">Nipun Batra</a></span>
<span class="date">January 14, 2018 at 11:50 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-426555" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks! When I just used the code in this blog post as it is (with attention), I didn’t see any reduction in loss function when using continuous data. That’s when I wondered if the attention implementation shared here is only for discrete data?</p>
<div class="reply">
<a aria-label="Reply to Nipun Batra" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=426555#respond" onclick='return addComment.moveForm( "comment-426555", "426555", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-426585">
<div class="comment-container" id="li-comment-426585">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">January 15, 2018 at 6:59 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#comment-426585" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Nice.</p>
<p>No, it is independent of the data.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/encoder-decoder-attention-sequence-to-sequence-prediction-keras/?replytocom=426585#respond" onclick='return addComment.moveForm( "comment-426585", "426585", "respond", "4549" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ol>
</div> <div class="comment-respond" id="respond">
<h3 class="comment-reply-title" id="reply-title">Leave a Reply <small><a href="/encoder-decoder-attention-sequence-to-sequence-prediction-keras/#respond" id="cancel-comment-reply-link" rel="nofollow" style="display:none;">Click here to cancel reply.</a></small></h3> <form action="https://machinelearningmastery.com/wp-comments-post.php?wpe-comment-post=mlmastery" class="comment-form" id="commentform" method="post">
<p class="comment-form-comment"><label class="hide" for="comment">Comment</label> <textarea aria-required="true" cols="50" id="comment" maxlength="65525" name="comment" required="required" rows="10" tabindex="4"></textarea></p><p class="comment-form-author"><input aria-required="true" class="txt" id="author" name="author" size="30" tabindex="1" type="text" value=""/><label for="author">Name <span class="required">(required)</span></label> </p>
<p class="comment-form-email"><input aria-required="true" class="txt" id="email" name="email" size="30" tabindex="2" type="text" value=""/><label for="email">Email (will not be published) <span class="required">(required)</span></label> </p>
<p class="comment-form-url"><input class="txt" id="url" name="url" size="30" tabindex="3" type="text" value=""/><label for="url">Website</label></p>
<p class="form-submit"><input class="submit" id="submit" name="submit" type="submit" value="Submit Comment"/> <input id="comment_post_ID" name="comment_post_ID" type="hidden" value="4549"/>
<input id="comment_parent" name="comment_parent" type="hidden" value="0"/>
</p><p style="display: none;"><input id="akismet_comment_nonce" name="akismet_comment_nonce" type="hidden" value="fa6cf2ca23"/></p><p style="display: none;"><input id="ak_js" name="ak_js" type="hidden" value="209"/></p> </form>
</div><!-- #respond -->
</section><!-- /#main -->
<aside id="sidebar">
<div class="widget widget_woo_blogauthorinfo" id="woo_blogauthorinfo-2"><h3>Welcome to Machine Learning Mastery</h3><span class="left"><img alt="" class="avatar avatar-100 photo" height="100" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=100&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=200&amp;d=mm&amp;r=g 2x" width="100"/></span>
<p>Hi, I'm Dr. Jason Brownlee.
<br/>
My goal is to make practitioners like YOU awesome at applied machine learning.</p>
<p><a href="/about">Read More</a></p>
<div class="fix"></div>
</div><div class="widget widget_text" id="text-29"> <div class="textwidget"><p></p><center>
<h3>Deep Learning for Sequence Prediction</h3>
<p>Cut through the math and research papers.<br/>
Discover 4 Models, 6 Architectures, and 14 Tutorials.</p>
<p><a href="/lstms-with-python/">Get Started With LSTMs in Python Today!</a><br/>
<a href="/lstms-with-python/"><img src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/07/Cover-220.png"/></a><br/>
</p></center>
</div>
</div>
<div class="widget widget_woo_tabs" id="woo_tabs-2"> <div id="tabs">
<ul class="wooTabs">
<li class="popular"><a href="#tab-pop">Popular</a></li> </ul>
<div class="clear"></div>
<div class="boxes box inside">
<ul class="list" id="tab-pop">
<li>
<a href="https://machinelearningmastery.com/machine-learning-in-python-step-by-step/" title="Your First Machine Learning Project in Python Step-By-Step"><img alt="Your First Machine Learning Project in Python Step-By-Step" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Your-First-Machine-Learning-Project-in-Python-Step-By-Step-150x150.jpg" title="Your First Machine Learning Project in Python Step-By-Step" width="45"/></a> <a href="https://machinelearningmastery.com/machine-learning-in-python-step-by-step/" title="Your First Machine Learning Project in Python Step-By-Step">Your First Machine Learning Project in Python Step-By-Step</a>
<span class="meta">June 10, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras"><img alt="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/07/Time-Series-Prediction-with-LSTM-Recurrent-Neural-Networks-in-Python-with-Keras-150x150.jpg" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras" width="45"/></a> <a href="https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras">Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras</a>
<span class="meta">July 21, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/" title="Multivariate Time Series Forecasting with LSTMs in Keras"><img alt="Line Plots of Air Pollution Time Series" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/06/Line-Plots-of-Air-Pollution-Time-Series-150x150.png" title="Multivariate Time Series Forecasting with LSTMs in Keras" width="45"/></a> <a href="https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/" title="Multivariate Time Series Forecasting with LSTMs in Keras">Multivariate Time Series Forecasting with LSTMs in Keras</a>
<span class="meta">August 14, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/tutorial-first-neural-network-python-keras/" title="Develop Your First Neural Network in Python With Keras Step-By-Step"><img alt="Tour of Deep Learning Algorithms" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/04/Tour-of-Deep-Learning-Algorithms-150x150.jpg" title="Develop Your First Neural Network in Python With Keras Step-By-Step" width="45"/></a> <a href="https://machinelearningmastery.com/tutorial-first-neural-network-python-keras/" title="Develop Your First Neural Network in Python With Keras Step-By-Step">Develop Your First Neural Network in Python With Keras Step-By-Step</a>
<span class="meta">May 24, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda"><img alt="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/How-to-Setup-a-Python-Environment-for-Machine-Learning-and-Deep-Learning-with-Anaconda-150x150.png" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda" width="45"/></a> <a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda">How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda</a>
<span class="meta">March 13, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/sequence-classification-lstm-recurrent-neural-networks-python-keras/" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras"><img alt="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/07/Sequence-Classification-with-LSTM-Recurrent-Neural-Networks-in-Python-with-Keras-150x150.jpg" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras" width="45"/></a> <a href="https://machinelearningmastery.com/sequence-classification-lstm-recurrent-neural-networks-python-keras/" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras">Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras</a>
<span class="meta">July 26, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/time-series-forecasting-long-short-term-memory-network-python/" title="Time Series Forecasting with the Long Short-Term Memory Network in Python"><img alt="Time Series Forecasting with the Long Short-Term Memory Network in Python" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/04/Time-Series-Forecasting-with-the-Long-Short-Term-Memory-Network-in-Python-150x150.jpg" title="Time Series Forecasting with the Long Short-Term Memory Network in Python" width="45"/></a> <a href="https://machinelearningmastery.com/time-series-forecasting-long-short-term-memory-network-python/" title="Time Series Forecasting with the Long Short-Term Memory Network in Python">Time Series Forecasting with the Long Short-Term Memory Network in Python</a>
<span class="meta">April 7, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/multi-class-classification-tutorial-keras-deep-learning-library/" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library"><img alt="Multi-Class Classification Tutorial with the Keras Deep Learning Library" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Multi-Class-Classification-Tutorial-with-the-Keras-Deep-Learning-Library-150x150.jpg" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library" width="45"/></a> <a href="https://machinelearningmastery.com/multi-class-classification-tutorial-keras-deep-learning-library/" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library">Multi-Class Classification Tutorial with the Keras Deep Learning Library</a>
<span class="meta">June 2, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/regression-tutorial-keras-deep-learning-library-python/" title="Regression Tutorial with the Keras Deep Learning Library in Python"><img alt="Regression Tutorial with Keras Deep Learning Library in Python" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Regression-Tutorial-with-Keras-Deep-Learning-Library-in-Python-150x150.jpg" title="Regression Tutorial with the Keras Deep Learning Library in Python" width="45"/></a> <a href="https://machinelearningmastery.com/regression-tutorial-keras-deep-learning-library-python/" title="Regression Tutorial with the Keras Deep Learning Library in Python">Regression Tutorial with the Keras Deep Learning Library in Python</a>
<span class="meta">June 9, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/grid-search-hyperparameters-deep-learning-models-python-keras/" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras"><img alt="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/08/How-to-Grid-Search-Hyperparameters-for-Deep-Learning-Models-in-Python-With-Keras-150x150.jpg" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras" width="45"/></a> <a href="https://machinelearningmastery.com/grid-search-hyperparameters-deep-learning-models-python-keras/" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras">How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras</a>
<span class="meta">August 9, 2016</span>
<div class="fix"></div>
</li>
</ul>
</div><!-- /.boxes -->
</div><!-- /wooTabs -->
</div> </aside><!-- /#sidebar -->
</div><!-- /#main-sidebar-container -->
</div><!-- /#content -->
<footer class="col-full" id="footer">
<div class="col-left" id="copyright">
<p>© 2018 Machine Learning Mastery. All Rights Reserved. </p> </div>
<div class="col-right" id="credit">
<p></p><p>
<a href="/privacy/">Privacy</a> | 
<a href="/contact/">Contact</a> |
<a href="/about/">About</a>
</p> </div>
</footer>
</div><!-- /#inner-wrapper -->
</div><!-- /#wrapper -->
<div class="fix"></div><!--/.fix-->
<!-- Drip -->
<script type="text/javascript">
  var _dcq = _dcq || [];
  var _dcs = _dcs || {}; 
  _dcs.account = '9556588';
  
  (function() {
    var dc = document.createElement('script');
    dc.type = 'text/javascript'; dc.async = true; 
    dc.src = '//tag.getdrip.com/9556588.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(dc, s);
  })();
</script><!-- Woo Tabs Widget -->
<script type="text/javascript">
jQuery(document).ready(function(){
	// UL = .wooTabs
	// Tab contents = .inside

	var tag_cloud_class = '#tagcloud';

	//Fix for tag clouds - unexpected height before .hide()
	var tag_cloud_height = jQuery( '#tagcloud').height();

	jQuery( '.inside ul li:last-child').css( 'border-bottom','0px' ); // remove last border-bottom from list in tab content
	jQuery( '.wooTabs').each(function(){
		jQuery(this).children( 'li').children( 'a:first').addClass( 'selected' ); // Add .selected class to first tab on load
	});
	jQuery( '.inside > *').hide();
	jQuery( '.inside > *:first-child').show();

	jQuery( '.wooTabs li a').click(function(evt){ // Init Click funtion on Tabs

		var clicked_tab_ref = jQuery(this).attr( 'href' ); // Strore Href value

		jQuery(this).parent().parent().children( 'li').children( 'a').removeClass( 'selected' ); //Remove selected from all tabs
		jQuery(this).addClass( 'selected' );
		jQuery(this).parent().parent().parent().children( '.inside').children( '*').hide();

		jQuery( '.inside ' + clicked_tab_ref).fadeIn(500);

		 evt.preventDefault();

	})
})
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/comment-reply.min.js?ver=4.9.2" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var wpcf7 = {"apiSettings":{"root":"https:\/\/machinelearningmastery.com\/wp-json\/contact-form-7\/v1","namespace":"contact-form-7\/v1"},"recaptcha":{"messages":{"empty":"Please verify that you are not a robot."}},"cached":"1"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/js/scripts.js?ver=4.9.2" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var frontend_ajax_object = {"ajax_url":"https:\/\/machinelearningmastery.com\/wp-admin\/admin-ajax.php","ajax_nonce":"555b70787c"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/seo-optimized-share-buttons/js/frontend.js?ver=4.2.2.0.iis7_supports_permalinks" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/wp-embed.min.js?ver=4.9.2" type="text/javascript"></script>
<script async="async" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/akismet/_inc/form.js?ver=4.0.2" type="text/javascript"></script>
</body>
</html>