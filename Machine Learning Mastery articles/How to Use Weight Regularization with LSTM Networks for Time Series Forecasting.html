<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
<meta charset="utf-8"/>
<title>How to Use Weight Regularization with LSTM Networks for Time Series Forecasting - Machine Learning Mastery</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="https://machinelearningmastery.com/xmlrpc.php" rel="pingback"/>
<!--  Mobile viewport scale -->
<meta content="initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" name="viewport"/>
<!-- This site is optimized with the Yoast SEO plugin v6.1.1 - https://yoa.st/1yg?utm_content=6.1.1 -->
<link href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/" rel="canonical"/>
<link href="https://plus.google.com/u/0/b/117073416089354242117/+MachinelearningmasteryHome/" rel="publisher"/>
<meta content="en_US" property="og:locale"/>
<meta content="article" property="og:type"/>
<meta content="How to Use Weight Regularization with LSTM Networks for Time Series Forecasting - Machine Learning Mastery" property="og:title"/>
<meta content="Long Short-Term Memory (LSTM) models are a recurrent neural network capable of learning sequences of observations. This may make them a network well suited to time series forecasting. An issue with LSTMs is that they can easily overfit training data, reducing their predictive skill. Weight regularization is a technique for imposing constraints (such as L1 …" property="og:description"/>
<meta content="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/" property="og:url"/>
<meta content="Machine Learning Mastery" property="og:site_name"/>
<meta content="https://www.facebook.com/Machine-Learning-Mastery-1429846323896563/" property="article:publisher"/>
<meta content="Long Short-Term Memory Networks" property="article:section"/>
<meta content="2017-05-05T05:00:04+11:00" property="article:published_time"/>
<meta content="2017-07-20T08:55:00+11:00" property="article:modified_time"/>
<meta content="2017-07-20T08:55:00+11:00" property="og:updated_time"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/How-to-Use-Weight-Regularization-with-LSTM-Networks-for-Time-Series-Forecasting.jpg" property="og:image"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/How-to-Use-Weight-Regularization-with-LSTM-Networks-for-Time-Series-Forecasting.jpg" property="og:image:secure_url"/>
<meta content="640" property="og:image:width"/>
<meta content="427" property="og:image:height"/>
<script type="application/ld+json">{"@context":"http:\/\/schema.org","@type":"WebSite","@id":"#website","url":"https:\/\/machinelearningmastery.com\/","name":"Machine Learning Mastery","potentialAction":{"@type":"SearchAction","target":"https:\/\/machinelearningmastery.com\/?s={search_term_string}","query-input":"required name=search_term_string"}}</script>
<script type="application/ld+json">{"@context":"http:\/\/schema.org","@type":"Organization","url":"https:\/\/machinelearningmastery.com\/use-weight-regularization-lstm-networks-time-series-forecasting\/","sameAs":["https:\/\/www.facebook.com\/Machine-Learning-Mastery-1429846323896563\/","https:\/\/www.linkedin.com\/in\/jasonbrownlee","https:\/\/plus.google.com\/u\/0\/b\/117073416089354242117\/+MachinelearningmasteryHome\/","https:\/\/twitter.com\/TeachTheMachine"],"@id":"#organization","name":"Machine Learning Mastery","logo":"https:\/\/machinelearningmastery.com\/wp-content\/uploads\/2016\/09\/cropped-icon.png"}</script>
<!-- / Yoast SEO plugin. -->
<link href="//cdnjs.cloudflare.com" rel="dns-prefetch"/>
<link href="//fonts.googleapis.com" rel="dns-prefetch"/>
<link href="//s.w.org" rel="dns-prefetch"/>
<link href="https://feeds.feedburner.com/MachineLearningMastery" rel="alternate" title="Machine Learning Mastery » Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/comments/feed/" rel="alternate" title="Machine Learning Mastery » Comments Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/feed/" rel="alternate" title="Machine Learning Mastery » How to Use Weight Regularization with LSTM Networks for Time Series Forecasting Comments Feed" type="application/rss+xml"/>
<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/machinelearningmastery.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.9.2"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56794,8205,9794,65039],[55358,56794,8203,9794,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta" id="crayon-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta" id="crayon-theme-classic-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta" id="crayon-font-monaco-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=4.9.2" id="contact-form-7-css" media="all" rel="stylesheet" type="text/css"/>
<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css?ver=4.2.2.0.iis7_supports_permalinks" id="apss-font-awesome-css" media="all" rel="stylesheet" type="text/css"/>
<link href="//fonts.googleapis.com/css?family=Open+Sans&amp;ver=4.9.2" id="apss-font-opensans-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/seo-optimized-share-buttons/css/frontend.css?ver=4.2.2.0.iis7_supports_permalinks" id="apss-frontend-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/integrations/testimonials/css/testimonials.css?ver=4.9.2" id="woo-testimonials-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/style.css?ver=5.9.21" id="theme-stylesheet-css" media="all" rel="stylesheet" type="text/css"/>
<!--[if lt IE 9]>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/css/non-responsive.css" rel="stylesheet" type="text/css" />
<style type="text/css">.col-full, #wrapper { width: 960px; max-width: 960px; } #inner-wrapper { padding: 0; } body.full-width #header, #nav-container, body.full-width #content, body.full-width #footer-widgets, body.full-width #footer { padding-left: 0; padding-right: 0; } body.fixed-mobile #top, body.fixed-mobile #header-container, body.fixed-mobile #footer-container, body.fixed-mobile #nav-container, body.fixed-mobile #footer-widgets-container { min-width: 960px; padding: 0 1em; } body.full-width #content { width: auto; padding: 0 1em;}</style>
<![endif]-->
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery.js?ver=1.12.4" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/machinelearningmastery.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/third-party.min.js?ver=4.9.2" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/modernizr.min.js?ver=2.6.2" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/general.min.js?ver=4.9.2" type="text/javascript"></script>
<link href="https://machinelearningmastery.com/wp-json/" rel="https://api.w.org/"/>
<link href="https://machinelearningmastery.com/xmlrpc.php?rsd" rel="EditURI" title="RSD" type="application/rsd+xml"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/wlwmanifest.xml" rel="wlwmanifest" type="application/wlwmanifest+xml"/>
<link href="https://machinelearningmastery.com/?p=3978" rel="shortlink"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fuse-weight-regularization-lstm-networks-time-series-forecasting%2F" rel="alternate" type="application/json+oembed"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fuse-weight-regularization-lstm-networks-time-series-forecasting%2F&amp;format=xml" rel="alternate" type="text/xml+oembed"/>
<!-- Start Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44039733-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->
<!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');

fbq('init', '296263687421164');
fbq('track', "PageView");</script>
<noscript><img height="1" src="https://www.facebook.com/tr?id=296263687421164&amp;ev=PageView&amp;noscript=1" style="display:none" width="1"/></noscript>
<!-- End Facebook Pixel Code -->
<!-- Custom CSS Styling -->
<style type="text/css">
#logo .site-title, #logo .site-description { display:none; }
body {background-repeat:no-repeat;background-position:top left;background-attachment:scroll;border-top:0px solid #000000;}
#header {background-repeat:no-repeat;background-position:left top;margin-top:0px;margin-bottom:0px;padding-top:10px;padding-bottom:10px;border:0px solid ;}
#logo .site-title a {font:bold 40px/1em Helvetica Neue, Helvetica, sans-serif;color:#222222;}
#logo .site-description {font:300 13px/1em Helvetica Neue, Helvetica, sans-serif;color:#999999;}
body, p { font:300 14px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
h1 { font:bold 28px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h2 { font:bold 24px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h3 { font:bold 20px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h4 { font:bold 16px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h5 { font:bold 14px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h6 { font:bold 12px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }
.page-title, .post .title, .page .title {font:bold 28px/1.1em "Helvetica Neue", Helvetica, sans-serif;color:#222222;}
.post .title a:link, .post .title a:visited, .page .title a:link, .page .title a:visited {color:#222222}
.post-meta { font:300 12px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#999999; }
.entry, .entry p{ font:300 15px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555; }
.post-more {font:300 13px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:;border-top:0px solid #e6e6e6;border-bottom:0px solid #e6e6e6;}
#post-author, #connect {border-top:1px solid #e6e6e6;border-bottom:1px solid #e6e6e6;border-left:1px solid #e6e6e6;border-right:1px solid #e6e6e6;border-radius:5px;-moz-border-radius:5px;-webkit-border-radius:5px;background-color:#fafafa}
.nav-entries a, .woo-pagination { font:300 13px/1em "Helvetica Neue", Helvetica, sans-serif;color:#888; }
.woo-pagination a, .woo-pagination a:hover {color:#888!important}
.widget h3 {font:bold 14px/1.2em &quot;Helvetica Neue&quot;, Helvetica, sans-serif;color:#555555;border-bottom:1px solid #e6e6e6;}
.widget_recent_comments li, #twitter li { border-color: #e6e6e6;}
.widget p, .widget .textwidget { font:300 13px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
.widget {font:300 13px/1.5em &quot;Helvetica Neue&quot;, Helvetica, sans-serif;color:#555555;border-radius:0px;-moz-border-radius:0px;-webkit-border-radius:0px;}
#tabs .inside li a, .widget_woodojo_tabs .tabbable .tab-pane li a { font:bold 12px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
#tabs .inside li span.meta, .widget_woodojo_tabs .tabbable .tab-pane li span.meta { font:300 11px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
#tabs ul.wooTabs li a, .widget_woodojo_tabs .tabbable .nav-tabs li a { font:300 11px/2em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
@media only screen and (min-width:768px) {
ul.nav li a, #navigation ul.rss a, #navigation ul.cart a.cart-contents, #navigation .cart-contents #navigation ul.rss, #navigation ul.nav-search, #navigation ul.nav-search a { font:300 14px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#666666; } #navigation ul.rss li a:before, #navigation ul.nav-search a.search-contents:before { color:#666666;}
#navigation ul.nav li ul, #navigation ul.cart > li > ul > div  { border: 0px solid #dbdbdb; }
#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation ul.nav > li  { border-right: 0px solid #dbdbdb; }#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation { box-shadow: none; -moz-box-shadow: none; -webkit-box-shadow: none; }#navigation ul li:first-child, #navigation ul li:first-child a { border-radius:0px 0 0 0px; -moz-border-radius:0px 0 0 0px; -webkit-border-radius:0px 0 0 0px; }
#navigation {border-top:0px solid #dbdbdb;border-bottom:0px solid #dbdbdb;border-left:0px solid #dbdbdb;border-right:0px solid #dbdbdb;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
#top ul.nav li a { font:300 12px/1.6em Helvetica Neue, Helvetica, sans-serif;color:#ddd; }
}
#footer, #footer p { font:300 13px/1.4em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
#footer {border-top:1px solid #dbdbdb;border-bottom:0px solid ;border-left:0px solid ;border-right:0px solid ;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
.magazine #loopedSlider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-magazine .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.magazine #loopedSlider .content .excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-magazine .slide-content p, .wooslider-theme-magazine .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.magazine .block .post .title a {font:bold 18px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }
#loopedSlider.business-slider .content h2 { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#loopedSlider.business-slider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#wrapper #loopedSlider.business-slider .content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.archive_header { font:bold 18px/1em Arial, sans-serif;color:#222222; }
.archive_header {border-bottom:1px solid #e6e6e6;}
.archive_header .catrss { display:none; }
</style>
<!-- Woo Shortcodes CSS -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/functions/css/shortcodes.css" rel="stylesheet" type="text/css"/>
<!-- Custom Stylesheet -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/custom.css" rel="stylesheet" type="text/css"/>
<!-- Theme version -->
<meta content="Canvas 5.9.21" name="generator"/>
<meta content="WooFramework 6.2.9" name="generator"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-32x32.png" rel="icon" sizes="32x32"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-192x192.png" rel="icon" sizes="192x192"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-180x180.png" rel="apple-touch-icon-precomposed"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-270x270.png" name="msapplication-TileImage"/>
</head>
<body class="post-template-default single single-post postid-3978 single-format-standard unknown alt-style-default two-col-left width-960 two-col-left-960">
<div id="wrapper">
<div id="inner-wrapper">
<h3 class="nav-toggle icon"><a href="#navigation">Navigation</a></h3>
<header class="col-full" id="header">
<div id="logo">
<a href="https://machinelearningmastery.com/" title="Making developers awesome at machine learning"><img alt="Machine Learning Mastery" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/MachineLearningMastery.png"/></a>
<span class="site-title"><a href="https://machinelearningmastery.com/">Machine Learning Mastery</a></span>
<span class="site-description">Making developers awesome at machine learning</span>
</div>
<div class="header-widget">
<div class="widget widget_text" id="text-3"> <div class="textwidget"><br/>
<div style="font-size:12pt;">
<a href="/start-here"><strong>Start Here</strong></a>
     
<a href="/blog">Blog</a>
     
<a href="/products">Books</a>
     
<a href="/about">About</a>
     
<a href="/contact">Contact</a>
</div></div>
</div><div class="widget widget_search" id="search-3"><div class="search_main">
<form action="https://machinelearningmastery.com/" class="searchform" method="get">
<input class="field s" name="s" onblur="if (this.value == '') {this.value = 'Search...';}" onfocus="if (this.value == 'Search...') {this.value = '';}" type="text" value="Search..."/>
<button class="fa fa-search submit" name="submit" type="submit" value="Search"></button>
</form>
<div class="fix"></div>
</div></div><div class="widget widget_text" id="text-31"> <div class="textwidget"><p>Need help with LSTMs in Python? <a href="https://machinelearningmastery.lpages.co/lnwp-mini-course/">Take the FREE Mini-Course</a>.</p>
</div>
</div> </div>
</header>
<nav class="col-full" id="navigation" role="navigation">
<section class="menus">
<a class="nav-home" href="https://machinelearningmastery.com"><span>Home</span></a>
<h3>Empty Menu</h3> <div class="side-nav">
</div><!-- /#side-nav -->
</section><!-- /.menus -->
<a class="nav-close" href="#top"><span>Return to Content</span></a>
</nav>
<!-- #content Starts -->
<div class="col-full" id="content">
<div id="main-sidebar-container">
<!-- #main Starts -->
<section id="main">
<article class="post-3978 post type-post status-publish format-standard has-post-thumbnail hentry category-lstm">
<header>
<h1 class="title entry-title">How to Use Weight Regularization with LSTM Networks for Time Series Forecasting</h1> </header>
<div class="post-meta"><span class="small">By</span> <span class="author vcard"><span class="fn"><a href="https://machinelearningmastery.com/author/jasonb/" rel="author" title="Posts by Jason Brownlee">Jason Brownlee</a></span></span> <span class="small">on</span> <abbr class="date time published updated" title="2017-05-05T05:00:04+1100">May 5, 2017</abbr> <span class="small">in</span> <span class="categories"><a href="https://machinelearningmastery.com/category/lstm/" title="View all items in Long Short-Term Memory Networks">Long Short-Term Memory Networks</a></span> </div>
<section class="entry">
<div class="apss-social-share apss-theme-4 clearfix">
<div class="apss-twitter apss-single-icon">
<a href="javascript:void(0);" onclick="apss_open_in_popup_window(event, 'https://twitter.com/intent/tweet?text=How%20to%20Use%20Weight%20Regularization%20with%20LSTM%20Networks%20for%20Time%20Series%20Forecasting&amp;url=https%3A%2F%2Fmachinelearningmastery.com%2Fuse-weight-regularization-lstm-networks-time-series-forecasting%2F&amp;');" rel="nofollow" target="" title="Share on Twitter">
<div class="apss-icon-block clearfix">
<i class="fa fa-twitter"></i>
<span class="apss-social-text">Share on Twitter</span><span class="apss-share">Tweet</span>
</div>
</a>
</div>
<div class="apss-facebook apss-single-icon">
<a href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/" onclick="apss_open_in_popup_window(event, 'https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/');" rel="nofollow" target="" title="Share on Facebook">
<div class="apss-icon-block clearfix">
<i class="fa fa-facebook"></i>
<span class="apss-social-text">Share on Facebook</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-linkedin apss-single-icon">
<a href="http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Use%20Weight%20Regularization%20with%20LSTM%20Networks%20for%20Time%20Series%20Forecasting&amp;url=https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/&amp;summary=Long+Short-Term+Memory+%28LSTM%29+models+are+a+recurrent+neural+network+capable+of+learning+sequences+of..." onclick="apss_open_in_popup_window(event, 'http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Use%20Weight%20Regularization%20with%20LSTM%20Networks%20for%20Time%20Series%20Forecasting&amp;url=https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/&amp;summary=Long+Short-Term+Memory+%28LSTM%29+models+are+a+recurrent+neural+network+capable+of+learning+sequences+of...');" rel="nofollow" target="" title="Share on LinkedIn">
<div class="apss-icon-block clearfix"><i class="fa fa-linkedin"></i>
<span class="apss-social-text">Share on LinkedIn</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-google-plus apss-single-icon">
<a href="https://plus.google.com/share?url=https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/" onclick="apss_open_in_popup_window(event, 'https://plus.google.com/share?url=https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/');" rel="nofollow" target="" title="Share on Google Plus">
<div class="apss-icon-block clearfix">
<i class="fa fa-google-plus"></i>
<span class="apss-social-text">Share on Google Plus</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
</div><p>Long Short-Term Memory (LSTM) models are a recurrent neural network capable of learning sequences of observations.</p>
<p>This may make them a network well suited to time series forecasting.</p>
<p>An issue with LSTMs is that they can easily overfit training data, reducing their predictive skill.</p>
<p>Weight regularization is a technique for imposing constraints (such as L1 or L2) on the weights within LSTM nodes. This has the effect of reducing overfitting and improving model performance.</p>
<p>In this tutorial, you will discover how to use weight regularization with LSTM networks and design experiments to test for its effectiveness for time series forecasting.</p>
<p>After completing this tutorial, you will know:</p>
<ul>
<li>How to design a robust test harness for evaluating LSTM networks for time series forecasting.</li>
<li>How to design, execute, and interpret the results from using bias weight regularization with LSTMs.</li>
<li>How to design, execute, and interpret the results from using input and recurrent weight regularization with LSTMs.</li>
</ul>
<p>Let’s get started.</p>
<div class="wp-caption aligncenter" id="attachment_3982" style="max-width: 650px"><img alt="How to Use Weight Regularization with LSTM Networks for Time Series Forecasting" class="size-full wp-image-3982" height="427" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/How-to-Use-Weight-Regularization-with-LSTM-Networks-for-Time-Series-Forecasting.jpg" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/How-to-Use-Weight-Regularization-with-LSTM-Networks-for-Time-Series-Forecasting.jpg 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/How-to-Use-Weight-Regularization-with-LSTM-Networks-for-Time-Series-Forecasting-300x200.jpg 300w" width="640"/><p class="wp-caption-text">How to Use Weight Regularization with LSTM Networks for Time Series Forecasting<br/>Photo by Julian Fong, some rights reserved.</p></div>
<h2>Tutorial Overview</h2>
<p>This tutorial is broken down into 6 parts. They are:</p>
<ol>
<li>Shampoo Sales Dataset</li>
<li>Experimental Test Harness</li>
<li>Bias Weight Regularization</li>
<li>Input Weight Regularization</li>
<li>Recurrent Weight Regularization</li>
<li>Review of Results</li>
</ol>
<h3>Environment</h3>
<p>This tutorial assumes you have a Python SciPy environment installed. You can use either Python 2 or 3 with this example.</p>
<p>This tutorial assumes you have Keras v2.0 or higher installed with either the TensorFlow or Theano backend.</p>
<p>This tutorial also assumes you have scikit-learn, Pandas, NumPy, and Matplotlib installed.</p>
<p>If you need help setting up your Python environment, see this post:</p>
<ul>
<li><a href="http://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/">How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda</a></li>
</ul>
<p>Next, let’s take a look at a standard time series forecasting problem that we can use as context for this experiment.</p>
<!-- Start shortcoder --><div class="woo-sc-hr"></div>
<center>
<h3>Need help with LSTMs for Sequence Prediction?</h3>
<p>Take my free 7-day email course and discover 6 different LSTM architectures (with sample code).</p>
<p>Click to sign-up and also get a free PDF Ebook version of the course.</p>
<p><a href="https://machinelearningmastery.lpages.co/leadbox/1403a9373f72a2%3A164f8be4f346dc/5754903989321728/" rel="noopener" style="background: #ffce0a; color: #ffffff; text-decoration: none; font-family: Helvetica, Arial, sans-serif; font-weight: bold; font-size: 16px; line-height: 20px; padding: 10px; display: inline-block; max-width: 300px; border-radius: 5px; text-shadow: rgba(0, 0, 0, 0.25) 0px -1px 1px; box-shadow: rgba(255, 255, 255, 0.5) 0px 1px 3px inset, rgba(0, 0, 0, 0.5) 0px 1px 3px;" target="_blank">Start Your FREE Mini-Course Now!</a><script data-config="%7B%7D" data-leadbox="1403a9373f72a2:164f8be4f346dc" data-url="https://machinelearningmastery.lpages.co/leadbox/1403a9373f72a2%3A164f8be4f346dc/5754903989321728/" src="https://machinelearningmastery.lpages.co/leadbox-1500400021.js" type="text/javascript"></script></p>
</center>
<div class="woo-sc-hr"></div><!-- End shortcoder v4.1.5-->
<h2>Shampoo Sales Dataset</h2>
<p>This dataset describes the monthly number of sales of shampoo over a 3-year period.</p>
<p>The units are a sales count and there are 36 observations. The original dataset is credited to Makridakis, Wheelwright, and Hyndman (1998).</p>
<p><a href="https://datamarket.com/data/set/22r0/sales-of-shampoo-over-a-three-year-period">You can download and learn more about the dataset here</a>.</p>
<p>The example below loads and creates a plot of the loaded dataset.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a65919c5c51f063413248" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load and plot dataset
from pandas import read_csv
from pandas import datetime
from matplotlib import pyplot
# load dataset
def parser(x):
	return datetime.strptime('190'+x, '%Y-%m')
series = read_csv('shampoo-sales.csv', header=0, parse_dates=[0], index_col=0, squeeze=True, date_parser=parser)
# summarize first few rows
print(series.head())
# line plot
series.plot()
pyplot.show()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a65919c5c51f063413248-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c51f063413248-2">2</div><div class="crayon-num" data-line="crayon-5a65919c5c51f063413248-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c51f063413248-4">4</div><div class="crayon-num" data-line="crayon-5a65919c5c51f063413248-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c51f063413248-6">6</div><div class="crayon-num" data-line="crayon-5a65919c5c51f063413248-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c51f063413248-8">8</div><div class="crayon-num" data-line="crayon-5a65919c5c51f063413248-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c51f063413248-10">10</div><div class="crayon-num" data-line="crayon-5a65919c5c51f063413248-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c51f063413248-12">12</div><div class="crayon-num" data-line="crayon-5a65919c5c51f063413248-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a65919c5c51f063413248-1"><span class="crayon-p"># load and plot dataset</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c51f063413248-2"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line" id="crayon-5a65919c5c51f063413248-3"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">datetime</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c51f063413248-4"><span class="crayon-e">from </span><span class="crayon-e">matplotlib </span><span class="crayon-e">import </span><span class="crayon-v">pyplot</span></div><div class="crayon-line" id="crayon-5a65919c5c51f063413248-5"><span class="crayon-p"># load dataset</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c51f063413248-6"><span class="crayon-e">def </span><span class="crayon-e">parser</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c51f063413248-7"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">datetime</span><span class="crayon-sy">.</span><span class="crayon-e">strptime</span><span class="crayon-sy">(</span><span class="crayon-s">'190'</span><span class="crayon-o">+</span><span class="crayon-v">x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'%Y-%m'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c51f063413248-8"><span class="crayon-v">series</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'shampoo-sales.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">squeeze</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">date_parser</span><span class="crayon-o">=</span><span class="crayon-v">parser</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c51f063413248-9"><span class="crayon-p"># summarize first few rows</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c51f063413248-10"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">series</span><span class="crayon-sy">.</span><span class="crayon-e">head</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c51f063413248-11"><span class="crayon-p"># line plot</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c51f063413248-12"><span class="crayon-v">series</span><span class="crayon-sy">.</span><span class="crayon-e">plot</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c51f063413248-13"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">show</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0009 seconds] -->
<p>Running the example loads the dataset as a Pandas Series and prints the first 5 rows.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a65919c5c527145255657" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Month
1901-01-01 266.0
1901-02-01 145.9
1901-03-01 183.1
1901-04-01 119.3
1901-05-01 180.3
Name: Sales, dtype: float64</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a65919c5c527145255657-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c527145255657-2">2</div><div class="crayon-num" data-line="crayon-5a65919c5c527145255657-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c527145255657-4">4</div><div class="crayon-num" data-line="crayon-5a65919c5c527145255657-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c527145255657-6">6</div><div class="crayon-num" data-line="crayon-5a65919c5c527145255657-7">7</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a65919c5c527145255657-1">Month</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c527145255657-2">1901-01-01 266.0</div><div class="crayon-line" id="crayon-5a65919c5c527145255657-3">1901-02-01 145.9</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c527145255657-4">1901-03-01 183.1</div><div class="crayon-line" id="crayon-5a65919c5c527145255657-5">1901-04-01 119.3</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c527145255657-6">1901-05-01 180.3</div><div class="crayon-line" id="crayon-5a65919c5c527145255657-7">Name: Sales, dtype: float64</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>A line plot of the series is then created showing a clear increasing trend.</p>
<div class="wp-caption aligncenter" id="attachment_3901" style="max-width: 650px"><img alt="Line Plot of Shampoo Sales Dataset" class="size-full wp-image-3901" height="480" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Line-Plot-of-Shampoo-Sales-Dataset-1.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Line-Plot-of-Shampoo-Sales-Dataset-1.png 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Line-Plot-of-Shampoo-Sales-Dataset-1-300x225.png 300w" width="640"/><p class="wp-caption-text">Line Plot of Shampoo Sales Dataset</p></div>
<p>Next, we will take a look at the model configuration and test harness used in the experiment.</p>
<h2>Experimental Test Harness</h2>
<p>This section describes the test harness used in this tutorial.</p>
<h3>Data Split</h3>
<p>We will split the Shampoo Sales dataset into two parts: a training and a test set.</p>
<p>The first two years of data will be taken for the training dataset and the remaining one year of data will be used for the test set.</p>
<p>Models will be developed using the training dataset and will make predictions on the test dataset.</p>
<p>The persistence forecast (naive forecast) on the test dataset achieves an error of 136.761 monthly shampoo sales. This provides a lower acceptable bound of performance on the test set.</p>
<h3>Model Evaluation</h3>
<p>A rolling-forecast scenario will be used, also called walk-forward model validation.</p>
<p>Each time step of the test dataset will be walked one at a time. A model will be used to make a forecast for the time step, then the actual expected value from the test set will be taken and made available to the model for the forecast on the next time step.</p>
<p>This mimics a real-world scenario where new Shampoo Sales observations would be available each month and used in the forecasting of the following month.</p>
<p>This will be simulated by the structure of the train and test datasets.</p>
<p>All forecasts on the test dataset will be collected and an error score calculated to summarize the skill of the model. The root mean squared error (RMSE) will be used as it punishes large errors and results in a score that is in the same units as the forecast data, namely monthly shampoo sales.</p>
<h3>Data Preparation</h3>
<p>Before we can fit a model to the dataset, we must transform the data.</p>
<p>The following three data transforms are performed on the dataset prior to fitting a model and making a forecast.</p>
<ol>
<li>Transform the time series data so that it is stationary. Specifically, a lag=1 differencing to remove the increasing trend in the data.</li>
<li>Transform the time series into a supervised learning problem. Specifically, the organization of data into input and output patterns where the observation at the previous time step is used as an input to forecast the observation at the current timestep</li>
<li>Transform the observations to have a specific scale. Specifically, to rescale the data to values between -1 and 1.</li>
</ol>
<p>These transforms are inverted on forecasts to return them into their original scale before calculating and error score.</p>
<h3>LSTM Model</h3>
<p>We will use a base stateful LSTM model with 1 neuron fit for 1000 epochs.</p>
<p> </p>
<p>Ideally a batch size of 1 would be used for walk-foward validation. We will assume walk-forward validation and predict the whole year for speed. As such we can use any batch size that is divisble by the number of samples, in this case we will use a value of 4.</p>
<p>Ideally, more training epochs would be used (such as 1500), but this was truncated to 1000 to keep run times reasonable.</p>
<p>The model will be fit using the efficient ADAM optimization algorithm and the mean squared error loss function.</p>
<h3>Experimental Runs</h3>
<p>Each experimental scenario will be run 30 times and the RMSE score on the test set will be recorded from the end each run.</p>
<p>Let’s dive into the experiments.</p>
<h2>Baseline LSTM Model</h2>
<p>Let’s start-off with the baseline LSTM model.</p>
<p>The baseline LSTM model for this problem has the following configuration:</p>
<ul>
<li>Lag inputs: 1</li>
<li>Epochs: 1000</li>
<li>Units in LSTM hidden layer: 3</li>
<li>Batch Size: 4</li>
<li>Repeats: 3</li>
</ul>
<p>The complete code listing is provided below.</p>
<p>This code listing will be used as the basis for all following experiments, with only the changes to this code provided in subsequent sections.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a65919c5c52c781413778" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from pandas import DataFrame
from pandas import Series
from pandas import concat
from pandas import read_csv
from pandas import datetime
from sklearn.metrics import mean_squared_error
from sklearn.preprocessing import MinMaxScaler
from keras.models import Sequential
from keras.layers import Dense
from keras.layers import LSTM
from keras.regularizers import L1L2
from math import sqrt
import matplotlib
# be able to save images on server
matplotlib.use('Agg')
from matplotlib import pyplot
import numpy

# date-time parsing function for loading the dataset
def parser(x):
	return datetime.strptime('190'+x, '%Y-%m')

# frame a sequence as a supervised learning problem
def timeseries_to_supervised(data, lag=1):
	df = DataFrame(data)
	columns = [df.shift(i) for i in range(1, lag+1)]
	columns.append(df)
	df = concat(columns, axis=1)
	return df

# create a differenced series
def difference(dataset, interval=1):
	diff = list()
	for i in range(interval, len(dataset)):
		value = dataset[i] - dataset[i - interval]
		diff.append(value)
	return Series(diff)

# invert differenced value
def inverse_difference(history, yhat, interval=1):
	return yhat + history[-interval]

# scale train and test data to [-1, 1]
def scale(train, test):
	# fit scaler
	scaler = MinMaxScaler(feature_range=(-1, 1))
	scaler = scaler.fit(train)
	# transform train
	train = train.reshape(train.shape[0], train.shape[1])
	train_scaled = scaler.transform(train)
	# transform test
	test = test.reshape(test.shape[0], test.shape[1])
	test_scaled = scaler.transform(test)
	return scaler, train_scaled, test_scaled

# inverse scaling for a forecasted value
def invert_scale(scaler, X, yhat):
	new_row = [x for x in X] + [yhat]
	array = numpy.array(new_row)
	array = array.reshape(1, len(array))
	inverted = scaler.inverse_transform(array)
	return inverted[0, -1]

# fit an LSTM network to training data
def fit_lstm(train, n_batch, nb_epoch, n_neurons):
	X, y = train[:, 0:-1], train[:, -1]
	X = X.reshape(X.shape[0], 1, X.shape[1])
	model = Sequential()
	model.add(LSTM(n_neurons, batch_input_shape=(n_batch, X.shape[1], X.shape[2]), stateful=True))
	model.add(Dense(1))
	model.compile(loss='mean_squared_error', optimizer='adam')
	for i in range(nb_epoch):
		model.fit(X, y, epochs=1, batch_size=n_batch, verbose=0, shuffle=False)
		model.reset_states()
	return model

# run a repeated experiment
def experiment(series, n_lag, n_repeats, n_epochs, n_batch, n_neurons):
	# transform data to be stationary
	raw_values = series.values
	diff_values = difference(raw_values, 1)
	# transform data to be supervised learning
	supervised = timeseries_to_supervised(diff_values, n_lag)
	supervised_values = supervised.values[n_lag:,:]
	# split data into train and test-sets
	train, test = supervised_values[0:-12], supervised_values[-12:]
	# transform the scale of the data
	scaler, train_scaled, test_scaled = scale(train, test)
	# run experiment
	error_scores = list()
	for r in range(n_repeats):
		# fit the model
		train_trimmed = train_scaled[2:, :]
		lstm_model = fit_lstm(train_trimmed, n_batch, n_epochs, n_neurons)
		# forecast test dataset
		test_reshaped = test_scaled[:,0:-1]
		test_reshaped = test_reshaped.reshape(len(test_reshaped), 1, 1)
		output = lstm_model.predict(test_reshaped, batch_size=n_batch)
		predictions = list()
		for i in range(len(output)):
			yhat = output[i,0]
			X = test_scaled[i, 0:-1]
			# invert scaling
			yhat = invert_scale(scaler, X, yhat)
			# invert differencing
			yhat = inverse_difference(raw_values, yhat, len(test_scaled)+1-i)
			# store forecast
			predictions.append(yhat)
		# report performance
		rmse = sqrt(mean_squared_error(raw_values[-12:], predictions))
		print('%d) Test RMSE: %.3f' % (r+1, rmse))
		error_scores.append(rmse)
	return error_scores

# configure the experiment
def run():
	# load dataset
	series = read_csv('shampoo-sales.csv', header=0, parse_dates=[0], index_col=0, squeeze=True, date_parser=parser)
	# configure the experiment
	n_lag = 1
	n_repeats = 30
	n_epochs = 1000
	n_batch = 4
	n_neurons = 3
	# run the experiment
	results = DataFrame()
	results['results'] = experiment(series, n_lag, n_repeats, n_epochs, n_batch, n_neurons)
	# summarize results
	print(results.describe())
	# save boxplot
	results.boxplot()
	pyplot.savefig('experiment_baseline.png')

# entry point
run()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-2">2</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-4">4</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-6">6</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-8">8</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-10">10</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-12">12</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-14">14</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-16">16</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-18">18</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-20">20</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-22">22</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-24">24</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-26">26</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-28">28</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-30">30</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-32">32</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-34">34</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-36">36</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-38">38</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-40">40</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-42">42</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-44">44</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-46">46</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-48">48</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-50">50</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-52">52</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-54">54</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-56">56</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-58">58</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-60">60</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-62">62</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-64">64</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-66">66</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-68">68</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-70">70</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-72">72</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-74">74</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-76">76</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-78">78</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-80">80</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-82">82</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-84">84</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-86">86</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-88">88</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-90">90</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-92">92</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-94">94</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-96">96</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-98">98</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-100">100</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-102">102</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-104">104</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-106">106</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-108">108</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-110">110</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-112">112</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-114">114</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-116">116</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-118">118</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-120">120</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-122">122</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-124">124</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-126">126</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-128">128</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-130">130</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-131">131</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-132">132</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-133">133</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c52c781413778-134">134</div><div class="crayon-num" data-line="crayon-5a65919c5c52c781413778-135">135</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a65919c5c52c781413778-1"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">DataFrame</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-2"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">Series</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-3"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">concat</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-4"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-5"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">datetime</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-6"><span class="crayon-e">from </span><span class="crayon-v">sklearn</span><span class="crayon-sy">.</span><span class="crayon-e">metrics </span><span class="crayon-e">import </span><span class="crayon-e">mean_squared_error</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-7"><span class="crayon-e">from </span><span class="crayon-v">sklearn</span><span class="crayon-sy">.</span><span class="crayon-e">preprocessing </span><span class="crayon-e">import </span><span class="crayon-e">MinMaxScaler</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Sequential</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dense</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-10"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">LSTM</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-11"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">regularizers </span><span class="crayon-e">import </span><span class="crayon-e">L1L2</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-12"><span class="crayon-e">from </span><span class="crayon-e">math </span><span class="crayon-e">import </span><span class="crayon-e">sqrt</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-13"><span class="crayon-e">import </span><span class="crayon-v">matplotlib</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-14"><span class="crayon-p"># be able to save images on server</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-15"><span class="crayon-v">matplotlib</span><span class="crayon-sy">.</span><span class="crayon-st">use</span><span class="crayon-sy">(</span><span class="crayon-s">'Agg'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-16"><span class="crayon-e">from </span><span class="crayon-e">matplotlib </span><span class="crayon-e">import </span><span class="crayon-e">pyplot</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-17"><span class="crayon-e">import </span><span class="crayon-v">numpy</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-18"> </div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-19"><span class="crayon-p"># date-time parsing function for loading the dataset</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-20"><span class="crayon-e">def </span><span class="crayon-e">parser</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-21"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">datetime</span><span class="crayon-sy">.</span><span class="crayon-e">strptime</span><span class="crayon-sy">(</span><span class="crayon-s">'190'</span><span class="crayon-o">+</span><span class="crayon-v">x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'%Y-%m'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-22"> </div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-23"><span class="crayon-p"># frame a sequence as a supervised learning problem</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-24"><span class="crayon-e">def </span><span class="crayon-e">timeseries_to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">lag</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-25"><span class="crayon-h"> </span><span class="crayon-v">df</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-26"><span class="crayon-h"> </span><span class="crayon-v">columns</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">df</span><span class="crayon-sy">.</span><span class="crayon-e">shift</span><span class="crayon-sy">(</span><span class="crayon-v">i</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">lag</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-27"><span class="crayon-h"> </span><span class="crayon-v">columns</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">df</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-28"><span class="crayon-h"> </span><span class="crayon-v">df</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concat</span><span class="crayon-sy">(</span><span class="crayon-v">columns</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">axis</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-29"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">df</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-30"> </div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-31"><span class="crayon-p"># create a differenced series</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-32"><span class="crayon-e">def </span><span class="crayon-e">difference</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">interval</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-33"><span class="crayon-h"> </span><span class="crayon-v">diff</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-34"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">interval</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-35"><span class="crayon-h"> </span><span class="crayon-v">value</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">interval</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-36"><span class="crayon-h"> </span><span class="crayon-v">diff</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">value</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-37"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">Series</span><span class="crayon-sy">(</span><span class="crayon-v">diff</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-38"> </div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-39"><span class="crayon-p"># invert differenced value</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-40"><span class="crayon-e">def </span><span class="crayon-e">inverse_difference</span><span class="crayon-sy">(</span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">interval</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-41"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">interval</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-42"> </div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-43"><span class="crayon-p"># scale train and test data to [-1, 1]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-44"><span class="crayon-e">def </span><span class="crayon-e">scale</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-45"><span class="crayon-h"> </span><span class="crayon-p"># fit scaler</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-46"><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">MinMaxScaler</span><span class="crayon-sy">(</span><span class="crayon-v">feature_range</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-47"><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-48"><span class="crayon-h"> </span><span class="crayon-p"># transform train</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-49"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-50"><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">.</span><span class="crayon-e">transform</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-51"><span class="crayon-h"> </span><span class="crayon-p"># transform test</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-52"><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-53"><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">.</span><span class="crayon-e">transform</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-54"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-55"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-56"><span class="crayon-p"># inverse scaling for a forecasted value</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-57"><span class="crayon-e">def </span><span class="crayon-e">invert_scale</span><span class="crayon-sy">(</span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-58"><span class="crayon-h"> </span><span class="crayon-v">new_row</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">yhat</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-59"><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">numpy</span><span class="crayon-sy">.</span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">new_row</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-60"><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-t">array</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-61"><span class="crayon-h"> </span><span class="crayon-v">inverted</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">.</span><span class="crayon-e">inverse_transform</span><span class="crayon-sy">(</span><span class="crayon-t">array</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-62"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">inverted</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-63"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-64"><span class="crayon-p"># fit an LSTM network to training data</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-65"><span class="crayon-e">def </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-66"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-67"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-68"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-69"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">stateful</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-70"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-71"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mean_squared_error'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-72"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-73"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">shuffle</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-74"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">reset_states</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-75"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-76"> </div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-77"><span class="crayon-p"># run a repeated experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-78"><span class="crayon-e">def </span><span class="crayon-e">experiment</span><span class="crayon-sy">(</span><span class="crayon-v">series</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_repeats</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-79"><span class="crayon-h"> </span><span class="crayon-p"># transform data to be stationary</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-80"><span class="crayon-h"> </span><span class="crayon-v">raw_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-sy">.</span><span class="crayon-e">values</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-81"><span class="crayon-e"> </span><span class="crayon-v">diff_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">difference</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-82"><span class="crayon-h"> </span><span class="crayon-p"># transform data to be supervised learning</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-83"><span class="crayon-h"> </span><span class="crayon-v">supervised</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">timeseries_to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">diff_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-84"><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">supervised</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-v">n_lag</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-85"><span class="crayon-h"> </span><span class="crayon-p"># split data into train and test-sets</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-86"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-87"><span class="crayon-h"> </span><span class="crayon-p"># transform the scale of the data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-88"><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">scale</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-89"><span class="crayon-h"> </span><span class="crayon-p"># run experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-90"><span class="crayon-h"> </span><span class="crayon-v">error_scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-91"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">r</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_repeats</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-92"><span class="crayon-h"> </span><span class="crayon-p"># fit the model</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-93"><span class="crayon-h"> </span><span class="crayon-v">train_trimmed</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-94"><span class="crayon-h"> </span><span class="crayon-v">lstm_model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train_trimmed</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-95"><span class="crayon-h"> </span><span class="crayon-p"># forecast test dataset</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-96"><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-97"><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-98"><span class="crayon-h"> </span><span class="crayon-v">output</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">lstm_model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">n_batch</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-99"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-100"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">output</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-101"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">output</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-102"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-103"><span class="crayon-h"> </span><span class="crayon-p"># invert scaling</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-104"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">invert_scale</span><span class="crayon-sy">(</span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-105"><span class="crayon-h"> </span><span class="crayon-p"># invert differencing</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-106"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">inverse_difference</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_scaled</span><span class="crayon-sy">)</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-o">-</span><span class="crayon-v">i</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-107"><span class="crayon-h"> </span><span class="crayon-p"># store forecast</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-108"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-109"><span class="crayon-h"> </span><span class="crayon-p"># report performance</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-110"><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-e">mean_squared_error</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-111"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'%d) Test RMSE: %.3f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">r</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-112"><span class="crayon-h"> </span><span class="crayon-v">error_scores</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-113"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">error_scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-114"> </div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-115"><span class="crayon-p"># configure the experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-116"><span class="crayon-e">def </span><span class="crayon-e">run</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-117"><span class="crayon-h"> </span><span class="crayon-p"># load dataset</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-118"><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'shampoo-sales.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">squeeze</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">date_parser</span><span class="crayon-o">=</span><span class="crayon-v">parser</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-119"><span class="crayon-h"> </span><span class="crayon-p"># configure the experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-120"><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-121"><span class="crayon-h"> </span><span class="crayon-v">n_repeats</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">30</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-122"><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1000</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-123"><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">4</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-124"><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">3</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-125"><span class="crayon-h"> </span><span class="crayon-p"># run the experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-126"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-127"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-s">'results'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">experiment</span><span class="crayon-sy">(</span><span class="crayon-v">series</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_repeats</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-128"><span class="crayon-h"> </span><span class="crayon-p"># summarize results</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-129"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">describe</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-130"><span class="crayon-h"> </span><span class="crayon-p"># save boxplot</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-131"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">boxplot</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-132"><span class="crayon-h"> </span><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">savefig</span><span class="crayon-sy">(</span><span class="crayon-s">'experiment_baseline.png'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-133"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c52c781413778-134"><span class="crayon-p"># entry point</span></div><div class="crayon-line" id="crayon-5a65919c5c52c781413778-135"><span class="crayon-e">run</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0111 seconds] -->
<p>Running the experiment prints summary statistics for the test RMSE for all repeats.</p>
<p>We can see that on average, this model configuration achieves a test RMSE of about 92 monthly shampoo sales with a standard deviation of 5.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a65919c5c532715944236" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
          results
count   30.000000
mean    92.842537
std      5.748456
min     81.205979
25%     89.514367
50%     92.030003
75%     96.926145
max    105.247117</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a65919c5c532715944236-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c532715944236-2">2</div><div class="crayon-num" data-line="crayon-5a65919c5c532715944236-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c532715944236-4">4</div><div class="crayon-num" data-line="crayon-5a65919c5c532715944236-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c532715944236-6">6</div><div class="crayon-num" data-line="crayon-5a65919c5c532715944236-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c532715944236-8">8</div><div class="crayon-num" data-line="crayon-5a65919c5c532715944236-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a65919c5c532715944236-1">          results</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c532715944236-2">count   30.000000</div><div class="crayon-line" id="crayon-5a65919c5c532715944236-3">mean    92.842537</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c532715944236-4">std      5.748456</div><div class="crayon-line" id="crayon-5a65919c5c532715944236-5">min     81.205979</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c532715944236-6">25%     89.514367</div><div class="crayon-line" id="crayon-5a65919c5c532715944236-7">50%     92.030003</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c532715944236-8">75%     96.926145</div><div class="crayon-line" id="crayon-5a65919c5c532715944236-9">max    105.247117</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>A box and whisker plot is also created from the distribution of test RMSE results and saved to a file.</p>
<p>The plot provides a clear depiction of the spread of the results, highlighting the middle 50% of values (the box) and the median (green line).</p>
<div class="wp-caption aligncenter" id="attachment_3953" style="max-width: 650px"><img alt="Box and Whisker Plot of Baseline Performance on the Shampoo Sales Dataset" class="size-full wp-image-3953" height="480" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-Baseline-Performance-on-the-Shampoo-Sales-Dataset.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-Baseline-Performance-on-the-Shampoo-Sales-Dataset.png 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-Baseline-Performance-on-the-Shampoo-Sales-Dataset-300x225.png 300w" width="640"/><p class="wp-caption-text">Box and Whisker Plot of Baseline Performance on the Shampoo Sales Dataset</p></div>
<h2>Bias Weight Regularization</h2>
<p>Weight regularization can be applied to the bias connection within the LSTM nodes.</p>
<p>In Keras, this is specified with a <em>bias_regularizer</em> argument when creating an LSTM layer. The regularizer is defined as an instance of the one of the L1, L2, or L1L2 classes.</p>
<p>More details here:</p>
<ul>
<li><a href="https://keras.io/regularizers/">Keras Usage of Regularizers</a></li>
</ul>
<p>In this experiment, we will compare L1, L2, and L1L2 with a default value of 0.01 against the baseline model. We can specify all configurations using the L1L2 class, as follows:</p>
<ul>
<li>L1L2(0.0, 0.0) [e.g. baseline]</li>
<li>L1L2(0.01, 0.0) [e.g. L1]</li>
<li>L1L2(0.0, 0.01) [e.g. L2]</li>
<li>L1L2(0.01, 0.01) [e.g. L1L2 or elasticnet]</li>
</ul>
<p>Below lists the updated <em>fit_lstm()</em>, <em>experiment()</em>, and <em>run()</em> functions for using bias weight regularization with LSTMs.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a65919c5c536660665934" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# fit an LSTM network to training data
def fit_lstm(train, n_batch, nb_epoch, n_neurons, reg):
	X, y = train[:, 0:-1], train[:, -1]
	X = X.reshape(X.shape[0], 1, X.shape[1])
	model = Sequential()
	model.add(LSTM(n_neurons, batch_input_shape=(n_batch, X.shape[1], X.shape[2]), stateful=True, bias_regularizer=reg))
	model.add(Dense(1))
	model.compile(loss='mean_squared_error', optimizer='adam')
	for i in range(nb_epoch):
		model.fit(X, y, epochs=1, batch_size=n_batch, verbose=0, shuffle=False)
		model.reset_states()
	return model

# run a repeated experiment
def experiment(series, n_lag, n_repeats, n_epochs, n_batch, n_neurons, reg):
	# transform data to be stationary
	raw_values = series.values
	diff_values = difference(raw_values, 1)
	# transform data to be supervised learning
	supervised = timeseries_to_supervised(diff_values, n_lag)
	supervised_values = supervised.values[n_lag:,:]
	# split data into train and test-sets
	train, test = supervised_values[0:-12], supervised_values[-12:]
	# transform the scale of the data
	scaler, train_scaled, test_scaled = scale(train, test)
	# run experiment
	error_scores = list()
	for r in range(n_repeats):
		# fit the model
		train_trimmed = train_scaled[2:, :]
		lstm_model = fit_lstm(train_trimmed, n_batch, n_epochs, n_neurons, reg)
		# forecast test dataset
		test_reshaped = test_scaled[:,0:-1]
		test_reshaped = test_reshaped.reshape(len(test_reshaped), 1, 1)
		output = lstm_model.predict(test_reshaped, batch_size=n_batch)
		predictions = list()
		for i in range(len(output)):
			yhat = output[i,0]
			X = test_scaled[i, 0:-1]
			# invert scaling
			yhat = invert_scale(scaler, X, yhat)
			# invert differencing
			yhat = inverse_difference(raw_values, yhat, len(test_scaled)+1-i)
			# store forecast
			predictions.append(yhat)
		# report performance
		rmse = sqrt(mean_squared_error(raw_values[-12:], predictions))
		print('%d) Test RMSE: %.3f' % (r+1, rmse))
		error_scores.append(rmse)
	return error_scores

# configure the experiment
def run():
	# load dataset
	series = read_csv('shampoo-sales.csv', header=0, parse_dates=[0], index_col=0, squeeze=True, date_parser=parser)
	# configure the experiment
	n_lag = 1
	n_repeats = 30
	n_epochs = 1000
	n_batch = 4
	n_neurons = 3
	regularizers = [L1L2(l1=0.0, l2=0.0), L1L2(l1=0.01, l2=0.0), L1L2(l1=0.0, l2=0.01), L1L2(l1=0.01, l2=0.01)]
	# run the experiment
	results = DataFrame()
	for reg in regularizers:
		name = ('l1 %.2f,l2 %.2f' % (reg.l1, reg.l2))
		results[name] = experiment(series, n_lag, n_repeats, n_epochs, n_batch, n_neurons, reg)
	# summarize results
	print(results.describe())
	# save boxplot
	results.boxplot()
	pyplot.savefig('experiment_reg_bias.png')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-2">2</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-4">4</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-6">6</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-8">8</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-10">10</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-12">12</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-14">14</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-16">16</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-18">18</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-20">20</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-22">22</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-24">24</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-26">26</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-28">28</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-30">30</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-32">32</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-34">34</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-36">36</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-38">38</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-40">40</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-42">42</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-44">44</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-46">46</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-48">48</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-50">50</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-52">52</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-54">54</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-56">56</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-58">58</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-60">60</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-62">62</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-64">64</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-66">66</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-68">68</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-70">70</div><div class="crayon-num" data-line="crayon-5a65919c5c536660665934-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c536660665934-72">72</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a65919c5c536660665934-1"><span class="crayon-p"># fit an LSTM network to training data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-2"><span class="crayon-e">def </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-3"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-4"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-5"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-6"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">stateful</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">bias_regularizer</span><span class="crayon-o">=</span><span class="crayon-v">reg</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-7"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-8"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mean_squared_error'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-9"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-10"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">shuffle</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-11"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">reset_states</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-12"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-13"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-14"><span class="crayon-p"># run a repeated experiment</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-15"><span class="crayon-e">def </span><span class="crayon-e">experiment</span><span class="crayon-sy">(</span><span class="crayon-v">series</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_repeats</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-16"><span class="crayon-h"> </span><span class="crayon-p"># transform data to be stationary</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-17"><span class="crayon-h"> </span><span class="crayon-v">raw_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-sy">.</span><span class="crayon-e">values</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-18"><span class="crayon-e"> </span><span class="crayon-v">diff_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">difference</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-19"><span class="crayon-h"> </span><span class="crayon-p"># transform data to be supervised learning</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-20"><span class="crayon-h"> </span><span class="crayon-v">supervised</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">timeseries_to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">diff_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-21"><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">supervised</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-v">n_lag</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-22"><span class="crayon-h"> </span><span class="crayon-p"># split data into train and test-sets</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-23"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-24"><span class="crayon-h"> </span><span class="crayon-p"># transform the scale of the data</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-25"><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">scale</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-26"><span class="crayon-h"> </span><span class="crayon-p"># run experiment</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-27"><span class="crayon-h"> </span><span class="crayon-v">error_scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-28"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">r</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_repeats</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-29"><span class="crayon-h"> </span><span class="crayon-p"># fit the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-30"><span class="crayon-h"> </span><span class="crayon-v">train_trimmed</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-31"><span class="crayon-h"> </span><span class="crayon-v">lstm_model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train_trimmed</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-32"><span class="crayon-h"> </span><span class="crayon-p"># forecast test dataset</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-33"><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-34"><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-35"><span class="crayon-h"> </span><span class="crayon-v">output</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">lstm_model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">n_batch</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-36"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-37"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">output</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-38"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">output</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-39"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-40"><span class="crayon-h"> </span><span class="crayon-p"># invert scaling</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-41"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">invert_scale</span><span class="crayon-sy">(</span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-42"><span class="crayon-h"> </span><span class="crayon-p"># invert differencing</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-43"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">inverse_difference</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_scaled</span><span class="crayon-sy">)</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-o">-</span><span class="crayon-v">i</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-44"><span class="crayon-h"> </span><span class="crayon-p"># store forecast</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-45"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-46"><span class="crayon-h"> </span><span class="crayon-p"># report performance</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-47"><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-e">mean_squared_error</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-48"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'%d) Test RMSE: %.3f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">r</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-49"><span class="crayon-h"> </span><span class="crayon-v">error_scores</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-50"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">error_scores</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-51"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-52"><span class="crayon-p"># configure the experiment</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-53"><span class="crayon-e">def </span><span class="crayon-e">run</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-54"><span class="crayon-h"> </span><span class="crayon-p"># load dataset</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-55"><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'shampoo-sales.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">squeeze</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">date_parser</span><span class="crayon-o">=</span><span class="crayon-v">parser</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-56"><span class="crayon-h"> </span><span class="crayon-p"># configure the experiment</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-57"><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-58"><span class="crayon-h"> </span><span class="crayon-v">n_repeats</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">30</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-59"><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1000</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-60"><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">4</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-61"><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">3</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-62"><span class="crayon-h"> </span><span class="crayon-v">regularizers</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">L1L2</span><span class="crayon-sy">(</span><span class="crayon-v">l1</span><span class="crayon-o">=</span><span class="crayon-cn">0.0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">l2</span><span class="crayon-o">=</span><span class="crayon-cn">0.0</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">L1L2</span><span class="crayon-sy">(</span><span class="crayon-v">l1</span><span class="crayon-o">=</span><span class="crayon-cn">0.01</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">l2</span><span class="crayon-o">=</span><span class="crayon-cn">0.0</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">L1L2</span><span class="crayon-sy">(</span><span class="crayon-v">l1</span><span class="crayon-o">=</span><span class="crayon-cn">0.0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">l2</span><span class="crayon-o">=</span><span class="crayon-cn">0.01</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">L1L2</span><span class="crayon-sy">(</span><span class="crayon-v">l1</span><span class="crayon-o">=</span><span class="crayon-cn">0.01</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">l2</span><span class="crayon-o">=</span><span class="crayon-cn">0.01</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-63"><span class="crayon-h"> </span><span class="crayon-p"># run the experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-64"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-65"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">reg </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">regularizers</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-66"><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-s">'l1 %.2f,l2 %.2f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">reg</span><span class="crayon-sy">.</span><span class="crayon-v">l1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">.</span><span class="crayon-v">l2</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-67"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-v">name</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">experiment</span><span class="crayon-sy">(</span><span class="crayon-v">series</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_repeats</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-68"><span class="crayon-h"> </span><span class="crayon-p"># summarize results</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-69"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">describe</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-70"><span class="crayon-h"> </span><span class="crayon-p"># save boxplot</span></div><div class="crayon-line" id="crayon-5a65919c5c536660665934-71"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">boxplot</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c536660665934-72"><span class="crayon-h"> </span><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">savefig</span><span class="crayon-sy">(</span><span class="crayon-s">'experiment_reg_bias.png'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0074 seconds] -->
<p>Running this experiment prints descriptive statistics for each evaluated configuration.</p>
<p>The results suggest that on average, the default of no bias regularization results in better performance compared to all of the other configurations considered.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a65919c5c53b565099197" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
       l1 0.00,l2 0.00  l1 0.01,l2 0.00  l1 0.00,l2 0.01  l1 0.01,l2 0.01
count        30.000000        30.000000        30.000000        30.000000
mean         92.821489        95.520003        93.285389        92.901021
std           4.894166         3.637022         3.906112         5.082358
min          81.394504        89.477398        82.994480        78.729224
25%          89.356330        93.017723        90.907343        91.210105
50%          92.822871        95.502700        93.837562        94.525965
75%          95.899939        98.195980        95.426270        96.882378
max         101.194678       101.750900       100.650130        97.766301</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a65919c5c53b565099197-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53b565099197-2">2</div><div class="crayon-num" data-line="crayon-5a65919c5c53b565099197-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53b565099197-4">4</div><div class="crayon-num" data-line="crayon-5a65919c5c53b565099197-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53b565099197-6">6</div><div class="crayon-num" data-line="crayon-5a65919c5c53b565099197-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53b565099197-8">8</div><div class="crayon-num" data-line="crayon-5a65919c5c53b565099197-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a65919c5c53b565099197-1">       l1 0.00,l2 0.00  l1 0.01,l2 0.00  l1 0.00,l2 0.01  l1 0.01,l2 0.01</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53b565099197-2">count        30.000000        30.000000        30.000000        30.000000</div><div class="crayon-line" id="crayon-5a65919c5c53b565099197-3">mean         92.821489        95.520003        93.285389        92.901021</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53b565099197-4">std           4.894166         3.637022         3.906112         5.082358</div><div class="crayon-line" id="crayon-5a65919c5c53b565099197-5">min          81.394504        89.477398        82.994480        78.729224</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53b565099197-6">25%          89.356330        93.017723        90.907343        91.210105</div><div class="crayon-line" id="crayon-5a65919c5c53b565099197-7">50%          92.822871        95.502700        93.837562        94.525965</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53b565099197-8">75%          95.899939        98.195980        95.426270        96.882378</div><div class="crayon-line" id="crayon-5a65919c5c53b565099197-9">max         101.194678       101.750900       100.650130        97.766301</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>A box and whisker plot is also created to compare the distributions of results for each configuration.</p>
<p>The plot shows that all configurations have about the same spread and that the addition of bias regularization uniformly was not helpful on this problem.</p>
<div class="wp-caption aligncenter" id="attachment_3979" style="max-width: 650px"><img alt="Box and Whisker Plots of Bias Weight Regularization Performance on the Shampoo Sales Dataset" class="size-full wp-image-3979" height="480" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plots-of-Bias-Weight-Regularization-Performance-on-the-Shampoo-Sales-Dataset.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plots-of-Bias-Weight-Regularization-Performance-on-the-Shampoo-Sales-Dataset.png 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plots-of-Bias-Weight-Regularization-Performance-on-the-Shampoo-Sales-Dataset-300x225.png 300w" width="640"/><p class="wp-caption-text">Box and Whisker Plots of Bias Weight Regularization Performance on the Shampoo Sales Dataset</p></div>
<h2>Input Weight Regularization</h2>
<p>We can also apply regularization to input connections on each LSTM unit.</p>
<p>In Keras, this is achieved by setting the <em>kernel_regularizer</em> argument to a regularizer class.</p>
<p>We will test the same regularizer configurations as were used in the previous section, specifically:</p>
<ul>
<li>L1L2(0.0, 0.0) [e.g. baseline]</li>
<li>L1L2(0.01, 0.0) [e.g. L1]</li>
<li>L1L2(0.0, 0.01) [e.g. L2]</li>
<li>L1L2(0.01, 0.01) [e.g. L1L2 or elasticnet]</li>
</ul>
<p>Below lists the updated <em>fit_lstm()</em>, <em>experiment()</em>, and <em>run()</em> functions for using bias weight regularization with LSTMs.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a65919c5c53e935373374" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# fit an LSTM network to training data
def fit_lstm(train, n_batch, nb_epoch, n_neurons, reg):
	X, y = train[:, 0:-1], train[:, -1]
	X = X.reshape(X.shape[0], 1, X.shape[1])
	model = Sequential()
	model.add(LSTM(n_neurons, batch_input_shape=(n_batch, X.shape[1], X.shape[2]), stateful=True, kernel_regularizer=reg))
	model.add(Dense(1))
	model.compile(loss='mean_squared_error', optimizer='adam')
	for i in range(nb_epoch):
		model.fit(X, y, epochs=1, batch_size=n_batch, verbose=0, shuffle=False)
		model.reset_states()
	return model

# run a repeated experiment
def experiment(series, n_lag, n_repeats, n_epochs, n_batch, n_neurons, reg):
	# transform data to be stationary
	raw_values = series.values
	diff_values = difference(raw_values, 1)
	# transform data to be supervised learning
	supervised = timeseries_to_supervised(diff_values, n_lag)
	supervised_values = supervised.values[n_lag:,:]
	# split data into train and test-sets
	train, test = supervised_values[0:-12], supervised_values[-12:]
	# transform the scale of the data
	scaler, train_scaled, test_scaled = scale(train, test)
	# run experiment
	error_scores = list()
	for r in range(n_repeats):
		# fit the model
		train_trimmed = train_scaled[2:, :]
		lstm_model = fit_lstm(train_trimmed, n_batch, n_epochs, n_neurons, reg)
		# forecast test dataset
		test_reshaped = test_scaled[:,0:-1]
		test_reshaped = test_reshaped.reshape(len(test_reshaped), 1, 1)
		output = lstm_model.predict(test_reshaped, batch_size=n_batch)
		predictions = list()
		for i in range(len(output)):
			yhat = output[i,0]
			X = test_scaled[i, 0:-1]
			# invert scaling
			yhat = invert_scale(scaler, X, yhat)
			# invert differencing
			yhat = inverse_difference(raw_values, yhat, len(test_scaled)+1-i)
			# store forecast
			predictions.append(yhat)
		# report performance
		rmse = sqrt(mean_squared_error(raw_values[-12:], predictions))
		print('%d) Test RMSE: %.3f' % (r+1, rmse))
		error_scores.append(rmse)
	return error_scores

# configure the experiment
def run():
	# load dataset
	series = read_csv('shampoo-sales.csv', header=0, parse_dates=[0], index_col=0, squeeze=True, date_parser=parser)
	# configure the experiment
	n_lag = 1
	n_repeats = 30
	n_epochs = 1000
	n_batch = 4
	n_neurons = 3
	regularizers = [L1L2(l1=0.0, l2=0.0), L1L2(l1=0.01, l2=0.0), L1L2(l1=0.0, l2=0.01), L1L2(l1=0.01, l2=0.01)]
	# run the experiment
	results = DataFrame()
	for reg in regularizers:
		name = ('l1 %.2f,l2 %.2f' % (reg.l1, reg.l2))
		results[name] = experiment(series, n_lag, n_repeats, n_epochs, n_batch, n_neurons, reg)
	# summarize results
	print(results.describe())
	# save boxplot
	results.boxplot()
	pyplot.savefig('experiment_reg_input.png')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-2">2</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-4">4</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-6">6</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-8">8</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-10">10</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-12">12</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-14">14</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-16">16</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-18">18</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-20">20</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-22">22</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-24">24</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-26">26</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-28">28</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-30">30</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-32">32</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-34">34</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-36">36</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-38">38</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-40">40</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-42">42</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-44">44</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-46">46</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-48">48</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-50">50</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-52">52</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-54">54</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-56">56</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-58">58</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-60">60</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-62">62</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-64">64</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-66">66</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-68">68</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-70">70</div><div class="crayon-num" data-line="crayon-5a65919c5c53e935373374-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c53e935373374-72">72</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a65919c5c53e935373374-1"><span class="crayon-p"># fit an LSTM network to training data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-2"><span class="crayon-e">def </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-3"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-4"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-5"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-6"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">stateful</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">kernel_regularizer</span><span class="crayon-o">=</span><span class="crayon-v">reg</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-7"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-8"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mean_squared_error'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-9"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-10"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">shuffle</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-11"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">reset_states</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-12"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-13"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-14"><span class="crayon-p"># run a repeated experiment</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-15"><span class="crayon-e">def </span><span class="crayon-e">experiment</span><span class="crayon-sy">(</span><span class="crayon-v">series</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_repeats</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-16"><span class="crayon-h"> </span><span class="crayon-p"># transform data to be stationary</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-17"><span class="crayon-h"> </span><span class="crayon-v">raw_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-sy">.</span><span class="crayon-e">values</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-18"><span class="crayon-e"> </span><span class="crayon-v">diff_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">difference</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-19"><span class="crayon-h"> </span><span class="crayon-p"># transform data to be supervised learning</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-20"><span class="crayon-h"> </span><span class="crayon-v">supervised</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">timeseries_to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">diff_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-21"><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">supervised</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-v">n_lag</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-22"><span class="crayon-h"> </span><span class="crayon-p"># split data into train and test-sets</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-23"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-24"><span class="crayon-h"> </span><span class="crayon-p"># transform the scale of the data</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-25"><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">scale</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-26"><span class="crayon-h"> </span><span class="crayon-p"># run experiment</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-27"><span class="crayon-h"> </span><span class="crayon-v">error_scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-28"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">r</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_repeats</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-29"><span class="crayon-h"> </span><span class="crayon-p"># fit the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-30"><span class="crayon-h"> </span><span class="crayon-v">train_trimmed</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-31"><span class="crayon-h"> </span><span class="crayon-v">lstm_model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train_trimmed</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-32"><span class="crayon-h"> </span><span class="crayon-p"># forecast test dataset</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-33"><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-34"><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-35"><span class="crayon-h"> </span><span class="crayon-v">output</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">lstm_model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">n_batch</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-36"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-37"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">output</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-38"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">output</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-39"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-40"><span class="crayon-h"> </span><span class="crayon-p"># invert scaling</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-41"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">invert_scale</span><span class="crayon-sy">(</span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-42"><span class="crayon-h"> </span><span class="crayon-p"># invert differencing</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-43"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">inverse_difference</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_scaled</span><span class="crayon-sy">)</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-o">-</span><span class="crayon-v">i</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-44"><span class="crayon-h"> </span><span class="crayon-p"># store forecast</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-45"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-46"><span class="crayon-h"> </span><span class="crayon-p"># report performance</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-47"><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-e">mean_squared_error</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-48"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'%d) Test RMSE: %.3f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">r</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-49"><span class="crayon-h"> </span><span class="crayon-v">error_scores</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-50"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">error_scores</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-51"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-52"><span class="crayon-p"># configure the experiment</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-53"><span class="crayon-e">def </span><span class="crayon-e">run</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-54"><span class="crayon-h"> </span><span class="crayon-p"># load dataset</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-55"><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'shampoo-sales.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">squeeze</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">date_parser</span><span class="crayon-o">=</span><span class="crayon-v">parser</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-56"><span class="crayon-h"> </span><span class="crayon-p"># configure the experiment</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-57"><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-58"><span class="crayon-h"> </span><span class="crayon-v">n_repeats</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">30</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-59"><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1000</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-60"><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">4</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-61"><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">3</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-62"><span class="crayon-h"> </span><span class="crayon-v">regularizers</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">L1L2</span><span class="crayon-sy">(</span><span class="crayon-v">l1</span><span class="crayon-o">=</span><span class="crayon-cn">0.0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">l2</span><span class="crayon-o">=</span><span class="crayon-cn">0.0</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">L1L2</span><span class="crayon-sy">(</span><span class="crayon-v">l1</span><span class="crayon-o">=</span><span class="crayon-cn">0.01</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">l2</span><span class="crayon-o">=</span><span class="crayon-cn">0.0</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">L1L2</span><span class="crayon-sy">(</span><span class="crayon-v">l1</span><span class="crayon-o">=</span><span class="crayon-cn">0.0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">l2</span><span class="crayon-o">=</span><span class="crayon-cn">0.01</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">L1L2</span><span class="crayon-sy">(</span><span class="crayon-v">l1</span><span class="crayon-o">=</span><span class="crayon-cn">0.01</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">l2</span><span class="crayon-o">=</span><span class="crayon-cn">0.01</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-63"><span class="crayon-h"> </span><span class="crayon-p"># run the experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-64"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-65"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">reg </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">regularizers</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-66"><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-s">'l1 %.2f,l2 %.2f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">reg</span><span class="crayon-sy">.</span><span class="crayon-v">l1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">.</span><span class="crayon-v">l2</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-67"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-v">name</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">experiment</span><span class="crayon-sy">(</span><span class="crayon-v">series</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_repeats</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-68"><span class="crayon-h"> </span><span class="crayon-p"># summarize results</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-69"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">describe</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-70"><span class="crayon-h"> </span><span class="crayon-p"># save boxplot</span></div><div class="crayon-line" id="crayon-5a65919c5c53e935373374-71"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">boxplot</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c53e935373374-72"><span class="crayon-h"> </span><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">savefig</span><span class="crayon-sy">(</span><span class="crayon-s">'experiment_reg_input.png'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0106 seconds] -->
<p>Running this experiment prints descriptive statistics for each evaluated configuration.</p>
<p>The results suggest that adding weight regularization to input connections does offer benefit across the board on this setup.</p>
<p>We can see that the test RMSE is approximately 10 units lower for all configurations with perhaps more benefit when both L1 and L2 are combined into an elasticnet type constraint.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a65919c5c542980371387" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
       l1 0.00,l2 0.00  l1 0.01,l2 0.00  l1 0.00,l2 0.01  l1 0.01,l2 0.01
count        30.000000        30.000000        30.000000        30.000000
mean         91.640028        82.118980        82.137198        80.471685
std           6.086401         4.116072         3.378984         2.212213
min          80.392310        75.705210        76.005173        76.550909
25%          88.025135        79.237822        79.698162        78.780802
50%          91.843761        81.235433        81.463882        80.283913
75%          94.860117        85.510177        84.563980        82.443390
max         105.820586        94.210503        90.823454        85.243135</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a65919c5c542980371387-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c542980371387-2">2</div><div class="crayon-num" data-line="crayon-5a65919c5c542980371387-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c542980371387-4">4</div><div class="crayon-num" data-line="crayon-5a65919c5c542980371387-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c542980371387-6">6</div><div class="crayon-num" data-line="crayon-5a65919c5c542980371387-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c542980371387-8">8</div><div class="crayon-num" data-line="crayon-5a65919c5c542980371387-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a65919c5c542980371387-1">       l1 0.00,l2 0.00  l1 0.01,l2 0.00  l1 0.00,l2 0.01  l1 0.01,l2 0.01</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c542980371387-2">count        30.000000        30.000000        30.000000        30.000000</div><div class="crayon-line" id="crayon-5a65919c5c542980371387-3">mean         91.640028        82.118980        82.137198        80.471685</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c542980371387-4">std           6.086401         4.116072         3.378984         2.212213</div><div class="crayon-line" id="crayon-5a65919c5c542980371387-5">min          80.392310        75.705210        76.005173        76.550909</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c542980371387-6">25%          88.025135        79.237822        79.698162        78.780802</div><div class="crayon-line" id="crayon-5a65919c5c542980371387-7">50%          91.843761        81.235433        81.463882        80.283913</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c542980371387-8">75%          94.860117        85.510177        84.563980        82.443390</div><div class="crayon-line" id="crayon-5a65919c5c542980371387-9">max         105.820586        94.210503        90.823454        85.243135</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>A box and whisker plot is also created to compare the distributions of results for each configuration.</p>
<p>The plot shows the general lower distribution of error for input regularization. The results also suggest a tighter spread of results with regularization that may be more pronounced with the L1L2 configuration that achieved the better results.</p>
<p>This is an encouraging finding, suggesting that additional experiments with different L1L2 values for input regularization would be well worth investigating.</p>
<div class="wp-caption aligncenter" id="attachment_3980" style="max-width: 650px"><img alt="Box and Whisker Plots of Input Weight Regularization Performance on the Shampoo Sales Dataset" class="size-full wp-image-3980" height="480" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plots-of-Input-Weight-Regularization-Performance-on-the-Shampoo-Sales-Dataset.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plots-of-Input-Weight-Regularization-Performance-on-the-Shampoo-Sales-Dataset.png 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plots-of-Input-Weight-Regularization-Performance-on-the-Shampoo-Sales-Dataset-300x225.png 300w" width="640"/><p class="wp-caption-text">Box and Whisker Plots of Input Weight Regularization Performance on the Shampoo Sales Dataset</p></div>
<h2>Recurrent Weight Regularization</h2>
<p>Finally, we can also apply regularization to recurrent connections on each LSTM unit.</p>
<p>In Keras, this is achieved by setting the <em>recurrent_regularizer</em> argument to a regularizer class.</p>
<p>We will test the same regularizer configurations as were used in the previous section, specifically:</p>
<ul>
<li>L1L2(0.0, 0.0) [e.g. baseline]</li>
<li>L1L2(0.01, 0.0) [e.g. L1]</li>
<li>L1L2(0.0, 0.01) [e.g. L2]</li>
<li>L1L2(0.01, 0.01) [e.g. L1L2 or elasticnet]</li>
</ul>
<p>Below lists the updated <em>fit_lstm()</em>, <em>experiment()</em>, and <em>run()</em> functions for using bias weight regularization with LSTMs.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a65919c5c54b174519652" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# fit an LSTM network to training data
def fit_lstm(train, n_batch, nb_epoch, n_neurons, reg):
	X, y = train[:, 0:-1], train[:, -1]
	X = X.reshape(X.shape[0], 1, X.shape[1])
	model = Sequential()
	model.add(LSTM(n_neurons, batch_input_shape=(n_batch, X.shape[1], X.shape[2]), stateful=True, recurrent_regularizer=reg))
	model.add(Dense(1))
	model.compile(loss='mean_squared_error', optimizer='adam')
	for i in range(nb_epoch):
		model.fit(X, y, epochs=1, batch_size=n_batch, verbose=0, shuffle=False)
		model.reset_states()
	return model

# run a repeated experiment
def experiment(series, n_lag, n_repeats, n_epochs, n_batch, n_neurons, reg):
	# transform data to be stationary
	raw_values = series.values
	diff_values = difference(raw_values, 1)
	# transform data to be supervised learning
	supervised = timeseries_to_supervised(diff_values, n_lag)
	supervised_values = supervised.values[n_lag:,:]
	# split data into train and test-sets
	train, test = supervised_values[0:-12], supervised_values[-12:]
	# transform the scale of the data
	scaler, train_scaled, test_scaled = scale(train, test)
	# run experiment
	error_scores = list()
	for r in range(n_repeats):
		# fit the model
		train_trimmed = train_scaled[2:, :]
		lstm_model = fit_lstm(train_trimmed, n_batch, n_epochs, n_neurons, reg)
		# forecast test dataset
		test_reshaped = test_scaled[:,0:-1]
		test_reshaped = test_reshaped.reshape(len(test_reshaped), 1, 1)
		output = lstm_model.predict(test_reshaped, batch_size=n_batch)
		predictions = list()
		for i in range(len(output)):
			yhat = output[i,0]
			X = test_scaled[i, 0:-1]
			# invert scaling
			yhat = invert_scale(scaler, X, yhat)
			# invert differencing
			yhat = inverse_difference(raw_values, yhat, len(test_scaled)+1-i)
			# store forecast
			predictions.append(yhat)
		# report performance
		rmse = sqrt(mean_squared_error(raw_values[-12:], predictions))
		print('%d) Test RMSE: %.3f' % (r+1, rmse))
		error_scores.append(rmse)
	return error_scores

# configure the experiment
def run():
	# load dataset
	series = read_csv('shampoo-sales.csv', header=0, parse_dates=[0], index_col=0, squeeze=True, date_parser=parser)
	# configure the experiment
	n_lag = 1
	n_repeats = 30
	n_epochs = 1000
	n_batch = 4
	n_neurons = 3
	regularizers = [L1L2(l1=0.0, l2=0.0), L1L2(l1=0.01, l2=0.0), L1L2(l1=0.0, l2=0.01), L1L2(l1=0.01, l2=0.01)]
	# run the experiment
	results = DataFrame()
	for reg in regularizers:
		name = ('l1 %.2f,l2 %.2f' % (reg.l1, reg.l2))
		results[name] = experiment(series, n_lag, n_repeats, n_epochs, n_batch, n_neurons, reg)
	# summarize results
	print(results.describe())
	# save boxplot
	results.boxplot()
	pyplot.savefig('experiment_reg_recurrent.png')</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-2">2</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-4">4</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-6">6</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-8">8</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-10">10</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-12">12</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-14">14</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-16">16</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-18">18</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-20">20</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-22">22</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-24">24</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-26">26</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-28">28</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-30">30</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-32">32</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-34">34</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-36">36</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-38">38</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-40">40</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-42">42</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-44">44</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-46">46</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-48">48</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-50">50</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-52">52</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-54">54</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-56">56</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-58">58</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-60">60</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-62">62</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-64">64</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-66">66</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-68">68</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-70">70</div><div class="crayon-num" data-line="crayon-5a65919c5c54b174519652-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54b174519652-72">72</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a65919c5c54b174519652-1"><span class="crayon-p"># fit an LSTM network to training data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-2"><span class="crayon-e">def </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-3"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-4"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-5"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-6"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">stateful</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">recurrent_regularizer</span><span class="crayon-o">=</span><span class="crayon-v">reg</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-7"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-8"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mean_squared_error'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-9"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-10"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">shuffle</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-11"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">reset_states</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-12"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-13"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-14"><span class="crayon-p"># run a repeated experiment</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-15"><span class="crayon-e">def </span><span class="crayon-e">experiment</span><span class="crayon-sy">(</span><span class="crayon-v">series</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_repeats</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-16"><span class="crayon-h"> </span><span class="crayon-p"># transform data to be stationary</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-17"><span class="crayon-h"> </span><span class="crayon-v">raw_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-sy">.</span><span class="crayon-e">values</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-18"><span class="crayon-e"> </span><span class="crayon-v">diff_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">difference</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-19"><span class="crayon-h"> </span><span class="crayon-p"># transform data to be supervised learning</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-20"><span class="crayon-h"> </span><span class="crayon-v">supervised</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">timeseries_to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">diff_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-21"><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">supervised</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-v">n_lag</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-22"><span class="crayon-h"> </span><span class="crayon-p"># split data into train and test-sets</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-23"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-24"><span class="crayon-h"> </span><span class="crayon-p"># transform the scale of the data</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-25"><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">scale</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-26"><span class="crayon-h"> </span><span class="crayon-p"># run experiment</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-27"><span class="crayon-h"> </span><span class="crayon-v">error_scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-28"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">r</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">n_repeats</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-29"><span class="crayon-h"> </span><span class="crayon-p"># fit the model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-30"><span class="crayon-h"> </span><span class="crayon-v">train_trimmed</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-31"><span class="crayon-h"> </span><span class="crayon-v">lstm_model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train_trimmed</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-32"><span class="crayon-h"> </span><span class="crayon-p"># forecast test dataset</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-33"><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-34"><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-35"><span class="crayon-h"> </span><span class="crayon-v">output</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">lstm_model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">n_batch</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-36"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-37"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">output</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-38"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">output</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-39"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-40"><span class="crayon-h"> </span><span class="crayon-p"># invert scaling</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-41"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">invert_scale</span><span class="crayon-sy">(</span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-42"><span class="crayon-h"> </span><span class="crayon-p"># invert differencing</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-43"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">inverse_difference</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_scaled</span><span class="crayon-sy">)</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-o">-</span><span class="crayon-v">i</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-44"><span class="crayon-h"> </span><span class="crayon-p"># store forecast</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-45"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-46"><span class="crayon-h"> </span><span class="crayon-p"># report performance</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-47"><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-e">mean_squared_error</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-48"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'%d) Test RMSE: %.3f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">r</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-49"><span class="crayon-h"> </span><span class="crayon-v">error_scores</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-50"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">error_scores</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-51"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-52"><span class="crayon-p"># configure the experiment</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-53"><span class="crayon-e">def </span><span class="crayon-e">run</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-54"><span class="crayon-h"> </span><span class="crayon-p"># load dataset</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-55"><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'shampoo-sales.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">squeeze</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">date_parser</span><span class="crayon-o">=</span><span class="crayon-v">parser</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-56"><span class="crayon-h"> </span><span class="crayon-p"># configure the experiment</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-57"><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-58"><span class="crayon-h"> </span><span class="crayon-v">n_repeats</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">30</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-59"><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">1000</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-60"><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">4</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-61"><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">3</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-62"><span class="crayon-h"> </span><span class="crayon-v">regularizers</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-e">L1L2</span><span class="crayon-sy">(</span><span class="crayon-v">l1</span><span class="crayon-o">=</span><span class="crayon-cn">0.0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">l2</span><span class="crayon-o">=</span><span class="crayon-cn">0.0</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">L1L2</span><span class="crayon-sy">(</span><span class="crayon-v">l1</span><span class="crayon-o">=</span><span class="crayon-cn">0.01</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">l2</span><span class="crayon-o">=</span><span class="crayon-cn">0.0</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">L1L2</span><span class="crayon-sy">(</span><span class="crayon-v">l1</span><span class="crayon-o">=</span><span class="crayon-cn">0.0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">l2</span><span class="crayon-o">=</span><span class="crayon-cn">0.01</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">L1L2</span><span class="crayon-sy">(</span><span class="crayon-v">l1</span><span class="crayon-o">=</span><span class="crayon-cn">0.01</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">l2</span><span class="crayon-o">=</span><span class="crayon-cn">0.01</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-63"><span class="crayon-h"> </span><span class="crayon-p"># run the experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-64"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-65"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">reg </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">regularizers</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-66"><span class="crayon-h"> </span><span class="crayon-v">name</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-s">'l1 %.2f,l2 %.2f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">reg</span><span class="crayon-sy">.</span><span class="crayon-v">l1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">.</span><span class="crayon-v">l2</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-67"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-v">name</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">experiment</span><span class="crayon-sy">(</span><span class="crayon-v">series</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_lag</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_repeats</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_epochs</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_batch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">n_neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">reg</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-68"><span class="crayon-h"> </span><span class="crayon-p"># summarize results</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-69"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">describe</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-70"><span class="crayon-h"> </span><span class="crayon-p"># save boxplot</span></div><div class="crayon-line" id="crayon-5a65919c5c54b174519652-71"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">boxplot</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54b174519652-72"><span class="crayon-h"> </span><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">savefig</span><span class="crayon-sy">(</span><span class="crayon-s">'experiment_reg_recurrent.png'</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0086 seconds] -->
<p>Running this experiment prints descriptive statistics for each evaluated configuration.</p>
<p>The results suggest no obvious benefit from using regularization on the recurrent connection with LSTMs on this problem.</p>
<p>The mean performance of all variations tried resulted in worse performance than the baseline model.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a65919c5c54f753147882" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
       l1 0.00,l2 0.00  l1 0.01,l2 0.00  l1 0.00,l2 0.01  l1 0.01,l2 0.01
count        30.000000        30.000000        30.000000        30.000000
mean         92.918797       100.675386       101.302169        96.820026
std           7.172764         3.866547         5.228815         3.966710
min          72.967841        93.789854        91.063592        89.367600
25%          90.311185        98.014045        98.222732        94.787647
50%          92.327824       100.546756       101.903350        95.727549
75%          95.989761       103.491192       104.918266        98.240613
max         110.529422       108.788604       110.712064       111.185747</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a65919c5c54f753147882-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54f753147882-2">2</div><div class="crayon-num" data-line="crayon-5a65919c5c54f753147882-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54f753147882-4">4</div><div class="crayon-num" data-line="crayon-5a65919c5c54f753147882-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54f753147882-6">6</div><div class="crayon-num" data-line="crayon-5a65919c5c54f753147882-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a65919c5c54f753147882-8">8</div><div class="crayon-num" data-line="crayon-5a65919c5c54f753147882-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a65919c5c54f753147882-1">       l1 0.00,l2 0.00  l1 0.01,l2 0.00  l1 0.00,l2 0.01  l1 0.01,l2 0.01</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54f753147882-2">count        30.000000        30.000000        30.000000        30.000000</div><div class="crayon-line" id="crayon-5a65919c5c54f753147882-3">mean         92.918797       100.675386       101.302169        96.820026</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54f753147882-4">std           7.172764         3.866547         5.228815         3.966710</div><div class="crayon-line" id="crayon-5a65919c5c54f753147882-5">min          72.967841        93.789854        91.063592        89.367600</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54f753147882-6">25%          90.311185        98.014045        98.222732        94.787647</div><div class="crayon-line" id="crayon-5a65919c5c54f753147882-7">50%          92.327824       100.546756       101.903350        95.727549</div><div class="crayon-line crayon-striped-line" id="crayon-5a65919c5c54f753147882-8">75%          95.989761       103.491192       104.918266        98.240613</div><div class="crayon-line" id="crayon-5a65919c5c54f753147882-9">max         110.529422       108.788604       110.712064       111.185747</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>A box and whisker plot is also created to compare the distributions of results for each configuration.</p>
<p>The plot shows the same story as the summary statistics, suggesting little benefit from using recurrent weight regularization.</p>
<div class="wp-caption aligncenter" id="attachment_3981" style="max-width: 650px"><img alt="Box and Whisker Plots of Recurrent Weight Regularization Performance on the Shampoo Sales Dataset" class="size-full wp-image-3981" height="480" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plots-of-Recurrent-Weight-Regularization-Performance-on-the-Shampoo-Sales-Dataset.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plots-of-Recurrent-Weight-Regularization-Performance-on-the-Shampoo-Sales-Dataset.png 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plots-of-Recurrent-Weight-Regularization-Performance-on-the-Shampoo-Sales-Dataset-300x225.png 300w" width="640"/><p class="wp-caption-text">Box and Whisker Plots of Recurrent Weight Regularization Performance on the Shampoo Sales Dataset</p></div>
<h2>Extensions</h2>
<p>This section lists ideas for follow-up experiments to extend the work in this tutorial.</p>
<ul>
<li><strong>Input Weight Regularization</strong>. The experimental results for input weight regularization on this problem showed great promise of listing performance. This could be investigated further by perhaps grid searching different L1 and L2 values to find an optimal configuration.</li>
<li><strong>Behavior Dynamics</strong>. The dynamic behavior of each weight regularization scheme could be investigated by plotting train and test RMSE over training epochs to get an idea of weight regularization on overfitting or underfitting behavior patterns.</li>
<li><strong>Combine Regularization</strong>. Experiments could be designed to explore the effect of combining different weight regularization schemes.</li>
<li><strong>Activation Regularization</strong>. Keras also supports activation regularization, and this could be another avenue to explore imposing constraints on the LSTM and reduce overfitting.</li>
</ul>
<h2>Summary</h2>
<p>In this tutorial, you discovered how to use weight regularization with LSTMs for time series forecasting.</p>
<p>Specifically, you learned:</p>
<ul>
<li>How to design a robust test harness for evaluating LSTM networks for time series forecasting.</li>
<li>How to configure bias weight regularization on LSTMs for time series forecasting.</li>
<li>How to configure input and recurrent weight regularization on LSTMs for time series forecasting.</li>
</ul>
<p>Do you have any questions about using weight regularization with LSTM networks?<br/>
Ask your questions in the comments below and I will do my best to answer.</p>
<div class="awac-wrapper"><div class="awac widget text-30"> <div class="textwidget"><div class="woo-sc-hr"></div>
<p></p><center>
<h2>Develop LSTMs for Sequence Prediction Today!</h2>
<p><a href="/lstms-with-python/"><img align="left" alt="Long Short-Term Memory Networks with Python" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/07/Cover-220.png" style="border: 0;"/></a></p>
<h4>Develop Your Own LSTM models in Minutes</h4>
<p>…with just a few lines of python code</p>
<p>Discover how in my new Ebook:<br/>
<a href="/lstms-with-python/">Long Short-Term Memory Networks with Python</a></p>
<p>It provides <strong>self-study tutorials</strong> on topics like:<br/>
<em>CNN LSTMs, Encoder-Decoder LSTMs, generative models, data preparation, making predictions</em> and much more…</p>
<h4>Finally Bring LSTM Recurrent Neural Networks to<br/>
Your Sequence Predictions Projects</h4>
<p>Skip the Academics. Just Results.</p>
<p><a href="/lstms-with-python/">Click to learn more</a>.<br/>
</p></center><br/>
<div class="woo-sc-hr"></div>
</div>
</div></div><div class="apss-social-share apss-theme-4 clearfix">
<div class="apss-twitter apss-single-icon">
<a href="javascript:void(0);" onclick="apss_open_in_popup_window(event, 'https://twitter.com/intent/tweet?text=How%20to%20Use%20Weight%20Regularization%20with%20LSTM%20Networks%20for%20Time%20Series%20Forecasting&amp;url=https%3A%2F%2Fmachinelearningmastery.com%2Fuse-weight-regularization-lstm-networks-time-series-forecasting%2F&amp;');" rel="nofollow" target="" title="Share on Twitter">
<div class="apss-icon-block clearfix">
<i class="fa fa-twitter"></i>
<span class="apss-social-text">Share on Twitter</span><span class="apss-share">Tweet</span>
</div>
</a>
</div>
<div class="apss-facebook apss-single-icon">
<a href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/" onclick="apss_open_in_popup_window(event, 'https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/');" rel="nofollow" target="" title="Share on Facebook">
<div class="apss-icon-block clearfix">
<i class="fa fa-facebook"></i>
<span class="apss-social-text">Share on Facebook</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-linkedin apss-single-icon">
<a href="http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Use%20Weight%20Regularization%20with%20LSTM%20Networks%20for%20Time%20Series%20Forecasting&amp;url=https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/&amp;summary=Long+Short-Term+Memory+%28LSTM%29+models+are+a+recurrent+neural+network+capable+of+learning+sequences+of..." onclick="apss_open_in_popup_window(event, 'http://www.linkedin.com/shareArticle?mini=true&amp;title=How%20to%20Use%20Weight%20Regularization%20with%20LSTM%20Networks%20for%20Time%20Series%20Forecasting&amp;url=https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/&amp;summary=Long+Short-Term+Memory+%28LSTM%29+models+are+a+recurrent+neural+network+capable+of+learning+sequences+of...');" rel="nofollow" target="" title="Share on LinkedIn">
<div class="apss-icon-block clearfix"><i class="fa fa-linkedin"></i>
<span class="apss-social-text">Share on LinkedIn</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-google-plus apss-single-icon">
<a href="https://plus.google.com/share?url=https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/" onclick="apss_open_in_popup_window(event, 'https://plus.google.com/share?url=https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/');" rel="nofollow" target="" title="Share on Google Plus">
<div class="apss-icon-block clearfix">
<i class="fa fa-google-plus"></i>
<span class="apss-social-text">Share on Google Plus</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
</div> </section><!-- /.entry -->
<div class="fix"></div>
<aside id="post-author">
<div class="profile-image"><img alt="" class="avatar avatar-80 photo" height="80" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=160&amp;d=mm&amp;r=g 2x" width="80"/></div>
<div class="profile-content">
<h4>About Jason Brownlee</h4>
		Dr. Jason Brownlee is a husband, proud father, academic researcher, author, professional developer and a machine learning practitioner. He is dedicated to helping developers get started and get good at applied machine learning.
<a href="/about">Learn more</a>.				<div class="profile-link">
<a href="https://machinelearningmastery.com/author/jasonb/">
				View all posts by Jason Brownlee <span class="meta-nav">→</span> </a>
</div><!--#profile-link-->
</div>
<div class="fix"></div>
</aside>
<div class="post-utility"></div>
</article><!-- /.post -->
<div class="post-entries">
<div class="nav-prev fl"><a href="https://machinelearningmastery.com/use-statistical-significance-tests-interpret-machine-learning-results/" rel="prev"><i class="fa fa-angle-left"></i> How to Use Statistical Significance Tests to Interpret Machine Learning Results</a></div>
<div class="nav-next fr"><a href="https://machinelearningmastery.com/convert-time-series-supervised-learning-problem-python/" rel="next">How to Convert a Time Series to a Supervised Learning Problem in Python <i class="fa fa-angle-right"></i></a></div>
<div class="fix"></div>
</div>
<div id="comments"> <h3 id="comments-title">16 Responses to <em>How to Use Weight Regularization with LSTM Networks for Time Series Forecasting</em></h3>
<ol class="commentlist">
<li class="comment even thread-even depth-1" id="comment-398566">
<div class="comment-container" id="li-comment-398566">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/07062bee713abad7dba252417d1306d2?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/07062bee713abad7dba252417d1306d2?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Alex</span>
<span class="date">May 5, 2017 at 5:57 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-398566" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Gret job like every time.</p>
<p>But I want to understand why always we are using rmse and we don’t use the accuracy metrics ??</p>
<div class="reply">
<a aria-label="Reply to Alex" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=398566#respond" onclick='return addComment.moveForm( "comment-398566", "398566", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-398580">
<div class="comment-container" id="li-comment-398580">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 5, 2017 at 7:35 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-398580" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You cannot measure accuracy on regression problems (unless you transform them to become a classification problem).</p>
<p>In general, problems that have a real-valued quantity as the output variable are regression problems, those that have a category or label output are classification.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=398580#respond" onclick='return addComment.moveForm( "comment-398580", "398580", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-398584">
<div class="comment-container" id="li-comment-398584">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/07062bee713abad7dba252417d1306d2?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/07062bee713abad7dba252417d1306d2?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Alex</span>
<span class="date">May 5, 2017 at 7:51 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-398584" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Ah OK, yes it is a logic thinking. Thanks</p>
<div class="reply">
<a aria-label="Reply to Alex" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=398584#respond" onclick='return addComment.moveForm( "comment-398584", "398584", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-398661">
<div class="comment-container" id="li-comment-398661">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/2fc25b7aa9894fbb4dd764e605270483?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2fc25b7aa9894fbb4dd764e605270483?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">shobhit</span>
<span class="date">May 5, 2017 at 9:08 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-398661" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>hello jason,<br/>
  how can be predicted a stock market data using a multiple input of columns and single output columns.</p>
<div class="reply">
<a aria-label="Reply to shobhit" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=398661#respond" onclick='return addComment.moveForm( "comment-398661", "398661", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-398736">
<div class="comment-container" id="li-comment-398736">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 6, 2017 at 7:42 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-398736" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Each separate time series would be framed as a separate feature in the LSTM.</p>
<p>also, I believe short term security prices are a random walk and are not predictable:<br/>
<a href="http://machinelearningmastery.com/gentle-introduction-random-walk-times-series-forecasting-python/" rel="nofollow">http://machinelearningmastery.com/gentle-introduction-random-walk-times-series-forecasting-python/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=398736#respond" onclick='return addComment.moveForm( "comment-398736", "398736", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-398667">
<div class="comment-container" id="li-comment-398667">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/2fc25b7aa9894fbb4dd764e605270483?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/2fc25b7aa9894fbb4dd764e605270483?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">shobhit</span>
<span class="date">May 5, 2017 at 9:18 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-398667" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>import numpy as np<br/>
import pandas as pd<br/>
import tensorflow as tf<br/>
#tf.logging.set_verosity(tf.logging.ERROR)<br/>
from pandas_datareader import data as web<br/>
import	matplotlib.pyplot as plt<br/>
def get_data():<br/>
	feature_cols={‘ret_%s’ %i:tf.constant(idata[‘ret_%s’%i].values)for i in lags}<br/>
	labels=tf.constant((idata[‘returns’]&gt;0).astype(int).values,shape=[idata[‘returns’].size,1])<br/>
	return feature_cols,labels</p>
<p>symbol=’^GSPC’<br/>
data=web.DataReader(symbol,data_source=’yahoo’,start=’2014-01-01′,end=’2016-10-31′)[‘Adj Close’]<br/>
data=pd.DataFrame(data)<br/>
data.rename(columns={‘Adj Close’:’price’},inplace=True)<br/>
data[‘returns’]=np.log(data/data.shift(1))<br/>
lags=range(1,6)<br/>
for i in lags:<br/>
	data[‘ret_%s’% i]=np.sign(data[‘returns’].shift(i))<br/>
data.dropna(inplace=True)<br/>
print data.round(4).tail()<br/>
cutoff=’2015-1-1′<br/>
training_data=data[data.index=cutoff].copy()<br/>
#def get_data():<br/>
	#feature_cols={‘ret_%s’ %i:tf.constant(data[‘ret_%s’%i].values)for i in lags}<br/>
	#labels=tf.constant((data[‘returns’]&gt;0).astype(int).values,shape=[data[‘returns’].size,1])<br/>
	#return feature_cols,labels<br/>
fc=[tf.contrib.layers.real_valued_column(‘ret_%s’% i,dimension=1) for i in lags]<br/>
model=tf.contrib.learn.DNNClassifier(feature_columns=fc,n_classes=2,hidden_units=[100,100])<br/>
idata=training_data<br/>
model.fit(input_fn=get_data,steps=500)<br/>
model.evaluate(input_fn=get_data,steps=1)<br/>
pred=model.predict(input_fn=get_data)<br/>
pred[:30]<br/>
training_data[‘prediction’]=np.where(pred&gt;0,1,-1)<br/>
training_data[‘strategy’]=training_data[‘prediction’]*training_data[‘returns’]<br/>
training_data[[‘returns’,’strategy’]].cumsum().apply(np.exp).plot(figsize=(10,6))<br/>
idata=test_data<br/>
model.evaluate(input_fn=get_data,steps=1)<br/>
pred=model.predict(input_fn=get_data)<br/>
test_data[‘prediction’]=np.where(pred&gt;0,1,-1)<br/>
test_data[‘strategy’]=test_data[‘prediction’]*test_data[‘returns’]<br/>
test_data[[‘returns’,’strategy’]].cumsum().apply(np.exp).plot(figsize=(10,6))<br/>
#pred[:1]<br/>
if __name__ == ‘__main__’:<br/>
	get_data()</p>
<p>hello jason,<br/>
    i just ran this code but i got some error in the code and i cannot understand the error.<br/>
the error is:—–&gt; 1 pred[:30]</p>
<p>TypeError: ‘generator’ object is not subscriptable</p>
<p>please kindly help me.</p>
<div class="reply">
<a aria-label="Reply to shobhit" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=398667#respond" onclick='return addComment.moveForm( "comment-398667", "398667", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-398738">
<div class="comment-container" id="li-comment-398738">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 6, 2017 at 7:43 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-398738" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Perhaps contact the author of the tensorflow code you have pasted?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=398738#respond" onclick='return addComment.moveForm( "comment-398738", "398738", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-399269">
<div class="comment-container" id="li-comment-399269">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/cfccb37eb2036bb031f66fc21c544815?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/cfccb37eb2036bb031f66fc21c544815?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Birkey</span>
<span class="date">May 10, 2017 at 10:48 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-399269" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Great article!<br/>
however, what confused me is, in section LSTM model, “A batch size of 1 is required as we will be using walk-forward validation and making one-step forecasts for each of the final 12 months of test data.”, but then you use batch size as 4 (n_batch=4). </p>
<p>I guess you mean “A time step of 1 is required”, am I right?  cause one forecast per month means one time step.</p>
<div class="reply">
<a aria-label="Reply to Birkey" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=399269#respond" onclick='return addComment.moveForm( "comment-399269", "399269", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-399347">
<div class="comment-container" id="li-comment-399347">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 11, 2017 at 8:26 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-399347" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>You make a good point.</p>
<p>A batch size of 1 would be required if we made predictions each time step of the test data. Here we predict the whole year first, then work through the predictions to see what they mean.</p>
<p>I have updated the post correcting the error.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=399347#respond" onclick='return addComment.moveForm( "comment-399347", "399347", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-399386">
<div class="comment-container" id="li-comment-399386">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ef10133ba4bbc7d63f56446ed831b1bd?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ef10133ba4bbc7d63f56446ed831b1bd?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Laurent</span>
<span class="date">May 11, 2017 at 5:58 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-399386" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thanks for all your pedagogic material, it’s really easy to learn with your articles!</p>
<p>I have a question: in all your examples of time series deep learning, you’re always predicting the next time step, one at a time.</p>
<p>How would you approach the case of training with a time series, and forecasting the next 12 steps, for example?</p>
<div class="reply">
<a aria-label="Reply to Laurent" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=399386#respond" onclick='return addComment.moveForm( "comment-399386", "399386", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-399437">
<div class="comment-container" id="li-comment-399437">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 12, 2017 at 7:37 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-399437" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Here is an example:<br/>
<a href="http://machinelearningmastery.com/multi-step-time-series-forecasting-long-short-term-memory-networks-python/" rel="nofollow">http://machinelearningmastery.com/multi-step-time-series-forecasting-long-short-term-memory-networks-python/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=399437#respond" onclick='return addComment.moveForm( "comment-399437", "399437", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-even depth-1" id="comment-399424">
<div class="comment-container" id="li-comment-399424">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/0f3c9fc72f05ff6b758a35aa93460b1a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/0f3c9fc72f05ff6b758a35aa93460b1a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">jinhua zhang</span>
<span class="date">May 12, 2017 at 4:31 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-399424" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>HI, your article is very useful for me! But I run the “Bias Weight Regularization procedure”, the spyder will have the fault :”D:\Program Files\Anaconda3\lib\site-packages\matplotlib\__init__.py:1357: UserWarning:  This call to matplotlib.use() has no effect<br/>
because the backend has already been chosen;<br/>
matplotlib.use() must be called *before* pylab, matplotlib.pyplot,<br/>
or matplotlib.backends is imported for the first time.</p>
<p>  warnings.warn(_use_error_msg)”,<br/>
  I don’t know how to slove the fault, could you help me ?</p>
<div class="reply">
<a aria-label="Reply to jinhua zhang" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=399424#respond" onclick='return addComment.moveForm( "comment-399424", "399424", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-2" id="comment-399447">
<div class="comment-container" id="li-comment-399447">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 12, 2017 at 7:47 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-399447" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Are you able to run the script from the command line instead of within the IDE?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=399447#respond" onclick='return addComment.moveForm( "comment-399447", "399447", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment odd alt depth-3" id="comment-399745">
<div class="comment-container" id="li-comment-399745">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/0f3c9fc72f05ff6b758a35aa93460b1a?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/0f3c9fc72f05ff6b758a35aa93460b1a?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">jinhua zhang</span>
<span class="date">May 16, 2017 at 1:07 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-399745" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Thank you very much! Because I  missed the command<br/>
 “# entry point<br/>
run()”.<br/>
  When I added the command,the procedure could  run.</p>
<div class="reply">
<a aria-label="Reply to jinhua zhang" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=399745#respond" onclick='return addComment.moveForm( "comment-399745", "399745", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor even depth-4" id="comment-399780">
<div class="comment-container" id="li-comment-399780">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 16, 2017 at 8:49 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-399780" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I’m glad to hear it.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=399780#respond" onclick='return addComment.moveForm( "comment-399780", "399780", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-418537">
<div class="comment-container" id="li-comment-418537">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/e1ea30b7d3d8c70ce3d61214482ff14b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/e1ea30b7d3d8c70ce3d61214482ff14b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Neeraj Agrawal</span>
<span class="date">October 31, 2017 at 6:17 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/#comment-418537" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I have one doubt related to stateful = True. As mentioned in keras documentation, first element of first batch is in sequence with first element of second batch and so on. But you have not converted time series into that order. Is it correct observation or I am missing something?</p>
<div class="reply">
<a aria-label="Reply to Neeraj Agrawal" class="comment-reply-link" href="https://machinelearningmastery.com/use-weight-regularization-lstm-networks-time-series-forecasting/?replytocom=418537#respond" onclick='return addComment.moveForm( "comment-418537", "418537", "respond", "3978" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ol>
</div> <div class="comment-respond" id="respond">
<h3 class="comment-reply-title" id="reply-title">Leave a Reply <small><a href="/use-weight-regularization-lstm-networks-time-series-forecasting/#respond" id="cancel-comment-reply-link" rel="nofollow" style="display:none;">Click here to cancel reply.</a></small></h3> <form action="https://machinelearningmastery.com/wp-comments-post.php?wpe-comment-post=mlmastery" class="comment-form" id="commentform" method="post">
<p class="comment-form-comment"><label class="hide" for="comment">Comment</label> <textarea aria-required="true" cols="50" id="comment" maxlength="65525" name="comment" required="required" rows="10" tabindex="4"></textarea></p><p class="comment-form-author"><input aria-required="true" class="txt" id="author" name="author" size="30" tabindex="1" type="text" value=""/><label for="author">Name <span class="required">(required)</span></label> </p>
<p class="comment-form-email"><input aria-required="true" class="txt" id="email" name="email" size="30" tabindex="2" type="text" value=""/><label for="email">Email (will not be published) <span class="required">(required)</span></label> </p>
<p class="comment-form-url"><input class="txt" id="url" name="url" size="30" tabindex="3" type="text" value=""/><label for="url">Website</label></p>
<p class="form-submit"><input class="submit" id="submit" name="submit" type="submit" value="Submit Comment"/> <input id="comment_post_ID" name="comment_post_ID" type="hidden" value="3978"/>
<input id="comment_parent" name="comment_parent" type="hidden" value="0"/>
</p><p style="display: none;"><input id="akismet_comment_nonce" name="akismet_comment_nonce" type="hidden" value="30a7852480"/></p><p style="display: none;"><input id="ak_js" name="ak_js" type="hidden" value="60"/></p> </form>
</div><!-- #respond -->
</section><!-- /#main -->
<aside id="sidebar">
<div class="widget widget_woo_blogauthorinfo" id="woo_blogauthorinfo-2"><h3>Welcome to Machine Learning Mastery</h3><span class="left"><img alt="" class="avatar avatar-100 photo" height="100" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=100&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=200&amp;d=mm&amp;r=g 2x" width="100"/></span>
<p>Hi, I'm Dr. Jason Brownlee.
<br/>
My goal is to make practitioners like YOU awesome at applied machine learning.</p>
<p><a href="/about">Read More</a></p>
<div class="fix"></div>
</div><div class="widget widget_text" id="text-29"> <div class="textwidget"><p></p><center>
<h3>Deep Learning for Sequence Prediction</h3>
<p>Cut through the math and research papers.<br/>
Discover 4 Models, 6 Architectures, and 14 Tutorials.</p>
<p><a href="/lstms-with-python/">Get Started With LSTMs in Python Today!</a><br/>
<a href="/lstms-with-python/"><img src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/07/Cover-220.png"/></a><br/>
</p></center>
</div>
</div>
<div class="widget widget_woo_tabs" id="woo_tabs-2"> <div id="tabs">
<ul class="wooTabs">
<li class="popular"><a href="#tab-pop">Popular</a></li> </ul>
<div class="clear"></div>
<div class="boxes box inside">
<ul class="list" id="tab-pop">
<li>
<a href="https://machinelearningmastery.com/machine-learning-in-python-step-by-step/" title="Your First Machine Learning Project in Python Step-By-Step"><img alt="Your First Machine Learning Project in Python Step-By-Step" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Your-First-Machine-Learning-Project-in-Python-Step-By-Step-150x150.jpg" title="Your First Machine Learning Project in Python Step-By-Step" width="45"/></a> <a href="https://machinelearningmastery.com/machine-learning-in-python-step-by-step/" title="Your First Machine Learning Project in Python Step-By-Step">Your First Machine Learning Project in Python Step-By-Step</a>
<span class="meta">June 10, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras"><img alt="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/07/Time-Series-Prediction-with-LSTM-Recurrent-Neural-Networks-in-Python-with-Keras-150x150.jpg" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras" width="45"/></a> <a href="https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras">Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras</a>
<span class="meta">July 21, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/" title="Multivariate Time Series Forecasting with LSTMs in Keras"><img alt="Line Plots of Air Pollution Time Series" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/06/Line-Plots-of-Air-Pollution-Time-Series-150x150.png" title="Multivariate Time Series Forecasting with LSTMs in Keras" width="45"/></a> <a href="https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/" title="Multivariate Time Series Forecasting with LSTMs in Keras">Multivariate Time Series Forecasting with LSTMs in Keras</a>
<span class="meta">August 14, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/tutorial-first-neural-network-python-keras/" title="Develop Your First Neural Network in Python With Keras Step-By-Step"><img alt="Tour of Deep Learning Algorithms" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/04/Tour-of-Deep-Learning-Algorithms-150x150.jpg" title="Develop Your First Neural Network in Python With Keras Step-By-Step" width="45"/></a> <a href="https://machinelearningmastery.com/tutorial-first-neural-network-python-keras/" title="Develop Your First Neural Network in Python With Keras Step-By-Step">Develop Your First Neural Network in Python With Keras Step-By-Step</a>
<span class="meta">May 24, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda"><img alt="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/How-to-Setup-a-Python-Environment-for-Machine-Learning-and-Deep-Learning-with-Anaconda-150x150.png" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda" width="45"/></a> <a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda">How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda</a>
<span class="meta">March 13, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/sequence-classification-lstm-recurrent-neural-networks-python-keras/" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras"><img alt="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/07/Sequence-Classification-with-LSTM-Recurrent-Neural-Networks-in-Python-with-Keras-150x150.jpg" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras" width="45"/></a> <a href="https://machinelearningmastery.com/sequence-classification-lstm-recurrent-neural-networks-python-keras/" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras">Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras</a>
<span class="meta">July 26, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/time-series-forecasting-long-short-term-memory-network-python/" title="Time Series Forecasting with the Long Short-Term Memory Network in Python"><img alt="Time Series Forecasting with the Long Short-Term Memory Network in Python" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/04/Time-Series-Forecasting-with-the-Long-Short-Term-Memory-Network-in-Python-150x150.jpg" title="Time Series Forecasting with the Long Short-Term Memory Network in Python" width="45"/></a> <a href="https://machinelearningmastery.com/time-series-forecasting-long-short-term-memory-network-python/" title="Time Series Forecasting with the Long Short-Term Memory Network in Python">Time Series Forecasting with the Long Short-Term Memory Network in Python</a>
<span class="meta">April 7, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/multi-class-classification-tutorial-keras-deep-learning-library/" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library"><img alt="Multi-Class Classification Tutorial with the Keras Deep Learning Library" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Multi-Class-Classification-Tutorial-with-the-Keras-Deep-Learning-Library-150x150.jpg" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library" width="45"/></a> <a href="https://machinelearningmastery.com/multi-class-classification-tutorial-keras-deep-learning-library/" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library">Multi-Class Classification Tutorial with the Keras Deep Learning Library</a>
<span class="meta">June 2, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/regression-tutorial-keras-deep-learning-library-python/" title="Regression Tutorial with the Keras Deep Learning Library in Python"><img alt="Regression Tutorial with Keras Deep Learning Library in Python" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Regression-Tutorial-with-Keras-Deep-Learning-Library-in-Python-150x150.jpg" title="Regression Tutorial with the Keras Deep Learning Library in Python" width="45"/></a> <a href="https://machinelearningmastery.com/regression-tutorial-keras-deep-learning-library-python/" title="Regression Tutorial with the Keras Deep Learning Library in Python">Regression Tutorial with the Keras Deep Learning Library in Python</a>
<span class="meta">June 9, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/grid-search-hyperparameters-deep-learning-models-python-keras/" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras"><img alt="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/08/How-to-Grid-Search-Hyperparameters-for-Deep-Learning-Models-in-Python-With-Keras-150x150.jpg" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras" width="45"/></a> <a href="https://machinelearningmastery.com/grid-search-hyperparameters-deep-learning-models-python-keras/" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras">How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras</a>
<span class="meta">August 9, 2016</span>
<div class="fix"></div>
</li>
</ul>
</div><!-- /.boxes -->
</div><!-- /wooTabs -->
</div> </aside><!-- /#sidebar -->
</div><!-- /#main-sidebar-container -->
</div><!-- /#content -->
<footer class="col-full" id="footer">
<div class="col-left" id="copyright">
<p>© 2018 Machine Learning Mastery. All Rights Reserved. </p> </div>
<div class="col-right" id="credit">
<p></p><p>
<a href="/privacy/">Privacy</a> | 
<a href="/contact/">Contact</a> |
<a href="/about/">About</a>
</p> </div>
</footer>
</div><!-- /#inner-wrapper -->
</div><!-- /#wrapper -->
<div class="fix"></div><!--/.fix-->
<!-- Drip -->
<script type="text/javascript">
  var _dcq = _dcq || [];
  var _dcs = _dcs || {}; 
  _dcs.account = '9556588';
  
  (function() {
    var dc = document.createElement('script');
    dc.type = 'text/javascript'; dc.async = true; 
    dc.src = '//tag.getdrip.com/9556588.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(dc, s);
  })();
</script><!-- Woo Tabs Widget -->
<script type="text/javascript">
jQuery(document).ready(function(){
	// UL = .wooTabs
	// Tab contents = .inside

	var tag_cloud_class = '#tagcloud';

	//Fix for tag clouds - unexpected height before .hide()
	var tag_cloud_height = jQuery( '#tagcloud').height();

	jQuery( '.inside ul li:last-child').css( 'border-bottom','0px' ); // remove last border-bottom from list in tab content
	jQuery( '.wooTabs').each(function(){
		jQuery(this).children( 'li').children( 'a:first').addClass( 'selected' ); // Add .selected class to first tab on load
	});
	jQuery( '.inside > *').hide();
	jQuery( '.inside > *:first-child').show();

	jQuery( '.wooTabs li a').click(function(evt){ // Init Click funtion on Tabs

		var clicked_tab_ref = jQuery(this).attr( 'href' ); // Strore Href value

		jQuery(this).parent().parent().children( 'li').children( 'a').removeClass( 'selected' ); //Remove selected from all tabs
		jQuery(this).addClass( 'selected' );
		jQuery(this).parent().parent().parent().children( '.inside').children( '*').hide();

		jQuery( '.inside ' + clicked_tab_ref).fadeIn(500);

		 evt.preventDefault();

	})
})
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/comment-reply.min.js?ver=4.9.2" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var wpcf7 = {"apiSettings":{"root":"https:\/\/machinelearningmastery.com\/wp-json\/contact-form-7\/v1","namespace":"contact-form-7\/v1"},"recaptcha":{"messages":{"empty":"Please verify that you are not a robot."}},"cached":"1"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/js/scripts.js?ver=4.9.2" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var frontend_ajax_object = {"ajax_url":"https:\/\/machinelearningmastery.com\/wp-admin\/admin-ajax.php","ajax_nonce":"555b70787c"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/seo-optimized-share-buttons/js/frontend.js?ver=4.2.2.0.iis7_supports_permalinks" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/wp-embed.min.js?ver=4.9.2" type="text/javascript"></script>
<script async="async" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/akismet/_inc/form.js?ver=4.0.2" type="text/javascript"></script>
</body>
</html>