<html lang="en-US" prefix="og: http://ogp.me/ns#">
<head>
<meta charset="utf-8"/>
<title>Stateful and Stateless LSTM for Time Series Forecasting with Python - Machine Learning Mastery</title>
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<link href="https://machinelearningmastery.com/xmlrpc.php" rel="pingback"/>
<!--  Mobile viewport scale -->
<meta content="initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" name="viewport"/>
<!-- This site is optimized with the Yoast SEO plugin v6.1.1 - https://yoa.st/1yg?utm_content=6.1.1 -->
<link href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/" rel="canonical"/>
<link href="https://plus.google.com/u/0/b/117073416089354242117/+MachinelearningmasteryHome/" rel="publisher"/>
<meta content="en_US" property="og:locale"/>
<meta content="article" property="og:type"/>
<meta content="Stateful and Stateless LSTM for Time Series Forecasting with Python - Machine Learning Mastery" property="og:title"/>
<meta content="The Keras Python deep learning library supports both stateful and stateless Long Short-Term Memory (LSTM) networks. When using stateful LSTM networks, we have fine-grained control over when the internal state of the LSTM network is reset. Therefore, it is important to understand different ways of managing this internal state when fitting and making predictions with …" property="og:description"/>
<meta content="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/" property="og:url"/>
<meta content="Machine Learning Mastery" property="og:site_name"/>
<meta content="https://www.facebook.com/Machine-Learning-Mastery-1429846323896563/" property="article:publisher"/>
<meta content="Long Short-Term Memory Networks" property="article:section"/>
<meta content="2017-04-21T05:00:12+11:00" property="article:published_time"/>
<meta content="2017-07-20T08:55:48+11:00" property="article:modified_time"/>
<meta content="2017-07-20T08:55:48+11:00" property="og:updated_time"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/04/Stateful-and-Stateless-LSTM-for-Time-Series-Forecasting-with-Python.jpg" property="og:image"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/04/Stateful-and-Stateless-LSTM-for-Time-Series-Forecasting-with-Python.jpg" property="og:image:secure_url"/>
<meta content="640" property="og:image:width"/>
<meta content="427" property="og:image:height"/>
<script type="application/ld+json">{"@context":"http:\/\/schema.org","@type":"WebSite","@id":"#website","url":"https:\/\/machinelearningmastery.com\/","name":"Machine Learning Mastery","potentialAction":{"@type":"SearchAction","target":"https:\/\/machinelearningmastery.com\/?s={search_term_string}","query-input":"required name=search_term_string"}}</script>
<script type="application/ld+json">{"@context":"http:\/\/schema.org","@type":"Organization","url":"https:\/\/machinelearningmastery.com\/stateful-stateless-lstm-time-series-forecasting-python\/","sameAs":["https:\/\/www.facebook.com\/Machine-Learning-Mastery-1429846323896563\/","https:\/\/www.linkedin.com\/in\/jasonbrownlee","https:\/\/plus.google.com\/u\/0\/b\/117073416089354242117\/+MachinelearningmasteryHome\/","https:\/\/twitter.com\/TeachTheMachine"],"@id":"#organization","name":"Machine Learning Mastery","logo":"https:\/\/machinelearningmastery.com\/wp-content\/uploads\/2016\/09\/cropped-icon.png"}</script>
<!-- / Yoast SEO plugin. -->
<link href="//cdnjs.cloudflare.com" rel="dns-prefetch"/>
<link href="//fonts.googleapis.com" rel="dns-prefetch"/>
<link href="//s.w.org" rel="dns-prefetch"/>
<link href="https://feeds.feedburner.com/MachineLearningMastery" rel="alternate" title="Machine Learning Mastery » Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/comments/feed/" rel="alternate" title="Machine Learning Mastery » Comments Feed" type="application/rss+xml"/>
<link href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/feed/" rel="alternate" title="Machine Learning Mastery » Stateful and Stateless LSTM for Time Series Forecasting with Python Comments Feed" type="application/rss+xml"/>
<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2.3\/svg\/","svgExt":".svg","source":{"concatemoji":"https:\/\/machinelearningmastery.com\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.9.2"}};
			!function(a,b,c){function d(a,b){var c=String.fromCharCode;l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,a),0,0);var d=k.toDataURL();l.clearRect(0,0,k.width,k.height),l.fillText(c.apply(this,b),0,0);var e=k.toDataURL();return d===e}function e(a){var b;if(!l||!l.fillText)return!1;switch(l.textBaseline="top",l.font="600 32px Arial",a){case"flag":return!(b=d([55356,56826,55356,56819],[55356,56826,8203,55356,56819]))&&(b=d([55356,57332,56128,56423,56128,56418,56128,56421,56128,56430,56128,56423,56128,56447],[55356,57332,8203,56128,56423,8203,56128,56418,8203,56128,56421,8203,56128,56430,8203,56128,56423,8203,56128,56447]),!b);case"emoji":return b=d([55358,56794,8205,9794,65039],[55358,56794,8203,9794,65039]),!b}return!1}function f(a){var c=b.createElement("script");c.src=a,c.defer=c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var g,h,i,j,k=b.createElement("canvas"),l=k.getContext&&k.getContext("2d");for(j=Array("flag","emoji"),c.supports={everything:!0,everythingExceptFlag:!0},i=0;i<j.length;i++)c.supports[j[i]]=e(j[i]),c.supports.everything=c.supports.everything&&c.supports[j[i]],"flag"!==j[i]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[j[i]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(h=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",h,!1),a.addEventListener("load",h,!1)):(a.attachEvent("onload",h),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),g=c.source||{},g.concatemoji?f(g.concatemoji):g.wpemoji&&g.twemoji&&(f(g.twemoji),f(g.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/css/min/crayon.min.css?ver=_2.7.2_beta" id="crayon-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/themes/classic/classic.css?ver=_2.7.2_beta" id="crayon-theme-classic-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/fonts/monaco.css?ver=_2.7.2_beta" id="crayon-font-monaco-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/css/styles.css?ver=4.9.2" id="contact-form-7-css" media="all" rel="stylesheet" type="text/css"/>
<link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css?ver=4.2.2.0.iis7_supports_permalinks" id="apss-font-awesome-css" media="all" rel="stylesheet" type="text/css"/>
<link href="//fonts.googleapis.com/css?family=Open+Sans&amp;ver=4.9.2" id="apss-font-opensans-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/seo-optimized-share-buttons/css/frontend.css?ver=4.2.2.0.iis7_supports_permalinks" id="apss-frontend-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/integrations/testimonials/css/testimonials.css?ver=4.9.2" id="woo-testimonials-css-css" media="all" rel="stylesheet" type="text/css"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/style.css?ver=5.9.21" id="theme-stylesheet-css" media="all" rel="stylesheet" type="text/css"/>
<!--[if lt IE 9]>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/css/non-responsive.css" rel="stylesheet" type="text/css" />
<style type="text/css">.col-full, #wrapper { width: 960px; max-width: 960px; } #inner-wrapper { padding: 0; } body.full-width #header, #nav-container, body.full-width #content, body.full-width #footer-widgets, body.full-width #footer { padding-left: 0; padding-right: 0; } body.fixed-mobile #top, body.fixed-mobile #header-container, body.fixed-mobile #footer-container, body.fixed-mobile #nav-container, body.fixed-mobile #footer-widgets-container { min-width: 960px; padding: 0 1em; } body.full-width #content { width: auto; padding: 0 1em;}</style>
<![endif]-->
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery.js?ver=1.12.4" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.4.1" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var CrayonSyntaxSettings = {"version":"_2.7.2_beta","is_admin":"0","ajaxurl":"https:\/\/machinelearningmastery.com\/wp-admin\/admin-ajax.php","prefix":"crayon-","setting":"crayon-setting","selected":"crayon-setting-selected","changed":"crayon-setting-changed","special":"crayon-setting-special","orig_value":"data-orig-value","debug":""};
var CrayonSyntaxStrings = {"copy":"Press %s to Copy, %s to Paste","minimize":"Click To Expand Code"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/crayon-syntax-highlighter/js/min/crayon.min.js?ver=_2.7.2_beta" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/third-party.min.js?ver=4.9.2" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/modernizr.min.js?ver=2.6.2" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/includes/js/general.min.js?ver=4.9.2" type="text/javascript"></script>
<link href="https://machinelearningmastery.com/wp-json/" rel="https://api.w.org/"/>
<link href="https://machinelearningmastery.com/xmlrpc.php?rsd" rel="EditURI" title="RSD" type="application/rsd+xml"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/wlwmanifest.xml" rel="wlwmanifest" type="application/wlwmanifest+xml"/>
<link href="https://machinelearningmastery.com/?p=3930" rel="shortlink"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fstateful-stateless-lstm-time-series-forecasting-python%2F" rel="alternate" type="application/json+oembed"/>
<link href="https://machinelearningmastery.com/wp-json/oembed/1.0/embed?url=https%3A%2F%2Fmachinelearningmastery.com%2Fstateful-stateless-lstm-time-series-forecasting-python%2F&amp;format=xml" rel="alternate" type="text/xml+oembed"/>
<!-- Start Google Analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-44039733-3', 'auto');
  ga('send', 'pageview');

</script>
<!-- End Google Analytics -->
<!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,
document,'script','https://connect.facebook.net/en_US/fbevents.js');

fbq('init', '296263687421164');
fbq('track', "PageView");</script>
<noscript><img height="1" src="https://www.facebook.com/tr?id=296263687421164&amp;ev=PageView&amp;noscript=1" style="display:none" width="1"/></noscript>
<!-- End Facebook Pixel Code -->
<!-- Custom CSS Styling -->
<style type="text/css">
#logo .site-title, #logo .site-description { display:none; }
body {background-repeat:no-repeat;background-position:top left;background-attachment:scroll;border-top:0px solid #000000;}
#header {background-repeat:no-repeat;background-position:left top;margin-top:0px;margin-bottom:0px;padding-top:10px;padding-bottom:10px;border:0px solid ;}
#logo .site-title a {font:bold 40px/1em Helvetica Neue, Helvetica, sans-serif;color:#222222;}
#logo .site-description {font:300 13px/1em Helvetica Neue, Helvetica, sans-serif;color:#999999;}
body, p { font:300 14px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
h1 { font:bold 28px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h2 { font:bold 24px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h3 { font:bold 20px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h4 { font:bold 16px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h5 { font:bold 14px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }h6 { font:bold 12px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }
.page-title, .post .title, .page .title {font:bold 28px/1.1em "Helvetica Neue", Helvetica, sans-serif;color:#222222;}
.post .title a:link, .post .title a:visited, .page .title a:link, .page .title a:visited {color:#222222}
.post-meta { font:300 12px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#999999; }
.entry, .entry p{ font:300 15px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:#555555; }
.post-more {font:300 13px/1.5em "Helvetica Neue", Helvetica, sans-serif;color:;border-top:0px solid #e6e6e6;border-bottom:0px solid #e6e6e6;}
#post-author, #connect {border-top:1px solid #e6e6e6;border-bottom:1px solid #e6e6e6;border-left:1px solid #e6e6e6;border-right:1px solid #e6e6e6;border-radius:5px;-moz-border-radius:5px;-webkit-border-radius:5px;background-color:#fafafa}
.nav-entries a, .woo-pagination { font:300 13px/1em "Helvetica Neue", Helvetica, sans-serif;color:#888; }
.woo-pagination a, .woo-pagination a:hover {color:#888!important}
.widget h3 {font:bold 14px/1.2em &quot;Helvetica Neue&quot;, Helvetica, sans-serif;color:#555555;border-bottom:1px solid #e6e6e6;}
.widget_recent_comments li, #twitter li { border-color: #e6e6e6;}
.widget p, .widget .textwidget { font:300 13px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
.widget {font:300 13px/1.5em &quot;Helvetica Neue&quot;, Helvetica, sans-serif;color:#555555;border-radius:0px;-moz-border-radius:0px;-webkit-border-radius:0px;}
#tabs .inside li a, .widget_woodojo_tabs .tabbable .tab-pane li a { font:bold 12px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#555555; }
#tabs .inside li span.meta, .widget_woodojo_tabs .tabbable .tab-pane li span.meta { font:300 11px/1.5em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
#tabs ul.wooTabs li a, .widget_woodojo_tabs .tabbable .nav-tabs li a { font:300 11px/2em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
@media only screen and (min-width:768px) {
ul.nav li a, #navigation ul.rss a, #navigation ul.cart a.cart-contents, #navigation .cart-contents #navigation ul.rss, #navigation ul.nav-search, #navigation ul.nav-search a { font:300 14px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#666666; } #navigation ul.rss li a:before, #navigation ul.nav-search a.search-contents:before { color:#666666;}
#navigation ul.nav li ul, #navigation ul.cart > li > ul > div  { border: 0px solid #dbdbdb; }
#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation ul.nav > li  { border-right: 0px solid #dbdbdb; }#navigation ul.nav > li:hover > ul  { left: 0; }
#navigation { box-shadow: none; -moz-box-shadow: none; -webkit-box-shadow: none; }#navigation ul li:first-child, #navigation ul li:first-child a { border-radius:0px 0 0 0px; -moz-border-radius:0px 0 0 0px; -webkit-border-radius:0px 0 0 0px; }
#navigation {border-top:0px solid #dbdbdb;border-bottom:0px solid #dbdbdb;border-left:0px solid #dbdbdb;border-right:0px solid #dbdbdb;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
#top ul.nav li a { font:300 12px/1.6em Helvetica Neue, Helvetica, sans-serif;color:#ddd; }
}
#footer, #footer p { font:300 13px/1.4em Helvetica Neue, Helvetica, sans-serif;color:#999999; }
#footer {border-top:1px solid #dbdbdb;border-bottom:0px solid ;border-left:0px solid ;border-right:0px solid ;border-radius:0px; -moz-border-radius:0px; -webkit-border-radius:0px;}
.magazine #loopedSlider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-magazine .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.magazine #loopedSlider .content .excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-magazine .slide-content p, .wooslider-theme-magazine .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.magazine .block .post .title a {font:bold 18px/1.2em Helvetica Neue, Helvetica, sans-serif;color:#222222; }
#loopedSlider.business-slider .content h2 { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#loopedSlider.business-slider .content h2.title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
.wooslider-theme-business .has-featured-image .slide-title a { font:bold 24px/1em Arial, sans-serif;color:#ffffff; }
#wrapper #loopedSlider.business-slider .content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-content p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.wooslider-theme-business .has-featured-image .slide-excerpt p { font:300 13px/1.5em Arial, sans-serif;color:#cccccc; }
.archive_header { font:bold 18px/1em Arial, sans-serif;color:#222222; }
.archive_header {border-bottom:1px solid #e6e6e6;}
.archive_header .catrss { display:none; }
</style>
<!-- Woo Shortcodes CSS -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/functions/css/shortcodes.css" rel="stylesheet" type="text/css"/>
<!-- Custom Stylesheet -->
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/themes/canvas-new/custom.css" rel="stylesheet" type="text/css"/>
<!-- Theme version -->
<meta content="Canvas 5.9.21" name="generator"/>
<meta content="WooFramework 6.2.9" name="generator"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-32x32.png" rel="icon" sizes="32x32"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-192x192.png" rel="icon" sizes="192x192"/>
<link href="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-180x180.png" rel="apple-touch-icon-precomposed"/>
<meta content="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/09/cropped-icon-270x270.png" name="msapplication-TileImage"/>
</head>
<body class="post-template-default single single-post postid-3930 single-format-standard chrome alt-style-default two-col-left width-960 two-col-left-960">
<div id="wrapper">
<div id="inner-wrapper">
<h3 class="nav-toggle icon"><a href="#navigation">Navigation</a></h3>
<header class="col-full" id="header">
<div id="logo">
<a href="https://machinelearningmastery.com/" title="Making developers awesome at machine learning"><img alt="Machine Learning Mastery" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/MachineLearningMastery.png"/></a>
<span class="site-title"><a href="https://machinelearningmastery.com/">Machine Learning Mastery</a></span>
<span class="site-description">Making developers awesome at machine learning</span>
</div>
<div class="header-widget">
<div class="widget widget_text" id="text-3"> <div class="textwidget"><br/>
<div style="font-size:12pt;">
<a href="/start-here"><strong>Start Here</strong></a>
     
<a href="/blog">Blog</a>
     
<a href="/products">Books</a>
     
<a href="/about">About</a>
     
<a href="/contact">Contact</a>
</div></div>
</div><div class="widget widget_search" id="search-3"><div class="search_main">
<form action="https://machinelearningmastery.com/" class="searchform" method="get">
<input class="field s" name="s" onblur="if (this.value == '') {this.value = 'Search...';}" onfocus="if (this.value == 'Search...') {this.value = '';}" type="text" value="Search..."/>
<button class="fa fa-search submit" name="submit" type="submit" value="Search"></button>
</form>
<div class="fix"></div>
</div></div><div class="widget widget_text" id="text-31"> <div class="textwidget"><p>Need help with LSTMs in Python? <a href="https://machinelearningmastery.lpages.co/lnwp-mini-course/">Take the FREE Mini-Course</a>.</p>
</div>
</div> </div>
</header>
<nav class="col-full" id="navigation" role="navigation">
<section class="menus">
<a class="nav-home" href="https://machinelearningmastery.com"><span>Home</span></a>
<h3>Empty Menu</h3> <div class="side-nav">
</div><!-- /#side-nav -->
</section><!-- /.menus -->
<a class="nav-close" href="#top"><span>Return to Content</span></a>
</nav>
<!-- #content Starts -->
<div class="col-full" id="content">
<div id="main-sidebar-container">
<!-- #main Starts -->
<section id="main">
<article class="post-3930 post type-post status-publish format-standard has-post-thumbnail hentry category-lstm">
<header>
<h1 class="title entry-title">Stateful and Stateless LSTM for Time Series Forecasting with Python</h1> </header>
<div class="post-meta"><span class="small">By</span> <span class="author vcard"><span class="fn"><a href="https://machinelearningmastery.com/author/jasonb/" rel="author" title="Posts by Jason Brownlee">Jason Brownlee</a></span></span> <span class="small">on</span> <abbr class="date time published updated" title="2017-04-21T05:00:12+1100">April 21, 2017</abbr> <span class="small">in</span> <span class="categories"><a href="https://machinelearningmastery.com/category/lstm/" title="View all items in Long Short-Term Memory Networks">Long Short-Term Memory Networks</a></span> </div>
<section class="entry">
<div class="apss-social-share apss-theme-4 clearfix">
<div class="apss-twitter apss-single-icon">
<a href="javascript:void(0);" onclick="apss_open_in_popup_window(event, 'https://twitter.com/intent/tweet?text=Stateful%20and%20Stateless%20LSTM%20for%20Time%20Series%20Forecasting%20with%20Python&amp;url=https%3A%2F%2Fmachinelearningmastery.com%2Fstateful-stateless-lstm-time-series-forecasting-python%2F&amp;');" rel="nofollow" target="" title="Share on Twitter">
<div class="apss-icon-block clearfix">
<i class="fa fa-twitter"></i>
<span class="apss-social-text">Share on Twitter</span><span class="apss-share">Tweet</span>
</div>
</a>
</div>
<div class="apss-facebook apss-single-icon">
<a href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/" onclick="apss_open_in_popup_window(event, 'https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/');" rel="nofollow" target="" title="Share on Facebook">
<div class="apss-icon-block clearfix">
<i class="fa fa-facebook"></i>
<span class="apss-social-text">Share on Facebook</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-linkedin apss-single-icon">
<a href="http://www.linkedin.com/shareArticle?mini=true&amp;title=Stateful%20and%20Stateless%20LSTM%20for%20Time%20Series%20Forecasting%20with%20Python&amp;url=https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/&amp;summary=The+Keras+Python+deep+learning+library+supports+both+stateful+and+stateless+Long+Short-Term+Memory+%28..." onclick="apss_open_in_popup_window(event, 'http://www.linkedin.com/shareArticle?mini=true&amp;title=Stateful%20and%20Stateless%20LSTM%20for%20Time%20Series%20Forecasting%20with%20Python&amp;url=https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/&amp;summary=The+Keras+Python+deep+learning+library+supports+both+stateful+and+stateless+Long+Short-Term+Memory+%28...');" rel="nofollow" target="" title="Share on LinkedIn">
<div class="apss-icon-block clearfix"><i class="fa fa-linkedin"></i>
<span class="apss-social-text">Share on LinkedIn</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-google-plus apss-single-icon">
<a href="https://plus.google.com/share?url=https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/" onclick="apss_open_in_popup_window(event, 'https://plus.google.com/share?url=https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/');" rel="nofollow" target="" title="Share on Google Plus">
<div class="apss-icon-block clearfix">
<i class="fa fa-google-plus"></i>
<span class="apss-social-text">Share on Google Plus</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
</div><p>The Keras Python deep learning library supports both stateful and stateless Long Short-Term Memory (LSTM) networks.</p>
<p>When using stateful LSTM networks, we have fine-grained control over when the internal state of the LSTM network is reset. Therefore, it is important to understand different ways of managing this internal state when fitting and making predictions with LSTM networks affect the skill of the network.</p>
<p>In this tutorial, you will explore the performance of stateful and stateless LSTM networks in Keras for time series forecasting.</p>
<p>After completing this tutorial, you will know:</p>
<ul>
<li>How to compare and contrast stateful and stateless LSTM networks for time series forecasts.</li>
<li>How the batch size in stateless LSTMs relate to stateful LSTM networks.</li>
<li>How to evaluate and compare different state resetting regimes for stateful LSTM networks.</li>
</ul>
<p>Let’s get started.</p>
<div class="wp-caption aligncenter" id="attachment_3935" style="max-width: 650px"><img alt="Stateful and Stateless LSTM for Time Series Forecasting with Python" class="size-full wp-image-3935" height="427" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/04/Stateful-and-Stateless-LSTM-for-Time-Series-Forecasting-with-Python.jpg" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/04/Stateful-and-Stateless-LSTM-for-Time-Series-Forecasting-with-Python.jpg 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/04/Stateful-and-Stateless-LSTM-for-Time-Series-Forecasting-with-Python-300x200.jpg 300w" width="640"/><p class="wp-caption-text">Stateful and Stateless LSTM for Time Series Forecasting with Python<br/>Photo by <a href="https://www.flickr.com/photos/39908901@N06/33414952872/">m01229</a>, some rights reserved.</p></div>
<h2>Tutorial Overview</h2>
<p>This tutorial is broken down into 7 parts. They are:</p>
<ol>
<li>Shampoo Sales Dataset</li>
<li>Experimental Test Harness</li>
<li>A vs A Test</li>
<li>Stateful vs Stateless</li>
<li>Stateless With Large Batch vs Stateless</li>
<li>Stateful Resetting vs Stateless</li>
<li>Review of Findings</li>
</ol>
<h3>Environment</h3>
<p>This tutorial assumes you have a Python SciPy environment installed. You can use either Python 2 or 3 with this example.</p>
<p>This tutorial assumes you have Keras v2.0 or higher installed with either the TensorFlow or Theano backend.</p>
<p>This tutorial also assumes you have scikit-learn, Pandas, NumPy, and Matplotlib installed.</p>
<p>If you need help setting up your Python environment, see this post:</p>
<ul>
<li><a href="http://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/">How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda</a></li>
</ul>
<!-- Start shortcoder --><div class="woo-sc-hr"></div>
<center>
<h3>Need help with LSTMs for Sequence Prediction?</h3>
<p>Take my free 7-day email course and discover 6 different LSTM architectures (with sample code).</p>
<p>Click to sign-up and also get a free PDF Ebook version of the course.</p>
<p><a href="https://machinelearningmastery.lpages.co/leadbox/1403a9373f72a2%3A164f8be4f346dc/5754903989321728/" rel="noopener" style="background: #ffce0a; color: #ffffff; text-decoration: none; font-family: Helvetica, Arial, sans-serif; font-weight: bold; font-size: 16px; line-height: 20px; padding: 10px; display: inline-block; max-width: 300px; border-radius: 5px; text-shadow: rgba(0, 0, 0, 0.25) 0px -1px 1px; box-shadow: rgba(255, 255, 255, 0.5) 0px 1px 3px inset, rgba(0, 0, 0, 0.5) 0px 1px 3px;" target="_blank">Start Your FREE Mini-Course Now!</a><script data-config="%7B%7D" data-leadbox="1403a9373f72a2:164f8be4f346dc" data-url="https://machinelearningmastery.lpages.co/leadbox/1403a9373f72a2%3A164f8be4f346dc/5754903989321728/" src="https://machinelearningmastery.lpages.co/leadbox-1500400021.js" type="text/javascript"></script></p>
</center>
<div class="woo-sc-hr"></div><!-- End shortcoder v4.1.5-->
<h2>Shampoo Sales Dataset</h2>
<p>This dataset describes the monthly number of sales of shampoo over a 3-year period.</p>
<p>The units are a sales count and there are 36 observations. The original dataset is credited to Makridakis, Wheelwright, and Hyndman (1998).</p>
<p><a href="https://datamarket.com/data/set/22r0/sales-of-shampoo-over-a-three-year-period">You can download and learn more about the dataset here</a>.</p>
<p>The example below loads and creates a plot of the loaded dataset.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e768243279278" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# load and plot dataset
from pandas import read_csv
from pandas import datetime
from matplotlib import pyplot
# load dataset
def parser(x):
	return datetime.strptime('190'+x, '%Y-%m')
series = read_csv('shampoo-sales.csv', header=0, parse_dates=[0], index_col=0, squeeze=True, date_parser=parser)
# summarize first few rows
print(series.head())
# line plot
series.plot()
pyplot.show()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e768243279278-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e768243279278-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e768243279278-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e768243279278-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e768243279278-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e768243279278-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e768243279278-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e768243279278-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e768243279278-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e768243279278-10">10</div><div class="crayon-num" data-line="crayon-5a658abc2e768243279278-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e768243279278-12">12</div><div class="crayon-num" data-line="crayon-5a658abc2e768243279278-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e768243279278-1"><span class="crayon-p"># load and plot dataset</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e768243279278-2"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line" id="crayon-5a658abc2e768243279278-3"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">datetime</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e768243279278-4"><span class="crayon-e">from </span><span class="crayon-e">matplotlib </span><span class="crayon-e">import </span><span class="crayon-v">pyplot</span></div><div class="crayon-line" id="crayon-5a658abc2e768243279278-5"><span class="crayon-p"># load dataset</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e768243279278-6"><span class="crayon-e">def </span><span class="crayon-e">parser</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e768243279278-7"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">datetime</span><span class="crayon-sy">.</span><span class="crayon-e">strptime</span><span class="crayon-sy">(</span><span class="crayon-s">'190'</span><span class="crayon-o">+</span><span class="crayon-v">x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'%Y-%m'</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e768243279278-8"><span class="crayon-v">series</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'shampoo-sales.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">squeeze</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">date_parser</span><span class="crayon-o">=</span><span class="crayon-v">parser</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e768243279278-9"><span class="crayon-p"># summarize first few rows</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e768243279278-10"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">series</span><span class="crayon-sy">.</span><span class="crayon-e">head</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e768243279278-11"><span class="crayon-p"># line plot</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e768243279278-12"><span class="crayon-v">series</span><span class="crayon-sy">.</span><span class="crayon-e">plot</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e768243279278-13"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">show</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0010 seconds] -->
<p>Running the example loads the dataset as a Pandas Series and prints the first 5 rows.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e772466845983" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
Month
1901-01-01 266.0
1901-02-01 145.9
1901-03-01 183.1
1901-04-01 119.3
1901-05-01 180.3
Name: Sales, dtype: float64</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e772466845983-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e772466845983-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e772466845983-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e772466845983-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e772466845983-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e772466845983-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e772466845983-7">7</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e772466845983-1">Month</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e772466845983-2">1901-01-01 266.0</div><div class="crayon-line" id="crayon-5a658abc2e772466845983-3">1901-02-01 145.9</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e772466845983-4">1901-03-01 183.1</div><div class="crayon-line" id="crayon-5a658abc2e772466845983-5">1901-04-01 119.3</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e772466845983-6">1901-05-01 180.3</div><div class="crayon-line" id="crayon-5a658abc2e772466845983-7">Name: Sales, dtype: float64</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>A line plot of the series is then created showing a clear increasing trend.</p>
<div class="wp-caption aligncenter" id="attachment_3901" style="max-width: 650px"><img alt="Line Plot of Shampoo Sales Dataset" class="size-full wp-image-3901" height="480" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Line-Plot-of-Shampoo-Sales-Dataset-1.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Line-Plot-of-Shampoo-Sales-Dataset-1.png 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Line-Plot-of-Shampoo-Sales-Dataset-1-300x225.png 300w" width="640"/><p class="wp-caption-text">Line Plot of Shampoo Sales Dataset</p></div>
<p>Next, we will take a look at the LSTM configuration and test harness used in the experiment.</p>
<h2>Experimental Test Harness</h2>
<p>This section describes the test harness used in this tutorial.</p>
<h3>Data Split</h3>
<p>We will split the Shampoo Sales dataset into two parts: a training and a test set.</p>
<p>The first two years of data will be taken for the training dataset and the remaining one year of data will be used for the test set.</p>
<p>Models will be developed using the training dataset and will make predictions on the test dataset.</p>
<p>The persistence forecast (naive forecast) on the test dataset achieves an error of 136.761 monthly shampoo sales. This provides a lower acceptable bound of performance on the test set.</p>
<h3>Model Evaluation</h3>
<p>A rolling-forecast scenario will be used, also called walk-forward model validation.</p>
<p>Each time step of the test dataset will be walked one at a time. A model will be used to make a forecast for the time step, then the actual expected value from the test set will be taken and made available to the model for the forecast on the next time step.</p>
<p>This mimics a real-world scenario where new Shampoo Sales observations would be available each month and used in the forecasting of the following month.</p>
<p>This will be simulated by the structure of the train and test datasets.</p>
<p>All forecasts on the test dataset will be collected and an error score calculated to summarize the skill of the model. The root mean squared error (RMSE) will be used as it punishes large errors and results in a score that is in the same units as the forecast data, namely monthly shampoo sales.</p>
<h3>Data Preparation</h3>
<p>Before we can fit an LSTM model to the dataset, we must transform the data.</p>
<p>The following three data transforms are performed on the dataset prior to fitting a model and making a forecast.</p>
<ol>
<li><strong>Transform the time series data so that it is stationary</strong>. Specifically, a lag=1 differencing to remove the increasing trend in the data.</li>
<li><strong>Transform the time series into a supervised learning problem</strong>. Specifically, the organization of data into input and output patterns where the observation at the previous time step is used as an input to forecast the observation at the current time step</li>
<li><strong>Transform the observations to have a specific scale</strong>. Specifically, to rescale the data to values between -1 and 1 to meet the default hyperbolic tangent activation function of the LSTM model.</li>
</ol>
<p>These transforms are inverted on forecasts to return them into their original scale before calculating and error score.</p>
<h3>LSTM Model</h3>
<p>We will use a base stateful LSTM model with 1 neuron fit for 1000 epochs.</p>
<p>A batch size of 1 is required as we will be using walk-forward validation and making one-step forecasts for each of the final 12 months of test data.</p>
<p>A batch size of 1 means that the model will be fit using online training (as opposed to batch training or mini-batch training). As a result, it is expected that the model fit will have some variance.</p>
<p>Ideally, more training epochs would be used (such as 1500), but this was truncated to 1000 to keep run times reasonable.</p>
<p>The model will be fit using the efficient ADAM optimization algorithm and the mean squared error loss function.</p>
<h3>Experimental Runs</h3>
<p>Each experimental scenario will be run 10 times.</p>
<p>The reason for this is that the random initial conditions for an LSTM network can result in very different results each time a given configuration is trained.</p>
<p>Let’s dive into the experiments.</p>
<h2>A vs A Test</h2>
<p>A good first experiment is to evaluate how noisy or reliable our test harness may be.</p>
<p>This can be evaluated by running the same experiment twice and comparing the results. This is often called an A vs A test in the world of <a href="https://en.wikipedia.org/wiki/A/B_testing">A/B testing</a>, and I find this name useful. The idea is to flush out any obvious faults with the experiment and get a handle on the expected variance in the mean value.</p>
<p>We will run an experiment with a stateful LSTM on the network twice.</p>
<p>The complete code listing is provided below.</p>
<p>This code also provides the basis for all experiments in this tutorial. Rather than re-listing it for each variation in subsequent sections, I will only list the functions that have been changed.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e778264446060" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from pandas import DataFrame
from pandas import Series
from pandas import concat
from pandas import read_csv
from pandas import datetime
from sklearn.metrics import mean_squared_error
from sklearn.preprocessing import MinMaxScaler
from keras.models import Sequential
from keras.layers import Dense
from keras.layers import LSTM
from math import sqrt
import matplotlib
import numpy
from numpy import concatenate

# date-time parsing function for loading the dataset
def parser(x):
	return datetime.strptime('190'+x, '%Y-%m')

# frame a sequence as a supervised learning problem
def timeseries_to_supervised(data, lag=1):
	df = DataFrame(data)
	columns = [df.shift(i) for i in range(1, lag+1)]
	columns.append(df)
	df = concat(columns, axis=1)
	return df

# create a differenced series
def difference(dataset, interval=1):
	diff = list()
	for i in range(interval, len(dataset)):
		value = dataset[i] - dataset[i - interval]
		diff.append(value)
	return Series(diff)

# invert differenced value
def inverse_difference(history, yhat, interval=1):
	return yhat + history[-interval]

# scale train and test data to [-1, 1]
def scale(train, test):
	# fit scaler
	scaler = MinMaxScaler(feature_range=(-1, 1))
	scaler = scaler.fit(train)
	# transform train
	train = train.reshape(train.shape[0], train.shape[1])
	train_scaled = scaler.transform(train)
	# transform test
	test = test.reshape(test.shape[0], test.shape[1])
	test_scaled = scaler.transform(test)
	return scaler, train_scaled, test_scaled

# inverse scaling for a forecasted value
def invert_scale(scaler, X, yhat):
	new_row = [x for x in X] + [yhat]
	array = numpy.array(new_row)
	array = array.reshape(1, len(array))
	inverted = scaler.inverse_transform(array)
	return inverted[0, -1]

# fit an LSTM network to training data
def fit_lstm(train, batch_size, nb_epoch, neurons):
	X, y = train[:, 0:-1], train[:, -1]
	X = X.reshape(X.shape[0], 1, X.shape[1])
	model = Sequential()
	model.add(LSTM(neurons, batch_input_shape=(batch_size, X.shape[1], X.shape[2]), stateful=True))
	model.add(Dense(1))
	model.compile(loss='mean_squared_error', optimizer='adam')
	for i in range(nb_epoch):
		model.fit(X, y, epochs=1, batch_size=batch_size, verbose=0, shuffle=False)
		model.reset_states()
	return model

# make a one-step forecast
def forecast_lstm(model, batch_size, X):
	X = X.reshape(1, 1, len(X))
	yhat = model.predict(X, batch_size=batch_size)
	return yhat[0,0]

# run a repeated experiment
def experiment(repeats, series):
	# transform data to be stationary
	raw_values = series.values
	diff_values = difference(raw_values, 1)
	# transform data to be supervised learning
	supervised = timeseries_to_supervised(diff_values, 1)
	supervised_values = supervised.values[1:,:]
	# split data into train and test-sets
	train, test = supervised_values[0:-12, :], supervised_values[-12:, :]
	# transform the scale of the data
	scaler, train_scaled, test_scaled = scale(train, test)
	# run experiment
	error_scores = list()
	for r in range(repeats):
		# fit the base model
		lstm_model = fit_lstm(train_scaled, 1, 1000, 1)
		# forecast test dataset
		predictions = list()
		for i in range(len(test_scaled)):
			# predict
			X, y = test_scaled[i, 0:-1], test_scaled[i, -1]
			yhat = forecast_lstm(lstm_model, 1, X)
			# invert scaling
			yhat = invert_scale(scaler, X, yhat)
			# invert differencing
			yhat = inverse_difference(raw_values, yhat, len(test_scaled)+1-i)
			# store forecast
			predictions.append(yhat)
		# report performance
		rmse = sqrt(mean_squared_error(raw_values[-12:], predictions))
		print('%d) Test RMSE: %.3f' % (r+1, rmse))
		error_scores.append(rmse)
	return error_scores

# execute the experiment
def run():
	# load dataset
	series = read_csv('shampoo-sales.csv', header=0, parse_dates=[0], index_col=0, squeeze=True, date_parser=parser)
	# experiment
	repeats = 10
	results = DataFrame()
	# run experiment
	results['results'] = experiment(repeats, series)
	# summarize results
	print(results.describe())
	# save results
	results.to_csv('experiment_stateful.csv', index=False)

 # entry point
run()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-10">10</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-12">12</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-14">14</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-16">16</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-18">18</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-20">20</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-22">22</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-24">24</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-26">26</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-28">28</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-30">30</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-32">32</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-34">34</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-36">36</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-38">38</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-40">40</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-42">42</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-43">43</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-44">44</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-45">45</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-46">46</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-47">47</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-48">48</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-49">49</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-50">50</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-51">51</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-52">52</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-53">53</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-54">54</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-55">55</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-56">56</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-57">57</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-58">58</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-59">59</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-60">60</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-61">61</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-62">62</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-63">63</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-64">64</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-65">65</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-66">66</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-67">67</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-68">68</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-69">69</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-70">70</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-71">71</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-72">72</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-73">73</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-74">74</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-75">75</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-76">76</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-77">77</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-78">78</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-79">79</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-80">80</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-81">81</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-82">82</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-83">83</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-84">84</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-85">85</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-86">86</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-87">87</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-88">88</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-89">89</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-90">90</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-91">91</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-92">92</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-93">93</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-94">94</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-95">95</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-96">96</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-97">97</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-98">98</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-99">99</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-100">100</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-101">101</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-102">102</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-103">103</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-104">104</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-105">105</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-106">106</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-107">107</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-108">108</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-109">109</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-110">110</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-111">111</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-112">112</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-113">113</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-114">114</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-115">115</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-116">116</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-117">117</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-118">118</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-119">119</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-120">120</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-121">121</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-122">122</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-123">123</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-124">124</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-125">125</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-126">126</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-127">127</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-128">128</div><div class="crayon-num" data-line="crayon-5a658abc2e778264446060-129">129</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e778264446060-130">130</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e778264446060-1"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">DataFrame</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-2"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">Series</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-3"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">concat</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-4"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-5"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">datetime</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-6"><span class="crayon-e">from </span><span class="crayon-v">sklearn</span><span class="crayon-sy">.</span><span class="crayon-e">metrics </span><span class="crayon-e">import </span><span class="crayon-e">mean_squared_error</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-7"><span class="crayon-e">from </span><span class="crayon-v">sklearn</span><span class="crayon-sy">.</span><span class="crayon-e">preprocessing </span><span class="crayon-e">import </span><span class="crayon-e">MinMaxScaler</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-8"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">models </span><span class="crayon-e">import </span><span class="crayon-e">Sequential</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-9"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">Dense</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-10"><span class="crayon-e">from </span><span class="crayon-v">keras</span><span class="crayon-sy">.</span><span class="crayon-e">layers </span><span class="crayon-e">import </span><span class="crayon-e">LSTM</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-11"><span class="crayon-e">from </span><span class="crayon-e">math </span><span class="crayon-e">import </span><span class="crayon-e">sqrt</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-12"><span class="crayon-e">import </span><span class="crayon-e">matplotlib</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-13"><span class="crayon-e">import </span><span class="crayon-e">numpy</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-14"><span class="crayon-e">from </span><span class="crayon-e">numpy </span><span class="crayon-e">import </span><span class="crayon-v">concatenate</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-15"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-16"><span class="crayon-p"># date-time parsing function for loading the dataset</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-17"><span class="crayon-e">def </span><span class="crayon-e">parser</span><span class="crayon-sy">(</span><span class="crayon-v">x</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-18"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">datetime</span><span class="crayon-sy">.</span><span class="crayon-e">strptime</span><span class="crayon-sy">(</span><span class="crayon-s">'190'</span><span class="crayon-o">+</span><span class="crayon-v">x</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'%Y-%m'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-19"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-20"><span class="crayon-p"># frame a sequence as a supervised learning problem</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-21"><span class="crayon-e">def </span><span class="crayon-e">timeseries_to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">lag</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-22"><span class="crayon-h"> </span><span class="crayon-v">df</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-v">data</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-23"><span class="crayon-h"> </span><span class="crayon-v">columns</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">df</span><span class="crayon-sy">.</span><span class="crayon-e">shift</span><span class="crayon-sy">(</span><span class="crayon-v">i</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">lag</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-24"><span class="crayon-h"> </span><span class="crayon-v">columns</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">df</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-25"><span class="crayon-h"> </span><span class="crayon-v">df</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">concat</span><span class="crayon-sy">(</span><span class="crayon-v">columns</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">axis</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-26"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">df</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-27"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-28"><span class="crayon-p"># create a differenced series</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-29"><span class="crayon-e">def </span><span class="crayon-e">difference</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">interval</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-30"><span class="crayon-h"> </span><span class="crayon-v">diff</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-31"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">interval</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">dataset</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-32"><span class="crayon-h"> </span><span class="crayon-v">value</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">dataset</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-h"> </span><span class="crayon-v">interval</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-33"><span class="crayon-h"> </span><span class="crayon-v">diff</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">value</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-34"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-e">Series</span><span class="crayon-sy">(</span><span class="crayon-v">diff</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-35"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-36"><span class="crayon-p"># invert differenced value</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-37"><span class="crayon-e">def </span><span class="crayon-e">inverse_difference</span><span class="crayon-sy">(</span><span class="crayon-v">history</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">interval</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-38"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-v">history</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-v">interval</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-39"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-40"><span class="crayon-p"># scale train and test data to [-1, 1]</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-41"><span class="crayon-e">def </span><span class="crayon-e">scale</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-42"><span class="crayon-h"> </span><span class="crayon-p"># fit scaler</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-43"><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">MinMaxScaler</span><span class="crayon-sy">(</span><span class="crayon-v">feature_range</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-44"><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-45"><span class="crayon-h"> </span><span class="crayon-p"># transform train</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-46"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-47"><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">.</span><span class="crayon-e">transform</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-48"><span class="crayon-h"> </span><span class="crayon-p"># transform test</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-49"><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-50"><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">.</span><span class="crayon-e">transform</span><span class="crayon-sy">(</span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-51"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-52"> </div><div class="crayon-line" id="crayon-5a658abc2e778264446060-53"><span class="crayon-p"># inverse scaling for a forecasted value</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-54"><span class="crayon-e">def </span><span class="crayon-e">invert_scale</span><span class="crayon-sy">(</span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-55"><span class="crayon-h"> </span><span class="crayon-v">new_row</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">x</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">+</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-v">yhat</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-56"><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">numpy</span><span class="crayon-sy">.</span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">new_row</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-57"><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-t">array</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-t">array</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-58"><span class="crayon-h"> </span><span class="crayon-v">inverted</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">.</span><span class="crayon-e">inverse_transform</span><span class="crayon-sy">(</span><span class="crayon-t">array</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-59"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">inverted</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-60"> </div><div class="crayon-line" id="crayon-5a658abc2e778264446060-61"><span class="crayon-p"># fit an LSTM network to training data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-62"><span class="crayon-e">def </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">neurons</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-63"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-64"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-65"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-66"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-v">neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">stateful</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-67"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-68"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mean_squared_error'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-69"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-70"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">shuffle</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-71"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">reset_states</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-72"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-73"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-74"><span class="crayon-p"># make a one-step forecast</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-75"><span class="crayon-e">def </span><span class="crayon-e">forecast_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-76"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-77"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-78"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-79"> </div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-80"><span class="crayon-p"># run a repeated experiment</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-81"><span class="crayon-e">def </span><span class="crayon-e">experiment</span><span class="crayon-sy">(</span><span class="crayon-v">repeats</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-82"><span class="crayon-h"> </span><span class="crayon-p"># transform data to be stationary</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-83"><span class="crayon-h"> </span><span class="crayon-v">raw_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-sy">.</span><span class="crayon-e">values</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-84"><span class="crayon-e"> </span><span class="crayon-v">diff_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">difference</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-85"><span class="crayon-h"> </span><span class="crayon-p"># transform data to be supervised learning</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-86"><span class="crayon-h"> </span><span class="crayon-v">supervised</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">timeseries_to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">diff_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-87"><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">supervised</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-88"><span class="crayon-h"> </span><span class="crayon-p"># split data into train and test-sets</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-89"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-90"><span class="crayon-h"> </span><span class="crayon-p"># transform the scale of the data</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-91"><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">scale</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-92"><span class="crayon-h"> </span><span class="crayon-p"># run experiment</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-93"><span class="crayon-h"> </span><span class="crayon-v">error_scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-94"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">r</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">repeats</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-95"><span class="crayon-h"> </span><span class="crayon-p"># fit the base model</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-96"><span class="crayon-h"> </span><span class="crayon-v">lstm_model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train_scaled</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1000</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-97"><span class="crayon-h"> </span><span class="crayon-p"># forecast test dataset</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-98"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-99"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_scaled</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-100"><span class="crayon-h"> </span><span class="crayon-p"># predict</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-101"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-102"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">forecast_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">lstm_model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-103"><span class="crayon-h"> </span><span class="crayon-p"># invert scaling</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-104"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">invert_scale</span><span class="crayon-sy">(</span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-105"><span class="crayon-h"> </span><span class="crayon-p"># invert differencing</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-106"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">inverse_difference</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_scaled</span><span class="crayon-sy">)</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-o">-</span><span class="crayon-v">i</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-107"><span class="crayon-h"> </span><span class="crayon-p"># store forecast</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-108"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-109"><span class="crayon-h"> </span><span class="crayon-p"># report performance</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-110"><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-e">mean_squared_error</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-111"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'%d) Test RMSE: %.3f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">r</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-112"><span class="crayon-h"> </span><span class="crayon-v">error_scores</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-113"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">error_scores</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-114"> </div><div class="crayon-line" id="crayon-5a658abc2e778264446060-115"><span class="crayon-p"># execute the experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-116"><span class="crayon-e">def </span><span class="crayon-e">run</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-117"><span class="crayon-h"> </span><span class="crayon-p"># load dataset</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-118"><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'shampoo-sales.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">parse_dates</span><span class="crayon-o">=</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index_col</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">squeeze</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">date_parser</span><span class="crayon-o">=</span><span class="crayon-v">parser</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-119"><span class="crayon-h"> </span><span class="crayon-p"># experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-120"><span class="crayon-h"> </span><span class="crayon-v">repeats</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">10</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-121"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-122"><span class="crayon-h"> </span><span class="crayon-p"># run experiment</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-123"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-s">'results'</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">experiment</span><span class="crayon-sy">(</span><span class="crayon-v">repeats</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-124"><span class="crayon-h"> </span><span class="crayon-p"># summarize results</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-125"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">describe</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-126"><span class="crayon-h"> </span><span class="crayon-p"># save results</span></div><div class="crayon-line" id="crayon-5a658abc2e778264446060-127"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">to_csv</span><span class="crayon-sy">(</span><span class="crayon-s">'experiment_stateful.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">index</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-128"> </div><div class="crayon-line" id="crayon-5a658abc2e778264446060-129"><span class="crayon-h"> </span><span class="crayon-p"># entry point</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e778264446060-130"><span class="crayon-e">run</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0120 seconds] -->
<p>Running the experiment saves the results to a file named “<em>experiment_stateful.csv</em>“.</p>
<p>Run the experiment a second time and change the filename written by the experiment to “<em>experiment_stateful2.csv</em>” as to not overwrite the results from the first run.</p>
<p>You should now have two sets of results in the current working directory in the files:</p>
<ul>
<li><em>experiment_stateful.csv</em></li>
<li><em>experiment_stateful2.csv</em></li>
</ul>
<p>We can now load and compare these two files. The script to do this is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e77e923492329" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from pandas import DataFrame
from pandas import read_csv
from matplotlib import pyplot
# load results into a dataframe
filenames = ['experiment_stateful.csv', 'experiment_stateful2.csv']
results = DataFrame()
for name in filenames:
	results[name[11:-4]] = read_csv(name, header=0)
# describe all results
print(results.describe())
# box and whisker plot
results.boxplot()
pyplot.show()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e77e923492329-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e77e923492329-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e77e923492329-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e77e923492329-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e77e923492329-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e77e923492329-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e77e923492329-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e77e923492329-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e77e923492329-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e77e923492329-10">10</div><div class="crayon-num" data-line="crayon-5a658abc2e77e923492329-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e77e923492329-12">12</div><div class="crayon-num" data-line="crayon-5a658abc2e77e923492329-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e77e923492329-1"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">DataFrame</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e77e923492329-2"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line" id="crayon-5a658abc2e77e923492329-3"><span class="crayon-e">from </span><span class="crayon-e">matplotlib </span><span class="crayon-e">import </span><span class="crayon-v">pyplot</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e77e923492329-4"><span class="crayon-p"># load results into a dataframe</span></div><div class="crayon-line" id="crayon-5a658abc2e77e923492329-5"><span class="crayon-v">filenames</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">'experiment_stateful.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'experiment_stateful2.csv'</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e77e923492329-6"><span class="crayon-v">results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e77e923492329-7"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">filenames</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e77e923492329-8"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-v">name</span><span class="crayon-sy">[</span><span class="crayon-cn">11</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">4</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e77e923492329-9"><span class="crayon-p"># describe all results</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e77e923492329-10"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">describe</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e77e923492329-11"><span class="crayon-p"># box and whisker plot</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e77e923492329-12"><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">boxplot</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e77e923492329-13"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">show</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>This script loads the result files and first calculates descriptive statistics for each run.</p>
<p>We can see that the mean results and standard deviation are relatively close values (around 103-106 and 7-10 respectively). This is a good sign, but not perfect. It is expected that increasing the number of repeats of the experiment from 10 to 30, 100, or even 1000 would produce near identical summary statistics.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e781156255270" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
         stateful   stateful2
count   10.000000   10.000000
mean   103.142903  106.594624
std      7.109461   10.687509
min     94.052380   91.570179
25%     96.765985  101.015403
50%    104.376252  102.425406
75%    107.753516  115.024920
max    114.958430  125.088436</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e781156255270-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e781156255270-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e781156255270-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e781156255270-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e781156255270-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e781156255270-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e781156255270-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e781156255270-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e781156255270-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e781156255270-1">         stateful   stateful2</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e781156255270-2">count   10.000000   10.000000</div><div class="crayon-line" id="crayon-5a658abc2e781156255270-3">mean   103.142903  106.594624</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e781156255270-4">std      7.109461   10.687509</div><div class="crayon-line" id="crayon-5a658abc2e781156255270-5">min     94.052380   91.570179</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e781156255270-6">25%     96.765985  101.015403</div><div class="crayon-line" id="crayon-5a658abc2e781156255270-7">50%    104.376252  102.425406</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e781156255270-8">75%    107.753516  115.024920</div><div class="crayon-line" id="crayon-5a658abc2e781156255270-9">max    114.958430  125.088436</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>The comparison also creates a box and whisker plot to compare the two distributions.</p>
<p>The plot shows the 25th, 50th (median), and 75th percentile of 10 test RMSE results from each experiment. The box shows the middle 50% of the data and the green line shows the median.</p>
<p>The plot shows that although the descriptive statistics are reasonably close, the distributions do show some differences.</p>
<p>Nevertheless, the distributions do overlap and comparing means and standard deviations of different experimental setups is reasonable as long as we don’t quibble over modest differences in mean.</p>
<div class="wp-caption aligncenter" id="attachment_3931" style="max-width: 650px"><img alt="Box and Whisker Plot of A vs A Experimental Results" class="size-full wp-image-3931" height="480" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-A-vs-A-Experimental-Results.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-A-vs-A-Experimental-Results.png 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-A-vs-A-Experimental-Results-300x225.png 300w" width="640"/><p class="wp-caption-text">Box and Whisker Plot of A vs A Experimental Results</p></div>
<p>A good follow-up to this analysis is to review the standard error of the distribution with different sample sizes. This would involve first creating a larger pool of experimental runs from which to draw (100 or 1000), and would give a good idea of a robust number of repeats and an expected error on the mean when comparing results.</p>
<h2>Stateful vs Stateless LSTMs</h2>
<p>A good first experiment is to explore whether maintaining state in the LSTM adds value over not maintaining state.</p>
<p>In this section, we will contrast:</p>
<ol>
<li>A Stateful LSTM (first result from the previous section).</li>
<li>A Stateless LSTM with the same configuration.</li>
<li>A Stateless LSTM with shuffling during training.</li>
</ol>
<p>The benefit of LSTM networks is their ability to maintain state and learn a sequence.</p>
<ul>
<li><strong>Expectation 1</strong>: The expectation is that the stateful LSTM will outperform the stateless LSTM.</li>
</ul>
<p>Shuffling of input patterns each batch or epoch is often performed to improve the generalizability of an MLP network during training. A stateless LSTM does not shuffle input patterns during training because the network aims to learn the sequence of patterns. We will test a stateless LSTM with and without shuffling.</p>
<ul>
<li><strong>Expectation 2</strong>: The expectation is that the stateless LSTM without shuffling will outperform the stateless LSTM with shuffling.</li>
</ul>
<p>The code changes to the stateful LSTM example above to make it stateless involve setting <em>stateless=False</em> in the LSTM layer and the use of automated training epoch training rather than manual. The results are written to a new file named “<em>experiment_stateless.csv</em>“. The updated <em>fit_lstm()</em> function is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e785132109145" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# fit an LSTM network to training data
def fit_lstm(train, batch_size, nb_epoch, neurons):
	X, y = train[:, 0:-1], train[:, -1]
	X = X.reshape(X.shape[0], 1, X.shape[1])
	model = Sequential()
	model.add(LSTM(neurons, batch_input_shape=(batch_size, X.shape[1], X.shape[2]), stateful=False))
	model.add(Dense(1))
	model.compile(loss='mean_squared_error', optimizer='adam')
	model.fit(X, y, epochs=nb_epoch, batch_size=batch_size, verbose=0, shuffle=False)
	return model</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e785132109145-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e785132109145-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e785132109145-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e785132109145-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e785132109145-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e785132109145-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e785132109145-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e785132109145-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e785132109145-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e785132109145-10">10</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e785132109145-1"><span class="crayon-p"># fit an LSTM network to training data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e785132109145-2"><span class="crayon-e">def </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">neurons</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e785132109145-3"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e785132109145-4"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e785132109145-5"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e785132109145-6"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-v">neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">stateful</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e785132109145-7"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e785132109145-8"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mean_squared_error'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e785132109145-9"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">shuffle</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e785132109145-10"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0017 seconds] -->
<p>The stateless with shuffling experiment involves setting the <em>shuffle</em> argument to <em>True</em> when calling fit in the <em>fit_lstm()</em> function. The results from this experiment are written to the file “<em>experiment_stateless_shuffle.csv</em>“.</p>
<p>The complete updated <em>fit_lstm()</em> function is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e788786420413" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# fit an LSTM network to training data
def fit_lstm(train, batch_size, nb_epoch, neurons):
	X, y = train[:, 0:-1], train[:, -1]
	X = X.reshape(X.shape[0], 1, X.shape[1])
	model = Sequential()
	model.add(LSTM(neurons, batch_input_shape=(batch_size, X.shape[1], X.shape[2]), stateful=False))
	model.add(Dense(1))
	model.compile(loss='mean_squared_error', optimizer='adam')
	model.fit(X, y, epochs=nb_epoch, batch_size=batch_size, verbose=0, shuffle=True)
	return model</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e788786420413-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e788786420413-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e788786420413-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e788786420413-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e788786420413-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e788786420413-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e788786420413-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e788786420413-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e788786420413-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e788786420413-10">10</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e788786420413-1"><span class="crayon-p"># fit an LSTM network to training data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e788786420413-2"><span class="crayon-e">def </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">neurons</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e788786420413-3"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e788786420413-4"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e788786420413-5"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e788786420413-6"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-v">neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">stateful</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e788786420413-7"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e788786420413-8"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mean_squared_error'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e788786420413-9"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">shuffle</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e788786420413-10"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0018 seconds] -->
<p>After running the experiments, you should have three result files for comparison:</p>
<ul>
<li><em>experiment_stateful.csv</em></li>
<li><em>experiment_stateless.csv</em></li>
<li><em>experiment_stateless_shuffle.csv</em></li>
</ul>
<p>We can now load and compare these results. The complete example for comparing the results is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e78b783488491" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from pandas import DataFrame
from pandas import read_csv
from matplotlib import pyplot
# load results into a dataframe
filenames = ['experiment_stateful.csv', 'experiment_stateless.csv',
	'experiment_stateless_shuffle.csv']
results = DataFrame()
for name in filenames:
	results[name[11:-4]] = read_csv(name, header=0)
# describe all results
print(results.describe())
# box and whisker plot
results.boxplot()
pyplot.show()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e78b783488491-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e78b783488491-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e78b783488491-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e78b783488491-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e78b783488491-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e78b783488491-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e78b783488491-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e78b783488491-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e78b783488491-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e78b783488491-10">10</div><div class="crayon-num" data-line="crayon-5a658abc2e78b783488491-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e78b783488491-12">12</div><div class="crayon-num" data-line="crayon-5a658abc2e78b783488491-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e78b783488491-14">14</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e78b783488491-1"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">DataFrame</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e78b783488491-2"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line" id="crayon-5a658abc2e78b783488491-3"><span class="crayon-e">from </span><span class="crayon-e">matplotlib </span><span class="crayon-e">import </span><span class="crayon-v">pyplot</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e78b783488491-4"><span class="crayon-p"># load results into a dataframe</span></div><div class="crayon-line" id="crayon-5a658abc2e78b783488491-5"><span class="crayon-v">filenames</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">'experiment_stateful.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'experiment_stateless.csv'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e78b783488491-6"><span class="crayon-h"> </span><span class="crayon-s">'experiment_stateless_shuffle.csv'</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658abc2e78b783488491-7"><span class="crayon-v">results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e78b783488491-8"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">filenames</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e78b783488491-9"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-v">name</span><span class="crayon-sy">[</span><span class="crayon-cn">11</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">4</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e78b783488491-10"><span class="crayon-p"># describe all results</span></div><div class="crayon-line" id="crayon-5a658abc2e78b783488491-11"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">describe</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e78b783488491-12"><span class="crayon-p"># box and whisker plot</span></div><div class="crayon-line" id="crayon-5a658abc2e78b783488491-13"><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">boxplot</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e78b783488491-14"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">show</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0008 seconds] -->
<p>Running the example first calculates and prints descriptive statistics for each of the experiments.</p>
<p>The average results suggest that the stateless LSTM configurations may outperform the stateful configuration. If robust, this finding is quite surprising as it does not meet the expectation of the addition of state improving performance.</p>
<p>The shuffling of training samples does not appear to make a large difference to the stateless LSTM. If the result is robust, the expectation of shuffled training order on the stateless LSTM does appear to offer some benefit.</p>
<p>Together, these findings may further suggest that the chosen LSTM configuration is focused more on learning input-output pairs rather than dependencies within the sequence.</p>
<p>From these limited results alone, one would consider exploring stateless LSTMs on this problem.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e78d620065430" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
         stateful   stateless  stateless_shuffle
count   10.000000   10.000000          10.000000
mean   103.142903   95.661773          96.206332
std      7.109461    1.924133           2.138610
min     94.052380   94.097259          93.678941
25%     96.765985   94.290720          94.548002
50%    104.376252   95.098050          95.804411
75%    107.753516   96.092609          97.076086
max    114.958430  100.334725          99.870445</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e78d620065430-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e78d620065430-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e78d620065430-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e78d620065430-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e78d620065430-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e78d620065430-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e78d620065430-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e78d620065430-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e78d620065430-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e78d620065430-1">         stateful   stateless  stateless_shuffle</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e78d620065430-2">count   10.000000   10.000000          10.000000</div><div class="crayon-line" id="crayon-5a658abc2e78d620065430-3">mean   103.142903   95.661773          96.206332</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e78d620065430-4">std      7.109461    1.924133           2.138610</div><div class="crayon-line" id="crayon-5a658abc2e78d620065430-5">min     94.052380   94.097259          93.678941</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e78d620065430-6">25%     96.765985   94.290720          94.548002</div><div class="crayon-line" id="crayon-5a658abc2e78d620065430-7">50%    104.376252   95.098050          95.804411</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e78d620065430-8">75%    107.753516   96.092609          97.076086</div><div class="crayon-line" id="crayon-5a658abc2e78d620065430-9">max    114.958430  100.334725          99.870445</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>A box and whisker plot is also created to compare the distributions.</p>
<p>The spread of the data appears much larger with the stateful configuration compared to the stateless cases. This is also present in the descriptive statistics when we look at the standard deviation scores.</p>
<p>This suggests that the stateless configurations may be more stable.</p>
<div class="wp-caption aligncenter" id="attachment_3932" style="max-width: 650px"><img alt="Box and Whisker Plot of Test RMSE of Stateful vs Stateless LSTM Results" class="size-full wp-image-3932" height="480" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-Test-RMSE-of-Stateful-vs-Stateless-LSTM-Results.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-Test-RMSE-of-Stateful-vs-Stateless-LSTM-Results.png 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-Test-RMSE-of-Stateful-vs-Stateless-LSTM-Results-300x225.png 300w" width="640"/><p class="wp-caption-text">Box and Whisker Plot of Test RMSE of Stateful vs Stateless LSTM Results</p></div>
<h2>Stateless with Large Batch vs Stateless</h2>
<p>A key to understanding the difference between stateful and stateless LSTMs is “when internal state is reset”.</p>
<ul>
<li><strong>Stateless</strong>: In the stateless LSTM configuration, internal state is reset after each training batch or each batch when making predictions.</li>
<li><strong>Stateful</strong>: In the stateful LSTM configuration, internal state is only reset when the <em>reset_state()</em> function is called.</li>
</ul>
<p>If this is the only difference, then it may be possible to simulate a stateful LSTM with a stateless LSTM using a large batch size.</p>
<ul>
<li><strong>Expectation 3</strong>: Stateless and stateful LSTMs should produce near identical results when using the same batch size.</li>
</ul>
<p>We can do this with the Shampoo Sales dataset by truncating the training data to only 12 months and leaving the test data as 12 months. This would allow a stateless LSTM to use a batch size of 12. If training and testing were performed in a one-shot manner (one function call), then it is possible that internal state of the “<em>stateless</em>” LSTM would not be reset and both configurations would produce equivalent results.</p>
<p>We will use the stateful results from the first experiment as a starting point. The <em>forecast_lstm()</em> function is modified to forecast one year of observations in a single step. The <em>experiment()</em> function is modified to truncate the training dataset to 12 months of data, to use a batch size of 12, and to process the batched predictions returned from the <em>forecast_lstm()</em> function. These updated functions are listed below. Results are written to the file “<em>experiment_stateful_batch12.csv</em>“.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e791177641530" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# make a one-step forecast
def forecast_lstm(model, batch_size, X):
	X = X.reshape(1, 1, len(X))
	yhat = model.predict(X, batch_size=batch_size)
	return yhat[0,0]

# run a repeated experiment
def experiment(repeats, series):
	# transform data to be stationary
	raw_values = series.values
	diff_values = difference(raw_values, 1)
	# transform data to be supervised learning
	supervised = timeseries_to_supervised(diff_values, 1)
	supervised_values = supervised.values[1:,:]
	# split data into train and test-sets
	train, test = supervised_values[-24:-12, :], supervised_values[-12:, :]
	# transform the scale of the data
	scaler, train_scaled, test_scaled = scale(train, test)
	# run experiment
	error_scores = list()
	for r in range(repeats):
		# fit the base model
		batch_size = 12
		lstm_model = fit_lstm(train_scaled, batch_size, 1000, 1)
		# forecast test dataset
		test_reshaped = test_scaled[:,0:-1]
		test_reshaped = test_reshaped.reshape(len(test_reshaped), 1, 1)
		output = lstm_model.predict(test_reshaped, batch_size=batch_size)
		predictions = list()
		for i in range(len(output)):
			yhat = output[i,0]
			X = test_scaled[i, 0:-1]
			# invert scaling
			yhat = invert_scale(scaler, X, yhat)
			# invert differencing
			yhat = inverse_difference(raw_values, yhat, len(test_scaled)+1-i)
			# store forecast
			predictions.append(yhat)
		# report performance
		rmse = sqrt(mean_squared_error(raw_values[-12:], predictions))
		print('%d) Test RMSE: %.3f' % (r+1, rmse))
		error_scores.append(rmse)
	return error_scores</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-10">10</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-12">12</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-14">14</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-16">16</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-18">18</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-20">20</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-22">22</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-24">24</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-26">26</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-28">28</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-30">30</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-32">32</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-34">34</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-36">36</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-38">38</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-39">39</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-40">40</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-41">41</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e791177641530-42">42</div><div class="crayon-num" data-line="crayon-5a658abc2e791177641530-43">43</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e791177641530-1"><span class="crayon-p"># make a one-step forecast</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-2"><span class="crayon-e">def </span><span class="crayon-e">forecast_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-3"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-4"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-5"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-6"> </div><div class="crayon-line" id="crayon-5a658abc2e791177641530-7"><span class="crayon-p"># run a repeated experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-8"><span class="crayon-e">def </span><span class="crayon-e">experiment</span><span class="crayon-sy">(</span><span class="crayon-v">repeats</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-9"><span class="crayon-h"> </span><span class="crayon-p"># transform data to be stationary</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-10"><span class="crayon-h"> </span><span class="crayon-v">raw_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-sy">.</span><span class="crayon-e">values</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-11"><span class="crayon-e"> </span><span class="crayon-v">diff_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">difference</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-12"><span class="crayon-h"> </span><span class="crayon-p"># transform data to be supervised learning</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-13"><span class="crayon-h"> </span><span class="crayon-v">supervised</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">timeseries_to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">diff_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-14"><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">supervised</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-15"><span class="crayon-h"> </span><span class="crayon-p"># split data into train and test-sets</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-16"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">24</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-17"><span class="crayon-h"> </span><span class="crayon-p"># transform the scale of the data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-18"><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">scale</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-19"><span class="crayon-h"> </span><span class="crayon-p"># run experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-20"><span class="crayon-h"> </span><span class="crayon-v">error_scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-21"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">r</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">repeats</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-22"><span class="crayon-h"> </span><span class="crayon-p"># fit the base model</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-23"><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-cn">12</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-24"><span class="crayon-h"> </span><span class="crayon-v">lstm_model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train_scaled</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1000</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-25"><span class="crayon-h"> </span><span class="crayon-p"># forecast test dataset</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-26"><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-27"><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-28"><span class="crayon-h"> </span><span class="crayon-v">output</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">lstm_model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">test_reshaped</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-29"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-30"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">output</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-31"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">output</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-32"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-33"><span class="crayon-h"> </span><span class="crayon-p"># invert scaling</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-34"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">invert_scale</span><span class="crayon-sy">(</span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-35"><span class="crayon-h"> </span><span class="crayon-p"># invert differencing</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-36"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">inverse_difference</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_scaled</span><span class="crayon-sy">)</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-o">-</span><span class="crayon-v">i</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-37"><span class="crayon-h"> </span><span class="crayon-p"># store forecast</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-38"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-39"><span class="crayon-h"> </span><span class="crayon-p"># report performance</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-40"><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-e">mean_squared_error</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-41"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'%d) Test RMSE: %.3f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">r</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e791177641530-42"><span class="crayon-h"> </span><span class="crayon-v">error_scores</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e791177641530-43"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">error_scores</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0045 seconds] -->
<p>We will use the stateless LSTM configuration from the previous experiment with training pattern shuffling turned off as the starting point. The experiment uses the same <em>forecast_lstm()</em> and <em>experiment()</em> functions listed above. Results are written to the file “<em>experiment_stateless_batch12.csv</em>“.</p>
<p>After running this experiment, you will have two result files:</p>
<ul>
<li><em>experiment_stateful_batch12.csv</em></li>
<li><em>experiment_stateless_batch12.csv</em></li>
</ul>
<p>We can now compare the results from these experiments.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e79a078559485" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from pandas import DataFrame
from pandas import read_csv
from matplotlib import pyplot
# load results into a dataframe
filenames = ['experiment_stateful_batch12.csv', 'experiment_stateless_batch12.csv']
results = DataFrame()
for name in filenames:
	results[name[11:-4]] = read_csv(name, header=0)
# describe all results
print(results.describe())
# box and whisker plot
results.boxplot()
pyplot.show()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e79a078559485-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e79a078559485-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e79a078559485-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e79a078559485-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e79a078559485-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e79a078559485-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e79a078559485-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e79a078559485-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e79a078559485-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e79a078559485-10">10</div><div class="crayon-num" data-line="crayon-5a658abc2e79a078559485-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e79a078559485-12">12</div><div class="crayon-num" data-line="crayon-5a658abc2e79a078559485-13">13</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e79a078559485-1"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">DataFrame</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e79a078559485-2"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line" id="crayon-5a658abc2e79a078559485-3"><span class="crayon-e">from </span><span class="crayon-e">matplotlib </span><span class="crayon-e">import </span><span class="crayon-v">pyplot</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e79a078559485-4"><span class="crayon-p"># load results into a dataframe</span></div><div class="crayon-line" id="crayon-5a658abc2e79a078559485-5"><span class="crayon-v">filenames</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">'experiment_stateful_batch12.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'experiment_stateless_batch12.csv'</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e79a078559485-6"><span class="crayon-v">results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e79a078559485-7"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">filenames</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e79a078559485-8"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-v">name</span><span class="crayon-sy">[</span><span class="crayon-cn">11</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">4</span><span class="crayon-sy">]</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e79a078559485-9"><span class="crayon-p"># describe all results</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e79a078559485-10"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">describe</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e79a078559485-11"><span class="crayon-p"># box and whisker plot</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e79a078559485-12"><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">boxplot</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e79a078559485-13"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">show</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0009 seconds] -->
<p>Running the comparison script first calculates and prints the descriptive statistics for each experiment.</p>
<p>The average results for each experiment suggest equivalent results between the stateless and stateful configurations with the same batch size. This confirms our expectations.</p>
<p>If this result is robust, it suggests that there are no further implementation-detailed differences between stateless and stateful LSTM networks in Keras beyond when the internal state is reset.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e79d112342326" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
       stateful_batch12  stateless_batch12
count         10.000000          10.000000
mean          97.920126          97.450757
std            6.526297           5.707647
min           92.723660          91.203493
25%           94.215807          93.888928
50%           95.770862          95.640314
75%           99.338368          98.540688
max          114.567780         110.014679</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e79d112342326-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e79d112342326-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e79d112342326-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e79d112342326-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e79d112342326-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e79d112342326-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e79d112342326-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e79d112342326-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e79d112342326-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e79d112342326-1">       stateful_batch12  stateless_batch12</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e79d112342326-2">count         10.000000          10.000000</div><div class="crayon-line" id="crayon-5a658abc2e79d112342326-3">mean          97.920126          97.450757</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e79d112342326-4">std            6.526297           5.707647</div><div class="crayon-line" id="crayon-5a658abc2e79d112342326-5">min           92.723660          91.203493</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e79d112342326-6">25%           94.215807          93.888928</div><div class="crayon-line" id="crayon-5a658abc2e79d112342326-7">50%           95.770862          95.640314</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e79d112342326-8">75%           99.338368          98.540688</div><div class="crayon-line" id="crayon-5a658abc2e79d112342326-9">max          114.567780         110.014679</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>A box and whisker plot is also created to compare the distributions.</p>
<p>The plot confirms the story in the descriptive statistics, perhaps just highlighting variability in the experimental design.</p>
<div class="wp-caption aligncenter" id="attachment_3933" style="max-width: 650px"><img alt="Box and Whisker Plot of Test RMSE of Stateful vs Stateless with Large Batch Size LSTM Results" class="size-full wp-image-3933" height="480" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-Test-RMSE-of-Stateful-vs-Stateless-with-Large-Batch-Size-LSTM-Results.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-Test-RMSE-of-Stateful-vs-Stateless-with-Large-Batch-Size-LSTM-Results.png 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-Test-RMSE-of-Stateful-vs-Stateless-with-Large-Batch-Size-LSTM-Results-300x225.png 300w" width="640"/><p class="wp-caption-text">Box and Whisker Plot of Test RMSE of Stateful vs Stateless with Large Batch Size LSTM Results</p></div>
<h2>Stateful Resetting vs Stateless</h2>
<p>Another question regarding stateful LSTMs is the best regime to perform resets to state.</p>
<p>Generally, we would expect that resetting the state after each presentation of the sequence would be a good idea.</p>
<ul>
<li><strong>Expectation 4</strong>: Resetting state after each training epoch results in better test performance.</li>
</ul>
<p>This raises the question as to the best way to manage state when making predictions. For example, should the network be seeded with state from making predictions on the training dataset first?</p>
<ul>
<li><strong>Expectation 5</strong>: Seeding state in the LSTM by making predictions on the training dataset results in better test performance.</li>
</ul>
<p>We would also expect that not resetting LSTM state between one-step predictions on the test set would be a good idea.</p>
<ul>
<li><strong>Expectation 6</strong>: Not resetting state between one-step predictions on the test set results in better test set performance.</li>
</ul>
<p>There is also the question of whether or not resetting state at all is a good idea. In this section, we attempt to tease out answers to these questions.</p>
<p>We will again use all of the available data and a batch size of 1 for one-step forecasts.</p>
<p>In summary, we are going to compare the following experimental setups:</p>
<p>No Seeding:</p>
<ul>
<li><strong>noseed_1</strong>: Reset state after each training epoch and not during testing (the stateful results from the first experiment in <em>experiment_stateful.csv</em>).</li>
<li><strong>noseed_2</strong>: Reset state after each training epoch and after each one-step prediction (<em>experiment_stateful_reset_test.csv</em>).</li>
<li><strong>noseed_3</strong>: No resets after training or making one-step predictions (<em>experiment_stateful_noreset.csv</em>).</li>
</ul>
<p>Seeding:</p>
<ul>
<li><strong>seed_1</strong>: Reset state after each training epoch, seed state with one-step predictions on training dataset before making one-step predictions on the test dataset (<em>experiment_stateful_seed_train.csv</em>).</li>
<li><strong>seed_2</strong>: Reset state after each training epoch, seed state with one-step predictions on training dataset before making one-step predictions on the test dataset and reset state after each one-step prediction on train and test sets (<em>experiment_stateful_seed_train_resets.csv</em>).</li>
<li><strong>seed_3</strong>: Seed on training dataset before making one-step predictions, no resets during training on predictions (<em>experiment_stateful_seed_train_no_resets.csv</em>).</li>
</ul>
<p>The stateful experiment code from the first “A vs A” experiment is used as a base.</p>
<p>The modifications needed for the various resetting/no-resetting and seeding/no-seeding are listed below.</p>
<p>We can update the <em>forecast_lstm()</em> function to update after each test by adding a call to <em>reset_states()</em> on the model after each prediction is made. The updated <em>forecast_lstm()</em> function is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e7a2146322765" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# make a one-step forecast
def forecast_lstm(model, batch_size, X):
	X = X.reshape(1, 1, len(X))
	yhat = model.predict(X, batch_size=batch_size)
	model.reset_states()
	return yhat[0,0]</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e7a2146322765-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a2146322765-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e7a2146322765-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a2146322765-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e7a2146322765-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a2146322765-6">6</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e7a2146322765-1"><span class="crayon-p"># make a one-step forecast</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a2146322765-2"><span class="crayon-e">def </span><span class="crayon-e">forecast_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e7a2146322765-3"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a2146322765-4"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">predict</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e7a2146322765-5"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">reset_states</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a2146322765-6"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0006 seconds] -->
<p>We can update the <em>fit_lstm()</em> function to not reset after each epoch by removing the call to <em>reset_states()</em>. The complete function is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e7a4005229232" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# fit an LSTM network to training data
def fit_lstm(train, batch_size, nb_epoch, neurons):
	X, y = train[:, 0:-1], train[:, -1]
	X = X.reshape(X.shape[0], 1, X.shape[1])
	model = Sequential()
	model.add(LSTM(neurons, batch_input_shape=(batch_size, X.shape[1], X.shape[2]), stateful=True))
	model.add(Dense(1))
	model.compile(loss='mean_squared_error', optimizer='adam')
	for i in range(nb_epoch):
		model.fit(X, y, epochs=1, batch_size=batch_size, verbose=0, shuffle=False)
	return model</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e7a4005229232-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a4005229232-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e7a4005229232-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a4005229232-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e7a4005229232-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a4005229232-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e7a4005229232-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a4005229232-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e7a4005229232-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a4005229232-10">10</div><div class="crayon-num" data-line="crayon-5a658abc2e7a4005229232-11">11</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e7a4005229232-1"><span class="crayon-p"># fit an LSTM network to training data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a4005229232-2"><span class="crayon-e">def </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">neurons</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e7a4005229232-3"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">[</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a4005229232-4"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-e">reshape</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e7a4005229232-5"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">Sequential</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a4005229232-6"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">LSTM</span><span class="crayon-sy">(</span><span class="crayon-v">neurons</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_input_shape</span><span class="crayon-o">=</span><span class="crayon-sy">(</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">.</span><span class="crayon-v">shape</span><span class="crayon-sy">[</span><span class="crayon-cn">2</span><span class="crayon-sy">]</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">stateful</span><span class="crayon-o">=</span><span class="crayon-t">True</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e7a4005229232-7"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">add</span><span class="crayon-sy">(</span><span class="crayon-e">Dense</span><span class="crayon-sy">(</span><span class="crayon-cn">1</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a4005229232-8"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">compile</span><span class="crayon-sy">(</span><span class="crayon-v">loss</span><span class="crayon-o">=</span><span class="crayon-s">'mean_squared_error'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">optimizer</span><span class="crayon-o">=</span><span class="crayon-s">'adam'</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e7a4005229232-9"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">nb_epoch</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a4005229232-10"><span class="crayon-h"> </span><span class="crayon-v">model</span><span class="crayon-sy">.</span><span class="crayon-e">fit</span><span class="crayon-sy">(</span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">epochs</span><span class="crayon-o">=</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">batch_size</span><span class="crayon-o">=</span><span class="crayon-v">batch_size</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">verbose</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">shuffle</span><span class="crayon-o">=</span><span class="crayon-t">False</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e7a4005229232-11"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">model</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0016 seconds] -->
<p>We can seed the state of LSTM after training with the state from making predictions on the training dataset by looping through the training dataset and making one-step forecasts. This can be added to the <em>run()</em> function before making one-step forecasts on the test dataset. The updated <em>run()</em> function is listed below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e7a8610636944" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
# run a repeated experiment
def experiment(repeats, series):
	# transform data to be stationary
	raw_values = series.values
	diff_values = difference(raw_values, 1)
	# transform data to be supervised learning
	supervised = timeseries_to_supervised(diff_values, 1)
	supervised_values = supervised.values[1:,:]
	# split data into train and test-sets
	train, test = supervised_values[0:-12, :], supervised_values[-12:, :]
	# transform the scale of the data
	scaler, train_scaled, test_scaled = scale(train, test)
	# run experiment
	error_scores = list()
	for r in range(repeats):
		# fit the base model
		lstm_model = fit_lstm(train_scaled, 1, 1000, 1)
		# forecast train dataset
		for i in range(len(train_scaled)):
			X, y = train_scaled[i, 0:-1], train_scaled[i, -1]
			yhat = forecast_lstm(lstm_model, 1, X)
		# forecast test dataset
		predictions = list()
		for i in range(len(test_scaled)):
			# predict
			X, y = test_scaled[i, 0:-1], test_scaled[i, -1]
			yhat = forecast_lstm(lstm_model, 1, X)
			# invert scaling
			yhat = invert_scale(scaler, X, yhat)
			# invert differencing
			yhat = inverse_difference(raw_values, yhat, len(test_scaled)+1-i)
			# store forecast
			predictions.append(yhat)
		# report performance
		rmse = sqrt(mean_squared_error(raw_values[-12:], predictions))
		print('%d) Test RMSE: %.3f' % (r+1, rmse))
		error_scores.append(rmse)
	return error_scores</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-10">10</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-12">12</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-14">14</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-16">16</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-17">17</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-18">18</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-19">19</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-20">20</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-21">21</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-22">22</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-23">23</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-24">24</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-25">25</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-26">26</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-27">27</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-28">28</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-29">29</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-30">30</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-31">31</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-32">32</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-33">33</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-34">34</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-35">35</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-36">36</div><div class="crayon-num" data-line="crayon-5a658abc2e7a8610636944-37">37</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7a8610636944-38">38</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-1"><span class="crayon-p"># run a repeated experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-2"><span class="crayon-e">def </span><span class="crayon-e">experiment</span><span class="crayon-sy">(</span><span class="crayon-v">repeats</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-3"><span class="crayon-h"> </span><span class="crayon-p"># transform data to be stationary</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-4"><span class="crayon-h"> </span><span class="crayon-v">raw_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">series</span><span class="crayon-sy">.</span><span class="crayon-e">values</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-5"><span class="crayon-e"> </span><span class="crayon-v">diff_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">difference</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-6"><span class="crayon-h"> </span><span class="crayon-p"># transform data to be supervised learning</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-7"><span class="crayon-h"> </span><span class="crayon-v">supervised</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">timeseries_to_supervised</span><span class="crayon-sy">(</span><span class="crayon-v">diff_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-8"><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">supervised</span><span class="crayon-sy">.</span><span class="crayon-v">values</span><span class="crayon-sy">[</span><span class="crayon-cn">1</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-9"><span class="crayon-h"> </span><span class="crayon-p"># split data into train and test-sets</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-10"><span class="crayon-h"> </span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-sy">[</span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">supervised_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">:</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-11"><span class="crayon-h"> </span><span class="crayon-p"># transform the scale of the data</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-12"><span class="crayon-h"> </span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">scale</span><span class="crayon-sy">(</span><span class="crayon-v">train</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-13"><span class="crayon-h"> </span><span class="crayon-p"># run experiment</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-14"><span class="crayon-h"> </span><span class="crayon-v">error_scores</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-15"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">r</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-v">repeats</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-16"><span class="crayon-h"> </span><span class="crayon-p"># fit the base model</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-17"><span class="crayon-h"> </span><span class="crayon-v">lstm_model</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">fit_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">train_scaled</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1000</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-18"><span class="crayon-h"> </span><span class="crayon-p"># forecast train dataset</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-19"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">train_scaled</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-20"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">train_scaled</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-21"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">forecast_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">lstm_model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-22"><span class="crayon-h"> </span><span class="crayon-p"># forecast test dataset</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-23"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">list</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-24"><span class="crayon-h"> </span><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-i">i</span><span class="crayon-h"> </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">range</span><span class="crayon-sy">(</span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_scaled</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-o">:</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-25"><span class="crayon-h"> </span><span class="crayon-p"># predict</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-26"><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">y</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">0</span><span class="crayon-o">:</span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">test_scaled</span><span class="crayon-sy">[</span><span class="crayon-v">i</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-o">-</span><span class="crayon-cn">1</span><span class="crayon-sy">]</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-27"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">forecast_lstm</span><span class="crayon-sy">(</span><span class="crayon-v">lstm_model</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-28"><span class="crayon-h"> </span><span class="crayon-p"># invert scaling</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-29"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">invert_scale</span><span class="crayon-sy">(</span><span class="crayon-v">scaler</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">X</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-30"><span class="crayon-h"> </span><span class="crayon-p"># invert differencing</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-31"><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">inverse_difference</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">yhat</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">len</span><span class="crayon-sy">(</span><span class="crayon-v">test_scaled</span><span class="crayon-sy">)</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-o">-</span><span class="crayon-v">i</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-32"><span class="crayon-h"> </span><span class="crayon-p"># store forecast</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-33"><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">yhat</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-34"><span class="crayon-h"> </span><span class="crayon-p"># report performance</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-35"><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">sqrt</span><span class="crayon-sy">(</span><span class="crayon-e">mean_squared_error</span><span class="crayon-sy">(</span><span class="crayon-v">raw_values</span><span class="crayon-sy">[</span><span class="crayon-o">-</span><span class="crayon-cn">12</span><span class="crayon-o">:</span><span class="crayon-sy">]</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">predictions</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-36"><span class="crayon-h"> </span><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-s">'%d) Test RMSE: %.3f'</span><span class="crayon-h"> </span><span class="crayon-o">%</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-v">r</span><span class="crayon-o">+</span><span class="crayon-cn">1</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e7a8610636944-37"><span class="crayon-h"> </span><span class="crayon-v">error_scores</span><span class="crayon-sy">.</span><span class="crayon-e">append</span><span class="crayon-sy">(</span><span class="crayon-v">rmse</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7a8610636944-38"><span class="crayon-h"> </span><span class="crayon-st">return</span><span class="crayon-h"> </span><span class="crayon-v">error_scores</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0033 seconds] -->
<p>This concludes all of the piecewise modifications needed to create the code for these 6 experiments.</p>
<p>After running these experiments you will have the following results files:</p>
<ul>
<li><em>experiment_stateful.csv</em></li>
<li><em>experiment_stateful_reset_test.csv</em></li>
<li><em>experiment_stateful_noreset.csv</em></li>
<li><em>experiment_stateful_seed_train.csv</em></li>
<li><em>experiment_stateful_seed_train_resets.csv</em></li>
<li><em>experiment_stateful_seed_train_no_resets.csv</em></li>
</ul>
<p>We can now compare the results, using the script below.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e7ab423791486" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
from pandas import DataFrame
from pandas import read_csv
from matplotlib import pyplot
# load results into a dataframe
filenames = ['experiment_stateful.csv', 'experiment_stateful_reset_test.csv',
	'experiment_stateful_noreset.csv', 'experiment_stateful_seed_train.csv',
	'experiment_stateful_seed_train_resets.csv', 'experiment_stateful_seed_train_no_resets.csv']
results = DataFrame()
for name in filenames:
	results[name] = read_csv(name, header=0)
results.columns = ['noseed_1', 'noseed_2', 'noseed_3', 'seed_1', 'seed_2', 'seed_3']
# describe all results
print(results.describe())
# box and whisker plot
results.boxplot()
pyplot.show()</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e7ab423791486-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7ab423791486-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e7ab423791486-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7ab423791486-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e7ab423791486-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7ab423791486-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e7ab423791486-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7ab423791486-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e7ab423791486-9">9</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7ab423791486-10">10</div><div class="crayon-num" data-line="crayon-5a658abc2e7ab423791486-11">11</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7ab423791486-12">12</div><div class="crayon-num" data-line="crayon-5a658abc2e7ab423791486-13">13</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7ab423791486-14">14</div><div class="crayon-num" data-line="crayon-5a658abc2e7ab423791486-15">15</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7ab423791486-16">16</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e7ab423791486-1"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">DataFrame</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7ab423791486-2"><span class="crayon-e">from </span><span class="crayon-e">pandas </span><span class="crayon-e">import </span><span class="crayon-e">read_csv</span></div><div class="crayon-line" id="crayon-5a658abc2e7ab423791486-3"><span class="crayon-e">from </span><span class="crayon-e">matplotlib </span><span class="crayon-e">import </span><span class="crayon-v">pyplot</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7ab423791486-4"><span class="crayon-p"># load results into a dataframe</span></div><div class="crayon-line" id="crayon-5a658abc2e7ab423791486-5"><span class="crayon-v">filenames</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">'experiment_stateful.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'experiment_stateful_reset_test.csv'</span><span class="crayon-sy">,</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7ab423791486-6"><span class="crayon-h"> </span><span class="crayon-s">'experiment_stateful_noreset.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'experiment_stateful_seed_train.csv'</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5a658abc2e7ab423791486-7"><span class="crayon-h"> </span><span class="crayon-s">'experiment_stateful_seed_train_resets.csv'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'experiment_stateful_seed_train_no_resets.csv'</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7ab423791486-8"><span class="crayon-v">results</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">DataFrame</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e7ab423791486-9"><span class="crayon-st">for</span><span class="crayon-h"> </span><span class="crayon-e">name </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-v">filenames</span><span class="crayon-o">:</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7ab423791486-10"><span class="crayon-h"> </span><span class="crayon-v">results</span><span class="crayon-sy">[</span><span class="crayon-v">name</span><span class="crayon-sy">]</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-e">read_csv</span><span class="crayon-sy">(</span><span class="crayon-v">name</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">header</span><span class="crayon-o">=</span><span class="crayon-cn">0</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5a658abc2e7ab423791486-11"><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-v">columns</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-s">'noseed_1'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'noseed_2'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'noseed_3'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'seed_1'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'seed_2'</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-s">'seed_3'</span><span class="crayon-sy">]</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7ab423791486-12"><span class="crayon-p"># describe all results</span></div><div class="crayon-line" id="crayon-5a658abc2e7ab423791486-13"><span class="crayon-e">print</span><span class="crayon-sy">(</span><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">describe</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7ab423791486-14"><span class="crayon-p"># box and whisker plot</span></div><div class="crayon-line" id="crayon-5a658abc2e7ab423791486-15"><span class="crayon-v">results</span><span class="crayon-sy">.</span><span class="crayon-e">boxplot</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7ab423791486-16"><span class="crayon-v">pyplot</span><span class="crayon-sy">.</span><span class="crayon-e">show</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span></div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0011 seconds] -->
<p>Running the comparison prints descriptive statistics for each set of results.</p>
<p>The results for no seeding suggest perhaps little difference between resetting after each prediction on the test dataset and not. This suggests any state built up from prediction to prediction is not adding value, or that this state is implicitly cleared by the Keras API. This was a surprising result.</p>
<p>The results on the no-seed case also suggest that having no resets during training results in worse on average performance with larger variance than resetting the state at the end of each epoch. This confirms the expectation that resetting the state at the end of each training epoch is a good practice.</p>
<p>The average results from the seed experiments suggest that seeding LSTM state with predictions on the training dataset before making predictions on the test dataset is neutral, if not resulting in slightly worse performance.</p>
<p>Resetting state after each prediction on the train and test sets seem to result in slightly better performance, whereas not resetting state during training or testing seems to result in the best performance.</p>
<p>These results regarding seeding are surprising, but we should note that the mean values are all within a test RMSE of 5 monthly shampoo sales and could be statistical noise.</p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->
<div class="crayon-syntax crayon-theme-classic crayon-font-monaco crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" id="crayon-5a658abc2e7af874021730" style=" margin-top: 12px; margin-bottom: 12px; font-size: 12px !important; line-height: 15px !important;">
<div class="crayon-toolbar" data-settings=" mouseover overlay hide delay" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><span class="crayon-title"></span>
<div class="crayon-tools" style="font-size: 12px !important;height: 18px !important; line-height: 18px !important;"><div class="crayon-button crayon-nums-button" title="Toggle Line Numbers"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-plain-button" title="Toggle Plain Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-wrap-button" title="Toggle Line Wrap"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-expand-button" title="Expand Code"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-copy-button" title="Copy"><div class="crayon-button-icon"></div></div><div class="crayon-button crayon-popup-button" title="Open Code In New Window"><div class="crayon-button-icon"></div></div></div></div>
<div class="crayon-info" style="min-height: 16.8px !important; line-height: 16.8px !important;"></div>
<div class="crayon-plain-wrap"><textarea class="crayon-plain print-no" data-settings="dblclick" readonly="" style="-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 12px !important; line-height: 15px !important;" wrap="soft">
         noseed_1    noseed_2    noseed_3      seed_1      seed_2      seed_3
count   10.000000   10.000000   10.000000   10.000000   10.000000   10.000000
mean   103.142903  101.757034  110.441021  105.468200  100.093551   98.766432
std      7.109461   14.584442   24.539690    5.206674    4.157095   11.573366
min     94.052380   91.264712   87.262549   97.683535   95.913385   90.005843
25%     96.765985   93.218929   94.610724  100.974693   96.721924   91.203879
50%    104.376252   96.144883   99.483971  106.036240   98.779770   95.079716
75%    107.753516  105.657586  121.586508  109.829793  103.082791  100.500867
max    114.958430  138.752321  166.527902  112.691046  108.070145  128.261354</textarea></div>
<div class="crayon-main" style="">
<table class="crayon-table">
<tr class="crayon-row">
<td class="crayon-nums " data-settings="show">
<div class="crayon-nums-content" style="font-size: 12px !important; line-height: 15px !important;"><div class="crayon-num" data-line="crayon-5a658abc2e7af874021730-1">1</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7af874021730-2">2</div><div class="crayon-num" data-line="crayon-5a658abc2e7af874021730-3">3</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7af874021730-4">4</div><div class="crayon-num" data-line="crayon-5a658abc2e7af874021730-5">5</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7af874021730-6">6</div><div class="crayon-num" data-line="crayon-5a658abc2e7af874021730-7">7</div><div class="crayon-num crayon-striped-num" data-line="crayon-5a658abc2e7af874021730-8">8</div><div class="crayon-num" data-line="crayon-5a658abc2e7af874021730-9">9</div></div>
</td>
<td class="crayon-code"><div class="crayon-pre" style="font-size: 12px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5a658abc2e7af874021730-1">         noseed_1    noseed_2    noseed_3      seed_1      seed_2      seed_3</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7af874021730-2">count   10.000000   10.000000   10.000000   10.000000   10.000000   10.000000</div><div class="crayon-line" id="crayon-5a658abc2e7af874021730-3">mean   103.142903  101.757034  110.441021  105.468200  100.093551   98.766432</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7af874021730-4">std      7.109461   14.584442   24.539690    5.206674    4.157095   11.573366</div><div class="crayon-line" id="crayon-5a658abc2e7af874021730-5">min     94.052380   91.264712   87.262549   97.683535   95.913385   90.005843</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7af874021730-6">25%     96.765985   93.218929   94.610724  100.974693   96.721924   91.203879</div><div class="crayon-line" id="crayon-5a658abc2e7af874021730-7">50%    104.376252   96.144883   99.483971  106.036240   98.779770   95.079716</div><div class="crayon-line crayon-striped-line" id="crayon-5a658abc2e7af874021730-8">75%    107.753516  105.657586  121.586508  109.829793  103.082791  100.500867</div><div class="crayon-line" id="crayon-5a658abc2e7af874021730-9">max    114.958430  138.752321  166.527902  112.691046  108.070145  128.261354</div></div></td>
</tr>
</table>
</div>
</div>
<!-- [Format Time: 0.0001 seconds] -->
<p>A box and whisker plot is also created to compare the distributions.</p>
<p>The plot tells the same story as the descriptive statistics. It highlights the increased spread when no resets are used on the stateless LSTM without seeding. It also highlights the general tight spread on the experiments that seed the state of the LSTM with predictions on the training dataset.</p>
<div class="wp-caption aligncenter" id="attachment_3934" style="max-width: 650px"><img alt="Box and Whisker Plot of Test RMSE of Reset Regimes in Stateful LSTMs" class="size-full wp-image-3934" height="480" sizes="(max-width: 640px) 100vw, 640px" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-Test-RMSE-of-Reset-Regimes-in-Stateful-LSTMs.png" srcset="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-Test-RMSE-of-Reset-Regimes-in-Stateful-LSTMs.png 640w, https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/Box-and-Whisker-Plot-of-Test-RMSE-of-Reset-Regimes-in-Stateful-LSTMs-300x225.png 300w" width="640"/><p class="wp-caption-text">Box and Whisker Plot of Test RMSE of Reset Regimes in Stateful LSTMs</p></div>
<h2>Review of Findings</h2>
<p>In this section, we recap the findings throughout this tutorial.</p>
<ul>
<li>10 repeats of an experiment with the chosen configuration results in some variation in the mean and standard deviation of the test RMSE of about 3 monthly shampoo sales. More repeats would be expected to tighten this up.</li>
<li>The stateless LSTM with the same configuration may perform better on this problem than the stateful version.</li>
<li>Not shuffling training patterns with the stateless LSTM may result in slightly better performance.</li>
<li>When a large batch size is used, a stateful LSTM can be simulated with a stateless LSTM.</li>
<li>Resetting state when making one-step predictions with a stateful LSTM may improve performance on the test set.</li>
<li>Seeding state in a stateful LSTM by making predictions on the training dataset before making predictions on the test set does not result in an obvious improvement in performance on the test set.</li>
<li>Fitting a stateful LSTM and seeding it on the training dataset and not performing any resetting of state during training or prediction may result in better performance on the test set.</li>
</ul>
<p>It must be noted that these findings should be made more robust by increasing the number of repeats of each experiment and confirming the differences are significant using statistical significance tests.</p>
<p>It should also be noted that these results apply to this specific problem, the way it was framed, and the chosen LSTM configuration parameters including topology, batch size, and training epochs.</p>
<h2>Summary</h2>
<p>In this tutorial, you discovered how to investigate the impact of using stateful vs stateless LSTM networks for time series forecasting in Python with Keras.</p>
<p>Specifically, you learned:</p>
<ul>
<li>How to compare stateless vs stateful LSTM networks for time series forecasting.</li>
<li>How to confirm the equivalence of stateless LSTMs and stateful LSTMs with a large batch size.</li>
<li>How to evaluate the impact of when LSTM state is reset during training and making predictions with LSTM networks for time series forecasting.</li>
</ul>
<p>Do you have any questions? Ask your questions in the comments and I will do my best to answer.</p>
<div class="awac-wrapper"><div class="awac widget text-30"> <div class="textwidget"><div class="woo-sc-hr"></div>
<p></p><center>
<h2>Develop LSTMs for Sequence Prediction Today!</h2>
<p><a href="/lstms-with-python/"><img align="left" alt="Long Short-Term Memory Networks with Python" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/07/Cover-220.png" style="border: 0;"/></a></p>
<h4>Develop Your Own LSTM models in Minutes</h4>
<p>…with just a few lines of python code</p>
<p>Discover how in my new Ebook:<br/>
<a href="/lstms-with-python/">Long Short-Term Memory Networks with Python</a></p>
<p>It provides <strong>self-study tutorials</strong> on topics like:<br/>
<em>CNN LSTMs, Encoder-Decoder LSTMs, generative models, data preparation, making predictions</em> and much more…</p>
<h4>Finally Bring LSTM Recurrent Neural Networks to<br/>
Your Sequence Predictions Projects</h4>
<p>Skip the Academics. Just Results.</p>
<p><a href="/lstms-with-python/">Click to learn more</a>.<br/>
</p></center><br/>
<div class="woo-sc-hr"></div>
</div>
</div></div><div class="apss-social-share apss-theme-4 clearfix">
<div class="apss-twitter apss-single-icon">
<a href="javascript:void(0);" onclick="apss_open_in_popup_window(event, 'https://twitter.com/intent/tweet?text=Stateful%20and%20Stateless%20LSTM%20for%20Time%20Series%20Forecasting%20with%20Python&amp;url=https%3A%2F%2Fmachinelearningmastery.com%2Fstateful-stateless-lstm-time-series-forecasting-python%2F&amp;');" rel="nofollow" target="" title="Share on Twitter">
<div class="apss-icon-block clearfix">
<i class="fa fa-twitter"></i>
<span class="apss-social-text">Share on Twitter</span><span class="apss-share">Tweet</span>
</div>
</a>
</div>
<div class="apss-facebook apss-single-icon">
<a href="https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/" onclick="apss_open_in_popup_window(event, 'https://www.facebook.com/sharer/sharer.php?u=https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/');" rel="nofollow" target="" title="Share on Facebook">
<div class="apss-icon-block clearfix">
<i class="fa fa-facebook"></i>
<span class="apss-social-text">Share on Facebook</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-linkedin apss-single-icon">
<a href="http://www.linkedin.com/shareArticle?mini=true&amp;title=Stateful%20and%20Stateless%20LSTM%20for%20Time%20Series%20Forecasting%20with%20Python&amp;url=https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/&amp;summary=The+Keras+Python+deep+learning+library+supports+both+stateful+and+stateless+Long+Short-Term+Memory+%28..." onclick="apss_open_in_popup_window(event, 'http://www.linkedin.com/shareArticle?mini=true&amp;title=Stateful%20and%20Stateless%20LSTM%20for%20Time%20Series%20Forecasting%20with%20Python&amp;url=https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/&amp;summary=The+Keras+Python+deep+learning+library+supports+both+stateful+and+stateless+Long+Short-Term+Memory+%28...');" rel="nofollow" target="" title="Share on LinkedIn">
<div class="apss-icon-block clearfix"><i class="fa fa-linkedin"></i>
<span class="apss-social-text">Share on LinkedIn</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
<div class="apss-google-plus apss-single-icon">
<a href="https://plus.google.com/share?url=https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/" onclick="apss_open_in_popup_window(event, 'https://plus.google.com/share?url=https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/');" rel="nofollow" target="" title="Share on Google Plus">
<div class="apss-icon-block clearfix">
<i class="fa fa-google-plus"></i>
<span class="apss-social-text">Share on Google Plus</span>
<span class="apss-share">Share</span>
</div>
</a>
</div>
</div> </section><!-- /.entry -->
<div class="fix"></div>
<aside id="post-author">
<div class="profile-image"><img alt="" class="avatar avatar-80 photo" height="80" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=160&amp;d=mm&amp;r=g 2x" width="80"/></div>
<div class="profile-content">
<h4>About Jason Brownlee</h4>
		Dr. Jason Brownlee is a husband, proud father, academic researcher, author, professional developer and a machine learning practitioner. He is dedicated to helping developers get started and get good at applied machine learning.
<a href="/about">Learn more</a>.				<div class="profile-link">
<a href="https://machinelearningmastery.com/author/jasonb/">
				View all posts by Jason Brownlee <span class="meta-nav">→</span> </a>
</div><!--#profile-link-->
</div>
<div class="fix"></div>
</aside>
<div class="post-utility"></div>
</article><!-- /.post -->
<div class="post-entries">
<div class="nav-prev fl"><a href="https://machinelearningmastery.com/use-features-lstm-networks-time-series-forecasting/" rel="prev"><i class="fa fa-angle-left"></i> How to Use Features in LSTM Networks for Time Series Forecasting</a></div>
<div class="nav-next fr"><a href="https://machinelearningmastery.com/instability-online-learning-stateful-lstm-time-series-forecasting/" rel="next">Instability of Online Learning for Stateful LSTM for Time Series Forecasting <i class="fa fa-angle-right"></i></a></div>
<div class="fix"></div>
</div>
<div id="comments"> <h3 id="comments-title">22 Responses to <em>Stateful and Stateless LSTM for Time Series Forecasting with Python</em></h3>
<ol class="commentlist">
<li class="comment even thread-even depth-1" id="comment-397712">
<div class="comment-container" id="li-comment-397712">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d2b7bdff071dd91b66d844bbe4681a62?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d2b7bdff071dd91b66d844bbe4681a62?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://talk2ai.com" rel="external nofollow">Sam Taha</a></span>
<span class="date">April 27, 2017 at 3:59 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-397712" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>Great subject and article. </p>
<p>How do we deal with the case when there the data has multiple features/labels per time series that we have suspicion have strong correlation (assumed to be strong). For example:</p>
<p>YR      Month     Production       Sales<br/>
1999      1         Shampoo         $400<br/>
1999      1         Conditioner      $300<br/>
1999      2         Shampoo         $410<br/>
1999      2         Conditioner       $305</p>
<p>And so in this case we  would like to be build one single model to predict Shampoo/Conditioner sales.</p>
<p>Is this configured by setting to the batch to 2 stateful (or 24 in the case of stateless) or am I looking at this all wrong?</p>
<div class="reply">
<a aria-label="Reply to Sam Taha" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=397712#respond" onclick='return addComment.moveForm( "comment-397712", "397712", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-397745">
<div class="comment-container" id="li-comment-397745">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">April 27, 2017 at 8:47 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-397745" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Same as any other algorithm.</p>
<p>Explore using all features in the model, explore removing highly corrected features and see how that affects the model.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=397745#respond" onclick='return addComment.moveForm( "comment-397745", "397745", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-400290">
<div class="comment-container" id="li-comment-400290">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/b7c1cb32c97bd28ec2f534fe4b204145?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b7c1cb32c97bd28ec2f534fe4b204145?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">chris</span>
<span class="date">May 23, 2017 at 3:42 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-400290" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
I follow your blog entries regarding lstms and time series quite a while and I like them really well. I have a question about something that does not fit 100% on the blog posts, but maybe you would like to share your ideas with me as I am relatively new in this area. I have a record consisting of 61 multivariate timeseries. Each time I have assigned a label in the preprocessing (0, 1 or 2).<br/>
I would like to make a multi-class classification with lstm’s.<br/>
As the starting point, I used the following:</p>
<p>model.add(LSTM(61, input_shape=(1, 61)))<br/>
model.add(Dense(3, activation=’softmax’))<br/>
model.compile(loss=’categorical_crossentropy’, optimizer=’adam’, metrics=[‘accuracy’]) </p>
<p>and learn with a batch size of 1 over 150 epochs. The dataset is divided into a training and test set.<br/>
I already have an accuracy of 97%. I think this is partly due to the data distribution, because label one occurs at about 94% and the other two about equally often. Nevertheless, it’s better than ever predict label one.</p>
<p>In the next steps, I will first let the batch size vary, and manage the memory cell.</p>
<p>Do you have other suggestions to increase the accuracy or any other things to do differently based on your experience? Or is there a reason to change the problem rather to a forecast problem?</p>
<p>Generally I have 3 problems:<br/>
1) The predicted labels are not 100% overlapping with the true labels. What I think is not quite so bad<br/>
2) I have something like jumping / oscillating values between two labels. I think that this will be improved with other parameter settings. But generally is there a recommended standard technique to treat these labels again, as for example like the moving average?<br/>
3)Completely wrongly labeled areas</p>
<p>Would you recommend to adjust the distribution of the data, so that each label equally often occur?<br/>
Many greetings,<br/>
chris</p>
<div class="reply">
<a aria-label="Reply to chris" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=400290#respond" onclick='return addComment.moveForm( "comment-400290", "400290", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-400307">
<div class="comment-container" id="li-comment-400307">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 23, 2017 at 7:58 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-400307" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Chris,</p>
<p>If your classes are not balanced, consider using a different measure than accuracy to get a true idea of the model skill, like a confusion matrix, logloss or AUC.</p>
<p>Try to quantify exactly what type of errors the model is making.</p>
<p>If there is conflict in the data, find a way to resolve it, perhaps the time axis or another variable can be used (feature engineering).</p>
<p>Most methods I know for rebalancing data are not for time series data, for example:<br/>
<a href="http://machinelearningmastery.com/tactics-to-combat-imbalanced-classes-in-your-machine-learning-dataset/" rel="nofollow">http://machinelearningmastery.com/tactics-to-combat-imbalanced-classes-in-your-machine-learning-dataset/</a></p>
<p>I do have a suite of general ideas for lifting the skill of deep learning models here:<br/>
<a href="http://machinelearningmastery.com/improve-deep-learning-performance/" rel="nofollow">http://machinelearningmastery.com/improve-deep-learning-performance/</a></p>
<p>I hope that helps as a start.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=400307#respond" onclick='return addComment.moveForm( "comment-400307", "400307", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-400356">
<div class="comment-container" id="li-comment-400356">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/b7c1cb32c97bd28ec2f534fe4b204145?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b7c1cb32c97bd28ec2f534fe4b204145?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Chris</span>
<span class="date">May 23, 2017 at 3:25 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-400356" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Good Morning, thanks for your quick reply. I started using the confusion matrix yesterday 😆. At the log loss I haven’t thought.<br/>
The feature engineering idea sounds really good,since I always have corridors of the same size for the 0 and 2 labels. I think, I’ll look at the rebalancing later and first try the other  appoaches. Thanks for the advices! I will keep you up to date.</p>
<div class="reply">
<a aria-label="Reply to Chris" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=400356#respond" onclick='return addComment.moveForm( "comment-400356", "400356", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-400396">
<div class="comment-container" id="li-comment-400396">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">May 24, 2017 at 4:52 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-400396" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Nice work, let me know how you go.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=400396#respond" onclick='return addComment.moveForm( "comment-400396", "400396", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment even depth-3" id="comment-401510">
<div class="comment-container" id="li-comment-401510">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/b7c1cb32c97bd28ec2f534fe4b204145?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b7c1cb32c97bd28ec2f534fe4b204145?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">chris</span>
<span class="date">June 5, 2017 at 5:34 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-401510" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
thanks again for the last tips.<br/>
Currently I get quite good results. The AUC for each of my three classes is already between 96-99 and also the F-Measure is better than in all models used so far.<br/>
I still have a few jumps in the labels, but I think I can certainly reduce them.</p>
<p>I now have the problem that I currently use 37 or even 62 different features.<br/>
I would like to perform a feature selection. Unfortunately, I have found nothing for keras / neural networks.  Do you already know something that can be used for neural networks or even has experience with it?  Or is that no standard practice for NN?  Thank you</p>
<div class="reply">
<a aria-label="Reply to chris" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=401510#respond" onclick='return addComment.moveForm( "comment-401510", "401510", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-4" id="comment-401523">
<div class="comment-container" id="li-comment-401523">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 5, 2017 at 7:43 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-401523" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi chris,</p>
<p>I would recommend performing feature selection up-front (prior to modeling) using sklearn:<br/>
<a href="http://machinelearningmastery.com/feature-selection-machine-learning-python/" rel="nofollow">http://machinelearningmastery.com/feature-selection-machine-learning-python/</a></p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=401523#respond" onclick='return addComment.moveForm( "comment-401523", "401523", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-400799">
<div class="comment-container" id="li-comment-400799">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/c414b0cbee737d908bcf84b1ab04ed3f?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/c414b0cbee737d908bcf84b1ab04ed3f?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">George Heitzer</span>
<span class="date">May 30, 2017 at 8:53 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-400799" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason, when running the second ( large ) piece of code using PyCharm I get “UnicodeDecodeError: ‘utf-8’ codec can’t decode byte 0xf6 in position 22: invalid start byte”, it seems to work using Spyder , however<br/>
best regards George</p>
<div class="reply">
<a aria-label="Reply to George Heitzer" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=400799#respond" onclick='return addComment.moveForm( "comment-400799", "400799", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-401193">
<div class="comment-container" id="li-comment-401193">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 2, 2017 at 12:31 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-401193" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>I recommend running all code from the command line.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=401193#respond" onclick='return addComment.moveForm( "comment-401193", "401193", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-403330">
<div class="comment-container" id="li-comment-403330">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/6e64263351fd5ccfaf87b1d89929752f?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/6e64263351fd5ccfaf87b1d89929752f?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Kris</span>
<span class="date">June 22, 2017 at 12:11 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-403330" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,</p>
<p>Great post! Maybe you would be able to help me with my problem?</p>
<p>I have a sequential data representing moving targets recorded by a radar. Sequences of some targets are longer than the others.</p>
<p>For example,</p>
<p>I have labeled data of cars and their velocities, accelerations etc.</p>
<p>‘c’ represents a car with a 3-dimensional feature vector, age is the number of times a target was recorded by the radar. Label means different types of cars such as truck etc.</p>
<p>c1 = [2,3,5], label = 0, age = 1<br/>
c2 = [2,4,7], label = 1, age = 1<br/>
c3 = [5,6,3], label = 2, age = 1<br/>
c1 = [4,5,7], label = 0, age = 2<br/>
c1 = [5,7,8], label = 0, age = 3<br/>
c2 = [6,7,4], label = 1, age = 2<br/>
c1 = [1,3,8], label = 0, age = 4<br/>
c3 = [5,6,3], label = 2, age = 2</p>
<p>As you can see, the sequences of some targets are longer than the others.</p>
<p>My question is how could I account for it while creating an LSTM model?</p>
<p>For example, by choosing window size 2, I would get [c1, c2, c3], [c2, c3, c1] and so on…</p>
<p>What happens to the labels in this case?</p>
<p>This is a classification problem so would stateful or stateless network be more appropriate?</p>
<p>Thank you,<br/>
Kris</p>
<div class="reply">
<a aria-label="Reply to Kris" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=403330#respond" onclick='return addComment.moveForm( "comment-403330", "403330", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-403369">
<div class="comment-container" id="li-comment-403369">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">June 22, 2017 at 6:08 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-403369" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Sorry, I’m not sure I follow.</p>
<p>Consider providing the entire sequences as input time steps. </p>
<p>Also consider padding sequences to make the same length if the number of time steps differ.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=403369#respond" onclick='return addComment.moveForm( "comment-403369", "403369", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-408886">
<div class="comment-container" id="li-comment-408886">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ffa63d210ca9bae2becd03e173fc3f83?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ffa63d210ca9bae2becd03e173fc3f83?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Tryfon</span>
<span class="date">August 8, 2017 at 6:28 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-408886" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason! I have some second thoughts about the stateless lstm.</p>
<p>The main purpose of the LSTM is to utilize its memory property. Based on that what is the point of a stateless LSTM to exist? Don’t we “convert” it into a simple NN by doing that?</p>
<p>In other words.. Does the stateless use of LSTM aim to model the sequences (window) in the input data – if we apply shuffle=False in the fit layer in keras – (eg. for a window of 10 time steps capture any pattern between 10-character words)? If yes why don’t we convert the initial input data to match the form of the sequencers under inspection and then use a plain NN (by adding extra columns to the original dataset that are shifted)?</p>
<p>If we choose to have shuffle = True then we are losing any information that could be found in our data (e.g. time series data – sequences), don’t we? In that case I would expect in to behave similarly to a plain NN and get the same results between the two by setting the same random seed.</p>
<p>Am I missing something in my thinking?</p>
<div class="reply">
<a aria-label="Reply to Tryfon" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=408886#respond" onclick='return addComment.moveForm( "comment-408886", "408886", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-408912">
<div class="comment-container" id="li-comment-408912">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 8, 2017 at 7:56 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-408912" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>The “stateless” LSTM just means that internal state is reset at the end of each batch, which works well in practice on many problems.</p>
<p>Really, maintaining state is part of the trade-off in backprop through time and input sequence length.</p>
<p>Shuffle applies to samples within a batch. BPTT really looks at time steps within a sample, then averages the gradient across the batch.</p>
<p>Does that help?</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=408912#respond" onclick='return addComment.moveForm( "comment-408912", "408912", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-408987">
<div class="comment-container" id="li-comment-408987">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/ffa63d210ca9bae2becd03e173fc3f83?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ffa63d210ca9bae2becd03e173fc3f83?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Tryfon</span>
<span class="date">August 8, 2017 at 10:41 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-408987" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Regarding the shuffling according to the documentation “shuffle: boolean or str (for ‘batch’). Whether to shuffle the samples at each epoch”. So it first resamples the data (i.e. changes the original order) and then on the new order creates the batches. Do I get it right?</p>
<p>Let me restate my previous question because I might have confused you. Suppose the dataset has only one variable X and one label Y. I actually want to know whether a stateless LSTM of batch size say 5 and timestep 1 is equivalent to a NN that will get as input X and X.shift(1) (so in total 2 inputs (2 columns) although they point to the same original X column of my dataset and batch size also 5. </p>
<p>Thanks in advance and congrats on your helpful website!</p>
<div class="reply">
<a aria-label="Reply to Tryfon" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=408987#respond" onclick='return addComment.moveForm( "comment-408987", "408987", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-409040">
<div class="comment-container" id="li-comment-409040">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">August 9, 2017 at 6:34 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-409040" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Even if you frame the sequence problem the same way for LSTMs and MLPs, the units inside each network are different (e.g. LSTMs have memory and gates). In turn, results will probably differ.</p>
<p>I would encourage you to test both types of networks on your problem, and most importantly, brainstorm many different ways to frame your sequence prediction problem to see which works best.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=409040#respond" onclick='return addComment.moveForm( "comment-409040", "409040", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-420680">
<div class="comment-container" id="li-comment-420680">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/11d440fe22ddd61ce8b0d16bc0ab888b?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/11d440fe22ddd61ce8b0d16bc0ab888b?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">YJ</span>
<span class="date">November 20, 2017 at 6:28 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-420680" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>My question doesn’t have much to do with LSTM. </p>
<p>“Transform the observations to have a specific scale. Specifically, to rescale the data to values between -1 and 1 to meet the default hyperbolic tangent activation function of the LSTM model.”</p>
<p>I have often ran into this comment where data should be prepared to fit the Y range of the activation function. Consequently, I’ve been trying to find the intuition or theoretical reason behind such transformation, but could not find any besides discussions on  SO. </p>
<p>I would much appreciate if  you could provide your wisdom regarding following questions.<br/>
  a) why such transformation is necessary<br/>
  b) is the transformation applicable to all other activation functions (e.g. [0,1] for sigmoid and on)?</p>
<p>Sincerely,<br/>
YJ</p>
<div class="reply">
<a aria-label="Reply to YJ" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=420680#respond" onclick='return addComment.moveForm( "comment-420680", "420680", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-420796">
<div class="comment-container" id="li-comment-420796">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">November 22, 2017 at 10:39 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-420796" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Generally, normalizing or standardizing data doe help with neural nets. I would recommend testing with and without it and see how it impacts model skill.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=420796#respond" onclick='return addComment.moveForm( "comment-420796", "420796", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-even depth-1" id="comment-424134">
<div class="comment-container" id="li-comment-424134">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/d308520be749c71072454bbdb3a8d151?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/d308520be749c71072454bbdb3a8d151?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">Stefano</span>
<span class="date">December 20, 2017 at 1:13 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-424134" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hi Jason,<br/>
what do you think of using a callback to reset states so that it is possible to use model.fit() on the entire set? Is there any reason to not do this?</p>
<p>Best regards</p>
<div class="reply">
<a aria-label="Reply to Stefano" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=424134#respond" onclick='return addComment.moveForm( "comment-424134", "424134", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-424167">
<div class="comment-container" id="li-comment-424167">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 20, 2017 at 3:50 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-424167" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>If it’s a good fit for your model/setup, go for it.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=424167#respond" onclick='return addComment.moveForm( "comment-424167", "424167", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
<li class="comment even thread-odd thread-alt depth-1" id="comment-424973">
<div class="comment-container" id="li-comment-424973">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/801c438ae15645fce29f3e5cb75faaf0?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/801c438ae15645fce29f3e5cb75faaf0?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name">arun</span>
<span class="date">December 27, 2017 at 6:14 pm</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-424973" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>Hello,<br/>
 Thanks for the wonderful post .<br/>
 I have a couple of questions on the way these long sequences have to be handled when traininig a LSTM network :<br/>
 Suppose I have a sequence classification task for which I have a set of 100 sequences with each sequence of varying length in the range 1000 – 2000 (samples). I would need the sequence classification task to identify sequences at regular intervals say every 10 or 20 samples within a sequence  </p>
<p>	Input Sequences :<br/>
         Sequence 1 : s1_1,s1_2,s1_3………………….s1_1000<br/>
	 Sequence 2 : s2_1,s2_2,s2_3………………….s2_1500<br/>
	 Sequence 3 : s3_1,s3_2,s3_3………………….s3_2000<br/>
	 .<br/>
	 .<br/>
	 .<br/>
	 Sequence 100 : s100_1,s100_2,s100_3………………….s100_1100</p>
<p> a. How do I preprocess the data i.e break down the data in to subsequences for training ? Is the sub-sequence length based on the dependency of output over the number of input Samples ?</p>
<p> b. If my output of Sequence classification depends on say last 20 samples within a sequence, how do I Split the input data sequence for training ?</p>
<p>	i.Should it be this way : Overlapping sub-sequences and Stateless – LSTM<br/>
						 s1_1,s1_2,…….s1_20<br/>
						 s1_2,s1_3……..s1_21<br/>
					         s1_3,s1_4……..s1_22 	 	</p>
<p>	ii.Or Should it be this way : Non-overlapping sub-sequences and Stateful – LSTM<br/>
						 s1_1,s1_2,…….s1_20<br/>
						 s1_21,s1_22……..s1_40<br/>
					        s1_41,s1_42……..s1_60 	 	</p>
<p>	Which among the above mentioned options(i and ii)is right? and Why ?</p>
<p>	Does the approach ii. learn dependencies longer than 20 samples … as the state is carry forwarded after each sub-sequence? If yes till what extent (number of samples … say 60 or 100)?</p>
<p> c. If my output of Sequence classification depends on say last 900 samples within a sequence, can the LSTM solve/address this problem ? If yes what would the split of a single training sequence be in such a situation and what would be the LSTM implementation be(Stateful or Stateless)?</p>
<div class="reply">
<a aria-label="Reply to arun" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=424973#respond" onclick='return addComment.moveForm( "comment-424973", "424973", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
<ul class="children">
<li class="comment byuser comment-author-jasonb bypostauthor odd alt depth-2" id="comment-425004">
<div class="comment-container" id="li-comment-425004">
<div class="avatar"><img alt="" class="avatar avatar-40 photo" height="40" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=40&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=80&amp;d=mm&amp;r=g 2x" width="40"/></div>
<div class="comment-head">
<span class="name"><a class="url" href="http://MachineLearningMastery.com" rel="external nofollow">Jason Brownlee</a></span>
<span class="date">December 28, 2017 at 5:20 am</span>
<span class="perma"><a href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/#comment-425004" title="Direct link to this comment">#</a></span>
<span class="edit"></span>
</div><!-- /.comment-head -->
<div class="comment-entry">
<p>This post will give you ideas on how to prepare your data:<br/>
<a href="https://machinelearningmastery.com/reshape-input-data-long-short-term-memory-networks-keras/" rel="nofollow">https://machinelearningmastery.com/reshape-input-data-long-short-term-memory-networks-keras/</a></p>
<p>And this post:<br/>
<a href="https://machinelearningmastery.com/prepare-univariate-time-series-data-long-short-term-memory-networks/" rel="nofollow">https://machinelearningmastery.com/prepare-univariate-time-series-data-long-short-term-memory-networks/</a></p>
<p>I think you mean 20 time steps, not 20 samples.</p>
<p>I would further encourage you to explore many different framings of your sequence classification problem and see what works best for your specific data.</p>
<div class="reply">
<a aria-label="Reply to Jason Brownlee" class="comment-reply-link" href="https://machinelearningmastery.com/stateful-stateless-lstm-time-series-forecasting-python/?replytocom=425004#respond" onclick='return addComment.moveForm( "comment-425004", "425004", "respond", "3930" )' rel="nofollow">Reply</a> </div><!-- /.reply -->
</div><!-- /comment-entry -->
</div><!-- /.comment-container -->
</li><!-- #comment-## -->
</ul><!-- .children -->
</li><!-- #comment-## -->
</ol>
</div> <div class="comment-respond" id="respond">
<h3 class="comment-reply-title" id="reply-title">Leave a Reply <small><a href="/stateful-stateless-lstm-time-series-forecasting-python/#respond" id="cancel-comment-reply-link" rel="nofollow" style="display:none;">Click here to cancel reply.</a></small></h3> <form action="https://machinelearningmastery.com/wp-comments-post.php?wpe-comment-post=mlmastery" class="comment-form" id="commentform" method="post">
<p class="comment-form-comment"><label class="hide" for="comment">Comment</label> <textarea aria-required="true" cols="50" id="comment" maxlength="65525" name="comment" required="required" rows="10" tabindex="4"></textarea></p><p class="comment-form-author"><input aria-required="true" class="txt" id="author" name="author" size="30" tabindex="1" type="text" value=""/><label for="author">Name <span class="required">(required)</span></label> </p>
<p class="comment-form-email"><input aria-required="true" class="txt" id="email" name="email" size="30" tabindex="2" type="text" value=""/><label for="email">Email (will not be published) <span class="required">(required)</span></label> </p>
<p class="comment-form-url"><input class="txt" id="url" name="url" size="30" tabindex="3" type="text" value=""/><label for="url">Website</label></p>
<p class="form-submit"><input class="submit" id="submit" name="submit" type="submit" value="Submit Comment"/> <input id="comment_post_ID" name="comment_post_ID" type="hidden" value="3930"/>
<input id="comment_parent" name="comment_parent" type="hidden" value="0"/>
</p><p style="display: none;"><input id="akismet_comment_nonce" name="akismet_comment_nonce" type="hidden" value="269387bbb5"/></p><p style="display: none;"><input id="ak_js" name="ak_js" type="hidden" value="180"/></p> </form>
</div><!-- #respond -->
</section><!-- /#main -->
<aside id="sidebar">
<div class="widget widget_woo_blogauthorinfo" id="woo_blogauthorinfo-2"><h3>Welcome to Machine Learning Mastery</h3><span class="left"><img alt="" class="avatar avatar-100 photo" height="100" src="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=100&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/1d75d46040c28497f0dee5d8e100db37?s=200&amp;d=mm&amp;r=g 2x" width="100"/></span>
<p>Hi, I'm Dr. Jason Brownlee.
<br/>
My goal is to make practitioners like YOU awesome at applied machine learning.</p>
<p><a href="/about">Read More</a></p>
<div class="fix"></div>
</div><div class="widget widget_text" id="text-29"> <div class="textwidget"><p></p><center>
<h3>Deep Learning for Sequence Prediction</h3>
<p>Cut through the math and research papers.<br/>
Discover 4 Models, 6 Architectures, and 14 Tutorials.</p>
<p><a href="/lstms-with-python/">Get Started With LSTMs in Python Today!</a><br/>
<a href="/lstms-with-python/"><img src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/07/Cover-220.png"/></a><br/>
</p></center>
</div>
</div>
<div class="widget widget_woo_tabs" id="woo_tabs-2"> <div id="tabs">
<ul class="wooTabs">
<li class="popular"><a href="#tab-pop">Popular</a></li> </ul>
<div class="clear"></div>
<div class="boxes box inside">
<ul class="list" id="tab-pop">
<li>
<a href="https://machinelearningmastery.com/machine-learning-in-python-step-by-step/" title="Your First Machine Learning Project in Python Step-By-Step"><img alt="Your First Machine Learning Project in Python Step-By-Step" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Your-First-Machine-Learning-Project-in-Python-Step-By-Step-150x150.jpg" title="Your First Machine Learning Project in Python Step-By-Step" width="45"/></a> <a href="https://machinelearningmastery.com/machine-learning-in-python-step-by-step/" title="Your First Machine Learning Project in Python Step-By-Step">Your First Machine Learning Project in Python Step-By-Step</a>
<span class="meta">June 10, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras"><img alt="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/07/Time-Series-Prediction-with-LSTM-Recurrent-Neural-Networks-in-Python-with-Keras-150x150.jpg" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras" width="45"/></a> <a href="https://machinelearningmastery.com/time-series-prediction-lstm-recurrent-neural-networks-python-keras/" title="Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras">Time Series Prediction with LSTM Recurrent Neural Networks in Python with Keras</a>
<span class="meta">July 21, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/" title="Multivariate Time Series Forecasting with LSTMs in Keras"><img alt="Line Plots of Air Pollution Time Series" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/06/Line-Plots-of-Air-Pollution-Time-Series-150x150.png" title="Multivariate Time Series Forecasting with LSTMs in Keras" width="45"/></a> <a href="https://machinelearningmastery.com/multivariate-time-series-forecasting-lstms-keras/" title="Multivariate Time Series Forecasting with LSTMs in Keras">Multivariate Time Series Forecasting with LSTMs in Keras</a>
<span class="meta">August 14, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/tutorial-first-neural-network-python-keras/" title="Develop Your First Neural Network in Python With Keras Step-By-Step"><img alt="Tour of Deep Learning Algorithms" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/04/Tour-of-Deep-Learning-Algorithms-150x150.jpg" title="Develop Your First Neural Network in Python With Keras Step-By-Step" width="45"/></a> <a href="https://machinelearningmastery.com/tutorial-first-neural-network-python-keras/" title="Develop Your First Neural Network in Python With Keras Step-By-Step">Develop Your First Neural Network in Python With Keras Step-By-Step</a>
<span class="meta">May 24, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda"><img alt="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/03/How-to-Setup-a-Python-Environment-for-Machine-Learning-and-Deep-Learning-with-Anaconda-150x150.png" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda" width="45"/></a> <a href="https://machinelearningmastery.com/setup-python-environment-machine-learning-deep-learning-anaconda/" title="How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda">How to Setup a Python Environment for Machine Learning and Deep Learning with Anaconda</a>
<span class="meta">March 13, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/sequence-classification-lstm-recurrent-neural-networks-python-keras/" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras"><img alt="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/07/Sequence-Classification-with-LSTM-Recurrent-Neural-Networks-in-Python-with-Keras-150x150.jpg" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras" width="45"/></a> <a href="https://machinelearningmastery.com/sequence-classification-lstm-recurrent-neural-networks-python-keras/" title="Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras">Sequence Classification with LSTM Recurrent Neural Networks in Python with Keras</a>
<span class="meta">July 26, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/time-series-forecasting-long-short-term-memory-network-python/" title="Time Series Forecasting with the Long Short-Term Memory Network in Python"><img alt="Time Series Forecasting with the Long Short-Term Memory Network in Python" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2017/04/Time-Series-Forecasting-with-the-Long-Short-Term-Memory-Network-in-Python-150x150.jpg" title="Time Series Forecasting with the Long Short-Term Memory Network in Python" width="45"/></a> <a href="https://machinelearningmastery.com/time-series-forecasting-long-short-term-memory-network-python/" title="Time Series Forecasting with the Long Short-Term Memory Network in Python">Time Series Forecasting with the Long Short-Term Memory Network in Python</a>
<span class="meta">April 7, 2017</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/multi-class-classification-tutorial-keras-deep-learning-library/" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library"><img alt="Multi-Class Classification Tutorial with the Keras Deep Learning Library" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Multi-Class-Classification-Tutorial-with-the-Keras-Deep-Learning-Library-150x150.jpg" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library" width="45"/></a> <a href="https://machinelearningmastery.com/multi-class-classification-tutorial-keras-deep-learning-library/" title="Multi-Class Classification Tutorial with the Keras Deep Learning Library">Multi-Class Classification Tutorial with the Keras Deep Learning Library</a>
<span class="meta">June 2, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/regression-tutorial-keras-deep-learning-library-python/" title="Regression Tutorial with the Keras Deep Learning Library in Python"><img alt="Regression Tutorial with Keras Deep Learning Library in Python" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/06/Regression-Tutorial-with-Keras-Deep-Learning-Library-in-Python-150x150.jpg" title="Regression Tutorial with the Keras Deep Learning Library in Python" width="45"/></a> <a href="https://machinelearningmastery.com/regression-tutorial-keras-deep-learning-library-python/" title="Regression Tutorial with the Keras Deep Learning Library in Python">Regression Tutorial with the Keras Deep Learning Library in Python</a>
<span class="meta">June 9, 2016</span>
<div class="fix"></div>
</li>
<li>
<a href="https://machinelearningmastery.com/grid-search-hyperparameters-deep-learning-models-python-keras/" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras"><img alt="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras" class="thumbnail wp-post-image" height="45" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/uploads/2016/08/How-to-Grid-Search-Hyperparameters-for-Deep-Learning-Models-in-Python-With-Keras-150x150.jpg" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras" width="45"/></a> <a href="https://machinelearningmastery.com/grid-search-hyperparameters-deep-learning-models-python-keras/" title="How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras">How to Grid Search Hyperparameters for Deep Learning Models in Python With Keras</a>
<span class="meta">August 9, 2016</span>
<div class="fix"></div>
</li>
</ul>
</div><!-- /.boxes -->
</div><!-- /wooTabs -->
</div> </aside><!-- /#sidebar -->
</div><!-- /#main-sidebar-container -->
</div><!-- /#content -->
<footer class="col-full" id="footer">
<div class="col-left" id="copyright">
<p>© 2018 Machine Learning Mastery. All Rights Reserved. </p> </div>
<div class="col-right" id="credit">
<p></p><p>
<a href="/privacy/">Privacy</a> | 
<a href="/contact/">Contact</a> |
<a href="/about/">About</a>
</p> </div>
</footer>
</div><!-- /#inner-wrapper -->
</div><!-- /#wrapper -->
<div class="fix"></div><!--/.fix-->
<!-- Drip -->
<script type="text/javascript">
  var _dcq = _dcq || [];
  var _dcs = _dcs || {}; 
  _dcs.account = '9556588';
  
  (function() {
    var dc = document.createElement('script');
    dc.type = 'text/javascript'; dc.async = true; 
    dc.src = '//tag.getdrip.com/9556588.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(dc, s);
  })();
</script><!-- Woo Tabs Widget -->
<script type="text/javascript">
jQuery(document).ready(function(){
	// UL = .wooTabs
	// Tab contents = .inside

	var tag_cloud_class = '#tagcloud';

	//Fix for tag clouds - unexpected height before .hide()
	var tag_cloud_height = jQuery( '#tagcloud').height();

	jQuery( '.inside ul li:last-child').css( 'border-bottom','0px' ); // remove last border-bottom from list in tab content
	jQuery( '.wooTabs').each(function(){
		jQuery(this).children( 'li').children( 'a:first').addClass( 'selected' ); // Add .selected class to first tab on load
	});
	jQuery( '.inside > *').hide();
	jQuery( '.inside > *:first-child').show();

	jQuery( '.wooTabs li a').click(function(evt){ // Init Click funtion on Tabs

		var clicked_tab_ref = jQuery(this).attr( 'href' ); // Strore Href value

		jQuery(this).parent().parent().children( 'li').children( 'a').removeClass( 'selected' ); //Remove selected from all tabs
		jQuery(this).addClass( 'selected' );
		jQuery(this).parent().parent().parent().children( '.inside').children( '*').hide();

		jQuery( '.inside ' + clicked_tab_ref).fadeIn(500);

		 evt.preventDefault();

	})
})
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/comment-reply.min.js?ver=4.9.2" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var wpcf7 = {"apiSettings":{"root":"https:\/\/machinelearningmastery.com\/wp-json\/contact-form-7\/v1","namespace":"contact-form-7\/v1"},"recaptcha":{"messages":{"empty":"Please verify that you are not a robot."}},"cached":"1"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/contact-form-7/includes/js/scripts.js?ver=4.9.2" type="text/javascript"></script>
<script type="text/javascript">
/* <![CDATA[ */
var frontend_ajax_object = {"ajax_url":"https:\/\/machinelearningmastery.com\/wp-admin\/admin-ajax.php","ajax_nonce":"555b70787c"};
/* ]]> */
</script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/seo-optimized-share-buttons/js/frontend.js?ver=4.2.2.0.iis7_supports_permalinks" type="text/javascript"></script>
<script src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-includes/js/wp-embed.min.js?ver=4.9.2" type="text/javascript"></script>
<script async="async" src="https://3qeqpr26caki16dnhd19sv6by6v-wpengine.netdna-ssl.com/wp-content/plugins/akismet/_inc/form.js?ver=4.0.2" type="text/javascript"></script>
</body>
</html>